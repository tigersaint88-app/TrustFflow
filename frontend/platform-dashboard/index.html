<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">å¹³å°æ”¶å…¥æµæ°´</title>
    <script src="ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* SaaS Professional Color Palette */
            --primary-color: #635bff;
            --primary-dark: #4a42d4;
            --secondary-color: #0a2540;
            --success-color: #00d4aa;
            --error-color: #e25950;
            --warning-color: #ffb020;
            --info-color: #3b82f6;
            
            /* Neutral Colors */
            --gray-50: #fafbfc;
            --gray-100: #f6f8fa;
            --gray-200: #e1e4e8;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Background Colors */
            --bg-primary: #ffffff;
            --bg-secondary: #fafbfc;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-focus: 0 0 0 3px rgba(99, 91, 255, 0.1);
            
            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            
            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            
            /* Typography */
            --font-size-xs: 12px;
            --font-size-sm: 14px;
            --font-size-base: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 20px;
            --font-size-2xl: 24px;
            
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            min-height: 100vh;
            padding: var(--spacing-lg);
            color: var(--gray-900);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--gray-200);
            overflow: hidden;
        }

        .header {
            background: var(--bg-primary);
            color: var(--gray-900);
            padding: var(--spacing-xl) var(--spacing-lg);
            border-bottom: 1px solid var(--gray-200);
            text-align: left;
        }

        .header h1 {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--spacing-xs);
            font-weight: 600;
            letter-spacing: -0.025em;
        }

        .header .subtitle {
            color: var(--gray-600);
            font-size: var(--font-size-sm);
            font-weight: 400;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-md);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--gray-200);
        }

        .stat-card {
            background: var(--bg-primary);
            padding: var(--spacing-md);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
        }

        .stat-label {
            font-size: 11px;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-xs);
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-value.usd {
            font-size: 12px;
            color: var(--gray-500);
            font-weight: 400;
            margin-top: 2px;
        }

        .content {
            padding: var(--spacing-xl) var(--spacing-lg);
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-group label {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
            white-space: nowrap;
            font-weight: 500;
        }

        input[type="date"], input[type="text"], select {
            padding: 10px 14px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            transition: var(--transition);
            background: var(--bg-primary);
            color: var(--gray-900);
        }

        input[type="date"]:focus, input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: var(--shadow-focus);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--gray-600);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--gray-700);
            box-shadow: var(--shadow-md);
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .revenue-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* äº‰è®®è®¢å•åˆ—è¡¨æ ·å¼ - å‚è€ƒæ”¶å…¥ä¿¡æ¯çš„ card æ¨¡å¼ */
        .dispute-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .dispute-item {
            background: var(--bg-primary);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            transition: var(--transition);
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        }

        .dispute-item:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .dispute-item.dispute-open {
            border-left: 4px solid #ef4444;
        }

        .dispute-item.dispute-resolved {
            border-left: 4px solid #10b981;
        }

        .dispute-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .dispute-order-id {
            font-size: 16px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .dispute-status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dispute-status-badge.open {
            background: #fee2e2;
            color: #dc2626;
        }

        .dispute-status-badge.resolved {
            background: #d1fae5;
            color: #059669;
        }

        .dispute-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .dispute-info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .dispute-info-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dispute-info-value {
            font-size: 14px;
            color: #1f2937;
            font-weight: 600;
            word-break: break-all;
        }

        .dispute-info-value.address {
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            cursor: pointer;
            color: #667eea;
        }

        .dispute-info-value.address:hover {
            text-decoration: underline;
        }

        .dispute-reason {
            margin-top: 15px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 3px solid #f59e0b;
        }

        .dispute-reason-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .dispute-reason-text {
            font-size: 14px;
            color: #1f2937;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .revenue-item {
            background: var(--bg-primary);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            transition: var(--transition);
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        }

        .revenue-item:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .revenue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .revenue-date {
            font-size: 12px;
            color: #6b7280;
        }

        .revenue-amount {
            font-size: 16px;
            font-weight: 700;
            color: var(--success-color);
        }

        .revenue-amount.usd {
            font-size: 11px;
            color: var(--gray-500);
            font-weight: 400;
            margin-left: var(--spacing-xs);
        }

        .revenue-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .detail-label {
            font-size: 10px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 12px;
            color: #1f2937;
            font-weight: 600;
            word-break: break-all;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
        }

        .detail-value.address {
            cursor: pointer;
            color: #667eea;
        }

        .detail-value.address:hover {
            text-decoration: underline;
        }

        .btn-details {
            padding: 6px 12px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-details:hover {
            background: #667eea;
            color: white;
        }

        .btn-details.active {
            background: #667eea;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Tab Control Styles - å‚ç…§ user ç«¯å’Œæ¥å—ç«¯ */
        .filter-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            padding: 0 16px;
            border-bottom: 2px solid #e5e7eb;
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
        
        .filter-tabs::-webkit-scrollbar {
            height: 6px;
        }
        
        .filter-tabs::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .filter-tabs::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .filter-tabs::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .filter-tab {
            padding: 12px 20px;
            border: none !important;
            background: transparent !important;
            color: #6b7280;
            border-radius: 0 !important;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            position: relative;
            margin-bottom: -2px;
            outline: none !important;
            box-shadow: none !important;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: auto !important;
            margin-top: 0 !important;
        }
        
        .filter-tab:hover {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.05) !important;
            border: none !important;
            box-shadow: none !important;
        }
        
        .filter-tab:focus {
            outline: none !important;
            box-shadow: none !important;
            border: none !important;
        }
        
        .filter-tab.active {
            background: transparent !important;
            border: none !important;
            color: #3b82f6 !important;
            font-weight: 600 !important;
            box-shadow: none !important;
            outline: none !important;
        }
        
        .filter-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #3b82f6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--gray-200);
        }

        .modal-header {
            background: var(--gray-900);
            color: white;
            padding: var(--spacing-lg) var(--spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        }

        .modal-header h2 {
            font-size: var(--font-size-xl);
            font-weight: 600;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 30px;
        }

        .transaction-detail {
            display: grid;
            gap: 20px;
        }

        .detail-section {
            padding: var(--spacing-lg);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            border-left: 4px solid var(--primary-color);
        }

        .detail-section h3 {
            font-size: var(--font-size-base);
            color: var(--gray-900);
            margin-bottom: var(--spacing-md);
            font-weight: 600;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-row-label {
            color: var(--gray-600);
            font-size: var(--font-size-sm);
        }

        .detail-row-value {
            color: var(--gray-900);
            font-size: var(--font-size-sm);
            font-weight: 600;
            text-align: right;
            max-width: 60%;
            word-break: break-all;
        }
        
        /* Admin Dispute Panel */
        .admin-dispute-panel {
            border: 1px solid #bbb;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            background: #fff7f7;
        }
        
        .admin-dispute-panel h3 {
            margin-bottom: 16px;
            color: #1f2937;
            font-size: 16px;
            font-weight: 700;
        }
        
        .admin-dispute-panel label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        .admin-dispute-panel input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .admin-dispute-panel button {
            padding: 12px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .admin-dispute-panel button:hover:not(:disabled) {
            background: #2563eb;
        }
        
        .admin-dispute-panel button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .copy-btn {
            padding: 4px 8px;
            background: #e5e7eb;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-left: 8px;
        }

        .copy-btn:hover {
            background: #d1d5db;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
        }

        .wallet-connect-section {
            padding: var(--spacing-2xl) var(--spacing-lg);
            text-align: center;
            background: var(--bg-secondary);
        }

        .wallet-connect-section h2 {
            margin-bottom: var(--spacing-md);
            color: var(--gray-900);
            font-size: var(--font-size-xl);
            font-weight: 600;
        }

        .wallet-connect-section p {
            color: var(--gray-600);
            margin-bottom: var(--spacing-lg);
            font-size: var(--font-size-base);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="header-title">ğŸ’° å¹³å°æ”¶å…¥æµæ°´</h1>
        </div>

        <div id="wallet-section" class="wallet-connect-section" style="display: none;">
            <h2 id="wallet-connect-title">è¿æ¥é’±åŒ…</h2>
            <p id="wallet-connect-desc">è¯·è¿æ¥é’±åŒ…ä»¥æŸ¥çœ‹å¹³å°æ”¶å…¥æµæ°´</p>
            <button class="btn btn-primary" onclick="connectWallet()" id="wallet-connect-btn">è¿æ¥é’±åŒ…</button>
        </div>

        <div id="dashboard-content" style="display: none;">
            <div class="stats-bar">
                <div class="stat-card">
                    <div class="stat-label">å¹³å°é’±åŒ…åœ°å€</div>
                    <div class="stat-value" style="font-size: 11px; font-family: monospace;" id="platform-wallet-address">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ€»æ”¶å…¥ (ETH)</div>
                    <div class="stat-value" id="total-revenue-eth">0.00</div>
                    <div class="stat-value usd" id="total-revenue-usd">$0.00 USD</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">äº¤æ˜“æ€»æ•°</div>
                    <div class="stat-value" id="total-transactions">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å°é’±åŒ…ä½™é¢</div>
                    <div class="stat-value" id="current-balance">0.00</div>
                    <div class="stat-value usd" id="current-balance-usd">$0.00 USD</div>
                </div>
            </div>

            <!-- è®¢å•çŠ¶æ€ç›‘æ§ -->
            <div class="stats-bar" style="margin-top: 12px;">
                <div class="stat-card">
                    <div class="stat-label">å½“æ—¥æ€»è®¢å•æ•°</div>
                    <div class="stat-value" id="today-total-orders">0</div>
                    <div class="stat-value usd" id="today-total-amount">0.00 ETH</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ­£åœ¨æ‰§è¡Œ</div>
                    <div class="stat-value" id="active-orders-count">0</div>
                    <div class="stat-value usd" id="active-orders-amount">0.00 ETH (0%)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">äº‰è®®è®¢å•</div>
                    <div class="stat-value" id="dispute-orders-count">0</div>
                    <div class="stat-value usd" id="dispute-orders-amount">0.00 ETH (0%)</div>
                </div>
            </div>

            <div class="content">
                <!-- Main Tabs -->
                <div class="filter-tabs">
                    <button class="filter-tab active" id="main-tab-revenue" onclick="switchMainTab('revenue')">
                        ğŸ’° æ”¶å…¥ä¿¡æ¯
                    </button>
                    <button class="filter-tab" id="main-tab-disputes" onclick="switchMainTab('disputes')">
                        âš–ï¸ äº‰è®®è®¢å•
                    </button>
                    <button class="filter-tab" id="main-tab-active" onclick="switchMainTab('active')">
                        ğŸš€ å½“å‰æ´»è·ƒè®¢å•
                    </button>
                </div>

                <!-- Revenue Tab Content -->
                <div id="tab-content-revenue" class="tab-content" style="display: block;">
                    <div class="filter-bar">
                        <div class="filter-group">
                            <label>èµ·å§‹æ—¥æœŸ:</label>
                            <input type="date" id="start-date">
                        </div>
                        <div class="filter-group">
                            <label>ç»“æŸæ—¥æœŸ:</label>
                            <input type="date" id="end-date">
                        </div>
                        <div class="filter-group">
                            <label>æœç´¢:</label>
                            <input type="text" id="search-input" placeholder="è®¢å•IDã€äº¤æ˜“å“ˆå¸Œã€å¸æœºåœ°å€...">
                        </div>
                        <button class="btn btn-primary" onclick="loadRevenueData()">åˆ·æ–°æ•°æ®</button>
                        <button class="btn btn-secondary" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                    </div>
                    
                    <div class="status-tabs" style="display: flex; gap: 8px; margin-bottom: 20px; padding: 0 16px;">
                        <button class="status-tab active" id="status-tab-all" onclick="filterByStatus('all')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: #3b82f6; color: white; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            å…¨éƒ¨
                        </button>
                        <button class="status-tab" id="status-tab-completed" onclick="filterByStatus('completed')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: #f9fafb; color: #6b7280; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            å·²å®Œæˆ
                        </button>
                        <button class="status-tab" id="status-tab-settled" onclick="filterByStatus('settled')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: #f9fafb; color: #6b7280; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            å·²ç»“ç®—
                        </button>
                    </div>

                    <div id="loading-revenue" class="loading">æ­£åœ¨åŠ è½½å¹³å°æ”¶å…¥æ•°æ®</div>
                    <div id="revenue-list" class="revenue-list" style="display: none;"></div>
                    <div id="empty-state-revenue" class="empty-state" style="display: none;">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <div>æš‚æ— æ”¶å…¥è®°å½•</div>
                    </div>
                </div>

                <!-- Disputes Tab Content -->
                <div id="tab-content-disputes" class="tab-content" style="display: none;">
                    <div class="filter-bar">
                        <div class="filter-group">
                            <label>çŠ¶æ€:</label>
                            <select id="dispute-status-filter" onchange="loadDisputes()">
                                <option value="all">å…¨éƒ¨</option>
                                <option value="open">å¾…å¤„ç†</option>
                                <option value="resolved">å·²è§£å†³</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="loadDisputes()">åˆ·æ–°æ•°æ®</button>
                    </div>

                    <div id="loading-disputes" class="loading">æ­£åœ¨åŠ è½½äº‰è®®è®¢å•</div>
                    <div id="dispute-list" class="dispute-list" style="display: none;"></div>
                    <div id="empty-state-disputes" class="empty-state" style="display: none;">
                        <div class="empty-state-icon">âš–ï¸</div>
                        <div>æš‚æ— äº‰è®®è®¢å•</div>
                    </div>
                </div>

                <!-- Active Orders Tab Content -->
                <div id="tab-content-active" class="tab-content" style="display: none;">
                    <div class="filter-bar">
                        <button class="btn btn-primary" onclick="loadActiveOrders()">åˆ·æ–°æ•°æ®</button>
                    </div>

                    <div id="loading-active" class="loading">æ­£åœ¨åŠ è½½æ´»è·ƒè®¢å•</div>
                    <div id="active-orders-list" class="revenue-list" style="display: none;"></div>
                    <div id="empty-state-active" class="empty-state" style="display: none;">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <div>æš‚æ— æ´»è·ƒè®¢å•</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- äº¤æ˜“è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>äº¤æ˜“è¯¦æƒ…</h2>
                <button class="modal-close" onclick="closeDetailModal()">Ã—</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <script>
        // è¯­è¨€æ£€æµ‹å’Œç¿»è¯‘
        function getCurrentLang() {
            // ä»localStorageè·å–è¯­è¨€è®¾ç½®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä»æµè§ˆå™¨è¯­è¨€æ£€æµ‹
            const savedLang = localStorage.getItem('platform_lang');
            if (savedLang) return savedLang;
            
            const browserLang = navigator.language || navigator.userLanguage;
            return browserLang.startsWith('zh') ? 'zh' : 'en';
        }
        
        function t(key, zhText, enText) {
            const lang = getCurrentLang();
            return lang === 'zh' ? zhText : enText;
        }
        
        const isZh = getCurrentLang() === 'zh';
        
        // å…¨å±€å˜é‡
        let provider, signer, account;
        let contracts = {};
        let revenueData = [];
        const ETH_TO_USD_RATE = 2500; // æ±‡ç‡

        // åˆå§‹åŒ–æ–‡æœ¬ï¼ˆæ ¹æ®è¯­è¨€ï¼‰
        function initTexts() {
            const lang = getCurrentLang();
            const texts = {
                zh: {
                    pageTitle: 'å¹³å°æ”¶å…¥æµæ°´',
                    headerTitle: 'ğŸ’° å¹³å°æ”¶å…¥æµæ°´',
                    walletConnectTitle: 'è¿æ¥é’±åŒ…',
                    walletConnectDesc: 'è¯·è¿æ¥é’±åŒ…ä»¥æŸ¥çœ‹å¹³å°æ”¶å…¥æµæ°´',
                    walletConnectBtn: 'è¿æ¥é’±åŒ…',
                    platformWalletAddress: 'å¹³å°é’±åŒ…åœ°å€',
                    totalRevenue: 'æ€»æ”¶å…¥ (ETH)',
                    totalTransactions: 'äº¤æ˜“æ€»æ•°',
                    platformBalance: 'å¹³å°é’±åŒ…ä½™é¢',
                    todayTotalOrders: 'å½“æ—¥æ€»è®¢å•æ•°',
                    activeOrders: 'æ­£åœ¨æ‰§è¡Œ',
                    disputeOrders: 'äº‰è®®è®¢å•',
                    revenueInfo: 'ğŸ’° æ”¶å…¥ä¿¡æ¯',
                    disputes: 'âš–ï¸ äº‰è®®è®¢å•',
                    activeOrdersTab: 'ğŸš€ å½“å‰æ´»è·ƒè®¢å•',
                    startDate: 'èµ·å§‹æ—¥æœŸ:',
                    endDate: 'ç»“æŸæ—¥æœŸ:',
                    search: 'æœç´¢:',
                    searchPlaceholder: 'è®¢å•IDã€äº¤æ˜“å“ˆå¸Œã€å¸æœºåœ°å€...',
                    refreshData: 'åˆ·æ–°æ•°æ®',
                    exportData: 'å¯¼å‡ºæ•°æ®',
                    all: 'å…¨éƒ¨',
                    completed: 'å·²å®Œæˆ',
                    settled: 'å·²ç»“ç®—',
                    loadingRevenue: 'æ­£åœ¨åŠ è½½å¹³å°æ”¶å…¥æ•°æ®',
                    noRevenueRecords: 'æš‚æ— æ”¶å…¥è®°å½•',
                    status: 'çŠ¶æ€:',
                    allStatus: 'å…¨éƒ¨',
                    openStatus: 'å¾…å¤„ç†',
                    resolvedStatus: 'å·²è§£å†³',
                    loadingDisputes: 'æ­£åœ¨åŠ è½½äº‰è®®è®¢å•',
                    noDisputes: 'æš‚æ— äº‰è®®è®¢å•',
                    loadingActive: 'æ­£åœ¨åŠ è½½æ´»è·ƒè®¢å•',
                    noActiveOrders: 'æš‚æ— æ´»è·ƒè®¢å•',
                    transactionDetails: 'äº¤æ˜“è¯¦æƒ…',
                    winner: 'è·èƒœæ–¹',
                    resolutionDetail: 'è£å†³è¯´æ˜',
                    openedAt: 'æäº¤æ—¶é—´',
                    resolvedAt: 'è§£å†³æ—¶é—´',
                    noDispute: 'æ— äº‰è®®',
                    resolveForDriver: 'å¸æœºè·èƒœ',
                    resolveForPassenger: 'ä¹˜å®¢è·èƒœ',
                    winnerWalletAddress: 'è·èƒœæ–¹é’±åŒ…åœ°å€',
                    processing: 'å¤„ç†ä¸­...',
                    disputeResolvedDriver: 'äº‰è®®å·²è§£å†³ï¼ˆå¸æœºè·èƒœï¼‰',
                    disputeResolvedPassenger: 'äº‰è®®å·²è§£å†³ï¼ˆä¹˜å®¢è·èƒœï¼‰',
                    confirmResolveDriver: 'ç¡®è®¤å°†äº‰è®®è§£å†³ä¸ºå¸æœºè·èƒœï¼Ÿ',
                    confirmResolvePassenger: 'ç¡®è®¤å°†äº‰è®®è§£å†³ä¸ºä¹˜å®¢è·èƒœï¼Ÿ',
                    driverAddress: 'å¸æœºåœ°å€',
                    passengerAddress: 'ä¹˜å®¢åœ°å€',
                    description: 'è¯´æ˜',
                    clickToCopy: 'ç‚¹å‡»å¤åˆ¶',
                    openedBy: 'å‘èµ·äºº',
                    orderStatus: 'è®¢å•çŠ¶æ€',
                    txHash: 'äº¤æ˜“å“ˆå¸Œ',
                    disputeReason: 'äº‰è®®åŸå› ',
                    resolved: 'å·²è§£å†³',
                    open: 'å¾…å¤„ç†',
                    details: 'è¯¦æƒ…',
                    notSet: 'æœªè®¾ç½®',
                    order: 'è®¢å•',
                    accepted: 'å·²æ¥å•',
                    inProgress: 'è¿›è¡Œä¸­',
                    awaitingSettlement: 'ç­‰å¾…ç»“ç®—',
                    status: 'çŠ¶æ€',
                    passenger: 'ä¹˜å®¢',
                    driver: 'å¸æœº',
                    pickupLocation: 'ä¸Šè½¦åœ°ç‚¹',
                    destination: 'ç›®çš„åœ°',
                    basicInfo: 'åŸºæœ¬ä¿¡æ¯',
                    amountDetails: 'é‡‘é¢æ˜ç»†',
                    participants: 'å‚ä¸æ–¹',
                    orderInfo: 'è®¢å•ä¿¡æ¯',
                    orderHistory: 'è®¢å•å†å²çŠ¶æ€',
                    disputeInfo: 'äº‰è®®ä¿¡æ¯',
                    orderId: 'è®¢å•ID',
                    transactionTime: 'äº¤æ˜“æ—¶é—´',
                    blockNumber: 'åŒºå—å·',
                    transactionHash: 'äº¤æ˜“å“ˆå¸Œ',
                    orderAmount: 'è®¢å•æ€»é¢',
                    platformFee: 'å¹³å°è´¹ (5%)',
                    driverEarnings: 'å¸æœºæ”¶å…¥ (95%)',
                    driverSide: 'æ¥å•ç«¯ï¼ˆå¸æœºï¼‰',
                    passengerSide: 'å‘å•ç«¯ï¼ˆä¹˜å®¢ï¼‰',
                    platformWallet: 'å¹³å°é’±åŒ…',
                    orderCategory: 'è®¢å•ç±»åˆ«',
                    subCategory: 'å­ç±»åˆ«',
                    disputeStatus: 'äº‰è®®çŠ¶æ€',
                    resolvedStatus: 'å·²è§£å†³',
                    pendingStatus: 'å¾…å¤„ç†',
                    noDisputeStatus: 'æ— äº‰è®®',
                    openedBy: 'å‘èµ·äºº',
                    disputeReason: 'äº‰è®®åŸå› ',
                    disputeOpenedAt: 'äº‰è®®å‘èµ·æ—¶é—´',
                    winner: 'è·èƒœæ–¹',
                    resolvedAt: 'è§£å†³æ—¶é—´',
                    resolutionDetail: 'è£å†³è¯´æ˜',
                    driverLabel: 'å¸æœº',
                    reasonLabel: 'åŸå› ',
                    winnerLabel: 'è·èƒœæ–¹',
                    blockLabel: 'åŒºå—',
                    enterSolutionNote: 'è¾“å…¥è§£å†³æ–¹æ¡ˆè¯´æ˜...',
                    copy: 'å¤åˆ¶'
                },
                en: {
                    pageTitle: 'Platform Revenue Dashboard',
                    headerTitle: 'ğŸ’° Platform Revenue Dashboard',
                    walletConnectTitle: 'Connect Wallet',
                    walletConnectDesc: 'Please connect your wallet to view platform revenue',
                    walletConnectBtn: 'Connect Wallet',
                    platformWalletAddress: 'Platform Wallet Address',
                    totalRevenue: 'Total Revenue (ETH)',
                    totalTransactions: 'Total Transactions',
                    platformBalance: 'Platform Balance',
                    todayTotalOrders: 'Today\'s Total Orders',
                    activeOrders: 'Active Orders',
                    disputeOrders: 'Dispute Orders',
                    revenueInfo: 'ğŸ’° Revenue Info',
                    disputes: 'âš–ï¸ Disputes',
                    activeOrdersTab: 'ğŸš€ Active Orders',
                    startDate: 'Start Date:',
                    endDate: 'End Date:',
                    search: 'Search:',
                    searchPlaceholder: 'Order ID, Transaction Hash, Driver Address...',
                    refreshData: 'Refresh Data',
                    exportData: 'Export Data',
                    all: 'All',
                    completed: 'Completed',
                    settled: 'Settled',
                    loadingRevenue: 'Loading platform revenue data',
                    noRevenueRecords: 'No revenue records',
                    status: 'Status:',
                    allStatus: 'All',
                    openStatus: 'Open',
                    resolvedStatus: 'Resolved',
                    loadingDisputes: 'Loading dispute orders',
                    noDisputes: 'No dispute orders',
                    loadingActive: 'Loading active orders',
                    noActiveOrders: 'No active orders',
                    transactionDetails: 'Transaction Details',
                    winner: 'Winner',
                    resolutionDetail: 'Resolution Detail',
                    openedAt: 'Opened At',
                    resolvedAt: 'Resolved At',
                    noDispute: 'No Dispute',
                    resolveForDriver: 'Resolve for Driver',
                    resolveForPassenger: 'Resolve for Passenger',
                    winnerWalletAddress: 'Winner Wallet Address',
                    processing: 'Processing...',
                    disputeResolvedDriver: 'Dispute resolved (Driver wins)',
                    disputeResolvedPassenger: 'Dispute resolved (Passenger wins)',
                    confirmResolveDriver: 'Confirm resolve dispute for driver?',
                    confirmResolvePassenger: 'Confirm resolve dispute for passenger?',
                    driverAddress: 'Driver Address',
                    passengerAddress: 'Passenger Address',
                    description: 'Description',
                    clickToCopy: 'Click to copy',
                    openedBy: 'Opened By',
                    orderStatus: 'Order Status',
                    txHash: 'TX Hash',
                    disputeReason: 'Dispute Reason',
                    resolved: 'Resolved',
                    open: 'Open',
                    details: 'Details',
                    notSet: 'Not Set',
                    order: 'Order',
                    accepted: 'Accepted',
                    inProgress: 'In Progress',
                    awaitingSettlement: 'Awaiting Settlement',
                    status: 'Status',
                    passenger: 'Passenger',
                    driver: 'Driver',
                    pickupLocation: 'Pickup Location',
                    destination: 'Destination',
                    basicInfo: 'Basic Info',
                    amountDetails: 'Amount Details',
                    participants: 'Participants',
                    orderInfo: 'Order Info',
                    orderHistory: 'Order History',
                    disputeInfo: 'Dispute Info',
                    orderId: 'Order ID',
                    transactionTime: 'Transaction Time',
                    blockNumber: 'Block Number',
                    transactionHash: 'Transaction Hash',
                    orderAmount: 'Order Amount',
                    platformFee: 'Platform Fee (5%)',
                    driverEarnings: 'Driver Earnings (95%)',
                    driverSide: 'Driver Side',
                    passengerSide: 'Passenger Side',
                    platformWallet: 'Platform Wallet',
                    orderCategory: 'Order Category',
                    subCategory: 'Sub Category',
                    disputeStatus: 'Dispute Status',
                    resolvedStatus: 'Resolved',
                    pendingStatus: 'Pending',
                    noDisputeStatus: 'No Dispute',
                    openedBy: 'Opened By',
                    disputeReason: 'Dispute Reason',
                    disputeOpenedAt: 'Dispute Opened At',
                    winner: 'Winner',
                    resolvedAt: 'Resolved At',
                    resolutionDetail: 'Resolution Detail',
                    driverLabel: 'Driver',
                    reasonLabel: 'Reason',
                    winnerLabel: 'Winner',
                    blockLabel: 'Block',
                    enterSolutionNote: 'Enter solution note...',
                    copy: 'Copy'
                }
            };
            
            const t = texts[lang];
            
            // æ›´æ–°é™æ€æ–‡æœ¬
            const titleEl = document.getElementById('page-title');
            if (titleEl) titleEl.textContent = t.pageTitle;
            
            const headerTitleEl = document.getElementById('header-title');
            if (headerTitleEl) headerTitleEl.textContent = t.headerTitle;
            
            const walletTitleEl = document.getElementById('wallet-connect-title');
            if (walletTitleEl) walletTitleEl.textContent = t.walletConnectTitle;
            
            const walletDescEl = document.getElementById('wallet-connect-desc');
            if (walletDescEl) walletDescEl.textContent = t.walletConnectDesc;
            
            const walletBtnEl = document.getElementById('wallet-connect-btn');
            if (walletBtnEl) walletBtnEl.textContent = t.walletConnectBtn;
            
            // æ›´æ–°ç»Ÿè®¡æ ‡ç­¾
            const statLabels = document.querySelectorAll('.stat-label');
            statLabels.forEach(label => {
                const text = label.textContent.trim();
                if (text === 'å¹³å°é’±åŒ…åœ°å€' || text === 'Platform Wallet Address') {
                    label.textContent = t.platformWalletAddress;
                } else if (text === 'æ€»æ”¶å…¥ (ETH)' || text === 'Total Revenue (ETH)') {
                    label.textContent = t.totalRevenue;
                } else if (text === 'äº¤æ˜“æ€»æ•°' || text === 'Total Transactions') {
                    label.textContent = t.totalTransactions;
                } else if (text === 'å¹³å°é’±åŒ…ä½™é¢' || text === 'Platform Balance') {
                    label.textContent = t.platformBalance;
                } else if (text === 'å½“æ—¥æ€»è®¢å•æ•°' || text === 'Today\'s Total Orders') {
                    label.textContent = t.todayTotalOrders;
                } else if (text === 'æ­£åœ¨æ‰§è¡Œ' || text === 'Active Orders') {
                    label.textContent = t.activeOrders;
                } else if (text === 'äº‰è®®è®¢å•' || text === 'Dispute Orders') {
                    label.textContent = t.disputeOrders;
                }
            });
            
            // æ›´æ–°TabæŒ‰é’®
            const revenueTab = document.getElementById('main-tab-revenue');
            if (revenueTab) revenueTab.textContent = t.revenueInfo;
            
            const disputesTab = document.getElementById('main-tab-disputes');
            if (disputesTab) disputesTab.textContent = t.disputes;
            
            const activeTab = document.getElementById('main-tab-active');
            if (activeTab) activeTab.textContent = t.activeOrdersTab;
            
            // æ›´æ–°è¡¨å•æ ‡ç­¾
            const labels = document.querySelectorAll('label');
            labels.forEach(label => {
                const text = label.textContent.trim();
                if (text.startsWith('èµ·å§‹æ—¥æœŸ') || text.startsWith('Start Date')) {
                    label.textContent = t.startDate;
                } else if (text.startsWith('ç»“æŸæ—¥æœŸ') || text.startsWith('End Date')) {
                    label.textContent = t.endDate;
                } else if (text.startsWith('æœç´¢') || text.startsWith('Search')) {
                    label.textContent = t.search;
                } else if (text.startsWith('çŠ¶æ€') || text.startsWith('Status')) {
                    label.textContent = t.status;
                }
            });
            
            // æ›´æ–°æœç´¢æ¡†placeholder
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.placeholder = t.searchPlaceholder;
            }
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                const text = btn.textContent.trim();
                if (text === 'åˆ·æ–°æ•°æ®' || text === 'Refresh Data') {
                    btn.textContent = t.refreshData;
                } else if (text === 'å¯¼å‡ºæ•°æ®' || text === 'Export Data') {
                    btn.textContent = t.exportData;
                }
            });
            
            // æ›´æ–°çŠ¶æ€Tab
            const statusTabs = document.querySelectorAll('.status-tab');
            statusTabs.forEach(tab => {
                const text = tab.textContent.trim();
                if (text === 'å…¨éƒ¨' || text === 'All') {
                    tab.textContent = t.all;
                } else if (text === 'å·²å®Œæˆ' || text === 'Completed') {
                    tab.textContent = t.completed;
                } else if (text === 'å·²ç»“ç®—' || text === 'Settled') {
                    tab.textContent = t.settled;
                }
            });
            
            // æ›´æ–°ä¸‹æ‹‰é€‰é¡¹
            const disputeFilter = document.getElementById('dispute-status-filter');
            if (disputeFilter) {
                const options = disputeFilter.querySelectorAll('option');
                options.forEach(opt => {
                    const val = opt.value;
                    if (val === 'all') opt.textContent = t.allStatus;
                    else if (val === 'open') opt.textContent = t.openStatus;
                    else if (val === 'resolved') opt.textContent = t.resolvedStatus;
                });
            }
            
            // æ›´æ–°åŠ è½½å’Œç©ºçŠ¶æ€æ–‡æœ¬
            const loadingRevenue = document.getElementById('loading-revenue');
            if (loadingRevenue) loadingRevenue.textContent = t.loadingRevenue;
            
            const emptyRevenue = document.querySelector('#empty-state-revenue div:last-child');
            if (emptyRevenue) emptyRevenue.textContent = t.noRevenueRecords;
            
            const loadingDisputes = document.getElementById('loading-disputes');
            if (loadingDisputes) loadingDisputes.textContent = t.loadingDisputes;
            
            const emptyDisputes = document.querySelector('#empty-state-disputes div:last-child');
            if (emptyDisputes) emptyDisputes.textContent = t.noDisputes;
            
            const loadingActive = document.getElementById('loading-active');
            if (loadingActive) loadingActive.textContent = t.loadingActive;
            
            const emptyActive = document.querySelector('#empty-state-active div:last-child');
            if (emptyActive) emptyActive.textContent = t.noActiveOrders;
            
            // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
            const modalTitle = document.getElementById('modal-title');
            if (modalTitle) modalTitle.textContent = t.transactionDetails;
            
            // ä¿å­˜ç¿»è¯‘å¯¹è±¡åˆ°å…¨å±€
            window.platformTexts = t;
        }
        
        // åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            initTexts();
            if (typeof window.ethereum !== 'undefined') {
                await connectWallet();
            } else {
                document.getElementById('wallet-section').style.display = 'block';
            }
        });

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                account = await signer.getAddress();
                console.log('è¿æ¥çš„è´¦æˆ·åœ°å€:', account);

                // æ£€æŸ¥ç½‘ç»œ
                const network = await provider.getNetwork();
                console.log('å½“å‰ç½‘ç»œä¿¡æ¯:', {
                    chainId: network.chainId.toString(),
                    name: network.name
                });
                
                // æ£€æŸ¥ Chain ID æ˜¯å¦ä¸º 1337 (æœ¬åœ° Hardhat ç½‘ç»œ)
                const EXPECTED_CHAIN_ID = 1337;
                // å°† chainId è½¬æ¢ä¸ºæ•°å­—è¿›è¡Œæ¯”è¾ƒï¼ˆå¯èƒ½æ˜¯ BigNumber æˆ–å­—ç¬¦ä¸²ï¼‰
                const currentChainId = typeof network.chainId === 'object' 
                    ? network.chainId.toNumber() 
                    : parseInt(network.chainId.toString(), 10);
                
                console.log('ç½‘ç»œæ£€æŸ¥:', {
                    chainIdåŸå§‹å€¼: network.chainId,
                    chainIdç±»å‹: typeof network.chainId,
                    chainIdæ•°å­—: currentChainId,
                    æœŸæœ›å€¼: EXPECTED_CHAIN_ID,
                    åŒ¹é…: currentChainId === EXPECTED_CHAIN_ID
                });
                
                if (currentChainId !== EXPECTED_CHAIN_ID) {
                    console.warn(`âš ï¸ è­¦å‘Š: å½“å‰ Chain ID æ˜¯ ${currentChainId}ï¼Œä½†åº”è¯¥æ˜¯ ${EXPECTED_CHAIN_ID}`);
                    console.warn('è¯·ç¡®ä¿ MetaMask è¿æ¥åˆ°æœ¬åœ° Hardhat ç½‘ç»œ (localhost:8545)');
                    
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œé˜»æ­¢ç»§ç»­æ‰§è¡Œ
                    const errorMsg = `âš ï¸ ç½‘ç»œä¸åŒ¹é…ï¼\n\n` +
                        `å½“å‰ Chain ID: ${currentChainId} (${network.name || 'Unknown'})\n` +
                        `æœŸæœ› Chain ID: ${EXPECTED_CHAIN_ID} (Hardhat Local)\n\n` +
                        `è¯·åˆ‡æ¢åˆ°æœ¬åœ° Hardhat ç½‘ç»œåå†ç»§ç»­ã€‚\n\n` +
                        `æ˜¯å¦è¦è‡ªåŠ¨åˆ‡æ¢åˆ°æœ¬åœ° Hardhat ç½‘ç»œï¼Ÿ\n\n` +
                        `ç‚¹å‡»"ç¡®å®š"è‡ªåŠ¨æ·»åŠ å¹¶åˆ‡æ¢ç½‘ç»œ\n` +
                        `ç‚¹å‡»"å–æ¶ˆ"æ‰‹åŠ¨åœ¨ MetaMask ä¸­é…ç½®`;
                    
                    const userWantsToSwitch = confirm(errorMsg);
                    
                    if (userWantsToSwitch) {
                        try {
                            // æ˜¾ç¤ºåŠ è½½æç¤º
                            const loadingMsg = document.createElement('div');
                            loadingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:10000;text-align:center;';
                            loadingMsg.innerHTML = '<div>æ­£åœ¨åˆ‡æ¢ç½‘ç»œ...</div><div style="margin-top:10px;font-size:12px;color:#666;">è¯·ç­‰å¾… MetaMask å®Œæˆç½‘ç»œåˆ‡æ¢ï¼ˆå¯èƒ½éœ€è¦ 2-5 ç§’ï¼‰</div>';
                            document.body.appendChild(loadingMsg);
                            
                            // ç›‘å¬ç½‘ç»œå˜åŒ–äº‹ä»¶
                            const handleChainChanged = (chainId) => {
                                console.log('ç½‘ç»œå·²åˆ‡æ¢ï¼Œæ–°çš„ Chain ID:', parseInt(chainId, 16));
                                document.body.removeChild(loadingMsg);
                                window.ethereum.removeListener('chainChanged', handleChainChanged);
                                
                                // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿ç½‘ç»œçŠ¶æ€æ›´æ–°
                                setTimeout(() => {
                                    console.log('âœ… ç½‘ç»œåˆ‡æ¢å®Œæˆï¼Œé‡æ–°åŠ è½½é¡µé¢');
                                    location.reload();
                                }, 1000);
                            };
                            window.ethereum.on('chainChanged', handleChainChanged);
                            
                            // å…ˆå°è¯•åˆ‡æ¢åˆ°æœ¬åœ°ç½‘ç»œï¼ˆå¦‚æœå·²å­˜åœ¨ï¼‰
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_switchEthereumChain',
                                    params: [{ chainId: '0x539' }] // 1337 çš„åå…­è¿›åˆ¶
                                });
                                console.log('âœ… å·²è¯·æ±‚åˆ‡æ¢åˆ°æœ¬åœ°ç½‘ç»œï¼Œç­‰å¾…ç¡®è®¤...');
                                // ä¸ç«‹å³é‡æ–°åŠ è½½ï¼Œç­‰å¾… chainChanged äº‹ä»¶
                                return; // é˜»æ­¢ç»§ç»­æ‰§è¡Œ
                            } catch (switchError) {
                                if (switchError.code === 4902) {
                                    // ç½‘ç»œä¸å­˜åœ¨ï¼Œéœ€è¦æ·»åŠ 
                                    console.log('â• æœ¬åœ°ç½‘ç»œä¸å­˜åœ¨ï¼Œæ­£åœ¨æ·»åŠ ...');
                                    loadingMsg.innerHTML = '<div>æ­£åœ¨æ·»åŠ æœ¬åœ°ç½‘ç»œ...</div><div style="margin-top:10px;font-size:12px;color:#666;">è¯·ç­‰å¾… MetaMask å®Œæˆç½‘ç»œæ·»åŠ ï¼ˆå¯èƒ½éœ€è¦ 2-5 ç§’ï¼‰</div>';
                                } else {
                                    document.body.removeChild(loadingMsg);
                                    window.ethereum.removeListener('chainChanged', handleChainChanged);
                                    throw switchError; // å…¶ä»–é”™è¯¯ï¼Œé‡æ–°æŠ›å‡º
                                }
                            }
                            
                            // æ·»åŠ ç½‘ç»œ
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: '0x539', // 1337 çš„åå…­è¿›åˆ¶
                                        chainName: 'Hardhat Local',
                                        nativeCurrency: {
                                            name: 'Ethereum',
                                            symbol: 'ETH',
                                            decimals: 18
                                        },
                                        rpcUrls: ['http://127.0.0.1:8545', 'http://localhost:8545'],
                                        blockExplorerUrls: null
                                    }]
                                });
                                console.log('âœ… æœ¬åœ°ç½‘ç»œå·²æ·»åŠ å¹¶åˆ‡æ¢ï¼Œç­‰å¾…ç½‘ç»œçŠ¶æ€æ›´æ–°...');
                                // ä¸ç«‹å³é‡æ–°åŠ è½½ï¼Œç­‰å¾… chainChanged äº‹ä»¶æˆ–è¶…æ—¶
                                setTimeout(() => {
                                    const currentChainId = window.ethereum.chainId;
                                    const chainIdNum = parseInt(currentChainId, 16);
                                    if (chainIdNum === 1337) {
                                        document.body.removeChild(loadingMsg);
                                        window.ethereum.removeListener('chainChanged', handleChainChanged);
                                        console.log('âœ… ç½‘ç»œåˆ‡æ¢å®Œæˆï¼Œé‡æ–°åŠ è½½é¡µé¢');
                                        location.reload();
                                    } else {
                                        console.log('ç­‰å¾…ç½‘ç»œåˆ‡æ¢å®Œæˆ...');
                                    }
                                }, 3000);
                                return; // é˜»æ­¢ç»§ç»­æ‰§è¡Œ
                            } catch (addError) {
                                document.body.removeChild(loadingMsg);
                                window.ethereum.removeListener('chainChanged', handleChainChanged);
                                console.error('âŒ æ·»åŠ ç½‘ç»œå¤±è´¥:', addError);
                                alert(
                                    `âŒ è‡ªåŠ¨æ·»åŠ ç½‘ç»œå¤±è´¥ï¼\n\n` +
                                    `é”™è¯¯: ${addError.message}\n\n` +
                                    `è¯·æ‰‹åŠ¨åœ¨ MetaMask ä¸­æ·»åŠ ç½‘ç»œï¼š\n` +
                                    `- ç½‘ç»œåç§°: Hardhat Local\n` +
                                    `- RPC URL: http://127.0.0.1:8545\n` +
                                    `- Chain ID: 1337\n` +
                                    `- è´§å¸ç¬¦å·: ETH\n\n` +
                                    `è¯¦ç»†æ­¥éª¤è¯·æŸ¥çœ‹æ–‡æ¡£ï¼šdocs/MetaMaskæœ¬åœ°ç½‘ç»œé…ç½®æŒ‡å—.md`
                                );
                                // å³ä½¿å¤±è´¥ä¹Ÿé˜»æ­¢ç»§ç»­æ‰§è¡Œ
                                return;
                            }
                        } catch (error) {
                            console.error('âŒ ç½‘ç»œåˆ‡æ¢è¿‡ç¨‹å‡ºé”™:', error);
                            alert(
                                `âŒ ç½‘ç»œåˆ‡æ¢å¤±è´¥ï¼\n\n` +
                                `é”™è¯¯: ${error.message}\n\n` +
                                `è¯·æ‰‹åŠ¨åœ¨ MetaMask ä¸­åˆ‡æ¢åˆ°æœ¬åœ°ç½‘ç»œã€‚\n\n` +
                                `æŸ¥çœ‹æ–‡æ¡£ï¼šdocs/MetaMaskæœ¬åœ°ç½‘ç»œé…ç½®æŒ‡å—.md`
                            );
                            return; // é˜»æ­¢ç»§ç»­æ‰§è¡Œ
                        }
                    } else {
                        // ç”¨æˆ·å–æ¶ˆäº†åˆ‡æ¢ï¼Œé˜»æ­¢ç»§ç»­æ‰§è¡Œ
                        alert(
                            `âš ï¸ éœ€è¦åˆ‡æ¢åˆ°æœ¬åœ°ç½‘ç»œæ‰èƒ½ç»§ç»­\n\n` +
                            `å½“å‰ç½‘ç»œ: Chain ID ${currentChainId}\n` +
                            `éœ€è¦ç½‘ç»œ: Chain ID ${EXPECTED_CHAIN_ID}\n\n` +
                            `è¯·åœ¨ MetaMask ä¸­åˆ‡æ¢åˆ°æœ¬åœ° Hardhat ç½‘ç»œï¼Œç„¶ååˆ·æ–°é¡µé¢ã€‚`
                        );
                        return; // é˜»æ­¢ç»§ç»­æ‰§è¡Œ
                    }
                } else {
                    console.log('âœ… Chain ID åŒ¹é…ï¼Œç½‘ç»œæ­£ç¡®');
                }
                
                // æŸ¥è¯¢è¿æ¥çš„è´¦æˆ·ä½™é¢ä½œä¸ºå¯¹æ¯”
                const accountBalance = await provider.getBalance(account);
                console.log('è¿æ¥çš„è´¦æˆ·ä½™é¢ (ETH):', ethers.utils.formatEther(accountBalance));
                
                // åŠ è½½åˆçº¦åœ°å€
                await loadContractAddresses();
                
                // åˆå§‹åŒ–åˆçº¦
                await initializeContracts();

                // æ˜¾ç¤ºä»ªè¡¨æ¿
                document.getElementById('wallet-section').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';

                // åŠ è½½æ•°æ®
                await loadRevenueData();
                
                // åŠ è½½è®¢å•ç»Ÿè®¡æ•°æ®
                await loadOrderStatistics();
                
                // åŠ è½½äº‰è®®è®¢å•æ•°æ®
                if (typeof loadDisputes === 'function') {
                    await loadDisputes();
                }
                
                // å¯åŠ¨å¹³å°æ”¶å…¥æ•°æ®è‡ªåŠ¨åˆ·æ–°
                if (typeof window.startPlatformAutoRefresh === 'function') {
                    window.startPlatformAutoRefresh();
                }
            } catch (error) {
                console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                alert('è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½åˆçº¦åœ°å€å’ŒABI
        async function loadContractAddresses() {
            try {
                const response = await fetch('/deployments/localhost-latest.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // æ£€æŸ¥ Content-Type æ˜¯å¦ä¸º JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('å“åº”ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼');
                }
                
                const deployment = await response.json();
                window.contractAddresses = {
                    rideOrder: deployment.contracts.rideOrder,
                    platformWallet: deployment.configuration?.platformWallet
                };
                
                // åŠ è½½å®Œæ•´çš„ABIæ–‡ä»¶
                try {
                    const abiResponse = await fetch('/contracts/abi/TrustFlowRide.json');
                    if (abiResponse.ok) {
                        window.contractABI = await abiResponse.json();
                        console.log('[PLATFORM] æˆåŠŸåŠ è½½å®Œæ•´çš„åˆçº¦ABI');
                        window.logger?.info('[PLATFORM] æˆåŠŸåŠ è½½å®Œæ•´çš„åˆçº¦ABI', { abiLength: window.contractABI?.length || 0 });
                    } else {
                        console.warn('[PLATFORM] æ— æ³•åŠ è½½å®Œæ•´ABIæ–‡ä»¶ï¼Œå°†ä½¿ç”¨æ‰‹åŠ¨å®šä¹‰çš„ABI');
                        window.logger?.warn('[PLATFORM] æ— æ³•åŠ è½½å®Œæ•´ABIæ–‡ä»¶', { status: abiResponse.status });
                    }
                } catch (abiError) {
                    console.warn('[PLATFORM] åŠ è½½ABIæ–‡ä»¶å¤±è´¥ï¼Œå°†ä½¿ç”¨æ‰‹åŠ¨å®šä¹‰çš„ABI:', abiError);
                    window.logger?.warn('[PLATFORM] åŠ è½½ABIæ–‡ä»¶å¤±è´¥', { error: abiError.message });
                }
                
                if (window.contractAddresses.platformWallet) {
                    const platformWalletAddress = window.contractAddresses.platformWallet;
                    document.getElementById('platform-wallet-address').textContent = platformWalletAddress;
                    console.log('å¹³å°é’±åŒ…åœ°å€å·²åŠ è½½:', platformWalletAddress);
                } else {
                    console.warn('å¹³å°é’±åŒ…åœ°å€æœªæ‰¾åˆ°');
                }
            } catch (error) {
                console.error('åŠ è½½åˆçº¦åœ°å€å¤±è´¥:', error);
                alert('åŠ è½½åˆçº¦åœ°å€å¤±è´¥: ' + error.message + '\nè¯·ç¡®ä¿å·²éƒ¨ç½²åˆçº¦å¹¶ç”Ÿæˆäº†éƒ¨ç½²æ–‡ä»¶ã€‚');
            }
        }

        // å‰ç«¯æ—¥å¿—åŠŸèƒ½
        const frontendLogger = {
            logs: [],
            maxLogs: 1000, // æœ€å¤šä¿å­˜1000æ¡æ—¥å¿—
            pendingLogs: [], // å¾…å‘é€çš„æ—¥å¿—é˜Ÿåˆ—
            sendTimer: null, // æ‰¹é‡å‘é€å®šæ—¶å™¨
            lastSendTime: 0, // ä¸Šæ¬¡å‘é€æ—¶é—´
            sendInterval: 5000, // æ‰¹é‡å‘é€é—´éš”ï¼ˆ5ç§’ï¼‰
            maxPendingLogs: 50, // æœ€å¤šç´¯ç§¯50æ¡æ—¥å¿—å†å‘é€
            isSending: false, // æ˜¯å¦æ­£åœ¨å‘é€
            
            log(level, message, data = {}) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    level: level,
                    message: message,
                    data: data,
                    url: window.location.href
                };
                
                // æ·»åŠ åˆ°å†…å­˜æ•°ç»„
                this.logs.push(logEntry);
                if (this.logs.length > this.maxLogs) {
                    this.logs.shift(); // ç§»é™¤æœ€æ—§çš„æ—¥å¿—
                }
                
                // æ§åˆ¶å°è¾“å‡º
                const consoleMethod = console[level] || console.log;
                consoleMethod(`[${logEntry.timestamp}] [${level.toUpperCase()}] ${message}`, data);
                
                // åªå‘é€errorå’Œwarnçº§åˆ«çš„æ—¥å¿—ï¼Œå‡å°‘è¯·æ±‚é‡
                // debugå’Œinfoçº§åˆ«ä¸å‘é€åˆ°åç«¯ï¼Œåªä¿å­˜åœ¨å†…å­˜ä¸­
                if (level === 'error' || level === 'warn') {
                    this.queueLogForSending(logEntry);
                }
            },
            
            queueLogForSending(logEntry) {
                // æ·»åŠ æ¥æºæ ‡è¯†
                logEntry.source = 'platform';
                // æ·»åŠ åˆ°å¾…å‘é€é˜Ÿåˆ—
                this.pendingLogs.push(logEntry);
                
                // å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œç«‹å³å‘é€
                if (this.pendingLogs.length >= this.maxPendingLogs) {
                    this.flushPendingLogs();
                    return;
                }
                
                // è®¾ç½®å®šæ—¶å™¨æ‰¹é‡å‘é€ï¼ˆå¦‚æœè¿˜æ²¡æœ‰è®¾ç½®ï¼‰
                if (!this.sendTimer) {
                    this.sendTimer = setTimeout(() => {
                        this.flushPendingLogs();
                        this.sendTimer = null;
                    }, this.sendInterval);
                }
            },
            
            async flushPendingLogs() {
                // å¦‚æœæ­£åœ¨å‘é€æˆ–é˜Ÿåˆ—ä¸ºç©ºï¼Œè·³è¿‡
                if (this.isSending || this.pendingLogs.length === 0) {
                    return;
                }
                
                // èŠ‚æµï¼šå¦‚æœè·ç¦»ä¸Šæ¬¡å‘é€æ—¶é—´å¤ªçŸ­ï¼Œå»¶è¿Ÿå‘é€
                const now = Date.now();
                if (now - this.lastSendTime < 2000) {
                    // å¦‚æœå·²ç»æœ‰å®šæ—¶å™¨ï¼Œä¸é‡å¤è®¾ç½®
                    if (!this.sendTimer) {
                        this.sendTimer = setTimeout(() => {
                            this.flushPendingLogs();
                            this.sendTimer = null;
                        }, 2000 - (now - this.lastSendTime));
                    }
                    return;
                }
                
                this.isSending = true;
                const logsToSend = [...this.pendingLogs];
                this.pendingLogs = [];
                this.lastSendTime = now;
                
                // æ¸…é™¤å®šæ—¶å™¨
                if (this.sendTimer) {
                    clearTimeout(this.sendTimer);
                    this.sendTimer = null;
                }
                
                try {
                    // æ‰¹é‡å‘é€æ—¥å¿—
                    const API_BASE_URL = window.API_BASE_URL || '';
                    await fetch(`${API_BASE_URL}/api/logs/frontend`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            logs: logsToSend.map(logEntry => ({
                                timestamp: logEntry.timestamp,
                                level: logEntry.level,
                                message: logEntry.message,
                                url: logEntry.url,
                                // é™åˆ¶dataå­—æ®µå¤§å°ï¼ˆæœ€å¤š1000å­—ç¬¦ï¼‰
                                data: typeof logEntry.data === 'string' 
                                    ? logEntry.data.substring(0, 1000)
                                    : typeof logEntry.data === 'object'
                                        ? JSON.stringify(logEntry.data).substring(0, 1000)
                                        : logEntry.data
                            }))
                        })
                    });
                } catch (error) {
                    // å‘é€å¤±è´¥ï¼Œå°†æ—¥å¿—é‡æ–°åŠ å…¥é˜Ÿåˆ—ï¼ˆæœ€å¤šä¿ç•™æœ€è¿‘20æ¡ï¼‰
                    this.pendingLogs = [...logsToSend.slice(-20), ...this.pendingLogs];
                    // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ä¸»æµç¨‹
                } finally {
                    this.isSending = false;
                }
            },
            
            // ä¸‹è½½æ—¥å¿—æ–‡ä»¶
            downloadLogs() {
                const logText = this.logs.map(log => 
                    `[${log.timestamp}] [${log.level.toUpperCase()}] ${log.message} | Data: ${JSON.stringify(log.data)} | URL: ${log.url}`
                ).join('\n');
                
                const blob = new Blob([logText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `frontend-logs-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        };
        
        // å°è£…å¸¸ç”¨çš„æ—¥å¿—æ–¹æ³•
        window.logger = {
            info: (msg, data) => frontendLogger.log('info', msg, data),
            warn: (msg, data) => frontendLogger.log('warn', msg, data),
            error: (msg, data) => frontendLogger.log('error', msg, data),
            debug: (msg, data) => frontendLogger.log('debug', msg, data),
            download: () => frontendLogger.downloadLogs()
        };
        
        // è®°å½•é¡µé¢åŠ è½½
        window.logger.info('Platform Dashboard é¡µé¢åŠ è½½', {
            url: window.location.href,
            userAgent: navigator.userAgent,
            timestamp: new Date().toISOString()
        });
        
        // è®°å½•APIè¯·æ±‚ï¼ˆæ‹¦æˆªfetchï¼‰- ä½†æ’é™¤æ—¥å¿—APIï¼Œé¿å…æ— é™å¾ªç¯
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            const [url, options = {}] = args;
            
            // æ’é™¤æ—¥å¿—APIå’Œé™æ€èµ„æºï¼Œé¿å…è®°å½•æ—¥å¿—è¯·æ±‚æœ¬èº«
            const urlString = String(url);
            if (urlString.includes('/api/logs/frontend') || 
                urlString.includes('.js') || 
                urlString.includes('.css') ||
                urlString.includes('.png') ||
                urlString.includes('.jpg') ||
                urlString.includes('.ico')) {
                return originalFetch(...args);
            }
            
            const startTime = Date.now();
            
            try {
                const response = await originalFetch(...args);
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                // åªè®°å½•é”™è¯¯å“åº”ï¼Œæ­£å¸¸å“åº”ä¸è®°å½•ï¼ˆå‡å°‘æ—¥å¿—é‡ï¼‰
                if (response.status >= 400) {
                    window.logger.warn('APIå“åº”å¼‚å¸¸', {
                        method: options.method || 'GET',
                        url: urlString,
                        status: response.status,
                        statusText: response.statusText,
                        duration: `${duration}ms`
                    });
                }
                
                return response;
            } catch (error) {
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                // åªè®°å½•é”™è¯¯
                window.logger.error('APIè¯·æ±‚å¤±è´¥', {
                    method: options.method || 'GET',
                    url: urlString,
                    error: error.message,
                    duration: `${duration}ms`
                });
                
                throw error;
            }
        };

        // åˆå§‹åŒ–åˆçº¦
        async function initializeContracts() {
            // ä¼˜å…ˆä½¿ç”¨å®Œæ•´ABIï¼Œå¦‚æœåŠ è½½å¤±è´¥åˆ™ä½¿ç”¨æ‰‹åŠ¨å®šä¹‰çš„ç®€åŒ–ABI
            let TRUST_FLOW_RIDE_ABI = window.contractABI;
            
            // éªŒè¯ABIæ ¼å¼
            if (TRUST_FLOW_RIDE_ABI) {
                if (!Array.isArray(TRUST_FLOW_RIDE_ABI)) {
                    console.error('[PLATFORM] ABIæ ¼å¼é”™è¯¯ï¼šä¸æ˜¯æ•°ç»„æ ¼å¼', typeof TRUST_FLOW_RIDE_ABI);
                    window.logger?.error('[PLATFORM] ABIæ ¼å¼é”™è¯¯', { type: typeof TRUST_FLOW_RIDE_ABI, abi: TRUST_FLOW_RIDE_ABI });
                    TRUST_FLOW_RIDE_ABI = null; // é‡ç½®ï¼Œä½¿ç”¨æ‰‹åŠ¨å®šä¹‰çš„ABI
                } else {
                    console.log(`[PLATFORM] ä½¿ç”¨å®Œæ•´çš„åˆçº¦ABI (${TRUST_FLOW_RIDE_ABI.length} ä¸ªæ¡ç›®)`);
                    window.logger?.info('[PLATFORM] ä½¿ç”¨å®Œæ•´çš„åˆçº¦ABI', { abiLength: TRUST_FLOW_RIDE_ABI.length });
                    
                    // éªŒè¯ABIä¸­æ˜¯å¦åŒ…å«å¿…éœ€çš„å‡½æ•°
                    const hasGetOrder = TRUST_FLOW_RIDE_ABI.some(item => 
                        item.type === 'function' && item.name === 'getOrder'
                    );
                    const hasGetDisputeStatus = TRUST_FLOW_RIDE_ABI.some(item => 
                        item.type === 'function' && item.name === 'getDisputeStatus'
                    );
                    
                    if (!hasGetOrder || !hasGetDisputeStatus) {
                        console.warn('[PLATFORM] å®Œæ•´ABIä¸­ç¼ºå°‘å¿…éœ€å‡½æ•°ï¼Œå°†ä½¿ç”¨æ‰‹åŠ¨å®šä¹‰çš„ABI', {
                            hasGetOrder,
                            hasGetDisputeStatus
                        });
                        window.logger?.warn('[PLATFORM] å®Œæ•´ABIä¸­ç¼ºå°‘å¿…éœ€å‡½æ•°', { hasGetOrder, hasGetDisputeStatus });
                        TRUST_FLOW_RIDE_ABI = null; // é‡ç½®ï¼Œä½¿ç”¨æ‰‹åŠ¨å®šä¹‰çš„ABI
                    }
                }
            }
            
            if (!TRUST_FLOW_RIDE_ABI) {
                console.warn('[PLATFORM] ä½¿ç”¨æ‰‹åŠ¨å®šä¹‰çš„ç®€åŒ–ABIï¼ˆå®Œæ•´ABIåŠ è½½å¤±è´¥æˆ–æ— æ•ˆï¼‰');
                window.logger?.warn('[PLATFORM] ä½¿ç”¨æ‰‹åŠ¨å®šä¹‰çš„ç®€åŒ–ABI');
                // æ‰‹åŠ¨å®šä¹‰çš„ç®€åŒ–ABIï¼ˆä»…åŒ…å«å¿…éœ€çš„å‡½æ•°å’Œäº‹ä»¶ï¼‰
                TRUST_FLOW_RIDE_ABI = [
                    "event PaymentReleased(uint256 indexed orderId, address indexed driver, uint256 driverAmount, uint256 platformFee)",
                    "event RideStarted(uint256 indexed orderId, uint256 timestamp)",
                    "event RideCompleted(uint256 indexed orderId, uint256 timestamp)",
                    "event RideSettled(uint256 indexed orderId, uint256 timestamp)",
                    "event OrderAccepted(uint256 indexed orderId, address indexed driver)",
                    "event DisputeOpened(uint256 indexed orderId, address indexed by, string reason, uint256 timestamp)",
                    "event DisputeResolved(uint256 indexed orderId, address indexed winner, string detail, uint256 timestamp)",
                    "function platformWallet() external view returns (address)",
                    "function getOrder(uint256 _orderId) external view returns (tuple(uint256 orderId, address passenger, address driver, tuple(int256 latitude, int256 longitude, string addressText) pickup, tuple(int256 latitude, int256 longitude, string addressText) destination, string category, string subCategory, uint256 estimatedFare, uint256 actualFare, uint8 status, uint8 rideStatus, uint256 createdAt, uint256 acceptedAt, uint256 pickedUpAt, uint256 completedAt, uint256 startTimestamp, uint256 endTimestamp, string ipfsHash, bool disputeOpened, bool disputeResolved, address disputeOpener, address disputeWinner, string disputeReason, uint256 disputeOpenedAt, uint256 disputeResolvedAt, string disputeResolutionDetail))",
                    "function getDisputeStatus(uint256 _orderId) external view returns (bool disputeOpened, string memory disputeReason, bool disputeResolved, address disputeOpener, address disputeWinner, uint256 disputeOpenedAt, uint256 disputeResolvedAt, string memory disputeResolutionDetail, uint8 rideStatus)",
                    "function resolveDispute(uint256 _orderId, address _winner, string memory _detail) external",
                    "function settle(uint256 _orderId) external",
                    "function orderCount() external view returns (uint256)"
                ];
            }

            if (window.contractAddresses?.rideOrder) {
                const contractAddress = window.contractAddresses.rideOrder;
                console.log(`[PLATFORM] åˆå§‹åŒ–åˆçº¦å®ä¾‹ï¼Œåœ°å€: ${contractAddress}`);
                window.logger?.info('[PLATFORM] åˆå§‹åŒ–åˆçº¦å®ä¾‹', { 
                    contractAddress,
                    abiType: Array.isArray(TRUST_FLOW_RIDE_ABI) ? 'array' : typeof TRUST_FLOW_RIDE_ABI,
                    abiLength: Array.isArray(TRUST_FLOW_RIDE_ABI) ? TRUST_FLOW_RIDE_ABI.length : 'N/A'
                });
                
                try {
                    // ä½¿ç”¨ provider åˆ›å»ºåˆçº¦å®ä¾‹ï¼ˆç”¨äºè¯»å–æ“ä½œï¼‰
                    contracts.rideOrder = new ethers.Contract(
                        contractAddress,
                        TRUST_FLOW_RIDE_ABI,
                        provider
                    );
                    
                    console.log('[PLATFORM] åˆçº¦å®ä¾‹åˆ›å»ºæˆåŠŸï¼ˆåªè¯»ï¼‰');
                    
                    // éªŒè¯åˆçº¦å®ä¾‹æ˜¯å¦æœ‰æ•ˆ
                    if (!contracts.rideOrder || !contracts.rideOrder.address) {
                        throw new Error('åˆçº¦å®ä¾‹åˆ›å»ºå¤±è´¥ï¼šåœ°å€æ— æ•ˆ');
                    }
                    
                    // å¦‚æœæœ‰ signerï¼Œä¹Ÿåˆ›å»ºä¸€ä¸ªå¸¦ signer çš„åˆçº¦å®ä¾‹ï¼ˆç”¨äºå†™å…¥æ“ä½œï¼‰
                    if (signer) {
                        contracts.rideOrderWithSigner = new ethers.Contract(
                            contractAddress,
                            TRUST_FLOW_RIDE_ABI,
                            signer
                        );
                        console.log('[PLATFORM] åˆçº¦å®ä¾‹åˆ›å»ºæˆåŠŸï¼ˆå¯å†™ï¼‰');
                    }
                    
                    // å°† contracts èµ‹å€¼ç»™ window.contracts ä»¥ä¾¿å…¨å±€è®¿é—®
                    window.contracts = contracts;
                    
                    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                    setupPlatformEventListeners();
                    
                    console.log('[PLATFORM] åˆçº¦åˆå§‹åŒ–å®Œæˆ');
                    window.logger?.info('[PLATFORM] åˆçº¦åˆå§‹åŒ–å®Œæˆ', { contractAddress });
                } catch (error) {
                    console.error('[PLATFORM] åˆçº¦åˆå§‹åŒ–å¤±è´¥:', error);
                    window.logger?.error('[PLATFORM] åˆçº¦åˆå§‹åŒ–å¤±è´¥', {
                        error: error.message,
                        stack: error.stack,
                        contractAddress,
                        abiType: Array.isArray(TRUST_FLOW_RIDE_ABI) ? 'array' : typeof TRUST_FLOW_RIDE_ABI
                    });
                    throw error;
                }
            } else {
                console.error('[PLATFORM] åˆçº¦åœ°å€æœªè®¾ç½®');
                window.logger?.error('[PLATFORM] åˆçº¦åœ°å€æœªè®¾ç½®', { contractAddresses: window.contractAddresses });
            }
        }
        
        // è®¾ç½®å¹³å°ç«¯äº‹ä»¶ç›‘å¬å™¨
        function setupPlatformEventListeners() {
            if (!contracts.rideOrder) {
                console.warn('âš ï¸ åˆçº¦æœªåˆå§‹åŒ–ï¼Œæ— æ³•è®¾ç½®äº‹ä»¶ç›‘å¬å™¨');
                return;
            }
            
            console.log('ğŸ“¡ è®¾ç½®å¹³å°ç«¯è®¢å•çŠ¶æ€äº‹ä»¶ç›‘å¬å™¨...');
            
            // å…ˆç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç›‘å¬
            try {
                contracts.rideOrder.removeAllListeners('RideStarted');
                contracts.rideOrder.removeAllListeners('RideCompleted');
                contracts.rideOrder.removeAllListeners('RideSettled');
                contracts.rideOrder.removeAllListeners('PaymentReleased');
                contracts.rideOrder.removeAllListeners('OrderAccepted');
                contracts.rideOrder.removeAllListeners('DisputeOpened');
                contracts.rideOrder.removeAllListeners('DisputeResolved');
            } catch (e) {
                console.warn('ç§»é™¤æ—§ç›‘å¬å™¨æ—¶å‡ºé”™ï¼ˆå¯å¿½ç•¥ï¼‰:', e);
            }
            
            // äº‹ä»¶è§¦å‘åˆ·æ–°å‡½æ•°ï¼ˆå¸¦é˜²æŠ–ï¼‰
            let eventRefreshTimer = null;
            function scheduleEventRefresh() {
                if (eventRefreshTimer) {
                    clearTimeout(eventRefreshTimer);
                }
                eventRefreshTimer = setTimeout(() => {
                    console.log('ğŸ”„ å“åº”äº‹ä»¶ï¼Œåˆ·æ–°å¹³å°æ•°æ®...');
                    loadRevenueData(false).catch(err => {
                        console.error('åˆ·æ–°å¹³å°æ”¶å…¥æ•°æ®å¤±è´¥:', err);
                    });
                    // åˆ·æ–°è®¢å•ç»Ÿè®¡æ•°æ®
                    if (window.loadOrderStatistics) {
                        window.loadOrderStatistics().catch(err => {
                            console.error('åˆ·æ–°è®¢å•ç»Ÿè®¡æ•°æ®å¤±è´¥:', err);
                        });
                    }
                    // å¦‚æœå½“å‰åœ¨æ´»è·ƒè®¢å•tabï¼Œä¹Ÿåˆ·æ–°æ´»è·ƒè®¢å•åˆ—è¡¨
                    const activeTab = document.getElementById('tab-content-active');
                    if (activeTab && activeTab.style.display !== 'none') {
                        if (window.loadActiveOrders) {
                            window.loadActiveOrders().catch(err => {
                                console.error('åˆ·æ–°æ´»è·ƒè®¢å•å¤±è´¥:', err);
                            });
                        }
                    }
                    // å¦‚æœå½“å‰åœ¨äº‰è®®è®¢å•tabï¼Œä¹Ÿåˆ·æ–°äº‰è®®åˆ—è¡¨
                    const disputesTab = document.getElementById('tab-content-disputes');
                    if (disputesTab && disputesTab.style.display !== 'none') {
                        if (typeof loadDisputes === 'function') {
                            loadDisputes().catch(err => {
                                console.error('åˆ·æ–°äº‰è®®åˆ—è¡¨å¤±è´¥:', err);
                            });
                        }
                    }
                }, 2000); // 2ç§’é˜²æŠ–ï¼Œé¿å…å¤šä¸ªäº‹ä»¶åŒæ—¶è§¦å‘æ—¶é‡å¤åˆ·æ–°
            }
            
            // ç›‘å¬ RideStarted äº‹ä»¶
            contracts.rideOrder.on('RideStarted', async (orderId, timestamp) => {
                const orderIdStr = orderId.toString ? orderId.toString() : String(orderId);
                console.log('ğŸš€ Ride Started äº‹ä»¶è§¦å‘:', orderIdStr);
                scheduleEventRefresh();
            });
            
            // ç›‘å¬ RideCompleted äº‹ä»¶
            contracts.rideOrder.on('RideCompleted', async (orderId, timestamp) => {
                const orderIdStr = orderId.toString ? orderId.toString() : String(orderId);
                console.log('âœ… Ride Completed äº‹ä»¶è§¦å‘:', orderIdStr);
                scheduleEventRefresh();
            });
            
            // ç›‘å¬ RideSettled äº‹ä»¶
            contracts.rideOrder.on('RideSettled', async (orderId, timestamp) => {
                const orderIdStr = orderId.toString ? orderId.toString() : String(orderId);
                console.log('ğŸ’° Ride Settled äº‹ä»¶è§¦å‘:', orderIdStr);
                scheduleEventRefresh();
            });
            
            // ç›‘å¬ PaymentReleased äº‹ä»¶ï¼ˆå¹³å°æ”¶å…¥ç›¸å…³ï¼‰
            contracts.rideOrder.on('PaymentReleased', async (orderId, driver, driverAmount, platformFee) => {
                const orderIdStr = orderId.toString ? orderId.toString() : String(orderId);
                console.log('ğŸ’µ Payment Released äº‹ä»¶è§¦å‘:', orderIdStr, 'Platform Fee:', ethers.utils.formatEther(platformFee));
                scheduleEventRefresh();
            });
            
            // ç›‘å¬ OrderAccepted äº‹ä»¶
            contracts.rideOrder.on('OrderAccepted', async (orderId, driver) => {
                const orderIdStr = orderId.toString ? orderId.toString() : String(orderId);
                console.log('ğŸ“‹ Order Accepted äº‹ä»¶è§¦å‘:', orderIdStr);
                scheduleEventRefresh();
            });
            
            // ç›‘å¬ DisputeOpened äº‹ä»¶
            contracts.rideOrder.on('DisputeOpened', async (orderId, by, reason, timestamp) => {
                const orderIdStr = orderId.toString ? orderId.toString() : String(orderId);
                console.log('âš–ï¸ Dispute Opened äº‹ä»¶è§¦å‘:', orderIdStr, reason);
                scheduleEventRefresh();
                // æ— è®ºå½“å‰åœ¨å“ªä¸ª tabï¼Œéƒ½åˆ·æ–°äº‰è®®åˆ—è¡¨ï¼ˆç¡®ä¿æ•°æ®æ˜¯æœ€æ–°çš„ï¼‰
                if (typeof loadDisputes === 'function') {
                    console.log('ğŸ”„ åˆ·æ–°äº‰è®®åˆ—è¡¨...');
                    loadDisputes().catch(err => {
                        console.error('åˆ·æ–°äº‰è®®åˆ—è¡¨å¤±è´¥:', err);
                    });
                }
            });
            
            // ç›‘å¬ DisputeResolved äº‹ä»¶
            contracts.rideOrder.on('DisputeResolved', async (orderId, winner, detail, timestamp) => {
                const orderIdStr = orderId.toString ? orderId.toString() : String(orderId);
                console.log('âœ… Dispute Resolved äº‹ä»¶è§¦å‘:', orderIdStr, winner);
                scheduleEventRefresh();
                // æ— è®ºå½“å‰åœ¨å“ªä¸ª tabï¼Œéƒ½åˆ·æ–°äº‰è®®åˆ—è¡¨ï¼ˆç¡®ä¿æ•°æ®æ˜¯æœ€æ–°çš„ï¼‰
                if (typeof loadDisputes === 'function') {
                    console.log('ğŸ”„ åˆ·æ–°äº‰è®®åˆ—è¡¨...');
                    loadDisputes().catch(err => {
                        console.error('åˆ·æ–°äº‰è®®åˆ—è¡¨å¤±è´¥:', err);
                    });
                }
            });
            
            console.log('âœ… å¹³å°ç«¯è®¢å•çŠ¶æ€äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®å®Œæˆ');
        }

        // åŠ è½½æ”¶å…¥æ•°æ®
        let isLoadingRevenue = false;
        let lastLoadTime = 0;
        const MIN_LOAD_INTERVAL = 2000; // æœ€å°åŠ è½½é—´éš” 2 ç§’ï¼Œé˜²æ­¢é¢‘ç¹åˆ·æ–°
        
        async function loadRevenueData(showLoading = true) {
            if (!contracts.rideOrder) {
                alert('åˆçº¦æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            // é˜²æ­¢å¹¶å‘åŠ è½½
            if (isLoadingRevenue) {
                console.log('â¸ï¸ æ•°æ®æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡æœ¬æ¬¡è¯·æ±‚');
                return;
            }

            // èŠ‚æµï¼šå¦‚æœè·ç¦»ä¸Šæ¬¡åŠ è½½æ—¶é—´å¤ªçŸ­ï¼Œåˆ™å»¶è¿Ÿæ‰§è¡Œ
            const now = Date.now();
            if (now - lastLoadTime < MIN_LOAD_INTERVAL) {
                const delay = MIN_LOAD_INTERVAL - (now - lastLoadTime);
                console.log(`â¸ï¸ è·ç¦»ä¸Šæ¬¡åŠ è½½æ—¶é—´è¿‡çŸ­ï¼Œå»¶è¿Ÿ ${delay}ms åæ‰§è¡Œ`);
                setTimeout(() => loadRevenueData(showLoading), delay);
                return;
            }

            isLoadingRevenue = true;
            lastLoadTime = now;

            // åªåœ¨éœ€è¦æ—¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆé¿å…é—ªçƒï¼‰
            if (showLoading && revenueData.length === 0) {
                document.getElementById('loading-revenue').style.display = 'block';
                document.getElementById('revenue-list').style.display = 'none';
                document.getElementById('empty-state-revenue').style.display = 'none';
            }

            try {
                // æŸ¥è¯¢ PaymentReleased äº‹ä»¶
                const filter = contracts.rideOrder.filters.PaymentReleased();
                const currentBlock = await provider.getBlockNumber();
                const events = await contracts.rideOrder.queryFilter(filter, 0, currentBlock);

                // ä½¿ç”¨ Map å»é‡ï¼ŒåŸºäº orderId + transactionHashï¼ˆé˜²æ­¢åŒä¸€è®¢å•çš„é‡å¤äº‹ä»¶ï¼‰
                const uniqueEventsMap = new Map();
                for (const event of events) {
                    const key = `${event.args.orderId.toString()}-${event.transactionHash}`;
                    if (!uniqueEventsMap.has(key)) {
                        uniqueEventsMap.set(key, event);
                    }
                }

                // å¤„ç†äº‹ä»¶æ•°æ®
                const newRevenueData = [];
                for (const event of uniqueEventsMap.values()) {
                    const receipt = await provider.getTransactionReceipt(event.transactionHash);
                    const tx = await provider.getTransaction(event.transactionHash);
                    const block = await provider.getBlock(receipt.blockNumber);

                    newRevenueData.push({
                        orderId: event.args.orderId.toString(),
                        driver: event.args.driver,
                        driverAmount: event.args.driverAmount,
                        platformFee: event.args.platformFee,
                        transactionHash: event.transactionHash,
                        blockNumber: receipt.blockNumber,
                        timestamp: block.timestamp
                    });
                }

                // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                newRevenueData.sort((a, b) => b.timestamp - a.timestamp);

                // æ£€æŸ¥æ•°æ®æ˜¯å¦çœŸçš„å˜åŒ–äº†ï¼ˆé¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“ï¼‰
                const dataChanged = JSON.stringify(revenueData.map(d => ({
                    orderId: d.orderId,
                    transactionHash: d.transactionHash
                }))) !== JSON.stringify(newRevenueData.map(d => ({
                    orderId: d.orderId,
                    transactionHash: d.transactionHash
                })));

                if (dataChanged || revenueData.length === 0) {
                    revenueData = newRevenueData;

                    // æ›´æ–°ç»Ÿè®¡æ•°æ®
                    await updateStatistics();

                    // æ¸²æŸ“åˆ—è¡¨
                    renderRevenueList();
                } else {
                    console.log('ğŸ“Š æ•°æ®æœªå˜åŒ–ï¼Œè·³è¿‡é‡æ–°æ¸²æŸ“');
                }

            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                if (showLoading) {
                    alert('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
                }
            } finally {
                isLoadingRevenue = false;
                if (showLoading) {
                    document.getElementById('loading-revenue').style.display = 'none';
                }
            }
        }
        
        // å¹³å°æ”¶å…¥æ•°æ®è‡ªåŠ¨åˆ·æ–° - è½®è¯¢æœºåˆ¶ï¼ˆå¢åŠ é—´éš”ä»¥å‡å°‘è°ƒç”¨ï¼‰
        let platformRefreshInterval = null;
        const PLATFORM_REFRESH_INTERVAL = 30000; // 30ç§’åˆ·æ–°ä¸€æ¬¡ï¼ˆä»10ç§’å¢åŠ åˆ°30ç§’ï¼‰
        
        function startPlatformAutoRefresh() {
            // å¦‚æœå·²ç»æœ‰å®šæ—¶å™¨ï¼Œå…ˆæ¸…é™¤
            if (platformRefreshInterval) {
                clearInterval(platformRefreshInterval);
            }
            
            // åˆ›å»ºæ–°çš„å®šæ—¶å™¨
            platformRefreshInterval = setInterval(() => {
                if (contracts?.rideOrder && provider) {
                    console.log('ğŸ”„ è‡ªåŠ¨åˆ·æ–°å¹³å°æ”¶å…¥æ•°æ®...');
                    loadRevenueData(false).catch(err => {
                        console.error('è‡ªåŠ¨åˆ·æ–°å¹³å°æ”¶å…¥æ•°æ®å¤±è´¥:', err);
                    });
                }
            }, PLATFORM_REFRESH_INTERVAL);
            
            console.log('âœ… å¹³å°æ”¶å…¥æ•°æ®è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨ï¼ˆæ¯', PLATFORM_REFRESH_INTERVAL / 1000, 'ç§’ï¼‰');
        }
        
        function stopPlatformAutoRefresh() {
            if (platformRefreshInterval) {
                clearInterval(platformRefreshInterval);
                platformRefreshInterval = null;
                console.log('â¸ï¸ å¹³å°æ”¶å…¥æ•°æ®è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢');
            }
        }
        
        window.startPlatformAutoRefresh = startPlatformAutoRefresh;
        window.stopPlatformAutoRefresh = stopPlatformAutoRefresh;

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        // ä½™é¢æŸ¥è¯¢ç¼“å­˜ï¼ˆé¿å…é¢‘ç¹è°ƒç”¨ eth_callï¼‰
        let balanceCache = {
            platformBalance: null,
            accountBalance: null,
            lastUpdate: 0,
            cacheDuration: 30000 // 30ç§’ç¼“å­˜
        };
        
        async function updateStatistics() {
            const totalRevenue = revenueData.reduce((sum, item) => 
                sum.add(item.platformFee), 
                ethers.BigNumber.from(0)
            );

            // æŸ¥è¯¢å¹³å°é’±åŒ…ä½™é¢ï¼ˆä½¿ç”¨ç¼“å­˜æœºåˆ¶ï¼‰
            try {
                const platformWallet = window.contractAddresses?.platformWallet;
                const now = Date.now();
                const cacheExpired = (now - balanceCache.lastUpdate) > balanceCache.cacheDuration;
                
                if (platformWallet) {
                    // å¦‚æœç¼“å­˜æœªè¿‡æœŸï¼Œä½¿ç”¨ç¼“å­˜å€¼
                    if (!cacheExpired && balanceCache.platformBalance !== null) {
                        const balanceETH = balanceCache.platformBalance;
                        document.getElementById('current-balance').textContent = 
                            balanceETH.toFixed(8);
                        document.getElementById('current-balance-usd').textContent = 
                            '$' + (balanceETH * ETH_TO_USD_RATE).toFixed(2) + ' USD';
                    } else {
                        // ç¼“å­˜è¿‡æœŸæˆ–ä¸å­˜åœ¨ï¼Œé‡æ–°æŸ¥è¯¢
                        const balance = await provider.getBalance(platformWallet);
                        const balanceETH = parseFloat(ethers.utils.formatEther(balance));
                        
                        // æ›´æ–°ç¼“å­˜
                        balanceCache.platformBalance = balanceETH;
                        balanceCache.lastUpdate = now;
                        
                        document.getElementById('current-balance').textContent = 
                            balanceETH.toFixed(8);
                        document.getElementById('current-balance-usd').textContent = 
                            '$' + (balanceETH * ETH_TO_USD_RATE).toFixed(2) + ' USD';
                    }
                } else {
                    console.warn('å¹³å°é’±åŒ…åœ°å€æœªåŠ è½½');
                    document.getElementById('current-balance').textContent = 'N/A';
                    document.getElementById('current-balance-usd').textContent = 'N/A';
                }
            } catch (error) {
                console.error('æŸ¥è¯¢å¹³å°é’±åŒ…ä½™é¢å¤±è´¥:', error);
                // å¦‚æœæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ç¼“å­˜å€¼
                if (balanceCache.platformBalance !== null) {
                    const balanceETH = balanceCache.platformBalance;
                    document.getElementById('current-balance').textContent = 
                        balanceETH.toFixed(8) + ' (cached)';
                    document.getElementById('current-balance-usd').textContent = 
                        '$' + (balanceETH * ETH_TO_USD_RATE).toFixed(2) + ' USD';
                } else {
                    document.getElementById('current-balance').textContent = 'Error';
                    document.getElementById('current-balance-usd').textContent = 'Error';
                }
            }

            document.getElementById('total-revenue-eth').textContent = 
                parseFloat(ethers.utils.formatEther(totalRevenue)).toFixed(8);
            document.getElementById('total-revenue-usd').textContent = 
                '$' + (parseFloat(ethers.utils.formatEther(totalRevenue)) * ETH_TO_USD_RATE).toFixed(2) + ' USD';
            
            // ä»APIè·å–è®¢å•æ€»æ•°ï¼ˆä»orderæ–‡ä»¶æ•°é‡ï¼‰
            try {
                const response = await fetch('/api/platform/summary');
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        document.getElementById('total-transactions').textContent = result.data.totalTransactions || 0;
                    } else {
                        document.getElementById('total-transactions').textContent = revenueData.length;
                    }
                } else {
                    document.getElementById('total-transactions').textContent = revenueData.length;
                }
            } catch (error) {
                console.error('è·å–è®¢å•æ€»æ•°å¤±è´¥:', error);
                document.getElementById('total-transactions').textContent = revenueData.length;
            }
        }

        // å½“å‰é€‰ä¸­çš„çŠ¶æ€ç­›é€‰
        let currentStatusFilter = 'all';
        
        // çŠ¶æ€ç­›é€‰å‡½æ•°
        function filterByStatus(status) {
            currentStatusFilter = status;
            
            // æ›´æ–°Tabé«˜äº®
            document.querySelectorAll('.status-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.background = '#f9fafb';
                tab.style.color = '#6b7280';
            });
            
            const activeTab = document.getElementById(`status-tab-${status}`);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.style.background = '#3b82f6';
                activeTab.style.color = 'white';
            }
            
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            renderRevenueList();
        }
        
        // æ¸²æŸ“æ”¶å…¥åˆ—è¡¨
        function renderRevenueList() {
            const container = document.getElementById('revenue-list');
            const emptyState = document.getElementById('empty-state-revenue');
            const loading = document.getElementById('loading-revenue');

            // æ£€æŸ¥å¿…è¦çš„ DOM å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!container) {
                console.error('âŒ revenue-list å®¹å™¨ä¸å­˜åœ¨');
                return;
            }

            // ç¡®ä¿åŠ è½½çŠ¶æ€å·²éšè—
            if (loading) {
                loading.style.display = 'none';
            }

            // åº”ç”¨ç­›é€‰
            let filteredData = revenueData;
            
            // çŠ¶æ€ç­›é€‰ï¼ˆç§»é™¤ï¼Œå› ä¸ºä¸å†æœ‰orderDetailsï¼‰
            // æ³¨æ„ï¼šå¦‚æœéœ€è¦çŠ¶æ€ç­›é€‰ï¼Œéœ€è¦ä»å…¶ä»–åœ°æ–¹è·å–è®¢å•çŠ¶æ€

            // æ—¥æœŸç­›é€‰
            const startDateEl = document.getElementById('start-date');
            const endDateEl = document.getElementById('end-date');
            const startDate = startDateEl ? startDateEl.value : '';
            const endDate = endDateEl ? endDateEl.value : '';
            if (startDate || endDate) {
                filteredData = filteredData.filter(item => {
                    const itemDate = new Date(item.timestamp * 1000).toISOString().split('T')[0];
                    if (startDate && itemDate < startDate) return false;
                    if (endDate && itemDate > endDate) return false;
                    return true;
                });
            }

            // æœç´¢ç­›é€‰
            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            if (searchTerm) {
                filteredData = filteredData.filter(item => 
                    item.orderId.includes(searchTerm) ||
                    item.transactionHash.toLowerCase().includes(searchTerm) ||
                    item.driver.toLowerCase().includes(searchTerm)
                );
            }

            if (filteredData.length === 0) {
                container.style.display = 'none';
                if (emptyState) {
                    emptyState.style.display = 'block';
                }
                return;
            }

            container.style.display = 'flex';
            if (emptyState) {
                emptyState.style.display = 'none';
            }

            container.innerHTML = filteredData.map((item, index) => {
                const date = new Date(item.timestamp * 1000);
                const platformFeeETH = ethers.utils.formatEther(item.platformFee);
                const driverAmountETH = ethers.utils.formatEther(item.driverAmount);
                const orderAmount = item.driverAmount.add(item.platformFee);
                const orderAmountETH = ethers.utils.formatEther(orderAmount);

                return `
                    <div class="revenue-item">
                        <div class="revenue-header">
                            <div>
                                <div class="revenue-date">${date.toLocaleString('zh-CN', { 
                                    year: 'numeric', 
                                    month: '2-digit', 
                                    day: '2-digit', 
                                    hour: '2-digit', 
                                    minute: '2-digit',
                                    second: '2-digit'
                                })}</div>
                                <div style="margin-top: 8px; font-size: 14px; color: #6b7280;">
                                    ${window.platformTexts?.order || 'è®¢å•'} #${item.orderId}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div class="revenue-amount">
                                    +${parseFloat(platformFeeETH).toFixed(8)} ETH
                                    <span class="revenue-amount usd">($${(parseFloat(platformFeeETH) * ETH_TO_USD_RATE).toFixed(2)})</span>
                                </div>
                                <button class="btn-details" onclick="showDetailModal(${index})" data-index="${index}">
                                    ${window.platformTexts?.details || 'è¯¦æƒ…'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // å­˜å‚¨ç­›é€‰åçš„æ•°æ®ä¾›è¯¦æƒ…ä½¿ç”¨
            window.filteredRevenueData = filteredData;
        }

        // æ˜¾ç¤ºè¯¦æƒ…æ¨¡æ€æ¡†
        // å‚æ•°å¯ä»¥æ˜¯ç´¢å¼•ï¼ˆæ•°å­—ï¼‰æˆ–è®¢å•IDï¼ˆå­—ç¬¦ä¸²ï¼‰
        async function showDetailModal(indexOrOrderId) {
            let item = null;
            
            // åˆ¤æ–­å‚æ•°æ˜¯ç´¢å¼•è¿˜æ˜¯è®¢å•ID
            if (typeof indexOrOrderId === 'number') {
                // æ˜¯ç´¢å¼•ï¼Œä» filteredRevenueData è·å–
                if (!window.filteredRevenueData || !window.filteredRevenueData[indexOrOrderId]) {
                    console.error('æ— æ³•æ‰¾åˆ°ç´¢å¼•å¯¹åº”çš„æ”¶å…¥æ•°æ®:', indexOrOrderId);
                    return;
                }
                item = window.filteredRevenueData[indexOrOrderId];
            } else {
                // æ˜¯è®¢å•IDï¼Œä» disputeData æˆ– revenueData ä¸­æŸ¥æ‰¾
                const orderIdStr = indexOrOrderId.toString();
                
                // å…ˆä»äº‰è®®æ•°æ®ä¸­æŸ¥æ‰¾
                const dispute = disputeData.find(d => d.orderId === orderIdStr);
                if (dispute && dispute.orderDetails) {
                    // æ„é€ ä¸ revenueData ç›¸åŒæ ¼å¼çš„æ•°æ®
                    const orderDetails = dispute.orderDetails;
                    const estimatedFare = orderDetails.estimatedFare || orderDetails.actualFare || ethers.BigNumber.from(0);
                    const platformFee = estimatedFare.mul(5).div(100); // 5%
                    const driverAmount = estimatedFare.sub(platformFee);
                    
                    item = {
                        orderId: orderIdStr,
                        driver: orderDetails.driver && orderDetails.driver !== ethers.constants.AddressZero ? orderDetails.driver : orderDetails.passenger,
                        platformFee: platformFee,
                        driverAmount: driverAmount,
                        timestamp: dispute.timestamp || dispute.disputeOpenedAt || Math.floor(Date.now() / 1000),
                        blockNumber: dispute.blockNumber || 0,
                        transactionHash: dispute.transactionHash || '',
                        orderDetails: orderDetails,
                        disputeInfo: {
                            openedBy: dispute.openedBy,
                            reason: dispute.reason,
                            disputeOpened: dispute.disputeOpened,
                            disputeResolved: dispute.disputeResolved,
                            disputeWinner: dispute.disputeWinner,
                            disputeOpenedAt: dispute.disputeOpenedAt,
                            disputeResolvedAt: dispute.disputeResolvedAt,
                            disputeResolutionDetail: dispute.disputeResolutionDetail
                        }
                    };
                } else {
                    // ä»æ”¶å…¥æ•°æ®ä¸­æŸ¥æ‰¾
                    const revenueItem = revenueData.find(r => r.orderId === orderIdStr);
                    if (revenueItem) {
                        item = revenueItem;
                    } else {
                        console.error('æ— æ³•æ‰¾åˆ°è®¢å•IDå¯¹åº”çš„æ•°æ®:', orderIdStr);
                        alert('æœªæ‰¾åˆ°è¯¥è®¢å•çš„è¯¦ç»†ä¿¡æ¯');
                        return;
                    }
                }
            }
            
            if (!item) return;

            const date = new Date(item.timestamp * 1000);
            const platformFeeETH = ethers.utils.formatEther(item.platformFee);
            const driverAmountETH = ethers.utils.formatEther(item.driverAmount);
            const orderAmount = item.driverAmount.add(item.platformFee);
            const orderAmountETH = ethers.utils.formatEther(orderAmount);

            // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¸æœºå’Œä¹˜å®¢ï¼‰
            let driverInfo = { id: null, nickname: null };
            let passengerInfo = { id: null, nickname: null };
            let orderHistory = { history: [] };
            
            try {
                const addresses = [item.driver];
                
                // æ‰¹é‡è·å–ç”¨æˆ·ä¿¡æ¯
                const userInfoResponse = await fetch('/api/user-info/batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ addresses: addresses })
                });
                
                if (userInfoResponse.ok) {
                    const result = await userInfoResponse.json();
                    if (result.success && result.data) {
                        driverInfo = result.data[item.driver] || { id: null, nickname: null };
                    }
                }
                
                // è·å–è®¢å•å†å²çŠ¶æ€
                const historyResponse = await fetch(`/api/order-history/${item.orderId}`);
                if (historyResponse.ok) {
                    const historyResult = await historyResponse.json();
                    if (historyResult.success && historyResult.data) {
                        orderHistory = historyResult.data;
                    }
                }
            } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯æˆ–è®¢å•å†å²å¤±è´¥:', error);
            }

            const t = window.platformTexts || {};
            const isZh = getCurrentLang() === 'zh';
            const dateLocale = isZh ? 'zh-CN' : 'en-US';
            
            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <div class="transaction-detail">
                    <div class="detail-section">
                        <h3>ğŸ“‹ ${t.basicInfo || 'åŸºæœ¬ä¿¡æ¯'}</h3>
                        <div class="detail-row">
                            <span class="detail-row-label">${t.orderId || 'è®¢å•ID'}</span>
                            <span class="detail-row-value">#${item.orderId}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-row-label">${t.transactionTime || 'äº¤æ˜“æ—¶é—´'}</span>
                            <span class="detail-row-value">${date.toLocaleString(dateLocale)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-row-label">${t.blockNumber || 'åŒºå—å·'}</span>
                            <span class="detail-row-value">#${item.blockNumber}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-row-label">${t.transactionHash || 'äº¤æ˜“å“ˆå¸Œ'}</span>
                            <span class="detail-row-value">
                                ${item.transactionHash}
                                <button class="copy-btn" onclick="copyToClipboard('${item.transactionHash}')">${t.copy || t.clickToCopy || 'å¤åˆ¶'}</button>
                            </span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>ğŸ’° ${t.amountDetails || 'é‡‘é¢æ˜ç»†'}</h3>
                        <div class="detail-row">
                            <span class="detail-row-label">${t.orderAmount || 'è®¢å•æ€»é¢'}</span>
                            <span class="detail-row-value">${parseFloat(orderAmountETH).toFixed(8)} ETH ($${(parseFloat(orderAmountETH) * ETH_TO_USD_RATE).toFixed(2)})</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-row-label">${t.platformFee || 'å¹³å°è´¹ (5%)'}</span>
                            <span class="detail-row-value" style="color: #10b981;">${parseFloat(platformFeeETH).toFixed(8)} ETH ($${(parseFloat(platformFeeETH) * ETH_TO_USD_RATE).toFixed(2)})</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-row-label">${t.driverEarnings || 'å¸æœºæ”¶å…¥ (95%)'}</span>
                            <span class="detail-row-value">${parseFloat(driverAmountETH).toFixed(8)} ETH ($${(parseFloat(driverAmountETH) * ETH_TO_USD_RATE).toFixed(2)})</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>ğŸ‘¥ ${t.participants || 'å‚ä¸æ–¹'}</h3>
                        <div class="detail-row">
                            <span class="detail-row-label">${t.driverSide || 'æ¥å•ç«¯ï¼ˆå¸æœºï¼‰'}</span>
                            <span class="detail-row-value">
                                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                                    ${driverInfo.nickname ? `<div style="font-weight: 600; color: #1f2937;">${driverInfo.nickname}</div>` : ''}
                                    ${driverInfo.id ? `<div style="font-size: 12px; color: #6b7280;">ID: ${driverInfo.id}</div>` : ''}
                                    <div style="font-size: 12px; color: #9ca3af; font-family: monospace;">
                                        ${item.driver}
                                        <button class="copy-btn" onclick="copyToClipboard('${item.driver}')" style="margin-left: 4px;">${t.copy || 'å¤åˆ¶'}</button>
                                    </div>
                                </div>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-row-label">${t.platformWallet || 'å¹³å°é’±åŒ…'}</span>
                            <span class="detail-row-value">
                                ${window.contractAddresses?.platformWallet || 'N/A'}
                                <button class="copy-btn" onclick="copyToClipboard('${window.contractAddresses?.platformWallet || ''}')">${t.copy || 'å¤åˆ¶'}</button>
                            </span>
                        </div>
                    </div>
                    
                    <!-- è®¢å•å†å²çŠ¶æ€ -->
                    ${orderHistory.history && orderHistory.history.length > 0 ? `
                    <div class="detail-section">
                        <h3>ğŸ“‹ ${t.orderHistory || 'è®¢å•å†å²çŠ¶æ€'}</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${orderHistory.history.map((historyItem, idx) => {
                                const historyDate = new Date(historyItem.timestamp * 1000);
                                const eventIcons = {
                                    'OrderCreated': 'ğŸ“',
                                    'OrderAccepted': 'âœ…',
                                    'PassengerPickedUp': 'ğŸš—',
                                    'RideStarted': 'ğŸš€',
                                    'OrderCompleted': 'ğŸ‰',
                                    'DisputeOpened': 'âš–ï¸',
                                    'DisputeResolved': 'âœ…'
                                };
                                
                                // äº‹ä»¶åç§°åˆ°ç¿»è¯‘æ–‡æœ¬çš„æ˜ å°„ï¼ˆåŒ…å«åç«¯å¯èƒ½è¿”å›çš„ä¸­æ–‡æè¿°ï¼‰
                                const eventTranslations = {
                                    'OrderCreated': { zh: 'è®¢å•åˆ›å»º', en: 'Order Created' },
                                    'OrderAccepted': { zh: 'å¸æœºæ¥å•', en: 'Order Accepted' },
                                    'PassengerPickedUp': { zh: 'å¼€å§‹æ¥åˆ°å®¢äºº', en: 'Passenger Picked Up' },
                                    'RideStarted': { zh: 'å¼€å§‹æ¥åˆ°å®¢äºº', en: 'Ride Started' },
                                    'OrderCompleted': { zh: 'è®¢å•å®Œæˆ', en: 'Order Completed' },
                                    'DisputeOpened': { zh: 'äº‰è®®å¼€å¯', en: 'Dispute Opened' },
                                    'DisputeResolved': { zh: 'äº‰è®®å·²è§£å†³', en: 'Dispute Resolved' },
                                    'PaymentLocked': { zh: 'èµ„é‡‘å·²é”å®š', en: 'Payment Locked' },
                                    'PaymentReleased': { zh: 'èµ„é‡‘å·²é‡Šæ”¾', en: 'Payment Released' }
                                };
                                
                                // åç«¯ä¸­æ–‡æè¿°åˆ°äº‹ä»¶åç§°çš„æ˜ å°„ï¼ˆç”¨äºåå‘æŸ¥æ‰¾ï¼‰
                                const descriptionToEvent = {
                                    'è®¢å•åˆ›å»º': 'OrderCreated',
                                    'å¸æœºæ¥å•': 'OrderAccepted',
                                    'å¼€å§‹æ¥åˆ°å®¢äºº': historyItem.event === 'PassengerPickedUp' ? 'PassengerPickedUp' : 'RideStarted',
                                    'è®¢å•å®Œæˆ': 'OrderCompleted',
                                    'äº‰è®®å¼€å¯': 'DisputeOpened',
                                    'äº‰è®®å·²è§£å†³': 'DisputeResolved',
                                    'èµ„é‡‘å·²é”å®š': 'PaymentLocked',
                                    'èµ„é‡‘å·²é‡Šæ”¾': 'PaymentReleased'
                                };
                                
                                const eventIcon = eventIcons[historyItem.event] || 'ğŸ“Œ';
                                
                                // è·å–ç¿»è¯‘åçš„æè¿°æ–‡æœ¬
                                let displayDescription = historyItem.event;
                                
                                // ä¼˜å…ˆä½¿ç”¨äº‹ä»¶åç§°çš„ç¿»è¯‘æ˜ å°„
                                if (eventTranslations[historyItem.event]) {
                                    displayDescription = isZh ? eventTranslations[historyItem.event].zh : eventTranslations[historyItem.event].en;
                                } else if (historyItem.description) {
                                    // å¦‚æœäº‹ä»¶åç§°æ²¡æœ‰æ˜ å°„ï¼Œæ£€æŸ¥descriptionæ˜¯å¦æ˜¯ä¸­æ–‡
                                    const isChineseDesc = /[\u4e00-\u9fa5]/.test(historyItem.description);
                                    if (isChineseDesc) {
                                        // å¦‚æœæ˜¯ä¸­æ–‡ï¼Œå°è¯•é€šè¿‡descriptionæ‰¾åˆ°å¯¹åº”çš„äº‹ä»¶
                                        const mappedEvent = descriptionToEvent[historyItem.description];
                                        if (mappedEvent && eventTranslations[mappedEvent]) {
                                            displayDescription = isZh ? eventTranslations[mappedEvent].zh : eventTranslations[mappedEvent].en;
                                        } else {
                                            // å¦‚æœæ‰¾ä¸åˆ°æ˜ å°„ï¼Œä¸”å½“å‰æ˜¯è‹±æ–‡ï¼Œä½¿ç”¨äº‹ä»¶åç§°
                                            displayDescription = isZh ? historyItem.description : historyItem.event;
                                        }
                                    } else {
                                        // å¦‚æœdescriptionä¸æ˜¯ä¸­æ–‡ï¼Œç›´æ¥ä½¿ç”¨
                                        displayDescription = historyItem.description;
                                    }
                                }
                                
                                return `
                                    <div style="padding: 12px; background: #f9fafb; border-radius: 8px; border-left: 3px solid #3b82f6;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                            <span style="font-size: 18px;">${eventIcon}</span>
                                            <span style="font-weight: 600; color: #1f2937;">${displayDescription}</span>
                                        </div>
                                        <div style="font-size: 12px; color: #6b7280; margin-left: 26px;">
                                            ${historyDate.toLocaleString(dateLocale, {
                                                year: 'numeric',
                                                month: '2-digit',
                                                day: '2-digit',
                                                hour: '2-digit',
                                                minute: '2-digit',
                                                second: '2-digit'
                                            })}
                                            ${historyItem.blockNumber ? ` â€¢ ${t.blockLabel || 'åŒºå—'} #${historyItem.blockNumber}` : ''}
                                        </div>
                                        ${historyItem.driver ? `
                                        <div style="font-size: 11px; color: #9ca3af; margin-left: 26px; margin-top: 4px;">
                                            ${t.driverLabel || 'å¸æœº'}: ${historyItem.driver.substring(0, 6)}...${historyItem.driver.substring(historyItem.driver.length - 4)}
                                        </div>
                                        ` : ''}
                                        ${historyItem.reason ? `
                                        <div style="font-size: 11px; color: #9ca3af; margin-left: 26px; margin-top: 4px;">
                                            ${t.reasonLabel || 'åŸå› '}: ${historyItem.reason}
                                        </div>
                                        ` : ''}
                                        ${historyItem.winner ? `
                                        <div style="font-size: 11px; color: #9ca3af; margin-left: 26px; margin-top: 4px;">
                                            ${t.winnerLabel || 'è·èƒœæ–¹'}: ${historyItem.winner.substring(0, 6)}...${historyItem.winner.substring(historyItem.winner.length - 4)}
                                        </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- äº‰è®®ä¿¡æ¯æ˜¾ç¤º -->
                    ${item.disputeInfo ? `
                    <div class="detail-section">
                        <h3>âš–ï¸ ${t.disputeInfo || 'äº‰è®®ä¿¡æ¯'}</h3>
                        <div class="detail-row">
                            <span class="detail-row-label">${t.disputeStatus || 'äº‰è®®çŠ¶æ€'}</span>
                            <span class="detail-row-value">
                                ${item.disputeInfo.disputeOpened 
                                    ? (item.disputeInfo.disputeResolved 
                                        ? `<span style="color: #10b981; font-weight: 600;">âœ… ${t.resolvedStatus || 'å·²è§£å†³'}</span>` 
                                        : `<span style="color: #ef4444; font-weight: 600;">âš ï¸ ${t.pendingStatus || 'å¾…å¤„ç†'}</span>`)
                                    : `<span style="color: #6b7280;">${t.noDisputeStatus || 'æ— äº‰è®®'}</span>`}
                            </span>
                        </div>
                        ${item.disputeInfo.openedBy ? `
                        <div class="detail-row">
                            <span class="detail-row-label">${t.openedBy || 'å‘èµ·äºº'}</span>
                            <span class="detail-row-value" style="font-family: monospace; font-size: 12px;">
                                ${item.disputeInfo.openedBy.substring(0, 6)}...${item.disputeInfo.openedBy.substring(item.disputeInfo.openedBy.length - 4)}
                                <button class="copy-btn" onclick="copyToClipboard('${item.disputeInfo.openedBy}')">${t.copy || 'å¤åˆ¶'}</button>
                            </span>
                        </div>
                        ` : ''}
                        ${item.disputeInfo.reason ? `
                        <div class="detail-row">
                            <span class="detail-row-label">${t.disputeReason || 'äº‰è®®åŸå› '}</span>
                            <span class="detail-row-value" style="white-space: pre-wrap; word-break: break-word;">${item.disputeInfo.reason}</span>
                        </div>
                        ` : ''}
                        ${item.disputeInfo.disputeOpenedAt ? `
                        <div class="detail-row">
                            <span class="detail-row-label">${t.disputeOpenedAt || 'äº‰è®®å‘èµ·æ—¶é—´'}</span>
                            <span class="detail-row-value">${new Date(item.disputeInfo.disputeOpenedAt * 1000).toLocaleString(dateLocale)}</span>
                        </div>
                        ` : ''}
                        ${item.disputeInfo.disputeResolved && item.disputeInfo.disputeWinner ? `
                        <div class="detail-row">
                            <span class="detail-row-label">${t.winner || 'è·èƒœæ–¹'}</span>
                            <span class="detail-row-value" style="font-family: monospace; font-size: 12px;">
                                ${item.disputeInfo.disputeWinner.substring(0, 6)}...${item.disputeInfo.disputeWinner.substring(item.disputeInfo.disputeWinner.length - 4)}
                                <button class="copy-btn" onclick="copyToClipboard('${item.disputeInfo.disputeWinner}')">${t.copy || 'å¤åˆ¶'}</button>
                            </span>
                        </div>
                        ` : ''}
                        ${item.disputeInfo.disputeResolvedAt ? `
                        <div class="detail-row">
                            <span class="detail-row-label">${t.resolvedAt || 'è§£å†³æ—¶é—´'}</span>
                            <span class="detail-row-value">${new Date(item.disputeInfo.disputeResolvedAt * 1000).toLocaleString(dateLocale)}</span>
                        </div>
                        ` : ''}
                        ${item.disputeInfo.disputeResolutionDetail ? `
                        <div class="detail-row">
                            <span class="detail-row-label">${t.resolutionDetail || 'è£å†³è¯´æ˜'}</span>
                            <span class="detail-row-value" style="white-space: pre-wrap; word-break: break-word;">${item.disputeInfo.disputeResolutionDetail}</span>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- Dispute Management Panel -->
                    <div class="admin-dispute-panel" id="dispute-panel-${item.orderId}">
                        <h3>âš–ï¸ ${window.platformTexts?.disputes || 'äº‰è®®è®¢å•'}</h3>
                        <div id="dispute-status-display-${item.orderId}" style="margin-bottom: 16px;"></div>
                        <div style="margin-top: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">${t.winnerWalletAddress || 'è·èƒœæ–¹é’±åŒ…åœ°å€'}:</label>
                            <input type="text" id="winner-address-${item.orderId}" placeholder="${t.enterWinnerAddress || 'è¾“å…¥è·èƒœæ–¹é’±åŒ…åœ°å€...'}" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; margin-bottom: 12px;">
                            
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">${t.resolutionDetail || 'è£å†³è¯´æ˜'}:</label>
                            <input type="text" id="resolution-detail-${item.orderId}" placeholder="${t.enterSolutionNote || 'è¾“å…¥è§£å†³æ–¹æ¡ˆè¯´æ˜...'}" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; margin-bottom: 16px;">
                            
                            <div style="display: flex; gap: 12px;">
                                <button id="btn-resolve-driver-${item.orderId}" onclick="resolveDisputeForDriver(${item.orderId})" style="flex: 1; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                    ${window.platformTexts?.resolveForDriver || 'å¸æœºè·èƒœ'}
                                </button>
                                <button id="btn-resolve-passenger-${item.orderId}" onclick="resolveDisputeForPassenger(${item.orderId})" style="flex: 1; padding: 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                    ${window.platformTexts?.resolveForPassenger || 'ä¹˜å®¢è·èƒœ'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // åŠ è½½å¹¶æ˜¾ç¤ºäº‰è®®çŠ¶æ€
            loadDisputeStatus(item.orderId);
            
            document.getElementById('detail-modal').classList.add('active');
        }
        
        // åŠ è½½äº‰è®®çŠ¶æ€
        async function loadDisputeStatus(orderId) {
            if (!window.contracts?.rideOrder) return;
            
            try {
                const disputeStatus = await window.contracts.rideOrder.getDisputeStatus(orderId);
                const statusDisplay = document.getElementById(`dispute-status-display-${orderId}`);
                if (!statusDisplay) return;
                
                const disputeOpened = disputeStatus.disputeOpened;
                const disputeResolved = disputeStatus.disputeResolved;
                const disputeReason = disputeStatus.disputeReason || '';
                const disputeOpener = disputeStatus.disputeOpener || ethers.constants.AddressZero;
                const disputeWinner = disputeStatus.disputeWinner || ethers.constants.AddressZero;
                const disputeOpenedAt = disputeStatus.disputeOpenedAt && disputeStatus.disputeOpenedAt.toNumber ? 
                    new Date(disputeStatus.disputeOpenedAt.toNumber() * 1000).toLocaleString('zh-CN') : '';
                const disputeResolvedAt = disputeStatus.disputeResolvedAt && disputeStatus.disputeResolvedAt.toNumber ? 
                    new Date(disputeStatus.disputeResolvedAt.toNumber() * 1000).toLocaleString('zh-CN') : '';
                const disputeResolutionDetail = disputeStatus.disputeResolutionDetail || '';
                
                let statusHtml = '';
                if (disputeOpened) {
                    statusHtml = `
                        <div style="padding: 12px; background: ${disputeResolved ? '#d1fae5' : '#fef3c7'}; border-radius: 8px; border: 1px solid ${disputeResolved ? '#10b981' : '#fbbf24'};">
                            <div style="font-weight: 600; color: ${disputeResolved ? '#065f46' : '#92400e'}; margin-bottom: 8px;">
                                ${disputeResolved ? `âœ… ${window.platformTexts?.disputeResolvedDriver || 'äº‰è®®å·²è§£å†³'}` : `âš ï¸ ${window.platformTexts?.disputes || 'äº‰è®®è®¢å•'}`}
                            </div>
                            ${disputeReason ? `
                            <div style="font-size: 14px; color: ${disputeResolved ? '#047857' : '#78350f'}; margin-bottom: 8px;">
                                <strong>${window.platformTexts?.disputeReason || 'äº‰è®®åŸå› '}:</strong> ${disputeReason}
                            </div>
                            ` : ''}
                            ${disputeOpener !== ethers.constants.AddressZero ? `
                            <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                                <strong>${window.platformTexts?.openedBy || 'å‘èµ·äºº'}:</strong> <span style="font-family: monospace;">${disputeOpener.substring(0, 6)}...${disputeOpener.substring(disputeOpener.length - 4)}</span>
                            </div>
                            ` : ''}
                            ${disputeResolved && disputeWinner !== ethers.constants.AddressZero ? `
                            <div style="font-size: 14px; color: #047857; margin-bottom: 8px;">
                                <strong>${window.platformTexts?.winner || 'è·èƒœæ–¹'}:</strong> <span style="font-family: monospace;">${disputeWinner.substring(0, 6)}...${disputeWinner.substring(disputeWinner.length - 4)}</span>
                            </div>
                            ` : ''}
                            ${disputeResolutionDetail ? `
                            <div style="font-size: 13px; color: #1f2937; margin-top: 8px; padding: 8px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6;">
                                <strong>${window.platformTexts?.resolutionDetail || 'è£å†³è¯´æ˜'}:</strong> ${disputeResolutionDetail}
                            </div>
                            ` : ''}
                            ${disputeOpenedAt ? `
                            <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                                ${window.platformTexts?.openedAt || 'æäº¤æ—¶é—´'}: ${disputeOpenedAt}
                            </div>
                            ` : ''}
                            ${disputeResolvedAt ? `
                            <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                ${window.platformTexts?.resolvedAt || 'è§£å†³æ—¶é—´'}: ${disputeResolvedAt}
                            </div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    statusHtml = `
                        <div style="padding: 12px; background: #f3f4f6; border-radius: 8px; border: 1px solid #d1d5db; color: #6b7280;">
                            ${window.platformTexts?.noDispute || 'æ— äº‰è®®'}
                        </div>
                    `;
                }
                
                statusDisplay.innerHTML = statusHtml;
                
                // å¦‚æœäº‰è®®å·²è§£å†³ï¼Œç¦ç”¨æŒ‰é’®å¹¶æ¢å¤æŒ‰é’®æ–‡æœ¬
                if (disputeResolved) {
                    const driverBtn = document.getElementById(`btn-resolve-driver-${orderId}`);
                    const passengerBtn = document.getElementById(`btn-resolve-passenger-${orderId}`);
                    const t = window.platformTexts || {};
                    if (driverBtn) {
                        driverBtn.disabled = true;
                        driverBtn.textContent = t.resolveForDriver || 'å¸æœºè·èƒœ';
                    }
                    if (passengerBtn) {
                        passengerBtn.disabled = true;
                        passengerBtn.textContent = t.resolveForPassenger || 'ä¹˜å®¢è·èƒœ';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½äº‰è®®çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // è§£å†³äº‰è®®ï¼ˆå¸æœºè·èƒœï¼‰
        async function resolveDisputeForDriver(orderId) {
            if (!window.contracts?.rideOrder) {
                alert('åˆçº¦æœªåˆå§‹åŒ–ï¼');
                return;
            }
            
            // ç¡®ä¿æœ‰ signer
            if (!signer) {
                try {
                    if (!provider) {
                        provider = new ethers.providers.Web3Provider(window.ethereum);
                    }
                    signer = provider.getSigner();
                } catch (error) {
                    alert('æ— æ³•è·å–ç­¾åè€…ï¼Œè¯·ç¡®ä¿å·²è¿æ¥é’±åŒ…');
                    return;
                }
            }
            
            let driverAddress = null;
            let item = null;
            
            // å…ˆä» filteredRevenueData æŸ¥æ‰¾
            if (window.filteredRevenueData) {
                item = window.filteredRevenueData.find(d => d.orderId === orderId.toString() || d.orderId === orderId);
                if (item && item.driver) {
                    driverAddress = item.driver;
                }
            }
            
            // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä» disputeData æŸ¥æ‰¾
            if (!driverAddress && typeof disputeData !== 'undefined') {
                const dispute = disputeData.find(d => d.orderId === orderId.toString() || d.orderId === orderId);
                if (dispute && dispute.orderDetails && dispute.orderDetails.driver) {
                    driverAddress = dispute.orderDetails.driver;
                    item = dispute;
                }
            }
            
            // å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œç›´æ¥ä»åˆçº¦è·å–è®¢å•ä¿¡æ¯
            if (!driverAddress) {
                try {
                    const order = await window.contracts.rideOrder.getOrder(orderId);
                    if (order && order.driver && order.driver !== ethers.constants.AddressZero) {
                        driverAddress = order.driver;
                    } else {
                        alert('æ— æ³•æ‰¾åˆ°è®¢å•ä¿¡æ¯æˆ–è®¢å•æ²¡æœ‰å¸æœº');
                        return;
                    }
                } catch (error) {
                    console.error('è·å–è®¢å•ä¿¡æ¯å¤±è´¥:', error);
                    alert('æ— æ³•æ‰¾åˆ°è®¢å•ä¿¡æ¯: ' + error.message);
                    return;
                }
            }
            
            if (!driverAddress) {
                alert('æ— æ³•æ‰¾åˆ°å¸æœºåœ°å€');
                return;
            }
            const detailInput = document.getElementById(`resolution-detail-${orderId}`);
            const detail = detailInput ? detailInput.value.trim() : 'Resolved for driver';
            
            const t = window.platformTexts || {};
            if (!confirm(`${t.confirmResolveDriver || 'ç¡®è®¤å°†äº‰è®®è§£å†³ä¸ºå¸æœºè·èƒœï¼Ÿ'}\n${t.driverAddress || 'å¸æœºåœ°å€'}: ${driverAddress}\n${t.description || 'è¯´æ˜'}: ${detail}`)) {
                return;
            }
            
            const btn = document.getElementById(`btn-resolve-driver-${orderId}`);
            const btnPassenger = document.getElementById(`btn-resolve-passenger-${orderId}`);
            
            try {
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = t.processing || 'å¤„ç†ä¸­...';
                }
                if (btnPassenger) {
                    btnPassenger.disabled = true;
                }
                
                // ä½¿ç”¨å¸¦ signer çš„åˆçº¦å®ä¾‹æ¥å‘é€äº¤æ˜“
                const contractWithSigner = window.contracts.rideOrderWithSigner || window.contracts.rideOrder.connect(signer);
                if (!contractWithSigner) {
                    alert('æ— æ³•è·å–ç­¾åè€…ï¼Œè¯·ç¡®ä¿å·²è¿æ¥é’±åŒ…');
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = t.resolveForDriver || 'å¸æœºè·èƒœ';
                    }
                    if (btnPassenger) {
                        btnPassenger.disabled = false;
                    }
                    return;
                }
                
                console.log(`[PLATFORM] å‡†å¤‡è§£å†³äº‰è®®ï¼ˆå¸æœºè·èƒœï¼‰ï¼Œè®¢å•ID: ${orderId}, å¸æœºåœ°å€: ${driverAddress}`);
                const tx = await contractWithSigner.resolveDispute(orderId, driverAddress, detail);
                console.log(`[PLATFORM] äº‰è®®è§£å†³äº¤æ˜“å·²å‘é€ï¼Œå“ˆå¸Œ: ${tx.hash}`);
                const receipt = await tx.wait();
                console.log(`[PLATFORM] äº‰è®®è§£å†³äº¤æ˜“å·²ç¡®è®¤ï¼ŒåŒºå—: ${receipt.blockNumber}`);
                
                // äº‰è®®è§£å†³åï¼Œç«‹å³è°ƒç”¨settleå‡½æ•°æ¥åˆ†é…èµ„é‡‘ï¼ˆæ”¯ä»˜ç»™å¸æœºï¼‰
                try {
                    console.log(`[PLATFORM] äº‰è®®å·²è§£å†³ï¼ˆå¸æœºè·èƒœï¼‰ï¼Œå¼€å§‹ç»“ç®—è®¢å• #${orderId}...`);
                    const settleTx = await contractWithSigner.settle(orderId);
                    console.log(`[PLATFORM] ç»“ç®—äº¤æ˜“å·²å‘é€ï¼Œå“ˆå¸Œ: ${settleTx.hash}`);
                    const settleReceipt = await settleTx.wait();
                    console.log(`[PLATFORM] è®¢å• #${orderId} ç»“ç®—å®Œæˆï¼Œèµ„é‡‘å·²æ”¯ä»˜ç»™å¸æœºï¼ŒåŒºå—: ${settleReceipt.blockNumber}`);
                } catch (settleError) {
                    console.error('ç»“ç®—è®¢å•å¤±è´¥:', settleError);
                    window.logger?.error('[PLATFORM] ç»“ç®—è®¢å•å¤±è´¥', {
                        orderId,
                        error: settleError.message,
                        reason: settleError.reason,
                        code: settleError.code,
                        stack: settleError.stack
                    });
                    // å³ä½¿settleå¤±è´¥ï¼Œä¹Ÿç»§ç»­æ‰§è¡Œï¼Œå› ä¸ºäº‰è®®å·²è§£å†³
                    alert('äº‰è®®å·²è§£å†³ï¼Œä½†ç»“ç®—å¤±è´¥: ' + (settleError.reason || settleError.message) + '\nè¯·æ‰‹åŠ¨è°ƒç”¨settleå‡½æ•°ã€‚');
                }
                
                alert(t.disputeResolvedDriver || 'äº‰è®®å·²è§£å†³ï¼ˆå¸æœºè·èƒœï¼‰ï¼Œèµ„é‡‘å·²æ”¯ä»˜ç»™å¸æœº');
                
                // åˆ·æ–°äº‰è®®çŠ¶æ€
                await loadDisputeStatus(orderId);
                
                // åˆ·æ–°æ”¶å…¥æ•°æ®
                await loadRevenueData();
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€ï¼ˆäº‰è®®å·²è§£å†³ï¼ŒæŒ‰é’®åº”è¯¥è¢«ç¦ç”¨æˆ–éšè—ï¼‰
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = t.resolveForDriver || 'å¸æœºè·èƒœ';
                }
                if (btnPassenger) {
                    btnPassenger.disabled = true;
                }
            } catch (error) {
                console.error('è§£å†³äº‰è®®å¤±è´¥:', error);
                alert('è§£å†³äº‰è®®å¤±è´¥: ' + (error.reason || error.message));
                
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = t.resolveForDriver || 'å¸æœºè·èƒœ';
                }
                if (btnPassenger) {
                    btnPassenger.disabled = false;
                }
            }
        }
        
        // è§£å†³äº‰è®®ï¼ˆä¹˜å®¢è·èƒœï¼‰
        async function resolveDisputeForPassenger(orderId) {
            if (!window.contracts?.rideOrder) {
                alert('åˆçº¦æœªåˆå§‹åŒ–ï¼');
                return;
            }
            
            // ç¡®ä¿æœ‰ signer
            if (!signer) {
                try {
                    if (!provider) {
                        provider = new ethers.providers.Web3Provider(window.ethereum);
                    }
                    signer = provider.getSigner();
                } catch (error) {
                    alert('æ— æ³•è·å–ç­¾åè€…ï¼Œè¯·ç¡®ä¿å·²è¿æ¥é’±åŒ…');
                    return;
                }
            }
            
            let passengerAddress = null;
            let item = null;
            
            // å…ˆä» filteredRevenueData æŸ¥æ‰¾ï¼ˆä½†æ”¶å…¥æ•°æ®ä¸­ä¸å†æœ‰orderDetailsï¼Œæ‰€ä»¥ç›´æ¥è·³è¿‡ï¼‰
            // å¦‚æœéœ€è¦ä»æ”¶å…¥æ•°æ®è·å–ï¼Œéœ€è¦ç›´æ¥ä»åˆçº¦è·å–è®¢å•ä¿¡æ¯
            
            // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä» disputeData æŸ¥æ‰¾
            if (!passengerAddress && typeof disputeData !== 'undefined') {
                const dispute = disputeData.find(d => d.orderId === orderId.toString() || d.orderId === orderId);
                if (dispute && dispute.orderDetails && dispute.orderDetails.passenger) {
                    passengerAddress = dispute.orderDetails.passenger;
                    item = dispute;
                }
            }
            
            // å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œç›´æ¥ä»åˆçº¦è·å–è®¢å•ä¿¡æ¯
            if (!passengerAddress) {
                try {
                    const order = await window.contracts.rideOrder.getOrder(orderId);
                    if (order && order.passenger) {
                        passengerAddress = order.passenger;
                    } else {
                        alert('æ— æ³•æ‰¾åˆ°è®¢å•ä¿¡æ¯æˆ–è®¢å•æ²¡æœ‰ä¹˜å®¢');
                        return;
                    }
                } catch (error) {
                    console.error('è·å–è®¢å•ä¿¡æ¯å¤±è´¥:', error);
                    alert('æ— æ³•æ‰¾åˆ°è®¢å•ä¿¡æ¯: ' + error.message);
                    return;
                }
            }
            
            if (!passengerAddress) {
                alert('æ— æ³•æ‰¾åˆ°ä¹˜å®¢åœ°å€');
                return;
            }
            const detailInput = document.getElementById(`resolution-detail-${orderId}`);
            const detail = detailInput ? detailInput.value.trim() : 'Resolved for passenger';
            
            const t = window.platformTexts || {};
            if (!confirm(`${t.confirmResolvePassenger || 'ç¡®è®¤å°†äº‰è®®è§£å†³ä¸ºä¹˜å®¢è·èƒœï¼Ÿ'}\n${t.passengerAddress || 'ä¹˜å®¢åœ°å€'}: ${passengerAddress}\n${t.description || 'è¯´æ˜'}: ${detail}`)) {
                return;
            }
            
            const btn = document.getElementById(`btn-resolve-passenger-${orderId}`);
            const btnDriver = document.getElementById(`btn-resolve-driver-${orderId}`);
            
            try {
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = t.processing || 'å¤„ç†ä¸­...';
                }
                if (btnDriver) {
                    btnDriver.disabled = true;
                }
                
                // ä½¿ç”¨å¸¦ signer çš„åˆçº¦å®ä¾‹æ¥å‘é€äº¤æ˜“
                const contractWithSigner = window.contracts.rideOrderWithSigner || window.contracts.rideOrder.connect(signer);
                if (!contractWithSigner) {
                    alert('æ— æ³•è·å–ç­¾åè€…ï¼Œè¯·ç¡®ä¿å·²è¿æ¥é’±åŒ…');
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = t.resolveForPassenger || 'ä¹˜å®¢è·èƒœ';
                    }
                    if (btnDriver) {
                        btnDriver.disabled = false;
                    }
                    return;
                }
                
                console.log(`[PLATFORM] å‡†å¤‡è§£å†³äº‰è®®ï¼ˆä¹˜å®¢è·èƒœï¼‰ï¼Œè®¢å•ID: ${orderId}, ä¹˜å®¢åœ°å€: ${passengerAddress}`);
                const tx = await contractWithSigner.resolveDispute(orderId, passengerAddress, detail);
                console.log(`[PLATFORM] äº‰è®®è§£å†³äº¤æ˜“å·²å‘é€ï¼Œå“ˆå¸Œ: ${tx.hash}`);
                const receipt = await tx.wait();
                console.log(`[PLATFORM] äº‰è®®è§£å†³äº¤æ˜“å·²ç¡®è®¤ï¼ŒåŒºå—: ${receipt.blockNumber}`);
                
                // äº‰è®®è§£å†³åï¼Œç«‹å³è°ƒç”¨settleå‡½æ•°æ¥åˆ†é…èµ„é‡‘ï¼ˆé€€æ¬¾ç»™ä¹˜å®¢ï¼‰
                try {
                    console.log(`[PLATFORM] äº‰è®®å·²è§£å†³ï¼ˆä¹˜å®¢è·èƒœï¼‰ï¼Œå¼€å§‹ç»“ç®—è®¢å• #${orderId}...`);
                    const settleTx = await contractWithSigner.settle(orderId);
                    console.log(`[PLATFORM] ç»“ç®—äº¤æ˜“å·²å‘é€ï¼Œå“ˆå¸Œ: ${settleTx.hash}`);
                    const settleReceipt = await settleTx.wait();
                    console.log(`[PLATFORM] è®¢å• #${orderId} ç»“ç®—å®Œæˆï¼Œèµ„é‡‘å·²é€€è¿˜ç»™ä¹˜å®¢ï¼ŒåŒºå—: ${settleReceipt.blockNumber}`);
                } catch (settleError) {
                    console.error('ç»“ç®—è®¢å•å¤±è´¥:', settleError);
                    window.logger?.error('[PLATFORM] ç»“ç®—è®¢å•å¤±è´¥', {
                        orderId,
                        error: settleError.message,
                        reason: settleError.reason,
                        code: settleError.code,
                        stack: settleError.stack
                    });
                    // å³ä½¿settleå¤±è´¥ï¼Œä¹Ÿç»§ç»­æ‰§è¡Œï¼Œå› ä¸ºäº‰è®®å·²è§£å†³
                    alert('äº‰è®®å·²è§£å†³ï¼Œä½†ç»“ç®—å¤±è´¥: ' + (settleError.reason || settleError.message) + '\nè¯·æ‰‹åŠ¨è°ƒç”¨settleå‡½æ•°ã€‚');
                }
                
                alert(t.disputeResolvedPassenger || 'äº‰è®®å·²è§£å†³ï¼ˆä¹˜å®¢è·èƒœï¼‰ï¼Œèµ„é‡‘å·²é€€è¿˜ç»™ä¹˜å®¢');
                
                // åˆ·æ–°äº‰è®®çŠ¶æ€
                await loadDisputeStatus(orderId);
                
                // åˆ·æ–°æ”¶å…¥æ•°æ®
                await loadRevenueData();
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€ï¼ˆäº‰è®®å·²è§£å†³ï¼ŒæŒ‰é’®åº”è¯¥è¢«ç¦ç”¨æˆ–éšè—ï¼‰
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = t.resolveForPassenger || 'ä¹˜å®¢è·èƒœ';
                }
                if (btnDriver) {
                    btnDriver.disabled = true;
                }
            } catch (error) {
                console.error('è§£å†³äº‰è®®å¤±è´¥:', error);
                alert('è§£å†³äº‰è®®å¤±è´¥: ' + (error.reason || error.message));
                
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = t.resolveForPassenger || 'ä¹˜å®¢è·èƒœ';
                }
                if (btnDriver) {
                    btnDriver.disabled = false;
                }
            }
        }
        
        window.resolveDisputeForDriver = resolveDisputeForDriver;
        window.resolveDisputeForPassenger = resolveDisputeForPassenger;

        // åŠ è½½è®¢å•ç»Ÿè®¡æ•°æ®
        async function loadOrderStatistics() {
            try {
                // ä½¿ç”¨åç«¯APIè·å–ç»Ÿè®¡æ•°æ®ï¼Œé¿å…å‰ç«¯éå†æ‰€æœ‰è®¢å•
                // è‡ªåŠ¨æ£€æµ‹APIåœ°å€ï¼šå¦‚æœæ˜¯é€šè¿‡æœåŠ¡å™¨è®¿é—®ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼›å¦åˆ™ä½¿ç”¨é…ç½®çš„åœ°å€
                let API_BASE_URL = window.API_BASE_URL;
                if (!API_BASE_URL) {
                    // å¦‚æœå½“å‰æ˜¯é€šè¿‡ http/https è®¿é—®ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆè®©ä»£ç†è½¬å‘ï¼‰
                    // å¦‚æœæ˜¯ file:// åè®®ç›´æ¥æ‰“å¼€ï¼Œé»˜è®¤ä½¿ç”¨ localhost:3000
                    API_BASE_URL = (window.location.protocol === 'file:') ? 'http://localhost:3000' : '';
                }
                const response = await fetch(`${API_BASE_URL}/api/platform/order-statistics`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥');
                }
                
                const data = result.data;
                
                // æ›´æ–°UI
                document.getElementById('today-total-orders').textContent = data.todayTotalOrders;
                document.getElementById('today-total-amount').textContent = 
                    parseFloat(data.todayTotalAmount).toFixed(8) + ' ETH';
                
                document.getElementById('active-orders-count').textContent = data.activeOrdersCount;
                const activeAmountETH = parseFloat(data.activeOrdersAmount);
                const activePercentage = data.todayTotalOrders > 0 
                    ? ((data.activeOrdersCount / data.todayTotalOrders) * 100).toFixed(1)
                    : '0.0';
                document.getElementById('active-orders-amount').textContent = 
                    `${activeAmountETH.toFixed(8)} ETH (${activePercentage}%)`;
                
                document.getElementById('dispute-orders-count').textContent = data.disputeOrdersCount;
                const disputeAmountETH = parseFloat(data.disputeOrdersAmount);
                const disputePercentage = data.todayTotalOrders > 0 
                    ? ((data.disputeOrdersCount / data.todayTotalOrders) * 100).toFixed(1)
                    : '0.0';
                document.getElementById('dispute-orders-amount').textContent = 
                    `${disputeAmountETH.toFixed(8)} ETH (${disputePercentage}%)`;
                
                // å¦‚æœåªæ£€æŸ¥äº†éƒ¨åˆ†è®¢å•ï¼Œæ˜¾ç¤ºæç¤º
                if (data.checkedOrders < data.totalOrders) {
                    console.log(`ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼šæ£€æŸ¥äº†æœ€è¿‘ ${data.checkedOrders} ä¸ªè®¢å•ï¼ˆå…± ${data.totalOrders} ä¸ªï¼‰`);
                }
                    
            } catch (error) {
                console.error('åŠ è½½è®¢å•ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ä½†ä¸é˜»å¡UI
                const errorMsg = error.message || 'åŠ è½½å¤±è´¥';
                document.getElementById('today-total-orders').textContent = '-';
                document.getElementById('today-total-amount').textContent = '-';
                document.getElementById('active-orders-count').textContent = '-';
                document.getElementById('active-orders-amount').textContent = '-';
                document.getElementById('dispute-orders-count').textContent = '-';
                document.getElementById('dispute-orders-amount').textContent = '-';
            }
        }
        
        window.loadOrderStatistics = loadOrderStatistics;

        // åŠ è½½æ´»è·ƒè®¢å•åˆ—è¡¨
        async function loadActiveOrders() {
            if (!window.contracts?.rideOrder) {
                // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥é’±åŒ…
                if (!provider || !account) {
                    alert('è¯·å…ˆè¿æ¥é’±åŒ…ï¼');
                    return;
                }
                // å¦‚æœå·²è¿æ¥é’±åŒ…ä½†åˆçº¦æœªåˆå§‹åŒ–ï¼Œå°è¯•åˆå§‹åŒ–
                if (window.contractAddresses?.rideOrder) {
                    try {
                        await initializeContracts();
                        if (!window.contracts?.rideOrder) {
                            alert('åˆçº¦åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                            return;
                        }
                    } catch (error) {
                        console.error('åˆå§‹åŒ–åˆçº¦å¤±è´¥:', error);
                        alert('åˆçº¦åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                        return;
                    }
                } else {
                    alert('åˆçº¦åœ°å€æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }
            }
            
            const loadingEl = document.getElementById('loading-active');
            const listEl = document.getElementById('active-orders-list');
            const emptyEl = document.getElementById('empty-state-active');
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (listEl) listEl.style.display = 'none';
            if (emptyEl) emptyEl.style.display = 'none';
            
            try {
                // éªŒè¯åˆçº¦åœ°å€
                const contractAddress = window.contractAddresses?.rideOrder;
                if (!contractAddress || !ethers.utils.isAddress(contractAddress)) {
                    throw new Error('æ— æ•ˆçš„åˆçº¦åœ°å€');
                }
                
                // éªŒè¯åˆçº¦æ˜¯å¦å­˜åœ¨
                const code = await provider.getCode(contractAddress);
                if (code === '0x' || code === '0x0') {
                    throw new Error('åˆçº¦æœªéƒ¨ç½²ï¼Œè¯·è¿è¡Œ: npm run deploy:local');
                }
                
                const orderCount = await window.contracts.rideOrder.orderCount();
                const activeOrders = [];
                
                // éå†æ‰€æœ‰è®¢å•ï¼Œæ‰¾å‡ºæ´»è·ƒè®¢å•
                for (let i = 0; i < orderCount.toNumber(); i++) {
                    try {
                        const order = await window.contracts.rideOrder.getOrder(i);
                        const rideStatus = order.rideStatus;
                        
                        // æ´»è·ƒè®¢å•ï¼šACCEPTED (2), IN_PROGRESS (3) æˆ– AWAITING_SETTLEMENT (5)
                        if (rideStatus === 2 || rideStatus === 3 || rideStatus === 5) {
                            const statusNames = {
                                0: 'NONE',
                                1: 'CREATED',
                                2: 'ACCEPTED',
                                3: 'IN_PROGRESS',
                                4: 'COMPLETED',
                                5: 'AWAITING_SETTLEMENT',
                                6: 'SETTLED'
                            };
                            
                            activeOrders.push({
                                orderId: i,
                                order: order,
                                status: statusNames[rideStatus] || 'UNKNOWN',
                                createdAt: order.createdAt.toNumber() * 1000,
                                estimatedFare: order.estimatedFare
                            });
                        }
                    } catch (error) {
                        console.warn(`è®¢å• ${i} åŠ è½½å¤±è´¥:`, error);
                    }
                }
                
                if (loadingEl) loadingEl.style.display = 'none';
                
                if (activeOrders.length === 0) {
                    if (listEl) listEl.style.display = 'none';
                    if (emptyEl) emptyEl.style.display = 'flex';
                    return;
                }
                
                // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
                activeOrders.sort((a, b) => b.createdAt - a.createdAt);
                
                if (listEl) {
                    listEl.style.display = 'flex';
                    listEl.innerHTML = activeOrders.map(item => {
                        const date = new Date(item.createdAt);
                        const amountETH = parseFloat(ethers.utils.formatEther(item.estimatedFare));
                        const isZh = getCurrentLang() === 'zh';
                        const dateLocale = isZh ? 'zh-CN' : 'en-US';
                        let statusBadge;
                        if (item.status === 'ACCEPTED') {
                            statusBadge = `<span class="dispute-status-badge" style="background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6;">${window.platformTexts?.accepted || 'å·²æ¥å•'}</span>`;
                        } else if (item.status === 'IN_PROGRESS') {
                            statusBadge = `<span class="dispute-status-badge open">${window.platformTexts?.inProgress || 'è¿›è¡Œä¸­'}</span>`;
                        } else {
                            statusBadge = `<span class="dispute-status-badge resolved">${window.platformTexts?.awaitingSettlement || 'ç­‰å¾…ç»“ç®—'}</span>`;
                        }
                        
                        return `
                            <div class="revenue-item">
                                <div class="revenue-header">
                                    <div>
                                        <div class="revenue-date">${date.toLocaleString(dateLocale, { 
                                            year: 'numeric', 
                                            month: '2-digit', 
                                            day: '2-digit', 
                                            hour: '2-digit', 
                                            minute: '2-digit',
                                            second: '2-digit'
                                        })}</div>
                                        <div style="margin-top: 8px; font-size: 14px; color: #6b7280;">
                                            ${window.platformTexts?.order || 'è®¢å•'} #${item.orderId}
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        ${statusBadge}
                                        <div class="revenue-amount" style="margin-top: 8px;">
                                            ${amountETH.toFixed(8)} ETH
                                        </div>
                                        <button class="btn-details" onclick="showActiveOrderDetail(${item.orderId})" style="margin-top: 12px;">
                                            ${window.platformTexts?.details || 'è¯¦æƒ…'}
                                        </button>
                                    </div>
                                </div>
                                <div class="revenue-details">
                                    <div class="detail-item">
                                        <div class="detail-label">${window.platformTexts?.status || 'çŠ¶æ€'}</div>
                                        <div class="detail-value">${item.status}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">${window.platformTexts?.passenger || 'ä¹˜å®¢'}</div>
                                        <div class="detail-value address" onclick="copyToClipboard('${item.order.passenger}'); event.stopPropagation();" title="${window.platformTexts?.clickToCopy || 'ç‚¹å‡»å¤åˆ¶'}">
                                            ${item.order.passenger.substring(0, 6)}...${item.order.passenger.substring(38)}
                                        </div>
                                    </div>
                                    ${item.order.driver && item.order.driver !== ethers.constants.AddressZero ? `
                                    <div class="detail-item">
                                        <div class="detail-label">${window.platformTexts?.driver || 'å¸æœº'}</div>
                                        <div class="detail-value address" onclick="copyToClipboard('${item.order.driver}'); event.stopPropagation();" title="${window.platformTexts?.clickToCopy || 'ç‚¹å‡»å¤åˆ¶'}">
                                            ${item.order.driver.substring(0, 6)}...${item.order.driver.substring(38)}
                                        </div>
                                    </div>
                                    ` : ''}
                                    <div class="detail-item">
                                        <div class="detail-label">${window.platformTexts?.pickupLocation || 'ä¸Šè½¦åœ°ç‚¹'}</div>
                                        <div class="detail-value">${item.order.pickup.addressText || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // å­˜å‚¨æ´»è·ƒè®¢å•æ•°æ®ä¾›è¯¦æƒ…ä½¿ç”¨
                window.activeOrdersData = activeOrders;
                
            } catch (error) {
                console.error('åŠ è½½æ´»è·ƒè®¢å•å¤±è´¥:', error);
                if (loadingEl) loadingEl.style.display = 'none';
                if (emptyEl) {
                    emptyEl.style.display = 'flex';
                    emptyEl.innerHTML = `
                        <div class="empty-state-icon">âŒ</div>
                        <div>åŠ è½½å¤±è´¥: ${error.message}</div>
                    `;
                }
            }
        }
        
        window.loadActiveOrders = loadActiveOrders;

        // æ˜¾ç¤ºæ´»è·ƒè®¢å•è¯¦æƒ…ï¼ˆå¤ç”¨æ”¶å…¥è¯¦æƒ…çš„æ¨¡æ€æ¡†ï¼‰
        async function showActiveOrderDetail(orderId) {
            if (!window.contracts?.rideOrder) {
                alert('åˆçº¦æœªåˆå§‹åŒ–ï¼');
                return;
            }
            
            try {
                const order = await window.contracts.rideOrder.getOrder(orderId);
                const ETH_TO_USD_RATE = 2500;
                
                // ä½¿ç”¨ç°æœ‰çš„ showDetailModal å‡½æ•°ï¼Œä½†éœ€è¦æ‰¾åˆ°å¯¹åº”çš„æ”¶å…¥æ•°æ®ç´¢å¼•
                // å¦‚æœæ²¡æœ‰å¯¹åº”çš„æ”¶å…¥æ•°æ®ï¼Œåˆ›å»ºä¸€ä¸ªä¸´æ—¶æ•°æ®
                const tempItem = {
                    orderId: orderId.toString(),
                    driver: order.driver !== ethers.constants.AddressZero ? order.driver : '',
                    orderDetails: order,
                    timestamp: order.createdAt.toNumber(),
                    blockNumber: 0,
                    transactionHash: 'N/A',
                    platformFee: ethers.BigNumber.from(0),
                    driverAmount: ethers.BigNumber.from(0)
                };
                
                // ä¸´æ—¶å­˜å‚¨åˆ° filteredRevenueData ä»¥ä¾¿ showDetailModal ä½¿ç”¨
                if (!window.filteredRevenueData) {
                    window.filteredRevenueData = [];
                }
                const tempIndex = window.filteredRevenueData.length;
                window.filteredRevenueData.push(tempItem);
                
                // è°ƒç”¨ç°æœ‰çš„ showDetailModal
                showDetailModal(tempIndex);
                
            } catch (error) {
                console.error('åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥:', error);
                alert('åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥: ' + error.message);
            }
        }
        
        window.showActiveOrderDetail = showActiveOrderDetail;

        // Tab åˆ‡æ¢å‡½æ•°
        function switchMainTab(tabName) {
            // æ›´æ–° tab æŒ‰é’®çŠ¶æ€ - ä½¿ç”¨ filter-tab æ ·å¼
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.background = 'transparent';
                tab.style.color = '#6b7280';
                tab.style.fontWeight = '500';
                tab.style.border = 'none';
            });
            
            const targetTab = document.getElementById(`main-tab-${tabName}`);
            if (targetTab) {
                targetTab.classList.add('active');
                targetTab.style.background = 'transparent';
                targetTab.style.color = '#3b82f6';
                targetTab.style.fontWeight = '600';
                targetTab.style.border = 'none';
            }

            // æ›´æ–°å†…å®¹åŒºåŸŸ
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            const targetContent = document.getElementById(`tab-content-${tabName}`);
            if (targetContent) {
                targetContent.classList.add('active');
                targetContent.style.display = 'block';
            }

            // æ ¹æ® tab åŠ è½½ç›¸åº”æ•°æ®
            if (tabName === 'disputes') {
                loadDisputes();
            } else if (tabName === 'active') {
                loadActiveOrders();
            } else if (tabName === 'revenue') {
                // æ”¶å…¥æ•°æ®å·²ç»åœ¨è¿æ¥é’±åŒ…æ—¶åŠ è½½äº†
            }
        }

        window.switchMainTab = switchMainTab;

        // åŠ è½½äº‰è®®è®¢å•
        let disputeData = [];
        let isLoadingDisputes = false;

        async function loadDisputes() {
            if (!contracts.rideOrder) {
                alert('åˆçº¦æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            if (isLoadingDisputes) {
                console.log('â¸ï¸ äº‰è®®æ•°æ®æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡æœ¬æ¬¡è¯·æ±‚');
                return;
            }

            isLoadingDisputes = true;
            const loadingEl = document.getElementById('loading-disputes');
            const listEl = document.getElementById('dispute-list');
            const emptyEl = document.getElementById('empty-state-disputes');

            if (loadingEl) loadingEl.style.display = 'block';
            if (listEl) listEl.style.display = 'none';
            if (emptyEl) emptyEl.style.display = 'none';

            try {
                // æŸ¥è¯¢æ‰€æœ‰è®¢å•çš„äº‰è®®çŠ¶æ€
                console.log(`[PLATFORM] [loadDisputes:3150] å¼€å§‹æŸ¥è¯¢DisputeOpenedäº‹ä»¶...`);
                window.logger?.debug('[PLATFORM] å¼€å§‹æŸ¥è¯¢DisputeOpenedäº‹ä»¶', { function: 'loadDisputes' });
                const currentBlock = await provider.getBlockNumber();
                console.log(`[PLATFORM] [loadDisputes:3151] å½“å‰åŒºå—é«˜åº¦: ${currentBlock}`);
                const disputeOpenedFilter = contracts.rideOrder.filters.DisputeOpened();
                window.logger?.debug('[PLATFORM] æŸ¥è¯¢DisputeOpenedäº‹ä»¶', { fromBlock: 0, toBlock: currentBlock });
                const disputeOpenedEvents = await contracts.rideOrder.queryFilter(disputeOpenedFilter, 0, currentBlock);
                console.log(`[PLATFORM] [loadDisputes:3153] æ‰¾åˆ° ${disputeOpenedEvents.length} ä¸ªDisputeOpenedäº‹ä»¶`);
                window.logger?.info('[PLATFORM] æŸ¥è¯¢åˆ°DisputeOpenedäº‹ä»¶', { count: disputeOpenedEvents.length, events: disputeOpenedEvents.map(e => ({ orderId: e.args.orderId.toString(), blockNumber: e.blockNumber, txHash: e.transactionHash })) });

                const newDisputeData = [];

                for (const event of disputeOpenedEvents) {
                    const orderId = event.args.orderId.toString();
                    let orderIdNum = null; // åœ¨å¾ªç¯ä½œç”¨åŸŸå†…å£°æ˜
                    
                    try {
                        // è·å–è®¢å•è¯¦æƒ…ï¼ˆç¡®ä¿ä½¿ç”¨æ•°å­—ç±»å‹ï¼‰
                        console.log(`[loadDisputes:3160] å¤„ç†è®¢å•ID: ${orderId} (ç±»å‹: ${typeof orderId})`);
                        orderIdNum = parseInt(orderId, 10);
                        console.log(`[loadDisputes:3162] è½¬æ¢åçš„è®¢å•ID: ${orderIdNum} (ç±»å‹: ${typeof orderIdNum}, isNaN: ${isNaN(orderIdNum)})`);
                        
                        if (isNaN(orderIdNum)) {
                            console.warn(`[loadDisputes:3164] è·³è¿‡æ— æ•ˆçš„è®¢å•ID: ${orderId}`);
                            continue;
                        }
                        
                        // è·å–åˆçº¦åœ°å€å’ŒRPCä¿¡æ¯
                        const contractAddress = window.contractAddresses?.rideOrder || contracts.rideOrder?.address;
                        let rpcUrl = 'unknown';
                        try {
                            if (provider?.connection?.url) {
                                rpcUrl = provider.connection.url;
                            } else if (provider?.provider?.connection?.url) {
                                rpcUrl = provider.provider.connection.url;
                            } else if (provider?.provider?.rpcUrl) {
                                rpcUrl = provider.provider.rpcUrl;
                            } else if (window.ethereum) {
                                rpcUrl = 'MetaMask Provider';
                            }
                        } catch (e) {
                            rpcUrl = 'unknown';
                        }
                        
                        const functionCall = `getOrder(${orderIdNum})`;
                        const fullCallInfo = `contract.getOrder(${orderIdNum}) at ${contractAddress} via ${rpcUrl}`;
                        
                        console.log(`[PLATFORM] [loadDisputes:3167] è°ƒç”¨ getOrder(${orderIdNum})...`);
                        console.log(`[PLATFORM] åˆçº¦åœ°å€: ${contractAddress}`);
                        console.log(`[PLATFORM] RPC URL: ${rpcUrl}`);
                        console.log(`[PLATFORM] å®Œæ•´è°ƒç”¨ä¿¡æ¯: ${fullCallInfo}`);
                        
                        // éªŒè¯åˆçº¦å®ä¾‹å’Œå‡½æ•°æ˜¯å¦å­˜åœ¨
                        if (!contracts.rideOrder) {
                            throw new Error('åˆçº¦å®ä¾‹æœªåˆå§‹åŒ– (contracts.rideOrder is null)');
                        }
                        
                        if (!contracts.rideOrder.address) {
                            throw new Error('åˆçº¦åœ°å€æœªè®¾ç½® (contracts.rideOrder.address is null)');
                        }
                        
                        // æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
                        if (typeof contracts.rideOrder.getOrder !== 'function') {
                            const availableFunctions = Object.keys(contracts.rideOrder).filter(key => 
                                typeof contracts.rideOrder[key] === 'function'
                            );
                            throw new Error(`getOrder å‡½æ•°ä¸å­˜åœ¨äºåˆçº¦å®ä¾‹ä¸­ã€‚å¯ç”¨å‡½æ•°: ${availableFunctions.join(', ')}`);
                        }
                        
                        window.logger?.debug('[PLATFORM] è°ƒç”¨getOrder', { 
                            orderId: orderIdNum,
                            contractAddress: contractAddress,
                            rpcUrl: rpcUrl,
                            functionCall: functionCall,
                            fullCallInfo: fullCallInfo,
                            contractInstanceExists: !!contracts.rideOrder,
                            contractAddressFromInstance: contracts.rideOrder?.address,
                            hasGetOrder: typeof contracts.rideOrder.getOrder === 'function'
                        });
                        
                        let orderDetails;
                        try {
                            orderDetails = await contracts.rideOrder.getOrder(orderIdNum);
                            console.log(`[PLATFORM] [loadDisputes:3169] getOrder æˆåŠŸï¼Œè®¢å•è¯¦æƒ…:`, orderDetails);
                        } catch (getOrderError) {
                            console.error(`[PLATFORM] [loadDisputes] getOrder è°ƒç”¨å¤±è´¥:`, getOrderError);
                            window.logger?.error(`[PLATFORM] getOrder è°ƒç”¨å¤±è´¥`, {
                                orderId: orderIdNum,
                                error: getOrderError.message,
                                code: getOrderError.code,
                                reason: getOrderError.reason,
                                data: getOrderError.data,
                                method: getOrderError.method,
                                stack: getOrderError.stack,
                                contractAddress,
                                rpcUrl,
                                contractInstanceAddress: contracts.rideOrder?.address
                            });
                            throw getOrderError; // é‡æ–°æŠ›å‡ºï¼Œè®©å¤–å±‚catchå¤„ç†
                        }
                        
                        // è·å–äº‰è®®çŠ¶æ€ï¼ˆä½¿ç”¨æ•°å­—ç±»å‹çš„è®¢å•IDï¼‰
                        console.log(`[PLATFORM] [loadDisputes:3171] è°ƒç”¨ getDisputeStatus(${orderIdNum})...`);
                        window.logger?.debug('[PLATFORM] è°ƒç”¨getDisputeStatus', { orderId: orderIdNum });
                        
                        let disputeStatus;
                        try {
                            if (typeof contracts.rideOrder.getDisputeStatus !== 'function') {
                                throw new Error('getDisputeStatus å‡½æ•°ä¸å­˜åœ¨äºåˆçº¦å®ä¾‹ä¸­');
                            }
                            disputeStatus = await contracts.rideOrder.getDisputeStatus(orderIdNum);
                            console.log(`[PLATFORM] [loadDisputes:3173] getDisputeStatus æˆåŠŸï¼Œäº‰è®®çŠ¶æ€:`, disputeStatus);
                        } catch (getDisputeStatusError) {
                            console.error(`[PLATFORM] [loadDisputes] getDisputeStatus è°ƒç”¨å¤±è´¥:`, getDisputeStatusError);
                            window.logger?.error(`[PLATFORM] getDisputeStatus è°ƒç”¨å¤±è´¥`, {
                                orderId: orderIdNum,
                                error: getDisputeStatusError.message,
                                code: getDisputeStatusError.code,
                                reason: getDisputeStatusError.reason,
                                data: getDisputeStatusError.data,
                                method: getDisputeStatusError.method,
                                stack: getDisputeStatusError.stack,
                                contractAddress,
                                rpcUrl
                            });
                            // å¦‚æœgetDisputeStatuså¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼ç»§ç»­å¤„ç†
                            disputeStatus = {
                                disputeOpened: true,
                                disputeReason: 'æ— æ³•è·å–äº‰è®®çŠ¶æ€',
                                disputeResolved: false,
                                disputeOpener: event.args.by,
                                disputeWinner: ethers.constants.AddressZero,
                                disputeOpenedAt: event.args.timestamp.toNumber(),
                                disputeResolvedAt: 0,
                                disputeResolutionDetail: '',
                                rideStatus: 0
                            };
                        }
                        
                        // è·å–äº‹ä»¶å—ä¿¡æ¯
                        const block = await provider.getBlock(event.blockNumber);
                        
                        newDisputeData.push({
                            orderId: orderId,
                            openedBy: event.args.by || disputeStatus.disputeOpener,
                            reason: event.args.reason || disputeStatus.disputeReason,
                            timestamp: event.args.timestamp && event.args.timestamp.toNumber ? event.args.timestamp.toNumber() : (disputeStatus.disputeOpenedAt && disputeStatus.disputeOpenedAt.toNumber ? disputeStatus.disputeOpenedAt.toNumber() : block.timestamp),
                            blockNumber: event.blockNumber,
                            transactionHash: event.transactionHash,
                            disputeOpened: disputeStatus.disputeOpened,
                            disputeResolved: disputeStatus.disputeResolved,
                            disputeWinner: disputeStatus.disputeWinner,
                            disputeOpenedAt: disputeStatus.disputeOpenedAt && disputeStatus.disputeOpenedAt.toNumber ? disputeStatus.disputeOpenedAt.toNumber() : null,
                            disputeResolvedAt: disputeStatus.disputeResolvedAt && disputeStatus.disputeResolvedAt.toNumber ? disputeStatus.disputeResolvedAt.toNumber() : null,
                            disputeResolutionDetail: disputeStatus.disputeResolutionDetail || '',
                            orderDetails: orderDetails
                        });
                    } catch (error) {
                        console.error(`[PLATFORM] [loadDisputes:3201] æ— æ³•è·å–è®¢å• #${orderId} (æ•°å­—ID: ${orderIdNum !== null ? orderIdNum : 'N/A'}) çš„è¯¦æƒ…:`, error);
                        window.logger?.error('[PLATFORM] è·å–è®¢å•è¯¦æƒ…å¤±è´¥', { orderId: orderId, orderIdNum: orderIdNum, error: error.message });
                        console.error(`[PLATFORM] [loadDisputes:3202] é”™è¯¯è¯¦æƒ…:`, {
                            message: error.message,
                            code: error.code,
                            reason: error.reason,
                            data: error.data,
                            method: error.method,
                            stack: error.stack
                        });
                        // å³ä½¿getOrderå¤±è´¥ï¼Œä¹Ÿå°è¯•ä½¿ç”¨äº‹ä»¶æ•°æ®åˆ›å»ºåŸºæœ¬è®°å½•
                        try {
                            const block = await provider.getBlock(event.blockNumber);
                            newDisputeData.push({
                                orderId: orderId,
                                openedBy: event.args.by || event.args.opener || 'Unknown',
                                reason: event.args.reason || 'Unknown',
                                timestamp: event.args.timestamp && event.args.timestamp.toNumber ? event.args.timestamp.toNumber() : block.timestamp,
                                blockNumber: event.blockNumber,
                                transactionHash: event.transactionHash,
                                disputeOpened: true,
                                disputeResolved: false, // æ— æ³•è·å–ï¼Œè®¾ä¸ºfalse
                                disputeWinner: null,
                                disputeOpenedAt: block.timestamp,
                                disputeResolvedAt: null,
                                disputeResolutionDetail: '',
                                orderDetails: null, // getOrderå¤±è´¥ï¼Œè®¾ä¸ºnull
                                _error: 'getOrder failed: ' + error.message
                            });
                            console.log(`[loadDisputes:3220] ä½¿ç”¨äº‹ä»¶æ•°æ®åˆ›å»ºåŸºæœ¬äº‰è®®è®°å½• (è®¢å• #${orderId})`);
                        } catch (fallbackError) {
                            console.error(`[loadDisputes:3222] åˆ›å»ºåŸºæœ¬äº‰è®®è®°å½•ä¹Ÿå¤±è´¥:`, fallbackError);
                        }
                    }
                }

                console.log(`[PLATFORM] [loadDisputes:3226] æˆåŠŸå¤„ç† ${newDisputeData.length} ä¸ªäº‰è®®è®¢å• (æ€»äº‹ä»¶æ•°: ${disputeOpenedEvents.length})`);
                window.logger?.info('[PLATFORM] å¤„ç†äº‰è®®æ•°æ®å®Œæˆ', { 
                    totalEvents: disputeOpenedEvents.length, 
                    processedCount: newDisputeData.length,
                    orderIds: newDisputeData.map(d => d.orderId)
                });
                
                // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                newDisputeData.sort((a, b) => b.timestamp - a.timestamp);

                disputeData = newDisputeData;
                console.log(`[PLATFORM] [loadDisputes:3216] è®¾ç½®disputeData (${disputeData.length}æ¡)ï¼Œå‡†å¤‡æ¸²æŸ“åˆ—è¡¨`);
                window.logger?.debug('[PLATFORM] å‡†å¤‡æ¸²æŸ“äº‰è®®åˆ—è¡¨', { disputeDataCount: disputeData.length });
                renderDisputeList();

            } catch (error) {
                console.error('åŠ è½½äº‰è®®è®¢å•å¤±è´¥:', error);
                alert('åŠ è½½äº‰è®®è®¢å•å¤±è´¥: ' + error.message);
            } finally {
                isLoadingDisputes = false;
                if (loadingEl) loadingEl.style.display = 'none';
            }
        }

        window.loadDisputes = loadDisputes;

        // æ¸²æŸ“äº‰è®®è®¢å•åˆ—è¡¨
        function renderDisputeList() {
            console.log(`[PLATFORM] [renderDisputeList] å¼€å§‹æ¸²æŸ“ï¼ŒdisputeDataé•¿åº¦: ${disputeData?.length || 0}`);
            window.logger?.debug('[PLATFORM] å¼€å§‹æ¸²æŸ“äº‰è®®åˆ—è¡¨', { disputeDataCount: disputeData?.length || 0, disputeData: disputeData });
            
            const container = document.getElementById('dispute-list');
            const emptyState = document.getElementById('empty-state-disputes');
            const statusFilter = document.getElementById('dispute-status-filter')?.value || 'all';

            if (!container) {
                console.warn('[PLATFORM] [renderDisputeList] å®¹å™¨å…ƒç´ ä¸å­˜åœ¨');
                window.logger?.warn('[PLATFORM] äº‰è®®åˆ—è¡¨å®¹å™¨ä¸å­˜åœ¨');
                return;
            }

            // åº”ç”¨çŠ¶æ€ç­›é€‰
            let filteredData = disputeData || [];
            if (statusFilter === 'open') {
                filteredData = filteredData.filter(d => d.disputeOpened && !d.disputeResolved);
            } else if (statusFilter === 'resolved') {
                filteredData = filteredData.filter(d => d.disputeResolved);
            }

            console.log(`[PLATFORM] [renderDisputeList] ç­›é€‰åæ•°æ®é•¿åº¦: ${filteredData.length} (ç­›é€‰æ¡ä»¶: ${statusFilter})`);
            window.logger?.debug('[PLATFORM] ç­›é€‰äº‰è®®æ•°æ®', { filteredCount: filteredData.length, statusFilter: statusFilter });
            
            if (filteredData.length === 0) {
                console.log(`[PLATFORM] [renderDisputeList] æ²¡æœ‰äº‰è®®æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€`);
                window.logger?.info('[PLATFORM] æ²¡æœ‰äº‰è®®æ•°æ®å¯æ˜¾ç¤º', { statusFilter: statusFilter, totalCount: disputeData?.length || 0 });
                container.style.display = 'none';
                if (emptyState) emptyState.style.display = 'flex';
                return;
            }

            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            if (emptyState) emptyState.style.display = 'none';

            container.innerHTML = filteredData.map((item, index) => {
                const date = new Date(item.timestamp * 1000);
                const isResolved = item.disputeResolved;
                const statusClass = isResolved ? 'dispute-resolved' : 'dispute-open';
                const statusBadge = isResolved 
                    ? `<span class="dispute-status-badge resolved">${window.platformTexts?.resolved || 'å·²è§£å†³'}</span>`
                    : `<span class="dispute-status-badge open">${window.platformTexts?.open || 'å¾…å¤„ç†'}</span>`;

                // è·å–è®¢å•çŠ¶æ€ä¿¡æ¯
                let orderStatus = 'Unknown';
                if (item.orderDetails) {
                    const status = typeof item.orderDetails.status === 'number' 
                        ? item.orderDetails.status 
                        : (item.orderDetails.status?.toNumber ? item.orderDetails.status.toNumber() : 0);
                    const statusNames = ['Pending', 'Accepted', 'Picked Up', 'Completed', 'Cancelled'];
                    orderStatus = statusNames[status] || 'Unknown';
                }

                return `
                    <div class="dispute-item ${statusClass}">
                        <div class="dispute-header">
                            <div>
                                <div class="revenue-date">${date.toLocaleString('zh-CN', { 
                                    year: 'numeric', 
                                    month: '2-digit', 
                                    day: '2-digit', 
                                    hour: '2-digit', 
                                    minute: '2-digit',
                                    second: '2-digit'
                                })}</div>
                                <div class="dispute-order-id" style="margin-top: 8px;">
                                    ${window.platformTexts?.order || 'è®¢å•'} #${item.orderId}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                ${statusBadge}
                                <button class="btn-details" onclick="showDisputeDetail('${item.orderId}')" style="margin-top: 12px;">
                                    ${window.platformTexts?.details || 'è¯¦æƒ…'}
                                </button>
                            </div>
                        </div>
                        <div class="dispute-info">
                            <div class="dispute-info-item">
                                <div class="dispute-info-label">${window.platformTexts?.openedBy || 'å‘èµ·äºº'}</div>
                                <div class="dispute-info-value address" onclick="copyToClipboard('${item.openedBy}'); event.stopPropagation();" title="${window.platformTexts?.clickToCopy || 'ç‚¹å‡»å¤åˆ¶'}">
                                    ${item.openedBy.substring(0, 6)}...${item.openedBy.substring(38)}
                                </div>
                            </div>
                            <div class="dispute-info-item">
                                <div class="dispute-info-label">${window.platformTexts?.orderStatus || 'è®¢å•çŠ¶æ€'}</div>
                                <div class="dispute-info-value">${orderStatus}</div>
                            </div>
                            ${isResolved ? `
                            <div class="dispute-info-item">
                                <div class="dispute-info-label">${window.platformTexts?.winner || 'è·èƒœæ–¹'}</div>
                                <div class="dispute-info-value address" onclick="copyToClipboard('${item.disputeWinner}'); event.stopPropagation();" title="${window.platformTexts?.clickToCopy || 'ç‚¹å‡»å¤åˆ¶'}">
                                    ${item.disputeWinner && item.disputeWinner !== ethers.constants.AddressZero 
                                        ? item.disputeWinner.substring(0, 6) + '...' + item.disputeWinner.substring(38)
                                        : window.platformTexts?.notSet || 'æœªè®¾ç½®'}
                                </div>
                            </div>
                            ` : ''}
                            <div class="dispute-info-item">
                                <div class="dispute-info-label">${window.platformTexts?.txHash || 'äº¤æ˜“å“ˆå¸Œ'}</div>
                                <div class="dispute-info-value address" onclick="copyToClipboard('${item.transactionHash}'); event.stopPropagation();" title="${window.platformTexts?.clickToCopy || 'ç‚¹å‡»å¤åˆ¶'}">
                                    ${item.transactionHash.substring(0, 10)}...${item.transactionHash.substring(58)}
                                </div>
                            </div>
                        </div>
                        ${item.reason ? `
                        <div class="dispute-reason">
                            <div class="dispute-reason-label">${window.platformTexts?.disputeReason || 'äº‰è®®åŸå› '}</div>
                            <div class="dispute-reason-text">${item.reason}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        window.showDisputeDetail = function(orderId) {
            // ä½¿ç”¨ç°æœ‰çš„è¯¦æƒ…æ¨¡æ€æ¡†æ˜¾ç¤ºäº‰è®®è®¢å•è¯¦æƒ…
            const dispute = disputeData.find(d => d.orderId === orderId.toString());
            if (!dispute) {
                alert('æœªæ‰¾åˆ°è¯¥äº‰è®®è®¢å•');
                return;
            }

            // è°ƒç”¨ç°æœ‰çš„ showDetailModal å‡½æ•°ï¼Œä¼ å…¥è®¢å•ID
            // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ç¡®ä¿ showDetailModal èƒ½å¤„ç†äº‰è®®è®¢å•
            showDetailModal(dispute.orderId);
        };

        // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
        function closeDetailModal() {
            document.getElementById('detail-modal').classList.remove('active');
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('å·²å¤åˆ¶: ' + text);
            });
        }

        // å¯¼å‡ºæ•°æ®
        async function exportData() {
            if (!window.filteredRevenueData || window.filteredRevenueData.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                return;
            }
            
            try {
                // å‡†å¤‡è®¢å•æ•°æ®
                const ordersData = window.filteredRevenueData.map(item => {
                    const date = new Date(item.timestamp * 1000);
                    const platformFeeETH = ethers.utils.formatEther(item.platformFee);
                    const orderAmount = item.driverAmount.add(item.platformFee);
                    const orderAmountETH = ethers.utils.formatEther(orderAmount);
                    
                    return {
                        orderId: item.orderId,
                        date: date.toISOString(),
                        dateString: date.toLocaleDateString('zh-CN'),
                        timeString: date.toLocaleTimeString('zh-CN'),
                        timestamp: item.timestamp,
                        platformFeeETH: parseFloat(platformFeeETH).toFixed(8),
                        platformFeeUSD: (parseFloat(platformFeeETH) * ETH_TO_USD_RATE).toFixed(2),
                        driverAddress: item.driver,
                        orderAmountETH: parseFloat(orderAmountETH).toFixed(8),
                        orderAmountUSD: (parseFloat(orderAmountETH) * ETH_TO_USD_RATE).toFixed(2),
                        transactionHash: item.transactionHash,
                        blockNumber: item.blockNumber || 0,
                        orderDetails: item.orderDetails || null
                    };
                });
                
                // è°ƒç”¨åç«¯APIä¿å­˜JSONæ–‡ä»¶
                const response = await fetch('/api/platform/save-orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ orders: ordersData })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`è®¢å•è®°å½•å·²ä¿å­˜æˆåŠŸï¼\næ–‡ä»¶å: ${result.data.filename}\nè®¢å•æ•°: ${result.data.totalOrders}`);
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
                alert('å¯¼å‡ºæ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('detail-modal').addEventListener('click', (e) => {
            if (e.target.id === 'detail-modal') {
                closeDetailModal();
            }
        });

        // æœç´¢æ¡†å®æ—¶ç­›é€‰
        document.getElementById('search-input')?.addEventListener('input', renderRevenueList);
        document.getElementById('start-date')?.addEventListener('change', renderRevenueList);
        document.getElementById('end-date')?.addEventListener('change', renderRevenueList);
    </script>
</body>
</html>

