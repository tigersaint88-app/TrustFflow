<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrustFlow - Driver App</title>
    <script src="ethers.umd.min.js"></script>
    <script src="i18n.js"></script>
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* SaaS Professional Color Palette - Stripe/Uber/Airbnb inspired */
            --primary-color: #635bff;
            --primary-dark: #4a42d4;
            --primary-light: #7c3aed;
            --secondary-color: #0a2540;
            --success-color: #00d4aa;
            --error-color: #e25950;
            --warning-color: #ffb020;
            --info-color: #3b82f6;
            
            /* Neutral Colors */
            --gray-50: #fafbfc;
            --gray-100: #f6f8fa;
            --gray-200: #e1e4e8;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Background Colors */
            --bg-primary: #ffffff;
            --bg-secondary: #fafbfc;
            --bg-tertiary: #f6f8fa;
            
            /* Shadows - Subtle and Professional */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-focus: 0 0 0 3px rgba(99, 91, 255, 0.1);
            
            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            
            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            
            /* Typography */
            --font-size-xs: 12px;
            --font-size-sm: 14px;
            --font-size-base: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 20px;
            --font-size-2xl: 24px;
            --font-size-3xl: 30px;
            
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            line-height: 1.5;
            color: var(--gray-900);
            padding-bottom: 80px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            background: var(--bg-primary);
            min-height: calc(100vh - 80px);
            padding: 0;
            overflow-x: hidden;
        }
        
        .header {
            background: var(--bg-primary);
            color: var(--gray-900);
            padding: var(--spacing-xl) var(--spacing-lg);
            border-bottom: 1px solid var(--gray-200);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }
        
        .header-content {
            flex: 1;
            text-align: left;
        }
        
        .header h1 {
            font-size: var(--font-size-3xl);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            letter-spacing: -0.025em;
            color: var(--gray-900);
            line-height: 1.2;
        }
        
        .header .subtitle {
            font-size: var(--font-size-sm);
            font-weight: 400;
            color: var(--gray-600);
            margin-top: var(--spacing-xs);
        }
        
        /* Ê±âÂ†°ËèúÂçïÊåâÈíÆ - SaaS È£éÊ†º */
        .hamburger-menu {
            position: fixed;
            top: var(--spacing-md);
            right: var(--spacing-md);
            background: var(--bg-primary);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            width: 40px;
            height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            z-index: 1001;
            box-shadow: var(--shadow-sm);
            gap: 5px;
        }
        
        .hamburger-menu:hover {
            background: var(--gray-50);
            border-color: var(--gray-300);
            box-shadow: var(--shadow-md);
        }
        
        .hamburger-menu.active {
            background: var(--gray-50);
            border-color: var(--primary-color);
        }
        
        .hamburger-menu span {
            display: block;
            width: 20px;
            height: 2px;
            background: var(--gray-700);
            margin: 0;
            padding: 0;
            transition: var(--transition);
            border-radius: 1px;
        }
        
        .hamburger-menu.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        
        .hamburger-menu.active span:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger-menu.active span:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }
        
        /* ‰æßËæπÊ†èËèúÂçï - SaaS È£éÊ†º */
        .sidebar-menu {
            position: fixed;
            top: 0;
            left: -320px;
            width: 320px;
            height: 100vh;
            background: var(--bg-primary);
            box-shadow: var(--shadow-xl);
            border-right: 1px solid var(--gray-200);
            z-index: 1000;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            padding-top: 80px;
        }
        
        .sidebar-menu.open {
            left: 0;
        }
        
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            backdrop-filter: blur(2px);
        }
        
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .sidebar-header {
            padding: var(--spacing-lg);
            background: var(--gray-900);
            color: white;
            position: fixed;
            top: 0;
            left: -320px;
            width: 320px;
            z-index: 1001;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 1px solid var(--gray-200);
        }
        
        .sidebar-menu.open .sidebar-header {
            left: 0;
        }
        
        .sidebar-header h2 {
            font-size: var(--font-size-xl);
            margin: 0;
            font-weight: 600;
        }
        
        .sidebar-menu-items {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar-menu-item {
            border-bottom: 1px solid var(--gray-100);
        }
        
        .sidebar-menu-item a {
            display: flex;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            color: var(--gray-700);
            text-decoration: none;
            transition: var(--transition);
            cursor: pointer;
        }
        
        .sidebar-menu-item a:hover {
            background: var(--gray-50);
        }
        
        .sidebar-menu-item.active a {
            background: rgba(99, 91, 255, 0.08);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .sidebar-menu-icon {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sidebar-menu-label {
            flex: 1;
            font-size: 16px;
        }
        
        .sidebar-menu-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 8px 0;
        }
        
        /* Language Options */
        .language-options {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px 20px;
            background: #f9fafb;
        }
        
        .lang-option {
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
        }
        
        .lang-option:hover {
            background: #f0f0f0;
        }
        
        .lang-option.active {
            background: var(--primary-color);
            color: white;
        }
        
        .lang-option.active .sidebar-menu-label {
            color: white;
        }
        
        .lang-check {
            font-size: 18px;
            font-weight: bold;
        }
        
        .wallet-status {
            background: var(--bg-primary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            margin: var(--spacing-md) var(--spacing-lg);
            text-align: center;
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
        }
        
        .status {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-sm);
            margin: 0;
            font-weight: 500;
            font-size: var(--font-size-sm);
            display: inline-block;
        }
        
        .status.success {
            background: rgba(0, 212, 170, 0.1);
            color: #065f46;
        }
        
        .status.error {
            background: rgba(226, 89, 80, 0.1);
            color: #991b1b;
        }
        
        .status.info {
            background: rgba(59, 130, 246, 0.1);
            color: #1e40af;
        }
        
        .status.warning {
            background: rgba(255, 176, 32, 0.1);
            color: #92400e;
        }
        
        .account-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-primary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            margin: 0 var(--spacing-lg) var(--spacing-md) var(--spacing-lg);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
        }
        
        .account-details {
            flex: 1;
            margin-right: 12px;
        }
        
        .account-address {
            font-family: monospace;
            font-size: 13px;
            color: #4b5563;
            word-break: break-all;
            margin: 4px 0;
            line-height: 1.4;
        }
        
        .account-details > div:first-child {
            margin-bottom: 6px;
            font-size: 14px;
        }
        
        .account-details div[style*="font-size: 12px"] {
            margin-top: 6px !important;
            line-height: 1.4;
        }
        
        .btn-switch-account {
            background: #6366f1;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            margin-left: 0;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .btn-switch-account:hover {
            background: #4f46e5;
        }
        
        button:not(.filter-tab) {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--font-size-base);
            font-weight: 500;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }
        
        button:hover {
            background: var(--primary-dark);
            box-shadow: var(--shadow-md);
        }
        
        button:disabled {
            background: var(--gray-400);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        button.secondary {
            background: var(--gray-600);
        }
        
        button.secondary:hover {
            background: var(--gray-700);
        }
        
        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .order-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }
        
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--gray-300);
        }
        
        .order-card.disputed {
            border: 2px solid #ef4444;
        }
        
        .order-card.disputed:hover {
            border-color: #dc2626;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.1), 0 2px 4px -1px rgba(239, 68, 68, 0.06);
        }
        
        /* ËÆ¢ÂçïËØ¶ÊÉÖÊ®°ÊÄÅÂØπËØùÊ°Ü */
        .order-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        
        .order-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .order-modal-content {
            position: relative;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            max-width: 90vw;
            max-height: 90vh;
            width: 100%;
            max-width: 800px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            animation: slideUp 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .order-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg) var(--spacing-xl);
            border-bottom: 1px solid var(--gray-200);
            background: var(--bg-primary);
        }
        
        .order-modal-header h2 {
            margin: 0;
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--gray-900);
        }
        
        .order-info-close-btn {
            width: auto !important;
            padding: 4px 12px !important;
            background: transparent !important;
            border: none !important;
            color: #6b7280 !important;
            font-size: 24px !important;
            cursor: pointer !important;
            line-height: 1 !important;
            transition: color 0.2s;
        }
        
        .order-info-close-btn:hover {
            color: var(--gray-900) !important;
        }
        
        #order-modal-body {
            overflow-y: auto;
            max-height: calc(90vh - 80px);
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .order-card h3 {
            color: var(--primary-color);
            margin-bottom: var(--spacing-md);
            font-size: var(--font-size-lg);
            font-weight: 600;
        }
        
        .order-info {
            margin: var(--spacing-sm) 0;
            color: var(--gray-600);
            font-size: var(--font-size-sm);
        }
        
        .order-info strong {
            color: var(--gray-900);
        }
        
        .order-fare {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--primary-color);
            margin: var(--spacing-md) 0;
        }
        
        .btn-accept {
            width: 100%;
            margin-top: 15px;
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: var(--spacing-2xl) var(--spacing-lg);
            color: var(--gray-500);
        }
        
        .empty-state h2 {
            margin-bottom: var(--spacing-sm);
            color: var(--gray-700);
            font-size: var(--font-size-xl);
            font-weight: 600;
        }
        
        /* Â∫ïÈÉ®ÂØºËà™ËèúÂçï - SaaS È£éÊ†º */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border-top: 1px solid var(--gray-200);
            padding: var(--spacing-sm) 0;
            z-index: 100;
            box-shadow: 0 -1px 3px rgba(0,0,0,0.05);
        }
        
        .bottom-nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .bottom-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray-600);
            text-decoration: none;
            min-width: 0;
            border-radius: var(--radius-md);
            margin: 0 var(--spacing-xs);
        }
        
        .bottom-nav-item:hover {
            color: var(--primary-color);
            background: var(--gray-50);
        }
        
        .bottom-nav-item.active {
            color: var(--primary-color);
        }
        
        .bottom-nav-icon {
            font-size: 20px;
            margin-bottom: var(--spacing-xs);
            line-height: 1;
        }
        
        .bottom-nav-label {
            font-size: var(--font-size-xs);
            font-weight: 500;
            letter-spacing: 0;
        }
        
        .bottom-nav-item.active .bottom-nav-label {
            font-weight: 600;
        }
        
        /* View Container */
        .view-container {
            min-height: calc(100vh - 80px);
            padding-bottom: 80px;
        }
        
        .content {
            padding: 0;
        }
        
        /* Filter Tabs - SaaS È£éÊ†º */
        .filter-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            padding: 0 16px;
            border-bottom: 2px solid #e5e7eb;
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
        
        .filter-tabs::-webkit-scrollbar {
            height: 6px;
        }
        
        .filter-tabs::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .filter-tabs::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .filter-tabs::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .filter-tab {
            padding: 12px 20px;
            border: none !important;
            background: transparent !important;
            color: #6b7280;
            border-radius: 0 !important;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            position: relative;
            margin-bottom: -2px;
            outline: none !important;
            box-shadow: none !important;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: auto !important;
            margin-top: 0 !important;
        }
        
        .filter-tab:hover {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.05) !important;
            border: none !important;
            box-shadow: none !important;
        }
        
        .filter-tab:focus {
            outline: none !important;
            box-shadow: none !important;
            border: none !important;
        }
        
        .filter-tab.active {
            background: transparent !important;
            border: none !important;
            color: #3b82f6 !important;
            font-weight: 600 !important;
            box-shadow: none !important;
            outline: none !important;
        }
        
        .filter-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #3b82f6;
            z-index: 1;
        }
        
        /* Dispute Section */
        .dispute-section {
            border: 1px solid #ddd;
            padding: 16px;
            margin-top: 20px;
            border-radius: 8px;
            background: #fafafa;
        }
        
        .dispute-section h3 {
            margin-bottom: 16px;
            color: #1f2937;
            font-size: 16px;
            font-weight: 700;
        }
        
        .dispute-section textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
        }
        
        .dispute-section button {
            margin-top: 12px;
            padding: 10px 20px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .dispute-section button:hover:not(:disabled) {
            background: #dc2626;
        }
        
        .dispute-section button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        /* Orders List */
        .orders-list {
            padding: 20px;
        }
        
        /* ÁªüËÆ°ËßÜÂõæÊ†∑Âºè */
        .statistics-view {
            padding: var(--spacing-lg);
            background: var(--bg-secondary);
            margin: 0;
        }
        
        .statistics-container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .statistics-container h2 {
            color: var(--gray-900);
            margin-bottom: var(--spacing-lg);
            font-size: var(--font-size-xl);
            font-weight: 600;
        }
        
        .chart-container {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            min-height: 300px;
            overflow-x: auto;
        }
        
        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: var(--spacing-lg);
            padding: var(--spacing-lg);
        }
        
        .order-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            cursor: pointer;
        }
        
        .order-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
            border-color: var(--gray-300);
        }
        
        /* Profile Styles - SaaS È£éÊ†º */
        .profile-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl) var(--spacing-lg);
            margin: var(--spacing-lg);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }
        
        .profile-avatar {
            flex-shrink: 0;
        }
        
        .avatar-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-2xl);
            font-weight: 700;
            border: 2px solid var(--gray-200);
            color: var(--primary-color);
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-info h2 {
            color: var(--gray-900);
            font-size: var(--font-size-2xl);
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
        }
        
        .profile-address {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            word-break: break-all;
            margin: var(--spacing-sm) 0;
        }
        
        .profile-role {
            font-size: var(--font-size-sm);
            color: var(--gray-500);
            margin-top: var(--spacing-xs);
        }
        
        /* Stats Grid - SaaS È£éÊ†º */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
            margin: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        
        .stat-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            text-align: center;
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
        }
        
        .stat-value {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--spacing-xs);
        }
        
        .stat-label {
            font-size: var(--font-size-xs);
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Section - SaaS È£éÊ†º */
        .section {
            margin: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-xl);
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }
        
        .section:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--gray-300);
        }
        
        .section h2 {
            color: var(--gray-900);
            margin-bottom: var(--spacing-lg);
            font-size: var(--font-size-xl);
            font-weight: 600;
        }
        
        /* Profile Form - SaaS È£éÊ†º */
        .profile-form {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
        }
        
        .form-group {
            margin-bottom: var(--spacing-lg);
        }
        
        .form-group label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: var(--spacing-xs);
        }
        
        .form-input {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            transition: var(--transition);
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }
        
        .form-hint {
            display: block;
            font-size: var(--font-size-xs);
            color: var(--gray-500);
            margin-top: var(--spacing-xs);
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: var(--spacing-md) var(--spacing-xl);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
        }
        
        .btn-primary:hover {
            background: var(--primary-color-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        /* Settings List - SaaS È£éÊ†º */
        .settings-list {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--gray-100);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        .setting-item:hover {
            background: var(--gray-50);
        }
        
        .setting-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: var(--spacing-md);
            flex-shrink: 0;
        }
        
        .setting-content {
            flex: 1;
        }
        
        .setting-title {
            font-size: var(--font-size-base);
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--spacing-xs);
        }
        
        .setting-desc {
            font-size: var(--font-size-sm);
            color: var(--gray-500);
        }
        
        .setting-arrow {
            font-size: var(--font-size-2xl);
            color: var(--gray-400);
            margin-left: var(--spacing-md);
        }
        
        /* Loading and Empty States - SaaS È£éÊ†º */
        .loading-state, .empty-state {
            text-align: center;
            padding: var(--spacing-2xl) var(--spacing-lg);
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: var(--spacing-md);
            opacity: 0.3;
        }
        
        .empty-state p {
            color: var(--gray-500);
            font-size: var(--font-size-base);
            margin: var(--spacing-sm) 0;
        }
        
        .empty-hint {
            font-size: var(--font-size-sm) !important;
            color: var(--gray-400) !important;
        }
        
        /* Route Styles */
        .order-route {
            margin: 16px 0;
        }
        
        .route-point {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .route-point:last-child {
            margin-bottom: 0;
        }
        
        .route-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 12px;
            flex-shrink: 0;
            font-weight: 600;
        }
        
        .route-icon.pickup {
            background: var(--primary-color);
            color: white;
        }
        
        .route-icon.destination {
            background: var(--error-color);
            color: white;
        }
        
        .route-line {
            width: 2px;
            height: 20px;
            background: #e5e7eb;
            margin-left: 11px;
            margin-right: 12px;
        }
        
        .route-address {
            flex: 1;
            font-size: 15px;
            color: #1f2937;
            line-height: 1.4;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .profile-card {
                flex-direction: column;
                text-align: center;
            }
            
            .filter-tabs {
                padding: 12px 16px;
            }
            
            .orders-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ‰æßËæπÊ†èÈÅÆÁΩ© -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <!-- ‰æßËæπÊ†èËèúÂçï -->
    <div class="sidebar-menu" id="sidebar-menu">
        <div class="sidebar-header">
            <h2>‚öôÔ∏è <span data-i18n="systemMenu">System Menu</span></h2>
        </div>
        <ul class="sidebar-menu-items">
            <li class="sidebar-menu-item" id="sidebar-nav-available">
                <a onclick="navigateFromSidebar('available')">
                    <span class="sidebar-menu-icon">üöó</span>
                    <span class="sidebar-menu-label">Available Orders</span>
                </a>
            </li>
            <li class="sidebar-menu-item" id="sidebar-nav-my-orders">
                <a onclick="navigateFromSidebar('my-orders')">
                    <span class="sidebar-menu-icon">üìã</span>
                    <span class="sidebar-menu-label">My Orders</span>
                </a>
            </li>
            <li class="sidebar-menu-item" id="sidebar-nav-profile">
                <a onclick="navigateFromSidebar('profile')">
                    <span class="sidebar-menu-icon">üë§</span>
                    <span class="sidebar-menu-label">Profile</span>
                </a>
            </li>
            <li class="sidebar-menu-divider"></li>
            <li class="sidebar-menu-item" id="sidebar-connection-status" style="display: none;">
                <a style="cursor: default;">
                    <span class="sidebar-menu-icon">üîó</span>
                    <span class="sidebar-menu-label" id="sidebar-connection-text">Connected</span>
                    <span style="font-size: 12px; color: #10b981; margin-left: 8px;">‚úì</span>
                </a>
            </li>
            <li class="sidebar-menu-item" id="sidebar-account-info" style="display: none;">
                <a onclick="showWalletInfo(); toggleSidebar();" style="flex-direction: column; align-items: flex-start;">
                    <div style="display: flex; align-items: center; width: 100%;">
                        <span class="sidebar-menu-icon">üíº</span>
                        <span class="sidebar-menu-label" data-i18n="driverWalletInfo">Wallet Info</span>
                    </div>
                    <div id="sidebar-account-address" style="font-size: 11px; color: #6b7280; margin-top: 4px; margin-left: 36px; font-family: monospace; word-break: break-all;"></div>
                </a>
            </li>
            <li class="sidebar-menu-item">
                <a onclick="switchAccount(); toggleSidebar();">
                    <span class="sidebar-menu-icon">üîÑ</span>
                    <span class="sidebar-menu-label" data-i18n="driverSwitchAccount">Switch Account</span>
                </a>
            </li>
            <li class="sidebar-menu-item">
                <a onclick="showNetworkInfo(); toggleSidebar();">
                    <span class="sidebar-menu-icon">üåê</span>
                    <span class="sidebar-menu-label" data-i18n="driverNetworkInfo">Network Info</span>
                </a>
            </li>
            <li class="sidebar-menu-item" id="language-menu-item">
                <a onclick="toggleLanguageMenu();">
                    <span class="sidebar-menu-icon">üåê</span>
                    <span class="sidebar-menu-label" data-i18n="language">Language</span>
                    <span id="current-lang" style="font-size: 14px; color: #6b7280;">EN</span>
                </a>
            </li>
            <li class="language-options" id="language-options" style="display: none;">
                <div class="lang-option active" id="lang-option-en" onclick="selectLanguage('en')">
                    <span class="sidebar-menu-label">English</span>
                    <span class="lang-check" id="lang-check-en">‚úì</span>
                </div>
                <div class="lang-option" id="lang-option-zh" onclick="selectLanguage('zh')">
                    <span class="sidebar-menu-label">‰∏≠Êñá</span>
                    <span class="lang-check" id="lang-check-zh" style="display: none;">‚úì</span>
                </div>
            </li>
            <li class="sidebar-menu-divider"></li>
            <li class="sidebar-menu-item">
                <a onclick="location.reload();">
                    <span class="sidebar-menu-icon">üîÑ</span>
                    <span class="sidebar-menu-label" data-i18n="driverRefreshPage">Refresh Page</span>
                </a>
            </li>
        </ul>
    </div>
    
    <div class="container">
        <div class="header">
            <button class="hamburger-menu" id="hamburger-menu" onclick="toggleSidebar()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="header-content">
                <h1 id="main-header-title">üöó TrustFlow - <span data-i18n="driverApp">Driver App</span></h1>
                <p id="main-header-subtitle" data-i18n="driverAppSubtitle">Driver Order Management System</p>
                <div class="browser-badge" id="browser-badge"></div>
            </div>
        </div>
        
        <div class="wallet-status" id="wallet-status">
            <button id="connect-btn" onclick="connectWallet()" data-i18n="connectWallet">Connect Wallet</button>
        </div>
        
        <div id="driver-interface" style="display: none;">
            <!-- Available Orders ËßÜÂõæ -->
            <div id="available-orders-view" class="view-container" style="display: block;">
                <div class="content">
                    <div id="available-orders-container">
                        <div class="loading-state" id="available-orders-loading">
                            <div class="loading"></div>
                            <p>Loading available orders...</p>
                        </div>
                        <div class="empty-state" id="available-orders-empty" style="display: none;">
                            <div class="empty-icon">üìã</div>
                            <p>No available orders</p>
                            <p class="empty-hint">Orders will appear here when passengers create them</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- My Orders ËßÜÂõæ -->
            <div id="my-orders-view" class="view-container" style="display: none;">
                <div class="content">
                    <!-- Á≠õÈÄâÊ†áÁ≠æ -->
                    <div class="filter-tabs">
                        <button class="filter-tab active" onclick="filterMyOrders('all')">All</button>
                        <button class="filter-tab" onclick="filterMyOrders('accepted')">Accepted</button>
                        <button class="filter-tab" onclick="filterMyOrders('completed')">Completed</button>
                        <button class="filter-tab" onclick="filterMyOrders('cancelled')">Cancelled</button>
                        <button class="filter-tab" onclick="filterMyOrders('statistics')" data-i18n="statistics">üìä Statistics</button>
                    </div>
                    
                    <!-- ÁªüËÆ°ËßÜÂõæ -->
                    <div id="my-orders-statistics" class="statistics-view" style="display: none;">
                        <div class="statistics-container">
                            <h2 style="margin-bottom: 20px; font-size: 20px; font-weight: 600; color: #1f2937;">Daily Orders Statistics</h2>
                            <div id="driver-daily-orders-chart" class="chart-container">
                                <!-- Êù°Áä∂ÂõæÂ∞ÜÂú®ËøôÈáåÊ∏≤Êüì -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- ËÆ¢ÂçïÂàóË°® -->
                    <div id="my-orders-list" class="orders-list">
                        <div class="loading-state" id="my-orders-loading">
                            <div class="loading"></div>
                            <p>Loading your orders...</p>
                        </div>
                        <div class="empty-state" id="my-orders-empty" style="display: none;">
                            <div class="empty-icon">üìã</div>
                            <p>No orders yet</p>
                            <p class="empty-hint">Accepted orders will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Profile ËßÜÂõæ -->
            <div id="profile-view" class="view-container" style="display: none;">
                <div class="content">
                    <!-- Áî®Êà∑‰ø°ÊÅØÂç°Áâá -->
                    <div class="profile-card">
                        <div class="profile-avatar">
                            <div class="avatar-circle">
                                <span id="profile-initials">D</span>
                            </div>
                        </div>
                        <div class="profile-info">
                            <h2 id="profile-name">Driver</h2>
                            <p class="profile-address" id="profile-address">-</p>
                            <p class="profile-role" id="profile-role">Driver</p>
                        </div>
                    </div>
                    
                    <!-- Ë¥¶Êà∑‰ø°ÊÅØÈù¢Êùø -->
                    <div id="account-info-panel" style="display: none;" class="account-info">
                        <div class="account-details">
                            <div style="font-weight: 600; margin-bottom: 6px; font-size: 14px;" data-i18n="driverCurrentAccountLabel">Current Driver Account:</div>
                            <div class="account-address" id="current-account-display"></div>
                            <div id="account-hint" style="font-size: 11px; color: #6b7280; margin-top: 6px; line-height: 1.4;" data-i18n="driverAccountHint">
                                Tip: Each browser can use a different MetaMask account, but connect to the same contract address
                            </div>
                        </div>
                        <button class="btn-switch-account" onclick="switchAccount()" data-i18n="driverSwitchAccount">Switch Account</button>
                    </div>
                    
                    <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="stat-total-orders">0</div>
                            <div class="stat-label">Total Orders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-completed-orders">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-total-earned">$0.00</div>
                            <div class="stat-label">Total Earned</div>
                        </div>
                    </div>
                    
                    <!-- ‰∏™‰∫∫‰ø°ÊÅØËÆæÁΩÆ -->
                    <div class="section">
                        <h2>Personal Information</h2>
                        <div class="profile-form">
                            <div class="form-group">
                                <label for="profile-nickname">Nickname</label>
                                <input type="text" id="profile-nickname" class="form-input" placeholder="Enter your nickname" />
                                <small class="form-hint">Display name for rental orders</small>
                            </div>
                            <div class="form-group">
                                <label for="profile-contact">Contact Method</label>
                                <input type="text" id="profile-contact" class="form-input" placeholder="Phone number, email, or Telegram" />
                                <small class="form-hint">How passengers can contact you (phone, email, etc.)</small>
                            </div>
                            <button class="btn-primary" onclick="saveProfile()">Save Profile</button>
                        </div>
                    </div>
                    
                    <!-- Ë¥¶Êà∑ËÆæÁΩÆ -->
                    <div class="section">
                        <h2>Account Settings</h2>
                        <div class="settings-list">
                            <div class="setting-item" onclick="showWalletInfo()">
                                <div class="setting-icon">üíº</div>
                                <div class="setting-content">
                                    <div class="setting-title">Wallet</div>
                                    <div class="setting-desc" id="setting-wallet-address">-</div>
                                </div>
                                <div class="setting-arrow">‚Ä∫</div>
                            </div>
                            <div class="setting-item" onclick="showNetworkInfo()">
                                <div class="setting-icon">üåê</div>
                                <div class="setting-content">
                                    <div class="setting-title">Network</div>
                                    <div class="setting-desc" id="setting-network">-</div>
                                </div>
                                <div class="setting-arrow">‚Ä∫</div>
                            </div>
                            <div class="setting-item" onclick="switchAccount()">
                                <div class="setting-icon">üîÑ</div>
                                <div class="setting-content">
                                    <div class="setting-title" data-i18n="driverSwitchAccount">Switch Account</div>
                                    <div class="setting-desc" data-i18n="driverSwitchAccountDesc">Change MetaMask account</div>
                                </div>
                                <div class="setting-arrow">‚Ä∫</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Â∫ïÈÉ®ÂØºËà™ËèúÂçï -->
    <nav class="bottom-nav" id="bottom-nav" style="display: none;">
        <div class="bottom-nav-items">
            <div class="bottom-nav-item active" id="nav-available" onclick="showAvailableOrdersView()">
                <div class="bottom-nav-icon">üöó</div>
                <div class="bottom-nav-label">Available</div>
            </div>
            <div class="bottom-nav-item" id="nav-my-orders" onclick="showMyOrdersView()">
                <div class="bottom-nav-icon">üìã</div>
                <div class="bottom-nav-label">My Orders</div>
            </div>
            <div class="bottom-nav-item" id="nav-profile" onclick="showProfileView()">
                <div class="bottom-nav-icon">üë§</div>
                <div class="bottom-nav-label">Profile</div>
            </div>
        </div>
    </nav>
    
    <!-- ËÆ¢ÂçïËØ¶ÊÉÖÊ®°ÊÄÅÂØπËØùÊ°Ü -->
    <div class="order-modal" id="order-modal" style="display: none;">
        <div class="order-modal-overlay" onclick="closeOrderModal()"></div>
        <div class="order-modal-content">
            <div class="order-modal-header">
                <h2 id="order-modal-title">ËÆ¢ÂçïËØ¶ÊÉÖ</h2>
                <button class="order-info-close-btn" onclick="closeOrderModal()" style="width: auto; padding: 4px 12px; background: transparent; border: none; color: #6b7280; font-size: 24px; cursor: pointer; line-height: 1;">√ó</button>
            </div>
            <div id="order-modal-body" style="padding: var(--spacing-xl); overflow-y: auto; max-height: calc(90vh - 80px);"></div>
        </div>
    </div>
    
    <script>
        // ===== ÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÔºàÂøÖÈ°ªÂú®ÊúÄÂâçÈù¢Ôºâ =====
        // ÊçïËé∑Êâ©Â±ïÁõ∏ÂÖ≥ÁöÑÊ∂àÊÅØÈÄöÈÅìÈîôËØØÔºåÈÅøÂÖçÊéßÂà∂Âè∞Âô™Èü≥
        (function() {
            if (typeof window !== 'undefined') {
                // ÊçïËé∑Êú™Â§ÑÁêÜÁöÑ Promise ÊãíÁªù
                window.addEventListener('unhandledrejection', (event) => {
                    const error = event.reason;
                    const errorMessage = error?.message || error?.toString() || String(error);
                    
                    // ÂøΩÁï• MetaMask/Chrome Êâ©Â±ïÁöÑÊ∂àÊÅØÈÄöÈÅìÈîôËØØÔºàËøôÊòØÊ≠£Â∏∏ÁöÑÔºå‰∏çÈúÄË¶ÅÊòæÁ§∫Ôºâ
                    if (errorMessage.includes('message channel closed') || 
                        errorMessage.includes('listener indicated an asynchronous response') ||
                        errorMessage.includes('Extension context invalidated')) {
                        event.preventDefault(); // ÈòªÊ≠¢ÈîôËØØÊòæÁ§∫Âú®ÊéßÂà∂Âè∞
                        // Âè™Âú®ÂºÄÂèëÊ®°Âºè‰∏ãËÆ∞ÂΩïË∞ÉËØï‰ø°ÊÅØ
                        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                            console.debug('ÂøΩÁï•Êâ©Â±ïÊ∂àÊÅØÈÄöÈÅìÈîôËØØÔºàËøôÊòØÊ≠£Â∏∏ÁöÑÔºâ');
                        }
                        return;
                    }
                    
                    // ÂÖ∂‰ªñÈîôËØØÊ≠£Â∏∏Â§ÑÁêÜÔºà‰ΩÜ‰∏çË¶ÅÈáçÂ§çÊòæÁ§∫Â∑≤Áü•ÁöÑÈîôËØØÔºâ
                    if (!errorMessage.includes('User rejected') && 
                        !errorMessage.includes('User denied')) {
                        console.error('Êú™Â§ÑÁêÜÁöÑ Promise ÊãíÁªù:', error);
                    }
                });
                
                // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨Âô®
                window.addEventListener('beforeunload', () => {
                    if (typeof window.ethereum !== 'undefined' && window.ethereum.removeListener) {
                        try {
                            // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨Âô®Ôºà‰ΩøÁî®Á©∫ÂáΩÊï∞‰Ωú‰∏∫Âç†‰ΩçÁ¨¶Ôºâ
                            const noop = () => {};
                            window.ethereum.removeListener('accountsChanged', noop);
                            window.ethereum.removeListener('chainChanged', noop);
                        } catch (error) {
                            // ÂøΩÁï•Ê∏ÖÁêÜÊó∂ÁöÑÈîôËØØ
                        }
                    }
                });
            }
        })();
        
        // È¶ñÂÖàÂÆö‰πâÂç†‰ΩçÁ¨¶ÂáΩÊï∞ÔºåÁ°Æ‰øùÂú®HTMLÂä†ËΩΩÂâçÂ∞±ÂèØÁî®
        window.toggleSidebar = function() {
            console.log('toggleSidebar: Function not yet initialized, please wait...');
        };
        
        window.toggleLanguageMenu = function() {
            console.log('toggleLanguageMenu: Function not yet initialized, please wait...');
        };
        
        window.selectLanguage = function(lang) {
            console.log('selectLanguage: Function not yet initialized, please wait...');
        };
        
        let provider, signer, account, contracts = {};
        const ETH_TO_USD_RATE = 2500;
        
        // Ê£ÄÊµãÊµèËßàÂô®ÔºàÊîØÊåÅÊõ¥Â§öÊµèËßàÂô®Ôºâ
        function detectBrowser() {
            const userAgent = navigator.userAgent;
            
            // Êåâ‰ºòÂÖàÁ∫ßÊ£ÄÊµãÔºàÊ≥®ÊÑèÔºöEdge ÈúÄË¶ÅÂÖà‰∫é Chrome Ê£ÄÊµãÔºåÂõ†‰∏∫ Edge ÁöÑ userAgent ÂåÖÂê´ "Chrome"Ôºâ
            if (userAgent.indexOf('Edg') > -1) return 'Edge';
            if (userAgent.indexOf('Opera') > -1 || userAgent.indexOf('OPR') > -1) return 'Opera';
            if (userAgent.indexOf('Brave') > -1) return 'Brave';
            if (userAgent.indexOf('Chrome') > -1) return 'Chrome';
            if (userAgent.indexOf('Firefox') > -1) return 'Firefox';
            if (userAgent.indexOf('Safari') > -1) return 'Safari';
            if (userAgent.indexOf('MSIE') > -1 || userAgent.indexOf('Trident') > -1) return 'IE';
            
            return 'Unknown';
        }
        
        // ‰ΩøÁî® window.CONTRACT_ADDRESSESÔºàÁî± config.js Êèê‰æõÔºâÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®ÂàôÂàõÂª∫
        if (typeof window.CONTRACT_ADDRESSES === 'undefined') {
            window.CONTRACT_ADDRESSES = {
                rideOrder: localStorage.getItem('RIDE_ORDER_ADDRESS') || '',
                paymentEscrow: localStorage.getItem('PAYMENT_ESCROW_ADDRESS') || '',
                ratingSystem: localStorage.getItem('RATING_SYSTEM_ADDRESS') || '',
                userRegistry: localStorage.getItem('USER_REGISTRY_ADDRESS') || ''
            };
        }
        
        // ‰∏∫‰∫ÜÊñπ‰æøËÆøÈóÆÔºåÂàõÂª∫‰∏Ä‰∏™Êú¨Âú∞ÂºïÁî®
        const CONTRACT_ADDRESSES = window.CONTRACT_ADDRESSES;
        
        // ‰ªéÂêéÁ´ØAPIÂä†ËΩΩÂêàÁ∫¶Âú∞ÂùÄÔºà‰ºòÂÖàÔºâ
        async function loadContractAddresses() {
            const API_BASE_URL = window.API_BASE_URL || 'http://localhost:3000';
            
            // ËÆ∞ÂΩïÂΩìÂâçÂú∞ÂùÄÔºåÈÅøÂÖçÈáçÂ§çÂàùÂßãÂåñ
            const currentAddress = CONTRACT_ADDRESSES.rideOrder;
            let addressChanged = false;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/contracts/addresses`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const contracts = result.data;
                        
                        if (contracts.rideOrder && contracts.rideOrder.startsWith('0x') && contracts.rideOrder.length === 42) {
                            // Ê£ÄÊü•Âú∞ÂùÄÊòØÂê¶ÂèòÂåñ
                            if (currentAddress && currentAddress !== contracts.rideOrder) {
                                addressChanged = true;
                                console.warn('‚ö†Ô∏è Ê£ÄÊµãÂà∞ÂêàÁ∫¶Âú∞ÂùÄÂèòÂåñ:', currentAddress, '->', contracts.rideOrder);
                                console.warn('‚ö†Ô∏è ËøôÈÄöÂ∏∏ÂèëÁîüÂú®ÈáçÊñ∞ÈÉ®ÁΩ≤ÂêéÔºåÈ°µÈù¢ÈúÄË¶ÅÊâãÂä®Âà∑Êñ∞');
                            }
                            
                            CONTRACT_ADDRESSES.rideOrder = contracts.rideOrder;
                            CONTRACT_ADDRESSES.paymentEscrow = contracts.paymentEscrow || '';
                            CONTRACT_ADDRESSES.ratingSystem = contracts.ratingSystem || '';
                            CONTRACT_ADDRESSES.userRegistry = contracts.userRegistry || '';
                            
                            // Êõ¥Êñ∞ localStorageÔºàÂº∫Âà∂‰ΩøÁî®ÊúÄÊñ∞Âú∞ÂùÄÔºâ
                            localStorage.setItem('RIDE_ORDER_ADDRESS', contracts.rideOrder);
                            if (contracts.paymentEscrow) {
                                localStorage.setItem('PAYMENT_ESCROW_ADDRESS', contracts.paymentEscrow);
                            }
                            if (contracts.ratingSystem) {
                                localStorage.setItem('RATING_SYSTEM_ADDRESS', contracts.ratingSystem);
                            }
                            if (contracts.userRegistry) {
                                localStorage.setItem('USER_REGISTRY_ADDRESS', contracts.userRegistry);
                            }
                            
                            console.log('‚úì ‰ªéÂêéÁ´ØAPIÂä†ËΩΩÂêàÁ∫¶Âú∞ÂùÄ:', contracts.rideOrder);
                            
                            // Â¶ÇÊûúÂú∞ÂùÄÂèòÂåñÔºåËøîÂõûÁâπÊÆäÊ†áËÆ∞
                            return addressChanged ? 'changed' : true;
                        }
                    }
                }
            } catch (e) {
                console.log('Êó†Ê≥ï‰ªéÂêéÁ´ØAPIÂä†ËΩΩÂêàÁ∫¶Âú∞ÂùÄÔºåÂ∞Ü‰ΩøÁî® localStorage:', e.message);
            }
            return false;
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂Â∞ùËØï‰ªéÂêéÁ´ØAPIËé∑ÂèñÂêàÁ∫¶Âú∞ÂùÄ
        loadContractAddresses().catch(err => {
            console.warn('Âä†ËΩΩÂêàÁ∫¶Âú∞ÂùÄÂ§±Ë¥•:', err);
        });
        
        const TRUST_FLOW_RIDE_ABI = [
            "function getOrder(uint256 _orderId) external view returns (tuple(uint256 orderId, address passenger, address driver, tuple(int256 latitude, int256 longitude, string addressText) pickup, tuple(int256 latitude, int256 longitude, string addressText) destination, string category, string subCategory, uint256 estimatedFare, uint256 actualFare, uint8 status, uint8 rideStatus, uint256 createdAt, uint256 acceptedAt, uint256 pickedUpAt, uint256 completedAt, uint256 startTimestamp, uint256 endTimestamp, string ipfsHash, bool disputeOpened, bool disputeResolved, address disputeOpener, address disputeWinner, string disputeReason, uint256 disputeOpenedAt, uint256 disputeResolvedAt, string disputeResolutionDetail))",
            "function getPassengerOrders(address _passenger) external view returns (uint256[] memory)",
            "function getDriverOrders(address _driver) external view returns (uint256[] memory)",
            "function acceptOrder(uint256 _orderId) external",
            "function confirmPickup(uint256 _orderId) external",
            "function completeOrder(uint256 _orderId, uint256 _actualFare) external",
            "function acceptRide(uint256 _orderId) external",
            "function startRide(uint256 _orderId) external",
            "function completeRide(uint256 _orderId) external",
            "function getRideStatus(uint256 _orderId) external view returns (uint8)",
            "function getDisputeStatus(uint256 _orderId) external view returns (bool disputeOpened, string memory disputeReason, bool disputeResolved, address disputeOpener, address disputeWinner, uint256 disputeOpenedAt, uint256 disputeResolvedAt, string memory disputeResolutionDetail, uint8 rideStatus)",
            "function settle(uint256 _orderId) external",
            "function submitDispute(uint256 _orderId, string memory _reason) external",
            "function orders(uint256) external view returns (uint256 orderId, address passenger, address driver, uint8 status)",
            "function orderCount() external view returns (uint256)",
            "event OrderCreated(uint256 indexed orderId, address indexed passenger, int256 pickupLat, int256 pickupLng, int256 destLat, int256 destLng, string category, string subCategory, uint256 estimatedFare)",
            "event OrderAccepted(uint256 indexed orderId, address indexed driver)",
            "event PassengerPickedUp(uint256 indexed orderId, uint256 timestamp)",
            "event OrderCompleted(uint256 indexed orderId, uint256 actualFare, uint256 timestamp)",
            "event RideAccepted(uint256 indexed orderId, address indexed driver, uint256 timestamp)",
            "event RideStarted(uint256 indexed orderId, uint256 timestamp)",
            "event RideCompleted(uint256 indexed orderId, uint256 timestamp)",
            "event RideSettled(uint256 indexed orderId, uint256 timestamp)",
            "event DisputeOpened(uint256 indexed orderId, address indexed by, string reason, uint256 timestamp)",
            "event DisputeResolved(uint256 indexed orderId, address indexed winner, string detail, uint256 timestamp)"
        ];
        
        const TRUST_FLOW_USER_REGISTRY_ABI = [
            "function getUser(address _user) external view returns (tuple(address userAddress, uint8 userType, string name, string phoneHash, uint8 kycStatus, uint256 creditScore, uint256 totalRides, bool isBlacklisted, uint256 registeredAt, string ipfsProfile))",
            "function users(address) external view returns (address userAddress, uint8 userType, string name, string phoneHash, uint8 kycStatus, uint256 creditScore, uint256 totalRides, bool isBlacklisted, uint256 registeredAt, string ipfsProfile)"
        ];
        
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                alert(isZh ? 'ËØ∑ÂÆâË£ÖMetaMaskÈí±ÂåÖÔºÅ' : 'Please install MetaMask wallet!');
                return;
            }
            
            try {
                const btn = document.getElementById('connect-btn');
                btn.disabled = true;
                const connectingText = typeof i18n !== 'undefined' ? i18n.t('connecting') : 'Connecting...';
                btn.innerHTML = `<span class="loading"></span> ${connectingText}`;
                
                // Ê£ÄÊµãÊµèËßàÂô®
                const browser = detectBrowser();
                console.log('ÂΩìÂâçÊµèËßàÂô® / Current Browser:', browser);
                
                // ËØ∑Ê±ÇËøûÊé•ÔºàMetaMask‰ºöÊòæÁ§∫Ë¥¶Êà∑ÈÄâÊã©Ôºâ
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                if (!accounts || accounts.length === 0) {
                    const noAccountText = typeof i18n !== 'undefined' ? i18n.t('noAccountSelected') : 'No account selected';
                    throw new Error(noAccountText);
                }
                
                account = accounts[0];
                console.log('ËøûÊé•ÁöÑË¥¶Êà∑ / Connected Account:', account);
                
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                
                // Ê£ÄÊü•ÁΩëÁªú Chain ID
                try {
                    const network = await provider.getNetwork();
                    const currentChainId = typeof network.chainId === 'object' 
                        ? network.chainId.toNumber() 
                        : parseInt(network.chainId.toString(), 10);
                    const EXPECTED_CHAIN_ID = 1337;
                    
                    if (currentChainId !== EXPECTED_CHAIN_ID) {
                        console.warn(`‚ö†Ô∏è ÂΩìÂâç Chain ID ÊòØ ${currentChainId}Ôºå‰ΩÜÂ∫îËØ•ÊòØ ${EXPECTED_CHAIN_ID}`);
                        const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                        const errorMsg = isZh 
                            ? `‚ö†Ô∏è ÁΩëÁªú‰∏çÂåπÈÖçÔºÅ\n\nÂΩìÂâç Chain ID: ${currentChainId}\nÊúüÊúõ Chain ID: ${EXPECTED_CHAIN_ID} (Hardhat Local)\n\nÊòØÂê¶Ë¶ÅËá™Âä®ÂàáÊç¢Âà∞Êú¨Âú∞ Hardhat ÁΩëÁªúÔºü\n\nÁÇπÂáª"Á°ÆÂÆö"Ëá™Âä®Ê∑ªÂä†Âπ∂ÂàáÊç¢ÁΩëÁªú\nÁÇπÂáª"ÂèñÊ∂à"ÊâãÂä®Âú® MetaMask ‰∏≠ÈÖçÁΩÆ`
                            : `‚ö†Ô∏è Network Mismatch!\n\nCurrent Chain ID: ${currentChainId}\nExpected Chain ID: ${EXPECTED_CHAIN_ID} (Hardhat Local)\n\nDo you want to automatically switch to Hardhat local network?\n\nClick "OK" to auto-add and switch network\nClick "Cancel" to manually configure in MetaMask`;
                        
                        const userWantsToSwitch = confirm(errorMsg);
                        
                        if (userWantsToSwitch) {
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: '0x539',
                                        chainName: 'Hardhat Localhost',
                                        nativeCurrency: {
                                            name: 'ETH',
                                            symbol: 'ETH',
                                            decimals: 18
                                        },
                                        rpcUrls: ['http://127.0.0.1:8545'],
                                        blockExplorerUrls: null
                                    }]
                                });
                                
                                // ÂàáÊç¢ÁΩëÁªú
                                await window.ethereum.request({
                                    method: 'wallet_switchEthereumChain',
                                    params: [{ chainId: '0x539' }]
                                });
                                
                                const successMsg = isZh 
                                    ? '‚úÖ ÁΩëÁªúÂ∑≤ÂàáÊç¢ÔºåÈ°µÈù¢Â∞ÜËá™Âä®Âà∑Êñ∞...'
                                    : '‚úÖ Network switched, page will reload...';
                                alert(successMsg);
                                location.reload();
                            } catch (networkError) {
                                const failMsg = isZh
                                    ? `‚ùå ÂàáÊç¢ÁΩëÁªúÂ§±Ë¥•: ${networkError.message}\n\nËØ∑ÊâãÂä®Âú® MetaMask ‰∏≠Ê∑ªÂä†ÁΩëÁªúÔºö\n\nÁΩëÁªúÂêçÁß∞: Hardhat Localhost\nRPC URL: http://127.0.0.1:8545\nChain ID: 1337\nË¥ßÂ∏ÅÁ¨¶Âè∑: ETH`
                                    : `‚ùå Failed to switch network: ${networkError.message}\n\nPlease manually add network in MetaMask:\n\nNetwork Name: Hardhat Localhost\nRPC URL: http://127.0.0.1:8545\nChain ID: 1337\nCurrency Symbol: ETH`;
                                alert(failMsg);
                                btn.disabled = false;
                                btn.textContent = isZh ? 'ËøûÊé•Èí±ÂåÖ' : 'Connect Wallet';
                                return;
                            }
                        } else {
                            btn.disabled = false;
                            btn.textContent = isZh ? 'ËøûÊé•Èí±ÂåÖ' : 'Connect Wallet';
                            return;
                        }
                    }
                } catch (networkCheckError) {
                    console.warn('ÁΩëÁªúÊ£ÄÊü•Â§±Ë¥•:', networkCheckError);
                }
                
                // ÂàùÂßãÂåñÂêàÁ∫¶
                if (CONTRACT_ADDRESSES.rideOrder) {
                    contracts.rideOrder = new ethers.Contract(
                        CONTRACT_ADDRESSES.rideOrder,
                        TRUST_FLOW_RIDE_ABI,
                        signer
                    );
                } else {
                    const promptMsg = 'ËØ∑ËæìÂÖ• TrustFlowRide ÂêàÁ∫¶Âú∞ÂùÄ:\n\n' +
                        '‚ö†Ô∏è ÈáçË¶ÅÊèêÁ§∫ / Important:\n' +
                        'ÊâÄÊúâÂè∏Êú∫Âíå‰πòÂÆ¢ÂøÖÈ°ª‰ΩøÁî®Âêå‰∏Ä‰∏™ÂêàÁ∫¶Âú∞ÂùÄÔºÅ\n' +
                        'All drivers and passengers must use the SAME contract address!\n\n' +
                        'Enter TrustFlowRide contract address:';
                    const addr = prompt(promptMsg, '');
                    if (addr && addr.trim().length === 42) {
                        CONTRACT_ADDRESSES.rideOrder = addr.trim();
                        window.CONTRACT_ADDRESSES.rideOrder = addr.trim(); // ÂêåÊ≠•Âà∞ window
                        localStorage.setItem('RIDE_ORDER_ADDRESS', addr.trim());
                        contracts.rideOrder = new ethers.Contract(addr.trim(), TRUST_FLOW_RIDE_ABI, signer);
                    } else {
                        alert('ÂêàÁ∫¶Âú∞ÂùÄÊ†ºÂºèÈîôËØØÔºÅ\n\nÊ≠£Á°ÆÁöÑÂú∞ÂùÄÊ†ºÂºèÔºö\n- ÂøÖÈ°ª‰ª• 0x ÂºÄÂ§¥\n- ÊÄªÈïøÂ∫¶‰∏∫ 42 ‰∏™Â≠óÁ¨¶\n\nÁ§∫‰æãÔºö0x5FbDB2315678afecb367f032d93F642f64180aa3');
                        btn.disabled = false;
                        btn.textContent = 'ËøûÊé•Èí±ÂåÖ / Connect Wallet';
                        return;
                    }
                }
                
                // ÂàùÂßãÂåñUserRegistryÂêàÁ∫¶ÔºàÂ¶ÇÊûúÂú∞ÂùÄÂ≠òÂú®Ôºâ
                if (CONTRACT_ADDRESSES.userRegistry) {
                    contracts.userRegistry = new ethers.Contract(
                        CONTRACT_ADDRESSES.userRegistry,
                        TRUST_FLOW_USER_REGISTRY_ABI,
                        signer
                    );
                } else {
                    // Â∞ùËØï‰ªéÈÉ®ÁΩ≤Êñá‰ª∂Âä†ËΩΩ
                    try {
                        const response = await fetch('/deployments/localhost-latest.json');
                        if (response.ok) {
                            const contentType = response.headers.get('content-type');
                            if (contentType && contentType.includes('application/json')) {
                                const deployment = await response.json();
                                if (deployment.contracts && deployment.contracts.userRegistry) {
                                    CONTRACT_ADDRESSES.userRegistry = deployment.contracts.userRegistry;
                                    window.CONTRACT_ADDRESSES.userRegistry = deployment.contracts.userRegistry;
                                    localStorage.setItem('USER_REGISTRY_ADDRESS', deployment.contracts.userRegistry);
                                    contracts.userRegistry = new ethers.Contract(
                                        deployment.contracts.userRegistry,
                                        TRUST_FLOW_USER_REGISTRY_ABI,
                                        signer
                                    );
                                }
                            } else {
                                console.warn('UserRegistryÂú∞ÂùÄÊñá‰ª∂‰∏çÊòØÊúâÊïàÁöÑJSONÊ†ºÂºè');
                            }
                        }
                    } catch (error) {
                        // ÈùôÈªòÂ§±Ë¥•ÔºåUserRegistryÊòØÂèØÈÄâÁöÑ
                        console.warn('Êó†Ê≥ïÂä†ËΩΩUserRegistryÂú∞ÂùÄÔºàËøô‰∏ç‰ºöÂΩ±ÂìçÊ†∏ÂøÉÂäüËÉΩÔºâ:', error.message);
                    }
                }
                
                // ËøûÊé•ÊàêÂäüÂêéÈöêËóèwallet-statusÔºàÁä∂ÊÄÅÂ∑≤ÁßªÂà∞ËèúÂçï‰∏≠Ôºâ
                const walletStatusEl = document.getElementById('wallet-status');
                if (walletStatusEl) {
                    walletStatusEl.style.display = 'none';
                }
                
                // Êõ¥Êñ∞ËèúÂçï‰∏≠ÁöÑËøûÊé•Áä∂ÊÄÅ
                const i18nPrefixConnected = typeof i18n !== 'undefined' ? i18n : null;
                const connectedText = i18nPrefixConnected ? i18nPrefixConnected.t('connected') : 'Connected';
                const sidebarConnectionStatus = document.getElementById('sidebar-connection-status');
                const sidebarConnectionText = document.getElementById('sidebar-connection-text');
                if (sidebarConnectionStatus && sidebarConnectionText) {
                    sidebarConnectionStatus.style.display = 'block';
                    sidebarConnectionText.textContent = connectedText;
                }
                
                // Êõ¥Êñ∞Ë¥¶Êà∑‰ø°ÊÅØÔºàÂè™Âú®ProfileËßÜÂõæ‰∏≠ÊòæÁ§∫Ôºâ
                const accountInfoPanel = document.getElementById('account-info-panel');
                if (accountInfoPanel) {
                    document.getElementById('current-account-display').textContent = account;
                    // Ë¥¶Êà∑‰ø°ÊÅØÈù¢Êùø‰ºöÂú® Profile ËßÜÂõæ‰∏≠Ëá™Âä®ÊòæÁ§∫
                }
                
                // Êõ¥Êñ∞ËèúÂçï‰∏≠ÁöÑË¥¶Êà∑‰ø°ÊÅØ
                const sidebarAccountInfo = document.getElementById('sidebar-account-info');
                const sidebarAccountAddress = document.getElementById('sidebar-account-address');
                if (sidebarAccountInfo && sidebarAccountAddress) {
                    sidebarAccountInfo.style.display = 'block';
                    sidebarAccountAddress.textContent = account.substring(0, 6) + '...' + account.substring(38);
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÂ§ö‰∏™Ë¥¶Êà∑
                checkMultipleAccounts();
                
                // ÊòæÁ§∫Âè∏Êú∫ÁïåÈù¢ÂíåÂ∫ïÈÉ®ÂØºËà™
                const driverInterface = document.getElementById('driver-interface');
                const bottomNav = document.getElementById('bottom-nav');
                if (driverInterface) {
                    driverInterface.style.display = 'block';
                }
                if (bottomNav) {
                    bottomNav.style.display = 'block';
                }
                
                // Êõ¥Êñ∞‰∏ªÊ†áÈ¢ò‰∏∫ÈªòËÆ§ËßÜÂõæÔºàAvailable OrdersÔºâ
                updateMainHeader('availableOrdersTitle', 'availableOrdersSubtitle');
                
                // Âä†ËΩΩËÆ¢Âçï
                await loadAvailableOrders();
                
                // ÁõëÂê¨Êñ∞ËÆ¢Âçï
                listenForNewOrders();
                
                // Âä†ËΩΩProfile‰ø°ÊÅØ
                loadProfile();
                
                // ÂêØÂä®ËÆ¢ÂçïÁä∂ÊÄÅËá™Âä®Âà∑Êñ∞
                if (typeof window.startDriverOrderAutoRefresh === 'function') {
                    window.startDriverOrderAutoRefresh();
                }
                
            } catch (error) {
                console.error('ËøûÊé•Â§±Ë¥•:', error);
                const isZhError = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                const errorText = typeof i18n !== 'undefined' ? i18n.t('walletConnectError') : 'Connection failed:';
                alert(`${errorText} ${error.message}`);
                document.getElementById('connect-btn').disabled = false;
                const connectBtnText = typeof i18n !== 'undefined' ? i18n.t('connectWallet') : 'Connect Wallet';
                document.getElementById('connect-btn').textContent = connectBtnText;
            }
        }
        
        // Èò≤Èó™ÁÉÅÊú∫Âà∂
        let isLoadingAvailableOrders = false;
        let lastAvailableOrdersData = null;
        let isLoadingMyOrders = false;
        let lastMyOrdersData = null;

        // Èò≤Ê≠¢ÈáçÂ§çÈáçÊñ∞Âä†ËΩΩÂêàÁ∫¶Âú∞ÂùÄÁöÑÊ†áÂøó
        let isReloadingContractAddress = false;
        
        // ËøûÊé•ÈîôËØØÂ§ÑÁêÜÔºöËÆ∞ÂΩïËøûÁª≠Â§±Ë¥•Ê¨°Êï∞ÂíåÊúÄÂêéÈîôËØØÊó∂Èó¥
        let apiConnectionFailures = 0;
        let lastApiErrorTime = null;
        const MAX_CONSECUTIVE_FAILURES = 3; // ËøûÁª≠Â§±Ë¥•3Ê¨°ÂêéÔºåÂ¢ûÂä†ÈáçËØïÈó¥Èöî
        const BACKOFF_MULTIPLIER = 2; // ÈÄÄÈÅøÂÄçÊï∞
        const BASE_RETRY_DELAY = 10000; // Âü∫Á°ÄÈáçËØïÂª∂ËøüÔºà10ÁßíÔºâ
        
        async function loadAvailableOrders(showLoading = true) {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ËøûÊé•Èí±ÂåÖ
            if (!account) {
                const container = document.getElementById('available-orders-container');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h2>ÈîôËØØ</h2>
                            <p>ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ</p>
                        </div>
                    `;
                }
                return;
            }
            
            // Èò≤Ê≠¢Âπ∂ÂèëÂä†ËΩΩ
            if (isLoadingAvailableOrders) {
                console.log('‚è∏Ô∏è ÂèØÁî®ËÆ¢ÂçïÊ≠£Âú®Âä†ËΩΩ‰∏≠ÔºåË∑≥ËøáÊú¨Ê¨°ËØ∑Ê±Ç');
                return;
            }
            
            isLoadingAvailableOrders = true;
            
            const container = document.getElementById('available-orders-container');
            const loadingState = document.getElementById('available-orders-loading');
            const emptyState = document.getElementById('available-orders-empty');
            
            // Âè™Âú®È¶ñÊ¨°Âä†ËΩΩÊàñÊòéÁ°ÆÈúÄË¶ÅÊó∂ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            if (showLoading && (!lastAvailableOrdersData || lastAvailableOrdersData.length === 0)) {
                if (loadingState) loadingState.style.display = 'block';
                if (emptyState) emptyState.style.display = 'none';
            }
            
            try {
                // ‰ªéÂêéÁ´Ø API Ëé∑ÂèñËÆ¢ÂçïÔºàÁªü‰∏ÄËé∑ÂèñÔºå‰øùËØÅÂÆåÂ§áÊÄß„ÄÅÂéüÂ≠êÊÄß„ÄÅÁªü‰∏ÄÊÄßÂíå‰∫ãÂä°ÊÄßÔºâ
                const API_BASE_URL = window.API_BASE_URL || 'http://localhost:3000';
                const forceRefresh = showLoading ? 'false' : 'false'; // ÂèØ‰ª•Ê†πÊçÆÈúÄË¶ÅÊéßÂà∂ÊòØÂê¶Âº∫Âà∂Âà∑Êñ∞
                
                // Âè™Âú®ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅÊó∂ËæìÂá∫Êó•ÂøóÔºåÂáèÂ∞ëÊó•ÂøóÂô™Èü≥
                if (showLoading) {
                    console.log(`[loadAvailableOrders] ‰ªéÂêéÁ´ØAPIËé∑ÂèñËÆ¢Âçï: ${API_BASE_URL}/api/available-orders?driver=${account}`);
                }
                
                // Ê∑ªÂä†Ë∂ÖÊó∂ÊéßÂà∂Ôºà10ÁßíÔºâ
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                let response;
                try {
                    response = await fetch(`${API_BASE_URL}/api/available-orders?driver=${encodeURIComponent(account)}&forceRefresh=${forceRefresh}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    
                    // ËøûÊé•ÊàêÂäüÔºåÈáçÁΩÆÂ§±Ë¥•ËÆ°Êï∞
                    if (apiConnectionFailures > 0) {
                        console.log('‚úÖ ÂêéÁ´ØAPIËøûÊé•Â∑≤ÊÅ¢Â§ç');
                        apiConnectionFailures = 0;
                        lastApiErrorTime = null;
                    }
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    
                    // Â§ÑÁêÜËøûÊé•ÈîôËØØ
                    if (fetchError.name === 'AbortError') {
                        throw new Error('ËØ∑Ê±ÇË∂ÖÊó∂ÔºöÂêéÁ´ØÊúçÂä°Âô®ÂìçÂ∫îÊó∂Èó¥ËøáÈïø');
                    } else if (fetchError.message?.includes('Failed to fetch') || fetchError.message?.includes('ERR_CONNECTION_REFUSED')) {
                        apiConnectionFailures++;
                        lastApiErrorTime = Date.now();
                        
                        // Â¶ÇÊûúÊòØËá™Âä®Âà∑Êñ∞‰∏îËøûÁª≠Â§±Ë¥•Ôºå‰∏çÊòæÁ§∫ÈîôËØØÔºàÈÅøÂÖçÂà∑Â±èÔºâ
                        if (!showLoading && apiConnectionFailures >= MAX_CONSECUTIVE_FAILURES) {
                            const backoffDelay = BASE_RETRY_DELAY * Math.pow(BACKOFF_MULTIPLIER, Math.min(apiConnectionFailures - MAX_CONSECUTIVE_FAILURES, 3));
                            const timeSinceLastError = lastApiErrorTime ? Date.now() - lastApiErrorTime : 0;
                            
                            if (timeSinceLastError < backoffDelay) {
                                console.warn(`‚ö†Ô∏è ÂêéÁ´ØAPIËøûÊé•Â§±Ë¥•ÔºàËøûÁª≠${apiConnectionFailures}Ê¨°ÔºâÔºåÂ∞ÜÂú®${Math.ceil((backoffDelay - timeSinceLastError) / 1000)}ÁßíÂêéÈáçËØï`);
                                throw fetchError; // ÈùôÈªòÂ§±Ë¥•Ôºå‰∏çÊòæÁ§∫ÈîôËØØ
                            }
                        }
                        
                        throw new Error('Êó†Ê≥ïËøûÊé•Âà∞ÂêéÁ´ØÊúçÂä°Âô®ÔºåËØ∑Ê£ÄÊü•ÊúçÂä°Âô®ÊòØÂê¶ËøêË°å');
                    } else {
                        throw fetchError;
                    }
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Ëé∑ÂèñËÆ¢ÂçïÂ§±Ë¥•');
                }
                
                const pendingOrders = result.data || [];
                console.log(`[loadAvailableOrders] ‰ªéÂêéÁ´ØËé∑ÂèñÂà∞ ${pendingOrders.length} ‰∏™ÂèØÁî®ËÆ¢Âçï`);
                
                // ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
                if (loadingState) loadingState.style.display = 'none';
                
                // Â§ÑÁêÜÁ©∫ËÆ¢ÂçïÂàóË°®
                if (pendingOrders.length === 0) {
                    if (emptyState) {
                        emptyState.style.display = 'block';
                    } else {
                        const i18nPrefix = typeof i18n !== 'undefined' ? i18n : null;
                        if (container) {
                            container.innerHTML = `
                                <div class="empty-state">
                                    <h2>${i18nPrefix ? i18nPrefix.t('noAvailableOrders') : 'No available orders'}</h2>
                                    <p>${i18nPrefix ? i18nPrefix.t('noAvailableOrdersHint') : 'Orders will appear here when passengers create them'}</p>
                                </div>
                            `;
                        }
                    }
                    lastAvailableOrdersData = [];
                    isLoadingAvailableOrders = false;
                    return;
                }
                
                // ÈöêËóèÁ©∫Áä∂ÊÄÅ
                if (emptyState) emptyState.style.display = 'none';
                
                // Ê£ÄÊü•Êï∞ÊçÆÊòØÂê¶ÁúüÁöÑÂèòÂåñ‰∫ÜÔºàÈÅøÂÖç‰∏çÂøÖË¶ÅÁöÑÈáçÊñ∞Ê∏≤ÊüìÔºâ
                const currentOrdersKey = JSON.stringify(pendingOrders.map(o => ({
                    orderId: o.orderId,
                    passenger: o.passenger,
                    estimatedFare: o.estimatedFare
                })));
                const lastOrdersKey = lastAvailableOrdersData ? JSON.stringify(lastAvailableOrdersData.map(o => ({
                    orderId: o.orderId,
                    passenger: o.passenger,
                    estimatedFare: o.estimatedFare
                }))) : null;
                
                // Â¶ÇÊûúÊï∞ÊçÆÊ≤°ÊúâÂèòÂåñ‰∏îÈÉΩÊúâÊï∞ÊçÆÔºåË∑≥ËøáÈáçÊñ∞Ê∏≤ÊüìÔºà‰∏çÊ∏ÖÁ©∫ÂÆπÂô®Ôºâ
                if (currentOrdersKey === lastOrdersKey && lastAvailableOrdersData && lastAvailableOrdersData.length > 0 && pendingOrders.length > 0) {
                    console.log('üìä ÂèØÁî®ËÆ¢ÂçïÊï∞ÊçÆÊú™ÂèòÂåñÔºåË∑≥ËøáÈáçÊñ∞Ê∏≤Êüì');
                    isLoadingAvailableOrders = false;
                    if (loadingState) loadingState.style.display = 'none';
                    return;
                }
                
                // Âè™ÊúâÂú®Êï∞ÊçÆÂèòÂåñÊó∂ÊâçÊ∏ÖÁ©∫ÂÆπÂô®Âπ∂ÈáçÊñ∞Ê∏≤Êüì
                if (container) {
                    container.innerHTML = '';
                }
                
                lastAvailableOrdersData = pendingOrders;
                
                // ÊâπÈáèËé∑Âèñ‰πòÂÆ¢‰ø°ÊÅØÔºà‰ªéÂêéÁ´ØAPIËé∑ÂèñÔºâ
                const passengerInfoMap = new Map();
                try {
                    const uniquePassengers = [...new Set(pendingOrders.map(o => o.passenger))];
                    if (uniquePassengers.length > 0) {
                        const API_BASE_URL = window.API_BASE_URL || 'http://localhost:3000';
                        const userInfoResponse = await fetch(`${API_BASE_URL}/api/user-info/batch`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ addresses: uniquePassengers })
                        });
                        
                        if (userInfoResponse.ok) {
                            const result = await userInfoResponse.json();
                            if (result.success && result.data) {
                                // Â∞ÜÂú∞ÂùÄÊò†Â∞ÑÂà∞ËÆ¢Âçï
                                pendingOrders.forEach(order => {
                                    const userInfo = result.data[order.passenger] || { id: null, nickname: null, contact: null };
                                    passengerInfoMap.set(order.passenger.toLowerCase(), {
                                        nickname: userInfo.nickname || null,
                                        contact: userInfo.contact || null
                                    });
                                });
                            }
                        }
                    }
                } catch (error) {
                    console.error('ÊâπÈáèËé∑Âèñ‰πòÂÆ¢‰ø°ÊÅØÂ§±Ë¥•:', error);
                }
                
                // Ê∏≤ÊüìËÆ¢ÂçïÂàóË°®ÔºàÂÆπÂô®Â∑≤Âú®Êï∞ÊçÆÂèòÂåñÊ£ÄÊü•ÂêéÊ∏ÖÁ©∫Ôºâ
                // Ê∏≤ÊüìËÆ¢ÂçïÂàóË°®
                const i18nPrefix = typeof i18n !== 'undefined' ? i18n : null;
                const ETH_TO_USD_RATE = 2500;
                const PLATFORM_FEE_RATE = 0.05;
                const isZhOrder = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                
                // ÂêéÁ´ØËøîÂõûÁöÑÊï∞ÊçÆÊ†ºÂºèÂ∑≤ÁªèÊòØÊ†áÂáÜÂåñÁöÑÔºåÁõ¥Êé•‰ΩøÁî®
                const ordersToRender = pendingOrders;
                
                container.innerHTML = '<div class="orders-grid">' + ordersToRender.map(order => {
                    // Ëé∑Âèñ‰πòÂÆ¢‰ø°ÊÅØ
                    const passengerInfo = passengerInfoMap.get(order.passenger.toLowerCase()) || { nickname: null, contact: null };
                    const passengerNickname = passengerInfo.nickname || null;
                    const passengerContact = passengerInfo.contact || null;
                    
                    // ‰πòÂÆ¢‰ø°ÊÅØÊòæÁ§∫HTML
                    const passengerInfoHtml = `
                        <div style="margin-bottom: 12px; padding: 12px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 10px; border: 1px solid #bae6fd;">
                            <div style="font-size: 12px; font-weight: 700; color: #0369a1; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                                üë§ ${isZhOrder ? '‰πòÂÆ¢‰ø°ÊÅØ / Passenger Info' : 'Passenger Info'}
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                                ${passengerNickname ? `
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 11px; color: #6b7280; font-weight: 500; min-width: 60px;">${isZhOrder ? 'ÊòµÁß∞ / Name' : 'Name'}:</span>
                                    <span style="font-size: 13px; font-weight: 600; color: #1e40af;">${passengerNickname}</span>
                                </div>
                                ` : ''}
                                ${passengerContact ? `
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 11px; color: #6b7280; font-weight: 500; min-width: 60px;">${isZhOrder ? 'ËÅîÁ≥ªÊñπÂºè / Contact' : 'Contact'}:</span>
                                    <span style="font-size: 12px; color: #6b7280;">${passengerContact}</span>
                                </div>
                                ` : ''}
                                <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                                    <span style="font-size: 11px; color: #6b7280; font-weight: 500; min-width: 60px;">${isZhOrder ? 'Âú∞ÂùÄ / Address' : 'Address'}:</span>
                                    <span onclick="copyToClipboard('${order.passenger}'); this.style.background='#e0e7ff'; setTimeout(()=>this.style.background='',300)" style="font-size: 11px; color: #1e40af; font-family: 'Monaco', 'Menlo', 'Courier New', monospace; cursor: pointer; padding: 2px 6px; border-radius: 4px; transition: background 0.2s;" title="${isZhOrder ? 'ÁÇπÂáªÂ§çÂà∂ / Click to copy' : 'Click to copy'}">
                                        ${order.passenger.substring(0, 6)}...${order.passenger.substring(38)}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // ËÆ°ÁÆóË¥πÁî®ÊòéÁªÜÔºàÂêéÁ´ØËøîÂõûÁöÑÊï∞ÊçÆÂ∑≤ÁªèÊòØÊ†áÂáÜÂåñÁöÑÔºâ
                    const fareToDisplay = parseFloat(order.estimatedFare);
                    const fareUSD = (fareToDisplay * ETH_TO_USD_RATE).toFixed(2);
                    
                    // ËÆ°ÁÆóÈ¢Ñ‰º∞Ë¥πÁî®ÊòéÁªÜ
                    const platformFeeETH = (fareToDisplay * PLATFORM_FEE_RATE).toFixed(8);
                    const platformFeeUSD = (parseFloat(platformFeeETH) * ETH_TO_USD_RATE).toFixed(2);
                    
                    // ‰º∞ÁÆóGasË¥πÁî®
                    const acceptGasETH = '0.0001'; // Êé•ÂèóËÆ¢ÂçïÊó∂ÁöÑGasË¥πÁî®ÔºàÈ¢Ñ‰º∞Ôºâ
                    const completeGasETH = '0.0003'; // ÂÆåÊàêËÆ¢ÂçïÊó∂ÁöÑGasË¥πÁî®ÔºàÈ¢Ñ‰º∞Ôºâ
                    const totalGasETH = (parseFloat(acceptGasETH) + parseFloat(completeGasETH)).toFixed(8);
                    const acceptGasUSD = (parseFloat(acceptGasETH) * ETH_TO_USD_RATE).toFixed(2);
                    const completeGasUSD = (parseFloat(completeGasETH) * ETH_TO_USD_RATE).toFixed(2);
                    const totalGasUSD = (parseFloat(totalGasETH) * ETH_TO_USD_RATE).toFixed(2);
                    
                    // ËÆ°ÁÆóÈ¢Ñ‰º∞ÂáÄÊî∂Áõä
                    const netEarnedETH = (fareToDisplay - parseFloat(platformFeeETH) - parseFloat(totalGasETH)).toFixed(8);
                    const netEarnedUSD = (parseFloat(netEarnedETH) * ETH_TO_USD_RATE).toFixed(2);
                    
                    // ËÆ°ÁÆóÁôæÂàÜÊØîÔºàÂÆûÈôÖÊî∂Áõä / ËÆ¢ÂçïÈáëÈ¢ù * 100Ôºâ
                    const netPercentage = fareToDisplay > 0 ? ((parseFloat(netEarnedETH) / fareToDisplay) * 100).toFixed(1) : '0.0';
                    
                    // Ê£ÄÊü•ÊòØÂê¶Êúâ‰∫âËÆÆ
                    const hasDispute = order.disputeOpened || false;
                    
                    // Â§ÑÁêÜÂùêÊ†áÔºàÂêéÁ´ØËøîÂõûÁöÑÂ∑≤ÁªèÊòØÂ∞èÊï∞Ê†ºÂºèÔºâ
                    const pickupLat = order.pickup.latitude;
                    const pickupLng = order.pickup.longitude;
                    const destLat = order.destination.latitude;
                    const destLng = order.destination.longitude;
                    
                    // Â§ÑÁêÜÂàõÂª∫Êó∂Èó¥ÔºàÂêéÁ´ØËøîÂõûÁöÑÊòØÊó∂Èó¥Êà≥Ôºâ
                    const createdAt = order.createdAt ? new Date(order.createdAt * 1000) : new Date();
                    
                    return `
                    <div class="order-card${hasDispute ? ' disputed' : ''}">
                        <h3 style="font-size: 18px;">${i18nPrefix ? i18nPrefix.t('orderNumber', { orderId: order.orderId }) : `Order #${order.orderId}`}</h3>
                        ${passengerInfoHtml}
                        <div class="order-info" style="font-size: 14px;">
                            <strong>${i18nPrefix ? i18nPrefix.t('pickup') : 'Pickup:'}</strong><br>
                            ${order.pickup.addressText || `${pickupLat}, ${pickupLng}`}
                        </div>
                        <div class="order-info" style="font-size: 14px;">
                            <strong>${i18nPrefix ? i18nPrefix.t('destination') : 'Destination:'}</strong><br>
                            ${order.destination.addressText || `${destLat}, ${destLng}`}
                        </div>
                        <div class="order-fare" style="font-size: 15px; font-weight: 700; color: #1f2937; margin: 10px 0;">
                            ${fareToDisplay.toFixed(8)} ETH
                            <div style="font-size: 12px; color: #6b7280; font-weight: 400;">
                                ($${fareUSD} USDÔºå${i18nPrefix ? i18nPrefix.t('reference') : 'reference'})
                            </div>
                        </div>
                        
                        <!-- Ë¥πÁî®ÊòéÁªÜ -->
                        <div style="margin-top: 12px; padding: 16px; background: #ffffff; border-radius: 12px; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                            <div style="font-size: 12px; font-weight: 700; color: #374151; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #f3f4f6; padding-bottom: 8px;">
                                üí∞ ${isZhOrder ? 'È¢Ñ‰º∞Ë¥πÁî®ÊòéÁªÜ / Estimated Fee Breakdown' : 'Estimated Fee Breakdown'}
                            </div>
                            
                            <!-- ÊÄªË¥πÁî® -->
                            <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #f3f4f6;">
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px; font-weight: 500;">${isZhOrder ? 'È¢Ñ‰º∞ËÆ¢ÂçïÊÄªË¥πÁî® / Est. Total Order Amount' : 'Estimated Total Order Amount'}:</div>
                                <div style="font-size: 14px; font-weight: 700; color: #1f2937;">
                                    ${fareToDisplay.toFixed(8)} ETH <span style="color: #6b7280; font-weight: 500; font-size: 13px;">($${fareUSD} USD)</span>
                                </div>
                            </div>
                            
                            <!-- Âπ≥Âè∞Ë¥πÁî® -->
                            <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #f3f4f6;">
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px; font-weight: 500;">${isZhOrder ? 'Âπ≥Âè∞Ë¥πÁî® (5%) / Platform Fee' : 'Platform Fee (5%)'}:</div>
                                <div style="font-size: 13px; font-weight: 600; color: #dc2626;">
                                    -${platformFeeETH} ETH <span style="color: #6b7280; font-weight: 500; font-size: 12px;">(-$${platformFeeUSD} USD)</span>
                                </div>
                            </div>
                            
                            <!-- Êé•ÂèóËÆ¢ÂçïÊó∂ÁöÑGasË¥πÁî® -->
                            <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #f3f4f6;">
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px; font-weight: 500;">${isZhOrder ? 'Network Fee (Êé•ÂèóËÆ¢Âçï) / Network Fee (Accept Order)' : 'Network Fee (Accept Order)'}:</div>
                                <div style="font-size: 13px; font-weight: 600; color: #f59e0b;">
                                    -${acceptGasETH} ETH <span style="color: #6b7280; font-weight: 500; font-size: 12px;">(-$${acceptGasUSD} USD)</span>
                                </div>
                                <div style="font-size: 10px; color: #9ca3af; margin-top: 4px; font-style: italic;">
                                    ${isZhOrder ? 'Êé•ÂèóËÆ¢ÂçïÊó∂ÁöÑÁΩëÁªúË¥πÁî®Ôºà‰º∞ÁÆóÔºâ' : 'Estimated network fee for accepting order'}
                                </div>
                            </div>
                            
                            <!-- ÂÆåÊàêËÆ¢ÂçïÊó∂ÁöÑGasË¥πÁî® -->
                            <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #f3f4f6;">
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px; font-weight: 500;">${isZhOrder ? 'Network Fee (ÂÆåÊàêËÆ¢Âçï) / Network Fee (Complete Order)' : 'Network Fee (Complete Order)'}:</div>
                                <div style="font-size: 13px; font-weight: 600; color: #f59e0b;">
                                    -${completeGasETH} ETH <span style="color: #6b7280; font-weight: 500; font-size: 12px;">(-$${completeGasUSD} USD)</span>
                                </div>
                                <div style="font-size: 10px; color: #9ca3af; margin-top: 4px; font-style: italic;">
                                    ${isZhOrder ? 'ÂÆåÊàêËÆ¢ÂçïÊó∂ÁöÑÁΩëÁªúË¥πÁî®Ôºà‰º∞ÁÆóÔºâ' : 'Estimated network fee for completing order'}
                                </div>
                            </div>
                            
                            <!-- ÊÄªGasË¥πÁî® -->
                            <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #f3f4f6;">
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px; font-weight: 600;">${isZhOrder ? 'ÊÄªNetwork Fee / Total Network Fee' : 'Total Network Fee'}:</div>
                                <div style="font-size: 13px; font-weight: 700; color: #d97706;">
                                    -${totalGasETH} ETH <span style="color: #6b7280; font-weight: 500; font-size: 12px;">(-$${totalGasUSD} USD)</span>
                                </div>
                            </div>
                            
                            <!-- È¢Ñ‰º∞ÂáÄÊî∂Áõä -->
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid #e5e7eb; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-radius: 8px; padding: 12px;">
                                <div style="font-size: 11px; color: #374151; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;">
                                    ‚è≥ ${isZhOrder ? 'È¢Ñ‰º∞ÂáÄÊî∂Áõä / Estimated Net Income' : 'Estimated Net Income'}
                                </div>
                                <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 4px;">
                                    <div style="font-size: 18px; font-weight: 700; color: #059669;">
                                        ${parseFloat(netEarnedETH) > 0 ? netEarnedETH : '0.00000000'} ETH
                                    </div>
                                    <div style="font-size: 13px; font-weight: 600; color: #6b7280;">
                                        ($${netEarnedUSD} USD)
                                    </div>
                                </div>
                                <div style="margin-top: 6px; padding: 6px 10px; background: #ffffff; border-radius: 6px; border: 1px solid #e5e7eb;">
                                    <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">${isZhOrder ? 'Âç†ËÆ¢ÂçïÈáëÈ¢ùÊØî‰æã / Percentage of Order Amount' : 'Percentage of Order Amount'}:</div>
                                    <div style="font-size: 14px; font-weight: 700; color: #059669;">
                                        ${netPercentage}%
                                    </div>
                                </div>
                                <div style="font-size: 10px; color: #9ca3af; margin-top: 8px; line-height: 1.4;">
                                    ${isZhOrder ? 'ÊÄªË¥πÁî® - Âπ≥Âè∞Ë¥π - Network Fee (Êé•Âèó + ÂÆåÊàê)' : 'Total - Platform Fee - Network Fee (Accept + Complete)'}
                                </div>
                            </div>
                            <div style="font-size: 10px; color: #9ca3af; margin-top: 12px; padding-top: 12px; border-top: 1px solid #f3f4f6; font-style: italic; text-align: center;">
                                ${isZhOrder ? 'üí° ÂÆûÈôÖË¥πÁî®Â∞ÜÂú®ÂÆåÊàêËÆ¢ÂçïÂêéÁ°ÆÂÆö' : 'üí° Actual fees will be determined after order completion'}
                            </div>
                        </div>
                        
                        <div class="order-info" style="font-size: 13px; margin-top: 12px;">
                            <strong>${i18nPrefix ? i18nPrefix.t('category') : 'Category:'}</strong> ${order.category} - ${order.subCategory}
                        </div>
                        <div class="order-info" style="font-size: 12px; color: #9ca3af;">
                            ${i18nPrefix ? i18nPrefix.t('createdAtLabel') : 'Created:'} ${createdAt.toLocaleString()}
                        </div>
                        <button class="btn-accept" onclick="acceptOrder(${order.orderId})" title="${i18nPrefix ? i18nPrefix.t('currentAccount') : 'Current Account:'} ${account.substring(0, 6)}...${account.substring(38)}">
                            üöó ${i18nPrefix ? i18nPrefix.t('acceptOrder') : 'Accept Order'}
                        </button>
                    </div>
                    `;
                }).join('') + '</div>';
                
            } catch (error) {
                // Ê£ÄÊü•ÊòØÂê¶ÊòØËøûÊé•ÈîôËØØ
                const isConnectionError = error.message?.includes('ERR_CONNECTION_REFUSED') || 
                                         error.message?.includes('Failed to fetch') ||
                                         error.message?.includes('Êó†Ê≥ïËøûÊé•Âà∞ÂêéÁ´ØÊúçÂä°Âô®') ||
                                         error.name === 'TypeError' && error.message?.includes('fetch');
                
                // Â¶ÇÊûúÊòØËøûÊé•ÈîôËØØÔºåÊ£ÄÊü•ÂÆπÂô®‰∏≠ÊòØÂê¶Â∑≤ÊúâËÆ¢Âçï
                const hasExistingOrders = container && container.querySelector('.order-card, .orders-grid');
                
                // Â¶ÇÊûúÊòØËøûÊé•ÈîôËØØ‰∏îÂÆπÂô®‰∏≠Â∑≤ÊúâËÆ¢ÂçïÔºå‰∏çÊ∏ÖÁ©∫ÂÆπÂô®
                if (isConnectionError && hasExistingOrders) {
                    console.warn('‚ö†Ô∏è ÂêéÁ´ØAPIËøûÊé•Â§±Ë¥•Ôºå‰øùÁïôÁé∞ÊúâËÆ¢ÂçïÊòæÁ§∫:', error.message);
                    isLoadingAvailableOrders = false;
                    if (loadingState) loadingState.style.display = 'none';
                    return; // ‰∏çÊ∏ÖÁ©∫ÂÆπÂô®Ôºå‰øùÁïôÁé∞ÊúâËÆ¢Âçï
                }
                
                // Â¶ÇÊûúÊòØËá™Âä®Âà∑Êñ∞‰∏îËøûÁª≠Â§±Ë¥•Â§öÊ¨°ÔºåÈùôÈªòÂ§ÑÁêÜÔºà‰∏çÊ∏ÖÁ©∫Áé∞ÊúâËÆ¢ÂçïÔºâ
                if (!showLoading && apiConnectionFailures >= MAX_CONSECUTIVE_FAILURES) {
                    console.warn('‚ö†Ô∏è Ëá™Âä®Âà∑Êñ∞Â§±Ë¥•ÔºàÂêéÁ´ØÊúçÂä°Âô®ÂèØËÉΩ‰∏çÂèØÁî®ÔºâÔºå‰øùÁïôÁé∞ÊúâËÆ¢ÂçïÊòæÁ§∫');
                    isLoadingAvailableOrders = false;
                    if (loadingState) loadingState.style.display = 'none';
                    return; // ÈùôÈªòÂ§±Ë¥•Ôºå‰∏çÊ∏ÖÁ©∫ÂÆπÂô®
                }
                
                console.error('Âä†ËΩΩËÆ¢ÂçïÂ§±Ë¥•:', error);
                if (loadingState) loadingState.style.display = 'none';
                
                let errorMessage = error.message || 'Êú™Áü•ÈîôËØØ';
                
                // Âè™Âú®È¶ñÊ¨°Âä†ËΩΩÊàñÊâãÂä®Âà∑Êñ∞Êó∂ÊòæÁ§∫ÈîôËØØÔºà‰∏îÂÆπÂô®‰∏∫Á©∫Êó∂Ôºâ
                if (showLoading && container && !hasExistingOrders) {
                    const i18nPrefix = typeof i18n !== 'undefined' ? i18n : null;
                    container.innerHTML = `
                        <div class="empty-state">
                            <h2 style="color: var(--error-color);">‚ùå ${i18nPrefix ? i18nPrefix.t('loadingOrdersFailed') : 'Failed to load orders'}</h2>
                            <p style="color: #6b7280; margin: 10px 0;">${errorMessage}</p>
                            <p style="color: #9ca3af; font-size: 12px; margin: 5px 0;">ÊèêÁ§∫ÔºöÂ¶ÇÊûúÂêéÁ´ØÊúçÂä°Âô®Ê≠£Âú®ÈáçÂêØÔºåËØ∑Á®çÂÄôÁâáÂàªÂêéÂà∑Êñ∞È°µÈù¢</p>
                            <button onclick="location.reload()" style="margin-top: 15px; padding: 10px 20px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                ${i18nPrefix ? i18nPrefix.t('refreshPage') : 'Refresh Page'}
                            </button>
                        </div>
                    `;
                } else if (!hasExistingOrders) {
                    // Ëá™Âä®Âà∑Êñ∞Â§±Ë¥•Êó∂ÔºåÂè™ËÆ∞ÂΩïÊó•ÂøóÔºå‰∏çÊ∏ÖÁ©∫ÂÆπÂô®
                    console.warn('‚ö†Ô∏è Ëá™Âä®Âà∑Êñ∞ËÆ¢ÂçïÂ§±Ë¥•ÔºàÂèØËÉΩÊòØÂêéÁ´ØÊúçÂä°Âô®ÊöÇÊó∂‰∏çÂèØÁî®Ôºâ:', errorMessage);
                } else {
                    // ÂÆπÂô®‰∏≠Â∑≤ÊúâËÆ¢ÂçïÔºåËøûÊé•Â§±Ë¥•Êó∂‰∏çÊ∏ÖÁ©∫
                    console.warn('‚ö†Ô∏è ÂêéÁ´ØAPIËøûÊé•Â§±Ë¥•Ôºå‰øùÁïôÁé∞ÊúâËÆ¢ÂçïÊòæÁ§∫:', errorMessage);
                }
            } finally {
                isLoadingAvailableOrders = false;
                if (loadingState) loadingState.style.display = 'none';
            }
        }
        
        async function acceptOrder(orderId) {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üöó acceptOrder is clicked - ËÆ¢Âçï ID:', orderId);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            if (!contracts.rideOrder) {
                console.error('‚ùå ÂêàÁ∫¶Êú™ÂàùÂßãÂåñÔºÅ');
                alert('ÂêàÁ∫¶Êú™ÂàùÂßãÂåñÔºÅ');
                return;
            }
            
            const i18nPrefix = typeof i18n !== 'undefined' ? i18n : null;
            const ETH_TO_USD_RATE = 2500;
            const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
            
            try {
                // Ê£ÄÊü•ÂêàÁ∫¶ÁöÑ orderCount
                try {
                    const orderCount = await contracts.rideOrder.orderCount();
                    console.log('üìä ÂêàÁ∫¶‰∏≠ÁöÑ orderCount:', orderCount.toString());
                    console.log('üìä ÊúâÊïàÁöÑËÆ¢ÂçïIDËåÉÂõ¥: 0 Âà∞', orderCount.sub(1).toString());
                    
                    // Ê£ÄÊü•ËÆ¢ÂçïIDÊòØÂê¶Âú®ÊúâÊïàËåÉÂõ¥ÂÜÖ
                    const orderIdBN = ethers.BigNumber.from(orderId);
                    if (orderIdBN.gte(orderCount)) {
                        const errorMsg = isZh 
                            ? `ËÆ¢Âçï #${orderId} ‰∏çÂ≠òÂú®ÔºÅ\n\nÂêàÁ∫¶‰∏≠ÁöÑ orderCount: ${orderCount.toString()}\nÊúâÊïàËÆ¢ÂçïIDËåÉÂõ¥: 0 Âà∞ ${orderCount.sub(1).toString()}\n\nËØ∑Âà∑Êñ∞ËÆ¢ÂçïÂàóË°®Ëé∑ÂèñÊúÄÊñ∞ËÆ¢Âçï„ÄÇ`
                            : `Order #${orderId} does not exist!\n\nContract orderCount: ${orderCount.toString()}\nValid order ID range: 0 to ${orderCount.sub(1).toString()}\n\nPlease refresh the order list to get the latest orders.`;
                        console.error('‚ùå', errorMsg);
                        alert(errorMsg);
                        return;
                    }
                } catch (countError) {
                    console.warn('‚ö†Ô∏è Êó†Ê≥ïËé∑Âèñ orderCount:', countError);
                }
                
                // È¶ñÂÖàÈ™åËØÅËÆ¢ÂçïÊòØÂê¶Â≠òÂú®
                let order;
                try {
                    console.log('üìã Ê≠£Âú®Ëé∑ÂèñËÆ¢Âçï‰ø°ÊÅØÔºåËÆ¢ÂçïID:', orderId);
                    order = await contracts.rideOrder.getOrder(orderId);
                    console.log('‚úÖ ËÆ¢ÂçïÂ≠òÂú®:', {
                        orderId: order.orderId.toString(),
                        status: order.status,
                        rideStatus: order.rideStatus,
                        passenger: order.passenger,
                        driver: order.driver ? order.driver : 'Êú™ÂàÜÈÖç'
                    });
                } catch (getOrderError) {
                    console.error('‚ùå Ëé∑ÂèñËÆ¢ÂçïÂ§±Ë¥•:', getOrderError);
                    // Â¶ÇÊûúËÆ¢Âçï‰∏çÂ≠òÂú®ÔºåÁªôÂá∫ÂèãÂ•ΩÁöÑÈîôËØØÊèêÁ§∫
                    if (getOrderError.reason && getOrderError.reason.includes('Order does not exist')) {
                        const errorMsg = isZh 
                            ? `ËÆ¢Âçï #${orderId} ‰∏çÂ≠òÂú®„ÄÇ\n\nÂèØËÉΩÁöÑÂéüÂõ†Ôºö\n1. ËÆ¢ÂçïID‰∏çÊ≠£Á°Æ\n2. ËÆ¢ÂçïÂ∑≤Ë¢´ÂèñÊ∂àÊàñÂà†Èô§\n3. ËÆ¢ÂçïÂ∞öÊú™ÂàõÂª∫\n\nËØ∑Âà∑Êñ∞ËÆ¢ÂçïÂàóË°®Ëé∑ÂèñÊúÄÊñ∞ËÆ¢Âçï„ÄÇ`
                            : `Order #${orderId} does not exist.\n\nPossible reasons:\n1. Invalid order ID\n2. Order has been cancelled or deleted\n3. Order has not been created yet\n\nPlease refresh the order list to get the latest orders.`;
                        console.error('‚ùå', errorMsg);
                        alert(errorMsg);
                        return;
                    }
                    throw getOrderError;
                }
                
                const estimatedFareETH = parseFloat(ethers.utils.formatEther(order.estimatedFare)).toFixed(8);
                const estimatedFareUSD = (parseFloat(estimatedFareETH) * ETH_TO_USD_RATE).toFixed(2);
                
                // ‰º∞ÁÆóGasË¥πÁî®ÔºàÊé•ÂçïÈÄöÂ∏∏ÈúÄË¶ÅÁ∫¶0.0001 ETHÔºâ
                let gasEstimate = '';
                let gasCostETH = '';
                let gasCostUSD = '';
                try {
                    const estimatedGas = await contracts.rideOrder.estimateGas.acceptOrder(orderId);
                    const gasPrice = await provider.getGasPrice();
                    const gasCostWei = estimatedGas.mul(gasPrice);
                    const gasCostEthValue = ethers.utils.formatEther(gasCostWei);
                    gasCostETH = parseFloat(gasCostEthValue) < 0.0001 ? '< 0.0001' : parseFloat(gasCostEthValue).toFixed(8);
                    gasCostUSD = (parseFloat(gasCostEthValue) * ETH_TO_USD_RATE).toFixed(2);
                    gasEstimate = `${estimatedGas.toString()} gas`;
                } catch (error) {
                    console.warn('Êó†Ê≥ï‰º∞ÁÆó Gas:', error);
                    gasEstimate = 'Á∫¶ 50,000 - 80,000 gas';
                    gasCostETH = 'Á∫¶ 0.0001 ETH';
                    gasCostUSD = 'Á∫¶ $0.25 USD';
                }
                
                const confirmText = i18nPrefix ? i18nPrefix.t('acceptOrderConfirm', { orderId }) : `Confirm accepting order #${orderId}?`;
                const feeInfoText = isZh 
                    ? `\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüí∞ ËÆ¢ÂçïÊÄªÈ¢ù / Total Order Amount\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n${estimatedFareETH} ETH\n($${estimatedFareUSD} USD)\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚õΩ È¢Ñ‰º∞GasË¥πÁî® / Estimated Gas Fee\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n${gasCostETH} ETH ($${gasCostUSD} USD)\n\nÊ≥®ÔºöGasË¥πÁî®Â∞Ü‰ªéÊÇ®ÁöÑË¥¶Êà∑Êâ£Èô§ÔºåÁî®‰∫éÊâßË°åÊé•Âçï‰∫§Êòì„ÄÇ\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`
                    : `\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüí∞ Total Order Amount\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n${estimatedFareETH} ETH\n($${estimatedFareUSD} USD)\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚õΩ Estimated Gas Fee\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n${gasCostETH} ETH ($${gasCostUSD} USD)\n\nNote: Gas fee will be deducted from your account for executing the accept order transaction.\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;
                
                const confirmed = confirm(confirmText + feeInfoText);
                if (!confirmed) return;
                
                const btn = window.event?.target || document.querySelector(`button[onclick*="acceptOrder(${orderId})"]`);
                if (btn) {
                    btn.disabled = true;
                    const acceptingText = i18nPrefix ? i18nPrefix.t('acceptingOrder') : 'Accepting...';
                    btn.innerHTML = `<span class="loading"></span> ${acceptingText}`;
                }
                
                // Âú®ÂèëÈÄÅ‰∫§ÊòìÂâçÔºåÂÖàÂ∞ùËØï‰º∞ÁÆó GasÔºàËøô‰ºöËß¶ÂèëÂêàÁ∫¶Ê£ÄÊü•Ôºâ
                try {
                    console.log('Ê≠£Âú®‰º∞ÁÆó Gas...');
                    const estimatedGas = await contracts.rideOrder.estimateGas.acceptOrder(orderId);
                    console.log('Gas ‰º∞ÁÆóÊàêÂäü:', estimatedGas.toString());
                } catch (gasError) {
                    console.error('Gas ‰º∞ÁÆóÂ§±Ë¥•ÔºåÂêàÁ∫¶ÂèØËÉΩÊãíÁªùÊ≠§‰∫§Êòì:', gasError);
                    let errorMsg = gasError.reason || gasError.message || 'Unknown error';
                    
                    // Ê£ÄÊü•ËÆ¢ÂçïÁä∂ÊÄÅ
                    try {
                        const currentOrder = await contracts.rideOrder.getOrder(orderId);
                        console.log('ÂΩìÂâçËÆ¢ÂçïÁä∂ÊÄÅ:', {
                            status: currentOrder.status,
                            rideStatus: currentOrder.rideStatus,
                            driver: currentOrder.driver,
                            passenger: currentOrder.passenger,
                            currentAccount: account
                        });
                        
                        if (currentOrder.status !== 0) { // Status.Pending = 0
                            errorMsg = isZh 
                                ? `ËÆ¢ÂçïÂ∑≤Ë¢´Êé•ÂèóÔºàÁä∂ÊÄÅ: ${currentOrder.status}Ôºâ„ÄÇÂΩìÂâçÂè∏Êú∫: ${currentOrder.driver}`
                                : `Order already accepted (status: ${currentOrder.status}). Current driver: ${currentOrder.driver}`;
                        } else if (currentOrder.passenger.toLowerCase() === account.toLowerCase()) {
                            errorMsg = isZh 
                                ? '‰∏çËÉΩÊé•ÂèóËá™Â∑±ÂàõÂª∫ÁöÑËÆ¢Âçï'
                                : 'Cannot accept own order';
                        }
                    } catch (getOrderError) {
                        console.error('Êó†Ê≥ïËé∑ÂèñËÆ¢Âçï‰ø°ÊÅØ:', getOrderError);
                    }
                    
                    throw new Error(errorMsg);
                }
                
                // Á°Æ‰øù‰ΩøÁî®signerÂèëÈÄÅ‰∫§Êòì
                if (!signer) {
                    if (!provider) {
                        provider = new ethers.providers.Web3Provider(window.ethereum);
                    }
                    signer = provider.getSigner();
                    // ÈáçÊñ∞ÂàõÂª∫Â∏¶signerÁöÑÂêàÁ∫¶ÂÆû‰æã
                    contracts.rideOrder = new ethers.Contract(
                        CONTRACT_ADDRESSES.rideOrder,
                        TRUST_FLOW_RIDE_ABI,
                        signer
                    );
                }
                
                console.log('ÂáÜÂ§áÂèëÈÄÅ acceptOrder ‰∫§ÊòìÔºåËÆ¢ÂçïID:', orderId);
                const tx = await contracts.rideOrder.acceptOrder(orderId);
                console.log('‰∫§ÊòìÂ∑≤ÂèëÈÄÅÔºåÂìàÂ∏å:', tx.hash);
                
                const txSubmittedText = i18nPrefix ? i18nPrefix.t('transactionSubmitted', { hash: tx.hash.substring(0, 10) }) : `Transaction submitted, waiting for confirmation... (Hash: ${tx.hash.substring(0, 10)}...)`;
                document.getElementById('wallet-status').innerHTML = `
                    <div class="status info">
                        ‚è≥ ${txSubmittedText}
                    </div>
                `;
                
                const receipt = await tx.wait();
                console.log('‰∫§ÊòìÂ∑≤Á°ÆËÆ§ÔºåÂå∫ÂùóÂè∑:', receipt.blockNumber);
                
                // ËÆ°ÁÆóÂÆûÈôÖGasË¥πÁî®
                const gasUsed = receipt.gasUsed;
                const gasPrice = tx.gasPrice || receipt.effectiveGasPrice || await provider.getGasPrice();
                const actualGasCostWei = gasUsed.mul(gasPrice);
                const actualGasCostETH = ethers.utils.formatEther(actualGasCostWei);
                const actualGasCostUSD = (parseFloat(actualGasCostETH) * ETH_TO_USD_RATE).toFixed(2);
                
                const acceptedText = i18nPrefix ? i18nPrefix.t('orderAccepted', { orderId }) : `Order #${orderId} accepted successfully!`;
                document.getElementById('wallet-status').innerHTML = `
                    <div class="status success">
                        ‚úì ${acceptedText}
                        <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 13px; text-align: left;">
                            <div><strong>${isZh ? 'Ë¥πÁî®ÊòéÁªÜ / Fee Details' : 'Fee Details'}:</strong></div>
                            <div>${isZh ? 'ÂÆûÈôÖGasË¥πÁî® / Actual Gas Fee' : 'Actual Gas Fee'}: ${parseFloat(actualGasCostETH) < 0.0001 ? '< 0.0001' : parseFloat(actualGasCostETH).toFixed(8)} ETH ($${actualGasCostUSD} USD)</div>
                        </div>
                    </div>
                `;
                
                // ÈáçÊñ∞Âä†ËΩΩËÆ¢ÂçïÂàóË°®
                setTimeout(() => {
                    loadAvailableOrders();
                    loadMyOrders();
                }, 1000);
                
            } catch (error) {
                console.error('Êé•ÂçïÂ§±Ë¥•:', error);
                console.error('ÈîôËØØËØ¶ÊÉÖ:', {
                    code: error.code,
                    message: error.message,
                    reason: error.reason,
                    data: error.data,
                    stack: error.stack
                });
                
                // ÊèêÂèñÈîôËØØ‰ø°ÊÅØ
                let errorMessage = error.reason || error.message || 'Unknown error';
                
                // Â§ÑÁêÜ Internal JSON-RPC error
                if (error.code === -32603 || errorMessage.includes('Internal JSON-RPC error')) {
                    errorMessage = isZh 
                        ? `Êé•ÂçïÂ§±Ë¥•ÔºöÂêàÁ∫¶ÊâßË°åË¢´ÊãíÁªù„ÄÇ\n\nÂèØËÉΩÁöÑÂéüÂõ†Ôºö\n1. ËÆ¢ÂçïÂ∑≤Ë¢´ÂÖ∂‰ªñÂè∏Êú∫Êé•Âçï\n2. ËÆ¢ÂçïÁä∂ÊÄÅ‰∏çÊ≠£Á°Æ\n3. ÂêàÁ∫¶Â∑≤ÊöÇÂÅú\n\nËØ∑Âà∑Êñ∞ËÆ¢ÂçïÂàóË°®ÂêéÈáçËØï„ÄÇ`
                        : `Failed to accept order: Contract execution was rejected.\n\nPossible reasons:\n1. Order already accepted by another driver\n2. Invalid order status\n3. Contract is paused\n\nPlease refresh the order list and try again.`;
                    
                    // Â∞ùËØïËé∑ÂèñËÆ¢ÂçïÁä∂ÊÄÅÊù•Êèê‰æõÊõ¥ËØ¶ÁªÜÁöÑ‰ø°ÊÅØ
                    try {
                        const currentOrder = await contracts.rideOrder.getOrder(orderId);
                        console.log('ËÆ¢ÂçïÂΩìÂâçÁä∂ÊÄÅ:', {
                            orderId: currentOrder.orderId.toString(),
                            status: currentOrder.status,
                            rideStatus: currentOrder.rideStatus,
                            driver: currentOrder.driver,
                            passenger: currentOrder.passenger
                        });
                        
                        if (currentOrder.driver && currentOrder.driver !== ethers.constants.AddressZero) {
                            errorMessage = isZh 
                                ? `ËÆ¢ÂçïÂ∑≤Ë¢´Âè∏Êú∫ ${currentOrder.driver.substring(0, 10)}... Êé•Âçï`
                                : `Order already accepted by driver ${currentOrder.driver.substring(0, 10)}...`;
                        } else if (currentOrder.status !== 0) {
                            errorMessage = isZh 
                                ? `ËÆ¢ÂçïÁä∂ÊÄÅ‰∏çÊ≠£Á°ÆÔºàÁä∂ÊÄÅ: ${currentOrder.status}ÔºâÔºåÊó†Ê≥ïÊé•Âçï`
                                : `Invalid order status (status: ${currentOrder.status}), cannot accept`;
                        }
                    } catch (getOrderError) {
                        console.error('Êó†Ê≥ïËé∑ÂèñËÆ¢ÂçïÁä∂ÊÄÅ:', getOrderError);
                    }
                }
                // Â¶ÇÊûúÊòØËÆ¢Âçï‰∏çÂ≠òÂú®ÁöÑÈîôËØØÔºåÊèê‰æõÊõ¥ËØ¶ÁªÜÁöÑÊèêÁ§∫
                else if (errorMessage.includes('Order does not exist') || (errorMessage.includes('ËÆ¢Âçï') && errorMessage.includes('‰∏çÂ≠òÂú®'))) {
                    errorMessage = isZh 
                        ? `ËÆ¢Âçï #${orderId} ‰∏çÂ≠òÂú®„ÄÇ\n\nÂèØËÉΩÁöÑÂéüÂõ†Ôºö\n1. ËÆ¢ÂçïÂ∑≤Ë¢´ÂèñÊ∂àÊàñÂà†Èô§\n2. ËÆ¢ÂçïÂ∑≤Ë¢´ÂÖ∂‰ªñÂè∏Êú∫Êé•Âçï\n3. ËÆ¢ÂçïIDÈîôËØØ\n\nËØ∑Âà∑Êñ∞ËÆ¢ÂçïÂàóË°®ÂêéÈáçËØï„ÄÇ`
                        : `Order #${orderId} does not exist.\n\nPossible reasons:\n1. Order has been cancelled or deleted\n2. Order has been accepted by another driver\n3. Invalid order ID\n\nPlease refresh the order list and try again.`;
                    
                    // Â¶ÇÊûúËÆ¢Âçï‰∏çÂ≠òÂú®ÔºåËá™Âä®Âà∑Êñ∞ËÆ¢ÂçïÂàóË°®
                    setTimeout(() => {
                        loadAvailableOrders();
                    }, 2000);
                }
                
                alert((isZh ? 'Êé•ÂçïÂ§±Ë¥•: ' : 'Failed to accept order: ') + errorMessage);
                const btn = window.event?.target || document.querySelector(`button[onclick*="acceptOrder(${orderId})"]`);
                if (btn) {
                    btn.disabled = false;
                    const acceptText = typeof i18n !== 'undefined' ? i18n.t('acceptOrder') : 'Accept Order';
                    btn.textContent = `üöó ${acceptText}`;
                }
            }
        }
        
        // Â∑≤‰∏äËΩ¶ÂäüËÉΩ
        async function pickUpPassenger(orderId) {
            if (!contracts.rideOrder) {
                alert('ÂêàÁ∫¶Êú™ÂàùÂßãÂåñÔºÅ');
                return;
            }
            
            const i18nPrefix = typeof i18n !== 'undefined' ? i18n : null;
            const confirmText = i18nPrefix ? i18nPrefix.t('pickupConfirm', { orderId }) : `Confirm passenger picked up for order #${orderId}?`;
            const confirmed = confirm(confirmText);
            if (!confirmed) return;
            
            try {
                const btn = window.event?.target || document.querySelector(`button[onclick*="pickUpPassenger(${orderId})"]`);
                if (btn) {
                    btn.disabled = true;
                    const pickingText = i18nPrefix ? i18nPrefix.t('pickingUp') : 'Processing...';
                    btn.innerHTML = `<span class="loading"></span> ${pickingText}`;
                }
                
                const tx = await contracts.rideOrder.confirmPickup(orderId);
                
                const txSubmittedText = i18nPrefix ? i18nPrefix.t('transactionSubmitted', { hash: tx.hash.substring(0, 10) }) : `Transaction submitted, waiting for confirmation... (Hash: ${tx.hash.substring(0, 10)}...)`;
                document.getElementById('wallet-status').innerHTML = `
                    <div class="status info">
                        ‚è≥ ${txSubmittedText}
                    </div>
                `;
                
                await tx.wait();
                
                const pickupConfirmedText = i18nPrefix ? i18nPrefix.t('pickupConfirmed', { orderId }) : `Pickup confirmed! Order #${orderId}`;
                document.getElementById('wallet-status').innerHTML = `
                    <div class="status success">
                        ‚úì ${pickupConfirmedText}
                    </div>
                `;
                
                // ÈáçÊñ∞Âä†ËΩΩËÆ¢ÂçïÂàóË°®
                setTimeout(() => {
                    loadMyOrders();
                }, 1000);
                
            } catch (error) {
                console.error('Á°ÆËÆ§‰∏äËΩ¶Â§±Ë¥•:', error);
                alert('Á°ÆËÆ§‰∏äËΩ¶Â§±Ë¥•: ' + (error.reason || error.message));
                const btn = window.event?.target || document.querySelector(`button[onclick*="pickUpPassenger(${orderId})"]`);
                if (btn) {
                    btn.disabled = false;
                    const pickupText = typeof i18n !== 'undefined' ? i18n.t('pickupPassenger') : 'Pick Up';
                    btn.textContent = `üìç ${pickupText}`;
                }
            }
        }
        
        // ÂÆåÊàêËÆ¢ÂçïÂäüËÉΩ
        async function completeOrder(orderId) {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîÑ complete is clicked - ËÆ¢Âçï ID:', orderId);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            if (!contracts.rideOrder) {
                console.error('‚ùå ÂêàÁ∫¶Êú™ÂàùÂßãÂåñÔºÅ');
                alert('ÂêàÁ∫¶Êú™ÂàùÂßãÂåñÔºÅ');
                return;
            }
            
            try {
                // Ëé∑ÂèñÂΩìÂâçË¥¶Êà∑‰ΩôÈ¢ùÔºà‰∫§ÊòìÂâçÔºâ
                let driverBalanceBefore = null;
                try {
                    if (account && provider) {
                        driverBalanceBefore = await provider.getBalance(account);
                        console.log('üí∞ Âè∏Êú∫‰∫§ÊòìÂâç‰ΩôÈ¢ù:', ethers.utils.formatEther(driverBalanceBefore), 'ETH');
                    }
                } catch (balanceError) {
                    console.warn('‚ö†Ô∏è Êó†Ê≥ïËé∑Âèñ‰∫§ÊòìÂâç‰ΩôÈ¢ù:', balanceError);
                }
                // Ëé∑ÂèñËÆ¢Âçï‰ø°ÊÅØ‰ª•ÊòæÁ§∫È¢Ñ‰º∞Ë¥πÁî®
                console.log('üìã Ëé∑ÂèñËÆ¢Âçï‰ø°ÊÅØ...');
                const order = await contracts.rideOrder.getOrder(orderId);
                console.log('üìã ËÆ¢Âçï‰ø°ÊÅØ:', {
                    orderId: order.orderId.toString(),
                    status: order.status,
                    rideStatus: order.rideStatus,
                    driver: order.driver,
                    passenger: order.passenger,
                    estimatedFare: ethers.utils.formatEther(order.estimatedFare) + ' ETH',
                    actualFare: ethers.utils.formatEther(order.actualFare || '0') + ' ETH',
                    disputeOpened: order.disputeOpened,
                    disputeResolved: order.disputeResolved
                });
                
                // È™åËØÅËÆ¢ÂçïÁä∂ÊÄÅÔºàÂøÖÈ°ªÂú®‰∫§ÊòìÂâçÊ£ÄÊü•Ôºâ
                const Status = { Pending: 0, Accepted: 1, PickedUp: 2, Completed: 3, Cancelled: 4 };
                const RideStatus = { CREATED: 0, ACCEPTED: 1, IN_PROGRESS: 2, COMPLETED: 3, AWAITING_SETTLEMENT: 4, SETTLED: 5 };
                
                if (order.status !== Status.PickedUp) {
                    const errorMsg = isZh 
                        ? `ËÆ¢ÂçïÁä∂ÊÄÅ‰∏çÊ≠£Á°ÆÔºàÁä∂ÊÄÅ: ${order.status}Ôºâ„ÄÇ\n\nËÆ¢ÂçïÂøÖÈ°ªÊòØ"Â∑≤‰∏äËΩ¶"(PickedUp)Áä∂ÊÄÅÊâçËÉΩÂÆåÊàê„ÄÇ\n\nÂΩìÂâçÁä∂ÊÄÅ: ${order.status === Status.Accepted ? 'Â∑≤Êé•Âçï' : order.status === Status.Completed ? 'Â∑≤ÂÆåÊàê' : 'Êú™Áü•'}`
                        : `Invalid order status (${order.status}).\n\nOrder must be in "PickedUp" status to complete.\n\nCurrent status: ${order.status}`;
                    console.error('‚ùå', errorMsg);
                    alert(errorMsg);
                    return;
                }
                
                if (order.rideStatus !== RideStatus.IN_PROGRESS) {
                    const errorMsg = isZh 
                        ? `Ë°åÁ®ãÁä∂ÊÄÅ‰∏çÊ≠£Á°ÆÔºàÁä∂ÊÄÅ: ${order.rideStatus}Ôºâ„ÄÇ\n\nË°åÁ®ãÂøÖÈ°ªÊòØ"ËøõË°å‰∏≠"(IN_PROGRESS)Áä∂ÊÄÅÊâçËÉΩÂÆåÊàê„ÄÇ`
                        : `Invalid ride status (${order.rideStatus}).\n\nRide must be in "IN_PROGRESS" status to complete.`;
                    console.error('‚ùå', errorMsg);
                    alert(errorMsg);
                    return;
                }
                
                if (order.driver.toLowerCase() !== account.toLowerCase()) {
                    const errorMsg = isZh 
                        ? `ÊÇ®‰∏çÊòØÊ≠§ËÆ¢ÂçïÁöÑÂè∏Êú∫„ÄÇ\n\nËÆ¢ÂçïÂè∏Êú∫: ${order.driver}\nÂΩìÂâçË¥¶Êà∑: ${account}`
                        : `You are not the driver for this order.\n\nOrder driver: ${order.driver}\nCurrent account: ${account}`;
                    console.error('‚ùå', errorMsg);
                    alert(errorMsg);
                    return;
                }
                
                // Ê£ÄÊü•ÂêàÁ∫¶‰ΩôÈ¢ùÔºàÂøÖÈ°ªÂú®‰∫§ÊòìÂâçÊ£ÄÊü•Ôºâ
                try {
                    const contractBalance = await provider.getBalance(contracts.rideOrder.address);
                    const estimatedFare = order.estimatedFare;
                    console.log('üì¶ ÂêàÁ∫¶‰ΩôÈ¢ùÊ£ÄÊü•:');
                    console.log('  ÂêàÁ∫¶‰ΩôÈ¢ù:', ethers.utils.formatEther(contractBalance), 'ETH');
                    console.log('  ËÆ¢ÂçïÈáëÈ¢ù:', ethers.utils.formatEther(estimatedFare), 'ETH');
                    if (contractBalance.lt(estimatedFare)) {
                        const errorMsg = isZh 
                            ? `ÂêàÁ∫¶‰ΩôÈ¢ù‰∏çË∂≥ÔºÅÊó†Ê≥ïÂÆåÊàêÁªìÁÆó„ÄÇ\n\nÈúÄË¶Å: ${ethers.utils.formatEther(estimatedFare)} ETH\nÂΩìÂâç: ${ethers.utils.formatEther(contractBalance)} ETH\n\nËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò„ÄÇ`
                            : `Insufficient contract balance!\n\nRequired: ${ethers.utils.formatEther(estimatedFare)} ETH\nCurrent: ${ethers.utils.formatEther(contractBalance)} ETH\n\nPlease contact administrator.`;
                        console.error('‚ùå', errorMsg);
                        alert(errorMsg);
                        return;
                    } else {
                        console.log('‚úÖ ÂêàÁ∫¶‰ΩôÈ¢ùÂÖÖË∂≥');
                    }
                } catch (balanceError) {
                    console.warn('‚ö†Ô∏è Êó†Ê≥ïÊ£ÄÊü•ÂêàÁ∫¶‰ΩôÈ¢ù:', balanceError);
                }
                
                const estimatedFareETH = parseFloat(ethers.utils.formatEther(order.estimatedFare)).toFixed(8);
                const estimatedFareUSD = parseFloat(estimatedFareETH) * ETH_TO_USD_RATE;
                
                // ËÆ°ÁÆóÂπ≥Âè∞Ë¥πÔºà5%Ôºâ
                const PLATFORM_FEE_RATE = 0.05;
                const platformFeeETH = (parseFloat(estimatedFareETH) * PLATFORM_FEE_RATE).toFixed(8);
                const platformFeeUSD = (parseFloat(platformFeeETH) * ETH_TO_USD_RATE).toFixed(2);
                
                // ÊèêÁ§∫ËæìÂÖ•ÂÆûÈôÖË¥πÁî®Ôºà‰ΩøÁî®ETH‰∏∫‰∏ªË¶ÅÊòæÁ§∫ÔºåUSD‰∏∫ÂèÇËÄÉÂÄºÔºâ
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                const actualFareETHInput = prompt(
                    (typeof i18n !== 'undefined' ? i18n.t('enterActualFare') : 'Enter actual fare (ETH):') + '\n\n' +
                    (typeof i18n !== 'undefined' ? i18n.t('estimatedFareLabel') : 'Estimated Fare') + `: ${estimatedFareETH} ETH ($${estimatedFareUSD.toFixed(2)} USDÔºå${typeof i18n !== 'undefined' ? i18n.t('reference') : 'reference'})\n` +
                    (typeof i18n !== 'undefined' ? i18n.t('estimatedPlatformFee') : 'Estimated Platform Fee (5%)') + `: ${platformFeeETH} ETH ($${platformFeeUSD} USD)\n\n` +
                    (typeof i18n !== 'undefined' ? i18n.t('enterActualFare') : 'Enter actual fare (ETH):'),
                    estimatedFareETH
                );
                
                if (!actualFareETHInput || isNaN(parseFloat(actualFareETHInput)) || parseFloat(actualFareETHInput) <= 0) {
                    alert(typeof i18n !== 'undefined' && i18n.currentLang === 'zh' ? 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑË¥πÁî®ÈáëÈ¢ùÔºÅ' : 'Please enter a valid fare amount!');
                    return;
                }
                
                const actualFareETH = parseFloat(actualFareETHInput).toFixed(8);
                const actualFareUSD = (parseFloat(actualFareETH) * ETH_TO_USD_RATE).toFixed(2);
                const actualFare = ethers.utils.parseEther(actualFareETH);
                
                // ËÆ°ÁÆóÂÆûÈôÖÂπ≥Âè∞Ë¥π
                const actualPlatformFeeETH = (parseFloat(actualFareETH) * PLATFORM_FEE_RATE).toFixed(8);
                const actualPlatformFeeUSD = (parseFloat(actualPlatformFeeETH) * ETH_TO_USD_RATE).toFixed(2);
                
                // ‰º∞ÁÆóGasË¥πÁî®ÔºàËøô‰ºöÊèêÂâçÊ£ÄÊü•‰∫§ÊòìÊòØÂê¶‰ºöÂ§±Ë¥•Ôºâ
                let gasEstimate = '';
                let gasCostETH = '';
                let gasCostUSD = '';
                try {
                    console.log('‚õΩ Ê≠£Âú®‰º∞ÁÆó Gas...');
                    const estimatedGas = await contracts.rideOrder.estimateGas.completeOrder(orderId, actualFare);
                    console.log('‚úÖ Gas ‰º∞ÁÆóÊàêÂäü:', estimatedGas.toString(), 'gas');
                    const gasPrice = await provider.getGasPrice();
                    const gasCostWei = estimatedGas.mul(gasPrice);
                    const gasCostEthValue = ethers.utils.formatEther(gasCostWei);
                    gasCostETH = parseFloat(gasCostEthValue) < 0.0001 ? '< 0.0001' : parseFloat(gasCostEthValue).toFixed(8);
                    gasCostUSD = (parseFloat(gasCostEthValue) * ETH_TO_USD_RATE).toFixed(2);
                    gasEstimate = `${estimatedGas.toString()} gas`;
                } catch (error) {
                    console.error('‚ùå Gas ‰º∞ÁÆóÂ§±Ë¥•ÔºÅËøôËØ¥Êòé‰∫§ÊòìÂèØËÉΩ‰ºöÂ§±Ë¥•:', error);
                    let errorMsg = error.reason || error.message || 'Unknown error';
                    
                    // Êèê‰æõÊõ¥ÂèãÂ•ΩÁöÑÈîôËØØÊèêÁ§∫
                    if (errorMsg.includes('Insufficient contract balance')) {
                        errorMsg = isZh 
                            ? 'ÂêàÁ∫¶‰ΩôÈ¢ù‰∏çË∂≥ÔºåÊó†Ê≥ïÂÆåÊàêÁªìÁÆó„ÄÇËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò„ÄÇ'
                            : 'Insufficient contract balance. Please contact administrator.';
                    } else if (errorMsg.includes('Order not ready to settle')) {
                        errorMsg = isZh 
                            ? 'ËÆ¢ÂçïÁä∂ÊÄÅ‰∏çÊ≠£Á°ÆÔºåÊó†Ê≥ïÁªìÁÆó„ÄÇ'
                            : 'Order not ready to settle.';
                    } else if (errorMsg.includes('Order not picked up')) {
                        errorMsg = isZh 
                            ? 'ËÆ¢ÂçïÂ∞öÊú™‰∏äËΩ¶ÔºåÊó†Ê≥ïÂÆåÊàê„ÄÇ'
                            : 'Order not picked up.';
                    } else if (errorMsg.includes('Ride must be in progress')) {
                        errorMsg = isZh 
                            ? 'Ë°åÁ®ãÂøÖÈ°ªÂú®ËøõË°å‰∏≠Áä∂ÊÄÅÊâçËÉΩÂÆåÊàê„ÄÇ'
                            : 'Ride must be in progress.';
                    }
                    
                    alert((isZh ? '‰∫§ÊòìÂèØËÉΩÂ§±Ë¥•: ' : 'Transaction may fail: ') + errorMsg);
                    
                    // ‰ªçÁÑ∂ÊòæÁ§∫ Gas ‰º∞ÁÆóÁöÑÂç†‰ΩçÁ¨¶Ôºå‰ΩÜÊ†áËÆ∞‰∏∫ÂèØËÉΩÂ§±Ë¥•
                    gasEstimate = '‰º∞ÁÆóÂ§±Ë¥• - ‰∫§ÊòìÂèØËÉΩÊó†Ê≥ïÊâßË°å';
                    gasCostETH = 'N/A';
                    gasCostUSD = 'N/A';
                    
                    // ËØ¢ÈóÆÁî®Êà∑ÊòØÂê¶ÁªßÁª≠
                    const shouldContinue = confirm(
                        (isZh 
                            ? 'Gas ‰º∞ÁÆóÂ§±Ë¥•Ôºå‰∫§ÊòìÂèØËÉΩ‰ºöÂ§±Ë¥•„ÄÇ\n\nÊòØÂê¶‰ªçÁÑ∂Â∞ùËØïÂèëÈÄÅ‰∫§ÊòìÔºü\n\nÂª∫ËÆÆÔºöËØ∑Ê£ÄÊü•ËÆ¢ÂçïÁä∂ÊÄÅÂíåÂêàÁ∫¶‰ΩôÈ¢ù„ÄÇ'
                            : 'Gas estimation failed. Transaction may fail.\n\nDo you still want to send the transaction?\n\nRecommendation: Please check order status and contract balance.')
                    );
                    
                    if (!shouldContinue) {
                        const btn = window.event?.target || document.querySelector(`button[onclick*="completeOrder(${orderId})"]`);
                        if (btn) {
                            btn.disabled = false;
                            const completeText = typeof i18n !== 'undefined' ? i18n.t('completeOrder') : 'Complete Order';
                            btn.textContent = `‚úÖ ${completeText}`;
                        }
                        return;
                    }
                }
                
                // ËÆ°ÁÆóÂè∏Êú∫Â∞ÜÊî∂Âà∞ÁöÑÈáëÈ¢ùÔºàËÆ¢ÂçïÈáëÈ¢ù - Âπ≥Âè∞Ë¥πÔºâ
                const driverEarningETH = (parseFloat(actualFareETH) - parseFloat(actualPlatformFeeETH)).toFixed(8);
                const driverEarningUSD = (parseFloat(driverEarningETH) * ETH_TO_USD_RATE).toFixed(2);
                
                const i18nPrefix2 = typeof i18n !== 'undefined' ? i18n : null;
                const isZh2 = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                const confirmTitle = i18nPrefix2 ? i18nPrefix2.t('completeOrderConfirm', { orderId }) : `Confirm completing order #${orderId}?`;
                const feeInfoText = isZh2 
                    ? `\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüí∞ ËÆ¢ÂçïÈáëÈ¢ù / Order Amount\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n${actualFareETH} ETH\n($${actualFareUSD} USD)\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìä Ë¥πÁî®ÊòéÁªÜ / Fee Breakdown\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nÂπ≥Âè∞Ë¥π (5%): -${actualPlatformFeeETH} ETH (-$${actualPlatformFeeUSD} USD)\nGas Ë¥πÁî®: -${gasCostETH} ETH ${gasCostUSD !== '-' ? `(-$${gasCostUSD} USD)` : ''}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚úÖ ÊÇ®Â∞ÜÊî∂Âà∞ÁöÑÈáëÈ¢ù / Amount You Will Receive\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n${driverEarningETH} ETH\n($${driverEarningUSD} USD)\n\nÊ≥®ÔºöËÆ¢ÂçïÈáëÈ¢ùÂ∞Ü‰ªéÊô∫ËÉΩÂêàÁ∫¶ËΩ¨Ë¥¶Âà∞ÊÇ®ÁöÑË¥¶Êà∑„ÄÇMetaMask ‰∏≠ÊòæÁ§∫ÁöÑÈáëÈ¢ù‰∏∫ 0 ETH ÊòØÊ≠£Â∏∏ÁöÑÔºåÂõ†‰∏∫ËøôÊòØÊé•Êî∂ËµÑÈáëÔºåËÄå‰∏çÊòØÂèëÈÄÅËµÑÈáë„ÄÇÂè™Êúâ Gas Ë¥πÁî®Â∞Ü‰ªéÊÇ®ÁöÑË¥¶Êà∑Êâ£Èô§„ÄÇ\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`
                    : `\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüí∞ Order Amount\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n${actualFareETH} ETH\n($${actualFareUSD} USD)\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìä Fee Breakdown\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nPlatform Fee (5%): -${actualPlatformFeeETH} ETH (-$${actualPlatformFeeUSD} USD)\nGas Fee: -${gasCostETH} ETH ${gasCostUSD !== '-' ? `(-$${gasCostUSD} USD)` : ''}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚úÖ Amount You Will Receive\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n${driverEarningETH} ETH\n($${driverEarningUSD} USD)\n\nNote: The order amount will be transferred from the smart contract to your account. The amount shown as 0 ETH in MetaMask is normal, as this is receiving funds, not sending funds. Only the gas fee will be deducted from your account.\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;
                
                const confirmed = confirm(confirmTitle + feeInfoText);
                
                if (!confirmed) return;
                
                const btn = window.event?.target || document.querySelector(`button[onclick*="completeOrder(${orderId})"]`);
                if (btn) {
                    btn.disabled = true;
                    const completingText = typeof i18n !== 'undefined' ? i18n.t('completing') : 'Completing...';
                    btn.innerHTML = `<span class="loading"></span> ${completingText}`;
                }
                
                // Á°Æ‰øù‰ΩøÁî®signerÂèëÈÄÅ‰∫§Êòì
                if (!signer) {
                    if (!provider) {
                        provider = new ethers.providers.Web3Provider(window.ethereum);
                    }
                    signer = provider.getSigner();
                    // ÈáçÊñ∞ÂàõÂª∫Â∏¶signerÁöÑÂêàÁ∫¶ÂÆû‰æã
                    contracts.rideOrder = new ethers.Contract(
                        CONTRACT_ADDRESSES.rideOrder,
                        TRUST_FLOW_RIDE_ABI,
                        signer
                    );
                }
                
                console.log('üì§ ÂáÜÂ§áÂèëÈÄÅ completeOrder ‰∫§Êòì');
                console.log('  ËÆ¢ÂçïID:', orderId);
                console.log('  ÂÆûÈôÖË¥πÁî®:', actualFare.toString(), 'wei (', actualFareETH, 'ETH)');
                console.log('  Âè∏Êú∫Âú∞ÂùÄ:', account);
                
                // ÂèëÈÄÅ‰∫§ÊòìÔºàÊ≥®ÊÑèÔºöcompleteOrder ‰∏çÈúÄË¶ÅÂèëÈÄÅ ETHÔºåvalue Â∫îËØ•ÊòØ 0Ôºâ
                let tx;
                try {
                    // Ëé∑ÂèñÂΩìÂâç Gas ‰ª∑Ê†º
                    const gasPrice = await provider.getGasPrice();
                    console.log('‚õΩ ÂΩìÂâç Gas ‰ª∑Ê†º:', ethers.utils.formatUnits(gasPrice, 'gwei'), 'gwei');
                    
                    // ‰º∞ÁÆó Gas Limit
                    let gasLimit;
                    try {
                        const estimatedGas = await contracts.rideOrder.estimateGas.completeOrder(orderId, actualFare);
                        console.log('‚õΩ ‰º∞ÁÆó Gas Limit:', estimatedGas.toString());
                        // Âè™Â¢ûÂä† 10% ÁöÑÁºìÂÜ≤ÔºàÂáèÂ∞ëÁºìÂÜ≤ÈÅøÂÖç MetaMask ËØØÂà§Ôºâ
                        gasLimit = estimatedGas.mul(110).div(100);
                        console.log('‚õΩ ‰ΩøÁî® Gas LimitÔºàÂê´ 10% ÁºìÂÜ≤Ôºâ:', gasLimit.toString());
                    } catch (gasError) {
                        console.warn('‚ö†Ô∏è Gas ‰º∞ÁÆóÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÂÄº:', gasError);
                        // ‰ΩøÁî®Êõ¥‰øùÂÆàÁöÑÈªòËÆ§ÂÄº
                        gasLimit = ethers.BigNumber.from(300000); // ÈªòËÆ§ 300kÔºàÊõ¥‰øùÂÆàÔºâ
                    }
                    
                    // ‰º∞ÁÆó‰∫§ÊòìÊÄªË¥πÁî®
                    const estimatedTotalCost = gasLimit.mul(gasPrice);
                    const estimatedTotalCostETH = ethers.utils.formatEther(estimatedTotalCost);
                    console.log('üí∞ ‰º∞ÁÆó‰∫§ÊòìÊÄªË¥πÁî®:', estimatedTotalCostETH, 'ETH');
                    
                    // Ê£ÄÊü•Ë¥¶Êà∑‰ΩôÈ¢ùÊòØÂê¶Ë∂≥Â§üÊîØ‰ªò Gas
                    if (account && provider) {
                        const accountBalance = await provider.getBalance(account);
                        console.log('üí∞ Ë¥¶Êà∑‰ΩôÈ¢ù:', ethers.utils.formatEther(accountBalance), 'ETH');
                        if (accountBalance.lt(estimatedTotalCost)) {
                            const errorMsg = isZh 
                                ? `Ë¥¶Êà∑‰ΩôÈ¢ù‰∏çË∂≥‰ª•ÊîØ‰ªò‰∫§ÊòìË¥πÁî®ÔºÅ\n\nÈúÄË¶Å: ${estimatedTotalCostETH} ETH\nÂΩìÂâç: ${ethers.utils.formatEther(accountBalance)} ETH`
                                : `Insufficient balance for transaction fees!\n\nRequired: ${estimatedTotalCostETH} ETH\nCurrent: ${ethers.utils.formatEther(accountBalance)} ETH`;
                            console.error('‚ùå', errorMsg);
                            alert(errorMsg);
                            return;
                        }
                    }
                    
                    console.log('üì§ ÂèëÈÄÅ completeOrder ‰∫§Êòì');
                    console.log('  Ê≥®ÊÑèÔºövalue = 0 ETHÔºàËøôÊòØÊé•Êî∂ËµÑÈáëÁöÑ‰∫§ÊòìÔºå‰∏çÊòØÂèëÈÄÅÔºâ');
                    console.log('  Gas Price:', ethers.utils.formatUnits(gasPrice, 'gwei'), 'gwei');
                    console.log('  Gas Limit:', gasLimit.toString());
                    
                    // ÊòéÁ°ÆËÆæÁΩÆ value ‰∏∫ 0ÔºågasPrice Âíå gasLimit
                    // Ê≥®ÊÑèÔºövalue ÂøÖÈ°ªÊòéÁ°ÆËÆæÁΩÆ‰∏∫ 0ÔºåÈÅøÂÖç MetaMask ËØØÂà§
                    tx = await contracts.rideOrder.completeOrder(orderId, actualFare, {
                        value: ethers.BigNumber.from(0),  // ÊòéÁ°ÆËÆæÁΩÆ‰∏∫ 0Ôºå‰ΩøÁî® BigNumber Ê†ºÂºè
                        gasPrice: gasPrice,
                        gasLimit: gasLimit
                    });
                    console.log('‚úÖ ‰∫§ÊòìÂ∑≤ÂèëÈÄÅÔºåÂìàÂ∏å:', tx.hash);
                } catch (sendError) {
                    console.error('‚ùå ÂèëÈÄÅ‰∫§ÊòìÂ§±Ë¥•:', sendError);
                    const errorMsg = sendError.reason || sendError.message || 'Unknown error';
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØ MetaMask Ë¥πÁî®‰øùÊä§ÈîôËØØ
                    if (errorMsg.includes('extra fees') || errorMsg.includes('cost you extra') || errorMsg.includes('stopped it') || errorMsg.includes('would have cost')) {
                        const metaMaskError = isZh 
                            ? `MetaMask ÈòªÊ≠¢‰∫Ü‰∫§ÊòìÔºåËÆ§‰∏∫Ë¥πÁî®ËøáÈ´ò„ÄÇ\n\nËß£ÂÜ≥ÊñπÊ°àÔºö\n\n1. Âú® MetaMask ÂºπÁ™ó‰∏≠ÔºåÁÇπÂáª"È´òÁ∫ß"Êàñ"ÁºñËæë"\n2. Á°ÆËÆ§"ÈáëÈ¢ù"ÊòæÁ§∫‰∏∫ 0 ETHÔºàËøôÊòØÊ≠£Â∏∏ÁöÑÔºåÂõ†‰∏∫ÊÇ®ÊòØÂú®Êé•Êî∂ËµÑÈáëÔºâ\n3. ÊâãÂä®Ë∞ÉÊï¥ Gas Limit Âíå Gas PriceÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ\n4. ÁÇπÂáª"Á°ÆËÆ§"Êàñ"Approve"\n\nÊ≥®ÊÑèÔºöËøôÂè™ÊòØ‰∏Ä‰∏™Êé•Êî∂ËµÑÈáëÁöÑ‰∫§ÊòìÔºå‰∏ç‰ºö‰ªéÊÇ®ÁöÑË¥¶Êà∑Êâ£Èô§ËÆ¢ÂçïÈáëÈ¢ùÔºåÂè™‰ºöÊâ£Èô§ Gas Ë¥πÁî®„ÄÇËÆ¢ÂçïÈáëÈ¢ù‰ºö‰ªéÊô∫ËÉΩÂêàÁ∫¶ËΩ¨ÁªôÊÇ®„ÄÇ`
                            : `MetaMask blocked the transaction due to fee concerns.\n\nSolution:\n\n1. In MetaMask popup, click "Advanced" or "Edit"\n2. Confirm "Amount" shows 0 ETH (this is normal, you're receiving funds)\n3. Manually adjust Gas Limit and Gas Price if needed\n4. Click "Confirm" or "Approve"\n\nNote: This is a fund-receiving transaction. The order amount will be transferred FROM the contract TO your account. Only gas fee will be deducted from your account.`;
                        alert(metaMaskError);
                    } else {
                        alert((isZh ? 'ÂèëÈÄÅ‰∫§ÊòìÂ§±Ë¥•: ' : 'Failed to send transaction: ') + errorMsg);
                    }
                    throw sendError;
                }
                
                const i18nPrefix = typeof i18n !== 'undefined' ? i18n : null;
                const txSubmittedText = i18nPrefix ? i18nPrefix.t('transactionSubmitted', { hash: tx.hash.substring(0, 10) }) : `Transaction submitted, waiting for confirmation... (Hash: ${tx.hash.substring(0, 10)}...)`;
                document.getElementById('wallet-status').innerHTML = `
                    <div class="status info">
                        ‚è≥ ${txSubmittedText}
                    </div>
                `;
                
                // Á≠âÂæÖ‰∫§ÊòìÁ°ÆËÆ§
                let receipt;
                try {
                    console.log('‚è≥ Á≠âÂæÖ‰∫§ÊòìÁ°ÆËÆ§...');
                    receipt = await tx.wait();
                    console.log('‚úÖ ‰∫§ÊòìÂ∑≤Á°ÆËÆ§ÔºåÂå∫ÂùóÂè∑:', receipt.blockNumber);
                    
                    // Ê£ÄÊü•‰∫§ÊòìÁä∂ÊÄÅ
                    if (receipt.status === 0) {
                        console.error('‚ùå ‰∫§ÊòìÂ§±Ë¥•Ôºàstatus = 0ÔºâÔºÅ');
                        throw new Error('Transaction failed (status = 0)');
                    }
                } catch (waitError) {
                    console.error('‚ùå ‰∫§ÊòìÁ≠âÂæÖÂ§±Ë¥•Êàñ‰∫§ÊòìË¢´ revert:', waitError);
                    
                    // Â∞ùËØïËé∑Âèñ‰∫§ÊòìÂõûÊâß‰ª•Êü•ÁúãÂ§±Ë¥•ÂéüÂõ†
                    try {
                        const failedReceipt = await provider.getTransactionReceipt(tx.hash);
                        if (failedReceipt) {
                            console.error('‰∫§ÊòìÂõûÊâßÁä∂ÊÄÅ:', failedReceipt.status === 1 ? 'ÊàêÂäü' : 'Â§±Ë¥•');
                            if (failedReceipt.status === 0) {
                                console.error('‚ùå ‰∫§ÊòìÂ§±Ë¥•ÔºÅÂèØËÉΩÁöÑÂéüÂõ†Ôºö');
                                console.error('  1. ÂêàÁ∫¶ÊâßË°å revertÔºàÊ£ÄÊü•ËÆ¢ÂçïÁä∂ÊÄÅ„ÄÅ‰ΩôÈ¢ùÁ≠âÔºâ');
                                console.error('  2. Gas ‰∏çË∂≥');
                                console.error('  3. ËÆ¢ÂçïÁä∂ÊÄÅ‰∏çÊ≠£Á°Æ');
                                console.error('  4. ÂêàÁ∫¶‰ΩôÈ¢ù‰∏çË∂≥');
                            }
                        }
                    } catch (receiptError) {
                        console.error('Êó†Ê≥ïËé∑Âèñ‰∫§ÊòìÂõûÊâß:', receiptError);
                    }
                    
                    const errorMsg = waitError.reason || waitError.message || 'Transaction failed or reverted';
                    alert((isZh ? '‰∫§ÊòìÂ§±Ë¥•ÊàñË¢´ÊãíÁªù: ' : 'Transaction failed or reverted: ') + errorMsg);
                    
                    const btn = window.event?.target || document.querySelector(`button[onclick*="completeOrder(${orderId})"]`);
                    if (btn) {
                        btn.disabled = false;
                        const completeText = typeof i18n !== 'undefined' ? i18n.t('completeOrder') : 'Complete Order';
                        btn.textContent = `‚úÖ ${completeText}`;
                    }
                    throw waitError;
                }
                
                console.log('‚úÖ ‰∫§ÊòìÁ°ÆËÆ§ÊàêÂäüÔºåÂå∫ÂùóÂè∑:', receipt.blockNumber);
                console.log('üìã ‰∫§ÊòìÂõûÊâß‰∏≠ÁöÑÊâÄÊúâ‰∫ã‰ª∂:', receipt.events?.map(e => e.event) || []);
                
                // Á≠âÂæÖ‰∏Ä‰∏™Âå∫ÂùóÔºåÁ°Æ‰øù‰ΩôÈ¢ùÊõ¥Êñ∞
                console.log('‚è≥ Á≠âÂæÖ‰ΩôÈ¢ùÊõ¥Êñ∞Ôºà2ÁßíÔºâ...');
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Ëé∑ÂèñÂè∏Êú∫Ë¥¶Êà∑‰ΩôÈ¢ùÔºà‰∫§ÊòìÂêéÔºâ
                let driverBalanceAfter = null;
                try {
                    if (account && provider) {
                        driverBalanceAfter = await provider.getBalance(account);
                        console.log('üí∞ Âè∏Êú∫‰∫§ÊòìÂêé‰ΩôÈ¢ù:', ethers.utils.formatEther(driverBalanceAfter), 'ETH');
                        
                        if (driverBalanceBefore) {
                            const balanceDiff = driverBalanceAfter.sub(driverBalanceBefore);
                            const balanceDiffETH = ethers.utils.formatEther(balanceDiff);
                            console.log('üìä ‰ΩôÈ¢ùÂèòÂåñ:', balanceDiffETH, 'ETH');
                            
                            if (balanceDiff.gt(0)) {
                                console.log('‚úÖ ‰ΩôÈ¢ùÂ¢ûÂä†ÔºÅËµÑÈáëÂ∑≤Âà∞Ë¥¶ÔºÅ');
                            } else if (balanceDiff.lt(0)) {
                                console.log('‚ö†Ô∏è ‰ΩôÈ¢ùÂáèÂ∞ëÔºàÂèØËÉΩÊòØ Gas Ë¥πÁî®Ôºâ');
                            } else {
                                console.error('‚ùå ‰ΩôÈ¢ùÊ≤°ÊúâÂèòÂåñÔºÅ');
                                console.error('ÂèØËÉΩÁöÑÂéüÂõ†Ôºö');
                                console.error('  1. PaymentReleased ‰∫ã‰ª∂Êú™ÂèëÂá∫');
                                console.error('  2. ËΩ¨Ë¥¶Â§±Ë¥•');
                                console.error('  3. ËÆ¢ÂçïÁä∂ÊÄÅ‰∏çÊ≠£Á°Æ');
                            }
                        }
                    }
                } catch (balanceError) {
                    console.warn('‚ö†Ô∏è Êó†Ê≥ïËé∑Âèñ‰∫§ÊòìÂêé‰ΩôÈ¢ù:', balanceError);
                }
                
                // Ê£ÄÊü•ÂêàÁ∫¶‰ΩôÈ¢ùÔºàËÆ¢ÂçïÈáëÈ¢ùÂ∫îËØ•Â∑≤ÂàÜÈÖçÔºâ
                try {
                    const contractBalance = await provider.getBalance(contracts.rideOrder.address);
                    console.log('üì¶ ÂêàÁ∫¶ÂΩìÂâç‰ΩôÈ¢ù:', ethers.utils.formatEther(contractBalance), 'ETH');
                } catch (balanceError) {
                    console.warn('‚ö†Ô∏è Êó†Ê≥ïËé∑ÂèñÂêàÁ∫¶‰ΩôÈ¢ù:', balanceError);
                }
                
                // Ê£ÄÊü• PaymentReleased ‰∫ã‰ª∂
                const paymentReleasedEvent = receipt.events?.find(e => e.event === 'PaymentReleased');
                if (paymentReleasedEvent) {
                    const driverAmount = paymentReleasedEvent.args.driverAmount;
                    const platformFee = paymentReleasedEvent.args.platformFee;
                    console.log('‚úÖ PaymentReleased ‰∫ã‰ª∂Â∑≤ÂèëÂá∫:');
                    console.log('  ËÆ¢ÂçïID:', paymentReleasedEvent.args.orderId.toString());
                    console.log('  Âè∏Êú∫Âú∞ÂùÄ:', paymentReleasedEvent.args.driver);
                    console.log('  Âè∏Êú∫ÈáëÈ¢ù:', ethers.utils.formatEther(driverAmount), 'ETH');
                    console.log('  Âπ≥Âè∞Ë¥πÁî®:', ethers.utils.formatEther(platformFee), 'ETH');
                } else {
                    console.error('‚ùå Êú™ÊâæÂà∞ PaymentReleased ‰∫ã‰ª∂ÔºÅ');
                    console.error('ÂèØËÉΩÁöÑÂéüÂõ†Ôºö');
                    console.error('  1. ÂêàÁ∫¶Ê≤°ÊúâË∂≥Â§üÁöÑ‰ΩôÈ¢ùËøõË°åËΩ¨Ë¥¶');
                    console.error('  2. ËÆ¢ÂçïÁä∂ÊÄÅ‰∏çÊ≠£Á°ÆÔºàÂèØËÉΩ‰∏çÊòØ AWAITING_SETTLEMENTÔºâ');
                    console.error('  3. Êúâ‰∫âËÆÆÈòªÊ≠¢‰∫ÜÁªìÁÆó');
                    console.error('  4. ËΩ¨Ë¥¶Â§±Ë¥•Ôºà‰ΩÜ‰∫§ÊòìÊ≤°Êúâ revertÔºâ');
                    
                    // Â∞ùËØï‰ªé‰∫§ÊòìÊó•Âøó‰∏≠Ëß£Êûê‰∫ã‰ª∂
                    console.log('üîç Â∞ùËØï‰ªé‰∫§ÊòìÊó•ÂøóËß£Êûê‰∫ã‰ª∂...');
                    if (receipt.logs && receipt.logs.length > 0) {
                        console.log('üìã ‰∫§ÊòìÊó•ÂøóÊï∞Èáè:', receipt.logs.length);
                        receipt.logs.forEach((log, index) => {
                            console.log(`  Êó•Âøó ${index + 1}:`, {
                                address: log.address,
                                topics: log.topics,
                                data: log.data
                            });
                        });
                    }
                }
                
                // Ê£ÄÊü• RideSettled ‰∫ã‰ª∂
                const rideSettledEvent = receipt.events?.find(e => e.event === 'RideSettled');
                if (rideSettledEvent) {
                    console.log('‚úÖ RideSettled ‰∫ã‰ª∂Â∑≤ÂèëÂá∫ÔºåËÆ¢ÂçïÂ∑≤ÁªìÁÆó');
                } else {
                    console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ RideSettled ‰∫ã‰ª∂');
                }
                
                // Ê£ÄÊü• OrderCompleted ‰∫ã‰ª∂
                const orderCompletedEvent = receipt.events?.find(e => e.event === 'OrderCompleted');
                if (orderCompletedEvent) {
                    console.log('‚úÖ OrderCompleted ‰∫ã‰ª∂Â∑≤ÂèëÂá∫');
                }
                
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                
                // ËÆ°ÁÆóÂÆûÈôÖGasË¥πÁî®
                const gasUsed = receipt.gasUsed;
                const gasPrice = tx.gasPrice || receipt.effectiveGasPrice || await provider.getGasPrice();
                const actualGasCostWei = gasUsed.mul(gasPrice);
                const actualGasCostETH = ethers.utils.formatEther(actualGasCostWei);
                const actualGasCostUSD = (parseFloat(actualGasCostETH) * ETH_TO_USD_RATE).toFixed(2);
                
                const completedText = i18nPrefix ? i18nPrefix.t('orderCompleted', { orderId }) : `Order #${orderId} completed`;
                document.getElementById('wallet-status').innerHTML = `
                    <div class="status success">
                        ‚úì ${completedText}
                        <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 13px; text-align: left;">
                            <div><strong>${typeof i18n !== 'undefined' ? i18n.t('feeDetails') : 'Fee Details'}:</strong></div>
                            <div>${typeof i18n !== 'undefined' ? i18n.t('orderAmount') : 'Order Amount'}: ${actualFareETH} ETH ($${actualFareUSD} USD)</div>
                            <div>${typeof i18n !== 'undefined' ? i18n.t('platformFee') : 'Platform Fee (5%)'}: ${actualPlatformFeeETH} ETH ($${actualPlatformFeeUSD} USD)</div>
                            <div>${typeof i18n !== 'undefined' ? i18n.t('gasFee') : 'Gas Fee'}: ${parseFloat(actualGasCostETH) < 0.0001 ? '< 0.0001' : parseFloat(actualGasCostETH).toFixed(8)} ETH ($${actualGasCostUSD} USD)</div>
                        </div>
                    </div>
                `;
                
                // ÈáçÊñ∞Âä†ËΩΩËÆ¢ÂçïÂàóË°®ÂíåÁªüËÆ°‰ø°ÊÅØ
                setTimeout(() => {
                    loadMyOrders();
                    loadProfile();
                }, 1000);
                
            } catch (error) {
                console.error('ÂÆåÊàêËÆ¢ÂçïÂ§±Ë¥•:', error);
                alert('ÂÆåÊàêËÆ¢ÂçïÂ§±Ë¥•: ' + (error.reason || error.message));
                const btn = window.event?.target || document.querySelector(`button[onclick*="completeOrder(${orderId})"]`);
                if (btn) {
                    btn.disabled = false;
                    const completeText = typeof i18n !== 'undefined' ? i18n.t('completeOrder') : 'Complete Order';
                    btn.textContent = `‚úÖ ${completeText}`;
                }
            }
        }
        
        // Ride Lifecycle ÂáΩÊï∞
        
        // Êé•ÂçïÔºàRide LifecycleÔºâ
        async function acceptRide(orderId) {
            if (!contracts.rideOrder) {
                alert('ÂêàÁ∫¶Êú™ÂàùÂßãÂåñÔºÅ');
                return;
            }
            
            const i18nPrefix = typeof i18n !== 'undefined' ? i18n : null;
            const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
            
            try {
                const confirmText = i18nPrefix ? 
                    (isZh ? `Á°ÆËÆ§Êé•Âçï #${orderId}Ôºü` : `Confirm accepting ride #${orderId}?`) :
                    `Confirm accepting ride #${orderId}?`;
                
                if (!confirm(confirmText)) return;
                
                const btn = window.event?.target || document.querySelector(`button[onclick*="acceptRide(${orderId})"]`);
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = `<span class="loading"></span> ${isZh ? 'Êé•Âçï‰∏≠...' : 'Accepting...'}`;
                }
                
                const tx = await contracts.rideOrder.acceptRide(orderId);
                
                const txSubmittedText = i18nPrefix ? i18nPrefix.t('transactionSubmitted', { hash: tx.hash.substring(0, 10) }) : `Transaction submitted, waiting for confirmation... (Hash: ${tx.hash.substring(0, 10)}...)`;
                document.getElementById('wallet-status').innerHTML = `
                    <div class="status info">
                        ‚è≥ ${txSubmittedText}
                    </div>
                `;
                
                await tx.wait();
                
                const acceptedText = isZh ? `ËÆ¢Âçï #${orderId} Â∑≤Êé•ÂçïÔºÅ` : `Ride #${orderId} accepted!`;
                document.getElementById('wallet-status').innerHTML = `
                    <div class="status success">
                        ‚úì ${acceptedText}
                    </div>
                `;
                
                setTimeout(() => {
                    loadMyOrders();
                    loadAvailableOrders();
                }, 1000);
                
            } catch (error) {
                console.error('Êé•ÂçïÂ§±Ë¥•:', error);
                alert((isZh ? 'Êé•ÂçïÂ§±Ë¥•: ' : 'Failed to accept ride: ') + (error.reason || error.message));
                const btn = window.event?.target || document.querySelector(`button[onclick*="acceptRide(${orderId})"]`);
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = isZh ? 'üöó Êé•Âçï' : 'üöó Accept Ride';
                }
            }
        }
        
        // ÂºÄÂßãË°åÁ®ã
        async function startRide(orderId) {
            if (!contracts.rideOrder) {
                alert('ÂêàÁ∫¶Êú™ÂàùÂßãÂåñÔºÅ');
                return;
            }
            
            const i18nPrefix = typeof i18n !== 'undefined' ? i18n : null;
            const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
            
            try {
                const confirmText = i18nPrefix ? 
                    (isZh ? `Á°ÆËÆ§ÂºÄÂßãË°åÁ®ã #${orderId}Ôºü` : `Confirm starting ride #${orderId}?`) :
                    `Confirm starting ride #${orderId}?`;
                
                if (!confirm(confirmText)) return;
                
                const btn = window.event?.target || document.querySelector(`button[onclick*="startRide(${orderId})"]`);
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = `<span class="loading"></span> ${isZh ? 'ÂºÄÂßã‰∏≠...' : 'Starting...'}`;
                }
                
                const tx = await contracts.rideOrder.startRide(orderId);
                
                const txSubmittedText = i18nPrefix ? i18nPrefix.t('transactionSubmitted', { hash: tx.hash.substring(0, 10) }) : `Transaction submitted, waiting for confirmation... (Hash: ${tx.hash.substring(0, 10)}...)`;
                document.getElementById('wallet-status').innerHTML = `
                    <div class="status info">
                        ‚è≥ ${txSubmittedText}
                    </div>
                `;
                
                await tx.wait();
                
                const startedText = isZh ? `Ë°åÁ®ã #${orderId} Â∑≤ÂºÄÂßãÔºÅ` : `Ride #${orderId} started!`;
                document.getElementById('wallet-status').innerHTML = `
                    <div class="status success">
                        ‚úì ${startedText}
                    </div>
                `;
                
                setTimeout(() => {
                    loadMyOrders();
                }, 1000);
                
            } catch (error) {
                console.error('ÂºÄÂßãË°åÁ®ãÂ§±Ë¥•:', error);
                alert((isZh ? 'ÂºÄÂßãË°åÁ®ãÂ§±Ë¥•: ' : 'Failed to start ride: ') + (error.reason || error.message));
                const btn = window.event?.target || document.querySelector(`button[onclick*="startRide(${orderId})"]`);
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = isZh ? 'üöÄ ÂºÄÂßãË°åÁ®ã' : 'üöÄ Start Ride';
                }
            }
        }
        
        // ÂÆåÊàêË°åÁ®ãÔºàRide LifecycleÔºå‰ºöËá™Âä®ÁªìÁÆóÔºâ
        async function completeRide(orderId) {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîÑ completeRide is clicked - ËÆ¢Âçï ID:', orderId);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            if (!contracts.rideOrder) {
                console.error('‚ùå ÂêàÁ∫¶Êú™ÂàùÂßãÂåñÔºÅ');
                alert('ÂêàÁ∫¶Êú™ÂàùÂßãÂåñÔºÅ');
                return;
            }
            
            const i18nPrefix = typeof i18n !== 'undefined' ? i18n : null;
            const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
            
            try {
                // Ëé∑ÂèñÂΩìÂâçË¥¶Êà∑‰ΩôÈ¢ùÔºà‰∫§ÊòìÂâçÔºâ
                let driverBalanceBefore = null;
                try {
                    if (account && provider) {
                        driverBalanceBefore = await provider.getBalance(account);
                        console.log('üí∞ Âè∏Êú∫‰∫§ÊòìÂâç‰ΩôÈ¢ù:', ethers.utils.formatEther(driverBalanceBefore), 'ETH');
                    }
                } catch (balanceError) {
                    console.warn('‚ö†Ô∏è Êó†Ê≥ïËé∑Âèñ‰∫§ÊòìÂâç‰ΩôÈ¢ù:', balanceError);
                }
                
                const confirmText = i18nPrefix ? 
                    (isZh ? `Á°ÆËÆ§ÂÆåÊàêË°åÁ®ã #${orderId}Ôºü\n\nÂÆåÊàêÂêéÂ∞ÜËá™Âä®ÁªìÁÆóË¥πÁî®„ÄÇ` : `Confirm completing ride #${orderId}?\n\nThe order will be settled automatically.`) :
                    `Confirm completing ride #${orderId}?\n\nThe order will be settled automatically.`;
                
                if (!confirm(confirmText)) return;
                
                const btn = window.event?.target || document.querySelector(`button[onclick*="completeRide(${orderId})"]`);
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = `<span class="loading"></span> ${isZh ? 'ÂÆåÊàê‰∏≠...' : 'Completing...'}`;
                }
                
                console.log('üì§ ÂèëÈÄÅ completeRide ‰∫§Êòì...');
                const tx = await contracts.rideOrder.completeRide(orderId);
                console.log('‚úÖ ‰∫§ÊòìÂ∑≤ÂèëÈÄÅÔºåÂìàÂ∏å:', tx.hash);
                
                const txSubmittedText = i18nPrefix ? i18nPrefix.t('transactionSubmitted', { hash: tx.hash.substring(0, 10) }) : `Transaction submitted, waiting for confirmation... (Hash: ${tx.hash.substring(0, 10)}...)`;
                document.getElementById('wallet-status').innerHTML = `
                    <div class="status info">
                        ‚è≥ ${txSubmittedText}
                    </div>
                `;
                
                const receipt = await tx.wait();
                console.log('‚úÖ completeRide ‰∫§ÊòìÂ∑≤Á°ÆËÆ§ÔºåÂå∫ÂùóÂè∑:', receipt.blockNumber);
                console.log('üìã ‰∫§ÊòìÂõûÊâß‰∏≠ÁöÑÊâÄÊúâ‰∫ã‰ª∂:', receipt.events?.map(e => e.event) || []);
                
                // Ê£ÄÊü• RideCompleted ‰∫ã‰ª∂
                const rideCompletedEvent = receipt.events?.find(e => e.event === 'RideCompleted');
                if (rideCompletedEvent) {
                    console.log('‚úÖ RideCompleted ‰∫ã‰ª∂Â∑≤ÂèëÂá∫');
                }
                
                // Á≠âÂæÖÁä∂ÊÄÅÊõ¥Êñ∞
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Ê£ÄÊü•ËÆ¢ÂçïÁä∂ÊÄÅÔºåÂ¶ÇÊûúËøõÂÖ• AWAITING_SETTLEMENTÔºåËá™Âä®Ë∞ÉÁî® settle
                try {
                    const order = await contracts.rideOrder.getOrder(orderId);
                    console.log('üìã ËÆ¢ÂçïÁä∂ÊÄÅÊ£ÄÊü•:', {
                        rideStatus: order.rideStatus,
                        status: order.status,
                        disputeOpened: order.disputeOpened
                    });
                    
                    // Â¶ÇÊûúËÆ¢ÂçïËøõÂÖ• AWAITING_SETTLEMENT Áä∂ÊÄÅ‰∏îÊ≤°Êúâ‰∫âËÆÆÔºåËá™Âä®ÁªìÁÆó
                    if (order.rideStatus === 4 && !order.disputeOpened) { // 4 = AWAITING_SETTLEMENT
                        console.log('üí∞ ËÆ¢ÂçïÂ∑≤ËøõÂÖ• AWAITING_SETTLEMENT Áä∂ÊÄÅÔºåËá™Âä®Ë∞ÉÁî® settle ÂáΩÊï∞ÁªìÁÆóËµÑÈáë...');
                        
                        const settleTx = await contracts.rideOrder.settle(orderId);
                        console.log('‚úÖ settle ‰∫§ÊòìÂ∑≤ÂèëÈÄÅÔºåÂìàÂ∏å:', settleTx.hash);
                        
                        document.getElementById('wallet-status').innerHTML = `
                            <div class="status info">
                                ‚è≥ ${isZh ? 'Ê≠£Âú®ÁªìÁÆóËµÑÈáë...' : 'Settling funds...'} (Hash: ${settleTx.hash.substring(0, 10)}...)
                            </div>
                        `;
                        
                        const settleReceipt = await settleTx.wait();
                        console.log('‚úÖ settle ‰∫§ÊòìÂ∑≤Á°ÆËÆ§ÔºåÂå∫ÂùóÂè∑:', settleReceipt.blockNumber);
                        console.log('üìã settle ‰∫§ÊòìÂõûÊâß‰∏≠ÁöÑÊâÄÊúâ‰∫ã‰ª∂:', settleReceipt.events?.map(e => e.event) || []);
                        
                        // Ê£ÄÊü• PaymentReleased ‰∫ã‰ª∂
                        const paymentReleasedEvent = settleReceipt.events?.find(e => e.event === 'PaymentReleased');
                        if (paymentReleasedEvent) {
                            const driverAmount = paymentReleasedEvent.args.driverAmount;
                            const platformFee = paymentReleasedEvent.args.platformFee;
                            console.log('‚úÖ PaymentReleased ‰∫ã‰ª∂Â∑≤ÂèëÂá∫:');
                            console.log('  Âè∏Êú∫ÈáëÈ¢ù:', ethers.utils.formatEther(driverAmount), 'ETH');
                            console.log('  Âπ≥Âè∞Ë¥πÁî®:', ethers.utils.formatEther(platformFee), 'ETH');
                        } else {
                            console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ PaymentReleased ‰∫ã‰ª∂');
                        }
                        
                        // Á≠âÂæÖ‰ΩôÈ¢ùÊõ¥Êñ∞
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    } else {
                        console.warn('‚ö†Ô∏è ËÆ¢ÂçïÁä∂ÊÄÅ‰∏çÊ≠£Á°ÆÊàñÂ≠òÂú®‰∫âËÆÆÔºåÊó†Ê≥ïËá™Âä®ÁªìÁÆó');
                        console.warn('  Áä∂ÊÄÅ:', order.rideStatus, '(ÈúÄË¶Å 4 = AWAITING_SETTLEMENT)');
                        console.warn('  ‰∫âËÆÆ:', order.disputeOpened);
                    }
                } catch (settleError) {
                    console.error('‚ùå Ëá™Âä®ÁªìÁÆóÂ§±Ë¥•:', settleError);
                    console.warn('üí° ÊèêÁ§∫ÔºöÊÇ®ÂèØ‰ª•Á®çÂêéÊâãÂä®Ë∞ÉÁî® settle ÂáΩÊï∞Êù•ÁªìÁÆóËµÑÈáë');
                }
                
                // Ëé∑ÂèñÂè∏Êú∫Ë¥¶Êà∑‰ΩôÈ¢ùÔºà‰∫§ÊòìÂêéÔºâ
                let driverBalanceAfter = null;
                try {
                    if (account && provider) {
                        driverBalanceAfter = await provider.getBalance(account);
                        console.log('üí∞ Âè∏Êú∫‰∫§ÊòìÂêé‰ΩôÈ¢ù:', ethers.utils.formatEther(driverBalanceAfter), 'ETH');
                        
                        if (driverBalanceBefore) {
                            const balanceDiff = driverBalanceAfter.sub(driverBalanceBefore);
                            const balanceDiffETH = ethers.utils.formatEther(balanceDiff);
                            console.log('üìä ‰ΩôÈ¢ùÂèòÂåñ:', balanceDiffETH, 'ETH');
                            
                            if (balanceDiff.gt(0)) {
                                console.log('‚úÖ ‰ΩôÈ¢ùÂ¢ûÂä†ÔºÅËµÑÈáëÂ∑≤Âà∞Ë¥¶ÔºÅ');
                            } else if (balanceDiff.lt(0)) {
                                console.log('‚ö†Ô∏è ‰ΩôÈ¢ùÂáèÂ∞ëÔºàÂèØËÉΩÊòØ Gas Ë¥πÁî®Ôºâ');
                            } else {
                                console.warn('‚ö†Ô∏è ‰ΩôÈ¢ùÊ≤°ÊúâÂèòÂåñÔºÅ');
                            }
                        }
                    }
                } catch (balanceError) {
                    console.warn('‚ö†Ô∏è Êó†Ê≥ïËé∑Âèñ‰∫§ÊòìÂêé‰ΩôÈ¢ù:', balanceError);
                }
                
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                
                const completedText = isZh ? `Ë°åÁ®ã #${orderId} Â∑≤ÂÆåÊàêÂπ∂Â∑≤ÁªìÁÆóÔºÅ` : `Ride #${orderId} completed and settled!`;
                document.getElementById('wallet-status').innerHTML = `
                    <div class="status success">
                        ‚úì ${completedText}
                    </div>
                `;
                
                setTimeout(() => {
                    loadMyOrders();
                    loadProfile();
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå ÂÆåÊàêË°åÁ®ãÂ§±Ë¥•:', error);
                alert((isZh ? 'ÂÆåÊàêË°åÁ®ãÂ§±Ë¥•: ' : 'Failed to complete ride: ') + (error.reason || error.message));
                const btn = window.event?.target || document.querySelector(`button[onclick*="completeRide(${orderId})"]`);
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = isZh ? '‚úÖ ÂÆåÊàêË°åÁ®ã' : '‚úÖ Complete Ride';
                }
            }
        }
        
        // Èò≤Ê≠¢ÈáçÂ§çÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®
        let orderCreatedListener = null;
        
        function listenForNewOrders() {
            if (!contracts.rideOrder) return;
            
            // Â¶ÇÊûúÂ∑≤ÁªèÊúâÁõëÂê¨Âô®ÔºåÂÖàÁßªÈô§
            if (orderCreatedListener) {
                try {
                    contracts.rideOrder.off('OrderCreated', orderCreatedListener);
                } catch (e) {
                    // ÂøΩÁï•ÁßªÈô§Â§±Ë¥•ÁöÑÊÉÖÂÜµ
                }
            }
            
            // ÂàõÂª∫Êñ∞ÁöÑÁõëÂê¨Âô®
            orderCreatedListener = async (orderId, passenger) => {
                // ‰ΩøÁî®Èò≤ÊäñÔºåÈÅøÂÖçÈ¢ëÁπÅÂà∑Êñ∞
                if (window.orderRefreshTimeout) {
                    clearTimeout(window.orderRefreshTimeout);
                }
                window.orderRefreshTimeout = setTimeout(() => {
                    loadAvailableOrders();
                }, 2000);
            };
            
            // ÁªëÂÆö‰∫ã‰ª∂
            contracts.rideOrder.on('OrderCreated', orderCreatedListener);
            
            // ÁõëÂê¨ Ride Lifecycle ‰∫ã‰ª∂
            contracts.rideOrder.on('RideAccepted', async (orderId, driver, timestamp) => {
                console.log('Ride Accepted:', orderId.toString(), driver);
                setTimeout(() => {
                    loadMyOrders();
                    loadAvailableOrders();
                }, 1000);
            });
            
            contracts.rideOrder.on('RideStarted', async (orderId, timestamp) => {
                console.log('Ride Started:', orderId.toString());
                setTimeout(() => {
                    loadMyOrders();
                }, 1000);
            });
            
            contracts.rideOrder.on('RideCompleted', async (orderId, timestamp) => {
                console.log('Ride Completed:', orderId.toString());
                setTimeout(() => {
                    loadMyOrders();
                }, 1000);
            });
            
            contracts.rideOrder.on('RideSettled', async (orderId, timestamp) => {
                console.log('Ride Settled:', orderId.toString());
                setTimeout(() => {
                    loadMyOrders();
                    loadProfile();
                }, 1000);
            });
            
            // ÁõëÂê¨ DisputeResolved ‰∫ã‰ª∂
            contracts.rideOrder.on('DisputeResolved', async (orderId, winner, detail, timestamp) => {
                const orderIdStr = orderId.toString ? orderId.toString() : String(orderId);
                console.log('‚öñÔ∏è Dispute Resolved:', orderIdStr, winner);
                setTimeout(() => {
                    // Âà∑Êñ∞ÊàëÁöÑËÆ¢ÂçïÂàóË°®
                    loadMyOrders();
                    // Â¶ÇÊûúËÆ¢ÂçïËØ¶ÊÉÖÊ®°ÊÄÅÊ°ÜÊâìÂºÄÔºåÂà∑Êñ∞ÂÆÉ
                    const orderModal = document.getElementById('order-modal');
                    if (orderModal && orderModal.style.display !== 'none') {
                        const orderModalBody = document.getElementById('order-modal-body');
                        if (orderModalBody && orderModalBody.innerHTML.includes(`order-detail-${orderIdStr}`)) {
                            // Â¶ÇÊûúÂΩìÂâçÊòæÁ§∫ÁöÑÊòØËøô‰∏™ËÆ¢ÂçïÁöÑËØ¶ÊÉÖÔºåÈáçÊñ∞Âä†ËΩΩ
                            viewOrderDetail(parseInt(orderIdStr));
                        }
                    }
                }, 1500);
            });
        }
        
        // ËÆ¢ÂçïÁä∂ÊÄÅËá™Âä®Âà∑Êñ∞ - ËΩÆËØ¢Êú∫Âà∂
        let driverOrderRefreshInterval = null;
        const DRIVER_ORDER_REFRESH_INTERVAL = 5000; // 5ÁßíÂà∑Êñ∞‰∏ÄÊ¨°
        
        function startDriverOrderAutoRefresh() {
            // Â¶ÇÊûúÂ∑≤ÁªèÊúâÂÆöÊó∂Âô®ÔºåÂÖàÊ∏ÖÈô§
            if (driverOrderRefreshInterval) {
                clearInterval(driverOrderRefreshInterval);
            }
            
            // ÂàõÂª∫Êñ∞ÁöÑÂÆöÊó∂Âô®
            driverOrderRefreshInterval = setInterval(() => {
                // Âè™Âú®Áõ∏ÂÖ≥ËßÜÂõæÊòæÁ§∫Êó∂Âà∑Êñ∞
                if (account && contracts?.rideOrder) {
                    const availableView = document.getElementById('available-orders-view');
                    const myOrdersView = document.getElementById('my-orders-view');
                    
                    if (availableView && availableView.style.display !== 'none') {
                        // Â¶ÇÊûúËøûÁª≠Â§±Ë¥•Â§öÊ¨°ÔºåÂ¢ûÂä†Âà∑Êñ∞Èó¥Èöî
                        if (apiConnectionFailures >= MAX_CONSECUTIVE_FAILURES) {
                            const backoffDelay = BASE_RETRY_DELAY * Math.pow(BACKOFF_MULTIPLIER, Math.min(apiConnectionFailures - MAX_CONSECUTIVE_FAILURES, 3));
                            const timeSinceLastError = lastApiErrorTime ? Date.now() - lastApiErrorTime : 0;
                            
                            if (timeSinceLastError < backoffDelay) {
                                // ËøòÂú®ÈÄÄÈÅøÊúüÂÜÖÔºåË∑≥ËøáÊú¨Ê¨°Âà∑Êñ∞
                                return;
                            }
                        }
                        
                        console.log('üîÑ Ëá™Âä®Âà∑Êñ∞ÂèØÁî®ËÆ¢Âçï...');
                        loadAvailableOrders(false).catch(err => {
                            // ÈîôËØØÂ∑≤Âú® loadAvailableOrders ‰∏≠Â§ÑÁêÜÔºåËøôÈáåÂè™ËÆ∞ÂΩï
                            if (apiConnectionFailures < MAX_CONSECUTIVE_FAILURES) {
                                console.warn('‚ö†Ô∏è Ëá™Âä®Âà∑Êñ∞ÂèØÁî®ËÆ¢ÂçïÂ§±Ë¥•:', err.message);
                            }
                        });
                    }
                    
                    if (myOrdersView && myOrdersView.style.display !== 'none') {
                        console.log('üîÑ Ëá™Âä®Âà∑Êñ∞ÊàëÁöÑËÆ¢Âçï...');
                        loadMyOrders(false).catch(err => {
                            console.error('Ëá™Âä®Âà∑Êñ∞ÊàëÁöÑËÆ¢ÂçïÂ§±Ë¥•:', err);
                        });
                    }
                }
            }, DRIVER_ORDER_REFRESH_INTERVAL);
            
            console.log('‚úÖ Âè∏Êú∫Á´ØËÆ¢ÂçïËá™Âä®Âà∑Êñ∞Â∑≤ÂêØÂä®ÔºàÊØè', DRIVER_ORDER_REFRESH_INTERVAL / 1000, 'ÁßíÔºâ');
        }
        
        function stopDriverOrderAutoRefresh() {
            if (driverOrderRefreshInterval) {
                clearInterval(driverOrderRefreshInterval);
                driverOrderRefreshInterval = null;
                console.log('‚è∏Ô∏è Âè∏Êú∫Á´ØËÆ¢ÂçïËá™Âä®Âà∑Êñ∞Â∑≤ÂÅúÊ≠¢');
            }
        }
        
        window.startDriverOrderAutoRefresh = startDriverOrderAutoRefresh;
        window.stopDriverOrderAutoRefresh = stopDriverOrderAutoRefresh;
        
        // ÂàáÊç¢Ë¥¶Êà∑
        async function switchAccount() {
            if (typeof window.ethereum === 'undefined') {
                const metaMaskNotInstalledText = typeof i18n !== 'undefined' ? i18n.t('metaMaskNotInstalled') : 'MetaMask is not installed!';
                alert(metaMaskNotInstalledText);
                return;
            }
            
            try {
                // ËØ∑Ê±ÇÂàáÊç¢Ë¥¶Êà∑ÔºàMetaMask‰ºöÊòæÁ§∫Ë¥¶Êà∑ÈÄâÊã©ÁïåÈù¢Ôºâ
                await window.ethereum.request({ 
                    method: 'wallet_requestPermissions',
                    params: [{ eth_accounts: {} }]
                });
                
                // ÈáçÊñ∞ËøûÊé•Èí±ÂåÖ‰ª•Ëé∑ÂèñÊñ∞Ë¥¶Êà∑
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length > 0) {
                    account = accounts[0];
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    
                    // Êõ¥Êñ∞ÂêàÁ∫¶ÂÆû‰æã
                    if (CONTRACT_ADDRESSES.rideOrder) {
                        contracts.rideOrder = new ethers.Contract(
                            CONTRACT_ADDRESSES.rideOrder,
                            TRUST_FLOW_RIDE_ABI,
                            signer
                        );
                    }
                    
                    // Êõ¥Êñ∞ÊòæÁ§∫
                    document.getElementById('current-account-display').textContent = account;
                    const i18nPrefixSwitch = typeof i18n !== 'undefined' ? i18n : null;
                    const accountSwitchedText = i18nPrefixSwitch ? i18nPrefixSwitch.t('accountSwitched') : 'Account Switched';
                    document.getElementById('wallet-status').innerHTML = `
                        <div class="status success">
                            ‚úì ${accountSwitchedText}: ${account.substring(0, 6)}...${account.substring(38)}
                        </div>
                    `;
                    
                    // ÈáçÊñ∞Âä†ËΩΩËÆ¢Âçï
                    await loadAvailableOrders();
                }
            } catch (error) {
                console.error('ÂàáÊç¢Ë¥¶Êà∑Â§±Ë¥•:', error);
                if (error.code !== 4001) { // Áî®Êà∑ÊãíÁªù‰∏çÁÆóÈîôËØØ
                    const switchAccountFailedText = typeof i18n !== 'undefined' ? i18n.t('switchAccountFailed') : 'Failed to switch account:';
                    alert(`${switchAccountFailedText} ${error.message}`);
                }
            }
        }
        
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÂ§ö‰∏™Ë¥¶Êà∑
        async function checkMultipleAccounts() {
            if (typeof window.ethereum === 'undefined') return;
            
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 1) {
                    const accountInfo = document.getElementById('account-info-panel');
                    const tip = document.getElementById('account-hint');
                    if (tip) {
                        if (typeof i18n !== 'undefined') {
                            tip.textContent = i18n.t('multiAccountHint', { count: accounts.length });
                        } else {
                            tip.innerHTML = `üí° ÊèêÁ§∫ÔºöÊ£ÄÊµãÂà∞ ${accounts.length} ‰∏™Ë¥¶Êà∑ÔºåÂèØÁÇπÂáª"ÂàáÊç¢Ë¥¶Êà∑"ÊåâÈíÆÂàáÊç¢`;
                        }
                    }
                }
            } catch (error) {
                console.warn('Ê£ÄÊü•Ë¥¶Êà∑Â§±Ë¥•:', error);
            }
        }
        
        // Ê≥®ÊÑèÔºöÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÂ∑≤ÁªèÂú®ËÑöÊú¨ÂºÄÂ§¥ËÆæÁΩÆÔºà1534Ë°åÔºâÔºåËøôÈáå‰∏çÈúÄË¶ÅÈáçÂ§çËÆæÁΩÆ
        
        // ÁõëÂê¨Ë¥¶Êà∑ÂàáÊç¢‰∫ã‰ª∂
        function setupAccountChangeListener() {
            if (typeof window.ethereum === 'undefined') return;
            
            // ÁõëÂê¨Ë¥¶Êà∑ÂèòÂåñ
            window.ethereum.on('accountsChanged', async (accounts) => {
                try {
                    if (accounts.length === 0) {
                        // Áî®Êà∑Êñ≠ÂºÄËøûÊé•
                        const connectBtnText = typeof i18n !== 'undefined' ? i18n.t('connectWallet') : 'Connect Wallet';
                        document.getElementById('wallet-status').innerHTML = `
                            <button id="connect-btn" onclick="connectWallet()" data-i18n="connectWallet">${connectBtnText}</button>
                        `;
                        const accountInfoPanel = document.getElementById('account-info-panel');
                        if (accountInfoPanel) accountInfoPanel.style.display = 'none';
                        document.getElementById('driver-interface').style.display = 'none';
                        document.getElementById('bottom-nav').style.display = 'none';
                } else if (accounts[0] !== account) {
                    // Ë¥¶Êà∑Â∑≤ÂàáÊç¢
                    account = accounts[0];
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    
                    if (CONTRACT_ADDRESSES.rideOrder) {
                        contracts.rideOrder = new ethers.Contract(
                            CONTRACT_ADDRESSES.rideOrder,
                            TRUST_FLOW_RIDE_ABI,
                            signer
                        );
                    }
                    
                    document.getElementById('current-account-display').textContent = account;
                    const i18nPrefixChanged = typeof i18n !== 'undefined' ? i18n : null;
                    const accountChangedText = i18nPrefixChanged ? i18nPrefixChanged.t('accountChanged') : 'Account Changed';
                    document.getElementById('wallet-status').innerHTML = `
                        <div class="status info">
                            üîÑ ${accountChangedText}: ${account.substring(0, 6)}...${account.substring(38)}
                        </div>
                    `;
                    
                        await loadAvailableOrders();
                    }
                } catch (error) {
                    // ÊçïËé∑Êâ©Â±ïÊ∂àÊÅØÈÄöÈÅìÈîôËØØÔºåÈÅøÂÖçÂú®ÊéßÂà∂Âè∞ÊòæÁ§∫
                    const errorMessage = error?.message || error?.toString() || '';
                    if (errorMessage.includes('message channel closed') || 
                        errorMessage.includes('listener indicated an asynchronous response')) {
                        console.debug('ÂøΩÁï•Êâ©Â±ïÊ∂àÊÅØÈÄöÈÅìÈîôËØØÔºàaccountsChangedÔºâ');
                        return;
                    }
                    console.error('Ë¥¶Êà∑ÂàáÊç¢Â§ÑÁêÜÈîôËØØ:', error);
                }
            });
            
            // ÁõëÂê¨ÈìæIDÂèòÂåñ
            window.ethereum.on('chainChanged', (chainId) => {
                try {
                    // ÈìæÂàáÊç¢ÂêéÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢
                    window.location.reload();
                } catch (error) {
                    // ÊçïËé∑Êâ©Â±ïÊ∂àÊÅØÈÄöÈÅìÈîôËØØ
                    const errorMessage = error?.message || error?.toString() || '';
                    if (errorMessage.includes('message channel closed') || 
                        errorMessage.includes('listener indicated an asynchronous response')) {
                        console.debug('ÂøΩÁï•Êâ©Â±ïÊ∂àÊÅØÈÄöÈÅìÈîôËØØÔºàchainChangedÔºâ');
                        return;
                    }
                    // Â¶ÇÊûúÈ°µÈù¢Ê≠£Âú®Âç∏ËΩΩÔºåÂøΩÁï•ÈîôËØØ
                    if (document.readyState === 'unloading') {
                        return;
                    }
                    console.error('ÈìæÂàáÊç¢Â§ÑÁêÜÈîôËØØ:', error);
                }
            });
        }
        
        // ÊòæÁ§∫ÊµèËßàÂô®Ê†áËØÜ
        function displayBrowserInfo() {
            const browser = detectBrowser();
            const badge = document.getElementById('browser-badge');
            if (badge) {
                const i18nPrefix = typeof i18n !== 'undefined' ? i18n : null;
                const currentBrowserText = i18nPrefix ? i18nPrefix.t('currentBrowser') : 'Current Browser:';
                badge.textContent = `${currentBrowserText} ${browser}`;
            }
            // ÂáèÂ∞ëÊó•ÂøóËæìÂá∫‰ª•ÊèêÈ´òÊÄßËÉΩÔºàFirefox‰ºòÂåñÔºâ
            // console.log('ÊµèËßàÂô®‰ø°ÊÅØ / Browser Info:', {
            //     browser: browser,
            //     userAgent: navigator.userAgent.substring(0, 50) + '...'
            // });
        }
        
        // ÂàáÊç¢‰æßËæπÊ†èËèúÂçïÔºàË¶ÜÁõñÂç†‰ΩçÁ¨¶ÂáΩÊï∞Ôºâ
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar-menu');
            const overlay = document.getElementById('sidebar-overlay');
            const hamburger = document.getElementById('hamburger-menu');
            
            if (sidebar && overlay && hamburger) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
                hamburger.classList.toggle('active');
            }
        };
        
        // ÂàáÊç¢ËØ≠Ë®ÄËèúÂçïÔºàË¶ÜÁõñÂç†‰ΩçÁ¨¶ÂáΩÊï∞Ôºâ
        window.toggleLanguageMenu = function() {
            const langOptions = document.getElementById('language-options');
            if (langOptions) {
                const isVisible = langOptions.style.display !== 'none';
                langOptions.style.display = isVisible ? 'none' : 'block';
            }
        };
        
        // ÈÄâÊã©ËØ≠Ë®ÄÔºàË¶ÜÁõñÂç†‰ΩçÁ¨¶ÂáΩÊï∞Ôºâ
        window.selectLanguage = function(lang) {
            if (typeof i18n === 'undefined') {
                console.error('i18n not loaded');
                return;
            }
            
            i18n.setLanguage(lang);
            
            // Êõ¥Êñ∞ËØ≠Ë®ÄÈÄâÈ°πÁä∂ÊÄÅ
            document.querySelectorAll('.lang-option').forEach(opt => {
                opt.classList.remove('active');
            });
            const activeOption = document.getElementById('lang-option-' + lang);
            if (activeOption) {
                activeOption.classList.add('active');
            }
            
            // Êõ¥Êñ∞ÈÄâ‰∏≠Ê†áËÆ∞
            const checkEn = document.getElementById('lang-check-en');
            const checkZh = document.getElementById('lang-check-zh');
            if (checkEn) checkEn.style.display = lang === 'en' ? 'inline' : 'none';
            if (checkZh) checkZh.style.display = lang === 'zh' ? 'inline' : 'none';
            
            // Êõ¥Êñ∞ÂΩìÂâçËØ≠Ë®ÄÊòæÁ§∫
            const currentLang = document.getElementById('current-lang');
            if (currentLang) {
                currentLang.textContent = lang === 'en' ? 'EN' : '‰∏≠Êñá';
            }
            
            // ÂÖ≥Èó≠ËØ≠Ë®ÄÈÄâÈ°π
            const langOptions = document.getElementById('language-options');
            if (langOptions) {
                langOptions.style.display = 'none';
            }
            
            // Êõ¥Êñ∞È°µÈù¢ÊñáÊú¨
            if (typeof i18n !== 'undefined' && i18n.updatePage) {
                i18n.updatePage();
            }
            
            // Êõ¥Êñ∞ÊµèËßàÂô®Ê†áËØÜ
            displayBrowserInfo();
            
            // Êõ¥Êñ∞‰∏ªÊ†áÈ¢òÔºàÊ†πÊçÆÂΩìÂâçËßÜÂõæÔºâ
            const availableView = document.getElementById('available-orders-view');
            const myOrdersView = document.getElementById('my-orders-view');
            const profileView = document.getElementById('profile-view');
            
            if (availableView && availableView.style.display === 'block') {
                updateMainHeader('availableOrdersTitle', 'availableOrdersSubtitle');
            } else if (myOrdersView && myOrdersView.style.display === 'block') {
                updateMainHeader('myOrdersTitle', 'myOrdersSubtitle');
            } else if (profileView && profileView.style.display === 'block') {
                updateMainHeader('profileTitle', 'profileSubtitle');
            } else {
                // ÈªòËÆ§ÊòæÁ§∫Âè∏Êú∫Á´ØÊ†áÈ¢ò
                updateMainHeader('driverApp', 'driverAppSubtitle');
            }
            
            // ÈáçÊñ∞Êõ¥Êñ∞Ë¥¶Êà∑ÊèêÁ§∫ÔºàÂ¶ÇÊûúÊúâÂ§öË¥¶Êà∑Ôºâ
            if (account && window.ethereum) {
                checkMultipleAccounts();
            }
            
            // ÈáçÊñ∞Âä†ËΩΩÂèØÁî®ËÆ¢ÂçïÂàóË°®‰ª•Êõ¥Êñ∞ÊñáÊú¨
            if (contracts.rideOrder && window.loadAvailableOrders) {
                window.loadAvailableOrders();
            }
            
            // ÈáçÊñ∞Ê∏≤ÊüìËÆ¢ÂçïÂàóË°®‰ª•Êõ¥Êñ∞Ë¥πÁî®ÊòéÁªÜÁöÑÊñáÊú¨
            if (window.myOrders && window.filterMyOrders) {
                // Ëé∑ÂèñÂΩìÂâçÊøÄÊ¥ªÁöÑÁ≠õÈÄâ
                const activeFilter = document.querySelector('.filter-tab.active')?.getAttribute('onclick')?.match(/filterMyOrders\('(\w+)'\)/)?.[1] || 'all';
                window.filterMyOrders(activeFilter);
            }
            
            // ÈáçÊñ∞Âä†ËΩΩProfile‰ª•Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØÊñáÊú¨
            if (account && window.loadProfile) {
                window.loadProfile();
            }
        };
        
        // ‰ªé‰æßËæπÊ†èÂØºËà™
        function navigateFromSidebar(view) {
            if (view === 'available') {
                showAvailableOrdersView();
            } else if (view === 'my-orders') {
                showMyOrdersView();
            } else if (view === 'profile') {
                showProfileView();
            }
            toggleSidebar(); // ÂÖ≥Èó≠‰æßËæπÊ†è
        }
        
        // Êõ¥Êñ∞‰æßËæπÊ†èÊ¥ªÂä®Áä∂ÊÄÅ
        function updateSidebarActive(navId) {
            document.querySelectorAll('.sidebar-menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            let sidebarId = '';
            if (navId === 'nav-available') {
                sidebarId = 'sidebar-nav-available';
            } else if (navId === 'nav-my-orders') {
                sidebarId = 'sidebar-nav-my-orders';
            } else if (navId === 'nav-profile') {
                sidebarId = 'sidebar-nav-profile';
            }
            
            const activeItem = document.getElementById(sidebarId);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }
        
        // ËßÜÂõæÂàáÊç¢ÂáΩÊï∞
        function setActiveNav(navId) {
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeNav = document.getElementById(navId);
            if (activeNav) activeNav.classList.add('active');
            
            // ÂêåÊó∂Êõ¥Êñ∞‰æßËæπÊ†èÊ¥ªÂä®Áä∂ÊÄÅ
            updateSidebarActive(navId);
        }
        
        // Êõ¥Êñ∞‰∏ªÊ†áÈ¢ò
        function updateMainHeader(titleKey, subtitleKey) {
            const titleElement = document.getElementById('main-header-title');
            const subtitleElement = document.getElementById('main-header-subtitle');
            const i18nPrefix = typeof i18n !== 'undefined' ? i18n : null;
            
            if (titleElement && titleKey) {
                const titleText = i18nPrefix ? i18nPrefix.t(titleKey) : titleKey;
                // Â¶ÇÊûúÊòØÈªòËÆ§ÁöÑ driverAppÔºåÊòæÁ§∫ÂÆåÊï¥Ê†ºÂºèÔºåÂê¶ÂàôÂè™ÊòæÁ§∫ËßÜÂõæÊ†áÈ¢ò
                if (titleKey === 'driverApp') {
                    titleElement.innerHTML = `üöó TrustFlow - <span data-i18n="${titleKey}">${titleText}</span>`;
                } else {
                    titleElement.innerHTML = `üöó ${titleText}`;
                }
            }
            
            if (subtitleElement && subtitleKey) {
                const subtitleText = i18nPrefix ? i18nPrefix.t(subtitleKey) : subtitleKey;
                subtitleElement.textContent = subtitleText;
                // Êõ¥Êñ∞ data-i18n Â±ûÊÄß‰ª•‰æøËØ≠Ë®ÄÂàáÊç¢Êó∂Êõ¥Êñ∞
                subtitleElement.setAttribute('data-i18n', subtitleKey);
            }
        }
        
        function showAvailableOrdersView() {
            setActiveNav('nav-available');
            document.getElementById('available-orders-view').style.display = 'block';
            document.getElementById('my-orders-view').style.display = 'none';
            document.getElementById('profile-view').style.display = 'none';
            
            // Êõ¥Êñ∞‰∏ªÊ†áÈ¢ò
            updateMainHeader('availableOrdersTitle', 'availableOrdersSubtitle');
            
            // ÈöêËóèË¥¶Êà∑‰ø°ÊÅØÈù¢ÊùøÔºà‰∏çÂú®ProfileËßÜÂõæ‰∏≠Ôºâ
            const accountInfoPanel = document.getElementById('account-info-panel');
            if (accountInfoPanel) accountInfoPanel.style.display = 'none';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            if (contracts.rideOrder) loadAvailableOrders();
        }
        
        function showMyOrdersView() {
            setActiveNav('nav-my-orders');
            document.getElementById('available-orders-view').style.display = 'none';
            document.getElementById('my-orders-view').style.display = 'block';
            document.getElementById('profile-view').style.display = 'none';
            
            // Êõ¥Êñ∞‰∏ªÊ†áÈ¢ò
            updateMainHeader('myOrdersTitle', 'myOrdersSubtitle');
            
            // ÈöêËóèË¥¶Êà∑‰ø°ÊÅØÈù¢ÊùøÔºà‰∏çÂú®ProfileËßÜÂõæ‰∏≠Ôºâ
            const accountInfoPanel = document.getElementById('account-info-panel');
            if (accountInfoPanel) accountInfoPanel.style.display = 'none';
            
            // Á°Æ‰øùAllÊåâÈíÆË¢´ÈÄâ‰∏≠Âπ∂Â∫îÁî®activeÊ†∑Âºè
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.background = 'transparent';
                tab.style.color = '#6b7280';
                tab.style.fontWeight = '500';
                tab.style.border = 'none';
            });
            const allTab = document.querySelector('.filter-tab[onclick*="filterMyOrders(\'all\')"]');
            if (allTab) {
                allTab.classList.add('active');
                allTab.style.background = 'transparent';
                allTab.style.color = '#3b82f6';
                allTab.style.fontWeight = '600';
                allTab.style.border = 'none';
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            if (contracts.rideOrder) {
                loadMyOrders();
                // Á°Æ‰øùÈªòËÆ§ÊòæÁ§∫AllÁ≠õÈÄâ
                filterMyOrders('all');
            }
        }
        
        function showProfileView() {
            setActiveNav('nav-profile');
            document.getElementById('available-orders-view').style.display = 'none';
            document.getElementById('my-orders-view').style.display = 'none';
            document.getElementById('profile-view').style.display = 'block';
            
            // Êõ¥Êñ∞‰∏ªÊ†áÈ¢ò
            updateMainHeader('profileTitle', 'profileSubtitle');
            
            // ÊòæÁ§∫Ë¥¶Êà∑‰ø°ÊÅØÈù¢ÊùøÔºà‰ªÖÂú®ProfileËßÜÂõæ‰∏≠Ôºâ
            const accountInfoPanel = document.getElementById('account-info-panel');
            if (accountInfoPanel && account) {
                accountInfoPanel.style.display = 'flex';
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            if (account) loadProfile();
        }
        
        // Âä†ËΩΩÊàëÁöÑËÆ¢Âçï
        async function loadMyOrders(showLoading = true) {
            if (!contracts.rideOrder || !account) return;
            
            // Èò≤Ê≠¢Âπ∂ÂèëÂä†ËΩΩ
            if (isLoadingMyOrders) {
                console.log('‚è∏Ô∏è ÊàëÁöÑËÆ¢ÂçïÊ≠£Âú®Âä†ËΩΩ‰∏≠ÔºåË∑≥ËøáÊú¨Ê¨°ËØ∑Ê±Ç');
                return;
            }
            
            isLoadingMyOrders = true;
            
            const loadingState = document.getElementById('my-orders-loading');
            const emptyState = document.getElementById('my-orders-empty');
            const ordersList = document.getElementById('my-orders-list');
            
            // Âè™Âú®È¶ñÊ¨°Âä†ËΩΩÊàñÊòéÁ°ÆÈúÄË¶ÅÊó∂ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            if (showLoading && (!lastMyOrdersData || lastMyOrdersData.length === 0)) {
                if (loadingState) loadingState.style.display = 'block';
                if (emptyState) emptyState.style.display = 'none';
            }
            
            try {
                // Ëé∑ÂèñÂè∏Êú∫ÁöÑËÆ¢ÂçïIDÂàóË°®
                const orderIds = await contracts.rideOrder.getDriverOrders(account);
                const myOrders = [];
                
                // ‰ºòÂåñÔºöÊâπÈáèËé∑ÂèñËÆ¢ÂçïÔºàÂπ∂Ë°åÂ§ÑÁêÜÔºå‰ΩÜÈôêÂà∂Âπ∂ÂèëÊï∞‰ª•ÈÅøÂÖçÈòªÂ°ûÔºâ
                const BATCH_SIZE = 10; // ÊØèÊâπÂ§ÑÁêÜ10‰∏™ËÆ¢Âçï
                
                for (let batchStart = 0; batchStart < orderIds.length; batchStart += BATCH_SIZE) {
                    const batchEnd = Math.min(batchStart + BATCH_SIZE, orderIds.length);
                    const batchPromises = [];
                    
                    // ÂàõÂª∫ÊâπÈáèËØ∑Ê±Ç
                    for (let i = batchStart; i < batchEnd; i++) {
                        batchPromises.push(
                            contracts.rideOrder.getOrder(orderIds[i]).catch(err => {
                                // Âçï‰∏™ËÆ¢ÂçïÂ§±Ë¥•‰∏çÂΩ±ÂìçÂÖ∂‰ªñËÆ¢Âçï
                                return null;
                            })
                        );
                    }
                    
                    // Á≠âÂæÖÂΩìÂâçÊâπÊ¨°ÂÆåÊàê
                    const batchResults = await Promise.all(batchPromises);
                    
                    // Â§ÑÁêÜÁªìÊûú
                    for (let j = 0; j < batchResults.length; j++) {
                        const order = batchResults[j];
                        if (!order) continue; // Ë∑≥ËøáÂ§±Ë¥•ÁöÑËÆ¢Âçï
                        
                        try {
                            myOrders.push({
                                orderId: order.orderId.toNumber(),
                                passenger: order.passenger,
                                driver: order.driver,
                                pickup: order.pickup,
                                destination: order.destination,
                                estimatedFare: order.estimatedFare ? (typeof order.estimatedFare === 'string' ? order.estimatedFare : ethers.utils.formatEther(order.estimatedFare)) : '0',
                                actualFare: order.actualFare ? (typeof order.actualFare === 'string' ? order.actualFare : ethers.utils.formatEther(order.actualFare)) : null,
                                status: typeof order.status === 'number' ? order.status : order.status.toNumber(),
                                rideStatus: typeof order.rideStatus === 'number' ? order.rideStatus : (order.rideStatus ? order.rideStatus.toNumber() : 0),
                                category: order.category || 'General',
                                subCategory: order.subCategory || 'Standard',
                                createdAt: new Date(order.createdAt.toNumber() * 1000),
                                acceptedAt: order.acceptedAt.toNumber() > 0 ? new Date(order.acceptedAt.toNumber() * 1000) : null,
                                pickedUpAt: order.pickedUpAt && order.pickedUpAt.toNumber() > 0 ? new Date(order.pickedUpAt.toNumber() * 1000) : null,
                                completedAt: order.completedAt.toNumber() > 0 ? new Date(order.completedAt.toNumber() * 1000) : null,
                                startTimestamp: order.startTimestamp && order.startTimestamp.toNumber() > 0 ? new Date(order.startTimestamp.toNumber() * 1000) : null,
                                endTimestamp: order.endTimestamp && order.endTimestamp.toNumber() > 0 ? new Date(order.endTimestamp.toNumber() * 1000) : null,
                                disputeOpened: order.disputeOpened !== undefined ? order.disputeOpened : false,
                                disputeReason: order.disputeReason || '',
                                disputeResolved: order.disputeResolved !== undefined ? order.disputeResolved : false,
                                disputeWinner: order.disputeWinner && order.disputeWinner !== ethers.constants.AddressZero ? order.disputeWinner : null,
                                disputeOpenedAt: order.disputeOpenedAt && order.disputeOpenedAt.toNumber() > 0 ? new Date(order.disputeOpenedAt.toNumber() * 1000) : null,
                                disputeResolvedAt: order.disputeResolvedAt && order.disputeResolvedAt.toNumber() > 0 ? new Date(order.disputeResolvedAt.toNumber() * 1000) : null
                            });
                        } catch (error) {
                            // Ë∑≥ËøáÂ§ÑÁêÜÂ§±Ë¥•ÁöÑËÆ¢Âçï
                            continue;
                        }
                    }
                    
                    // Âú® Firefox ‰∏≠ÔºåÁªôÊµèËßàÂô®‰∏Ä‰∫õÂñòÊÅØÊó∂Èó¥ÔºàÈÅøÂÖçÈòªÂ°ûUIÔºâ
                    if (batchEnd < orderIds.length) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                }
                
                // Ê£ÄÊü•Êï∞ÊçÆÊòØÂê¶ÁúüÁöÑÂèòÂåñ‰∫ÜÔºàÈÅøÂÖç‰∏çÂøÖË¶ÅÁöÑÈáçÊñ∞Ê∏≤ÊüìÔºâ
                const dataChanged = JSON.stringify(lastMyOrdersData?.map(o => ({
                    orderId: o.orderId,
                    status: o.status,
                    rideStatus: o.rideStatus,
                    disputeOpened: o.disputeOpened,
                    disputeResolved: o.disputeResolved
                }))) !== JSON.stringify(myOrders.map(o => ({
                    orderId: o.orderId,
                    status: o.status,
                    rideStatus: o.rideStatus,
                    disputeOpened: o.disputeOpened,
                    disputeResolved: o.disputeResolved
                })));
                
                if (!dataChanged && lastMyOrdersData && lastMyOrdersData.length > 0) {
                    console.log('üìä ÊàëÁöÑËÆ¢ÂçïÊï∞ÊçÆÊú™ÂèòÂåñÔºåË∑≥ËøáÈáçÊñ∞Ê∏≤Êüì');
                    isLoadingMyOrders = false;
                    if (loadingState) loadingState.style.display = 'none';
                    return;
                }
                
                lastMyOrdersData = myOrders;
                
                // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáè‰æõÁ≠õÈÄâ‰ΩøÁî®
                window.myOrders = myOrders;
                
                // Ê∏≤ÊüìËÆ¢ÂçïÂàóË°®
                filterMyOrders('all');
                
            } catch (error) {
                console.error('Âä†ËΩΩÊàëÁöÑËÆ¢ÂçïÂ§±Ë¥•:', error);
                if (ordersList) {
                    ordersList.innerHTML = `
                        <div class="empty-state">
                            <h2 style="color: var(--error-color);">Âä†ËΩΩÂ§±Ë¥•</h2>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            } finally {
                isLoadingMyOrders = false;
                if (loadingState) loadingState.style.display = 'none';
            }
        }
        
        // Á≠õÈÄâÊàëÁöÑËÆ¢Âçï
        let lastFilteredMyOrdersKey = null;
        let lastFilterMyOrders = null;
        
        async function filterMyOrders(filter) {
            const ordersList = document.getElementById('my-orders-list');
            const statisticsView = document.getElementById('my-orders-statistics');
            
            // Êõ¥Êñ∞Á≠õÈÄâÊ†áÁ≠æÁä∂ÊÄÅ - È´ò‰∫ÆÊòæÁ§∫ÂΩìÂâçÈÄâ‰∏≠ÁöÑTab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.background = 'transparent';
                tab.style.color = '#6b7280';
                tab.style.fontWeight = '500';
                tab.style.border = 'none';
            });
            
            // ÊâæÂà∞ÂØπÂ∫îÁöÑTabÂπ∂È´ò‰∫ÆÔºå‰ΩøÁî®ËìùËâ≤ÊñáÂ≠óÂíå‰∏ãÂàíÁ∫ø
            const targetTab = document.querySelector(`.filter-tab[onclick*="filterMyOrders('${filter}')"]`);
            if (targetTab) {
                targetTab.classList.add('active');
                targetTab.style.background = 'transparent';
                targetTab.style.color = '#3b82f6';
                targetTab.style.fontWeight = '600';
                targetTab.style.border = 'none';
            } else if (event?.target) {
                event.target.classList.add('active');
                event.target.style.background = 'transparent';
                event.target.style.color = '#3b82f6';
                event.target.style.fontWeight = '600';
                event.target.style.border = 'none';
            }
            
            // Â¶ÇÊûúÊòØÁªüËÆ°ËßÜÂõæÔºåÊòæÁ§∫ÁªüËÆ°ÂõæË°®
            if (filter === 'statistics') {
                if (ordersList) ordersList.style.display = 'none';
                if (statisticsView) {
                    statisticsView.style.display = 'block';
                    renderDriverDailyOrdersChart();
                }
                return;
            }
            
            // Âê¶ÂàôÈöêËóèÁªüËÆ°ËßÜÂõæÔºåÊòæÁ§∫ËÆ¢ÂçïÂàóË°®
            if (statisticsView) statisticsView.style.display = 'none';
            if (ordersList) ordersList.style.display = 'block';
            
            if (!window.myOrders) {
                const emptyState = document.getElementById('my-orders-empty');
                if (emptyState) emptyState.style.display = 'block';
                return;
            }
            
            const emptyState = document.getElementById('my-orders-empty');
            
            let filteredOrders = window.myOrders;
            
            if (filter === 'accepted') {
                filteredOrders = window.myOrders.filter(o => o.status === 1);
            } else if (filter === 'completed') {
                filteredOrders = window.myOrders.filter(o => o.status === 3);
            } else if (filter === 'cancelled') {
                filteredOrders = window.myOrders.filter(o => o.status === 4);
            }
            
            // Ê£ÄÊü•Êï∞ÊçÆÊòØÂê¶ÁúüÁöÑÂèòÂåñ‰∫ÜÔºàÈÅøÂÖç‰∏çÂøÖË¶ÅÁöÑÈáçÊñ∞Ê∏≤ÊüìÔºâ
            const currentFilterKey = JSON.stringify({
                filter: filter,
                orders: filteredOrders.map(o => ({
                    orderId: o.orderId,
                    status: o.status,
                    rideStatus: o.rideStatus,
                    disputeOpened: o.disputeOpened,
                    disputeResolved: o.disputeResolved
                }))
            });
            
            if (currentFilterKey === lastFilteredMyOrdersKey && lastFilterMyOrders === filter && ordersList && ordersList.innerHTML.trim() !== '') {
                console.log('üìä ÊàëÁöÑËÆ¢ÂçïÁ≠õÈÄâÊï∞ÊçÆÊú™ÂèòÂåñÔºåË∑≥ËøáÈáçÊñ∞Ê∏≤Êüì');
                return;
            }
            
            lastFilteredMyOrdersKey = currentFilterKey;
            lastFilterMyOrders = filter;
            
            const statusNames = {
                0: 'Pending',
                1: 'Accepted',
                2: 'Picked Up',
                3: 'Completed',
                4: 'Cancelled'
            };
            
            if (filteredOrders.length === 0) {
                ordersList.innerHTML = '';
                if (emptyState) emptyState.style.display = 'block';
                return;
            }
            
            if (emptyState) emptyState.style.display = 'none';
            
            // ÊâπÈáèËé∑Âèñ‰πòÂÆ¢‰ø°ÊÅØÔºà‰ªéÂêéÁ´ØAPIËé∑ÂèñÔºâ
            const passengerInfoMap = new Map();
            try {
                const uniquePassengers = [...new Set(filteredOrders.map(o => o.passenger))];
                if (uniquePassengers.length > 0) {
                    const userInfoResponse = await fetch('/api/user-info/batch', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ addresses: uniquePassengers })
                    });
                    
                    if (userInfoResponse.ok) {
                        const result = await userInfoResponse.json();
                        if (result.success && result.data) {
                            // Â∞ÜÂú∞ÂùÄÊò†Â∞ÑÂà∞ËÆ¢ÂçïID
                            filteredOrders.forEach(order => {
                                const userInfo = result.data[order.passenger] || { id: null, nickname: null, contact: null };
                                passengerInfoMap.set(order.orderId, {
                                    nickname: userInfo.nickname || null,
                                    contact: userInfo.contact || null
                                });
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('ÊâπÈáèËé∑Âèñ‰πòÂÆ¢‰ø°ÊÅØÂ§±Ë¥•:', error);
            }
            
            ordersList.innerHTML = filteredOrders.map(order => {
                // Ëé∑Âèñ‰πòÂÆ¢‰ø°ÊÅØ
                const passengerInfo = passengerInfoMap.get(order.orderId) || { nickname: null, contact: null };
                const passengerNickname = passengerInfo.nickname || null;
                const passengerContact = passengerInfo.contact || null;
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                
                // ‰πòÂÆ¢‰ø°ÊÅØÊòæÁ§∫HTML
                const passengerInfoHtml = `
                    <div style="margin-bottom: 12px; padding: 12px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 10px; border: 1px solid #bae6fd;">
                        <div style="font-size: 12px; font-weight: 700; color: #0369a1; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                            üë§ ${isZh ? '‰πòÂÆ¢‰ø°ÊÅØ / Passenger Info' : 'Passenger Info'}
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            ${passengerNickname ? `
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 11px; color: #6b7280; font-weight: 500; min-width: 60px;">${isZh ? 'ÊòµÁß∞ / Name' : 'Name'}:</span>
                                <span style="font-size: 13px; font-weight: 600; color: #1e40af;">${passengerNickname}</span>
                            </div>
                            ` : ''}
                            ${passengerContact ? `
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 11px; color: #6b7280; font-weight: 500; min-width: 60px;">${isZh ? 'ËÅîÁ≥ªÊñπÂºè / Contact' : 'Contact'}:</span>
                                <span style="font-size: 12px; color: #6b7280;">${passengerContact}</span>
                            </div>
                            ` : ''}
                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                                <span style="font-size: 11px; color: #6b7280; font-weight: 500; min-width: 60px;">${isZh ? 'Âú∞ÂùÄ / Address' : 'Address'}:</span>
                                <span onclick="copyToClipboard('${order.passenger}'); this.style.background='#e0e7ff'; setTimeout(()=>this.style.background='',300)" style="font-size: 11px; color: #1e40af; font-family: 'Monaco', 'Menlo', 'Courier New', monospace; cursor: pointer; padding: 2px 6px; border-radius: 4px; transition: background 0.2s;" title="${isZh ? 'ÁÇπÂáªÂ§çÂà∂ / Click to copy' : 'Click to copy'}">
                                    ${order.passenger.substring(0, 6)}...${order.passenger.substring(38)}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                
                // Ride Status Ê†áÁ≠æÂíåÊåâÈíÆÈÄªËæë
                const rideStatusNames = {
                    0: { name: 'NONE', color: '#9ca3af', bg: '#f3f4f6' },
                    1: { name: 'CREATED', color: '#3b82f6', bg: '#dbeafe' },
                    2: { name: 'ACCEPTED', color: '#6366f1', bg: '#e0e7ff' },
                    3: { name: 'IN_PROGRESS', color: '#f59e0b', bg: '#fef3c7' },
                    4: { name: 'COMPLETED', color: '#10b981', bg: '#d1fae5' },
                    5: { name: 'SETTLED', color: '#059669', bg: '#d1fae5' }
                };
                const rideStatus = order.rideStatus !== undefined ? order.rideStatus : (order.status === 0 ? 1 : (order.status === 1 ? 2 : (order.status === 2 ? 3 : (order.status === 3 ? 4 : 0))));
                const statusInfo = rideStatusNames[rideStatus] || rideStatusNames[0];
                const rideStatusLabel = isZh ? 
                    (rideStatus === 1 ? 'Â∑≤ÂàõÂª∫' : rideStatus === 2 ? 'Â∑≤Êé•Âçï' : rideStatus === 3 ? 'ËøõË°å‰∏≠' : rideStatus === 4 ? 'Â∑≤ÂÆåÊàê' : rideStatus === 5 ? 'Â∑≤ÁªìÁÆó' : 'Êó†Áä∂ÊÄÅ') :
                    statusInfo.name;
                
                // Ê†πÊçÆ RideStatus ÊòæÁ§∫‰∏çÂêåÁöÑÊìç‰ΩúÊåâÈíÆ
                let actionButtons = '';
                if (rideStatus === 1) {
                    // CREATED Áä∂ÊÄÅÔºöÊòæÁ§∫"Êé•Âçï"ÊåâÈíÆÔºàRide LifecycleÔºâ
                    const acceptRideText = isZh ? 'Êé•Âçï' : 'Accept Ride';
                    actionButtons = `
                        <button class="btn-accept" onclick="acceptRide(${order.orderId})" style="width: 100%; margin-top: 10px; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            üöó ${acceptRideText}
                        </button>
                    `;
                } else if (rideStatus === 2) {
                    // ACCEPTED Áä∂ÊÄÅÔºöÊòæÁ§∫"ÂºÄÂßãË°åÁ®ã"ÊåâÈíÆ
                    const startRideText = isZh ? 'ÂºÄÂßãË°åÁ®ã' : 'Start Ride';
                    actionButtons = `
                        <button class="btn-start" onclick="startRide(${order.orderId})" style="width: 100%; margin-top: 10px; padding: 10px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            üöÄ ${startRideText}
                        </button>
                    `;
                } else if (rideStatus === 3) {
                    // IN_PROGRESS Áä∂ÊÄÅÔºöÊòæÁ§∫"ÁªìÊùüË°åÁ®ã"ÊåâÈíÆ + ÂÄíËÆ°Êó∂
                    const completeRideText = isZh ? 'ÁªìÊùüË°åÁ®ã' : 'Complete Ride';
                    const countdownId = `countdown-${order.orderId}`;
                    actionButtons = `
                        <div id="${countdownId}" style="margin-top: 10px; padding: 8px; background: #fef3c7; border-radius: 6px; text-align: center; color: #92400e; font-weight: 600; margin-bottom: 8px;">
                            ‚è±Ô∏è ${isZh ? 'Ë°åÁ®ãËøõË°å‰∏≠...' : 'Ride in progress...'}
                        </div>
                        <button class="btn-complete" onclick="completeRide(${order.orderId})" style="width: 100%; padding: 10px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            ‚úÖ ${completeRideText}
                        </button>
                    `;
                    // ÂêØÂä®ÂÄíËÆ°Êó∂Ôºà10ÁßíÊ®°ÊãüÔºâ
                    if (order.startTimestamp) {
                        const startTime = order.startTimestamp.getTime();
                        const updateCountdown = () => {
                            const elapsed = Math.floor((Date.now() - startTime) / 1000);
                            const countdownEl = document.getElementById(countdownId);
                            if (countdownEl) {
                                countdownEl.innerHTML = `‚è±Ô∏è ${isZh ? 'Ë°åÁ®ãËøõË°å‰∏≠' : 'Ride in progress'} (${elapsed}s)`;
                            }
                        };
                        const intervalId = setInterval(updateCountdown, 1000);
                        updateCountdown();
                        // Ê∏ÖÁêÜÔºöÂΩìËÆ¢ÂçïÁä∂ÊÄÅÊîπÂèòÊó∂Ê∏ÖÈô§ÂÆöÊó∂Âô®ÔºàÂú®ËÆ¢ÂçïÈáçÊñ∞Âä†ËΩΩÊó∂‰ºöË¢´Ê∏ÖÈô§Ôºâ
                        setTimeout(() => clearInterval(intervalId), 60000);
                    }
                } else if (rideStatus === 4) {
                    // COMPLETED Áä∂ÊÄÅÔºöÊòæÁ§∫"Á≠âÂæÖÁªìÁÆó"ÊèêÁ§∫
                    const waitingText = isZh ? 'Á≠âÂæÖÂπ≥Âè∞Ëá™Âä®ÁªìÁÆóÊàñ‰πòÂÆ¢Á°ÆËÆ§' : 'Waiting for platform settlement or passenger confirmation';
                    actionButtons = `
                        <div style="margin-top: 10px; padding: 10px; background: #dbeafe; border-radius: 6px; text-align: center; color: #1e40af; font-weight: 500;">
                            ‚è≥ ${waitingText}
                            ${order.completedAt ? '<br><small>' + order.completedAt.toLocaleString() + '</small>' : ''}
                        </div>
                    `;
                } else if (rideStatus === 5) {
                    // SETTLED Áä∂ÊÄÅÔºö‰∏çÊòæÁ§∫È¢ùÂ§ñ‰ø°ÊÅØÔºàÂõ†‰∏∫‰∏äÈù¢Â∑≤ÁªèÊúâÁä∂ÊÄÅÊòæÁ§∫‰∫ÜÔºâ
                    actionButtons = '';
                }
                
                // Ê£ÄÊü•ÊòØÂê¶Êúâ‰∫âËÆÆÔºàÂ∑≤Êèê‰∫§‰ΩÜÊú™Ëß£ÂÜ≥Ôºâ
                const disputeOpened = order.disputeOpened || false;
                const disputeResolved = order.disputeResolved || false;
                const hasActiveDispute = disputeOpened && !disputeResolved; // Âè™Êúâ‰∫âËÆÆÂ∑≤Êèê‰∫§‰ΩÜÊú™Ëß£ÂÜ≥Êó∂ÊâçËÆ§‰∏∫ÊòØÊ¥ªË∑É‰∫âËÆÆ
                
                // Ê£ÄÊü•ËÆ¢ÂçïÁä∂ÊÄÅÔºà‰∏éuserÁ´Ø‰øùÊåÅ‰∏ÄËá¥Ôºâ
                let orderStatus = order.status;
                if (typeof orderStatus === 'number') {
                    orderStatus = orderStatus;
                } else if (orderStatus && typeof orderStatus.toNumber === 'function') {
                    orderStatus = orderStatus.toNumber();
                } else if (typeof orderStatus === 'string') {
                    orderStatus = parseInt(orderStatus) || 0;
                } else {
                    orderStatus = parseInt(orderStatus) || 0;
                }
                
                let displayRideStatusLabel = rideStatusLabel;
                let displayStatusInfo = statusInfo;
                
                // Â¶ÇÊûúËÆ¢ÂçïÂ∑≤ÂÆåÊàêÔºàstatus === 3 Êàñ rideStatus === 4Ôºâ‰∏îÊúâÊ¥ªË∑É‰∫âËÆÆÔºàÂ∑≤Êèê‰∫§‰ΩÜÊú™Ëß£ÂÜ≥ÔºâÔºåÊòæÁ§∫ Completed/Disputed
                if ((orderStatus === 3 || rideStatus === 4) && hasActiveDispute) {
                    displayRideStatusLabel = isZh ? 'Â∑≤ÂÆåÊàê/‰∫âËÆÆ‰∏≠' : 'Completed/Disputed';
                    displayStatusInfo = { name: 'COMPLETED/DISPUTED', color: '#991b1b', bg: '#fee2e2' };
                }
                
                // Ê∑ªÂä† Ride Status Ê†áÁ≠æÔºàÂè™Âú®rideStatusÊèê‰æõÈ¢ùÂ§ñ‰ø°ÊÅØÊó∂ÊòæÁ§∫ÔºåÈÅøÂÖç‰∏éorder statusÈáçÂ§çÔºâ
                // Âè™Âú®rideStatus‰∏éorder.status‰∏ç‰∏ÄËá¥ÔºåÊàñËÄÖÊúâÈ¢ùÂ§ñÊó∂Èó¥‰ø°ÊÅØÊó∂ÊòæÁ§∫
                const shouldShowRideStatus = (rideStatus !== 0 && rideStatus !== 1) || order.startTimestamp || order.endTimestamp || disputeOpened;
                const rideStatusBadge = shouldShowRideStatus ? `
                    <div style="margin-bottom: 10px; padding: 8px; background: ${displayStatusInfo.bg}; border-radius: 8px; border: 1px solid ${displayStatusInfo.color};">
                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px; text-transform: uppercase;">${isZh ? 'Ë°åÁ®ãÁä∂ÊÄÅ / Ride Status' : 'Ride Status'}:</div>
                        <div style="font-size: 13px; font-weight: 700; color: ${displayStatusInfo.color};">
                            ${displayRideStatusLabel}
                        </div>
                        ${order.startTimestamp ? `<div style="font-size: 11px; color: #6b7280; margin-top: 4px;">${isZh ? 'ÂºÄÂßãÊó∂Èó¥' : 'Start'}: ${order.startTimestamp.toLocaleString()}</div>` : ''}
                        ${order.endTimestamp ? `<div style="font-size: 11px; color: #6b7280; margin-top: 2px;">${isZh ? 'ÁªìÊùüÊó∂Èó¥' : 'End'}: ${order.endTimestamp.toLocaleString()}</div>` : ''}
                    </div>
                ` : '';
                
                // Âà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅÊ∑ªÂä†disputedÁ±ªÔºàÂè™Ë¶ÅÊúâ‰∫âËÆÆÂ∞±ÊòæÁ§∫‰∫âËÆÆËæπÊ°ÜÔºåÂåÖÊã¨Â∑≤Ëß£ÂÜ≥ÁöÑÔºâ
                const isDisputed = disputeOpened || false;
                
                return `
                    <div class="order-card${isDisputed ? ' disputed' : ''}">
                        <div class="order-header">
                            <div>
                                <div class="order-date" style="font-size: 13px;">${order.createdAt.toLocaleString()}</div>
                                <div class="order-id" style="font-size: 11px;">Order #${order.orderId}</div>
                            </div>
                        </div>
                        ${passengerInfoHtml}
                        ${rideStatusBadge}
                        <div class="order-route">
                            <div class="route-point">
                                <div class="route-icon pickup">A</div>
                                <div class="route-address" style="font-size: 14px;">${order.pickup.addressText || `${order.pickup.latitude.toNumber() / 1e6}, ${order.pickup.longitude.toNumber() / 1e6}`}</div>
                            </div>
                            <div class="route-line"></div>
                            <div class="route-point">
                                <div class="route-icon destination">B</div>
                                <div class="route-address" style="font-size: 14px;">${order.destination.addressText || `${order.destination.latitude.toNumber() / 1e6}, ${order.destination.longitude.toNumber() / 1e6}`}</div>
                            </div>
                        </div>
                        <div class="order-footer">
                            ${(() => {
                                // Ê†πÊçÆËÆ¢ÂçïÁä∂ÊÄÅÂÜ≥ÂÆöÊòæÁ§∫ÁöÑË¥πÁî®ÂÄº
                                const ETH_TO_USD_RATE = 2500;
                                const PLATFORM_FEE_RATE = 0.05;
                                
                                let fareToDisplay, fareUSD, feeDetailsHtml = '';
                                let netEarnedETH, netEarnedUSD, platformFeeETH, totalGasETH;
                                
                                if (order.status === 3) {
                                    // CompletedÁä∂ÊÄÅÔºöÊòæÁ§∫ÂÆûÈôÖË¥πÁî®ÔºàÂ¶ÇÊûúÂ∑≤ËÆæÁΩÆÔºâÔºåÂê¶ÂàôÊòæÁ§∫È¢Ñ‰º∞Ë¥πÁî®
                                    fareToDisplay = parseFloat(order.actualFare && order.actualFare !== '0' && order.actualFare !== '0.0' ? order.actualFare : order.estimatedFare);
                                    fareUSD = (fareToDisplay * ETH_TO_USD_RATE).toFixed(2);
                                    
                                    // ËÆ°ÁÆóË¥πÁî®ÊòéÁªÜ
                                    platformFeeETH = (fareToDisplay * PLATFORM_FEE_RATE).toFixed(8);
                                    const platformFeeUSD = (parseFloat(platformFeeETH) * ETH_TO_USD_RATE).toFixed(2);
                                    
                                    // ‰º∞ÁÆóGasË¥πÁî®
                                    const acceptGasETH = '0.0001'; // Êé•ÂèóËÆ¢ÂçïÊó∂ÁöÑGasË¥πÁî®
                                    const completeGasETH = '0.0003'; // ÂÆåÊàêËÆ¢ÂçïÊó∂ÁöÑGasË¥πÁî®
                                    totalGasETH = (parseFloat(acceptGasETH) + parseFloat(completeGasETH)).toFixed(8);
                                    const acceptGasUSD = (parseFloat(acceptGasETH) * ETH_TO_USD_RATE).toFixed(2);
                                    const completeGasUSD = (parseFloat(completeGasETH) * ETH_TO_USD_RATE).toFixed(2);
                                    const totalGasUSD = (parseFloat(totalGasETH) * ETH_TO_USD_RATE).toFixed(2);
                                    
                                    // ËÆ°ÁÆóÂÆûÈôÖÊî∂ÁõäÔºàÊÄªË¥πÁî® - Âπ≥Âè∞Ë¥π - GasË¥πÔºâ
                                    netEarnedETH = (fareToDisplay - parseFloat(platformFeeETH) - parseFloat(totalGasETH)).toFixed(8);
                                    netEarnedUSD = (parseFloat(netEarnedETH) * ETH_TO_USD_RATE).toFixed(2);
                                    
                                    // ËÆ°ÁÆóÁôæÂàÜÊØîÔºàÂÆûÈôÖÊî∂Áõä / ËÆ¢ÂçïÈáëÈ¢ù * 100Ôºâ
                                    const netPercentage = fareToDisplay > 0 ? ((parseFloat(netEarnedETH) / fareToDisplay) * 100).toFixed(1) : '0.0';
                                    
                                    const isZhOrder = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                                    
                                    feeDetailsHtml = `
                                        <div style="margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                                            <div style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 10px;">
                                                üí∞ ${isZh ? 'Ë¥πÁî®ÊòéÁªÜ / Fee Breakdown' : 'Fee Breakdown'}
                                            </div>
                                            
                                            <!-- Âπ≥Âè∞Ë¥πÁî® -->
                                            <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span style="font-size: 12px; color: #6b7280;">${isZh ? 'Âπ≥Âè∞Ë¥πÁî® (5%)' : 'Platform Fee (5%)'}</span>
                                                    <span style="font-size: 13px; font-weight: 600; color: #dc2626;">
                                                        -${platformFeeETH} ETH <span style="color: #6b7280; font-size: 11px;">(-$${platformFeeUSD})</span>
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <!-- ÊÄªGasË¥πÁî® -->
                                            <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span style="font-size: 12px; color: #6b7280;">${isZh ? 'Network Fee (Êé•Âèó + ÂÆåÊàê)' : 'Network Fee (Accept + Complete)'}</span>
                                                    <span style="font-size: 13px; font-weight: 600; color: #d97706;">
                                                        -${totalGasETH} ETH <span style="color: #6b7280; font-size: 11px;">(-$${totalGasUSD})</span>
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <!-- Ë¥πÁî®ÊòéÁªÜËØ¥Êòé -->
                                            <div style="margin-top: 12px; padding: 10px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
                                                <div style="font-size: 11px; color: #6b7280; line-height: 1.5;">
                                                    ${isZh ? 'üí° ÂÆûÈôÖÊî∂Áõä = ËÆ¢ÂçïÈáëÈ¢ù - Âπ≥Âè∞Ë¥π(5%) - Network Fee' : 'üí° Actual Earnings = Order Amount - Platform Fee(5%) - Network Fee'}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                } else if (order.status === 2) {
                                    // Picked UpÁä∂ÊÄÅÔºöÊòæÁ§∫È¢Ñ‰º∞Ë¥πÁî®ÂèäÊòéÁªÜ
                                    fareToDisplay = parseFloat(order.estimatedFare);
                                    fareUSD = (fareToDisplay * ETH_TO_USD_RATE).toFixed(2);
                                    
                                    // ËÆ°ÁÆóÈ¢Ñ‰º∞Ë¥πÁî®ÊòéÁªÜ
                                    platformFeeETH = (fareToDisplay * PLATFORM_FEE_RATE).toFixed(8);
                                    const platformFeeUSD = (parseFloat(platformFeeETH) * ETH_TO_USD_RATE).toFixed(2);
                                    
                                    // ‰º∞ÁÆóGasË¥πÁî®
                                    const acceptGasETH = '0.0001'; // Êé•ÂèóËÆ¢ÂçïÊó∂ÁöÑGasË¥πÁî®ÔºàÂ∑≤ÊîØ‰ªòÔºâ
                                    const completeGasETH = '0.0003'; // ÂÆåÊàêËÆ¢ÂçïÊó∂ÁöÑGasË¥πÁî®ÔºàÈ¢Ñ‰º∞Ôºâ
                                    totalGasETH = (parseFloat(acceptGasETH) + parseFloat(completeGasETH)).toFixed(8);
                                    const acceptGasUSD = (parseFloat(acceptGasETH) * ETH_TO_USD_RATE).toFixed(2);
                                    const completeGasUSD = (parseFloat(completeGasETH) * ETH_TO_USD_RATE).toFixed(2);
                                    const totalGasUSD = (parseFloat(totalGasETH) * ETH_TO_USD_RATE).toFixed(2);
                                    
                                    // ËÆ°ÁÆóÈ¢Ñ‰º∞ÂáÄÊî∂Áõä
                                    netEarnedETH = (fareToDisplay - parseFloat(platformFeeETH) - parseFloat(totalGasETH)).toFixed(8);
                                    netEarnedUSD = (parseFloat(netEarnedETH) * ETH_TO_USD_RATE).toFixed(2);
                                    
                                    // ËÆ°ÁÆóÁôæÂàÜÊØîÔºàÈ¢Ñ‰º∞ÂáÄÊî∂Áõä / ËÆ¢ÂçïÈáëÈ¢ù * 100Ôºâ
                                    const netPercentage = fareToDisplay > 0 ? ((parseFloat(netEarnedETH) / fareToDisplay) * 100).toFixed(1) : '0.0';
                                    
                                    const isZhOrder = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                                    
                                    feeDetailsHtml = `
                                        <div style="margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                                            <div style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 10px;">
                                                üí∞ ${isZh ? 'È¢Ñ‰º∞Ë¥πÁî®ÊòéÁªÜ / Estimated Fee Breakdown' : 'Estimated Fee Breakdown'}
                                            </div>
                                            
                                            <!-- Âπ≥Âè∞Ë¥πÁî® -->
                                            <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span style="font-size: 12px; color: #6b7280;">${isZh ? 'Âπ≥Âè∞Ë¥πÁî® (5%)' : 'Platform Fee (5%)'}</span>
                                                    <span style="font-size: 13px; font-weight: 600; color: #dc2626;">
                                                        -${platformFeeETH} ETH <span style="color: #6b7280; font-size: 11px;">(-$${platformFeeUSD})</span>
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <!-- ÊÄªGasË¥πÁî® -->
                                            <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span style="font-size: 12px; color: #6b7280;">${isZh ? 'Network Fee (Êé•Âèó + ÂÆåÊàê)' : 'Network Fee (Accept + Complete)'}</span>
                                                    <span style="font-size: 13px; font-weight: 600; color: #d97706;">
                                                        -${totalGasETH} ETH <span style="color: #6b7280; font-size: 11px;">(-$${totalGasUSD})</span>
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <!-- Ë¥πÁî®ÊòéÁªÜËØ¥Êòé -->
                                            <div style="margin-top: 12px; padding: 10px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
                                                <div style="font-size: 11px; color: #6b7280; line-height: 1.5;">
                                                    ${isZh ? 'üí° È¢Ñ‰º∞ÂáÄÊî∂Áõä = ËÆ¢ÂçïÈáëÈ¢ù - Âπ≥Âè∞Ë¥π(5%) - Network Fee (Êé•Âèó + ÂÆåÊàê)' : 'üí° Estimated Net Income = Order Amount - Platform Fee(5%) - Network Fee (Accept + Complete)'}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    // ÂÖ∂‰ªñÁä∂ÊÄÅÔºöÊòæÁ§∫È¢Ñ‰º∞Ë¥πÁî®ÂèäÊòéÁªÜ
                                    fareToDisplay = parseFloat(order.estimatedFare);
                                    fareUSD = (fareToDisplay * ETH_TO_USD_RATE).toFixed(2);
                                    
                                    // ËÆ°ÁÆóÈ¢Ñ‰º∞Ë¥πÁî®ÊòéÁªÜ
                                    platformFeeETH = (fareToDisplay * PLATFORM_FEE_RATE).toFixed(8);
                                    const platformFeeUSD = (parseFloat(platformFeeETH) * ETH_TO_USD_RATE).toFixed(2);
                                    
                                    // ‰º∞ÁÆóGasË¥πÁî®
                                    const acceptGasETH = '0.0001'; // Êé•ÂèóËÆ¢ÂçïÊó∂ÁöÑGasË¥πÁî®ÔºàÈ¢Ñ‰º∞Ôºâ
                                    const completeGasETH = '0.0003'; // ÂÆåÊàêËÆ¢ÂçïÊó∂ÁöÑGasË¥πÁî®ÔºàÈ¢Ñ‰º∞Ôºâ
                                    totalGasETH = (parseFloat(acceptGasETH) + parseFloat(completeGasETH)).toFixed(8);
                                    const acceptGasUSD = (parseFloat(acceptGasETH) * ETH_TO_USD_RATE).toFixed(2);
                                    const completeGasUSD = (parseFloat(completeGasETH) * ETH_TO_USD_RATE).toFixed(2);
                                    const totalGasUSD = (parseFloat(totalGasETH) * ETH_TO_USD_RATE).toFixed(2);
                                    
                                    // ËÆ°ÁÆóÈ¢Ñ‰º∞ÂáÄÊî∂Áõä
                                    netEarnedETH = (fareToDisplay - parseFloat(platformFeeETH) - parseFloat(totalGasETH)).toFixed(8);
                                    netEarnedUSD = (parseFloat(netEarnedETH) * ETH_TO_USD_RATE).toFixed(2);
                                    
                                    // ËÆ°ÁÆóÁôæÂàÜÊØîÔºàÈ¢Ñ‰º∞ÂáÄÊî∂Áõä / ËÆ¢ÂçïÈáëÈ¢ù * 100Ôºâ
                                    const netPercentage = fareToDisplay > 0 ? ((parseFloat(netEarnedETH) / fareToDisplay) * 100).toFixed(1) : '0.0';
                                    
                                    const isZhOrder = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                                    
                                    feeDetailsHtml = `
                                        <div style="margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                                            <div style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 10px;">
                                                üí∞ ${isZh ? 'È¢Ñ‰º∞Ë¥πÁî®ÊòéÁªÜ / Estimated Fee Breakdown' : 'Estimated Fee Breakdown'}
                                            </div>
                                            
                                            <!-- Âπ≥Âè∞Ë¥πÁî® -->
                                            <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span style="font-size: 12px; color: #6b7280;">${isZh ? 'Âπ≥Âè∞Ë¥πÁî® (5%)' : 'Platform Fee (5%)'}</span>
                                                    <span style="font-size: 13px; font-weight: 600; color: #dc2626;">
                                                        -${platformFeeETH} ETH <span style="color: #6b7280; font-size: 11px;">(-$${platformFeeUSD})</span>
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <!-- ÊÄªGasË¥πÁî® -->
                                            <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span style="font-size: 12px; color: #6b7280;">${isZh ? 'Network Fee (Êé•Âèó + ÂÆåÊàê)' : 'Network Fee (Accept + Complete)'}</span>
                                                    <span style="font-size: 13px; font-weight: 600; color: #d97706;">
                                                        -${totalGasETH} ETH <span style="color: #6b7280; font-size: 11px;">(-$${totalGasUSD})</span>
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <!-- Ë¥πÁî®ÊòéÁªÜËØ¥Êòé -->
                                            <div style="margin-top: 12px; padding: 10px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
                                                <div style="font-size: 11px; color: #6b7280; line-height: 1.5;">
                                                    ${isZh ? 'üí° È¢Ñ‰º∞ÂáÄÊî∂Áõä = ËÆ¢ÂçïÈáëÈ¢ù - Âπ≥Âè∞Ë¥π(5%) - Network Fee (Êé•Âèó + ÂÆåÊàê)' : 'üí° Estimated Net Income = Order Amount - Platform Fee(5%) - Network Fee (Accept + Complete)'}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                // Á°Æ‰øùÂáÄÊî∂ÁõäÂ∑≤ËÆ°ÁÆóÔºàÂ¶ÇÊûúÊú™ËÆ°ÁÆóÔºåÂàôËÆ°ÁÆóÔºâ
                                if (!netEarnedETH) {
                                    if (!platformFeeETH) {
                                        platformFeeETH = (fareToDisplay * PLATFORM_FEE_RATE).toFixed(8);
                                    }
                                    if (!totalGasETH) {
                                        totalGasETH = '0.0004'; // ÈªòËÆ§ÂÄº
                                    }
                                    netEarnedETH = (fareToDisplay - parseFloat(platformFeeETH) - parseFloat(totalGasETH)).toFixed(8);
                                    netEarnedUSD = (parseFloat(netEarnedETH) * ETH_TO_USD_RATE).toFixed(2);
                                }
                                const isNetIncome = order.status !== 3;
                                
                                return `
                                    <div>
                                        <!-- ËÆ¢ÂçïÈáëÈ¢ùÂíåÂáÄÊî∂ÁõäÂπ∂ÂàóÊòæÁ§∫ -->
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                            <div style="padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 6px; font-weight: 500;">${isZh ? 'ËÆ¢ÂçïÈáëÈ¢ù / Order Amount' : 'Order Amount'}</div>
                                                <div style="font-size: 16px; font-weight: 700; color: #1f2937;">
                                                    ${fareToDisplay.toFixed(8)} ETH
                                                </div>
                                                <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                                    ($${fareUSD} USD)
                                                </div>
                                            </div>
                                            <div style="padding: 12px; background: ${order.status === 3 ? '#d1fae5' : '#dbeafe'}; border-radius: 8px; border: 1px solid ${order.status === 3 ? '#10b981' : '#3b82f6'};">
                                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 6px; font-weight: 500;">${isNetIncome ? (isZh ? 'È¢Ñ‰º∞ÂáÄÊî∂Áõä / Est. Net Income' : 'Estimated Net Income') : (isZh ? 'ÂÆûÈôÖÊî∂Áõä / Actual Earnings' : 'Actual Earnings')}</div>
                                                <div style="font-size: 16px; font-weight: 700; color: ${order.status === 3 ? '#059669' : '#1e40af'};">
                                                    ${parseFloat(netEarnedETH) > 0 ? netEarnedETH : '0.00000000'} ETH
                                                </div>
                                                <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                                    ($${netEarnedUSD} USD)
                                                </div>
                                            </div>
                                        </div>
                                        ${feeDetailsHtml}
                                    </div>
                                `;
                            })()}
                        </div>
                        ${actionButtons}
                        ${order.status >= 1 ? `
                        <button onclick="viewOrderDetail(${order.orderId})" style="width: 100%; margin-top: 10px; padding: 10px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px;">
                            üìã ${typeof i18n !== 'undefined' && i18n.currentLang === 'zh' ? 'Êü•ÁúãËØ¶ÊÉÖ / View Details' : 'View Details'}
                        </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Êü•ÁúãËÆ¢ÂçïËØ¶ÊÉÖÔºàÂåÖÊã¨ËµÑÈáëÊµÅÂêëÔºâ- ‰ΩøÁî®Ê®°ÊÄÅÂØπËØùÊ°Ü
        async function viewOrderDetail(orderId) {
            const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
            
            if (!contracts.rideOrder) {
                alert(isZh ? 'ÂêàÁ∫¶Êú™ÂàùÂßãÂåñÔºÅ' : 'Contract not initialized!');
                return;
            }
            
            const orderModal = document.getElementById('order-modal');
            const orderModalBody = document.getElementById('order-modal-body');
            const orderModalTitle = document.getElementById('order-modal-title');
            
            if (!orderModal || !orderModalBody) {
                console.error('ËÆ¢ÂçïËØ¶ÊÉÖÊ®°ÊÄÅÂØπËØùÊ°Ü‰∏çÂ≠òÂú®');
                return;
            }
            
            try {
                orderModalBody.innerHTML = '<div style="text-align: center; padding: 20px;">Âä†ËΩΩ‰∏≠...</div>';
                if (orderModalTitle) {
                    orderModalTitle.textContent = isZh ? `ËÆ¢Âçï #${orderId} ËØ¶ÊÉÖ` : `Order #${orderId} Details`;
                }
                orderModal.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // Èò≤Ê≠¢ËÉåÊôØÊªöÂä®
                
                const order = await contracts.rideOrder.getOrder(orderId);
                
                // Ëé∑ÂèñÊúÄÊñ∞ÁöÑ‰∫âËÆÆÁä∂ÊÄÅÔºà‰ΩøÁî®getDisputeStatusËÄå‰∏çÊòØorderÂØπË±°‰∏≠ÁöÑÂ≠óÊÆµÔºâ
                let latestDisputeStatus = null;
                try {
                    latestDisputeStatus = await contracts.rideOrder.getDisputeStatus(orderId);
                } catch (error) {
                    console.warn('Ëé∑Âèñ‰∫âËÆÆÁä∂ÊÄÅÂ§±Ë¥•Ôºå‰ΩøÁî®orderÂØπË±°‰∏≠ÁöÑÂ≠óÊÆµ:', error);
                }
                
                // ‰ΩøÁî®ÊúÄÊñ∞ÁöÑ‰∫âËÆÆÁä∂ÊÄÅÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®orderÂØπË±°‰∏≠ÁöÑÂ≠óÊÆµ
                const disputeOpened = latestDisputeStatus ? latestDisputeStatus.disputeOpened : (order.disputeOpened || false);
                const disputeResolved = latestDisputeStatus ? latestDisputeStatus.disputeResolved : (order.disputeResolved || false);
                const disputeReason = latestDisputeStatus ? latestDisputeStatus.disputeReason : (order.disputeReason || '');
                const disputeWinner = latestDisputeStatus ? latestDisputeStatus.disputeWinner : (order.disputeWinner || ethers.constants.AddressZero);
                const disputeOpenedAt = order.disputeOpenedAt ? new Date(order.disputeOpenedAt.toNumber() * 1000).toLocaleString() : '';
                const disputeResolvedAt = order.disputeResolvedAt ? new Date(order.disputeResolvedAt.toNumber() * 1000).toLocaleString() : '';
                
                const ETH_TO_USD_RATE = 2500;
                const PLATFORM_FEE_RATE = 0.05;
                
                const contractAddress = window.contracts?.rideOrder?.address || window.CONTRACT_ADDRESSES?.rideOrder || 'N/A';
                const passengerAddr = order.passenger || 'N/A';
                const driverAddr = order.driver && order.driver !== ethers.constants.AddressZero ? order.driver : account;
                const fareToDisplay = parseFloat(order.actualFare && order.actualFare.toString() !== '0' ? ethers.utils.formatEther(order.actualFare) : ethers.utils.formatEther(order.estimatedFare));
                const orderAmountETH = fareToDisplay.toFixed(8);
                const orderAmountUSD = (fareToDisplay * ETH_TO_USD_RATE).toFixed(2);
                const platformFeeETH = (fareToDisplay * PLATFORM_FEE_RATE).toFixed(8);
                const platformFeeUSD = (parseFloat(platformFeeETH) * ETH_TO_USD_RATE).toFixed(2);
                const driverAmountETH = (fareToDisplay - parseFloat(platformFeeETH)).toFixed(8);
                const driverAmountUSD = (parseFloat(driverAmountETH) * ETH_TO_USD_RATE).toFixed(2);
                
                function formatAddress(addr, maxLength = 10) {
                    if (!addr || addr === 'N/A') return addr;
                    if (addr.length <= maxLength * 2 + 2) return addr;
                    return addr.substring(0, maxLength) + '...' + addr.substring(addr.length - maxLength);
                }
                
                orderModalBody.innerHTML = `
                    <div style="position: relative;">
                        <h4 style="margin-bottom: 16px; color: var(--primary-color); font-size: 16px; font-weight: 700;">${isZh ? 'üí∞ ËµÑÈáëÊµÅÂêë / Fund Flow' : 'üí∞ Fund Flow'}</h4>
                        <div style="background: #f9fafb; border-radius: 12px; padding: 20px; margin-bottom: 12px;">
                            <!-- ÂàõÂª∫ËÆ¢ÂçïÊó∂ÁöÑËµÑÈáëÊµÅÂêë -->
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                    ${isZh ? 'üì§ ÂàõÂª∫ËÆ¢ÂçïÊó∂ / When Order Created' : 'üì§ When Order Created'}
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 12px;">
                                    <div style="flex: 1; min-width: 140px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
                                        <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase;">${isZh ? '‰ªé / From' : 'From'}</div>
                                        <div onclick="copyToClipboard('${passengerAddr}'); this.style.background='#e0e7ff'; setTimeout(()=>this.style.background='',300)" style="font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 12px; color: var(--primary-color); font-weight: 600; word-break: break-all; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" title="${isZh ? 'ÁÇπÂáªÂ§çÂà∂ / Click to copy' : 'Click to copy'}">
                                            ${formatAddress(passengerAddr)}
                                        </div>
                                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${isZh ? '‰πòÂÆ¢ / Passenger' : 'Passenger'}</div>
                                    </div>
                                    <div style="flex-shrink: 0; padding: 8px 0;">
                                        <div style="font-size: 20px; color: var(--primary-color);">‚Üí</div>
                                    </div>
                                    <div style="flex: 1; min-width: 140px; padding: 12px; background: white; border-radius: 8px; border: 2px solid var(--primary-color);">
                                        <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase;">${isZh ? 'Âà∞ / To' : 'To'}</div>
                                        <div onclick="copyToClipboard('${contractAddress}'); this.style.background='#e0e7ff'; setTimeout(()=>this.style.background='',300)" style="font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 12px; color: var(--primary-color); font-weight: 600; word-break: break-all; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" title="${isZh ? 'ÁÇπÂáªÂ§çÂà∂ / Click to copy' : 'Click to copy'}">
                                            ${formatAddress(contractAddress)}
                                        </div>
                                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${isZh ? 'Êô∫ËÉΩÂêàÁ∫¶ / Contract' : 'Smart Contract'}</div>
                                    </div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #e0e7ff; border-radius: 6px; margin-top: 8px;">
                                    <span style="font-size: 14px; font-weight: 700; color: var(--primary-color);">
                                        ${orderAmountETH} ETH
                                    </span>
                                    <span style="font-size: 12px; color: #6b7280; margin-left: 8px;">
                                        ($${orderAmountUSD} USD)
                                    </span>
                                </div>
                            </div>
                            
                            ${order.status === 3 && driverAddr && driverAmountETH ? `
                            <!-- ËÆ¢ÂçïÂÆåÊàêÂêéÁöÑËµÑÈáëÊµÅÂêë -->
                            <div style="margin-bottom: 20px; padding-top: 20px; border-top: 2px solid #10b981;">
                                <div style="font-size: 13px; font-weight: 600; color: #059669; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                    ‚úÖ ${isZh ? 'ËÆ¢ÂçïÂÆåÊàêÊó∂ / When Order Completed' : 'When Order Completed'}
                                </div>
                                
                                <!-- Âè∏Êú∫Êî∂Ê¨æ -->
                                <div style="margin-bottom: 16px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 12px;">
                                        <div style="flex: 1; min-width: 140px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
                                            <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase;">${isZh ? '‰ªé / From' : 'From'}</div>
                                            <div style="font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 12px; color: var(--primary-color); font-weight: 600; word-break: break-all;">
                                                ${formatAddress(contractAddress)}
                                            </div>
                                            <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${isZh ? 'Êô∫ËÉΩÂêàÁ∫¶ / Contract' : 'Smart Contract'}</div>
                                        </div>
                                        <div style="flex-shrink: 0; padding: 8px 0;">
                                            <div style="font-size: 20px; color: #10b981;">‚Üí</div>
                                        </div>
                                        <div style="flex: 1; min-width: 140px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #10b981;">
                                            <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase;">${isZh ? 'Âà∞ / To' : 'To'}</div>
                                            <div onclick="copyToClipboard('${driverAddr}'); this.style.background='#e0e7ff'; setTimeout(()=>this.style.background='',300)" style="font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 12px; color: #059669; font-weight: 600; word-break: break-all; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" title="${isZh ? 'ÁÇπÂáªÂ§çÂà∂ / Click to copy' : 'Click to copy'}">
                                                ${formatAddress(driverAddr)}
                                            </div>
                                            <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${isZh ? 'Âè∏Êú∫ / Driver (ÊÇ®)' : 'Driver (You)'}</div>
                                        </div>
                                    </div>
                                    <div style="text-align: center; padding: 8px; background: #d1fae5; border-radius: 6px; margin-top: 8px;">
                                        <span style="font-size: 14px; font-weight: 700; color: #059669;">
                                            ${driverAmountETH} ETH
                                        </span>
                                        <span style="font-size: 12px; color: #6b7280; margin-left: 8px;">
                                            ($${driverAmountUSD} USD)
                                        </span>
                                        <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">${isZh ? 'ËÆ¢ÂçïÈáëÈ¢ù - Âπ≥Âè∞Ë¥π' : 'Order Amount - Platform Fee'}</div>
                                    </div>
                                </div>
                                
                                <!-- Âπ≥Âè∞Ë¥π -->
                                ${parseFloat(platformFeeETH) > 0 ? `
                                <div>
                                    <div style="display: flex; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 12px;">
                                        <div style="flex: 1; min-width: 140px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
                                            <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase;">${isZh ? '‰ªé / From' : 'From'}</div>
                                            <div style="font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 12px; color: var(--primary-color); font-weight: 600; word-break: break-all;">
                                                ${formatAddress(contractAddress)}
                                            </div>
                                            <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${isZh ? 'Êô∫ËÉΩÂêàÁ∫¶ / Contract' : 'Smart Contract'}</div>
                                        </div>
                                        <div style="flex-shrink: 0; padding: 8px 0;">
                                            <div style="font-size: 20px; color: #f59e0b;">‚Üí</div>
                                        </div>
                                        <div style="flex: 1; min-width: 140px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #f59e0b;">
                                            <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase;">${isZh ? 'Âà∞ / To' : 'To'}</div>
                                            <div style="font-size: 12px; color: #d97706; font-weight: 600;">
                                                ${isZh ? 'Âπ≥Âè∞Èí±ÂåÖ / Platform Wallet' : 'Platform Wallet'}
                                            </div>
                                            <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${isZh ? 'Âπ≥Âè∞Ë¥π 5%' : 'Platform Fee 5%'}</div>
                                        </div>
                                    </div>
                                    <div style="text-align: center; padding: 8px; background: #fef3c7; border-radius: 6px; margin-top: 8px;">
                                        <span style="font-size: 14px; font-weight: 700; color: #d97706;">
                                            ${platformFeeETH} ETH
                                        </span>
                                        <span style="font-size: 12px; color: #6b7280; margin-left: 8px;">
                                            ($${platformFeeUSD} USD)
                                        </span>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            ` : order.status === 1 ? `
                            <!-- Â∑≤Êé•ÂçïÁä∂ÊÄÅÔºöÊòæÁ§∫È¢Ñ‰º∞ËµÑÈáëÊµÅÂêë -->
                            <div style="margin-bottom: 20px; padding-top: 20px; border-top: 2px solid #3b82f6;">
                                <div style="font-size: 13px; font-weight: 600; color: #1e40af; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                    ‚è≥ ${isZh ? 'ËÆ¢ÂçïÂÆåÊàêÊó∂ÔºàÈ¢Ñ‰º∞Ôºâ / When Order Completed (Est.)' : 'When Order Completed (Estimated)'}
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 12px;">
                                    <div style="flex: 1; min-width: 140px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
                                        <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase;">${isZh ? '‰ªé / From' : 'From'}</div>
                                        <div style="font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 12px; color: var(--primary-color); font-weight: 600; word-break: break-all;">
                                            ${formatAddress(contractAddress)}
                                        </div>
                                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${isZh ? 'Êô∫ËÉΩÂêàÁ∫¶ / Contract' : 'Smart Contract'}</div>
                                    </div>
                                    <div style="flex-shrink: 0; padding: 8px 0;">
                                        <div style="font-size: 20px; color: #3b82f6;">‚Üí</div>
                                    </div>
                                    <div style="flex: 1; min-width: 140px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #3b82f6;">
                                        <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase;">${isZh ? 'Âà∞ / To' : 'To'}</div>
                                        <div onclick="copyToClipboard('${driverAddr}'); this.style.background='#e0e7ff'; setTimeout(()=>this.style.background='',300)" style="font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 12px; color: #1e40af; font-weight: 600; word-break: break-all; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" title="${isZh ? 'ÁÇπÂáªÂ§çÂà∂ / Click to copy' : 'Click to copy'}">
                                            ${formatAddress(driverAddr)}
                                        </div>
                                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${isZh ? 'Âè∏Êú∫ / Driver (ÊÇ®)' : 'Driver (You)'}</div>
                                    </div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #dbeafe; border-radius: 6px; margin-top: 8px;">
                                    <span style="font-size: 14px; font-weight: 700; color: #1e40af;">
                                        ${driverAmountETH} ETH
                                    </span>
                                    <span style="font-size: 12px; color: #6b7280; margin-left: 8px;">
                                        ($${driverAmountUSD} USD)
                                    </span>
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">${isZh ? 'È¢Ñ‰º∞Êî∂ÁõäÔºàËÆ¢ÂçïÈáëÈ¢ù - Âπ≥Âè∞Ë¥πÔºâ' : 'Estimated Earnings (Order Amount - Platform Fee)'}</div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        <div style="font-size: 11px; color: #9ca3af; margin-top: 8px; padding: 8px; background: #f3f4f6; border-radius: 6px; text-align: center;">
                            üí° ${isZh ? 'ÊèêÁ§∫ÔºöÁÇπÂáªÂú∞ÂùÄÂèØÂ§çÂà∂Âà∞Ââ™Ë¥¥Êùø' : 'Tip: Click address to copy to clipboard'}
                        </div>
                    </div>
                    
                    <!-- Dispute Section -->
                    <div class="dispute-section" id="dispute-section-${orderId}" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <h3 style="margin-bottom: 16px; color: #1f2937; font-size: 16px; font-weight: 700;">${isZh ? '‚öñÔ∏è ‰∫âËÆÆÂ§ÑÁêÜ / Dispute' : '‚öñÔ∏è Dispute'}</h3>
                        <!-- ‰∫âËÆÆÁä∂ÊÄÅÊòæÁ§∫Âå∫ÂüüÔºàÁî±updateDisputeUIDriverÊõ¥Êñ∞Ôºâ -->
                        <div id="driver-dispute-status-${orderId}"></div>
                        <!-- ‰∫âËÆÆ‰ø°ÊÅØÊòæÁ§∫Âå∫ÂüüÔºàÁî±updateDisputeUIDriverÊõ¥Êñ∞Ôºâ -->
                        <div id="driver-dispute-info-${orderId}"></div>
                        <!-- ‰∫âËÆÆË°®ÂçïÂå∫ÂüüÔºàÁî±updateDisputeUIDriverÊõ¥Êñ∞Ôºâ -->
                        <div id="driver-dispute-form-${orderId}"></div>
                    </div>
                `;
                
                // Âä†ËΩΩÂπ∂Êõ¥Êñ∞ Dispute UI
                updateDisputeUIDriver(orderId, order);
                
            } catch (error) {
                console.error('Âä†ËΩΩËÆ¢ÂçïËØ¶ÊÉÖÂ§±Ë¥•:', error);
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                orderModalBody.innerHTML = `<div style="color: #ef4444; padding: 10px;">${isZh ? 'Âä†ËΩΩÂ§±Ë¥•: ' : 'Failed to load: '}${error.message}</div>`;
            }
        }
        
        // ÂÖ≥Èó≠ËÆ¢ÂçïËØ¶ÊÉÖÊ®°ÊÄÅÂØπËØùÊ°Ü
        window.closeOrderModal = function() {
            const orderModal = document.getElementById('order-modal');
            const orderModalBody = document.getElementById('order-modal-body');
            if (orderModal) {
                orderModal.style.display = 'none';
                document.body.style.overflow = ''; // ÊÅ¢Â§çËÉåÊôØÊªöÂä®
            }
            if (orderModalBody) {
                orderModalBody.innerHTML = '';
            }
        };
        
        // Âä†ËΩΩ‰∫âËÆÆÁä∂ÊÄÅ
        async function loadDisputeStatus(orderId) {
            try {
                if (!contracts.rideOrder) {
                    return null;
                }
                const result = await contracts.rideOrder.getDisputeStatus(orderId);
                return {
                    disputeOpened: result.disputeOpened,
                    disputeReason: result.disputeReason,
                    disputeResolved: result.disputeResolved,
                    disputeOpener: result.disputeOpener,
                    disputeWinner: result.disputeWinner,
                    disputeOpenedAt: result.disputeOpenedAt,
                    disputeResolvedAt: result.disputeResolvedAt,
                    disputeResolutionDetail: result.disputeResolutionDetail,
                    rideStatus: result.rideStatus
                };
            } catch (error) {
                console.error('Âä†ËΩΩ‰∫âËÆÆÁä∂ÊÄÅÂ§±Ë¥•:', error);
                return null;
            }
        }
        
        // Êõ¥Êñ∞Âè∏Êú∫Á´Ø Dispute UI
        async function updateDisputeUIDriver(orderId, order) {
            const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
            const disputeStatusEl = document.getElementById(`driver-dispute-status-${orderId}`);
            const disputeInfoEl = document.getElementById(`driver-dispute-info-${orderId}`);
            const disputeFormEl = document.getElementById(`driver-dispute-form-${orderId}`);
            
            if (!disputeStatusEl || !disputeInfoEl || !disputeFormEl) {
                return;
            }
            
            // Âä†ËΩΩÊúÄÊñ∞ÁöÑ‰∫âËÆÆÁä∂ÊÄÅ
            const disputeStatus = await loadDisputeStatus(orderId);
            if (!disputeStatus) {
                disputeStatusEl.innerHTML = '<div style="color: #6b7280; font-size: 14px;">Êó†Ê≥ïÂä†ËΩΩ‰∫âËÆÆÁä∂ÊÄÅ</div>';
                return;
            }
            
            const rideStatus = disputeStatus.rideStatus || order.rideStatus || 0;
            const isAwaitingSettlement = rideStatus === 5; // AWAITING_SETTLEMENT = 5
            
            // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
            if (disputeStatus.disputeOpened) {
                const isActuallyResolved = disputeStatus.disputeResolved && disputeStatus.disputeWinner && disputeStatus.disputeWinner !== ethers.constants.AddressZero;
                if (isActuallyResolved) {
                    // ‰∫âËÆÆÂ∑≤Ëß£ÂÜ≥ÔºåÊòæÁ§∫Ëé∑ËÉúÊñπ‰ø°ÊÅØ
                    const isWinner = disputeStatus.disputeWinner && disputeStatus.disputeWinner.toLowerCase() === (account || '').toLowerCase();
                    disputeStatusEl.innerHTML = `
                        <div style="padding: 12px; background: ${isWinner ? '#d1fae5' : '#fee2e2'}; border-radius: 8px; border: 1px solid ${isWinner ? '#10b981' : '#ef4444'}; margin-bottom: 12px;">
                            <div style="font-size: 14px; font-weight: 600; color: ${isWinner ? '#065f46' : '#991b1b'};">
                                ${isWinner 
                                    ? (isZh ? '‚úÖ ‰∫âËÆÆÂ∑≤Ëß£ÂÜ≥ÔºåÊÇ®Ëé∑ËÉú' : '‚úÖ Dispute Resolved, You Won')
                                    : (isZh ? '‚ùå ‰∫âËÆÆÂ∑≤Ëß£ÂÜ≥ÔºåÂØπÊñπËé∑ËÉú' : '‚ùå Dispute Resolved, Opponent Won')}
                            </div>
                            <div style="font-size: 12px; color: ${isWinner ? '#047857' : '#991b1b'}; margin-top: 8px;">
                                ${isZh ? 'Ëé∑ËÉúÊñπ / Winner' : 'Winner'}: ${disputeStatus.disputeWinner ? (disputeStatus.disputeWinner.substring(0, 6) + '...' + disputeStatus.disputeWinner.substring(disputeStatus.disputeWinner.length - 4)) : 'N/A'}
                            </div>
                        </div>
                    `;
                } else {
                    // ‰∫âËÆÆÂ∑≤Êèê‰∫§‰ΩÜÊú™Ëß£ÂÜ≥
                    disputeStatusEl.innerHTML = `
                        <div style="padding: 12px; background: #fee2e2; border-radius: 8px; border: 1px solid #ef4444; margin-bottom: 12px;">
                            <div style="font-size: 14px; font-weight: 600; color: #991b1b;">
                                ${isZh ? '‚ö†Ô∏è ‰∫âËÆÆÂ∑≤Êèê‰∫§ÔºåÁ≠âÂæÖÂπ≥Âè∞Â§ÑÁêÜ' : '‚ö†Ô∏è Dispute Submitted, Awaiting Resolution'}
                            </div>
                        </div>
                    `;
                }
            } else {
                disputeStatusEl.innerHTML = '';
            }
            
            // Êõ¥Êñ∞‰∫âËÆÆ‰ø°ÊÅØ
            if (disputeStatus.disputeOpened) {
                const openedAt = disputeStatus.disputeOpenedAt && disputeStatus.disputeOpenedAt.toNumber 
                    ? new Date(disputeStatus.disputeOpenedAt.toNumber() * 1000).toLocaleString()
                    : '';
                const resolvedAt = disputeStatus.disputeResolvedAt && disputeStatus.disputeResolvedAt.toNumber
                    ? new Date(disputeStatus.disputeResolvedAt.toNumber() * 1000).toLocaleString()
                    : '';
                
                disputeInfoEl.innerHTML = `
                    <div style="margin-top: 12px;">
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px; font-weight: 600;">
                            ${isZh ? '‰∫âËÆÆ‰ø°ÊÅØ / Dispute Info' : 'Dispute Info'}
                        </div>
                        <div style="padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <div style="margin-bottom: 8px;">
                                <span style="font-size: 12px; color: #6b7280;">${isZh ? 'ÂèëËµ∑‰∫∫ / Opened By' : 'Opened By'}:</span>
                                <span style="font-size: 13px; color: #1f2937; font-family: monospace; margin-left: 8px;">
                                    ${disputeStatus.disputeOpener ? (disputeStatus.disputeOpener.substring(0, 6) + '...' + disputeStatus.disputeOpener.substring(38)) : 'N/A'}
                                </span>
                            </div>
                            ${openedAt ? `
                            <div style="margin-bottom: 8px;">
                                <span style="font-size: 12px; color: #6b7280;">${isZh ? 'ÂèëËµ∑Êó∂Èó¥ / Opened At' : 'Opened At'}:</span>
                                <span style="font-size: 13px; color: #1f2937; margin-left: 8px;">${openedAt}</span>
                            </div>
                            ` : ''}
                            ${disputeStatus.disputeReason ? `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 6px; font-weight: 600;">
                                    ${isZh ? '‰∫âËÆÆÂéüÂõ† / Reason' : 'Reason'}
                                </div>
                                <div style="font-size: 14px; color: #1f2937; line-height: 1.6; white-space: pre-wrap;">${disputeStatus.disputeReason}</div>
                            </div>
                            ` : ''}
                            ${disputeStatus.disputeResolved ? `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 6px; font-weight: 600;">
                                    ${isZh ? 'Ëé∑ËÉúÊñπ / Winner' : 'Winner'}
                                </div>
                                <div style="font-size: 13px; color: #1f2937; font-family: monospace;">
                                    ${disputeStatus.disputeWinner ? (disputeStatus.disputeWinner.substring(0, 6) + '...' + disputeStatus.disputeWinner.substring(38)) : 'N/A'}
                                </div>
                                ${resolvedAt ? `
                                <div style="font-size: 11px; color: #6b7280; margin-top: 6px;">
                                    ${isZh ? 'Ëß£ÂÜ≥Êó∂Èó¥ / Resolved At' : 'Resolved At'}: ${resolvedAt}
                                </div>
                                ` : ''}
                                ${disputeStatus.disputeResolutionDetail ? `
                                <div style="margin-top: 8px; padding: 8px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6;">
                                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px; font-weight: 600;">
                                        ${isZh ? 'Ë£ÅÂÜ≥ËØ¥Êòé / Resolution Detail' : 'Resolution Detail'}
                                    </div>
                                    <div style="font-size: 13px; color: #1f2937; line-height: 1.5;">${disputeStatus.disputeResolutionDetail}</div>
                                </div>
                                ` : ''}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                disputeInfoEl.innerHTML = '';
            }
            
            // Êõ¥Êñ∞‰∫âËÆÆË°®ÂçïÔºà‰ªÖÂΩìËÆ¢ÂçïÂú® AWAITING_SETTLEMENT Áä∂ÊÄÅ‰∏îÊú™ÂèëËµ∑‰∫âËÆÆÊó∂ÊòæÁ§∫Ôºâ
            if (isAwaitingSettlement && !disputeStatus.disputeOpened) {
                disputeFormEl.innerHTML = `
                    <div style="margin-top: 16px;">
                        <textarea id="driver-dispute-reason-${orderId}" placeholder="${isZh ? 'ËØ∑ÊèèËø∞ÊÇ®ÁöÑÈóÆÈ¢ò...' : 'Describe your issue from driver side...'}" style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; box-sizing: border-box;"></textarea>
                        <button id="btn-driver-submit-dispute-${orderId}" onclick="submitDisputeDriver(${orderId})" style="margin-top: 12px; padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; width: 100%;">
                            ${isZh ? 'Êèê‰∫§‰∫âËÆÆ / Submit Dispute' : 'Submit Dispute'}
                        </button>
                    </div>
                `;
            } else {
                disputeFormEl.innerHTML = '';
            }
        }
        
        window.updateDisputeUIDriver = updateDisputeUIDriver;
        
        // Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                alert((isZh ? 'Â∑≤Â§çÂà∂: ' : 'Copied: ') + text);
            });
        }
        
        // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÔºàÊòµÁß∞ÂíåÊâãÊú∫Âè∑ÂìàÂ∏åÔºâ
        async function getUserInfo(userAddress) {
            if (!contracts.userRegistry || !userAddress) {
                return { name: 'Unknown', phoneHash: null };
            }
            
            try {
                const user = await contracts.userRegistry.getUser(userAddress);
                return {
                    name: user.name || 'Unknown',
                    phoneHash: user.phoneHash || null
                };
            } catch (error) {
                console.warn('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', error);
                return { name: 'Unknown', phoneHash: null };
            }
        }
        
        // Âä†ËΩΩProfile‰ø°ÊÅØ
        async function loadProfile() {
            if (!account) return;
            
            // Âä†ËΩΩÊòµÁß∞ÂíåËÅîÁ≥ªÊñπÂºè
            const nickname = localStorage.getItem('user_nickname') || '';
            const contact = localStorage.getItem('user_contact') || '';
            
            const profileNickname = document.getElementById('profile-nickname');
            if (profileNickname) {
                profileNickname.value = nickname;
            }
            
            const profileContact = document.getElementById('profile-contact');
            if (profileContact) {
                profileContact.value = contact;
            }
            
            // Êõ¥Êñ∞Âü∫Êú¨‰ø°ÊÅØ
            document.getElementById('profile-address').textContent = account;
            const profileName = document.getElementById('profile-name');
            if (profileName) {
                profileName.textContent = nickname || 'Driver';
            }
            
            // ÁîüÊàêÁî®Êà∑È¶ñÂ≠óÊØçÔºà‰ºòÂÖà‰ΩøÁî®ÊòµÁß∞Ôºâ
            const initials = nickname ? nickname.substring(0, 2).toUpperCase() : 
                           (account ? account.substring(2, 4).toUpperCase() : 'D');
            const profileInitials = document.getElementById('profile-initials');
            if (profileInitials) {
                profileInitials.textContent = initials;
            }
            
            // Êõ¥Êñ∞ËÆæÁΩÆ‰ø°ÊÅØ
            document.getElementById('setting-wallet-address').textContent = `${account.substring(0, 6)}...${account.substring(38)}`;
            
            try {
                const chainId = await provider.getNetwork();
                document.getElementById('setting-network').textContent = `Chain ID: ${chainId.chainId}`;
            } catch (error) {
                document.getElementById('setting-network').textContent = 'Unknown';
            }
            
            // Âä†ËΩΩÁªüËÆ°‰ø°ÊÅØ
            if (contracts.rideOrder) {
                try {
                    const orderIds = await contracts.rideOrder.getDriverOrders(account);
                    const totalOrders = orderIds.length;
                    let completedOrders = 0;
                    let totalEarned = 0;
                    
                    // ‰ºòÂåñÔºöÊâπÈáèËé∑ÂèñËÆ¢ÂçïÔºàÂπ∂Ë°åÂ§ÑÁêÜÔºâ
                    const BATCH_SIZE = 10;
                    
                    for (let batchStart = 0; batchStart < orderIds.length; batchStart += BATCH_SIZE) {
                        const batchEnd = Math.min(batchStart + BATCH_SIZE, orderIds.length);
                        const batchPromises = [];
                        
                        // ÂàõÂª∫ÊâπÈáèËØ∑Ê±Ç
                        for (let i = batchStart; i < batchEnd; i++) {
                            batchPromises.push(
                                contracts.rideOrder.getOrder(orderIds[i]).catch(err => null)
                            );
                        }
                        
                        // Á≠âÂæÖÂΩìÂâçÊâπÊ¨°ÂÆåÊàê
                        const batchResults = await Promise.all(batchPromises);
                        
                        // Â§ÑÁêÜÁªìÊûú
                        for (const order of batchResults) {
                            if (!order) continue;
                            try {
                                const status = typeof order.status === 'number' ? order.status : order.status.toNumber();
                                if (status === 3) {
                                    completedOrders++;
                                    if (order.actualFare) {
                                        totalEarned += parseFloat(ethers.utils.formatEther(order.actualFare));
                                    } else if (order.estimatedFare) {
                                        totalEarned += parseFloat(ethers.utils.formatEther(order.estimatedFare));
                                    }
                                }
                            } catch (error) {
                                // Ë∑≥ËøáÂ§ÑÁêÜÂ§±Ë¥•ÁöÑËÆ¢Âçï
                                continue;
                            }
                        }
                        
                        // Âú® Firefox ‰∏≠ÔºåÁªôÊµèËßàÂô®‰∏Ä‰∫õÂñòÊÅØÊó∂Èó¥
                        if (batchEnd < orderIds.length) {
                            await new Promise(resolve => setTimeout(resolve, 10));
                        }
                    }
                    
                    document.getElementById('stat-total-orders').textContent = totalOrders;
                    document.getElementById('stat-completed-orders').textContent = completedOrders;
                    
                    // ËÆ°ÁÆóÊÄªÂπ≥Âè∞Ë¥πÂíåÂáÄÊî∂ÂÖ•
                    const PLATFORM_FEE_RATE = 0.05;
                    const totalPlatformFee = totalEarned * PLATFORM_FEE_RATE;
                    const netEarned = totalEarned - totalPlatformFee;
                    
                    // ÊòæÁ§∫ÊÄªÊî∂ÂÖ•ÂíåÂáÄÊî∂ÂÖ•ÔºàÂåÖÊã¨ÊòéÁªÜÔºâ
                    const earnedElement = document.getElementById('stat-total-earned');
                    if (earnedElement) {
                        if (totalEarned > 0) {
                            const totalEarnedETH = totalEarned.toFixed(8);
                            const totalEarnedUSD = (totalEarned * ETH_TO_USD_RATE).toFixed(2);
                            const platformFeeETH = totalPlatformFee.toFixed(8);
                            const platformFeeUSD = (totalPlatformFee * ETH_TO_USD_RATE).toFixed(2);
                            const netEarnedETH = netEarned.toFixed(8);
                            const netEarnedUSD = (netEarned * ETH_TO_USD_RATE).toFixed(2);
                            
                            const isZh3 = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                            earnedElement.innerHTML = `
                                <div style="font-size: 18px; font-weight: 700; color: #1f2937; margin-bottom: 6px;">$${netEarnedUSD}</div>
                                <div style="font-size: 11px; color: #6b7280; line-height: 1.5;">
                                    <div>${isZh3 ? 'ÊÄªÊî∂ÂÖ•' : 'Total Income'}: ${totalEarnedETH} ETH ($${totalEarnedUSD} USD)</div>
                                    <div>${typeof i18n !== 'undefined' ? i18n.t('platformFee') : 'Platform Fee (5%)'}: -${platformFeeETH} ETH (-$${platformFeeUSD} USD)</div>
                                    <div style="font-weight: 600; color: #10b981; margin-top: 4px; padding-top: 4px; border-top: 1px solid #e5e7eb;">
                                        ${typeof i18n !== 'undefined' ? i18n.t('netIncome') : 'Net Income'}: ${netEarnedETH} ETH ($${netEarnedUSD} USD)
                                    </div>
                                    <div style="font-size: 10px; color: #9ca3af; margin-top: 4px;">
                                        ${typeof i18n !== 'undefined' ? i18n.t('gasFeeNote') : 'Note: Gas fee not included in this calculation'}
                                    </div>
                                </div>
                            `;
                        } else {
                            earnedElement.textContent = '$0.00';
                        }
                    }
                } catch (error) {
                    console.error('Âä†ËΩΩÁªüËÆ°‰ø°ÊÅØÂ§±Ë¥•:', error);
                }
            }
        }
        
        // ‰øùÂ≠ò‰∏™‰∫∫‰ø°ÊÅØ
        function saveProfile() {
            const nickname = document.getElementById('profile-nickname').value.trim();
            const contact = document.getElementById('profile-contact').value.trim();
            
            if (nickname) {
                localStorage.setItem('user_nickname', nickname);
            } else {
                localStorage.removeItem('user_nickname');
            }
            
            if (contact) {
                localStorage.setItem('user_contact', contact);
            } else {
                localStorage.removeItem('user_contact');
            }
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            const profileName = document.getElementById('profile-name');
            if (profileName) {
                profileName.textContent = nickname || 'Driver';
            }
            
            const profileInitials = document.getElementById('profile-initials');
            if (profileInitials) {
                const initials = nickname ? nickname.substring(0, 2).toUpperCase() : 
                               (account ? account.substring(2, 4).toUpperCase() : 'D');
                profileInitials.textContent = initials;
            }
            
            // ÊòæÁ§∫‰øùÂ≠òÊàêÂäüÊèêÁ§∫
            const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
            alert(isZh ? '‚úì ‰∏™‰∫∫‰ø°ÊÅØÂ∑≤‰øùÂ≠ò' : '‚úì Profile saved successfully');
        }
        
        // ÊòæÁ§∫Èí±ÂåÖ‰ø°ÊÅØ
        function showWalletInfo() {
            alert(`Wallet Address:\n${account}\n\nYou can copy this address to share it with others.`);
        }
        
        // ÊòæÁ§∫ÁΩëÁªú‰ø°ÊÅØ
        async function showNetworkInfo() {
            try {
                const network = await provider.getNetwork();
                alert(`Network Information:\n\nChain ID: ${network.chainId}\nNetwork Name: ${network.name}`);
            } catch (error) {
                alert('Failed to get network information: ' + error.message);
            }
        }
        
        // Ëá™Âä®Ê£ÄÊü•ÊòØÂê¶Â∑≤ËøûÊé•
        window.addEventListener('load', async () => {
            displayBrowserInfo();
            setupAccountChangeListener();
            
            // ÂàùÂßãÂåñÊó∂ÊòæÁ§∫ÈªòËÆ§Ê†áÈ¢ò
            updateMainHeader('driverApp', 'driverAppSubtitle');
            
            if (typeof window.ethereum !== 'undefined') {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    connectWallet();
                }
            }
        });
        
        // Â∞ÜÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºàtoggleSidebar, toggleLanguageMenu, selectLanguage Â∑≤Âú®‰∏äÈù¢ÂÆö‰πâÂú® window ‰∏äÔºâ
        window.showAvailableOrdersView = showAvailableOrdersView;
        window.showMyOrdersView = showMyOrdersView;
        window.showProfileView = showProfileView;
        window.filterMyOrders = filterMyOrders;
        window.loadMyOrders = loadMyOrders;
        window.loadProfile = loadProfile;
        window.saveProfile = saveProfile;
        window.showWalletInfo = showWalletInfo;
        window.showNetworkInfo = showNetworkInfo;
        window.acceptOrder = acceptOrder;
        window.pickUpPassenger = pickUpPassenger;
        window.completeOrder = completeOrder;
        window.acceptRide = acceptRide;
        window.startRide = startRide;
        window.completeRide = completeRide;
        window.connectWallet = connectWallet;
        window.switchAccount = switchAccount;
        window.navigateFromSidebar = navigateFromSidebar;
        window.viewOrderDetail = viewOrderDetail;
        
        // Êèê‰∫§‰∫âËÆÆÔºàÂè∏Êú∫Á´ØÔºâ
        async function submitDisputeDriver(orderId) {
            if (!contracts.rideOrder) {
                alert('ÂêàÁ∫¶Êú™ÂàùÂßãÂåñÔºÅ');
                return;
            }
            
            const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
            // Â∞ùËØï‰ªéÊñ∞ÁöÑË°®ÂçïÂÖÉÁ¥†Ëé∑ÂèñÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®ÂàôÂ∞ùËØïÊóßÁöÑ
            let reasonInput = document.getElementById(`driver-dispute-reason-${orderId}`);
            if (!reasonInput) {
                reasonInput = document.getElementById(`dispute-input-driver-${orderId}`);
            }
            if (!reasonInput) {
                alert(isZh ? 'Êó†Ê≥ïÊâæÂà∞‰∫âËÆÆËæìÂÖ•Ê°Ü' : 'Cannot find dispute input');
                return;
            }
            
            const reason = reasonInput.value.trim();
            if (!reason) {
                alert(isZh ? 'ËØ∑ËæìÂÖ•‰∫âËÆÆÂéüÂõ†' : 'Please enter dispute reason');
                return;
            }
            
            try {
                const btn = document.getElementById(`btn-driver-dispute-${orderId}`);
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = isZh ? 'Êèê‰∫§‰∏≠...' : 'Submitting...';
                }
                
                const tx = await contracts.rideOrder.submitDispute(orderId, reason);
                await tx.wait();
                
                alert(isZh ? '‰∫âËÆÆÂ∑≤Êèê‰∫§' : 'Dispute submitted.');
                
                // Âà∑Êñ∞ËÆ¢ÂçïËØ¶ÊÉÖ
                viewOrderDetail(orderId);
            } catch (error) {
                console.error('Êèê‰∫§‰∫âËÆÆÂ§±Ë¥•:', error);
                const friendlyError = error.reason || error.message || 'Unknown error';
                alert(isZh ? `Êèê‰∫§‰∫âËÆÆÂ§±Ë¥•: ${friendlyError}` : `Failed to submit dispute: ${friendlyError}`);
                
                const btn = document.getElementById(`btn-driver-dispute-${orderId}`);
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = isZh ? 'Êèê‰∫§‰∫âËÆÆ / Submit Dispute' : 'Submit Dispute';
                }
            }
        }
        
        window.submitDisputeDriver = submitDisputeDriver;
        
        // Âä†ËΩΩ‰∫âËÆÆÁä∂ÊÄÅ
        async function loadDisputeStatus(orderId) {
            if (!contracts.rideOrder) {
                return null;
            }
            
            try {
                const disputeStatus = await contracts.rideOrder.getDisputeStatus(orderId);
                return {
                    disputeOpened: disputeStatus.disputeOpened,
                    disputeResolved: disputeStatus.disputeResolved,
                    disputeOpener: disputeStatus.disputeOpener,
                    disputeWinner: disputeStatus.disputeWinner,
                    disputeReason: disputeStatus.disputeReason,
                    disputeOpenedAt: disputeStatus.disputeOpenedAt,
                    disputeResolvedAt: disputeStatus.disputeResolvedAt,
                    disputeResolutionDetail: disputeStatus.disputeResolutionDetail,
                    rideStatus: disputeStatus.rideStatus
                };
            } catch (error) {
                console.error('Âä†ËΩΩ‰∫âËÆÆÁä∂ÊÄÅÂ§±Ë¥•:', error);
                return null;
            }
        }
        
        window.loadDisputeStatus = loadDisputeStatus;
        
        // Ëé∑Âèñ‰∫âËÆÆÁä∂ÊÄÅÔºàÂÖºÂÆπÊóß‰ª£Á†ÅÔºâ
        async function getDisputeStatus(orderId) {
            return await loadDisputeStatus(orderId);
        }
        
        window.getDisputeStatus = getDisputeStatus;
        window.copyToClipboard = copyToClipboard;
        
        // Ê∏≤ÊüìÂè∏Êú∫Á´ØÊó•ËÆ¢ÂçïÁªüËÆ°ÂõæË°®Ôºà‰ΩøÁî®ÊºîÁ§∫Êï∞ÊçÆÔºâ
        function renderDriverDailyOrdersChart() {
            const chartContainer = document.getElementById('driver-daily-orders-chart');
            if (!chartContainer) return;
            
            // ÁîüÊàêËøáÂéª14Â§©ÁöÑÊºîÁ§∫Êï∞ÊçÆ
            const demoData = [];
            const today = new Date();
            for (let i = 13; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                // ÁîüÊàêÈöèÊú∫ËÆ¢ÂçïÊï∞Ôºà1-15‰πãÈó¥Ôºâ
                const orderCount = Math.floor(Math.random() * 15) + 1;
                demoData.push({
                    date: date,
                    orders: orderCount
                });
            }
            
            // ËÆ°ÁÆóÊúÄÂ§ßÂÄºÁî®‰∫éÁº©Êîæ
            const maxOrders = Math.max(...demoData.map(d => d.orders), 1);
            
            // ÁîüÊàêÂõæË°®HTML
            const chartHeight = 300;
            const barWidth = 40;
            const barGap = 10;
            const totalWidth = demoData.length * (barWidth + barGap) + 40;
            
            let chartHtml = `
                <div style="width: 100%; overflow-x: auto;">
                    <svg width="${totalWidth}" height="${chartHeight + 60}" style="display: block; margin: 0 auto;">
                        <!-- YËΩ¥Ê†áÁ≠æ -->
                        ${Array.from({length: 6}, (_, i) => {
                            const value = Math.round((maxOrders / 5) * (5 - i));
                            const y = (chartHeight / 5) * i + 20;
                            return `<text x="0" y="${y + 5}" font-size="12" fill="#6b7280" text-anchor="end">${value}</text>`;
                        }).join('')}
                        
                        <!-- ÁΩëÊ†ºÁ∫ø -->
                        ${Array.from({length: 6}, (_, i) => {
                            const y = (chartHeight / 5) * i + 20;
                            return `<line x1="30" y1="${y}" x2="${totalWidth - 10}" y2="${y}" stroke="#e5e7eb" stroke-width="1"/>`;
                        }).join('')}
                        
                        <!-- Êü±Áä∂Âõæ -->
                        ${demoData.map((item, index) => {
                            const barHeight = (item.orders / maxOrders) * chartHeight;
                            const x = 40 + index * (barWidth + barGap);
                            const y = chartHeight + 20 - barHeight;
                            const dateStr = item.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            
                            return `
                                <g>
                                    <!-- Êü±Áä∂ -->
                                    <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" 
                                          fill="var(--primary-color)" rx="4" opacity="0.8">
                                        <title>${dateStr}: ${item.orders} orders</title>
                                    </rect>
                                    <!-- Êï∞ÂÄºÊ†áÁ≠æ -->
                                    <text x="${x + barWidth / 2}" y="${y - 5}" 
                                          font-size="12" fill="#1f2937" font-weight="600" 
                                          text-anchor="middle">${item.orders}</text>
                                    <!-- Êó•ÊúüÊ†áÁ≠æ -->
                                    <text x="${x + barWidth / 2}" y="${chartHeight + 45}" 
                                          font-size="11" fill="#6b7280" 
                                          text-anchor="middle" transform="rotate(-45 ${x + barWidth / 2} ${chartHeight + 45})">${dateStr}</text>
                                </g>
                            `;
                        }).join('')}
                    </svg>
                </div>
            `;
            
            chartContainer.innerHTML = chartHtml;
        }
        
        // Êö¥Èú≤ÂáΩÊï∞Âà∞ÂÖ®Â±Ä
        window.renderDriverDailyOrdersChart = renderDriverDailyOrdersChart;
    </script>
</body>
</html>

