# 多浏览器测试指南

本指南说明如何使用多个浏览器测试 TrustFlow 司机接单功能。

## 测试场景

- **Edge浏览器**: 乘客端，用于创建订单
- **Chrome浏览器**: 司机1，用于接单
- **Firefox浏览器**: 司机2，用于接单

## 准备工作

### 1. 确保每个浏览器都安装了MetaMask

在每个浏览器中：
1. 打开扩展商店
2. 搜索并安装 MetaMask
3. 创建或导入钱包账户

### 2. 配置MetaMask连接到Hardhat本地网络

在每个浏览器的MetaMask中：
1. 点击网络选择器
2. 选择"添加网络"
3. 手动添加：
   - 网络名称：Hardhat Local Network
   - RPC URL：http://127.0.0.1:8545
   - 链ID：1337
   - 货币符号：ETH

**或者** 在司机界面连接钱包时，系统会自动提示添加网络。

### 3. 准备不同的钱包地址

为了模拟不同司机，建议：
- Edge浏览器：使用账户1（乘客账户）
- Chrome浏览器：使用账户2（司机1账户）
- Firefox浏览器：使用账户3（司机2账户）

**在Hardhat节点中导入账户**（如果需要）：
```bash
npx hardhat console --network localhost
```
然后使用Hardhat的默认账户或导入新的账户。

## 启动步骤

### 1. 启动Hardhat节点（终端1）

```bash
npm run node
```

保持终端运行。

### 2. 部署合约（终端2）

```bash
npm run deploy:local
```

记录输出的合约地址（特别是 TrustFlowRide 地址）。

### 3. 启动前端服务器（终端3）

```bash
npm run frontend
```

服务器将在 http://localhost:3001 启动。

### 4. 在Edge浏览器打开乘客端

1. 打开 Edge 浏览器
2. 访问：http://localhost:3001
3. 连接MetaMask（选择账户1）
4. **配置合约地址**（如果提示）：
   - 输入步骤2中记录的 TrustFlowRide 合约地址
   - 例如：`0x5FbDB2315678afecb367f032d93F642f64180aa3`
   - ⚠️ **重要**：所有用户必须使用**同一个**合约地址
5. 创建订单

### 5. 在Chrome浏览器打开司机端（司机1）

1. 打开 Chrome 浏览器
2. 访问：http://localhost:3001/driver
3. 连接MetaMask（选择账户2 - 与Edge不同的账户）
4. **配置合约地址**（如果提示）：
   - 输入**相同的** TrustFlowRide 合约地址（与Edge中配置的相同）
   - ⚠️ **重要**：必须使用**同一个**合约地址，否则看不到订单
5. 查看可用订单并接单

### 6. 在Firefox浏览器打开司机端（司机2）

1. 打开 Firefox 浏览器
2. 访问：http://localhost:3001/driver
3. 连接MetaMask（选择账户3 - 与前两个不同的账户）
4. **配置合约地址**（如果提示）：
   - 输入**相同的** TrustFlowRide 合约地址（与Edge和Chrome中配置的相同）
   - ⚠️ **重要**：必须使用**同一个**合约地址
5. 查看可用订单并接单

## ⚠️ 重要说明：合约地址

### 所有用户使用同一个合约地址

**关键点**：
- ✅ **同一个合约地址**：所有乘客和司机必须连接到**同一个** TrustFlowRide 合约地址
- ✅ **不同的账户地址**：每个用户使用**不同的** MetaMask 账户（钱包地址）来区分身份

**为什么？**
1. **订单共享**：订单存储在智能合约中，所有司机需要连接到同一个合约才能看到订单
2. **状态一致性**：订单状态（Pending、Accepted等）在合约中统一管理
3. **去中心化特性**：区块链应用的核心是共享同一个合约实例

**架构说明**：
```
┌─────────────────────────────────────────┐
│     TrustFlowRide 智能合约 (同一个)      │
│     地址: 0x5FbDB2315678afecb...        │
└─────────────────────────────────────────┘
         │         │         │
         │         │         │
    ┌────┴───┐ ┌──┴───┐ ┌───┴───┐
    │ Edge   │ │Chrome│ │Firefox│
    │账户1   │ │账户2 │ │账户3  │
    │(乘客)  │ │(司机1)│ │(司机2)│
    └────────┘ └──────┘ └───────┘
```

## 功能说明

### 司机界面特性

1. **浏览器标识**：界面顶部显示当前使用的浏览器（Edge/Chrome/Firefox）

2. **账户显示**：连接钱包后，会显示当前司机账户地址

3. **切换账户**：如果MetaMask中有多个账户，可以点击"切换账户"按钮切换

4. **自动账户检测**：如果MetaMask中的账户发生变化，界面会自动更新

5. **实时订单更新**：当有新订单创建时，所有司机端都会自动刷新显示

### 多司机抢单机制

- 所有Pending状态的订单都会显示在所有司机端
- 多个司机可以同时看到同一个订单
- 第一个成功接单的司机会锁定订单（状态变为Accepted）
- 其他司机尝试接单时会收到错误提示（订单已被接单）

## 测试流程

### 测试场景1：单司机接单

1. 在Edge创建订单
2. 在Chrome查看订单
3. 在Chrome接单
4. 验证订单状态变为Accepted

### 测试场景2：多司机抢单

1. 在Edge创建订单
2. 同时在Chrome和Firefox打开司机界面
3. 两个司机都看到同一个订单
4. 其中一个司机点击"接单"
5. 另一个司机尝试接单应该失败

### 测试场景3：账户切换

1. 在Chrome连接账户2
2. 点击"切换账户"按钮
3. 在MetaMask中选择账户3
4. 验证界面显示新账户

## 常见问题

### Q1: 所有浏览器显示相同的订单吗？

**A**: 是的。所有司机端连接到同一个智能合约，所以会看到相同的Pending订单列表。

### Q2: 可以使用同一个MetaMask账户吗？

**A**: 不建议。虽然技术上可以，但为了真实模拟多司机场景，建议每个浏览器使用不同的账户。

### Q3: 如何在MetaMask中切换账户？

**A**: 
1. 点击MetaMask扩展图标
2. 点击账户名称旁边的下拉箭头
3. 选择"创建账户"或"导入账户"
4. 或在司机界面点击"切换账户"按钮

### Q4: 合约地址需要每个浏览器都配置吗？

**A**: 
- **不同浏览器需要各自配置一次**：每个浏览器的localStorage是独立的
- **但必须使用相同的合约地址**：所有浏览器（Edge、Chrome、Firefox）必须配置**同一个** TrustFlowRide 合约地址
- 如果使用不同的合约地址，司机将看不到乘客创建的订单

### Q5: 如果所有浏览器使用同一个账户会怎样？

**A**: 司机端会过滤掉自己创建的订单（passenger地址 = driver地址），所以如果使用同一个账户：
- Edge（乘客）创建的订单在Edge（如果当司机用）看不到
- 但在Chrome和Firefox可以看到

## 调试技巧

### 查看当前账户

每个司机界面上方会显示：
- 当前司机账户地址（完整地址）
- 浏览器类型
- 连接状态

### 查看控制台日志

按F12打开浏览器控制台，可以看到：
- 浏览器检测信息
- 连接的账户
- 订单加载过程
- 接单操作日志

### 验证账户是否不同

在浏览器控制台运行：
```javascript
// 查看当前连接的账户
window.ethereum.selectedAddress
```

或在司机界面查看"当前司机账户"显示。

## 注意事项

1. **网络必须一致**：所有浏览器必须连接到同一个Hardhat节点（localhost:8545）

2. **合约地址必须一致**：所有浏览器必须配置相同的TrustFlowRide合约地址

3. **账户要有余额**：每个司机账户需要有足够的ETH支付gas费用

4. **订单状态实时性**：订单状态变化后，可能需要几秒钟才会在其他界面刷新（取决于事件监听）

5. **浏览器独立运行**：每个浏览器完全独立，不会互相干扰

## 成功标志

测试成功的标志：
- ✅ 三个浏览器可以同时连接到同一个合约
- ✅ Edge可以创建订单
- ✅ Chrome和Firefox都能看到Pending订单
- ✅ 其中一个司机成功接单后，另一个司机看到订单状态变为Accepted
- ✅ 每个浏览器显示不同的账户地址

祝测试顺利！🚗💨
