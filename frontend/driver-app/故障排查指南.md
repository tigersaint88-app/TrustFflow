# 司机界面故障排查指南

## 错误：call revert exception - orderCount()

如果看到以下错误：
```
Error: call revert exception
method="orderCount()"
```

这表示无法调用合约函数。以下是详细的排查步骤。

## 可能的原因

### 1. ❌ 合约地址错误

**症状**：
- 调用任何合约函数都失败
- 错误信息包含 `CALL_EXCEPTION` 或 `revert exception`

**解决方案**：
1. 检查合约地址是否正确
   ```javascript
   // 在浏览器控制台运行
   localStorage.getItem('RIDE_ORDER_ADDRESS')
   ```

2. 确认合约地址与部署输出一致
   - 运行 `npm run deploy:local`
   - 查看输出的合约地址
   - 对比浏览器中保存的地址

3. 如果地址错误，清除并重新配置：
   ```javascript
   // 在浏览器控制台运行
   localStorage.removeItem('RIDE_ORDER_ADDRESS')
   // 然后刷新页面，重新配置合约地址
   ```

### 2. ❌ 合约未部署

**症状**：
- 合约地址存在，但调用函数失败
- 错误信息：`call revert exception`

**解决方案**：
1. 确认 Hardhat 节点正在运行
   ```bash
   npm run node
   ```
   
2. 确认合约已部署
   ```bash
   npm run deploy:local
   ```
   
3. 检查部署记录
   - 查看 `deployments/localhost-latest.json`
   - 确认 `rideOrder` 字段有值

### 3. ❌ 网络不匹配

**症状**：
- MetaMask 连接到错误的网络
- 合约地址正确，但调用失败

**解决方案**：
1. 检查 MetaMask 网络
   - 应该连接到：**Hardhat Local Network**
   - Chain ID: **1337**
   - RPC URL: **http://127.0.0.1:8545**

2. 如果网络错误，切换网络：
   - 点击 MetaMask 网络选择器
   - 选择 "Hardhat Local Network"
   - 如果没有，点击"添加网络"手动添加

### 4. ❌ Hardhat 节点未运行

**症状**：
- 所有合约调用都超时或失败
- MetaMask 无法连接到网络

**解决方案**：
1. 启动 Hardhat 节点
   ```bash
   npm run node
   ```
   
2. 等待节点完全启动（看到 "Started HTTP and WebSocket server"）

3. 确保节点运行在端口 8545

## 快速诊断步骤

### 步骤 1：检查 Hardhat 节点

```bash
# 确认节点正在运行
curl http://localhost:8545
# 应该返回 JSON 数据，而不是连接错误
```

### 步骤 2：检查合约部署

```bash
# 查看最新的部署记录
cat deployments/localhost-latest.json

# 或重新部署
npm run deploy:local
```

### 步骤 3：检查浏览器配置

在浏览器控制台运行：
```javascript
// 查看保存的合约地址
localStorage.getItem('RIDE_ORDER_ADDRESS')

// 查看当前网络
window.ethereum.request({ method: 'eth_chainId' }).then(console.log)
// 应该返回: "0x539" (1337 的十六进制)

// 查看当前账户
window.ethereum.request({ method: 'eth_accounts' }).then(console.log)
```

### 步骤 4：验证合约代码

在浏览器控制台运行：
```javascript
// 假设 provider 已初始化
const address = localStorage.getItem('RIDE_ORDER_ADDRESS');
const code = await provider.getCode(address);
console.log('合约代码长度:', code.length);
// 如果 code === '0x' 或 code.length < 100，说明合约未部署
```

## 完整的重置步骤

如果以上步骤都无法解决问题，尝试完全重置：

### 1. 停止所有进程

按 `Ctrl+C` 停止：
- Hardhat 节点
- 前端服务器

### 2. 重新启动节点

```bash
npm run node
```

等待节点完全启动（通常需要几秒钟）。

### 3. 重新部署合约

在新终端：
```bash
npm run deploy:local
```

**重要**：记录输出的合约地址！

### 4. 清除浏览器缓存

在浏览器中：
```javascript
// 清除合约地址
localStorage.removeItem('RIDE_ORDER_ADDRESS')

// 刷新页面
location.reload()
```

### 5. 重新配置

1. 连接钱包
2. 输入新部署的合约地址
3. 确认配置成功

### 6. 验证连接

在浏览器控制台：
```javascript
// 检查合约是否可访问
const contract = window.contracts.rideOrder;
const count = await contract.orderCount();
console.log('订单数量:', count.toNumber());
```

## 常见错误信息对照表

| 错误信息 | 可能原因 | 解决方案 |
|---------|---------|---------|
| `call revert exception` | 合约地址错误/未部署 | 检查地址，重新部署 |
| `network error` | Hardhat 节点未运行 | 运行 `npm run node` |
| `user rejected` | 用户拒绝 MetaMask 请求 | 在 MetaMask 中批准请求 |
| `insufficient funds` | 账户余额不足 | 使用 Hardhat 默认账户或转账 |
| `chain ID mismatch` | 网络不匹配 | 切换到 Chain ID 1337 |

## 验证清单

在报告问题前，请确认：

- [ ] Hardhat 节点正在运行 (`npm run node`)
- [ ] 合约已部署 (`npm run deploy:local`)
- [ ] 合约地址已正确配置（在浏览器 localStorage 中）
- [ ] MetaMask 连接到 Hardhat Local Network (Chain ID: 1337)
- [ ] MetaMask 账户已解锁
- [ ] 账户有足够的 ETH 余额
- [ ] 浏览器控制台没有其他错误

## 获取帮助

如果以上步骤都无法解决问题：

1. 查看浏览器控制台的完整错误信息
2. 查看 Hardhat 节点的日志
3. 检查 `deployments/localhost-latest.json` 文件
4. 确认所有步骤都按照顺序执行

## 测试连接

使用以下代码测试合约连接（在浏览器控制台运行）：

```javascript
// 测试脚本
async function testConnection() {
    const address = localStorage.getItem('RIDE_ORDER_ADDRESS');
    console.log('1. 合约地址:', address);
    
    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
    console.log('2. 链ID:', parseInt(chainId, 16), '(应该是 1337)');
    
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const code = await provider.getCode(address);
    console.log('3. 合约代码:', code.length > 100 ? '✓ 存在' : '✗ 不存在');
    
    const contract = new ethers.Contract(address, [
        "function orderCount() external view returns (uint256)"
    ], provider);
    
    try {
        const count = await contract.orderCount();
        console.log('4. 订单数量:', count.toNumber());
        console.log('✓ 连接成功！');
    } catch (error) {
        console.error('4. 调用失败:', error.message);
        console.log('✗ 连接失败');
    }
}

testConnection();
```

运行这个脚本可以帮助快速诊断问题所在。

