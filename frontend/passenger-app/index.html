<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrustFlow - Order Creation</title>
    <script src="ethers.umd.min.js"></script>
    <script src="i18n.js"></script>
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* SaaS Professional Color Palette - Stripe/Uber/Airbnb inspired */
            --primary-color: #635bff;
            --primary-dark: #4a42d4;
            --primary-light: #7c3aed;
            --secondary-color: #0a2540;
            --success-color: #00d4aa;
            --error-color: #e25950;
            --warning-color: #ffb020;
            --info-color: #3b82f6;
            
            /* Neutral Colors */
            --gray-50: #fafbfc;
            --gray-100: #f6f8fa;
            --gray-200: #e1e4e8;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Background Colors */
            --bg-primary: #ffffff;
            --bg-secondary: #fafbfc;
            --bg-tertiary: #f6f8fa;
            
            /* Shadows - Subtle and Professional */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            
            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            
            /* Typography */
            --font-size-xs: 12px;
            --font-size-sm: 14px;
            --font-size-base: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 20px;
            --font-size-2xl: 24px;
            --font-size-3xl: 30px;
            
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            line-height: 1.5;
            color: var(--gray-900);
            padding-bottom: 80px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            min-height: calc(100vh - 80px);
            padding: 0;
            overflow-x: hidden;
        }
        
        .header {
            background: var(--bg-primary);
            color: var(--gray-900);
            padding: var(--spacing-xl) var(--spacing-lg);
            border-bottom: 1px solid var(--gray-200);
            position: relative;
        }
        
        .header h1 {
            font-size: var(--font-size-3xl);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            letter-spacing: -0.025em;
            color: var(--gray-900);
            line-height: 1.2;
        }
        
        .header .subtitle {
            font-size: var(--font-size-sm);
            font-weight: 400;
            color: var(--gray-600);
            margin-top: var(--spacing-xs);
        }
        
        /* Ê±âÂ†°ËèúÂçïÊåâÈíÆ - SaaS È£éÊ†º */
        .menu-toggle {
            position: fixed;
            top: var(--spacing-md);
            right: var(--spacing-md);
            z-index: 1001;
            width: 40px !important;
            height: 40px;
            background: var(--bg-primary);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            gap: 5px;
            padding: 0 !important;
            margin: 0 !important;
            box-sizing: border-box;
        }
        
        .menu-toggle:hover {
            background: var(--gray-50);
            border-color: var(--gray-300);
            box-shadow: var(--shadow-md);
        }
        
        .menu-toggle.active {
            background: var(--gray-50);
            border-color: var(--primary-color);
        }
        
        .menu-toggle span {
            display: block;
            width: 20px;
            height: 2px;
            background: var(--gray-700);
            transition: var(--transition);
            border-radius: 1px;
        }
        
        .menu-toggle.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        
        .menu-toggle.active span:nth-child(2) {
            opacity: 0;
        }
        
        .menu-toggle.active span:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }
        
        /* ÊµÆÂä®ËèúÂçï - SaaS È£éÊ†º */
        .floating-menu {
            position: fixed;
            top: 60px;
            right: var(--spacing-md);
            left: auto;
            z-index: 1000;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--gray-200);
            min-width: 240px;
            max-width: 300px;
            width: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px) scale(0.98);
            transition: var(--transition);
            overflow: hidden;
        }
        
        .floating-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        
        .menu-header {
            background: var(--gray-900);
            color: white;
            padding: var(--spacing-lg);
            font-weight: 600;
            font-size: var(--font-size-xl);
            border-bottom: 1px solid var(--gray-200);
        }
        
        .menu-header h2 {
            font-size: var(--font-size-xl);
            margin: 0;
            font-weight: 600;
        }
        
        .menu-item {
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--gray-100);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0;
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }
        
        .menu-item:hover {
            background: var(--gray-50);
        }
        
        .menu-item-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 12px;
        }
        
        .menu-item-label {
            flex: 1;
            font-weight: 500;
            color: var(--gray-700);
            font-size: 16px;
        }
        
        .menu-item-value {
            color: #6b7280;
            font-size: 14px;
        }
        
        .menu-item.active {
            background: rgba(99, 91, 255, 0.08);
            color: var(--primary-color);
        }
        
        .menu-item.active .menu-item-label {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .menu-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 8px 0;
        }
        
        /* ËØ≠Ë®ÄÈÄâÊã©Âô®Âú®ËèúÂçï‰∏≠ */
        .language-options {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px 20px;
            background: #f9fafb;
        }
        
        .lang-option {
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
        }
        
        .lang-option:hover {
            background: #f0f0f0;
        }
        
        .lang-option.active {
            background: var(--primary-color);
            color: white;
        }
        
        .lang-option.active .menu-item-label {
            color: white;
        }
        
        .lang-check {
            font-size: 18px;
            font-weight: bold;
        }
        
        /* ËèúÂçïÈÅÆÁΩ©Â±Ç */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            backdrop-filter: blur(2px);
        }
        
        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .content {
            padding: var(--spacing-xl) var(--spacing-lg);
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Â∫ïÈÉ®ÂØºËà™ËèúÂçï - SaaS È£éÊ†º */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border-top: 1px solid var(--gray-200);
            padding: var(--spacing-sm) 0;
            z-index: 100;
            box-shadow: 0 -1px 3px rgba(0,0,0,0.05);
        }
        
        .bottom-nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .bottom-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray-500);
            text-decoration: none;
            min-width: 0;
            border-radius: var(--radius-md);
            margin: 0 var(--spacing-xs);
        }
        
        .bottom-nav-item:hover {
            color: var(--primary-color);
            background: var(--gray-50);
        }
        
        .bottom-nav-item.active {
            color: var(--primary-color);
        }
        
        .bottom-nav-icon {
            font-size: 20px;
            margin-bottom: var(--spacing-xs);
            line-height: 1;
        }
        
        .bottom-nav-label {
            font-size: var(--font-size-xs);
            font-weight: 500;
            letter-spacing: 0;
        }
        
        .bottom-nav-item.active .bottom-nav-label {
            font-weight: 600;
        }
        
        .section {
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-xl);
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }
        
        .section:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--gray-300);
        }
        
        .section h2 {
            color: var(--gray-900);
            margin-bottom: var(--spacing-lg);
            font-size: var(--font-size-xl);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            letter-spacing: -0.01em;
        }
        
        .section h2::before {
            display: none;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: var(--spacing-sm);
            color: var(--gray-700);
            font-weight: 500;
            font-size: var(--font-size-sm);
            letter-spacing: 0;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            transition: var(--transition);
            background: var(--bg-primary);
            color: var(--gray-900);
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }
        
        .form-group input:disabled,
        .form-group select:disabled {
            background: var(--gray-50);
            cursor: not-allowed;
            color: var(--gray-500);
        }
        
        .form-group select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%234b5563' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            transition: var(--transition);
            background: var(--bg-primary);
            color: var(--gray-900);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }
        
        .form-hint {
            display: block;
            margin-top: var(--spacing-xs);
            font-size: var(--font-size-xs);
            color: var(--gray-500);
            font-weight: 400;
            line-height: 1.4;
        }
        
        .profile-form {
            max-width: 600px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
        }
        
        button:not(.filter-tab):not(.menu-toggle):not(.btn-detail):not(.btn-cancel):not(.order-info-close-btn) {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            margin-top: var(--spacing-sm);
            box-shadow: var(--shadow-sm);
        }
        
        button:hover:not(:disabled) {
            background: var(--primary-dark);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        
        button:disabled {
            background: var(--gray-300);
            color: var(--gray-500);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        button.secondary {
            background: var(--bg-primary);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }
        
        button.secondary:hover:not(:disabled) {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }
        
        .status {
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            font-size: var(--font-size-sm);
            line-height: 1.5;
            border: 1px solid;
        }
        
        .status.success {
            background: #ecfdf5;
            color: #065f46;
            border-color: var(--success-color);
        }
        
        .status.error {
            background: #fef2f2;
            color: #991b1b;
            border-color: var(--error-color);
        }
        
        .status.info {
            background: #eff6ff;
            color: #1e40af;
            border-color: var(--info-color);
        }
        
        .status.warning {
            background: #fffbeb;
            color: #92400e;
            border-color: var(--warning-color);
        }
        
        .account-info {
            background: var(--bg-primary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
        }
        
        .account-info strong {
            color: var(--gray-600);
            font-weight: 500;
            display: block;
            margin-bottom: var(--spacing-xs);
            font-size: var(--font-size-xs);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .account-info span {
            color: var(--gray-900);
            font-family: 'SF Mono', 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: var(--font-size-sm);
            word-break: break-all;
            font-weight: 500;
        }
        
        /* ËÆ¢ÂçïËØ¶ÊÉÖÊ®°ÊÄÅÂØπËØùÊ°Ü */
        .order-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        
        .order-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .order-modal-content {
            position: relative;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            max-width: 90vw;
            max-height: 90vh;
            width: 100%;
            max-width: 800px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            animation: slideUp 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        #order-modal-body {
            overflow-y: auto;
            max-height: 90vh;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .order-info {
            background: var(--bg-primary);
            padding: 0;
            border-radius: var(--radius-lg);
            margin: 0;
            border: none;
            box-shadow: none;
            overflow: hidden;
            position: relative;
        }
        
        .order-info-header {
            background: var(--gray-900);
            padding: var(--spacing-lg) var(--spacing-xl);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .order-info h3 {
            color: white;
            margin: 0;
            font-size: var(--font-size-xl);
            font-weight: 600;
            letter-spacing: -0.01em;
        }
        
        .order-info-close-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 32px !important;
            height: 32px;
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 300;
            transition: var(--transition);
            padding: 0 !important;
            margin: 0 !important;
            line-height: 1;
            flex-shrink: 0;
        }
        
        .order-info-close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .order-info-close-btn:active {
            transform: scale(0.95);
        }
        
        .order-info-content {
            padding: var(--spacing-xl);
        }
        
        .driver-info-container {
            padding: var(--spacing-xl);
        }
        
        /* ÂèØÊäòÂè†Âç°ÁâáÊ†∑Âºè */
        .collapsible-card {
            transition: all 0.3s ease;
        }
        
        /* Dispute Section Ê†∑Âºè */
        .dispute-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 16px;
            background: #fafafa;
        }
        
        .dispute-section h3 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #1f2937;
            font-size: 16px;
            font-weight: 700;
        }
        
        .collapsible-header {
            transition: background-color 0.2s ease;
        }
        
        .collapsible-header:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .collapsible-icon {
            transition: transform 0.3s ease;
        }
        
        .collapsible-icon.expanded {
            transform: rotate(180deg);
        }
        
        .collapsible-content {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }
        
        .order-info .info-row {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-md) 0;
            border-bottom: 1px solid var(--gray-100);
        }
        
        .order-info .info-row:last-child {
            border-bottom: none;
        }
        
        .order-info .info-label {
            color: var(--gray-600);
            font-weight: 500;
            font-size: var(--font-size-sm);
        }
        
        .order-info .info-value {
            color: var(--gray-900);
            font-size: var(--font-size-sm);
            text-align: right;
            word-break: break-all;
            font-family: 'SF Mono', 'Monaco', 'Menlo', 'Courier New', monospace;
            font-weight: 500;
        }
        
        .order-info .info-value a {
            color: var(--primary-color);
            text-decoration: none;
            border-bottom: 1px dotted;
        }
        
        .order-info .info-value a:hover {
            border-bottom: 1px solid;
        }
        
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .badge.disputed {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        
        .badge.pending {
            background: #fffbeb;
            color: #92400e;
            border: 1px solid #fef3c7;
        }
        
        .badge.accepted {
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid #dbeafe;
        }
        
        .badge.picked-up {
            background: #f5f3ff;
            color: #6b21a8;
            border: 1px solid #e9d5ff;
        }
        
        .badge.completed {
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #d1fae5;
        }
        
        .badge.cancelled {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fee2e2;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 32px;
            }
            
            .content {
                padding: 15px;
            }
            
            .section {
                padding: 18px;
            }
            
            .bottom-nav {
                padding: 6px 0;
            }
            
            .bottom-nav-icon {
                font-size: 22px;
            }
            
            .bottom-nav-label {
                font-size: 10px;
            }
            
            .menu-toggle {
                top: 12px;
                right: 12px;
                width: 36px;
                height: 36px;
            }
            
            .menu-toggle span {
                width: 18px;
                height: 3.5px;
                margin: 0;
                padding: 0;
                min-height: 3.5px;
            }
            
            .menu-toggle {
                padding: 6px;
            }
            
            .floating-menu {
                top: 55px;
                right: 12px;
                left: auto;
                max-width: 300px;
                min-width: 240px;
                width: auto;
            }
            
            .header {
                padding: 50px 15px 25px 15px;
            }
            
            .header h1 {
                font-size: 28px;
            }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Orders Âíå Profile ËßÜÂõæÊ†∑Âºè */
        .view-container {
            min-height: calc(100vh - 80px);
            padding-bottom: 80px;
        }
        
        /* Á≠õÈÄâÊ†áÁ≠æ - SaaS È£éÊ†º */
        .filter-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            padding: 0 16px;
            border-bottom: 2px solid #e5e7eb;
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
        
        .filter-tabs::-webkit-scrollbar {
            height: 6px;
        }
        
        .filter-tabs::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .filter-tabs::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .filter-tabs::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .filter-tab {
            padding: 12px 20px;
            border: none !important;
            background: transparent !important;
            color: #6b7280;
            border-radius: 0 !important;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            position: relative;
            margin-bottom: -2px;
            outline: none !important;
            box-shadow: none !important;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: auto !important;
            margin-top: 0 !important;
        }
        
        .filter-tab:hover {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.05) !important;
            border: none !important;
            box-shadow: none !important;
        }
        
        .filter-tab:focus {
            outline: none !important;
            box-shadow: none !important;
            border: none !important;
        }
        
        .filter-tab.active {
            background: transparent !important;
            border: none !important;
            color: #3b82f6 !important;
            font-weight: 600 !important;
            box-shadow: none !important;
            outline: none !important;
        }
        
        .filter-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #3b82f6;
            z-index: 1;
        }
        
        /* ËÆ¢ÂçïÂàóË°® */
        .orders-list {
            padding: var(--spacing-xl);
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* ÁªüËÆ°ËßÜÂõæÊ†∑Âºè */
        .statistics-view {
            padding: var(--spacing-xl);
            background: var(--bg-secondary);
            margin: 0;
        }
        
        .statistics-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .statistics-container h2 {
            color: var(--gray-900);
            margin-bottom: var(--spacing-lg);
            font-size: var(--font-size-xl);
            font-weight: 600;
        }
        
        .chart-container {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            min-height: 300px;
            overflow-x: auto;
        }
        
        .order-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            cursor: pointer;
        }
        
        .order-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--gray-300);
            transform: translateY(-1px);
        }
        
        .order-card.disputed {
            border: 2px solid #ef4444;
        }
        
        .order-card.disputed:hover {
            border-color: #dc2626;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.1), 0 2px 4px -1px rgba(239, 68, 68, 0.06);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--gray-100);
        }
        
        .order-date {
            font-size: var(--font-size-xs);
            color: var(--gray-500);
            font-weight: 500;
            letter-spacing: 0;
        }
        
        .order-status-badge {
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .order-route {
            margin: 16px 0;
        }
        
        .route-point {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .route-point:last-child {
            margin-bottom: 0;
        }
        
        .route-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        .route-icon.pickup {
            background: var(--primary-color);
            color: white;
        }
        
        .route-icon.destination {
            background: var(--error-color);
            color: white;
        }
        
        .route-line {
            width: 2px;
            height: 20px;
            background: #e5e7eb;
            margin-left: 11px;
            margin-right: 12px;
        }
        
        .route-address {
            flex: 1;
            font-size: var(--font-size-sm);
            color: var(--gray-900);
            line-height: 1.5;
            font-weight: 500;
        }
        
        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--gray-100);
            margin-top: var(--spacing-md);
            gap: var(--spacing-md);
        }
        
        .order-footer > div:last-child {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
            justify-content: flex-end;
            flex-shrink: 0;
        }
        
        .btn-detail {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-detail:hover {
            background: var(--primary-dark);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }
        
        .btn-detail:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        
        .btn-cancel {
            background: var(--bg-primary);
            color: var(--error-color);
            border: 1px solid var(--gray-300);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            margin-left: var(--spacing-sm);
        }
        
        .btn-cancel:hover {
            background: #fef2f2;
            border-color: var(--error-color);
            color: var(--error-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .btn-cancel:active {
            transform: translateY(0);
        }
        
        .order-fare {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .order-id {
            font-size: var(--font-size-xs);
            color: var(--gray-500);
            font-family: 'SF Mono', 'Monaco', 'Menlo', 'Courier New', monospace;
            font-weight: 500;
        }
        
        /* Âä†ËΩΩÂíåÁ©∫Áä∂ÊÄÅ */
        .loading-state, .empty-state {
            text-align: center;
            padding: var(--spacing-2xl) var(--spacing-xl);
        }
        
        .empty-icon {
            font-size: 56px;
            margin-bottom: var(--spacing-lg);
            opacity: 0.4;
        }
        
        .empty-state p {
            color: var(--gray-600);
            font-size: var(--font-size-base);
            margin: var(--spacing-sm) 0;
            font-weight: 500;
        }
        
        .empty-hint {
            font-size: var(--font-size-sm) !important;
            color: var(--gray-500) !important;
            font-weight: 400 !important;
        }
        
        /* Profile Ê†∑Âºè - SaaS È£éÊ†º */
        .profile-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }
        
        .profile-avatar {
            flex-shrink: 0;
        }
        
        .avatar-circle {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 600;
            color: white;
            border: 2px solid var(--gray-200);
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-info h2 {
            color: var(--gray-900);
            font-size: var(--font-size-2xl);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            letter-spacing: -0.01em;
        }
        
        .profile-address {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
            font-family: 'SF Mono', 'Monaco', 'Menlo', 'Courier New', monospace;
            word-break: break-all;
            margin: var(--spacing-xs) 0;
            font-weight: 500;
        }
        
        .profile-role {
            font-size: var(--font-size-sm);
            color: var(--gray-500);
            margin-top: var(--spacing-xs);
            font-weight: 500;
        }
        
        /* ÁªüËÆ°Âç°Áâá - SaaS È£éÊ†º */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }
        
        .stat-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            text-align: left;
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }
        
        .stat-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--gray-300);
        }
        
        .stat-value {
            font-size: var(--font-size-2xl);
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--spacing-xs);
            letter-spacing: -0.02em;
        }
        
        .stat-label {
            font-size: var(--font-size-xs);
            color: var(--gray-600);
            font-weight: 500;
            letter-spacing: 0;
        }
        
        /* ËÆæÁΩÆÂàóË°® - SaaS È£éÊ†º */
        .settings-list {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--gray-100);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        .setting-item:hover {
            background: var(--gray-50);
        }
        
        .setting-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: var(--spacing-md);
            flex-shrink: 0;
        }
        
        .setting-content {
            flex: 1;
        }
        
        .setting-title {
            font-size: var(--font-size-base);
            font-weight: 500;
            color: var(--gray-900);
            margin-bottom: var(--spacing-xs);
        }
        
        .setting-desc {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
            font-weight: 400;
        }
        
        .setting-arrow {
            font-size: 20px;
            color: var(--gray-400);
            margin-left: var(--spacing-md);
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .profile-card {
                flex-direction: column;
                text-align: center;
            }
            
            .filter-tabs {
                padding: 12px 16px;
            }
        }
    </style>
</head>
<body>
    <!-- ËèúÂçïÈÅÆÁΩ©Â±Ç -->
    <div class="menu-overlay" id="menu-overlay" onclick="toggleMenu()"></div>
    
    <!-- Ê±âÂ†°ËèúÂçïÊåâÈíÆ -->
    <button class="menu-toggle" id="menu-toggle" onclick="toggleMenu()" aria-label="Menu">
        <span></span>
        <span></span>
        <span></span>
    </button>
    
    <!-- ËÆ¢ÂçïËØ¶ÊÉÖÊ®°ÊÄÅÂØπËØùÊ°Ü -->
    <div class="order-modal" id="order-modal" style="display: none;">
        <div class="order-modal-overlay" onclick="closeOrderModal()"></div>
        <div class="order-modal-content">
            <div id="order-modal-body"></div>
        </div>
    </div>
    
    <!-- ÊµÆÂä®ËèúÂçï -->
    <div class="floating-menu" id="floating-menu">
        <div class="menu-header">
            <h2>‚öôÔ∏è <span data-i18n="systemMenu">System Menu</span></h2>
        </div>
        
        <div class="menu-item" id="menu-nav-orders" onclick="navigateFromMenu('orders'); toggleMenu();">
            <div class="menu-item-icon">üìã</div>
            <div class="menu-item-label">My Orders</div>
        </div>
        
        <div class="menu-item" id="menu-nav-profile" onclick="navigateFromMenu('profile'); toggleMenu();">
            <div class="menu-item-icon">üë§</div>
            <div class="menu-item-label">Profile</div>
        </div>
        
        <div class="menu-divider"></div>
        
        <div class="menu-item" id="menu-connection-status" style="display: none;">
            <div class="menu-item-icon">üîó</div>
            <div class="menu-item-label" id="menu-connection-text">Connected</div>
            <span style="font-size: 12px; color: #10b981; margin-left: 8px;">‚úì</span>
        </div>
        
        <div class="menu-item" id="menu-account-info" style="display: none;" onclick="showWalletInfo(); toggleMenu();">
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div style="display: flex; align-items: center; width: 100%;">
                    <div class="menu-item-icon">üíº</div>
                    <div class="menu-item-label">Wallet Info</div>
                </div>
                <div id="menu-account-address" style="font-size: 11px; color: #6b7280; margin-top: 4px; margin-left: 36px; font-family: monospace; word-break: break-all;"></div>
            </div>
        </div>
        
        <div class="menu-item" onclick="switchAccount(); toggleMenu();">
            <div class="menu-item-icon">üîÑ</div>
            <div class="menu-item-label">Switch Account</div>
        </div>
        
        <div class="menu-item" onclick="showNetworkInfo(); toggleMenu();">
            <div class="menu-item-icon">üåê</div>
            <div class="menu-item-label">Network Info</div>
        </div>
        
        <div class="menu-item" id="language-menu-item" onclick="toggleLanguageMenu()">
            <div class="menu-item-icon">üåê</div>
            <div class="menu-item-label">Language</div>
            <span id="current-lang" style="font-size: 14px; color: #6b7280;">EN</span>
        </div>
        
        <div class="language-options" id="language-options" style="display: none;">
            <div class="lang-option active" id="lang-option-en" onclick="selectLanguage('en')">
                <span class="menu-item-label">English</span>
                <span class="lang-check" id="lang-check-en">‚úì</span>
            </div>
            <div class="lang-option" id="lang-option-zh" onclick="selectLanguage('zh')">
                <span class="menu-item-label">‰∏≠Êñá</span>
                <span class="lang-check" id="lang-check-zh" style="display: none;">‚úì</span>
            </div>
        </div>
        
        <div class="menu-divider"></div>
        
        <div class="menu-item" onclick="location.reload();">
            <div class="menu-item-icon">üîÑ</div>
            <div class="menu-item-label">Refresh Page</div>
        </div>
    </div>
    
    <div class="container fade-in">
        <div class="header">
            <h1 data-i18n="title">TrustFlow</h1>
            <p class="subtitle" data-i18n="subtitle">Decentralized Rental Payment System</p>
        </div>
        
        <div class="content" id="main-content">
            <!-- ËøûÊé•Èí±ÂåÖÂå∫Âüü -->
            <div class="section">
                <h2 data-i18n="walletSection">1. Connect Wallet</h2>
                <div id="wallet-status" class="status info" data-i18n="walletStatus">Please connect your wallet to get started</div>
                
                <!-- ÁßªÂä®Á´ØÈí±ÂåÖÊèêÁ§∫ -->
                <div id="mobile-wallet-guide" class="status info" style="display: none; margin-top: 15px;">
                    <strong data-i18n="mobileWalletGuide">üì± Mobile Wallet Guide</strong>
                    <p style="margin-top: 10px; margin-bottom: 5px;" data-i18n="mobileWalletOptions">For mobile devices, you can use:</p>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li><a href="https://metamask.io/download/" target="_blank" data-i18n="metamaskMobile">MetaMask Mobile App</a></li>
                        <li data-i18n="walletConnect">WalletConnect (QR Code)</li>
                        <li><a href="https://trustwallet.com/" target="_blank" data-i18n="trustWallet">Trust Wallet</a></li>
                        <li><a href="https://www.coinbase.com/wallet" target="_blank" data-i18n="coinbaseWallet">Coinbase Wallet</a></li>
                    </ul>
                    <p style="margin-top: 10px; font-size: 0.9em;">
                        <strong>Tip:</strong> If you have MetaMask Mobile installed, click "Connect Wallet" to open it automatically.
                    </p>
                </div>
                
                <!-- Ë¥¶Êà∑‰ø°ÊÅØÂ∑≤ÁßªÂà∞ËèúÂçï‰∏≠ -->
                <button id="connect-btn" data-i18n="connectWallet">Connect Wallet</button>
            </div>
            
            <!-- ËÆ¢ÂçïÂàõÂª∫Ë°®Âçï -->
            <div class="section" id="order-form-section" style="display: none;">
                <h2 data-i18n="orderSection">2. Create Order</h2>
                
                <div class="grid">
                    <div class="form-group">
                        <label data-i18n="pickupAddress">Pickup Address</label>
                        <input type="text" id="pickup-address" data-i18n="pickupAddressPlaceholder" placeholder="e.g., Tiananmen Square" value="Tiananmen Square">
                    </div>
                    <div class="form-group">
                        <label data-i18n="destinationAddress">Destination Address</label>
                        <input type="text" id="dest-address" data-i18n="destinationAddressPlaceholder" placeholder="e.g., National Stadium (Bird's Nest)" value="National Stadium (Bird's Nest)">
                    </div>
                </div>
                
                <div class="grid">
                    <div class="form-group">
                        <label data-i18n="pickupLatitude">Pickup Latitude</label>
                        <input type="number" id="pickup-lat" placeholder="39.9" value="39.9" step="0.000001">
                    </div>
                    <div class="form-group">
                        <label data-i18n="pickupLongitude">Pickup Longitude</label>
                        <input type="number" id="pickup-lng" placeholder="116.4" value="116.4" step="0.000001">
                    </div>
                </div>
                
                <div class="grid">
                    <div class="form-group">
                        <label data-i18n="destinationLatitude">Destination Latitude</label>
                        <input type="number" id="dest-lat" placeholder="40.0" value="40.0" step="0.000001">
                    </div>
                    <div class="form-group">
                        <label data-i18n="destinationLongitude">Destination Longitude</label>
                        <input type="number" id="dest-lng" placeholder="116.4" value="116.4" step="0.000001">
                    </div>
                </div>
                
                <!-- Category Âíå SubCategory ÈÄâÊã© -->
                <div class="grid">
                    <div class="form-group">
                        <label data-i18n="category">Category</label>
                        <select id="category-select" onchange="updateSubCategoryOptions()">
                            <option value="rental" selected>Rentals</option>
                            <option value="goods">Goods</option>
                            <option value="services">Services</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="subCategory">Sub Category</label>
                        <select id="subcategory-select">
                            <option value="rental car" selected>Car</option>
                            <option value="rental scooter">Scooter</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label data-i18n="estimatedFare">Estimated Fare (ETH)</label>
                    <input type="number" id="estimated-fare" placeholder="25.00" value="25.00" step="0.01" min="0">
                </div>
                
                <button id="calculate-btn" onclick="calculateFare()" data-i18n="calculateFare">Calculate Fare</button>
                <button id="create-order-btn" onclick="createOrder()" style="display: none;" data-i18n="createOrder">Create Order</button>
            </div>
            
            <!-- ËÆ¢Âçï‰ø°ÊÅØÊòæÁ§∫ -->
            <div id="order-info" style="display: none;"></div>
        </div>
        
        <!-- Orders ËßÜÂõæ -->
        <div id="orders-view" class="view-container" style="display: none;">
            <!-- ËÆ¢ÂçïËØ¶ÊÉÖÊòæÁ§∫Âå∫ÂüüÔºàÂú® Orders ËßÜÂõæ‰∏≠Ôºâ -->
            <div id="order-info-in-orders-view" style="display: none; margin: 20px; padding: 0; position: relative;"></div>
            <div class="content">
                <!-- Á≠õÈÄâÊ†áÁ≠æ -->
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterOrders('all')" data-i18n="all">All</button>
                    <button class="filter-tab" onclick="filterOrders('pending')" data-i18n="pending">Pending</button>
                    <button class="filter-tab" onclick="filterOrders('completed')" data-i18n="completed">Completed</button>
                    <button class="filter-tab" onclick="filterOrders('cancelled')" data-i18n="cancelled">Cancelled</button>
                    <button class="filter-tab" onclick="filterOrders('statistics')" data-i18n="statistics">üìä Statistics</button>
                </div>
                
                <!-- ÁªüËÆ°ËßÜÂõæ -->
                <div id="orders-statistics" class="statistics-view" style="display: none;">
                    <div class="statistics-container">
                        <h2 style="margin-bottom: 20px; font-size: 20px; font-weight: 600; color: #1f2937;">Daily Orders Statistics</h2>
                        <div id="daily-orders-chart" class="chart-container">
                            <!-- Êù°Áä∂ÂõæÂ∞ÜÂú®ËøôÈáåÊ∏≤Êüì -->
                        </div>
                    </div>
                </div>
                
                <!-- ËÆ¢ÂçïÂàóË°® -->
                <div id="orders-list" class="orders-list">
                    <div class="loading-state" id="orders-loading">
                        <div class="loading"></div>
                        <p data-i18n="loadingOrders">Loading orders...</p>
                    </div>
                    <div class="empty-state" id="orders-empty" style="display: none;">
                        <div class="empty-icon">üìã</div>
                        <p data-i18n="noOrders">No orders yet</p>
                        <p class="empty-hint" data-i18n="createFirstOrder">Create your first order to get started</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Profile ËßÜÂõæ -->
        <div id="profile-view" class="view-container" style="display: none;">
            <div class="content">
                <!-- Áî®Êà∑‰ø°ÊÅØÂç°Áâá -->
                <div class="profile-card">
                    <div class="profile-avatar">
                        <div class="avatar-circle">
                            <span id="profile-initials">U</span>
                        </div>
                    </div>
                    <div class="profile-info">
                        <h2 id="profile-name" data-i18n="user">User</h2>
                        <p class="profile-address" id="profile-address">-</p>
                        <p class="profile-role" id="profile-role" data-i18n="passenger">Passenger</p>
                    </div>
                </div>
                
                <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-total-orders">0</div>
                        <div class="stat-label" data-i18n="totalOrders">Total Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-completed-orders">0</div>
                        <div class="stat-label" data-i18n="completedOrders">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-total-spent">$0.00</div>
                        <div class="stat-label" data-i18n="totalSpent">Total Spent</div>
                    </div>
                </div>
                
                <!-- ‰∏™‰∫∫‰ø°ÊÅØËÆæÁΩÆ -->
                <div class="section">
                    <h2 data-i18n="personalInfo">Personal Information</h2>
                    <div class="profile-form">
                        <div class="form-group">
                            <label for="profile-nickname" data-i18n="nickname">Nickname</label>
                            <input type="text" id="profile-nickname" class="form-input" placeholder="Enter your nickname" />
                            <small class="form-hint" data-i18n="nicknameHint">Display name for rental orders</small>
                        </div>
                        <div class="form-group">
                            <label for="profile-contact" data-i18n="contactMethod">Contact Method</label>
                            <input type="text" id="profile-contact" class="form-input" placeholder="Phone number, email, or Telegram" />
                            <small class="form-hint" data-i18n="contactHint">How drivers can contact you (phone, email, etc.)</small>
                        </div>
                        <button class="btn-primary" onclick="saveProfile()" data-i18n="saveProfile">Save Profile</button>
                    </div>
                </div>
                
                <!-- Ë¥¶Êà∑ËÆæÁΩÆ -->
                <div class="section">
                    <h2 data-i18n="accountSettings">Account Settings</h2>
                    <div class="settings-list">
                        <div class="setting-item" onclick="showWalletInfo()">
                            <div class="setting-icon">üíº</div>
                            <div class="setting-content">
                                <div class="setting-title" data-i18n="wallet">Wallet</div>
                                <div class="setting-desc" id="setting-wallet-address">-</div>
                            </div>
                            <div class="setting-arrow">‚Ä∫</div>
                        </div>
                        <div class="setting-item" onclick="showNetworkInfo()">
                            <div class="setting-icon">üåê</div>
                            <div class="setting-content">
                                <div class="setting-title" data-i18n="network">Network</div>
                                <div class="setting-desc" id="setting-network">-</div>
                            </div>
                            <div class="setting-arrow">‚Ä∫</div>
                        </div>
                        <div class="setting-item" onclick="clearCache()">
                            <div class="setting-icon">üóëÔ∏è</div>
                            <div class="setting-content">
                                <div class="setting-title" data-i18n="clearCache">Clear Cache</div>
                                <div class="setting-desc" data-i18n="clearCacheDesc">Clear stored data</div>
                            </div>
                            <div class="setting-arrow">‚Ä∫</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Â∫ïÈÉ®ÂØºËà™ËèúÂçï -->
    <nav class="bottom-nav">
        <div class="bottom-nav-items">
            <div class="bottom-nav-item active" id="nav-contract" onclick="showContractView()">
                <div class="bottom-nav-icon">üìÑ</div>
                <div class="bottom-nav-label" data-i18n="contract">Contract</div>
            </div>
            <div class="bottom-nav-item" id="nav-orders" onclick="showOrdersView()">
                <div class="bottom-nav-icon">üìã</div>
                <div class="bottom-nav-label" data-i18n="orders">Orders</div>
            </div>
            <div class="bottom-nav-item" id="nav-profile" onclick="showProfileView()">
                <div class="bottom-nav-icon">üë§</div>
                <div class="bottom-nav-label" data-i18n="profile">Profile</div>
            </div>
        </div>
    </nav>

    <script>
        // First define all placeholder functions to ensure functions are always defined (can be used before script loads)
        // This prevents onclick errors even while scripts are still loading
        
        window.toggleMenu = function() {
            console.log('toggleMenu: Function not yet initialized, please wait...');
        };
        
        window.toggleLanguageMenu = function() {
            console.log('toggleLanguageMenu: Function not yet initialized, please wait...');
        };
        
        window.selectLanguage = function(lang) {
            console.log('selectLanguage: Function not yet initialized, please wait...');
        };
        
        window.showAbout = function() {
            console.log('showAbout: Function not yet initialized, please wait...');
        };
        
        window.showHelp = function() {
            console.log('showHelp: Function not yet initialized, please wait...');
        };
        
        // Use flag to track if function has been initialized
        window._connectWalletInitialized = false;
        // Placeholder function - will be replaced in IIFE
        window.connectWallet = async function() {
            if (!window._connectWalletInitialized) {
                console.log('connectWallet: Function not yet initialized, waiting for scripts to load...');
                const walletStatus = document.getElementById('wallet-status');
                if (walletStatus) {
                    walletStatus.className = 'status warning';
                    walletStatus.textContent = 'Please wait, initializing...';
                }
                // Retry with delay, up to 10 retries (2 seconds)
                let retries = 0;
                const maxRetries = 10;
                const checkInterval = setInterval(() => {
                    retries++;
                    if (window._connectWalletInitialized && typeof window.connectWallet === 'function') {
                        clearInterval(checkInterval);
                        // Save reference to the real function
                        const realConnectWallet = window.connectWallet;
                        // Call the real function (using saved reference to avoid recursion)
                        if (realConnectWallet && realConnectWallet.toString().indexOf('not yet initialized') === -1) {
                            realConnectWallet().catch(err => {
                                console.error('Error calling connectWallet:', err);
                            });
                        }
                    } else if (retries >= maxRetries) {
                        clearInterval(checkInterval);
                        console.warn('connectWallet: Still not initialized after retries');
                        if (walletStatus) {
                            walletStatus.className = 'status error';
                            walletStatus.textContent = 'Error: Failed to initialize. Please refresh the page.';
                        }
                    }
                }, 200);
                return; // Return immediately to avoid executing subsequent code
            } else {
                // If initialized but placeholder function still exists, IIFE may not have replaced it correctly
                // Try calling the real function
                console.warn('connectWallet: Placeholder function called but initialized flag is true');
            }
        };
        
        window.calculateFare = function() {
            console.log('calculateFare: Function not yet initialized, please wait...');
        };
        
        window.createOrder = function() {
            console.log('createOrder: Function not yet initialized, please wait...');
        };
        
        window.showContractView = function() {
            console.log('showContractView: Function not yet initialized, please wait...');
        };
        
        window.showOrdersView = function() {
            console.log('showOrdersView: Function not yet initialized, please wait...');
        };
        
        window.showProfileView = function() {
            console.log('showProfileView: Function not yet initialized, please wait...');
        };
        
        window.copyToClipboard = function(text) {
            console.log('copyToClipboard: Function not yet initialized, please wait...');
            // Simple fallback implementation
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    console.log('Copied to clipboard:', text);
                }).catch(err => {
                    console.error('Failed to copy:', err);
                });
            }
        };
        
        // Ensure functions are in global scope
        (function() {
            'use strict';
            
            // Global variables
            window.provider = null;
            window.signer = null;
            window.account = null;
            window.contracts = {};
            
            // Contract addresses (loaded from config.js or localStorage)
            let CONTRACT_ADDRESSES = {
                rideOrder: '',
                paymentEscrow: '',
                ratingSystem: ''
            };
            
            // Load contract addresses from localStorage or config.js
            // If config.js is loaded, prioritize using it
            if (typeof window !== 'undefined' && window.CONTRACT_ADDRESSES) {
                const configAddrs = window.CONTRACT_ADDRESSES;
                if (configAddrs.rideOrder) {
                    CONTRACT_ADDRESSES = Object.assign({}, configAddrs);
                }
            }
            
            // Load from localStorage (if config.js doesn't have addresses)
            if (!CONTRACT_ADDRESSES.rideOrder) {
                try {
                    const savedAddresses = {
                        rideOrder: localStorage.getItem('RIDE_ORDER_ADDRESS') || '',
                        paymentEscrow: localStorage.getItem('PAYMENT_ESCROW_ADDRESS') || '',
                        ratingSystem: localStorage.getItem('RATING_SYSTEM_ADDRESS') || ''
                    };
                    
                    if (savedAddresses.rideOrder) {
                        CONTRACT_ADDRESSES = savedAddresses;
                    }
                } catch (e) {
                    console.warn('Failed to load from localStorage:', e);
                }
            }
            
            // Expose contract addresses to global scope
            window.CONTRACT_ADDRESSES = CONTRACT_ADDRESSES;
            
            // Contract ABI (simplified version, only includes necessary functions)
            const TRUST_FLOW_RIDE_ABI = [
                "function createOrder(int256 _pickupLat, int256 _pickupLng, string memory _pickupAddress, int256 _destLat, int256 _destLng, string memory _destAddress, string memory _category, string memory _subCategory, uint256 _estimatedFare) external payable returns (uint256)",
                "function getOrder(uint256 _orderId) external view returns (tuple(uint256 orderId, address passenger, address driver, tuple(int256 latitude, int256 longitude, string addressText) pickup, tuple(int256 latitude, int256 longitude, string addressText) destination, string category, string subCategory, uint256 estimatedFare, uint256 actualFare, uint8 status, uint8 rideStatus, uint256 createdAt, uint256 acceptedAt, uint256 pickedUpAt, uint256 completedAt, uint256 startTimestamp, uint256 endTimestamp, string ipfsHash, bool disputeOpened, bool disputeResolved, address disputeOpener, address disputeWinner, string disputeReason, uint256 disputeOpenedAt, uint256 disputeResolvedAt, string disputeResolutionDetail))",
                "function getPassengerOrders(address _passenger) external view returns (uint256[] memory)",
                "function cancelOrder(uint256 _orderId, string memory _reason) external",
                "function getDisputeStatus(uint256 _orderId) external view returns (bool disputeOpened, string memory disputeReason, bool disputeResolved, address disputeOpener, address disputeWinner, uint256 disputeOpenedAt, uint256 disputeResolvedAt, string memory disputeResolutionDetail, uint8 rideStatus)",
                "function settle(uint256 _orderId) external",
                "function submitDispute(uint256 _orderId, string memory _reason) external",
                "function completeOrder(uint256 _orderId, uint256 _actualFare) external",
                "function orderCount() external view returns (uint256)",
                "event OrderCreated(uint256 indexed orderId, address indexed passenger, int256 pickupLat, int256 pickupLng, int256 destLat, int256 destLng, string category, string subCategory, uint256 estimatedFare)",
                "event OrderCancelled(uint256 indexed orderId, address indexed cancelledBy, string reason)",
                "event OrderAccepted(uint256 indexed orderId, address indexed driver)",
                "event RideAccepted(uint256 indexed orderId, address indexed driver, uint256 timestamp)",
                "event PassengerPickedUp(uint256 indexed orderId, uint256 timestamp)",
                "event RideStarted(uint256 indexed orderId, uint256 timestamp)",
                "event RideCompleted(uint256 indexed orderId, uint256 timestamp)",
                "event RideSettled(uint256 indexed orderId, uint256 timestamp)",
                "event DisputeOpened(uint256 indexed orderId, address indexed by, string reason, uint256 timestamp)",
                "event DisputeResolved(uint256 indexed orderId, address indexed winner, string detail, uint256 timestamp)"
            ];
            window.TRUST_FLOW_RIDE_ABI = TRUST_FLOW_RIDE_ABI;
            
            // TrustFlowEscrow contract ABI (using ETH)
            const TRUST_FLOW_ESCROW_ABI = [
                "function createOrder(address _driver) external payable returns (uint256)",
                "function startRide(uint256 _orderId) external",
                "function completeOrder(uint256 _orderId) external",
                "function cancelOrder(uint256 _orderId) external",
                "function getOrderDetails(uint256 _orderId) external view returns (tuple(uint256 orderId, address passenger, address driver, uint256 amount, uint256 platformFee, uint8 status, uint256 createdAt, uint256 completedAt))",
                "function platformWallet() external view returns (address)",
                "function platformFeeRate() external view returns (uint256)",
                "event OrderCreated(uint256 indexed orderId, address indexed passenger, uint256 amount)",
                "event PaymentLocked(uint256 indexed orderId, address indexed passenger, uint256 amount)",
                "event PaymentReleased(uint256 indexed orderId, address indexed driver, uint256 amount, uint256 platformFee, address platformWallet)",
                "event OrderCancelled(uint256 indexed orderId, address indexed passenger, uint256 refundAmount)"
            ];
            window.TRUST_FLOW_ESCROW_ABI = TRUST_FLOW_ESCROW_ABI;
            
            // Toggle menu - must be in global scope
            window.toggleMenu = function() {
                const menu = document.getElementById('floating-menu');
                const overlay = document.getElementById('menu-overlay');
                const toggle = document.getElementById('menu-toggle');
                
                if (menu && overlay && toggle) {
                    menu.classList.toggle('active');
                    overlay.classList.toggle('active');
                    toggle.classList.toggle('active');
                }
            };
            
            // Toggle language menu
            window.toggleLanguageMenu = function() {
                const langOptions = document.getElementById('language-options');
                if (langOptions) {
                    const isVisible = langOptions.style.display !== 'none';
                    langOptions.style.display = isVisible ? 'none' : 'block';
                }
            };
            
            // Select language
            window.selectLanguage = function(lang) {
                if (typeof i18n === 'undefined') {
                    console.error('i18n not loaded');
                    return;
                }
                
                i18n.setLanguage(lang);
                
                // Update language option status
                document.querySelectorAll('.lang-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                const activeOption = document.getElementById('lang-option-' + lang);
                if (activeOption) {
                    activeOption.classList.add('active');
                }
                
                // Update selected marker
                const checkEn = document.getElementById('lang-check-en');
                const checkZh = document.getElementById('lang-check-zh');
                if (checkEn) checkEn.style.display = lang === 'en' ? 'inline' : 'none';
                if (checkZh) checkZh.style.display = lang === 'zh' ? 'inline' : 'none';
                
                // Update current language display
                const currentLang = document.getElementById('current-lang');
                if (currentLang) {
                    currentLang.textContent = lang === 'en' ? 'EN' : '‰∏≠Êñá';
                }
                
                // Close language options
                const langOptions = document.getElementById('language-options');
                if (langOptions) {
                    langOptions.style.display = 'none';
                }
                
                // Update page text
                i18n.updatePage();
                
                // Update SubCategory option text (if options already exist)
                if (typeof updateSubCategoryOptions === 'function') {
                    updateSubCategoryOptions();
                }
            };
            
            // Show about information
            window.showAbout = function() {
                alert(
                    'TrustFlow - Decentralized Rental Payment System\n\n' +
                    'Version: 1.0.0\n' +
                    'Built with: Solidity, Hardhat, Ethers.js\n\n' +
                    '¬© 2024 TrustFlow. All rights reserved.'
                );
                if (window.toggleMenu) {
                    window.toggleMenu();
                }
            };
            
            // Show help information
            window.showHelp = function() {
                if (typeof i18n === 'undefined') {
                    alert('Help: Please check the documentation for more information.');
                    return;
                }
                
                const helpText = i18n.currentLang === 'zh' 
                    ? 'Â∏ÆÂä©‰ø°ÊÅØÔºö\n\n' +
                      '1. ËøûÊé•Èí±ÂåÖÔºöÁÇπÂáª"ËøûÊé•Èí±ÂåÖ"ÊåâÈíÆÔºåÂú®MetaMask‰∏≠Á°ÆËÆ§\n' +
                      '2. ÂàõÂª∫ËÆ¢ÂçïÔºöÂ°´ÂÜôËÆ¢Âçï‰ø°ÊÅØÔºåÁÇπÂáª"ÂàõÂª∫ËÆ¢Âçï"\n' +
                      '3. Êü•ÁúãËÆ¢ÂçïÔºöËÆ¢ÂçïÂàõÂª∫Âêé‰ºöÂú®‰∏ãÊñπÊòæÁ§∫ËØ¶ÊÉÖ\n\n' +
                      'Êõ¥Â§öÂ∏ÆÂä©ËØ∑Êü•ÁúãÊñáÊ°£„ÄÇ'
                    : 'Help:\n\n' +
                      '1. Connect Wallet: Click "Connect Wallet" and confirm in MetaMask\n' +
                      '2. Create Order: Fill in order details and click "Create Order"\n' +
                      '3. View Order: Order details will be displayed below after creation\n\n' +
                      'For more help, please check the documentation.';
                
                alert(helpText);
                if (window.toggleMenu) {
                    window.toggleMenu();
                }
            };
            
            // Bottom navigation functions - already redefined above
            
            window.showOrdersView = function() {
                // Switch to order list view
                if (window.setActiveNav) {
                    window.setActiveNav('nav-orders');
                }
                
                // Hide other views, show order view
                const mainContent = document.getElementById('main-content') || document.querySelector('.content');
                if (mainContent) mainContent.style.display = 'none';
                const ordersView = document.getElementById('orders-view');
                if (ordersView) {
                    ordersView.style.display = 'block';
                }
                const profileView = document.getElementById('profile-view');
                if (profileView) {
                    profileView.style.display = 'none';
                }
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Load order data (delay a bit to ensure DOM is ready)
                setTimeout(() => {
                    loadOrders();
                }, 50);
                
                // Update menu active status
                updateMenuActive('nav-orders');
            };
            
            // Navigate from menu
            window.navigateFromMenu = function(view) {
                if (view === 'orders') {
                    showOrdersView();
                } else if (view === 'profile') {
                    showProfileView();
                }
            };
            
            // Update menu active status
            function updateMenuActive(navId) {
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                let menuId = '';
                if (navId === 'nav-orders') {
                    menuId = 'menu-nav-orders';
                } else if (navId === 'nav-profile') {
                    menuId = 'menu-nav-profile';
                }
                
                const activeItem = document.getElementById(menuId);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
            }
            
            window.updateMenuActive = updateMenuActive;
            
            window.showProfileView = function() {
                // Switch to profile view
                if (window.setActiveNav) {
                    window.setActiveNav('nav-profile');
                }
                
                // Hide other views, show profile view
                const mainContent = document.getElementById('main-content') || document.querySelector('.content');
                if (mainContent) mainContent.style.display = 'none';
                document.getElementById('orders-view').style.display = 'none';
                document.getElementById('profile-view').style.display = 'block';
                
                // Update menu active status
                updateMenuActive('nav-profile');
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Load user profile
                loadProfile();
            };
            
            window.showContractView = function() {
                // Switch to contract view (create order)
                if (window.setActiveNav) {
                    window.setActiveNav('nav-contract');
                }
                
                // Show contract view, hide other views
                document.querySelector('.content').style.display = 'block';
                document.getElementById('orders-view').style.display = 'none';
                document.getElementById('profile-view').style.display = 'none';
            };
            
            // ETH to USD conversion function (using fixed rate, in actual project should get real-time rate from API)
            // Here using fixed rate 1 ETH = $2500 USD (can be modified according to actual situation)
            // Declare once at the top of IIFE for use by all functions
            const ETH_TO_USD_RATE = 2500; // Can get real-time exchange rate via API
            window.ETH_TO_USD_RATE = ETH_TO_USD_RATE; // Expose to global scope for use by external functions
            
            window.convertEthToUsd = function(ethAmount) {
                const eth = parseFloat(ethAmount) || 0;
                return (eth * ETH_TO_USD_RATE).toFixed(2);
            };
            
            window.formatCurrency = function(ethAmount) {
                return '$' + window.convertEthToUsd(ethAmount);
            };
            
            // Filter orders
            window.filterOrders = function(filter) {
                console.log('üìã Á≠õÈÄâËÆ¢ÂçïÔºåfilter:', filter);
                console.log('  - ÂΩìÂâçËÆ¢ÂçïÂàóË°®:', window.allOrders ? window.allOrders.length : 0, '‰∏™ËÆ¢Âçï');
                
                const ordersList = document.getElementById('orders-list');
                const statisticsView = document.getElementById('orders-statistics');
                
                // Update filter tab status - highlight currently selected tab
                document.querySelectorAll('.filter-tab').forEach(tab => {
                    tab.classList.remove('active');
                    tab.style.background = 'transparent';
                    tab.style.color = '#6b7280';
                    tab.style.fontWeight = '500';
                    tab.style.border = 'none';
                });
                
                // Find corresponding tab and activate, using blue text and underline
                const targetTab = document.querySelector(`.filter-tab[onclick*="filterOrders('${filter}')"]`);
                if (targetTab) {
                    targetTab.classList.add('active');
                    targetTab.style.background = 'transparent';
                    targetTab.style.color = '#3b82f6';
                    targetTab.style.fontWeight = '600';
                    targetTab.style.border = 'none';
                } else if (event && event.target) {
                    event.target.classList.add('active');
                    event.target.style.background = 'transparent';
                    event.target.style.color = '#3b82f6';
                    event.target.style.fontWeight = '600';
                    event.target.style.border = 'none';
                }
                
                // If it is statistics view, show statistics chart
                if (filter === 'statistics') {
                    if (ordersList) ordersList.style.display = 'none';
                    if (statisticsView) {
                        statisticsView.style.display = 'block';
                        renderDailyOrdersChart();
                    }
                    return;
                }
                
                // Otherwise hide statistics view, show order list
                if (statisticsView) statisticsView.style.display = 'none';
                if (ordersList) ordersList.style.display = 'block';
                
                // If order list is empty or not loaded, load orders first
                if (!window.allOrders || window.allOrders.length === 0) {
                    console.log('  - ËÆ¢ÂçïÂàóË°®‰∏∫Á©∫ÔºåÂÖàÂä†ËΩΩËÆ¢Âçï...');
                    if (window.loadOrders) {
                        window.loadOrders().then(() => {
                            // Filter again after loading completes
                            const orders = window.allOrders || [];
                            // Ensure Orders view is displayed
                            const ordersView = document.getElementById('orders-view');
                            if (ordersView && ordersView.style.display === 'none') {
                                ordersView.style.display = 'block';
                            }
                            setTimeout(() => {
                                renderOrders(orders, filter, 0);
                            }, 50);
                        }).catch(err => {
                            console.error('Âä†ËΩΩËÆ¢ÂçïÂ§±Ë¥•:', err);
                        });
                        return;
                    }
                }
                
                // Ensure Orders view is displayed
                let ordersView = document.getElementById('orders-view');
                if (ordersView && ordersView.style.display === 'none') {
                    console.log('üìã Âú® filterOrders ‰∏≠Ê£ÄÊµãÂà∞ Orders ËßÜÂõæÊú™ÊòæÁ§∫ÔºåÂÖàÊòæÁ§∫ËßÜÂõæ...');
                    ordersView.style.display = 'block';
                    // Give some time for DOM to render
                    setTimeout(() => {
                        filterOrders(filter);
                    }, 50);
                    return;
                }
                
                // Re-render order list (using latest order data)
                const orders = window.allOrders || [];
                console.log('  - Á≠õÈÄâÂâçËÆ¢ÂçïÊï∞:', orders.length);
                
                // Count orders by status (ensure status is numeric type)
                const filterStatusCount = {
                    pending: orders.filter(o => {
                        let status = o.status;
                        if (typeof status === 'number') {
                            status = status;
                        } else if (status && typeof status.toNumber === 'function') {
                            status = status.toNumber();
                        } else {
                            status = parseInt(status) || 0;
                        }
                        return status === 0;
                    }).length,
                    accepted: orders.filter(o => {
                        let status = o.status;
                        if (typeof status === 'number') {
                            status = status;
                        } else if (status && typeof status.toNumber === 'function') {
                            status = status.toNumber();
                        } else {
                            status = parseInt(status) || 0;
                        }
                        return status === 1;
                    }).length,
                    pickedUp: orders.filter(o => {
                        let status = o.status;
                        if (typeof status === 'number') {
                            status = status;
                        } else if (status && typeof status.toNumber === 'function') {
                            status = status.toNumber();
                        } else {
                            status = parseInt(status) || 0;
                        }
                        return status === 2;
                    }).length,
                    completed: orders.filter(o => {
                        let status = o.status;
                        if (typeof status === 'number') {
                            status = status;
                        } else if (status && typeof status.toNumber === 'function') {
                            status = status.toNumber();
                        } else {
                            status = parseInt(status) || 0;
                        }
                        return status === 3;
                    }).length,
                    cancelled: orders.filter(o => {
                        let status = o.status;
                        if (typeof status === 'number') {
                            status = status;
                        } else if (status && typeof status.toNumber === 'function') {
                            status = status.toNumber();
                        } else {
                            status = parseInt(status) || 0;
                        }
                        return status === 4;
                    }).length
                };
                console.log('  - ËÆ¢ÂçïÁä∂ÊÄÅÁªüËÆ°:', filterStatusCount);
                
                // Debug: show status of first few orders
                if (orders.length > 0) {
                    console.log('  - Ââç3‰∏™ËÆ¢ÂçïÁöÑÁä∂ÊÄÅ:', orders.slice(0, 3).map(o => ({
                        id: o.orderId,
                        status: typeof o.status === 'number' ? o.status : parseInt(o.status),
                        statusType: typeof o.status
                    })));
                }
                
                // Ensure Orders view is displayed (using existing ordersView variable)
                if (!ordersView) {
                    ordersView = document.getElementById('orders-view');
                }
                if (ordersView && ordersView.style.display === 'none') {
                    ordersView.style.display = 'block';
                    setTimeout(() => {
                        renderOrders(orders, filter, 0);
                    }, 50);
                } else {
                    renderOrders(orders, filter, 0);
                }
            };
            
            // Render daily order statistics chart (using demo data)
            function renderDailyOrdersChart() {
                const chartContainer = document.getElementById('daily-orders-chart');
                if (!chartContainer) return;
                
                // Generate demo data for past 14 days
                const demoData = [];
                const today = new Date();
                for (let i = 13; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    // Generate random number of orders (between 1-15)
                    const orderCount = Math.floor(Math.random() * 15) + 1;
                    demoData.push({
                        date: date,
                        orders: orderCount
                    });
                }
                
                // Calculate maximum value for scaling
                const maxOrders = Math.max(...demoData.map(d => d.orders), 1);
                
                // Generate chart HTML
                const chartHeight = 300;
                const barWidth = 40;
                const barGap = 10;
                const totalWidth = demoData.length * (barWidth + barGap) + 40;
                
                let chartHtml = `
                    <div style="width: 100%; overflow-x: auto;">
                        <svg width="${totalWidth}" height="${chartHeight + 60}" style="display: block; margin: 0 auto;">
                            <!-- YËΩ¥Ê†áÁ≠æ -->
                            ${Array.from({length: 6}, (_, i) => {
                                const value = Math.round((maxOrders / 5) * (5 - i));
                                const y = (chartHeight / 5) * i + 20;
                                return `<text x="0" y="${y + 5}" font-size="12" fill="#6b7280" text-anchor="end">${value}</text>`;
                            }).join('')}
                            
                            <!-- ÁΩëÊ†ºÁ∫ø -->
                            ${Array.from({length: 6}, (_, i) => {
                                const y = (chartHeight / 5) * i + 20;
                                return `<line x1="30" y1="${y}" x2="${totalWidth - 10}" y2="${y}" stroke="#e5e7eb" stroke-width="1"/>`;
                            }).join('')}
                            
                            <!-- Êü±Áä∂Âõæ -->
                            ${demoData.map((item, index) => {
                                const barHeight = (item.orders / maxOrders) * chartHeight;
                                const x = 40 + index * (barWidth + barGap);
                                const y = chartHeight + 20 - barHeight;
                                const dateStr = item.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                
                                return `
                                    <g>
                                        <!-- Êü±Áä∂ -->
                                        <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" 
                                              fill="var(--primary-color)" rx="4" opacity="0.8">
                                            <title>${dateStr}: ${item.orders} orders</title>
                                        </rect>
                                        <!-- Êï∞ÂÄºÊ†áÁ≠æ -->
                                        <text x="${x + barWidth / 2}" y="${y - 5}" 
                                              font-size="12" fill="#1f2937" font-weight="600" 
                                              text-anchor="middle">${item.orders}</text>
                                        <!-- Êó•ÊúüÊ†áÁ≠æ -->
                                        <text x="${x + barWidth / 2}" y="${chartHeight + 45}" 
                                              font-size="11" fill="#6b7280" 
                                              text-anchor="middle" transform="rotate(-45 ${x + barWidth / 2} ${chartHeight + 45})">${dateStr}</text>
                                    </g>
                                `;
                            }).join('')}
                        </svg>
                    </div>
                `;
                
                chartContainer.innerHTML = chartHtml;
            }
            
            // Expose function to global scope
            window.renderDailyOrdersChart = renderDailyOrdersChart;
            
            // Load order data
            // Data change detection variable
            let lastOrdersDataKey = null;
            let isLoadingOrders = false;
            // Expose to global scope for auto-refresh use
            window.isLoadingOrders = false;
            
            // Record set of rendered order IDs (for incremental update, avoid flickering)
            window.renderedOrderIds = new Set();
            
            async function loadOrders() {
                console.log('üìã loadOrders ÂáΩÊï∞Ë¢´Ë∞ÉÁî®');
                console.log('  - window.account:', window.account);
                console.log('  - window.contracts:', window.contracts);
                console.log('  - window.contracts.rideOrder:', window.contracts?.rideOrder);
                
                // Prevent concurrent loading
                if (isLoadingOrders || window.isLoadingOrders) {
                    console.log('‚è∏Ô∏è ËÆ¢ÂçïÊ≠£Âú®Âä†ËΩΩ‰∏≠ÔºåË∑≥ËøáÊú¨Ê¨°ËØ∑Ê±Ç');
                    return;
                }
                
                isLoadingOrders = true;
                
                const ordersList = document.getElementById('orders-list');
                const loadingState = document.getElementById('orders-loading');
                const emptyState = document.getElementById('orders-empty');
                
                console.log('  - DOM ÂÖÉÁ¥†Ê£ÄÊü•:');
                console.log('    - orders-list:', ordersList ? 'Â≠òÂú®' : '‰∏çÂ≠òÂú®');
                console.log('    - orders-loading:', loadingState ? 'Â≠òÂú®' : '‰∏çÂ≠òÂú®');
                console.log('    - orders-empty:', emptyState ? 'Â≠òÂú®' : '‰∏çÂ≠òÂú®');
                
                // If Orders view elements don't exist, still continue loading order data (data will be saved to window.allOrders)
                // This way even if view is not displayed, order data will still be correctly loaded and saved
                if (!ordersList || !loadingState || !emptyState) {
                    console.warn('‚ö†Ô∏è Orders view elements not found. Orders view may not be visible.');
                    console.warn('   ÁªßÁª≠Âä†ËΩΩËÆ¢ÂçïÊï∞ÊçÆÔºåÂç≥‰ΩøËßÜÂõæÊú™ÊòæÁ§∫...');
                    // Don't return, continue execution to load and save order data
                }
                
                if (!window.account) {
                    console.warn('‚ö†Ô∏è window.account Êú™ÂÆö‰πâÔºåÊó†Ê≥ïÂä†ËΩΩËÆ¢Âçï');
                    console.warn('   ËØ∑ÂÖàËøûÊé•Èí±ÂåÖÔºÅ');
                    if (loadingState) loadingState.style.display = 'none';
                    if (emptyState) {
                        emptyState.style.display = 'block';
                        // Display friendly message
                        const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                        emptyState.innerHTML = `
                            <div class="empty-icon">üîå</div>
                            <p>${isZh ? 'ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ' : 'Please connect your wallet first'}</p>
                            <p class="empty-hint">${isZh ? 'ËøûÊé•Èí±ÂåÖÂêéÂç≥ÂèØÊü•ÁúãÂéÜÂè≤ËÆ¢Âçï' : 'Connect wallet to view order history'}</p>
                        `;
                    }
                    return;
                }
                
                if (!window.contracts || !window.contracts.rideOrder) {
                    console.warn('‚ö†Ô∏è window.contracts.rideOrder Êú™ÂÆö‰πâÔºåÊó†Ê≥ïÂä†ËΩΩËÆ¢Âçï');
                    console.warn('   ËØ∑Á°Æ‰øùÔºö');
                    console.warn('   1. Â∑≤ËøûÊé•Èí±ÂåÖ');
                    console.warn('   2. ÂêàÁ∫¶Âú∞ÂùÄÂ∑≤ÈÖçÁΩÆ');
                    console.warn('   3. ÂêàÁ∫¶Â∑≤ÂàùÂßãÂåñ');
                    if (loadingState) loadingState.style.display = 'none';
                    if (emptyState) {
                        emptyState.style.display = 'block';
                        const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                        emptyState.innerHTML = `
                            <div class="empty-icon">‚öôÔ∏è</div>
                            <p>${isZh ? 'ÂêàÁ∫¶Êú™ÈÖçÁΩÆ' : 'Contract not configured'}</p>
                            <p class="empty-hint">${isZh ? 'ËØ∑ÈÖçÁΩÆÂêàÁ∫¶Âú∞ÂùÄ' : 'Please configure contract address'}</p>
                        `;
                    }
                    return;
                }
                
                try {
                    if (loadingState) loadingState.style.display = 'block';
                    if (emptyState) emptyState.style.display = 'none';
                    
                    console.log('üìã ÂºÄÂßãÂä†ËΩΩËÆ¢ÂçïÂàóË°®ÔºåË¥¶Êà∑:', window.account);
                    
                    // Get order ID list from contract (get all historical orders, including all statuses)
                    let orderIds;
                    let orders = null; // Declare orders variable outside try block
                    try {
                        // First verify if contract address has code
                        const contractAddress = window.contracts.rideOrder.address;
                        console.log('üìã È™åËØÅÂêàÁ∫¶Âú∞ÂùÄ:', contractAddress);
                        
                        const code = await window.provider.getCode(contractAddress);
                        if (code === '0x') {
                            throw new Error(`ÂêàÁ∫¶Âú∞ÂùÄ ${contractAddress} Ê≤°ÊúâÈÉ®ÁΩ≤ÂêàÁ∫¶‰ª£Á†Å„ÄÇËØ∑Ê£ÄÊü•ÂêàÁ∫¶Âú∞ÂùÄÊòØÂê¶Ê≠£Á°ÆÔºåÊàñÈáçÊñ∞ÈÉ®ÁΩ≤ÂêàÁ∫¶„ÄÇ`);
                        }
                        
                        console.log('‚úì ÂêàÁ∫¶Âú∞ÂùÄÈ™åËØÅÈÄöËøáÔºåÂºÄÂßã‰ªéÂêéÁ´ØAPIËé∑ÂèñËÆ¢ÂçïÂàóË°®...');
                        
                        // Get order list through backend API (alternative to direct on-chain query)
                        orders = await getUserOrdersFromAPI(window.account, 'passenger');
                        console.log('üìã ‰ªéAPIËé∑ÂèñÂà∞ËÆ¢ÂçïÂàóË°®:', orders ? orders.length : 0, '‰∏™ËÆ¢Âçï');
                        
                        // Convert order object array to order ID array (for subsequent processing)
                        orderIds = orders ? orders.map(order => {
                            const id = order.orderId;
                            return typeof id === 'object' && id.toNumber ? id.toNumber() : parseInt(id);
                        }) : [];
                    } catch (error) {
                        console.error('‚ùå Ëé∑ÂèñËÆ¢ÂçïIDÂàóË°®Â§±Ë¥•:', error);
                        
                        // Provide detailed error diagnosis
                        const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                        let errorMessage = error.message || error.toString();
                        
                        // Check if it is CALL_EXCEPTION error
                        if (error.code === 'CALL_EXCEPTION' || error.message?.includes('revert') || error.message?.includes('CALL_EXCEPTION')) {
                            const contractAddress = window.contracts?.rideOrder?.address || 'Êú™Áü•';
                            const helpfulMessage = isZh 
                                ? `Êó†Ê≥ïË∞ÉÁî®ÂêàÁ∫¶ÂáΩÊï∞ getPassengerOrders„ÄÇËøôÂèØËÉΩÊòØÂõ†‰∏∫Ôºö

1. ‚ùå ÂêàÁ∫¶Âú∞ÂùÄÈîôËØØ
   ÂΩìÂâçÂú∞ÂùÄ: ${contractAddress}
   
2. ‚ùå ÂêàÁ∫¶Êú™ÈÉ®ÁΩ≤Âà∞ËØ•Âú∞ÂùÄ
   ËØ∑ËøêË°å: npm run deploy:local
   
3. ‚ùå ÁΩëÁªú‰∏çÂåπÈÖç
   ËØ∑Á°Æ‰øù MetaMask ËøûÊé•Âà∞: Hardhat Local Network (Chain ID: 1337)
   
4. ‚ùå Hardhat ËäÇÁÇπÊú™ËøêË°å
   ËØ∑ËøêË°å: npm run node

5. ‚ùå ÂêàÁ∫¶Ë¢´ÊöÇÂÅúÊàñÁä∂ÊÄÅÂºÇÂ∏∏

ÈîôËØØËØ¶ÊÉÖ: ${error.message || error.toString()}`
                                : `Cannot call contract function getPassengerOrders. Possible reasons:

1. ‚ùå Wrong contract address
   Current: ${contractAddress}
   
2. ‚ùå Contract not deployed at this address
   Run: npm run deploy:local
   
3. ‚ùå Network mismatch
   Make sure MetaMask is connected to: Hardhat Local Network (Chain ID: 1337)
   
4. ‚ùå Hardhat node not running
   Run: npm run node

5. ‚ùå Contract paused or in abnormal state

Error details: ${error.message || error.toString()}`;
                            
                            if (loadingState) loadingState.style.display = 'none';
                            if (emptyState) {
                                emptyState.style.display = 'block';
                                emptyState.innerHTML = `
                                    <div class="empty-icon">‚ùå</div>
                                    <h2 style="color: var(--error-color); margin: 10px 0;">Âä†ËΩΩËÆ¢ÂçïÂ§±Ë¥•</h2>
                                    <p style="color: #6b7280; margin: 10px 0; white-space: pre-line; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">${helpfulMessage}</p>
                                    <button onclick="location.reload()" style="margin-top: 15px; padding: 10px 20px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                        Âà∑Êñ∞È°µÈù¢ / Refresh Page
                                    </button>
                                `;
                            }
                            return; // Don't throw error, display friendly error message
                        }
                        
                        // Other errors, throw
                        throw new Error(errorMessage);
                    }
                    
                    if (!orders || orders.length === 0) {
                        console.log('üìã ÂΩìÂâçË¥¶Êà∑Ê≤°ÊúâËÆ¢Âçï');
                        if (loadingState) loadingState.style.display = 'none';
                        if (emptyState) emptyState.style.display = 'block';
                        return;
                    }
                    
                    console.log(`üìã ÊâæÂà∞ ${orders.length} ‰∏™ËÆ¢ÂçïÔºåÂºÄÂßãÂ§ÑÁêÜËÆ¢ÂçïÊï∞ÊçÆ...`);
                    
                    // Order data has already been obtained from API, process directly (API returned data is already formatted)
                    const processedOrders = orders.map((order) => {
                        try {
                            // API returned order data is already formatted, use directly
                            const orderId = typeof order.orderId === 'number' ? order.orderId : parseInt(order.orderId);
                            console.log(`üìã Â§ÑÁêÜËÆ¢Âçï #${orderId}...`);
                            
                            // API returned data format may differ, needs adaptation
                            const orderData = {
                                orderId: orderId,
                                passenger: order.passenger,
                                driver: order.driver || null,
                                pickup: {
                                    address: order.pickup?.addressText || order.pickup?.address || '',
                                    lat: typeof order.pickup?.latitude === 'number' ? order.pickup.latitude / 1e6 : 
                                         (order.pickup?.latitude?.toNumber ? order.pickup.latitude.toNumber() / 1e6 : 0),
                                    lng: typeof order.pickup?.longitude === 'number' ? order.pickup.longitude / 1e6 : 
                                         (order.pickup?.longitude?.toNumber ? order.pickup.longitude.toNumber() / 1e6 : 0)
                                },
                                destination: {
                                    address: order.destination?.addressText || order.destination?.address || '',
                                    lat: typeof order.destination?.latitude === 'number' ? order.destination.latitude / 1e6 : 
                                         (order.destination?.latitude?.toNumber ? order.destination.latitude.toNumber() / 1e6 : 0),
                                    lng: typeof order.destination?.longitude === 'number' ? order.destination.longitude / 1e6 : 
                                         (order.destination?.longitude?.toNumber ? order.destination.longitude.toNumber() / 1e6 : 0)
                                },
                                category: order.category || '',
                                subCategory: order.subCategory || '',
                                estimatedFare: typeof order.estimatedFare === 'string' ? order.estimatedFare : 
                                              (order.estimatedFare ? ethers.utils.formatEther(order.estimatedFare) : '0'),
                                actualFare: typeof order.actualFare === 'string' ? order.actualFare : 
                                           (order.actualFare ? ethers.utils.formatEther(order.actualFare) : '0'),
                                status: typeof order.status === 'number' ? order.status : 
                                       (order.status?.toNumber ? order.status.toNumber() : parseInt(order.status) || 0),
                                rideStatus: typeof order.rideStatus === 'number' ? order.rideStatus : 
                                           (order.rideStatus?.toNumber ? order.rideStatus.toNumber() : parseInt(order.rideStatus) || 0),
                                createdAt: order.createdAt ? (typeof order.createdAt === 'number' ? new Date(order.createdAt * 1000) : 
                                    new Date((order.createdAt.toNumber ? order.createdAt.toNumber() : parseInt(order.createdAt)) * 1000)) : new Date(),
                                acceptedAt: order.acceptedAt && (order.acceptedAt.toNumber ? order.acceptedAt.toNumber() : parseInt(order.acceptedAt)) > 0 ? 
                                    new Date((order.acceptedAt.toNumber ? order.acceptedAt.toNumber() : parseInt(order.acceptedAt)) * 1000) : null,
                                pickedUpAt: order.pickedUpAt && (order.pickedUpAt.toNumber ? order.pickedUpAt.toNumber() : parseInt(order.pickedUpAt)) > 0 ? 
                                    new Date((order.pickedUpAt.toNumber ? order.pickedUpAt.toNumber() : parseInt(order.pickedUpAt)) * 1000) : null,
                                completedAt: order.completedAt && (order.completedAt.toNumber ? order.completedAt.toNumber() : parseInt(order.completedAt)) > 0 ? 
                                    new Date((order.completedAt.toNumber ? order.completedAt.toNumber() : parseInt(order.completedAt)) * 1000) : null,
                                startTimestamp: order.startTimestamp && (order.startTimestamp.toNumber ? order.startTimestamp.toNumber() : parseInt(order.startTimestamp)) > 0 ? 
                                    new Date((order.startTimestamp.toNumber ? order.startTimestamp.toNumber() : parseInt(order.startTimestamp)) * 1000) : null,
                                endTimestamp: order.endTimestamp && (order.endTimestamp.toNumber ? order.endTimestamp.toNumber() : parseInt(order.endTimestamp)) > 0 ? 
                                    new Date((order.endTimestamp.toNumber ? order.endTimestamp.toNumber() : parseInt(order.endTimestamp)) * 1000) : null,
                                disputeOpened: order.disputeOpened !== undefined ? order.disputeOpened : false,
                                disputeReason: order.disputeReason || '',
                                disputeResolved: order.disputeResolved !== undefined ? order.disputeResolved : false,
                                disputeWinner: order.disputeWinner && order.disputeWinner !== ethers.constants.AddressZero ? order.disputeWinner : null
                            };
                            
                            const statusNames = ['Pending', 'Accepted', 'Picked Up', 'Completed', 'Cancelled'];
                            const rate = window.ETH_TO_USD_RATE || 2500; // ‰ΩøÁî®ÂÖ®Â±ÄÂÆö‰πâÁöÑÂ∏∏Èáè
                            const estimatedFareUSD = (parseFloat(orderData.estimatedFare) * rate).toFixed(2);
                            
                            // Ensure status is numeric type (important: for subsequent filtering)
                            if (typeof orderData.status !== 'number') {
                                console.warn(`‚ö†Ô∏è ËÆ¢Âçï #${orderData.orderId} Áä∂ÊÄÅ‰∏çÊòØÊï∞Â≠óÁ±ªÂûã:`, typeof orderData.status, orderData.status);
                                orderData.status = parseInt(orderData.status) || 0;
                            }
                            
                            console.log(`‚úì ËÆ¢Âçï #${orderData.orderId} Âä†ËΩΩÊàêÂäü - Áä∂ÊÄÅ: ${statusNames[orderData.status]} (${orderData.status}), È¢Ñ‰º∞Ë¥πÁî®: ${orderData.estimatedFare} ETH ($${estimatedFareUSD} USD)`);
                            
                            return orderData;
                        } catch (error) {
                            console.error(`‚úó Â§ÑÁêÜËÆ¢ÂçïÂ§±Ë¥•:`, error);
                            return null;
                        }
                    });
                    
                    // Filter out null values and sort by time in descending order (latest first)
                    const fetchedOrders = processedOrders.filter(o => o !== null).sort((a, b) => b.createdAt - a.createdAt);
                    
                    console.log(`üìã ÊàêÂäüÂä†ËΩΩ ${fetchedOrders.length} ‰∏™ËÆ¢Âçï`);
                    
                    // Count number of orders by status
                    // Helper function: ensure status is correctly parsed as number
                    const parseStatus = (status) => {
                        if (typeof status === 'number') {
                            return status;
                        } else if (status && typeof status.toNumber === 'function') {
                            return status.toNumber();
                        } else {
                            return parseInt(status) || 0;
                        }
                    };
                    const statusCount = {
                        pending: fetchedOrders.filter(o => parseStatus(o.status) === 0).length,
                        accepted: fetchedOrders.filter(o => parseStatus(o.status) === 1).length,
                        pickedUp: fetchedOrders.filter(o => parseStatus(o.status) === 2).length,
                        completed: fetchedOrders.filter(o => parseStatus(o.status) === 3).length,
                        cancelled: fetchedOrders.filter(o => parseStatus(o.status) === 4).length
                    };
                    console.log('üìä ËÆ¢ÂçïÁä∂ÊÄÅÁªüËÆ°:', statusCount);
                    
                    // Merge existing orders (avoid overwriting newly created orders)
                    // Note: After page refresh, window.allOrders will be lost, so mainly use orders obtained from chain
                    if (window.allOrders && window.allOrders.length > 0) {
                        console.log(`üìã ÂêàÂπ∂ËÆ¢ÂçïÔºöÂ∑≤Êúâ ${window.allOrders.length} ‰∏™ÔºåÊñ∞Ëé∑Âèñ ${fetchedOrders.length} ‰∏™`);
                    // Merge orders, avoid duplicates
                    const orderMap = new Map();
                    // First add existing orders (may include newly created but unconfirmed)
                    window.allOrders.forEach(o => {
                        // Ensure status is correctly parsed
                        let status = o.status;
                        if (typeof status !== 'number') {
                            if (status && typeof status.toNumber === 'function') {
                                status = status.toNumber();
                            } else {
                                status = parseInt(status) || 0;
                            }
                            o.status = status; // Update to numeric type
                        }
                        orderMap.set(o.orderId, o);
                    });
                    // Then update with orders obtained from chain (these are confirmed, higher priority)
                    fetchedOrders.forEach(o => {
                        // Ensure status is correctly parsed
                        let status = o.status;
                        if (typeof status !== 'number') {
                            if (status && typeof status.toNumber === 'function') {
                                status = status.toNumber();
                            } else {
                                status = parseInt(status) || 0;
                            }
                            o.status = status; // Update to numeric type
                        }
                        orderMap.set(o.orderId, o); // This will overwrite old status
                    });
                    // Convert back to array and sort
                    window.allOrders = Array.from(orderMap.values()).sort((a, b) => b.createdAt - a.createdAt);
                    console.log(`üìã ÂêàÂπ∂ÂêéÂÖ±Êúâ ${window.allOrders.length} ‰∏™ËÆ¢Âçï`);
                    // Debug: show merged order status
                    console.log('  - ÂêàÂπ∂ÂêéÁöÑËÆ¢ÂçïÁä∂ÊÄÅ:', window.allOrders.map(o => ({
                        id: o.orderId,
                        status: o.status,
                        statusType: typeof o.status
                    })));
                    } else {
                        // After page refresh, directly use orders obtained from chain (this is the only data source)
                        window.allOrders = fetchedOrders;
                        console.log(`üìã ËÆæÁΩÆËÆ¢ÂçïÂàóË°®ÔºöÂÖ± ${window.allOrders.length} ‰∏™ËÆ¢ÂçïÔºà‰ªéÈìæ‰∏äËé∑ÂèñÔºâ`);
                    }
                    
                    // Check if data has actually changed (avoid unnecessary re-rendering)
                    const currentOrdersKey = JSON.stringify(window.allOrders.map(o => ({
                        orderId: o.orderId,
                        status: o.status,
                        rideStatus: o.rideStatus
                    })));
                    
                    if (currentOrdersKey === lastOrdersDataKey && lastOrdersDataKey !== null) {
                        console.log('üìä ËÆ¢ÂçïÊï∞ÊçÆÊú™ÂèòÂåñÔºåË∑≥ËøáÈáçÊñ∞Ê∏≤Êüì');
                        isLoadingOrders = false;
                        window.isLoadingOrders = false;
                        if (loadingState) loadingState.style.display = 'none';
                        return;
                    }
                    
                    lastOrdersDataKey = currentOrdersKey;
                    
                    // Update UI (if view elements exist)
                    if (loadingState) loadingState.style.display = 'none';
                    
                    // Only render order list when Orders view is displayed
                    const ordersView = document.getElementById('orders-view');
                    if (ordersView && ordersView.style.display !== 'none' && ordersList) {
                        // Get currently selected filter
                        const activeTab = document.querySelector('.filter-tab.active');
                        let currentFilter = 'all';
                        if (activeTab) {
                            const onclickAttr = activeTab.getAttribute('onclick');
                            if (onclickAttr) {
                                const match = onclickAttr.match(/'(\w+)'/);
                                currentFilter = match ? match[1] : 'all';
                            }
                        }
                        // If no tab is selected, default to 'all'
                        if (!activeTab) {
                            const allTab = document.querySelector(`.filter-tab[onclick*="filterOrders('all')"]`);
                            if (allTab) {
                                allTab.classList.add('active');
                                allTab.style.background = '#3b82f6';
                                allTab.style.color = 'white';
                                allTab.style.fontWeight = '600';
                            }
                        }
                        console.log(`üìã ‰ΩøÁî®Á≠õÈÄâÂô®: ${currentFilter}`);
                        console.log(`üìã ÂΩìÂâçËÆ¢ÂçïÂàóË°®ÂåÖÂê´ ${window.allOrders.length} ‰∏™ËÆ¢Âçï`);
                        
                            // Count order status for debugging
                        // Helper function: ensure status is correctly parsed as number
                        const parseStatusForStats = (status) => {
                            if (typeof status === 'number') {
                                return status;
                            } else if (status && typeof status.toNumber === 'function') {
                                return status.toNumber();
                            } else {
                                return parseInt(status) || 0;
                            }
                        };
                        const orderStatusCount = {
                            pending: window.allOrders.filter(o => parseStatusForStats(o.status) === 0).length,
                            accepted: window.allOrders.filter(o => parseStatusForStats(o.status) === 1).length,
                            pickedUp: window.allOrders.filter(o => parseStatusForStats(o.status) === 2).length,
                            completed: window.allOrders.filter(o => parseStatusForStats(o.status) === 3).length,
                            cancelled: window.allOrders.filter(o => parseStatusForStats(o.status) === 4).length
                        };
                        console.log('üìä ËÆ¢ÂçïÁä∂ÊÄÅÁªüËÆ°:', orderStatusCount);
                        
                        // Incremental update: check which orders have been rendered
                        const currentRenderedIds = new Set(Array.from(document.querySelectorAll('.order-card[data-order-id]')).map(card => {
                            const orderId = card.getAttribute('data-order-id');
                            return orderId ? parseInt(orderId) : null;
                        }).filter(id => id !== null));
                        
                        console.log(`üìã Â∑≤Ê∏≤ÊüìÁöÑËÆ¢ÂçïID:`, Array.from(currentRenderedIds));
                        console.log(`üìã ÂΩìÂâçËÆ¢ÂçïID:`, window.allOrders.map(o => o.orderId));
                        
                        // Check if there are new orders to add, or existing orders to update
                        const newOrderIds = window.allOrders.map(o => o.orderId).filter(id => !currentRenderedIds.has(id));
                        const existingOrderIds = window.allOrders.map(o => o.orderId).filter(id => currentRenderedIds.has(id));
                        
                        console.log(`üìã Êñ∞ËÆ¢Âçï (${newOrderIds.length}):`, newOrderIds);
                        console.log(`üìã Â∑≤Â≠òÂú®ËÆ¢Âçï (${existingOrderIds.length}):`, existingOrderIds);
                        
                        // If all orders are rendered and no new orders, skip re-rendering
                        if (newOrderIds.length === 0 && existingOrderIds.length === window.allOrders.length && window.allOrders.length > 0) {
                            console.log('‚úÖ ÊâÄÊúâËÆ¢ÂçïÈÉΩÂ∑≤Ê∏≤ÊüìÔºåÊó†ÈúÄÊõ¥Êñ∞');
                            isLoadingOrders = false;
                            window.isLoadingOrders = false;
                            return;
                        }
                        
                        // Render order list (using incremental update mode)
                        renderOrders(window.allOrders, currentFilter, 0, true);
                        console.log('‚úì ËÆ¢ÂçïÂàóË°®Ê∏≤ÊüìÂÆåÊàêÔºàÂ¢ûÈáèÊõ¥Êñ∞Ôºâ');
                    } else {
                        // Even if view is not displayed, ensure order data is saved
                        console.log(`üìã ËÆ¢ÂçïÊï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞ window.allOrdersÔºàÂÖ± ${window.allOrders.length} ‰∏™ËÆ¢ÂçïÔºâÔºå‰ΩÜËßÜÂõæÊú™ÊòæÁ§∫Ôºå‰∏çËøõË°åÊ∏≤Êüì`);
                    }
                    
                } catch (error) {
                    console.error('Error loading orders:', error);
                    if (loadingState) loadingState.style.display = 'none';
                    if (emptyState) emptyState.style.display = 'block';
                } finally {
                    isLoadingOrders = false;
                }
            }
            
            // Expose loadOrders to global scope for use in createOrder
            window.loadOrders = loadOrders;
            
            // Order status auto-refresh - polling mechanism
            let orderRefreshInterval = null;
            const ORDER_REFRESH_INTERVAL = 5000; // Refresh every 5 seconds
            
            function startOrderAutoRefresh() {
                // If timer already exists, clear it first
                if (orderRefreshInterval) {
                    clearInterval(orderRefreshInterval);
                }
                
                // Create new timer
                orderRefreshInterval = setInterval(() => {
                    // Only refresh when Orders view is displayed
                    const ordersView = document.getElementById('orders-view');
                    if (ordersView && ordersView.style.display !== 'none' && window.account && window.contracts?.rideOrder) {
                        // Check if orders are being loaded, avoid duplicate loading
                        if (window.isLoadingOrders) {
                            console.log('‚è∏Ô∏è ËÆ¢ÂçïÊ≠£Âú®Âä†ËΩΩ‰∏≠ÔºåË∑≥ËøáËá™Âä®Âà∑Êñ∞');
                            return;
                        }
                        console.log('üîÑ Ëá™Âä®Âà∑Êñ∞ËÆ¢ÂçïÁä∂ÊÄÅ...');
                        loadOrders().catch(err => {
                            console.error('Ëá™Âä®Âà∑Êñ∞ËÆ¢ÂçïÂ§±Ë¥•:', err);
                        });
                    }
                }, ORDER_REFRESH_INTERVAL);
                
                console.log('‚úÖ ËÆ¢ÂçïËá™Âä®Âà∑Êñ∞Â∑≤ÂêØÂä®ÔºàÊØè', ORDER_REFRESH_INTERVAL / 1000, 'ÁßíÔºâ');
            }
            
            function stopOrderAutoRefresh() {
                if (orderRefreshInterval) {
                    clearInterval(orderRefreshInterval);
                    orderRefreshInterval = null;
                    console.log('‚è∏Ô∏è ËÆ¢ÂçïËá™Âä®Âà∑Êñ∞Â∑≤ÂÅúÊ≠¢');
                }
            }
            
            // Start auto-refresh after wallet connection
            window.startOrderAutoRefresh = startOrderAutoRefresh;
            window.stopOrderAutoRefresh = stopOrderAutoRefresh;
            
            // Setup smart contract event listeners
            function setupRideEventListeners() {
                if (!window.contracts || !window.contracts.rideOrder) {
                    console.warn('‚ö†Ô∏è ÂêàÁ∫¶Êú™ÂàùÂßãÂåñÔºåÊó†Ê≥ïËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®');
                    return;
                }
                
                console.log('üì° ËÆæÁΩÆËÆ¢ÂçïÁä∂ÊÄÅ‰∫ã‰ª∂ÁõëÂê¨Âô®...');
                
                // Remove old listeners first, avoid duplicate listening
                try {
                    window.contracts.rideOrder.removeAllListeners('RideStarted');
                    window.contracts.rideOrder.removeAllListeners('PassengerPickedUp');
                    window.contracts.rideOrder.removeAllListeners('RideCompleted');
                    window.contracts.rideOrder.removeAllListeners('RideSettled');
                    window.contracts.rideOrder.removeAllListeners('OrderAccepted');
                    window.contracts.rideOrder.removeAllListeners('RideAccepted');
                    window.contracts.rideOrder.removeAllListeners('DisputeOpened');
                    window.contracts.rideOrder.removeAllListeners('DisputeResolved');
                } catch (e) {
                    console.warn('ÁßªÈô§ÊóßÁõëÂê¨Âô®Êó∂Âá∫ÈîôÔºàÂèØÂøΩÁï•Ôºâ:', e);
                }
                
                // Listen to PassengerPickedUp event (contract emits: PassengerPickedUp(orderId, timestamp))
                rideOrderContract.on('PassengerPickedUp', async (orderId, timestamp) => {
                    const orderIdStr = orderId.toString ? orderId.toString() : String(orderId);
                    console.log('üìç Passenger Picked Up ‰∫ã‰ª∂Ëß¶Âèë:', orderIdStr);
                    // Immediately refresh order status
                    setTimeout(() => {
                        if (window.loadOrders) {
                            console.log('üîÑ ÂìçÂ∫î PassengerPickedUp ‰∫ã‰ª∂ÔºåÂà∑Êñ∞ËÆ¢ÂçïÂàóË°®...');
                            window.loadOrders().catch(err => {
                                console.error('Âà∑Êñ∞ËÆ¢ÂçïÂ§±Ë¥•:', err);
                            });
                        }
                    }, 1000); // Áº©Áü≠Âª∂ËøüÊó∂Èó¥ÔºåÊõ¥Âø´ÂìçÂ∫î
                });
                
                // Listen to RideStarted event (contract also emits: RideStarted(orderId, timestamp))
                rideOrderContract.on('RideStarted', async (orderId, timestamp) => {
                    const orderIdStr = orderId.toString ? orderId.toString() : String(orderId);
                    console.log('üöÄ Ride Started ‰∫ã‰ª∂Ëß¶Âèë:', orderIdStr);
                    // Immediately refresh order status
                    setTimeout(() => {
                        if (window.loadOrders) {
                            console.log('üîÑ ÂìçÂ∫î RideStarted ‰∫ã‰ª∂ÔºåÂà∑Êñ∞ËÆ¢ÂçïÂàóË°®...');
                            window.loadOrders().catch(err => {
                                console.error('Âà∑Êñ∞ËÆ¢ÂçïÂ§±Ë¥•:', err);
                            });
                        }
                    }, 1000); // Áº©Áü≠Âª∂ËøüÊó∂Èó¥ÔºåÊõ¥Âø´ÂìçÂ∫î
                });
                
                // Listen to RideCompleted event
                rideOrderContract.on('RideCompleted', async (orderId, timestamp) => {
                    const orderIdStr = orderId.toString ? orderId.toString() : String(orderId);
                    console.log('‚úÖ Ride Completed ‰∫ã‰ª∂Ëß¶Âèë:', orderIdStr);
                    setTimeout(() => {
                        if (window.loadOrders) {
                            console.log('üîÑ ÂìçÂ∫î RideCompleted ‰∫ã‰ª∂ÔºåÂà∑Êñ∞ËÆ¢ÂçïÂàóË°®...');
                            window.loadOrders().catch(err => {
                                console.error('Âà∑Êñ∞ËÆ¢ÂçïÂ§±Ë¥•:', err);
                            });
                        }
                    }, 1500);
                });
                
                // Listen to RideSettled event
                rideOrderContract.on('RideSettled', async (orderId, timestamp) => {
                    const orderIdStr = orderId.toString ? orderId.toString() : String(orderId);
                    console.log('üí∞ Ride Settled ‰∫ã‰ª∂Ëß¶Âèë:', orderIdStr);
                    setTimeout(() => {
                        if (window.loadOrders) {
                            console.log('üîÑ ÂìçÂ∫î RideSettled ‰∫ã‰ª∂ÔºåÂà∑Êñ∞ËÆ¢ÂçïÂàóË°®...');
                            window.loadOrders().catch(err => {
                                console.error('Âà∑Êñ∞ËÆ¢ÂçïÂ§±Ë¥•:', err);
                            });
                        }
                    }, 1500);
                });
                
                // Listen to DisputeResolved event (first one)
                rideOrderContract.on('DisputeResolved', async (orderId, winner, detail, timestamp) => {
                    const orderIdStr = orderId.toString ? orderId.toString() : String(orderId);
                    console.log('‚öñÔ∏è Dispute Resolved ‰∫ã‰ª∂Ëß¶Âèë:', orderIdStr, winner);
                    setTimeout(() => {
                        if (window.loadOrders) {
                            console.log('üîÑ ÂìçÂ∫î DisputeResolved ‰∫ã‰ª∂ÔºåÂà∑Êñ∞ËÆ¢ÂçïÂàóË°®...');
                            window.loadOrders().catch(err => {
                                console.error('Âà∑Êñ∞ËÆ¢ÂçïÂ§±Ë¥•:', err);
                            });
                        }
                        // If order detail modal is open, refresh it
                        const orderModal = document.getElementById('order-modal');
                        if (orderModal && orderModal.style.display !== 'none') {
                            const orderModalBody = document.getElementById('order-modal-body');
                            if (orderModalBody && orderModalBody.innerHTML.includes(`order-${orderIdStr}`)) {
                                // If currently displaying this order's detail, reload
                                if (window.showOrderDetail) {
                                    window.showOrderDetail(parseInt(orderIdStr));
                                }
                            }
                        }
                    }, 1500);
                });
                
                // Listen to OrderAccepted event (contract emits: OrderAccepted(orderId, driver))
                rideOrderContract.on('OrderAccepted', async (orderId, driver) => {
                    const orderIdStr = orderId.toString ? orderId.toString() : String(orderId);
                    console.log('üìã Order Accepted ‰∫ã‰ª∂Ëß¶Âèë:', orderIdStr, 'Âè∏Êú∫:', driver);
                    // Immediately refresh order status
                    setTimeout(() => {
                        if (window.loadOrders) {
                            console.log('üîÑ ÂìçÂ∫î OrderAccepted ‰∫ã‰ª∂ÔºåÂà∑Êñ∞ËÆ¢ÂçïÂàóË°®...');
                            window.loadOrders().catch(err => {
                                console.error('Âà∑Êñ∞ËÆ¢ÂçïÂ§±Ë¥•:', err);
                            });
                        }
                    }, 1000); // Áº©Áü≠Âª∂ËøüÊó∂Èó¥ÔºåÊõ¥Âø´ÂìçÂ∫î
                });
                
                // Listen to RideAccepted event (contract also emits: RideAccepted(orderId, driver, timestamp))
                rideOrderContract.on('RideAccepted', async (orderId, driver, timestamp) => {
                    const orderIdStr = orderId.toString ? orderId.toString() : String(orderId);
                    console.log('üöó Ride Accepted ‰∫ã‰ª∂Ëß¶Âèë:', orderIdStr, 'Âè∏Êú∫:', driver);
                    // Immediately refresh order status
                    setTimeout(() => {
                        if (window.loadOrders) {
                            console.log('üîÑ ÂìçÂ∫î RideAccepted ‰∫ã‰ª∂ÔºåÂà∑Êñ∞ËÆ¢ÂçïÂàóË°®...');
                            window.loadOrders().catch(err => {
                                console.error('Âà∑Êñ∞ËÆ¢ÂçïÂ§±Ë¥•:', err);
                            });
                        }
                    }, 1000); // Áº©Áü≠Âª∂ËøüÊó∂Èó¥ÔºåÊõ¥Âø´ÂìçÂ∫î
                });
                
                // Listen to DisputeOpened event
                rideOrderContract.on('DisputeOpened', async (orderId, by, reason, timestamp) => {
                    const orderIdStr = orderId.toString ? orderId.toString() : String(orderId);
                    console.log('‚öñÔ∏è Dispute Opened ‰∫ã‰ª∂Ëß¶Âèë:', orderIdStr, reason);
                    setTimeout(() => {
                        if (window.loadOrders) {
                            console.log('üîÑ ÂìçÂ∫î DisputeOpened ‰∫ã‰ª∂ÔºåÂà∑Êñ∞ËÆ¢ÂçïÂàóË°®...');
                            window.loadOrders().catch(err => {
                                console.error('Âà∑Êñ∞ËÆ¢ÂçïÂ§±Ë¥•:', err);
                            });
                        }
                        // If currently viewing this order detail, refresh detail
                        if (typeof window.viewOrderDetail === 'function') {
                            const orderIdNum = typeof orderId === 'object' && orderId.toNumber ? orderId.toNumber() : parseInt(orderIdStr);
                            window.viewOrderDetail(orderIdNum).catch(err => {
                                console.error('Âà∑Êñ∞ËÆ¢ÂçïËØ¶ÊÉÖÂ§±Ë¥•:', err);
                            });
                        }
                    }, 1500);
                });
                
                // Listen to DisputeResolved event (second one, duplicate)
                rideOrderContract.on('DisputeResolved', async (orderId, winner, detail, timestamp) => {
                    const orderIdStr = orderId.toString ? orderId.toString() : String(orderId);
                    console.log('‚úÖ Dispute Resolved ‰∫ã‰ª∂Ëß¶Âèë:', orderIdStr, winner);
                    setTimeout(() => {
                        if (window.loadOrders) {
                            console.log('üîÑ ÂìçÂ∫î DisputeResolved ‰∫ã‰ª∂ÔºåÂà∑Êñ∞ËÆ¢ÂçïÂàóË°®...');
                            window.loadOrders().catch(err => {
                                console.error('Âà∑Êñ∞ËÆ¢ÂçïÂ§±Ë¥•:', err);
                            });
                        }
                        // If currently viewing this order detail, refresh detail
                        if (typeof window.viewOrderDetail === 'function') {
                            const orderIdNum = typeof orderId === 'object' && orderId.toNumber ? orderId.toNumber() : parseInt(orderIdStr);
                            window.viewOrderDetail(orderIdNum).catch(err => {
                                console.error('Âà∑Êñ∞ËÆ¢ÂçïËØ¶ÊÉÖÂ§±Ë¥•:', err);
                            });
                        }
                    }, 1500);
                });
                
                console.log('‚úÖ ËÆ¢ÂçïÁä∂ÊÄÅ‰∫ã‰ª∂ÁõëÂê¨Âô®Â∑≤ËÆæÁΩÆÂÆåÊàê');
            }
            
            window.setupRideEventListeners = setupRideEventListeners;
            
            // Render order list (supports incremental update)
            function renderOrders(orders, filter = 'all', retryCount = 0, incrementalUpdate = false) {
                // Add retry limit to avoid infinite loop
                const MAX_RETRIES = 5;
                
                // Initialize rendered order ID set (if it doesn't exist)
                if (!window.renderedOrderIds) {
                    window.renderedOrderIds = new Set();
                }
                
                // Ensure Orders view is displayed
                const ordersView = document.getElementById('orders-view');
                if (ordersView && ordersView.style.display === 'none') {
                    console.log('üìã Orders ËßÜÂõæÊú™ÊòæÁ§∫ÔºåÂÖàÊòæÁ§∫ËßÜÂõæ...');
                    ordersView.style.display = 'block';
                    // View just displayed, give some time for DOM to render
                    if (retryCount === 0) {
                        setTimeout(() => {
                            renderOrders(orders, filter, retryCount + 1);
                        }, 100);
                        return;
                    }
                }
                
                const ordersList = document.getElementById('orders-list');
                let emptyState = document.getElementById('orders-empty');
                
                // Check if required DOM elements exist (ordersList is required)
                if (!ordersList) {
                    if (retryCount < MAX_RETRIES) {
                        console.warn(`‚ö†Ô∏è renderOrders: ordersList DOM ÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÂª∂ËøüÈáçËØï... (${retryCount + 1}/${MAX_RETRIES})`);
                        setTimeout(() => {
                            renderOrders(orders, filter, retryCount + 1);
                        }, 100);
                    } else {
                        console.error('‚ùå renderOrders: ordersList DOM ÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÂ∑≤ËææÂà∞ÊúÄÂ§ßÈáçËØïÊ¨°Êï∞ÔºåÊîæÂºÉÊ∏≤Êüì');
                        console.error('  - ordersList:', ordersList ? 'Â≠òÂú®' : '‰∏çÂ≠òÂú®');
                        console.error('  - ordersView:', ordersView ? 'Â≠òÂú®' : '‰∏çÂ≠òÂú®');
                        if (ordersView) {
                            console.error('  - ordersView.style.display:', ordersView.style.display);
                        }
                    }
                    return;
                }
                
                // If emptyState doesn't exist, try to create it (optional element)
                if (!emptyState && ordersList) {
                    console.warn('‚ö†Ô∏è emptyState ÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïÂàõÂª∫...');
                    emptyState = document.createElement('div');
                    emptyState.id = 'orders-empty';
                    emptyState.className = 'empty-state';
                    emptyState.style.display = 'none';
                    emptyState.innerHTML = `
                        <div class="empty-icon">üìã</div>
                        <p data-i18n="noOrders">No orders yet</p>
                        <p class="empty-hint" data-i18n="createFirstOrder">Create your first order to get started</p>
                    `;
                    // Insert emptyState after ordersList
                    if (ordersList.parentNode) {
                        ordersList.parentNode.insertBefore(emptyState, ordersList.nextSibling);
                    } else {
                        ordersList.appendChild(emptyState);
                    }
                    console.log('‚úì Â∑≤ÂàõÂª∫ emptyState ÂÖÉÁ¥†');
                }
                
                // Filter orders
                let filteredOrders = orders;
                if (filter !== 'all') {
                    console.log(`üîç ÂºÄÂßãÁ≠õÈÄâÔºåfilter: "${filter}", ËÆ¢ÂçïÊï∞: ${orders.length}`);
                    filteredOrders = orders.filter(order => {
                        // Ensure order.status is numeric type (supports multiple formats)
                        let status = order.status;
                        if (typeof status === 'number') {
                            status = status;
                        } else if (status && typeof status.toNumber === 'function') {
                            // BigNumber type
                            status = status.toNumber();
                        } else if (typeof status === 'string') {
                            status = parseInt(status) || 0;
                        } else {
                            status = parseInt(status) || 0;
                        }
                        
                        // Filter orders according to filter
                        let matches = false;
                        if (filter === 'completed') {
                            matches = status === 3;
                        } else if (filter === 'cancelled') {
                            matches = status === 4;
                        } else if (filter === 'pending') {
                            matches = status === 0;
                        } else if (filter === 'accepted') {
                            matches = status === 1;
                        } else if (filter === 'picked-up') {
                            matches = status === 2;
                        }
                        
                        if (matches) {
                            console.log(`  ‚úì ËÆ¢Âçï #${order.orderId} ÂåπÈÖçÁ≠õÈÄâÂô® "${filter}" (Áä∂ÊÄÅ: ${status})`);
                        }
                        
                        return matches;
                    });
                    
                    console.log(`  - Á≠õÈÄâ "${filter}" Âêé: ${filteredOrders.length} ‰∏™ËÆ¢Âçï`);
                    // Debug: show status of all orders (including unmatched ones)
                    console.log('  - ÊâÄÊúâËÆ¢ÂçïÁöÑÁä∂ÊÄÅ:', orders.map(o => {
                        let s = o.status;
                        if (typeof s === 'number') {
                            s = s;
                        } else if (s && typeof s.toNumber === 'function') {
                            s = s.toNumber();
                        } else {
                            s = parseInt(s) || 0;
                        }
                        return {
                            id: o.orderId,
                            status: s,
                            statusType: typeof o.status,
                            rawStatus: o.status,
                            matchesFilter: (() => {
                                if (filter === 'pending') return s === 0;
                                if (filter === 'completed') return s === 3;
                                if (filter === 'cancelled') return s === 4;
                                if (filter === 'accepted') return s === 1;
                                if (filter === 'picked-up') return s === 2;
                                return true;
                            })()
                        };
                    }));
                    // Debug: show status of each order
                    if (filteredOrders.length > 0) {
                        console.log('  - Á≠õÈÄâÂêéÁöÑËÆ¢ÂçïÁä∂ÊÄÅ:', filteredOrders.map(o => {
                            let s = o.status;
                            if (typeof s === 'number') {
                                s = s;
                            } else if (s && typeof s.toNumber === 'function') {
                                s = s.toNumber();
                            } else {
                                s = parseInt(s) || 0;
                            }
                            return {
                                id: o.orderId,
                                status: s
                            };
                        }));
                    }
                }
                
                // In incremental update mode, even if filter result is empty, should not clear existing orders
                if (filteredOrders.length === 0) {
                    if (incrementalUpdate) {
                        // Incremental update mode: don't clear list, only show empty state prompt
                        console.log('üìã Á≠õÈÄâÁªìÊûú‰∏∫Á©∫Ôºå‰ΩÜ‰ΩøÁî®Â¢ûÈáèÊõ¥Êñ∞Ê®°ÂºèÔºå‰øùÁïôÂ∑≤Ê∏≤ÊüìÁöÑËÆ¢Âçï');
                        if (emptyState) {
                            // Check if there are really orders in the list
                            const existingCards = document.querySelectorAll('.order-card');
                            if (existingCards.length === 0) {
                                emptyState.style.display = 'block';
                            } else {
                                emptyState.style.display = 'none';
                            }
                        }
                        return;
                    } else {
                        // Non-incremental update mode: clear list
                        ordersList.innerHTML = '';
                        if (emptyState) {
                            emptyState.style.display = 'block';
                        }
                        return;
                    }
                }
                
                if (emptyState) {
                    emptyState.style.display = 'none';
                }
                
                const statusNames = typeof i18n !== 'undefined' ? [
                    i18n.t('statusPending'),
                    i18n.t('statusAccepted'),
                    i18n.t('statusPickedUp'),
                    i18n.t('statusCompleted'),
                    i18n.t('statusCancelled')
                ] : ['Pending', 'Accepted', 'Picked Up', 'Completed', 'Cancelled'];
                const statusBadges = ['pending', 'accepted', 'picked-up', 'completed', 'cancelled'];
                
                // Debug: show orders about to be rendered
                console.log(`üìã ÂáÜÂ§áÊ∏≤Êüì ${filteredOrders.length} ‰∏™ËÆ¢Âçï (Á≠õÈÄâÂô®: ${filter}, Â¢ûÈáèÊõ¥Êñ∞: ${incrementalUpdate})`);
                
                // Incremental update: check which orders have been rendered
                if (incrementalUpdate) {
                    // Get currently rendered order IDs
                    const existingOrderCards = Array.from(document.querySelectorAll('.order-card'));
                    const existingOrderIds = new Set(existingOrderCards.map(card => {
                        const onclickAttr = card.getAttribute('onclick');
                        if (onclickAttr) {
                            const match = onclickAttr.match(/viewOrderDetail\((\d+)\)/);
                            return match ? parseInt(match[1]) : null;
                        }
                        return null;
                    }).filter(id => id !== null));
                    
                    console.log(`üìã Â∑≤Ê∏≤ÊüìÁöÑËÆ¢ÂçïID (${existingOrderIds.size}):`, Array.from(existingOrderIds));
                    
                    // Separate new orders and existing orders
                    const newOrders = filteredOrders.filter(order => !existingOrderIds.has(order.orderId));
                    const existingOrders = filteredOrders.filter(order => existingOrderIds.has(order.orderId));
                    
                    console.log(`üìã Êñ∞ËÆ¢Âçï (${newOrders.length}):`, newOrders.map(o => o.orderId));
                    console.log(`üìã Â∑≤Â≠òÂú®ËÆ¢Âçï (${existingOrders.length}):`, existingOrders.map(o => o.orderId));
                    
                    // If all orders are rendered, skip re-rendering
                    if (newOrders.length === 0) {
                        console.log('‚úÖ ÊâÄÊúâËÆ¢ÂçïÈÉΩÂ∑≤Ê∏≤ÊüìÔºåÊó†ÈúÄÊõ¥Êñ∞');
                        // Update rendered order ID set
                        filteredOrders.forEach(order => {
                            window.renderedOrderIds.add(order.orderId);
                        });
                        return;
                    }
                    
                    // Only render new orders (add to top of list)
                    const newOrdersHtml = newOrders.map(order => {
                        return generateOrderCardHtml(order, statusNames, statusBadges);
                    }).join('');
                    
                    // Add new orders to top of list
                    if (newOrdersHtml) {
                        ordersList.insertAdjacentHTML('afterbegin', newOrdersHtml);
                        // Update rendered order ID set
                        newOrders.forEach(order => {
                            window.renderedOrderIds.add(order.orderId);
                        });
                        console.log(`‚úÖ Â¢ûÈáèÊ∑ªÂä† ${newOrders.length} ‰∏™Êñ∞ËÆ¢Âçï`);
                    }
                    
                    return;
                }
                
                // Full re-render (non-incremental update mode)
                ordersList.innerHTML = filteredOrders.map(order => {
                    return generateOrderCardHtml(order, statusNames, statusBadges);
                }).join('');
                
                // Update rendered order ID set
                filteredOrders.forEach(order => {
                    window.renderedOrderIds.add(order.orderId);
                });
            }
            
            // Generate order card HTML (extracted as separate function for reuse)
            function generateOrderCardHtml(order, statusNames, statusBadges) {
                // Ensure status is numeric type
                let orderStatus = order.status;
                if (typeof orderStatus === 'number') {
                    orderStatus = orderStatus;
                } else if (orderStatus && typeof orderStatus.toNumber === 'function') {
                    orderStatus = orderStatus.toNumber();
                } else if (typeof orderStatus === 'string') {
                    orderStatus = parseInt(orderStatus) || 0;
                } else {
                    orderStatus = parseInt(orderStatus) || 0;
                }
                
                // Ensure status is saved back to order object
                order.status = orderStatus;
                
                // Check if there is a dispute
                const hasDispute = order.disputeOpened || false;
                let statusName = statusNames[orderStatus] || 'Unknown';
                let badgeClass = statusBadges[orderStatus] || 'pending';
                
                // If order is completed and has dispute, show Completed/Disputed
                if (orderStatus === 3 && hasDispute) {
                    const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                    statusName = isZh ? 'Â∑≤ÂÆåÊàê/‰∫âËÆÆ‰∏≠' : 'Completed/Disputed';
                    badgeClass = 'disputed';
                }
                
                const dateStr = order.createdAt instanceof Date ? order.createdAt.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : new Date(order.createdAt).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                    <div class="order-card fade-in${hasDispute ? ' disputed' : ''}" onclick="viewOrderDetail(${order.orderId})" data-order-id="${order.orderId}">
                        <div class="order-header">
                            <div class="order-date">${dateStr}</div>
                            <span class="badge ${badgeClass} order-status-badge">${statusName}</span>
                        </div>
                        <div class="order-route">
                            <div class="route-point">
                                <div class="route-icon pickup">üìç</div>
                                <div class="route-address">${order.pickup?.address || 'Pickup location'}</div>
                            </div>
                            <div class="route-line"></div>
                            <div class="route-point">
                                <div class="route-icon destination">üèÅ</div>
                                <div class="route-address">${order.destination?.address || 'Destination'}</div>
                            </div>
                        </div>
                        ${(order.category || order.subCategory) ? `
                        <div class="order-category" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #f3f4f6;">
                            ${order.category ? `<span style="display: inline-block; padding: 4px 10px; background: #e0e7ff; color: var(--primary-color); border-radius: 6px; font-size: 12px; font-weight: 600; margin-right: 6px;">
                                ${order.category}
                            </span>` : ''}
                            ${order.subCategory ? `<span style="display: inline-block; padding: 4px 10px; background: #f3f4f6; color: #6b7280; border-radius: 6px; font-size: 12px;">
                                ${order.subCategory}
                            </span>` : ''}
                        </div>
                        ` : ''}
                        <div class="order-footer">
                            <div>
                                ${(() => {
                                    const rate = window.ETH_TO_USD_RATE || 2500;
                                    const actualFareValue = order.actualFare ? parseFloat(order.actualFare) : 0;
                                    const estimatedFareValue = order.estimatedFare ? parseFloat(order.estimatedFare) : 0;
                                    const fareToDisplay = (actualFareValue > 0) ? actualFareValue : estimatedFareValue;
                                    const fareUSD = (fareToDisplay * rate).toFixed(2);
                                    return `
                                <div class="order-fare" style="font-size: 15px; font-weight: 700; color: #1f2937; margin-bottom: 4px;">
                                    ${fareToDisplay.toFixed(8)} ETH
                                </div>
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">
                                    ($${fareUSD} USD)
                                </div>
                                    `;
                                })()}
                                <div class="order-id" style="font-size: 11px;">Order #${order.orderId}</div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end; max-width: 100%;">
                                <button class="btn-detail" onclick="event.stopPropagation(); window.viewOrderDetail(${order.orderId})" style="background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; flex-shrink: 0; height: 36px; display: flex; align-items: center; justify-content: center; box-sizing: border-box;">
                                    ${typeof i18n !== 'undefined' ? (i18n.t('viewDetails') || 'View Details') : 'View Details'}
                                </button>
                                ${orderStatus === 0 ? `
                                <button class="btn-cancel" onclick="event.stopPropagation(); window.cancelOrder(${order.orderId})" style="background: var(--bg-primary); color: var(--error-color); border: 1px solid var(--error-color); padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; flex-shrink: 0; height: 36px; display: flex; align-items: center; justify-content: center; box-sizing: border-box;">
                                    ${typeof i18n !== 'undefined' ? i18n.t('cancelOrder') : 'Cancel Order'}
                                </button>
                                ` : ''}
                                ${orderStatus === 3 ? `
                                <div style="width: 100%;">
                                    <div style="display: flex; gap: 8px; width: 100%;">
                                        <button class="btn-complete" onclick="event.stopPropagation(); window.passengerConfirmComplete(${order.orderId})" style="flex: 1; background: var(--success-color); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; height: 36px; display: flex; align-items: center; justify-content: center; box-sizing: border-box;">
                                            ${typeof i18n !== 'undefined' ? (i18n.t('completeOrder') || 'Complete') : 'Complete'}
                                        </button>
                                        ${!hasDispute ? `
                                        <button class="btn-dispute" onclick="event.stopPropagation(); window.submitDispute(${order.orderId})" style="flex: 1; background: var(--error-color); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; height: 36px; display: flex; align-items: center; justify-content: center; box-sizing: border-box;">
                                            ${typeof i18n !== 'undefined' ? (i18n.t('dispute') || 'Dispute') : 'Dispute'}
                                        </button>
                                        ` : `
                                        <button class="btn-dispute" disabled style="flex: 1; background: #9ca3af; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: not-allowed; white-space: nowrap; height: 36px; display: flex; align-items: center; justify-content: center; box-sizing: border-box; opacity: 0.6;">
                                            ${typeof i18n !== 'undefined' ? (i18n.t('disputed') || 'Disputed') : 'Disputed'}
                                        </button>
                                        `}
                                    </div>
                                    <div style="margin-top: 8px; font-size: 11px; color: #6b7280; text-align: center; line-height: 1.4;">
                                        ${(() => {
                                            const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                                            return isZh 
                                                ? 'Complete Order ÊåâÈíÆÁî®‰ª•Ê®°ÊãüËá™Âä®ÁªìÁÆóÁöÑËΩ¨Ë¥¶ÊµÅÁ®ã'
                                                : 'Complete Order button simulates automatic settlement and transfer process';
                                        })()}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Expose renderOrders to global scope
            window.renderOrders = renderOrders;
            
            // View order details
            window.viewOrderDetail = async function(orderId) {
                console.log('üîç viewOrderDetail Ë¢´Ë∞ÉÁî®ÔºåËÆ¢ÂçïID:', orderId);
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                
                // Check if contract is initialized
                if (!window.contractsInitialized || !window.contracts.rideOrder) {
                    alert(isZh ? '‚ö†Ô∏è ÂêàÁ∫¶Êú™ÂàùÂßãÂåñ' : '‚ö†Ô∏è Contract not initialized');
                    return;
                }
                
                try {
                    // Show loading state
                    const statusEl = document.getElementById('wallet-status');
                    if (statusEl) {
                        statusEl.className = 'status info';
                        statusEl.textContent = isZh ? 'Ê≠£Âú®Âä†ËΩΩËÆ¢ÂçïËØ¶ÊÉÖ...' : 'Loading order details...';
                    }
                    
                    // Get order information from backend API (alternative to direct on-chain query)
                    console.log('üìã ‰ªéÂêéÁ´ØAPIËé∑ÂèñËÆ¢Âçï‰ø°ÊÅØÔºåËÆ¢ÂçïID:', orderId);
                    const order = await getOrderFromAPI(orderId);
                    console.log('‚úì ËÆ¢Âçï‰ø°ÊÅØËé∑ÂèñÊàêÂäü:', order);
                    
                    // Calculate fee details
                    const ethToUsdRate = window.ETH_TO_USD_RATE || 2500;
                    const PLATFORM_FEE_RATE = 0.05;
                    // Handle estimatedFare: may be string (from API) or BigNumber (from on-chain query)
                    let estimatedFareStr;
                    if (typeof order.estimatedFare === 'string') {
                        estimatedFareStr = parseFloat(order.estimatedFare).toFixed(8);
                    } else if (order.estimatedFare && (order.estimatedFare._hex || order.estimatedFare.toString)) {
                        estimatedFareStr = parseFloat(ethers.utils.formatEther(order.estimatedFare)).toFixed(8);
                    } else {
                        estimatedFareStr = '0.00000000';
                    }
                    const totalOrderFareETH = estimatedFareStr;
                    const totalOrderFareUSD = (parseFloat(totalOrderFareETH) * ethToUsdRate).toFixed(2);
                    const orderBaseFareETH = parseFloat(totalOrderFareETH);
                    const orderBaseFareUSD = (orderBaseFareETH * ethToUsdRate);
                    const platformFeeETH = (orderBaseFareETH * PLATFORM_FEE_RATE).toFixed(8);
                    const platformFeeUSD = (orderBaseFareUSD * PLATFORM_FEE_RATE).toFixed(2);
                    
                    // Ëé∑ÂèñÁî®Êà∑ÊòµÁß∞ÂíåËÅîÁ≥ªÊñπÂºèÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                    const userNickname = localStorage.getItem('user_nickname') || '';
                    const userContact = localStorage.getItem('user_contact') || '';
                    
                    // Â¶ÇÊûúËÆ¢ÂçïÂ∑≤Ë¢´Êé•ÂèóÔºåËé∑ÂèñÂè∏Êú∫‰ø°ÊÅØ
                    let driverInfo = null;
                    if (order.driver && order.driver !== ethers.constants.AddressZero) {
                        try {
                            const userInfoResponse = await fetch('/api/user-info/batch', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ addresses: [order.driver] })
                            });
                            
                            if (userInfoResponse.ok) {
                                const result = await userInfoResponse.json();
                                if (result.success && result.data && result.data[order.driver]) {
                                    driverInfo = result.data[order.driver];
                                }
                            }
                        } catch (error) {
                            console.error('Ëé∑ÂèñÂè∏Êú∫‰ø°ÊÅØÂ§±Ë¥•:', error);
                        }
                    }
                    
                    // ‰ΩøÁî®Ê®°ÊÄÅÂØπËØùÊ°ÜÊòæÁ§∫ËÆ¢ÂçïËØ¶ÊÉÖ
                    const orderModal = document.getElementById('order-modal');
                    const orderModalBody = document.getElementById('order-modal-body');
                    
                    if (!orderModal || !orderModalBody) {
                        console.error('‚ùå ËÆ¢ÂçïËØ¶ÊÉÖÊ®°ÊÄÅÂØπËØùÊ°Ü‰∏çÂ≠òÂú®');
                        alert(isZh ? 'Êó†Ê≥ïÊâæÂà∞ËÆ¢ÂçïËØ¶ÊÉÖÊ®°ÊÄÅÂØπËØùÊ°Ü' : 'Cannot find order details modal');
                        return;
                    }
                    
                    // Ë∞ÉÁî® showOrderInfo ÂáΩÊï∞ÊòæÁ§∫ËÆ¢ÂçïËØ¶ÊÉÖ
                    console.log('üìã Ë∞ÉÁî® showOrderInfo ÊòæÁ§∫ËÆ¢ÂçïËØ¶ÊÉÖÔºàÊ®°ÊÄÅÂØπËØùÊ°ÜÔºâ');
                    if (typeof showOrderInfo === 'function') {
                        // Áõ¥Êé•Ë∞ÉÁî® showOrderInfoÔºå‰º†ÈÄíÊ®°ÊÄÅÂØπËØùÊ°ÜÁöÑ body ÂÖÉÁ¥†
                        showOrderInfo(orderId, order, '', userNickname, userContact, {
                            totalOrderFareETH,
                            totalOrderFareUSD,
                            baseFareETH: orderBaseFareETH.toFixed(8),
                            baseFareUSD: orderBaseFareUSD.toFixed(2),
                            platformFeeETH,
                            platformFeeUSD
                        }, orderModalBody, driverInfo); // ‰º†ÈÄíÊ®°ÊÄÅÂØπËØùÊ°Ü body ÂÖÉÁ¥†ÂíåÂè∏Êú∫‰ø°ÊÅØ
                    } else {
                        // Â¶ÇÊûú showOrderInfo ‰∏çÂèØÁî®ÔºåÁõ¥Êé•ÁîüÊàê HTML
                        console.warn('‚ö†Ô∏è showOrderInfo ÂáΩÊï∞‰∏çÂèØÁî®Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ≥ï');
                        const orderInfoHtml = generateOrderInfoHtml(orderId, order, '', userNickname, userContact, {
                            totalOrderFareETH,
                            totalOrderFareUSD,
                            baseFareETH: orderBaseFareETH.toFixed(8),
                            baseFareUSD: orderBaseFareUSD.toFixed(2),
                            platformFeeETH,
                            platformFeeUSD
                        });
                        orderModalBody.innerHTML = orderInfoHtml;
                    }
                    
                    // ÊòæÁ§∫Ê®°ÊÄÅÂØπËØùÊ°Ü
                    orderModal.style.display = 'flex';
                    document.body.style.overflow = 'hidden'; // Èò≤Ê≠¢ËÉåÊôØÊªöÂä®
                    
                    // Êõ¥Êñ∞Áä∂ÊÄÅ
                    if (statusEl) {
                        statusEl.className = 'status success';
                        statusEl.textContent = isZh ? `‚úì ËÆ¢Âçï #${orderId} ËØ¶ÊÉÖÂ∑≤Âä†ËΩΩ` : `‚úì Order #${orderId} details loaded`;
                    }
                    
                } catch (error) {
                    console.error('‚ùå Âä†ËΩΩËÆ¢ÂçïËØ¶ÊÉÖÂ§±Ë¥•:', error);
                    const friendlyError = translateErrorCode ? translateErrorCode(error, isZh) : (error.message || 'Unknown error');
                    alert(isZh 
                        ? `Âä†ËΩΩËÆ¢ÂçïËØ¶ÊÉÖÂ§±Ë¥•: ${friendlyError}` 
                        : `Failed to load order details: ${friendlyError}`);
                    
                    const statusEl = document.getElementById('wallet-status');
                    if (statusEl) {
                        statusEl.className = 'status error';
                        statusEl.textContent = isZh 
                            ? `Âä†ËΩΩËÆ¢ÂçïËØ¶ÊÉÖÂ§±Ë¥•: ${friendlyError}` 
                            : `Failed to load order details: ${friendlyError}`;
                    }
                }
            };
            
            // ÈîôËØØ‰ª£Á†ÅÁøªËØëÂáΩÊï∞
            function translateErrorCode(error, isZh = false) {
                const errorCodeMap = {
                    // Â∏∏ËßÅÈîôËØØ‰ª£Á†Å
                    '4001': isZh ? 'Áî®Êà∑ÊãíÁªù‰∫Ü‰∫§ÊòìËØ∑Ê±Ç' : 'User rejected the transaction',
                    '-32002': isZh ? 'ËØ∑Ê±ÇÊ≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑Ê£ÄÊü•Èí±ÂåÖ' : 'Request already pending, please check your wallet',
                    '-32603': isZh ? 'ÂÜÖÈÉ®JSON-RPCÈîôËØØ' : 'Internal JSON-RPC error',
                    'UNPREDICTABLE_GAS_LIMIT': isZh ? 'Êó†Ê≥ï‰º∞ÁÆó Gas Ë¥πÁî®Ôºå‰∫§ÊòìÂèØËÉΩÂ§±Ë¥•' : 'Cannot estimate gas, transaction may fail',
                    'CALL_EXCEPTION': isZh ? 'ÂêàÁ∫¶Ë∞ÉÁî®Â§±Ë¥•' : 'Contract call failed',
                    'INSUFFICIENT_FUNDS': isZh ? '‰ΩôÈ¢ù‰∏çË∂≥' : 'Insufficient funds',
                    'REPLACEMENT_UNDERPRICED': isZh ? '‰∫§ÊòìÊõøÊç¢Ë¥πÁî®‰∏çË∂≥' : 'Replacement transaction underpriced',
                    'NONCE_EXPIRED': isZh ? '‰∫§Êòì nonce Â∑≤ËøáÊúü' : 'Transaction nonce expired',
                    'TRANSACTION_REPLACED': isZh ? '‰∫§ÊòìÂ∑≤Ë¢´ÊõøÊç¢' : 'Transaction replaced',
                    
                    // ÂêàÁ∫¶ÈîôËØØ
                    'revert': isZh ? '‰∫§ÊòìË¢´ÂõûÊªö' : 'Transaction reverted',
                    'execution reverted': isZh ? 'ÊâßË°åË¢´ÂõûÊªö' : 'Execution reverted',
                    
                    // ÁΩëÁªúÈîôËØØ
                    'network': isZh ? 'ÁΩëÁªúËøûÊé•ÈîôËØØ' : 'Network connection error',
                    'timeout': isZh ? 'ËØ∑Ê±ÇË∂ÖÊó∂' : 'Request timeout',
                    'NETWORK_ERROR': isZh ? 'ÁΩëÁªúÈîôËØØ' : 'Network error',
                    
                    // Êú™Áü•ÈîôËØØ
                    'Unknown error': isZh ? 'Êú™Áü•ÈîôËØØ' : 'Unknown error'
                };
                
                // Â∞ùËØï‰ªéÈîôËØØ‰ª£Á†ÅÊàñÊ∂àÊÅØ‰∏≠ÂåπÈÖç
                if (error.code) {
                    const codeStr = String(error.code);
                    if (errorCodeMap[codeStr]) {
                        return errorCodeMap[codeStr];
                    }
                }
                
                if (error.message) {
                    const msg = error.message;
                    // Ê£ÄÊü•Ê∂àÊÅØ‰∏≠ÊòØÂê¶ÂåÖÂê´ÈîôËØØ‰ª£Á†Å
                    for (const [code, translation] of Object.entries(errorCodeMap)) {
                        if (msg.includes(code) || msg.toLowerCase().includes(code.toLowerCase())) {
                            return translation;
                        }
                    }
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØ revert ÈîôËØØ
                    if (msg.toLowerCase().includes('revert') || msg.toLowerCase().includes('execution reverted')) {
                        // Â∞ùËØïÊèêÂèñ revert ÂéüÂõ†
                        const revertMatch = msg.match(/revert\s+(.+?)(?:\n|$|\[)/i) || msg.match(/execution reverted:\s*(.+?)(?:\n|$|\[)/i);
                        if (revertMatch && revertMatch[1]) {
                            const reason = revertMatch[1].trim();
                            return isZh 
                                ? `‰∫§ÊòìË¢´ÂõûÊªö: ${reason}` 
                                : `Transaction reverted: ${reason}`;
                        }
                        return errorCodeMap['revert'];
                    }
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØ gas ‰º∞ÁÆóÈîôËØØ
                    if (msg.includes('UNPREDICTABLE_GAS_LIMIT') || msg.includes('cannot estimate gas')) {
                        return errorCodeMap['UNPREDICTABLE_GAS_LIMIT'];
                    }
                }
                
                // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂåπÈÖçÔºåËøîÂõûÂéüÂßãÊ∂àÊÅØÊàñÈªòËÆ§Ê∂àÊÅØ
                return error.message || error.reason || errorCodeMap['Unknown error'];
            }
            
            // ÂèñÊ∂àËÆ¢Âçï
            window.cancelOrder = async function(orderId) {
                if (!window.contractsInitialized || !window.contracts.rideOrder) {
                    const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                    alert(isZh ? '‚ö†Ô∏è ÂêàÁ∫¶Êú™ÂàùÂßãÂåñ' : '‚ö†Ô∏è Contract not initialized');
                    return;
                }
                
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                
                // ‰º∞ÁÆó Gas Ë¥πÁî®
                let gasEstimate = '';
                let gasCost = '';
                let gasEstimateNum = '';
                try {
                    const estimatedGas = await window.contracts.rideOrder.estimateGas.cancelOrder(
                        orderId,
                        isZh ? 'Áî®Êà∑ÂèñÊ∂à' : 'Cancelled by user'
                    );
                    const gasPrice = await window.provider.getGasPrice();
                    const gasCostWei = estimatedGas.mul(gasPrice);
                    const gasCostEth = ethers.utils.formatEther(gasCostWei);
                    gasEstimateNum = estimatedGas.toString();
                    
                    // Ê†ºÂºèÂåñÊòæÁ§∫
                    if (parseFloat(gasCostEth) < 0.0001) {
                        gasCost = isZh ? '< 0.0001 ETH' : '< 0.0001 ETH';
                    } else {
                        gasCost = `${parseFloat(gasCostEth).toFixed(8)} ETH`;
                    }
                    gasEstimate = `${estimatedGas.toString()} gas`;
                } catch (error) {
                    console.warn('Êó†Ê≥ï‰º∞ÁÆó Gas:', error);
                    gasEstimate = isZh ? 'Á∫¶ 30,000 - 50,000 gas' : '~30,000 - 50,000 gas';
                    gasEstimateNum = '30000-50000';
                    gasCost = isZh ? 'Â∞ëÈáè Gas Ë¥πÁî®' : 'Small gas fee';
                }
                
                // È¶ñÂÖàÊòæÁ§∫ Gas Ê∂àËÄóË≠¶ÂëäÂíåÁ°ÆËÆ§
                const confirmMessage = isZh 
                    ? `‚ö†Ô∏è ÂèñÊ∂àËÆ¢ÂçïÈúÄË¶ÅÊ∂àËÄó Gas Ë¥πÁî®\n\nËÆ¢ÂçïÁºñÂè∑Ôºö${orderId}\nÈ¢Ñ‰º∞ GasÔºö${gasEstimate}\nÈ¢Ñ‰º∞Ë¥πÁî®Ôºö${gasCost}\n\nÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂèñÊ∂àÂêóÔºü`
                    : `‚ö†Ô∏è Cancelling order requires gas fees\n\nOrder ID: ${orderId}\nEstimated Gas: ${gasEstimate}\nEstimated Cost: ${gasCost}\n\nDo you want to continue?`;
                
                if (!confirm(confirmMessage)) {
                    return; // Áî®Êà∑ÁÇπÂáª‰∫ÜÂèñÊ∂à
                }
                
                // ËæìÂÖ•ÂèñÊ∂àÂéüÂõ†
                const reason = prompt(
                    isZh 
                        ? `ËØ∑ËæìÂÖ•ÂèñÊ∂àÂéüÂõ†ÔºàÂèØÈÄâÔºâÔºö\n\n‚ö†Ô∏è ÊèêÁ§∫ÔºöËæÉÈïøÁöÑÂéüÂõ†‰ºöÂ¢ûÂä† Gas Ê∂àËÄó\n\nÂ¶ÇÁõ¥Êé•ÁÇπÂáªÁ°ÆÂÆöÔºåÂ∞Ü‰ΩøÁî®ÈªòËÆ§ÂéüÂõ†„ÄÇ` 
                        : `Please enter cancellation reason (optional):\n\n‚ö†Ô∏è Tip: Longer reasons will increase gas consumption\n\nClick OK to use default reason.`,
                    isZh ? 'Áî®Êà∑ÂèñÊ∂à' : 'Cancelled by user'
                );
                
                if (reason === null) {
                    return; // Áî®Êà∑ÁÇπÂáª‰∫ÜÂèñÊ∂à
                }
                
                try {
                    // Show loading state
                    const statusEl = document.getElementById('wallet-status');
                    if (statusEl) {
                        statusEl.className = 'status info';
                        statusEl.textContent = isZh ? 'Ê≠£Âú®ÂèñÊ∂àËÆ¢Âçï...' : 'Cancelling order...';
                    }
                    
                    // Ë∞ÉÁî®Êô∫ËÉΩÂêàÁ∫¶ÂèñÊ∂àËÆ¢Âçï
                    const tx = await window.contracts.rideOrder.cancelOrder(
                        orderId,
                        reason || (isZh ? 'Áî®Êà∑ÂèñÊ∂à' : 'Cancelled by user')
                    );
                    
                    if (statusEl) {
                        statusEl.className = 'status info';
                        statusEl.textContent = isZh 
                            ? `‚è≥ ‰∫§ÊòìÂ∑≤Êèê‰∫§ÔºåÁ≠âÂæÖÁ°ÆËÆ§... (Hash: ${tx.hash.substring(0, 10)}...)` 
                            : `‚è≥ Transaction submitted, waiting for confirmation... (Hash: ${tx.hash.substring(0, 10)}...)`;
                    }
                    
                    // Á≠âÂæÖ‰∫§ÊòìÁ°ÆËÆ§
                    const receipt = await tx.wait();
                    
                    console.log('‚úì ‰∫§ÊòìÁ°ÆËÆ§ÂÆåÊàêÔºåËÆ¢ÂçïÂ∑≤ÂèñÊ∂à');
                    
                    // Á´ãÂç≥Êõ¥Êñ∞Êú¨Âú∞ËÆ¢ÂçïÂàóË°®‰∏≠ÁöÑËÆ¢ÂçïÁä∂ÊÄÅÔºàÊó†ÈúÄÁ≠âÂæÖÈìæ‰∏äÊü•ËØ¢Ôºâ
                    if (window.allOrders && Array.isArray(window.allOrders)) {
                        const orderIndex = window.allOrders.findIndex(o => o.orderId === orderId);
                        if (orderIndex !== -1) {
                            window.allOrders[orderIndex].status = 4; // Cancelled (Áä∂ÊÄÅ 4)
                            console.log(`‚úì Â∑≤Êõ¥Êñ∞Êú¨Âú∞ËÆ¢Âçï #${orderId} Áä∂ÊÄÅ‰∏∫ Cancelled (4)`);
                            
                            // Á´ãÂç≥ÈáçÊñ∞Ê∏≤ÊüìÂΩìÂâçËßÜÂõæÔºàÂ¶ÇÊûúÊòØ Pending ËßÜÂõæÔºåËÆ¢Âçï‰ºöÊ∂àÂ§±Ôºâ
                            const activeTab = document.querySelector('.filter-tab.active');
                            const currentFilter = activeTab ? activeTab.getAttribute('onclick').match(/'(\w+)'/)?.[1] || 'all' : 'all';
                            if (window.renderOrders) {
                                // Á°Æ‰øù Orders ËßÜÂõæÂ∑≤ÊòæÁ§∫
                                const ordersViewForCancel = document.getElementById('orders-view');
                                if (ordersViewForCancel && ordersViewForCancel.style.display === 'none') {
                                    ordersViewForCancel.style.display = 'block';
                                }
                                window.renderOrders(window.allOrders, currentFilter, 0);
                                console.log(`‚úì Â∑≤ÈáçÊñ∞Ê∏≤ÊüìÂΩìÂâçËßÜÂõæ (filter: ${currentFilter})`);
                            }
                        }
                    }
                    
                    if (statusEl) {
                        statusEl.className = 'status success';
                        statusEl.textContent = isZh 
                            ? `‚úì ËÆ¢Âçï #${orderId} Â∑≤ÂèñÊ∂à` 
                            : `‚úì Order #${orderId} cancelled successfully`;
                    }
                    
                    // Á≠âÂæÖ‰∏ÄÂ∞èÊÆµÊó∂Èó¥Á°Æ‰øùÈìæ‰∏äÁä∂ÊÄÅÂ∑≤ÂÆåÂÖ®Êõ¥Êñ∞ÔºåÁÑ∂Âêé‰ªéÈìæ‰∏äÈáçÊñ∞Âä†ËΩΩ‰ª•Á°Æ‰øùÂêåÊ≠•
                    console.log('‚è≥ Á≠âÂæÖÈìæ‰∏äÁä∂ÊÄÅÊõ¥Êñ∞ÂêéÈáçÊñ∞Âä†ËΩΩ...');
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // ÈáçÊñ∞‰ªéÈìæ‰∏äÂä†ËΩΩËÆ¢ÂçïÂàóË°®ÔºàÁ°Æ‰øùËé∑ÂèñÊúÄÊñ∞ÁöÑËÆ¢ÂçïÁä∂ÊÄÅÔºâ
                    console.log('üìã ÈáçÊñ∞‰ªéÈìæ‰∏äÂä†ËΩΩËÆ¢ÂçïÂàóË°®...');
                    if (window.loadOrders) {
                        await window.loadOrders();
                        
                        // Á≠âÂæÖËÆ¢ÂçïÂä†ËΩΩÂÆåÊàêÂêéÔºåËá™Âä®ÂàáÊç¢Âà∞ Cancelled Ê†áÁ≠æ
                        setTimeout(() => {
                            // ÁßªÈô§ÊâÄÊúâ active Á±ª
                            document.querySelectorAll('.filter-tab').forEach(tab => {
                                tab.classList.remove('active');
                            });
                            
                            // ÊøÄÊ¥ª Cancelled Ê†áÁ≠æ
                            const cancelledTab = document.querySelector('.filter-tab[onclick*="cancelled"]');
                            if (cancelledTab) {
                                cancelledTab.classList.add('active');
                                // ÊâãÂä®Ëß¶ÂèëÁ≠õÈÄâÔºàÁ°Æ‰øù‰ΩøÁî®ÊúÄÊñ∞ÁöÑËÆ¢ÂçïÊï∞ÊçÆÔºâ
                                if (window.allOrders && window.renderOrders) {
                                    console.log('üìã ÂàáÊç¢Âà∞ Cancelled Ê†áÁ≠æÔºåËÆ¢ÂçïÊï∞:', window.allOrders.length);
                                    // Á°Æ‰øù Orders ËßÜÂõæÂ∑≤ÊòæÁ§∫
                                    const ordersViewForCancelled = document.getElementById('orders-view');
                                    if (ordersViewForCancelled && ordersViewForCancelled.style.display === 'none') {
                                        ordersViewForCancelled.style.display = 'block';
                                    }
                                    window.renderOrders(window.allOrders, 'cancelled', 0);
                                }
                            }
                        }, 300);
                    } else if (window.showOrdersView) {
                        // Â¶ÇÊûú loadOrders ‰∏çÂèØÁî®ÔºåÈÄöËøá showOrdersView Êù•Âà∑Êñ∞
                        window.showOrdersView();
                    }
                    
                } catch (error) {
                    console.error('ÂèñÊ∂àËÆ¢ÂçïÂ§±Ë¥•:', error);
                    const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                    const statusEl = document.getElementById('wallet-status');
                    if (statusEl) {
                        statusEl.className = 'status error';
                        
                        // ÁøªËØëÈîôËØØ‰ª£Á†Å‰∏∫Áî®Êà∑ÂèØÁêÜËß£ÁöÑËØ≠Ë®Ä
                        const friendlyError = translateErrorCode(error, isZh);
                        
                        // ÂáÜÂ§áÂÆåÊï¥ÁöÑÈîôËØØËØ¶ÊÉÖ JSON
                        const errorDetails = {
                            code: error.code || 'N/A',
                            message: error.message || 'N/A',
                            reason: error.reason || 'N/A',
                            data: error.data || 'N/A',
                            stack: error.stack || 'N/A'
                        };
                        const errorDetailsJson = JSON.stringify(errorDetails, null, 2);
                        
                        // ÁîüÊàêÂîØ‰∏Ä ID Áî®‰∫éÂ±ïÂºÄ/Êî∂Áº©ËØ¶ÊÉÖ
                        const detailId = 'error-detail-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                        
                        statusEl.innerHTML = `
                            <div style="margin-bottom: 10px;">
                                <strong>${isZh ? '‚ùå ÂèñÊ∂àËÆ¢ÂçïÂ§±Ë¥•' : '‚ùå Failed to cancel order'}</strong><br>
                                <div style="margin-top: 8px; font-size: 14px;">
                                    ${friendlyError}
                                </div>
                            </div>
                            <details id="${detailId}" style="margin-top: 12px;">
                                <summary style="cursor: pointer; color: var(--primary-color); font-weight: 500; user-select: none; padding: 8px; background: rgba(0,0,0,0.02); border-radius: 4px; transition: background 0.2s;">
                                    ${isZh ? 'üìã Êü•ÁúãËØ¶ÊÉÖ (Detail)' : 'üìã View Details'}
                                </summary>
                                <div style="margin-top: 10px; padding: 12px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb; font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 12px; overflow-x: auto; max-height: 300px; overflow-y: auto;">
                                    <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">${errorDetailsJson}</pre>
                                </div>
                            </details>
                        `;
                        
                        // Ê∑ªÂä†‰∫§‰∫íÊ†∑Âºè
                        const detailsEl = document.getElementById(detailId);
                        if (detailsEl) {
                            const summaryEl = detailsEl.querySelector('summary');
                            if (summaryEl) {
                                summaryEl.addEventListener('mouseenter', function() {
                                    this.style.background = 'rgba(0,0,0,0.04)';
                                });
                                summaryEl.addEventListener('mouseleave', function() {
                                    this.style.background = 'rgba(0,0,0,0.02)';
                                });
                            }
                        }
                    }
                }
            };
            
            // Âä†ËΩΩÁî®Êà∑ËµÑÊñô
            async function loadProfile() {
                if (!window.account) {
                    return;
                }
                
                // Êõ¥Êñ∞Âú∞ÂùÄÊòæÁ§∫
                const profileAddress = document.getElementById('profile-address');
                if (profileAddress) {
                    profileAddress.textContent = window.account;
                }
                
                // Âä†ËΩΩÊòµÁß∞ÂíåËÅîÁ≥ªÊñπÂºè
                const nickname = localStorage.getItem('user_nickname') || '';
                const contact = localStorage.getItem('user_contact') || '';
                
                // ÂêåÊ≠•Âà∞ÂêéÁ´ØÔºàÂ¶ÇÊûú localStorage ‰∏≠ÊúâÊï∞ÊçÆÔºâ
                if (nickname || contact) {
                    try {
                        const response = await fetch('/api/user-info', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                address: window.account,
                                nickname: nickname || null,
                                contact: contact || null
                            })
                        });
                        
                        if (response.ok) {
                            console.log('Áî®Êà∑‰ø°ÊÅØÂ∑≤ÂêåÊ≠•Âà∞ÂêéÁ´Ø');
                        }
                    } catch (error) {
                        console.error('ÂêåÊ≠•Áî®Êà∑‰ø°ÊÅØÂà∞ÂêéÁ´ØÈîôËØØ:', error);
                    }
                }
                
                const profileNickname = document.getElementById('profile-nickname');
                if (profileNickname) {
                    profileNickname.value = nickname;
                }
                
                const profileContact = document.getElementById('profile-contact');
                if (profileContact) {
                    profileContact.value = contact;
                }
                
                // Êõ¥Êñ∞ Profile Âç°Áâá‰∏≠ÁöÑÊòµÁß∞ÊòæÁ§∫
                const profileName = document.getElementById('profile-name');
                if (profileName) {
                    profileName.textContent = nickname || i18n.t('user');
                }
                
                // ÁîüÊàêÁî®Êà∑È¶ñÂ≠óÊØçÔºà‰ºòÂÖà‰ΩøÁî®ÊòµÁß∞Ôºâ
                const initials = nickname ? nickname.substring(0, 2).toUpperCase() : 
                               (window.account ? window.account.substring(2, 4).toUpperCase() : 'U');
                const profileInitials = document.getElementById('profile-initials');
                if (profileInitials) {
                    profileInitials.textContent = initials;
                }
                
                // Êõ¥Êñ∞Èí±ÂåÖÂú∞ÂùÄËÆæÁΩÆ
                const settingWalletAddress = document.getElementById('setting-wallet-address');
                if (settingWalletAddress) {
                    settingWalletAddress.textContent = window.account.substring(0, 6) + '...' + window.account.substring(38);
                }
                
                // Êõ¥Êñ∞ÁΩëÁªú‰ø°ÊÅØ
                if (window.provider) {
                    try {
                        const network = await window.provider.getNetwork();
                        const networkName = network.name === 'homestead' ? 'Ethereum Mainnet' : 
                                          network.name === 'matic' ? 'Polygon' :
                                          network.name === 'maticmum' ? 'Mumbai Testnet' :
                                          network.name;
                        const settingNetwork = document.getElementById('setting-network');
                        if (settingNetwork) {
                            settingNetwork.textContent = networkName + ' (Chain ID: ' + network.chainId + ')';
                        }
                    } catch (error) {
                        console.error('Error getting network:', error);
                    }
                }
                
                // Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
                await loadProfileStats();
            }
            
            // ‰øùÂ≠ò Profile ‰ø°ÊÅØ
            window.saveProfile = async function() {
                const nickname = document.getElementById('profile-nickname').value.trim();
                const contact = document.getElementById('profile-contact').value.trim();
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                
                if (nickname) {
                    localStorage.setItem('user_nickname', nickname);
                } else {
                    localStorage.removeItem('user_nickname');
                }
                
                if (contact) {
                    localStorage.setItem('user_contact', contact);
                } else {
                    localStorage.removeItem('user_contact');
                }
                
                // ÂêåÊ≠•Âà∞ÂêéÁ´Ø
                if (window.account) {
                    try {
                        const response = await fetch('/api/user-info', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                address: window.account,
                                nickname: nickname || null,
                                contact: contact || null
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                console.log('Áî®Êà∑‰ø°ÊÅØÂ∑≤ÂêåÊ≠•Âà∞ÂêéÁ´Ø');
                            }
                        } else {
                            console.warn('ÂêåÊ≠•Áî®Êà∑‰ø°ÊÅØÂà∞ÂêéÁ´ØÂ§±Ë¥•');
                        }
                    } catch (error) {
                        console.error('ÂêåÊ≠•Áî®Êà∑‰ø°ÊÅØÂà∞ÂêéÁ´ØÈîôËØØ:', error);
                    }
                }
                
                // Êõ¥Êñ∞ÊòæÁ§∫
                const profileName = document.getElementById('profile-name');
                if (profileName) {
                    profileName.textContent = nickname || i18n.t('user');
                }
                
                const profileInitials = document.getElementById('profile-initials');
                if (profileInitials) {
                    const initials = nickname ? nickname.substring(0, 2).toUpperCase() : 
                                   (window.account ? window.account.substring(2, 4).toUpperCase() : 'U');
                    profileInitials.textContent = initials;
                }
                
                // ÊòæÁ§∫‰øùÂ≠òÊàêÂäüÊèêÁ§∫
                alert(isZh ? '‚úì ‰∏™‰∫∫‰ø°ÊÅØÂ∑≤‰øùÂ≠ò' : '‚úì Profile saved successfully');
            };
            
            // Âä†ËΩΩÁî®Êà∑ÁªüËÆ°Êï∞ÊçÆ
            async function loadProfileStats() {
                if (!window.account || !window.contracts.rideOrder) {
                    return;
                }
                
                try {
                    // È™åËØÅÂêàÁ∫¶Âú∞ÂùÄ
                    const contractAddress = window.contracts.rideOrder.address;
                    const code = await window.provider.getCode(contractAddress);
                    if (code === '0x') {
                        console.warn('‚ö†Ô∏è ÂêàÁ∫¶Âú∞ÂùÄÊ≤°Êúâ‰ª£Á†ÅÔºåË∑≥ËøáÁªüËÆ°Âä†ËΩΩ');
                        return;
                    }
                    
                    // ÈÄöËøáÂêéÁ´ØAPIËé∑ÂèñËÆ¢ÂçïÂàóË°®ÔºàÊõø‰ª£Áõ¥Êé•Èìæ‰∏äÊü•ËØ¢Ôºâ
                    const orders = await getUserOrdersFromAPI(window.account, 'passenger');
                    
                    if (orders && orders.length > 0) {
                        const processedOrders = orders.map((order) => {
                            try {
                                return {
                                    status: typeof order.status === 'number' ? order.status : 
                                           (order.status?.toNumber ? order.status.toNumber() : parseInt(order.status) || 0),
                                    actualFare: typeof order.actualFare === 'string' ? order.actualFare : 
                                              (order.actualFare ? ethers.utils.formatEther(order.actualFare) : '0')
                                };
                            } catch (error) {
                                return null;
                            }
                        });
                        
                        const validOrders = processedOrders.filter(o => o !== null);
                        const totalOrders = validOrders.length;
                        // ËæÖÂä©ÂáΩÊï∞ÔºöÁ°Æ‰øùÁä∂ÊÄÅË¢´Ê≠£Á°ÆËß£Êûê‰∏∫Êï∞Â≠ó
                        const parseStatusForProfile = (status) => {
                            if (typeof status === 'number') {
                                return status;
                            } else if (status && typeof status.toNumber === 'function') {
                                return status.toNumber();
                            } else {
                                return parseInt(status) || 0;
                            }
                        };
                        const completedOrders = validOrders.filter(o => parseStatusForProfile(o.status) === 3).length;
                        const totalSpent = validOrders
                            .filter(o => parseStatusForProfile(o.status) === 3)
                            .reduce((sum, o) => sum + parseFloat(ethers.utils.formatEther(o.actualFare)), 0);
                        
                        document.getElementById('stat-total-orders').textContent = totalOrders;
                        document.getElementById('stat-completed-orders').textContent = completedOrders;
                        document.getElementById('stat-total-spent').textContent = '$' + (totalSpent * 2500).toFixed(2);
                    }
                } catch (error) {
                    console.error('Error loading profile stats:', error);
                }
            }
            
            // ÊòæÁ§∫Èí±ÂåÖ‰ø°ÊÅØ
            window.showWalletInfo = function() {
                if (window.account) {
                    alert('Wallet Address: ' + window.account + '\n\nYou can copy this address to share or use in other applications.');
                }
            };
            
            // ÊòæÁ§∫ÁΩëÁªú‰ø°ÊÅØ
            window.showNetworkInfo = function() {
                if (window.provider) {
                    window.provider.getNetwork().then(network => {
                        alert('Network: ' + network.name + '\nChain ID: ' + network.chainId);
                    });
                }
            };
            
            // Ê∏ÖÈô§ÁºìÂ≠ò
            window.clearCache = function() {
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                if (confirm(isZh ? 'Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÁºìÂ≠òÊï∞ÊçÆÂêóÔºüËøôÂ∞ÜÂà†Èô§Â∑≤‰øùÂ≠òÁöÑÂêàÁ∫¶Âú∞ÂùÄ„ÄÇ' : 'Are you sure you want to clear all cached data? This will remove saved contract addresses.')) {
                    localStorage.removeItem('RIDE_ORDER_ADDRESS');
                    localStorage.removeItem('PAYMENT_ESCROW_ADDRESS');
                    localStorage.removeItem('RATING_SYSTEM_ADDRESS');
                    alert(isZh ? 'ÁºìÂ≠òÂ∑≤Ê∏ÖÈô§„ÄÇÈ°µÈù¢Â∞ÜÂà∑Êñ∞„ÄÇ' : 'Cache cleared. Page will refresh.');
                    location.reload();
                }
            };
            
            // Âº∫Âà∂ÈáçÊñ∞ËæìÂÖ•ÂêàÁ∫¶Âú∞ÂùÄ
            window.resetContractAddress = async function() {
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                
                if (confirm(isZh 
                    ? 'Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÂêàÁ∫¶Âú∞ÂùÄÂπ∂ÈáçÊñ∞ËæìÂÖ•ÂêóÔºü\n\nËøôÂ∞ÜÂà†Èô§ÂΩìÂâç‰øùÂ≠òÁöÑÂêàÁ∫¶Âú∞ÂùÄÔºåÁÑ∂ÂêéÊèêÁ§∫ÊÇ®ÈáçÊñ∞ËæìÂÖ•„ÄÇ'
                    : 'Are you sure you want to reset the contract address?\n\nThis will clear the saved contract address and prompt you to enter a new one.')) {
                    
                    // Ê∏ÖÈô§ÂêàÁ∫¶Âú∞ÂùÄ
                    localStorage.removeItem('RIDE_ORDER_ADDRESS');
                    localStorage.removeItem('PAYMENT_ESCROW_ADDRESS');
                    localStorage.removeItem('RATING_SYSTEM_ADDRESS');
                    
                    // Ê∏ÖÈô§ window ‰∏≠ÁöÑÂêàÁ∫¶Âú∞ÂùÄ
                    if (window.CONTRACT_ADDRESSES) {
                        window.CONTRACT_ADDRESSES.rideOrder = '';
                        window.CONTRACT_ADDRESSES.paymentEscrow = '';
                        window.CONTRACT_ADDRESSES.ratingSystem = '';
                    }
                    
                    // Ê∏ÖÈô§ÂêàÁ∫¶ÂÆû‰æã
                    if (window.contracts) {
                        window.contracts.rideOrder = null;
                    }
                    window.contractsInitialized = false;
                    
                    console.log('‚úì ÂêàÁ∫¶Âú∞ÂùÄÂ∑≤Ê∏ÖÈô§');
                    
                    // ÈáçÊñ∞Âä†ËΩΩÂêàÁ∫¶Âú∞ÂùÄÔºàËøô‰ºöËß¶ÂèëËæìÂÖ•ÊèêÁ§∫Ôºâ
                    if (typeof loadContractAddresses === 'function') {
                        await loadContractAddresses();
                    } else {
                        // Â¶ÇÊûúÂáΩÊï∞‰∏çÂèØÁî®ÔºåÂà∑Êñ∞È°µÈù¢
                        alert(isZh ? 'ÂêàÁ∫¶Âú∞ÂùÄÂ∑≤Ê∏ÖÈô§„ÄÇÈ°µÈù¢Â∞ÜÂà∑Êñ∞ÔºåËØ∑ÈáçÊñ∞ËæìÂÖ•ÂêàÁ∫¶Âú∞ÂùÄ„ÄÇ' : 'Contract address cleared. Page will refresh, please enter the contract address again.');
                        location.reload();
                    }
                }
            };
            
            window.setActiveNav = function(navId) {
                // Êõ¥Êñ∞ËèúÂçïÊ¥ªÂä®Áä∂ÊÄÅ
                if (window.updateMenuActive) {
                    window.updateMenuActive(navId);
                }
                document.querySelectorAll('.bottom-nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                const navItem = document.getElementById(navId);
                if (navItem) {
                    navItem.classList.add('active');
                }
            };
            
            // Ê£ÄÊµãÊòØÂê¶‰∏∫ÁßªÂä®ËÆæÂ§á
            window.isMobileDevice = function() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            };
            
            // Ê£ÄÊµãÊòØÂê¶Âú®MetaMask MobileÊµèËßàÂô®‰∏≠
            window.isMetaMaskMobile = function() {
                return window.ethereum && window.ethereum.isMetaMask && window.isMobileDevice();
            };
            
            // Ê£ÄÊµãÈí±ÂåÖÊòØÂê¶ÂèØÁî®ÔºàÂåÖÊã¨Â§öÁßçÊ£ÄÊµãÊñπÂºèÔºâ
            window.isWalletAvailable = function() {
                // È¶ñÂÖàÊ£ÄÊü• window.ethereumÔºàÊúÄÊ†áÂáÜÁöÑÊñπÂºèÔºâ
                if (typeof window.ethereum !== 'undefined') {
                    console.log('‚úì window.ethereum detected');
                    console.log('  - isMetaMask:', window.ethereum.isMetaMask);
                    console.log('  - selectedAddress:', window.ethereum.selectedAddress);
                    return true;
                }
                
                // Ê£ÄÊü• window.web3ÔºàÊóßÁâàWeb3Ôºâ
                if (typeof window.web3 !== 'undefined') {
                    console.log('‚úì window.web3 detected');
                    return true;
                }
                
                // Ê£ÄÊü•ÂÖ∂‰ªñÈí±ÂåÖÊ≥®ÂÖ•
                if (window.ethereum) {
                    console.log('‚úì window.ethereum found (alternative check)');
                    return true;
                }
                
                console.log('‚úó No wallet detected');
                console.log('  - typeof window.ethereum:', typeof window.ethereum);
                console.log('  - typeof window.web3:', typeof window.web3);
                
                return false;
            };
            
            // Â∞ùËØïÊâìÂºÄMetaMask Mobile
            window.openMetaMaskMobile = function() {
                // MetaMask Mobile deep link
                const metamaskDeepLink = 'https://metamask.app.link/dapp/' + encodeURIComponent(window.location.href);
                window.location.href = metamaskDeepLink;
            };
            
            // Á≠âÂæÖÈí±ÂåÖÊ≥®ÂÖ•ÔºàÁßªÂä®Á´ØÂèØËÉΩÈúÄË¶ÅÊó∂Èó¥ÔºåÊ°åÈù¢Á´Ø‰πüÂèØËÉΩÈúÄË¶ÅÔºâ
            window.waitForWallet = async function(timeout = 10000) {
                console.log('‚è≥ Waiting for wallet injection...');
                const startTime = Date.now();
                let attempts = 0;
                
                while (Date.now() - startTime < timeout) {
                    attempts++;
                    if (window.isWalletAvailable && window.isWalletAvailable()) {
                        console.log('‚úì Wallet detected after ' + attempts + ' attempts (' + (Date.now() - startTime) + 'ms)');
                        return true;
                    }
                    // ÊØè500msÊ£ÄÊü•‰∏ÄÊ¨°
                    await new Promise(function(resolve) { setTimeout(resolve, 500); });
                    
                    // ÊØè2ÁßíËæìÂá∫‰∏ÄÊ¨°ËøõÂ∫¶
                    if (attempts % 4 === 0) {
                        console.log('  Still waiting... (' + Math.round((Date.now() - startTime) / 1000) + 's)');
                    }
                }
                
                console.log('‚úó Wallet not detected after ' + timeout + 'ms');
                return false;
            };
            
            // ËøûÊé•Èí±ÂåÖ
            window.connectWallet = async function() {
                // Ê†áËÆ∞ÂáΩÊï∞Â∑≤ÂàùÂßãÂåñ
                window._connectWalletInitialized = true;
                try {
                    // Ê£ÄÊµãÁßªÂä®ËÆæÂ§á
                    const isMobile = window.isMobileDevice ? window.isMobileDevice() : false;
                    console.log('üîå Connecting wallet...');
                    console.log('  - Is mobile:', isMobile);
                    console.log('  - User agent:', navigator.userAgent);
                    
                    // Show loading state
                    const connectBtn = document.getElementById('connect-btn');
                    if (connectBtn) {
                        connectBtn.disabled = true;
                        const connectingText = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('connecting') : 'Connecting...';
                        connectBtn.innerHTML = '<span class="loading"></span> ' + connectingText;
                    }
                    
                    // Êó†ËÆ∫ÁßªÂä®Á´ØËøòÊòØÊ°åÈù¢Á´ØÔºåÈÉΩÁ≠âÂæÖÈí±ÂåÖÊ≥®ÂÖ•ÔºàÊúâÊó∂Ê°åÈù¢Á´ØÊâ©Â±ï‰πüÈúÄË¶ÅÊó∂Èó¥Ôºâ
                    if (!window.isWalletAvailable || !window.isWalletAvailable()) {
                        const walletStatus = document.getElementById('wallet-status');
                        if (walletStatus) {
                            walletStatus.className = 'status info';
                            walletStatus.textContent = 'Waiting for wallet...';
                        }
                        console.log('‚è≥ Wallet not immediately available, waiting...');
                        
                        const walletAvailable = window.waitForWallet ? await window.waitForWallet(8000) : false; // Â¢ûÂä†Âà∞8Áßí
                        if (!walletAvailable) {
                            // Êèê‰æõÊõ¥ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
                            const errorMsg = isMobile
                                ? 'Wallet not detected. Please:\n1. Use MetaMask Mobile built-in browser (recommended)\n2. Refresh this page after opening MetaMask\n3. Make sure MetaMask is unlocked'
                                : 'MetaMask not detected. Please:\n1. Make sure MetaMask extension is installed and enabled\n2. Refresh this page\n3. Check if MetaMask is unlocked\n4. Try disabling other wallet extensions';
                            
                            throw new Error(errorMsg);
                        }
                    }
                    
                    // ÂÜçÊ¨°Ê£ÄÊü•Á°Æ‰øùÈí±ÂåÖÂèØÁî®
                    if (window.isWalletAvailable && window.isWalletAvailable()) {
                    // Ëé∑Âèñethereum providerÔºàÊîØÊåÅÂ§öÁßçÈí±ÂåÖÔºâ
                    let ethereum = window.ethereum;
                    console.log('üì° Getting ethereum provider...');
                    
                    // Â¶ÇÊûúwindow.ethereum‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïwindow.web3
                    if (!ethereum && window.web3) {
                        console.log('  - Using window.web3.currentProvider');
                        ethereum = window.web3.currentProvider;
                    }
                    
                    if (!ethereum) {
                        console.error('‚úó Ethereum provider not found after detection');
                        throw new Error('Ethereum provider not found. Please refresh the page.');
                    }
                    
                    console.log('‚úì Ethereum provider found');
                    console.log('  - Provider type:', ethereum.constructor.name);
                    console.log('  - Is MetaMask:', ethereum.isMetaMask);
                        
                        // Ê£ÄÊü•Âπ∂ÂàáÊç¢Âà∞ Hardhat Êú¨Âú∞ÁΩëÁªúÔºàÂ¶ÇÊûú‰∏çÂú®Ê≠£Á°ÆÁΩëÁªúÔºâ
                        try {
                            const currentChainId = await ethereum.request({ method: 'eth_chainId' });
                            const hardhatChainId = '0x539'; // 1337 ÁöÑÂçÅÂÖ≠ËøõÂà∂ÔºàÂåπÈÖç hardhat.config.jsÔºâ
                            
                            console.log('üîç Checking network...');
                            console.log('  - Current Chain ID:', currentChainId);
                            console.log('  - Expected Chain ID:', hardhatChainId, '(1337)');
                            
                            if (currentChainId !== hardhatChainId) {
                                console.log('‚ö†Ô∏è  Not on Hardhat network, switching...');
                                
                                try {
                                    // Â∞ùËØïÂàáÊç¢Âà∞ Hardhat ÁΩëÁªú
                                    await ethereum.request({
                                        method: 'wallet_switchEthereumChain',
                                        params: [{ chainId: hardhatChainId }]
                                    });
                                    console.log('‚úì Switched to Hardhat network');
                                } catch (switchError) {
                                    // Â¶ÇÊûúÁΩëÁªú‰∏çÂ≠òÂú®ÔºåÊ∑ªÂä†ÂÆÉ
                                    if (switchError.code === 4902) {
                                        console.log('‚ûï Hardhat network not found, adding...');
                                        await ethereum.request({
                                            method: 'wallet_addEthereumChain',
                                            params: [{
                                                chainId: hardhatChainId,
                                                chainName: 'Hardhat Local Network (Development)',
                                                nativeCurrency: {
                                                    name: 'Ethereum',
                                                    symbol: 'ETH',
                                                    decimals: 18
                                                },
                                                rpcUrls: ['http://127.0.0.1:8545', 'http://localhost:8545'],
                                                blockExplorerUrls: null
                                            }]
                                        });
                                        console.log('‚úì Added and switched to Hardhat network');
                                    } else {
                                        console.warn('‚ö†Ô∏è  Could not switch network:', switchError.message);
                                        // ÁªßÁª≠ÊâßË°åÔºåËÆ©Áî®Êà∑ÊâãÂä®ÂàáÊç¢
                                    }
                                }
                            } else {
                                console.log('‚úì Already on Hardhat network');
                            }
                        } catch (networkError) {
                            console.warn('‚ö†Ô∏è  Network check failed:', networkError.message);
                            // ÁªßÁª≠ÊâßË°åÔºå‰∏çÈòªÊ≠¢ËøûÊé•
                        }
                    
                    // ËØ∑Ê±ÇËøûÊé•Ë¥¶Êà∑
                    console.log('üîê Requesting accounts...');
                    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                    console.log('‚úì Accounts received:', accounts);
                    
                    if (!accounts || accounts.length === 0) {
                        throw new Error('No accounts found. Please unlock your wallet.');
                    }
                    
                    window.account = accounts[0];
                    
                    window.provider = new ethers.providers.Web3Provider(ethereum);
                    window.signer = window.provider.getSigner();
                    
                    // Êõ¥Êñ∞ËèúÂçï‰∏≠ÁöÑËøûÊé•Áä∂ÊÄÅ
                    const menuConnectionStatus = document.getElementById('menu-connection-status');
                    const menuConnectionText = document.getElementById('menu-connection-text');
                    const connectedText = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('connected') : 'Connected';
                    if (menuConnectionStatus && menuConnectionText) {
                        menuConnectionStatus.style.display = 'block';
                        menuConnectionText.textContent = connectedText;
                    }
                    
                    // Êõ¥Êñ∞ËèúÂçï‰∏≠ÁöÑË¥¶Êà∑‰ø°ÊÅØ
                    const menuAccountInfo = document.getElementById('menu-account-info');
                    const menuAccountAddress = document.getElementById('menu-account-address');
                    if (menuAccountInfo && menuAccountAddress) {
                        menuAccountInfo.style.display = 'block';
                        menuAccountAddress.textContent = window.account.substring(0, 6) + '...' + window.account.substring(38);
                    }
                    
                    // ËøûÊé•ÊàêÂäüÂêéÈöêËóèwallet-statusÔºàÁä∂ÊÄÅÂ∑≤ÁßªÂà∞ËèúÂçï‰∏≠Ôºâ
                    const walletStatus = document.getElementById('wallet-status');
                    if (walletStatus) {
                        walletStatus.style.display = 'none';
                    }
                    
                    if (connectBtn) {
                        connectBtn.textContent = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('connected') : 'Connected';
                        connectBtn.disabled = true;
                    }
                    
                    const orderFormSection = document.getElementById('order-form-section');
                    if (orderFormSection) orderFormSection.style.display = 'block';
                    
                    const mobileWalletGuide = document.getElementById('mobile-wallet-guide');
                    if (mobileWalletGuide) mobileWalletGuide.style.display = 'none';
                    
                    // ÂàùÂßãÂåñÂêàÁ∫¶
                    if (typeof initializeContracts === 'function') {
                        await initializeContracts();
                    }
                    if (typeof loadContractAddresses === 'function') {
                        await loadContractAddresses();
                    }
                    
                    // ÂêØÂä®ËÆ¢ÂçïÁä∂ÊÄÅËá™Âä®Âà∑Êñ∞
                    if (typeof window.startOrderAutoRefresh === 'function') {
                        window.startOrderAutoRefresh();
                    }
                    
                    // ËÆæÁΩÆÊô∫ËÉΩÂêàÁ∫¶‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÂÆûÊó∂ÂìçÂ∫îÁä∂ÊÄÅÂèòÂåñÔºàÂú®ÂêàÁ∫¶ÂàùÂßãÂåñÂÆåÊàêÂêéÔºâ
                    // Ê≥®ÊÑèÔºö‰∫ã‰ª∂ÁõëÂê¨Âô®‰ºöÂú® initializeContracts() ÂÆåÊàêÂêéËá™Âä®ËÆæÁΩÆ
                    
                } else if (isMobile) {
                    // ÁßªÂä®Á´ØÊú™Ê£ÄÊµãÂà∞Èí±ÂåÖ
                    document.getElementById('wallet-status').className = 'status warning';
                    document.getElementById('wallet-status').innerHTML = `
                        <strong>üì± Mobile Wallet Not Detected</strong><br>
                        <p style="margin-top: 10px;">Please try one of the following:</p>
                        <ol style="margin-left: 20px; margin-top: 10px;">
                            <li>Use <strong>MetaMask Mobile</strong> built-in browser (recommended)</li>
                            <li>Refresh this page after opening MetaMask</li>
                            <li>Make sure MetaMask Mobile is installed and unlocked</li>
                        </ol>
                    `;
                    document.getElementById('mobile-wallet-guide').style.display = 'block';
                    
                    const userChoice = confirm(
                        i18n.t('installMetaMaskMobile') + '\n\n' +
                        'Would you like to open MetaMask Mobile?'
                    );
                    if (userChoice) {
                        openMetaMaskMobile();
                    }
                } else {
                    // Êú™Ê£ÄÊµãÂà∞Èí±ÂåÖ
                    console.error('‚úó Wallet not available after waiting');
                    document.getElementById('wallet-status').className = 'status error';
                    
                    // Êèê‰æõËØ¶ÁªÜÁöÑËØäÊñ≠‰ø°ÊÅØ
                    const diagnostics = `
                        Wallet Detection Failed
                        
                        Debug Info:
                        - window.ethereum: ${typeof window.ethereum}
                        - window.web3: ${typeof window.web3}
                        - User Agent: ${navigator.userAgent.substring(0, 50)}...
                        
                        Troubleshooting:
                        ${isMobileDevice() 
                            ? '1. Use MetaMask Mobile built-in browser\n2. Refresh the page\n3. Make sure MetaMask is unlocked'
                            : '1. Install MetaMask extension: https://metamask.io/\n2. Enable the extension in browser settings\n3. Refresh this page (F5)\n4. Make sure MetaMask is unlocked'
                        }
                        
                        Check browser console (F12) for more details.
                    `;
                    
                    document.getElementById('wallet-status').innerHTML = `
                        <strong>‚ùå ${i18n.t('walletConnectError')}</strong><br>
                        <p style="margin-top: 10px; font-size: 0.9em;">
                            ${isMobileDevice() 
                                ? 'Mobile wallet not detected. Please use MetaMask Mobile built-in browser or refresh the page.'
                                : 'MetaMask extension not detected. Please install MetaMask or refresh the page after installation.'
                            }
                        </p>
                        <p style="margin-top: 10px; font-size: 0.85em; color: #666;">
                            Open browser console (F12) for detailed diagnostics.
                        </p>
                    `;
                    
                    // ÊòæÁ§∫ÂèãÂ•ΩÁöÑÊèêÁ§∫
                    if (!isMobileDevice()) {
                        const userChoice = confirm(
                            'MetaMask not detected.\n\n' +
                            'Please:\n' +
                            '1. Install MetaMask from https://metamask.io/\n' +
                            '2. Refresh this page\n\n' +
                            'Would you like to open the MetaMask download page?'
                        );
                        if (userChoice) {
                            window.open('https://metamask.io/download/', '_blank');
                        }
                    }
                }
                } catch (error) {
                    console.error('‚ùå Wallet connection failed:', error);
                    console.error('  - Error code:', error.code);
                    console.error('  - Error message:', error.message);
                    if (error.stack) {
                        console.error('  - Error stack:', error.stack);
                    }
                    
                    const walletStatus = document.getElementById('wallet-status');
                    if (!walletStatus) return;
                    
                    walletStatus.className = 'status error';
                    
                    // Êõ¥ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
                    let errorMessage = error.message || error.toString();
                    let troubleshooting = '';
                    const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                    
                    if (error.code === 4001) {
                        errorMessage = isZh ? 'Áî®Êà∑ÊãíÁªù‰∫ÜËøûÊé•ËØ∑Ê±Ç' : 'User rejected the connection request';
                        troubleshooting = isZh
                            ? '‚Ä¢ ËØ∑Âú®MetaMask‰∏≠ÁÇπÂáª"ËøûÊé•"Êàñ"ÊâπÂáÜ"<br>‚Ä¢ Á°Æ‰øùÈí±ÂåÖÂ∑≤Ëß£ÈîÅ'
                            : '‚Ä¢ Click "Connect" or "Approve" in MetaMask<br>‚Ä¢ Make sure your wallet is unlocked';
                    } else if (error.code === -32002) {
                        errorMessage = isZh
                            ? 'ËøûÊé•ËØ∑Ê±ÇÂ∑≤Âú®ËøõË°å‰∏≠ÔºåËØ∑Ê£ÄÊü•MetaMask'
                            : 'Connection request already pending. Please check your wallet.';
                        troubleshooting = isZh
                            ? '‚Ä¢ ÊâìÂºÄMetaMaskÊâ©Â±ïÊü•ÁúãÂæÖÂ§ÑÁêÜÁöÑËØ∑Ê±Ç<br>‚Ä¢ ÊàñÂà∑Êñ∞È°µÈù¢ÈáçËØï'
                            : '‚Ä¢ Open MetaMask extension to see pending request<br>‚Ä¢ Or refresh the page to retry';
                    } else if (error.message && error.message.includes('not detected')) {
                        troubleshooting = isZh
                            ? '‚Ä¢ Á°Æ‰øùMetaMaskÊâ©Â±ïÂ∑≤ÂÆâË£ÖÂπ∂ÂêØÁî®<br>‚Ä¢ Âà∑Êñ∞È°µÈù¢ÔºàF5Ôºâ<br>‚Ä¢ Ê£ÄÊü•ÊµèËßàÂô®Êâ©Â±ïËÆæÁΩÆ<br>‚Ä¢ Â∞ùËØïÁ¶ÅÁî®ÂÖ∂‰ªñÈí±ÂåÖÊâ©Â±ï'
                            : '‚Ä¢ Make sure MetaMask extension is installed and enabled<br>‚Ä¢ Refresh the page (F5)<br>‚Ä¢ Check browser extension settings<br>‚Ä¢ Try disabling other wallet extensions';
                    } else {
                        troubleshooting = isZh
                            ? '‚Ä¢ Á°Æ‰øùÈí±ÂåÖÂ∑≤Ëß£ÈîÅ<br>‚Ä¢ Â∞ùËØïÂà∑Êñ∞È°µÈù¢<br>‚Ä¢ Ê£ÄÊü•ÊòØÂê¶‰ΩøÁî®‰∫ÜÊ≠£Á°ÆÁöÑÁΩëÁªú<br>‚Ä¢ Êü•ÁúãÊµèËßàÂô®ÊéßÂà∂Âè∞ÔºàF12ÔºâËé∑ÂèñÊõ¥Â§ö‰ø°ÊÅØ'
                            : '‚Ä¢ Make sure your wallet is unlocked<br>‚Ä¢ Try refreshing the page<br>‚Ä¢ Check if you are using the correct network<br>‚Ä¢ Open browser console (F12) for more details';
                    }
                    
                    const errorText = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('walletConnectError') : 'Connection failed:';
                    walletStatus.innerHTML = '<strong>' + errorText + '</strong><br><p style="margin-top: 8px;">' + errorMessage + '</p>' + (troubleshooting ? '<p style="margin-top: 10px; font-size: 0.9em;"><strong>Troubleshooting:</strong><br>' + troubleshooting + '</p>' : '');
                    
                    // Â¶ÇÊûúÊòØÁßªÂä®Á´ØÔºåÊòæÁ§∫Êõ¥Â§öÂ∏ÆÂä©
                    if (window.isMobileDevice && window.isMobileDevice()) {
                        const mobileWalletGuide = document.getElementById('mobile-wallet-guide');
                        if (mobileWalletGuide) mobileWalletGuide.style.display = 'block';
                    }
                } finally {
                    // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                    if (!window.account) {
                        const connectBtn = document.getElementById('connect-btn');
                        if (connectBtn) {
                            connectBtn.disabled = false;
                            connectBtn.textContent = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('connectWallet') : 'Connect Wallet';
                        }
                    }
                }
            };
            
            // Êö¥Èú≤ÂÖ∂‰ªñÂøÖË¶ÅÁöÑÂáΩÊï∞Âà∞ÂÖ®Â±Ä
            window.calculateFare = function() {
                // ËÆ°ÁÆóË¥πÁî®ÁöÑÂáΩÊï∞‰ºöÂú®ÂêéÈù¢ÂÆö‰πâ
                if (window._calculateFare) {
                    return window._calculateFare();
                }
            };
            
            window.createOrder = function() {
                // ÂàõÂª∫ËÆ¢ÂçïÁöÑÂáΩÊï∞‰ºöÂú®ÂêéÈù¢ÂÆö‰πâ
                if (window._createOrder) {
                    return window._createOrder();
                }
            };
            
        })(); // IIFEÁªìÊùü
        
        // Á°Æ‰øùconnectWalletÂáΩÊï∞ÊÄªÊòØË¢´ÂÆö‰πâÔºàÂç≥‰ΩøÂú®IIFEÊâßË°åÂ§±Ë¥•ÁöÑÊÉÖÂÜµ‰∏ãÔºâ
        // Â¶ÇÊûúIIFEÊâßË°åÂ§±Ë¥•ÔºåÂç†‰ΩçÁ¨¶ÂáΩÊï∞‰ºöË¢´‰øùÁïô
        try {
            // Ê£ÄÊü•IIFEÊòØÂê¶ÊàêÂäüÂÆö‰πâ‰∫ÜÂáΩÊï∞
            if (typeof window.connectWallet === 'function' && window.connectWallet.toString().includes('not yet initialized')) {
                // IIFEÊâßË°åÂ§±Ë¥•Ôºå‰øùÁïôÂç†‰ΩçÁ¨¶ÂáΩÊï∞
                console.warn('IIFE may have failed. connectWallet function may not be fully initialized.');
            }
        } catch (e) {
            console.error('Error checking connectWallet function:', e);
        }
        
        // ÁªßÁª≠ÂÆö‰πâÂÖ∂‰ªñÂáΩÊï∞Ôºà‰ΩøÁî®ÂéüÊù•ÁöÑÂÆö‰πâÊñπÂºèÔºåÂõ†‰∏∫ÂÆÉ‰ª¨Âú®IIFEÂ§ñÈÉ®Ôºâ
        let provider = window.provider || null;
        let signer = window.signer || null;
        let account = window.account || null;
        let contracts = window.contracts || {};
        
        // APIÂü∫Á°ÄURL
        const API_BASE_URL = window.API_BASE_URL || 'http://localhost:3000';
        
        /**
         * ÈÄöËøáÂêéÁ´ØAPIËé∑ÂèñËÆ¢ÂçïËØ¶ÊÉÖÔºàÊõø‰ª£Áõ¥Êé•Èìæ‰∏äÊü•ËØ¢Ôºâ
         */
        async function getOrderFromAPI(orderId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/orders/${orderId}`);
                if (!response.ok) {
                    throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} ${response.statusText}`);
                }
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Ëé∑ÂèñËÆ¢ÂçïÂ§±Ë¥•');
                }
                return result.data;
            } catch (error) {
                console.error(`[API] Ëé∑ÂèñËÆ¢Âçï ${orderId} Â§±Ë¥•:`, error);
                // Â¶ÇÊûúAPIÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞Èìæ‰∏äÊü•ËØ¢Ôºà‰ªÖ‰Ωú‰∏∫ÂêéÂ§áÊñπÊ°àÔºâ
                if (window.contracts?.rideOrder) {
                    console.warn(`[Fallback] ÂõûÈÄÄÂà∞Èìæ‰∏äÊü•ËØ¢ËÆ¢Âçï ${orderId}`);
                    return await window.contracts.rideOrder.getOrder(orderId);
                }
                throw error;
            }
        }
        
        /**
         * ÈÄöËøáÂêéÁ´ØAPIËé∑ÂèñÁî®Êà∑ËÆ¢ÂçïÂàóË°®ÔºàÊõø‰ª£Áõ¥Êé•Èìæ‰∏äÊü•ËØ¢Ôºâ
         */
        async function getUserOrdersFromAPI(address, type = 'passenger') {
            try {
                const response = await fetch(`${API_BASE_URL}/api/users/${address}/orders?type=${type}`);
                if (!response.ok) {
                    throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} ${response.statusText}`);
                }
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Ëé∑ÂèñËÆ¢ÂçïÂàóË°®Â§±Ë¥•');
                }
                return result.data || [];
            } catch (error) {
                console.error(`[API] Ëé∑ÂèñÁî®Êà∑ËÆ¢ÂçïÂàóË°®Â§±Ë¥•:`, error);
                // Â¶ÇÊûúAPIÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞Èìæ‰∏äÊü•ËØ¢Ôºà‰ªÖ‰Ωú‰∏∫ÂêéÂ§áÊñπÊ°àÔºâ
                if (window.contracts?.rideOrder && type === 'passenger') {
                    console.warn(`[Fallback] ÂõûÈÄÄÂà∞Èìæ‰∏äÊü•ËØ¢Áî®Êà∑ËÆ¢Âçï`);
                    const orderIds = await window.contracts.rideOrder.getPassengerOrders(address);
                    // Â∞ÜËÆ¢ÂçïIDÊï∞ÁªÑËΩ¨Êç¢‰∏∫ËÆ¢ÂçïÂØπË±°Êï∞ÁªÑ
                    const orders = await Promise.all(
                        orderIds.map(async (id) => {
                            try {
                                const orderIdNum = typeof id === 'object' && id.toNumber ? id.toNumber() : parseInt(id);
                                return await getOrderFromAPI(orderIdNum);
                            } catch (e) {
                                console.warn(`Ëé∑ÂèñËÆ¢Âçï ${id} Â§±Ë¥•:`, e);
                                return null;
                            }
                        })
                    );
                    return orders.filter(o => o !== null);
                }
                throw error;
            }
        }
        
        // Êö¥Èú≤Âà∞ÂÖ®Â±ÄÔºå‰æõÂÖ∂‰ªñÂáΩÊï∞‰ΩøÁî®
        window.getOrderFromAPI = getOrderFromAPI;
        window.getUserOrdersFromAPI = getUserOrdersFromAPI;
        
        // ÂêàÁ∫¶Âú∞ÂùÄÔºà‰ªéwindowËé∑ÂèñÔºåÂ∑≤Âú®IIFE‰∏≠ÂÆö‰πâÔºâ
        // Ê≥®ÊÑèÔºöCONTRACT_ADDRESSESÂ∑≤Âú®IIFE‰∏≠ÂÆö‰πâÂπ∂Êö¥Èú≤Âà∞windowÔºåËøôÈáåÁõ¥Êé•‰ΩøÁî®windowÂØπË±°
        // ÂêàÁ∫¶ABIÔºà‰ªéwindowËé∑ÂèñÔºâ
        const TRUST_FLOW_RIDE_ABI = window.TRUST_FLOW_RIDE_ABI || [
            "function createOrder(int256 _pickupLat, int256 _pickupLng, string memory _pickupAddress, int256 _destLat, int256 _destLng, string memory _destAddress, string memory _category, string memory _subCategory, uint256 _estimatedFare) external payable returns (uint256)",
            "function getOrder(uint256 _orderId) external view returns (tuple(uint256 orderId, address passenger, address driver, tuple(int256 latitude, int256 longitude, string addressText) pickup, tuple(int256 latitude, int256 longitude, string addressText) destination, string category, string subCategory, uint256 estimatedFare, uint256 actualFare, uint8 status, uint8 rideStatus, uint256 createdAt, uint256 acceptedAt, uint256 pickedUpAt, uint256 completedAt, uint256 startTimestamp, uint256 endTimestamp, string ipfsHash, bool disputeOpened, bool disputeResolved, address disputeOpener, address disputeWinner, string disputeReason, uint256 disputeOpenedAt, uint256 disputeResolvedAt, string disputeResolutionDetail))",
            "function getPassengerOrders(address _passenger) external view returns (uint256[] memory)",
            "function cancelOrder(uint256 _orderId, string memory _reason) external",
                "function getDisputeStatus(uint256 _orderId) external view returns (bool disputeOpened, string memory disputeReason, bool disputeResolved, address disputeOpener, address disputeWinner, uint256 disputeOpenedAt, uint256 disputeResolvedAt, string memory disputeResolutionDetail, uint8 rideStatus)",
                "function settle(uint256 _orderId) external",
                "function submitDispute(uint256 _orderId, string memory _reason) external",
                "function completeOrder(uint256 _orderId, uint256 _actualFare) external",
                "function orderCount() external view returns (uint256)",
            "event OrderCreated(uint256 indexed orderId, address indexed passenger, int256 pickupLat, int256 pickupLng, int256 destLat, int256 destLng, string category, string subCategory, uint256 estimatedFare)",
            "event OrderCancelled(uint256 indexed orderId, address indexed cancelledBy, string reason)",
            "event OrderAccepted(uint256 indexed orderId, address indexed driver)",
            "event RideAccepted(uint256 indexed orderId, address indexed driver, uint256 timestamp)",
            "event PassengerPickedUp(uint256 indexed orderId, uint256 timestamp)",
            "event RideStarted(uint256 indexed orderId, uint256 timestamp)",
            "event RideCompleted(uint256 indexed orderId, uint256 timestamp)",
            "event RideSettled(uint256 indexed orderId, uint256 timestamp)",
            "event DisputeOpened(uint256 indexed orderId, address indexed by, string reason, uint256 timestamp)",
            "event DisputeResolved(uint256 indexed orderId, address indexed winner, string detail, uint256 timestamp)"
        ];
        
            // ÂàùÂßãÂåñÂêàÁ∫¶
        async function initializeContracts() {
            const CONTRACT_ADDRESSES = window.CONTRACT_ADDRESSES || {};
            if (!CONTRACT_ADDRESSES || !CONTRACT_ADDRESSES.rideOrder) {
                // Ê£ÄÊü•ÊòØÂê¶Âú®Êú¨Âú∞ÂºÄÂèëÁéØÂ¢É
                const isLocalhost = window.location.hostname === 'localhost' || 
                                   window.location.hostname === '127.0.0.1' ||
                                   window.location.hostname === '';
                
                if (isLocalhost) {
                    // ÂºÄÂèëÁéØÂ¢ÉÔºöÊèê‰æõÂèãÂ•ΩÁöÑÊèêÁ§∫Ôºå‰ΩÜ‰∏çÈòªÊ≠¢Áî®Êà∑ÊµèËßà
                    document.getElementById('wallet-status').className = 'status info';
                    document.getElementById('wallet-status').innerHTML = `
                        <strong>üí° ÊèêÁ§∫ / Tip</strong><br>
                        <p style="margin-top: 10px; font-size: 0.9em;">
                            ÂêàÁ∫¶Âú∞ÂùÄÊú™ÈÖçÁΩÆÔºåÊÇ®ÂèØ‰ª•ÊµèËßàÁïåÈù¢Ôºå‰ΩÜÊó†Ê≥ïÂàõÂª∫ÁúüÂÆûËÆ¢Âçï„ÄÇ<br>
                            <small style="opacity: 0.9;">Contract address not set. You can explore the UI, but cannot create real orders.</small>
                        </p>
                        <details style="margin-top: 12px; cursor: pointer;">
                            <summary style="color: var(--primary-color); font-weight: 500; user-select: none;">
                                üìö Â¶Ç‰ΩïÈÉ®ÁΩ≤ÂêàÁ∫¶Ôºü / How to deploy contracts?
                            </summary>
                            <div style="margin-top: 10px; padding: 12px; background: #f9fafb; border-radius: 8px; font-size: 0.9em;">
                                <strong>Step 1:</strong> ÂêØÂä®Êú¨Âú∞ËäÇÁÇπ<br>
                                <code style="background: white; padding: 4px 8px; border-radius: 4px; display: inline-block; margin: 4px 0;">npm run node</code><br><br>
                                <strong>Step 2:</strong> ÈÉ®ÁΩ≤ÂêàÁ∫¶<br>
                                <code style="background: white; padding: 4px 8px; border-radius: 4px; display: inline-block; margin: 4px 0;">npm run deploy:local</code><br><br>
                                <strong>Step 3:</strong> Âà∑Êñ∞È°µÈù¢Âπ∂ËæìÂÖ•ÂêàÁ∫¶Âú∞ÂùÄ
                            </div>
                        </details>
                    `;
                } else {
                    // Áîü‰∫ßÁéØÂ¢ÉÔºöÊòæÁ§∫ÂèãÂ•ΩÁöÑÊèêÁ§∫
                    document.getElementById('wallet-status').className = 'status info';
                    document.getElementById('wallet-status').textContent = 'System is being configured. Some features may be limited.';
                }
                
                // ‰∏çËøîÂõûÔºåËÆ©Áî®Êà∑ÁªßÁª≠ÊµèËßàÁïåÈù¢Ôºå‰ΩÜÊ†áËÆ∞ÂêàÁ∫¶Êú™ÂàùÂßãÂåñ
                window.contractsInitialized = false;
                return;
            }
            
            // Ëé∑Âèñ signer Êàñ providerÔºà‰ºòÂÖà‰ΩøÁî® signerÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî® providerÔºâ
            const currentSigner = window.signer || signer;
            const currentProvider = window.provider || provider;
            
            // Â¶ÇÊûúÊ≤°Êúâ signer ‰πüÊ≤°Êúâ providerÔºåÂàõÂª∫‰∏Ä‰∏™Âè™ËØªÁöÑ provider
            let contractProvider = currentSigner;
            if (!contractProvider && !currentProvider) {
                // ÂàõÂª∫‰∏Ä‰∏™Âè™ËØª provider Áî®‰∫é‰∫ã‰ª∂ÁõëÂê¨
                contractProvider = new ethers.providers.JsonRpcProvider('http://localhost:8545');
                console.warn('‚ö†Ô∏è No signer or provider found, using read-only provider for event listening');
            } else if (!contractProvider) {
                // Â¶ÇÊûúÊúâ provider ‰ΩÜÊ≤°Êúâ signerÔºå‰ΩøÁî® provider
                contractProvider = currentProvider;
                console.log('‚ÑπÔ∏è Using provider (read-only) for contract initialization');
            }
            
            if (!contractProvider) {
                console.error('‚ùå Cannot initialize contracts: no provider or signer available');
                window.contractsInitialized = false;
                return;
            }
            
            // ÂàùÂßãÂåñ TrustFlowRide ÂêàÁ∫¶
            contracts.rideOrder = new ethers.Contract(
                CONTRACT_ADDRESSES.rideOrder,
                TRUST_FLOW_RIDE_ABI,
                contractProvider
            );
            
            // ÂàùÂßãÂåñ TrustFlowEscrow ÂêàÁ∫¶ÔºàÂ¶ÇÊûúÂú∞ÂùÄÂ∑≤ÈÖçÁΩÆÔºâ
            if (CONTRACT_ADDRESSES.paymentEscrow) {
                contracts.paymentEscrow = new ethers.Contract(
                    CONTRACT_ADDRESSES.paymentEscrow,
                    window.TRUST_FLOW_ESCROW_ABI,
                    contractProvider
                );
            }
            
            // ‰øùÂ≠òÂà∞ window ÂØπË±°
            window.contracts = contracts;
            
            // Ê†áËÆ∞ÂêàÁ∫¶Â∑≤ÂàùÂßãÂåñ
            window.contractsInitialized = true;
            
            // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
            if (typeof window.setupRideEventListeners === 'function') {
                window.setupRideEventListeners();
            }
        }
        
        // ‰ªéÈÉ®ÁΩ≤‰ø°ÊÅØÂä†ËΩΩÂêàÁ∫¶Âú∞ÂùÄ
        async function loadContractAddresses() {
            try {
                // Á°Æ‰øùCONTRACT_ADDRESSESÂ≠òÂú®
                if (!window.CONTRACT_ADDRESSES) {
                    window.CONTRACT_ADDRESSES = {
                        rideOrder: '',
                        paymentEscrow: '',
                        ratingSystem: ''
                    };
                }
                const CONTRACT_ADDRESSES = window.CONTRACT_ADDRESSES;
                
                // ‰ºòÂÖà‰ªéÂêéÁ´ØAPIËé∑ÂèñÂêàÁ∫¶Âú∞ÂùÄÔºàÊúÄÊñ∞Ôºâ
                let loadedFromAPI = false;
                const API_BASE_URL = window.API_BASE_URL || 'http://localhost:3000';
                
                // ËÆ∞ÂΩïÂΩìÂâçÂú∞ÂùÄÔºåÈÅøÂÖçÈáçÂ§çÂàùÂßãÂåñ
                const currentAddress = CONTRACT_ADDRESSES.rideOrder;
                let addressChanged = false;
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/contracts/addresses`);
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data) {
                            const contracts = result.data;
                            
                            if (contracts.rideOrder && contracts.rideOrder.startsWith('0x') && contracts.rideOrder.length === 42) {
                                // Ê£ÄÊü•Âú∞ÂùÄÊòØÂê¶ÂèòÂåñ
                                if (currentAddress && currentAddress !== contracts.rideOrder) {
                                    addressChanged = true;
                                    console.log('‚ö†Ô∏è Ê£ÄÊµãÂà∞ÂêàÁ∫¶Âú∞ÂùÄÂèòÂåñ:', currentAddress, '->', contracts.rideOrder);
                                    console.log('‚ö†Ô∏è ËøôÈÄöÂ∏∏ÂèëÁîüÂú®ÈáçÊñ∞ÈÉ®ÁΩ≤ÂêéÔºåÈ°µÈù¢ÈúÄË¶ÅÊâãÂä®Âà∑Êñ∞');
                                }
                                
                                CONTRACT_ADDRESSES.rideOrder = contracts.rideOrder;
                                CONTRACT_ADDRESSES.paymentEscrow = contracts.paymentEscrow || '';
                                CONTRACT_ADDRESSES.ratingSystem = contracts.ratingSystem || '';
                                
                                // Êõ¥Êñ∞ localStorageÔºàÂº∫Âà∂‰ΩøÁî®ÊúÄÊñ∞Âú∞ÂùÄÔºâ
                                localStorage.setItem('RIDE_ORDER_ADDRESS', contracts.rideOrder);
                                if (contracts.paymentEscrow) {
                                    localStorage.setItem('PAYMENT_ESCROW_ADDRESS', contracts.paymentEscrow);
                                }
                                if (contracts.ratingSystem) {
                                    localStorage.setItem('RATING_SYSTEM_ADDRESS', contracts.ratingSystem);
                                }
                                
                                console.log('‚úì ‰ªéÂêéÁ´ØAPIÂä†ËΩΩÂêàÁ∫¶Âú∞ÂùÄ:', contracts.rideOrder);
                                loadedFromAPI = true;
                            }
                        }
                    }
                } catch (e) {
                    console.log('Êó†Ê≥ï‰ªéÂêéÁ´ØAPIÂä†ËΩΩÂêàÁ∫¶Âú∞ÂùÄÔºåÂ∞ùËØïÂÖ∂‰ªñÊñπÂºè:', e.message);
                }
                
                // Â¶ÇÊûúAPIÂä†ËΩΩÂ§±Ë¥•ÔºåÂ∞ùËØï‰ªéÈÉ®ÁΩ≤Êñá‰ª∂Âä†ËΩΩ
                let loadedFromFile = false;
                if (!loadedFromAPI) {
                    try {
                        const response = await fetch('/deployments/localhost-latest.json');
                        if (response.ok) {
                            const deployment = await response.json();
                            const contracts = deployment.contracts;
                            
                            if (contracts.rideOrder) {
                                // È™åËØÅÂêàÁ∫¶Âú∞ÂùÄÊ†ºÂºè
                                if (contracts.rideOrder.startsWith('0x') && contracts.rideOrder.length === 42) {
                                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÊóßÂú∞ÂùÄÔºàÂ∑≤Áü•ÁöÑÊóßÂú∞ÂùÄÂàóË°®Ôºâ
                                    const oldAddresses = [
                                        '0x8f86403A4DE0BB5791fa46B8e795C547942fE4Cf',
                                        '0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0'
                                    ];
                                    
                                    // Â¶ÇÊûú localStorage ‰∏≠ÁöÑÂú∞ÂùÄÊòØÊóßÂú∞ÂùÄÔºåÊ∏ÖÈô§ÂÆÉ
                                    const savedAddress = localStorage.getItem('RIDE_ORDER_ADDRESS');
                                    if (savedAddress && oldAddresses.includes(savedAddress)) {
                                        console.warn('‚ö†Ô∏è Ê£ÄÊµãÂà∞ÊóßÂêàÁ∫¶Âú∞ÂùÄÔºåÂ∑≤Ê∏ÖÈô§:', savedAddress);
                                        localStorage.removeItem('RIDE_ORDER_ADDRESS');
                                        localStorage.removeItem('PAYMENT_ESCROW_ADDRESS');
                                        localStorage.removeItem('RATING_SYSTEM_ADDRESS');
                                    }
                                    
                                    CONTRACT_ADDRESSES.rideOrder = contracts.rideOrder;
                                    CONTRACT_ADDRESSES.paymentEscrow = contracts.paymentEscrow || '';
                                    CONTRACT_ADDRESSES.ratingSystem = contracts.ratingSystem || '';
                                    
                                    // Êõ¥Êñ∞ localStorageÔºàÂº∫Âà∂‰ΩøÁî®ÊúÄÊñ∞Âú∞ÂùÄÔºâ
                                    localStorage.setItem('RIDE_ORDER_ADDRESS', contracts.rideOrder);
                                    if (contracts.paymentEscrow) {
                                        localStorage.setItem('PAYMENT_ESCROW_ADDRESS', contracts.paymentEscrow);
                                    }
                                    if (contracts.ratingSystem) {
                                        localStorage.setItem('RATING_SYSTEM_ADDRESS', contracts.ratingSystem);
                                    }
                                    
                                    console.log('‚úì ‰ªéÈÉ®ÁΩ≤Êñá‰ª∂Âä†ËΩΩÂêàÁ∫¶Âú∞ÂùÄ:', contracts.rideOrder);
                                    loadedFromFile = true;
                                }
                            }
                        }
                    } catch (e) {
                        console.log('Êó†Ê≥ï‰ªéÈÉ®ÁΩ≤Êñá‰ª∂Âä†ËΩΩÂêàÁ∫¶Âú∞ÂùÄÔºåÂ∞Ü‰ΩøÁî® localStorage:', e.message);
                    }
                }
                
                // Â¶ÇÊûúÈÉΩÊ≤°ÊúâÂä†ËΩΩÊàêÂäüÔºåÂ∞ùËØï‰ªé localStorage Âä†ËΩΩ
                if (!loadedFromAPI && !loadedFromFile) {
                    const savedAddresses = {
                        rideOrder: localStorage.getItem('RIDE_ORDER_ADDRESS'),
                        paymentEscrow: localStorage.getItem('PAYMENT_ESCROW_ADDRESS'),
                        ratingSystem: localStorage.getItem('RATING_SYSTEM_ADDRESS')
                    };
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÊóßÂú∞ÂùÄ
                    const oldAddresses = [
                        '0x8f86403A4DE0BB5791fa46B8e795C547942fE4Cf',
                        '0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0'
                    ];
                    
                    if (savedAddresses.rideOrder && oldAddresses.includes(savedAddresses.rideOrder)) {
                        console.warn('‚ö†Ô∏è localStorage ‰∏≠ÁöÑÂêàÁ∫¶Âú∞ÂùÄÊòØÊóßÁâàÊú¨ÔºåÂ∑≤Ê∏ÖÈô§:', savedAddresses.rideOrder);
                        localStorage.removeItem('RIDE_ORDER_ADDRESS');
                        localStorage.removeItem('PAYMENT_ESCROW_ADDRESS');
                        localStorage.removeItem('RATING_SYSTEM_ADDRESS');
                        savedAddresses.rideOrder = null;
                    }
                    
                    if (savedAddresses.rideOrder) {
                        CONTRACT_ADDRESSES.rideOrder = savedAddresses.rideOrder;
                        CONTRACT_ADDRESSES.paymentEscrow = savedAddresses.paymentEscrow;
                        CONTRACT_ADDRESSES.ratingSystem = savedAddresses.ratingSystem;
                    }
                }
                
                // Â¶ÇÊûúÂ∑≤ÊúâÂêàÁ∫¶Âú∞ÂùÄÔºåÂàùÂßãÂåñÂêàÁ∫¶
                // Ê≥®ÊÑèÔºöÂ¶ÇÊûúÂú∞ÂùÄÂèëÁîüÂèòÂåñÔºå‰∏çËá™Âä®ÈáçÊñ∞ÂàùÂßãÂåñÔºåÈÅøÂÖçÊó†ÈôêÂæ™ÁéØ
                // Áî®Êà∑ÈúÄË¶ÅÊâãÂä®Âà∑Êñ∞È°µÈù¢‰ª•‰ΩøÁî®Êñ∞Âú∞ÂùÄ
                if (CONTRACT_ADDRESSES.rideOrder) {
                    if (addressChanged) {
                        console.warn('‚ö†Ô∏è ÂêàÁ∫¶Âú∞ÂùÄÂ∑≤ÂèòÂåñÔºå‰ΩÜ‰∏∫ÈÅøÂÖçÊó†ÈôêÂæ™ÁéØÔºå‰∏çËá™Âä®ÈáçÊñ∞ÂàùÂßãÂåñ');
                        console.warn('‚ö†Ô∏è ËØ∑ÊâãÂä®Âà∑Êñ∞È°µÈù¢‰ª•‰ΩøÁî®Êñ∞ÁöÑÂêàÁ∫¶Âú∞ÂùÄ');
                        // ‰∏çË∞ÉÁî® initializeContracts()ÔºåÈÅøÂÖçÂæ™ÁéØ
                    } else if (!window.contractsInitialized || !window.contracts?.rideOrder) {
                        // Âè™ÊúâÂú®Êú™ÂàùÂßãÂåñÊó∂ÊâçÂàùÂßãÂåñ
                        await initializeContracts();
                    } else {
                        console.log('‚úì ÂêàÁ∫¶Â∑≤ÂàùÂßãÂåñÔºåË∑≥ËøáÈáçÂ§çÂàùÂßãÂåñ');
                    }
                } else {
                    // Êèê‰æõÊõ¥ËØ¶ÁªÜÁöÑÊèêÁ§∫‰ø°ÊÅØ
                    const promptMessage = `Êú™ÊâæÂà∞ÂêàÁ∫¶Âú∞ÂùÄÈÖçÁΩÆ„ÄÇ

ËØ∑ÈÄâÊã©Ôºö
1. Â¶ÇÊûúÂ∑≤ÈÉ®ÁΩ≤ÂêàÁ∫¶ÔºåËØ∑ËæìÂÖ• TrustFlowRide ÂêàÁ∫¶Âú∞ÂùÄÔºà0xÂºÄÂ§¥Ôºå42‰∏™Â≠óÁ¨¶Ôºâ
   ‰æãÂ¶ÇÔºö0x1234567890123456789012345678901234567890

2. Â¶ÇÊûúËøòÊú™ÈÉ®ÁΩ≤ÔºåËØ∑ÂÖàËøêË°åÈÉ®ÁΩ≤ËÑöÊú¨Ôºö
   - Êú¨Âú∞ÁΩëÁªúÔºönpm run deploy:local
   - MumbaiÊµãËØïÁΩëÔºönpm run deploy:mumbai
   - Polygon‰∏ªÁΩëÔºönpm run deploy:polygon

ÈÉ®ÁΩ≤ÂÆåÊàêÂêéÔºå‰ºöÊòæÁ§∫ÂêàÁ∫¶Âú∞ÂùÄÔºåÂ§çÂà∂ "TrustFlowRide" ÁöÑÂú∞ÂùÄÂç≥ÂèØ„ÄÇ

ÂèñÊ∂àÊ≠§ÂØπËØùÊ°ÜÂêéÔºå‰πüÂèØ‰ª•Âú®ÊµèËßàÂô®ÊéßÂà∂Âè∞ÊâãÂä®ËÆæÁΩÆÔºö
localStorage.setItem('RIDE_ORDER_ADDRESS', '‰Ω†ÁöÑÂêàÁ∫¶Âú∞ÂùÄ')`;

                    const rideOrderAddr = prompt(promptMessage, '');
                    if (rideOrderAddr && rideOrderAddr.trim().length > 0) {
                        // È™åËØÅÂú∞ÂùÄÊ†ºÂºè
                        const addr = rideOrderAddr.trim();
                        if (addr.startsWith('0x') && addr.length === 42) {
                            CONTRACT_ADDRESSES.rideOrder = addr;
                            localStorage.setItem('RIDE_ORDER_ADDRESS', addr);
                        await initializeContracts();
                            
                            // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
                            const walletStatus = document.getElementById('wallet-status');
                            if (walletStatus) {
                                walletStatus.className = 'status success';
                                walletStatus.textContent = `ÂêàÁ∫¶Âú∞ÂùÄÂ∑≤ËÆæÁΩÆ: ${addr.substring(0, 10)}...${addr.substring(38)}`;
                            }
                        } else {
                            alert('‚ö†Ô∏è Âú∞ÂùÄÊ†ºÂºèÈîôËØØÔºÅ\n\nÊ≠£Á°ÆÁöÑ‰ª•Â§™ÂùäÂú∞ÂùÄÊ†ºÂºèÔºö\n- ÂøÖÈ°ª‰ª• 0x ÂºÄÂ§¥\n- ÊÄªÈïøÂ∫¶‰∏∫ 42 ‰∏™Â≠óÁ¨¶\n\nÁ§∫‰æãÔºö0x1234567890123456789012345678901234567890');
                        }
                    }
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂêàÁ∫¶Âú∞ÂùÄÂ§±Ë¥•:', error);
            }
        }
        
        // Êö¥Èú≤calculateFareÂà∞ÂÖ®Â±Ä
        window.calculateFare = async function calculateFare() {
            const btn = document.getElementById('calculate-btn');
            btn.disabled = true;
            btn.innerHTML = `<span class="loading"></span> ${i18n.t('calculating')}`;
            
            try {
                const pickupLat = parseFloat(document.getElementById('pickup-lat').value);
                const pickupLng = parseFloat(document.getElementById('pickup-lng').value);
                const destLat = parseFloat(document.getElementById('dest-lat').value);
                const destLng = parseFloat(document.getElementById('dest-lng').value);
                
                const distance = Math.sqrt(
                    Math.pow((destLat - pickupLat) * 111, 2) + 
                    Math.pow((destLng - pickupLng) * 111 * Math.cos(pickupLat * Math.PI / 180), 2)
                );
                
                // Ë¥πÁî®ËÆ°ÁÆóÔºö‰ΩøÁî® ETHÔºà18‰ΩçÂ∞èÊï∞Ôºâ
                const rate = window.ETH_TO_USD_RATE || 2500; // ‰ΩøÁî®ÂÖ®Â±ÄÂÆö‰πâÁöÑÊ±áÁéá
                const baseFareUSD = 12.50; // $12.50 Âü∫Á°ÄË¥πÁî®
                const perKmFareUSD = 2.50; // $2.50 ÊØèÂÖ¨Èáå
                const baseFareAmountUSD = baseFareUSD + (distance * perKmFareUSD);
                
                // Â∞Ü USD ËΩ¨Êç¢‰∏∫ ETH
                const baseFareETH = baseFareAmountUSD / rate;
                
                // ËÆ°ÁÆóÂπ≥Âè∞Ë¥πÔºà5%Ôºâ
                const PLATFORM_FEE_RATE = 0.05;
                const platformFeeUSD = baseFareAmountUSD * PLATFORM_FEE_RATE;
                const platformFeeETH = platformFeeUSD / rate;
                
                // ÊÄªËÆ¢ÂçïÈáëÈ¢ùÔºàETHÔºâ
                const estimatedFareETH = baseFareETH;
                
                // ‰øùÂ≠òË¥πÁî®‰ø°ÊÅØÂà∞ÂÖ®Â±ÄÂèòÈáè
                window.currentBaseFareETH = baseFareETH;
                window.currentBaseFareUSD = baseFareAmountUSD;
                window.currentPlatformFeeETH = platformFeeETH;
                window.currentPlatformFeeUSD = platformFeeUSD;
                
                document.getElementById('estimated-fare').value = estimatedFareETH.toFixed(8);
                document.getElementById('create-order-btn').style.display = 'block';
                
                // ÊòæÁ§∫Ë¥πÁî®ÊòéÁªÜ
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                const fareDetailsHtml = `
                    <div style="margin-top: 15px; padding: 15px; background: #f9fafb; border-radius: 8px; border-left: 4px solid var(--primary-color);">
                        <div style="font-weight: 600; margin-bottom: 10px; color: #1f2937;">${isZh ? 'Ë¥πÁî®ÊòéÁªÜ / Fee Details' : 'Fee Details'}</div>
                        <div style="font-size: 16px; margin-bottom: 8px;">
                            <strong>${isZh ? 'ËÆ¢ÂçïÈáëÈ¢ù' : 'Order Amount'}:</strong> 
                            <span style="color: var(--primary-color); font-weight: 700;">${baseFareETH.toFixed(8)} ETH</span>
                            <span style="color: #6b7280; font-size: 14px;">($${baseFareAmountUSD.toFixed(2)} USD)</span>
                        </div>
                        <div style="font-size: 14px; margin-top: 8px; color: #6b7280;">
                            ${isZh ? 'Âπ≥Âè∞Ë¥πÔºà5%Ôºâ' : 'Platform Fee (5%)'}: ${platformFeeETH.toFixed(8)} ETH ($${platformFeeUSD.toFixed(2)} USD)
                        </div>
                        <div style="font-size: 12px; color: #9ca3af; margin-top: 8px; padding: 8px; background: #f3f4f6; border-radius: 4px;">
                            <strong>${isZh ? 'üí° Ë¥πÁî®ËØ¥ÊòéÔºö' : 'üí° Fee Breakdown:'}</strong><br>
                            ${isZh 
                                ? '‚Ä¢ <strong>ËÆ¢ÂçïÈáëÈ¢ù</strong>ÔºöÂ∞ÜÈîÅÂÆöÂú®Êô∫ËÉΩÂêàÁ∫¶‰∏≠ÔºåÁî®‰∫éÊîØ‰ªòÁªôÂè∏Êú∫ÂíåÂπ≥Âè∞<br>‚Ä¢ <strong>Gas Ë¥πÁî®</strong>ÔºöÂàõÂª∫ËÆ¢ÂçïÊó∂ÁöÑÁΩëÁªú‰∫§ÊòìÊâãÁª≠Ë¥πÔºàÁ∫¶ $0.50-1.00ÔºâÔºåÈúÄÈ¢ùÂ§ñÊîØ‰ªò'
                                : '‚Ä¢ <strong>Order Amount</strong>: Locked in smart contract, paid to driver and platform<br>‚Ä¢ <strong>Gas Fee</strong>: Network transaction fee for creating order (~$0.50-1.00), paid separately'}
                        </div>
                    </div>
                `;
                
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊúâË¥πÁî®ÊòéÁªÜÊòæÁ§∫Âå∫Âüü
                let fareDetailsDiv = document.getElementById('fare-details');
                if (!fareDetailsDiv) {
                    fareDetailsDiv = document.createElement('div');
                    fareDetailsDiv.id = 'fare-details';
                    document.getElementById('estimated-fare').parentElement.appendChild(fareDetailsDiv);
                }
                fareDetailsDiv.innerHTML = fareDetailsHtml;
                
                document.getElementById('wallet-status').className = 'status success';
                document.getElementById('wallet-status').textContent = i18n.t('fareCalculated', {
                    distance: distance.toFixed(2),
                    fare: baseFareAmountUSD.toFixed(2)
                });
                
            } catch (error) {
                console.error('ËÆ°ÁÆóË¥πÁî®Â§±Ë¥•:', error);
                document.getElementById('wallet-status').className = 'status error';
                document.getElementById('wallet-status').textContent = i18n.t('orderCreateError') + ' ' + error.message;
            } finally {
                btn.disabled = false;
                btn.textContent = i18n.t('calculateFare');
            }
        }
        
        // Êö¥Èú≤createOrderÂà∞ÂÖ®Â±Ä
        window.createOrder = async function createOrder() {
            // Ê£ÄÊü•ÂêàÁ∫¶ÊòØÂê¶Â∑≤ÂàùÂßãÂåñ
            if (!window.contractsInitialized || !contracts.rideOrder) {
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                const message = isZh 
                    ? '‚ö†Ô∏è ÂêàÁ∫¶Êú™ÈÖçÁΩÆ\n\nË¶ÅÂàõÂª∫ÁúüÂÆûËÆ¢ÂçïÔºåËØ∑ÂÖàÔºö\n1. ÈÉ®ÁΩ≤ÂêàÁ∫¶Âà∞Âå∫ÂùóÈìæ\n2. ÈÖçÁΩÆÂêàÁ∫¶Âú∞ÂùÄ\n3. Âà∑Êñ∞È°µÈù¢\n\nËØ¶ËßÅÂºÄÂèëÊåáÂçó„ÄÇ'
                    : '‚ö†Ô∏è Contract Not Configured\n\nTo create real orders:\n1. Deploy contracts to blockchain\n2. Configure contract address\n3. Refresh the page\n\nSee development guide for details.';
                alert(message);
                return;
            }
            
            const btn = document.getElementById('create-order-btn');
            btn.disabled = true;
            btn.innerHTML = `<span class="loading"></span> ${i18n.t('creating')}`;
            
            try {
                // Âú®ÂáΩÊï∞ÂºÄÂßãÂ§ÑÂ£∞ÊòéÊ±áÁéáÔºå‰æõÊï¥‰∏™ÂáΩÊï∞‰ΩøÁî®
                const ethToUsdRate = window.ETH_TO_USD_RATE || 2500;
                
                const pickupLat = Math.round(parseFloat(document.getElementById('pickup-lat').value) * 1e6);
                const pickupLng = Math.round(parseFloat(document.getElementById('pickup-lng').value) * 1e6);
                const pickupAddress = document.getElementById('pickup-address').value;
                const destLat = Math.round(parseFloat(document.getElementById('dest-lat').value) * 1e6);
                const destLng = Math.round(parseFloat(document.getElementById('dest-lng').value) * 1e6);
                const destAddress = document.getElementById('dest-address').value;
                
                // ‰ªéË°®ÂçïËé∑ÂèñÈÄâÊã©ÁöÑ Catalog Âíå SubCatalog
                const categorySelect = document.getElementById('category-select');
                const subCategorySelect = document.getElementById('subcategory-select');
                const category = categorySelect ? categorySelect.value : 'rental';  // ÈªòËÆ§ÂÄºÔºörental
                const subCategory = subCategorySelect ? subCategorySelect.value : 'rental car';  // ÈªòËÆ§ÂÄºÔºörental car
                
                // Â¶ÇÊûúÊòØÁßüËΩ¶Á±ªÂûãÔºåËØªÂèñÊòµÁß∞ÂíåËÅîÁ≥ªÊñπÂºè
                let userNickname = '';
                let userContact = '';
                if (category === 'Vehicle Rental' || category === 'General') {
                    userNickname = localStorage.getItem('user_nickname') || '';
                    userContact = localStorage.getItem('user_contact') || '';
                    
                    // Â¶ÇÊûúÊú™ËÆæÁΩÆÔºåËá™Âä®ÁîüÊàêÊ®°ÊãüÁî®Êà∑‰ø°ÊÅØ
                    if (!userNickname || !userContact) {
                        const mockInfo = typeof window.generateMockUserInfo === 'function' 
                            ? window.generateMockUserInfo() 
                            : { nickname: 'User' + Math.floor(Math.random() * 1000), phone: '138' + String(Math.floor(Math.random() * 100000000)).padStart(8, '0') };
                        if (!userNickname) {
                            userNickname = mockInfo.nickname;
                            try {
                                localStorage.setItem('user_nickname', userNickname);
                            } catch (e) {
                                console.warn('Êó†Ê≥ï‰øùÂ≠òÁî®Êà∑ÊòµÁß∞Âà∞localStorage:', e);
                            }
                        }
                        if (!userContact) {
                            userContact = mockInfo.phone;
                            try {
                                localStorage.setItem('user_contact', userContact);
                            } catch (e) {
                                console.warn('Êó†Ê≥ï‰øùÂ≠òÁî®Êà∑ËÅîÁ≥ªÊñπÂºèÂà∞localStorage:', e);
                            }
                        }
                        console.log('‚úÖ Â∑≤Ëá™Âä®ÁîüÊàêÊ®°ÊãüÁî®Êà∑‰ø°ÊÅØ:', { nickname: userNickname, contact: userContact });
                    }
                }
                
                // Ëé∑ÂèñË¥πÁî®‰ø°ÊÅØÔºàETHÔºâ
                const estimatedFareETH = parseFloat(document.getElementById('estimated-fare').value);
                const baseFareETH = window.currentBaseFareETH || estimatedFareETH;
                const baseFareUSD = window.currentBaseFareUSD || (estimatedFareETH * 2500);
                
                // Â∞Ü ETH ËΩ¨Êç¢‰∏∫ WeiÔºà18‰ΩçÂ∞èÊï∞Ôºâ
                const estimatedFareWei = ethers.utils.parseEther(estimatedFareETH.toFixed(8));
                
                // Ê£ÄÊü• ETH ‰ΩôÈ¢ùÔºàÈúÄË¶ÅË∂≥Â§üÊîØ‰ªòËÆ¢ÂçïÈáëÈ¢ù + Gas Ë¥πÁî®Ôºâ
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                const ethBalance = await window.provider.getBalance(window.account);
                // ‰º∞ÁÆó Gas Ë¥πÁî®ÔºàÁ∫¶ 0.0003 ETHÔºâ
                const estimatedGasWei = ethers.utils.parseEther('0.0003');
                const totalNeededWei = estimatedFareWei.add(estimatedGasWei);
                if (ethBalance.lt(totalNeededWei)) {
                    throw new Error(isZh 
                        ? `ETH ‰ΩôÈ¢ù‰∏çË∂≥„ÄÇ\nÈúÄË¶ÅÊÄªÈ¢ù: ${ethers.utils.formatEther(totalNeededWei)} ETHÔºàËÆ¢Âçï: ${ethers.utils.formatEther(estimatedFareWei)} ETH + Gas: ~${ethers.utils.formatEther(estimatedGasWei)} ETHÔºâ\nÂΩìÂâç‰ΩôÈ¢ù: ${ethers.utils.formatEther(ethBalance)} ETH`
                        : `Insufficient ETH balance.\nTotal required: ${ethers.utils.formatEther(totalNeededWei)} ETH (Order: ${ethers.utils.formatEther(estimatedFareWei)} ETH + Gas: ~${ethers.utils.formatEther(estimatedGasWei)} ETH)\nCurrent balance: ${ethers.utils.formatEther(ethBalance)} ETH`);
                }
                
                // ‰øùÂ≠òÁî®‰∫éÂêéÁª≠ÊòæÁ§∫
                window.currentOrderFees = {
                    totalFareETH: estimatedFareETH,
                    baseFareETH: baseFareETH,
                    baseFareUSD: baseFareUSD,
                    platformFeeETH: window.currentPlatformFeeETH || (estimatedFareETH * 0.05),
                    platformFeeUSD: window.currentPlatformFeeUSD || (baseFareUSD * 0.05)
                };
                
                document.getElementById('wallet-status').className = 'status info';
                document.getElementById('wallet-status').textContent = i18n.t('submitting');
                
                // ÂàõÂª∫ TrustFlowRide ËÆ¢ÂçïÔºà‰ΩøÁî® ETHÔºâ
                // Ê≥®ÊÑèÔºöÁé∞Âú® createOrder ÊòØ payable ÂáΩÊï∞Ôºå‰ºöÁ´ãÂç≥ÈîÅÂÆöËÆ¢ÂçïÈáëÈ¢ù
                // MetaMask Â∞ÜÊòæÁ§∫ÔºöËÆ¢ÂçïÈáëÈ¢ù + Gas Ë¥πÁî® = ÊÄªË¥πÁî®
                const estimatedFareWeiForOrder = ethers.utils.parseEther(estimatedFareETH.toFixed(8));
                
                // Á°Æ‰øù value ÊòØ BigNumber Ê†ºÂºè
                console.log('üí∞ ËÆ¢ÂçïÈáëÈ¢ù:', {
                    ETH: estimatedFareETH,
                    Wei: estimatedFareWeiForOrder.toString(),
                    Hex: estimatedFareWeiForOrder.toHexString()
                });
                
                // ‰ΩøÁî® signer ÂèëÈÄÅ‰∫§ÊòìÔºåÁ°Æ‰øù value Ê≠£Á°Æ‰º†ÈÄí
                const txResponse = await contracts.rideOrder.connect(window.signer || signer).createOrder(
                    pickupLat,
                    pickupLng,
                    pickupAddress,
                    destLat,
                    destLng,
                    destAddress,
                    category,
                    subCategory,
                    estimatedFareWeiForOrder,  // È¢Ñ‰º∞Ë¥πÁî®ÔºàWeiÔºâ
                    { 
                        value: estimatedFareWeiForOrder,  // ÂèëÈÄÅ ETHÔºàËøôÊ†∑ MetaMask ‰ºöÊòæÁ§∫ÊÄªË¥πÁî®Ôºâ
                        gasLimit: 500000  // ËÆæÁΩÆ gas limit ‰ª•ÈÅøÂÖç‰º∞ÁÆóÈóÆÈ¢ò
                    }
                );
                
                console.log('üìù ‰∫§ÊòìÂ∑≤ÂèëÈÄÅ:', {
                    hash: txResponse.hash,
                    value: txResponse.value ? txResponse.value.toString() : 'N/A',
                    to: txResponse.to,
                    from: txResponse.from
                });
                
                document.getElementById('wallet-status').className = 'status info';
                document.getElementById('wallet-status').textContent = i18n.t('transactionSubmitted', {
                    hash: txResponse.hash.substring(0, 10)
                });
                
                // Âú®ÂàõÂª∫ËÆ¢Âçï‰πãÂâçÔºåÂÖàËé∑ÂèñÂΩìÂâçÁöÑËÆ¢ÂçïÊï∞Èáè
                let previousOrderCount = 0;
                try {
                    previousOrderCount = await contracts.rideOrder.orderCount();
                    previousOrderCount = previousOrderCount.toNumber ? previousOrderCount.toNumber() : parseInt(previousOrderCount);
                    console.log('üìä ÂàõÂª∫ËÆ¢ÂçïÂâçÁöÑËÆ¢ÂçïÊï∞Èáè:', previousOrderCount);
                } catch (e) {
                    console.warn('‚ö†Ô∏è Êó†Ê≥ïËé∑ÂèñËÆ¢ÂçïÊï∞ÈáèÔºåÂ∞Ü‰ΩøÁî®ÂÖ∂‰ªñÊñπÊ≥ï:', e);
                }
                
                // Á≠âÂæÖ‰∫§ÊòìÁ°ÆËÆ§
                const receipt = await txResponse.wait();
                
                // ËÆ°ÁÆóÂÆûÈôÖgasË¥πÁî®Ôºà‰ªçÁÑ∂‰ΩøÁî® ETHÔºåÂõ†‰∏∫ gas Ë¥πÁî®ÊòØÁî®ÂéüÁîüÂ∏ÅÊîØ‰ªòÁöÑÔºâ
                const gasUsed = receipt.gasUsed;
                const gasPrice = txResponse.gasPrice || receipt.effectiveGasPrice || await provider.getGasPrice();
                const gasCostWei = gasUsed.mul(gasPrice);
                const gasCostETH = ethers.utils.formatEther(gasCostWei);
                const gasCostUSD = (parseFloat(gasCostETH) * ethToUsdRate).toFixed(2);
                
                // Ê£ÄÊü•‰∫§ÊòìÁä∂ÊÄÅ
                if (receipt.status === 0) {
                    throw new Error('‰∫§ÊòìÂ§±Ë¥•Ôºö‰∫§ÊòìË¢´ revert„ÄÇËØ∑Ê£ÄÊü•ÂêàÁ∫¶Áä∂ÊÄÅÂíåÂèÇÊï∞ÊòØÂê¶Ê≠£Á°Æ„ÄÇ');
                }
                
                console.log('üìã ‰∫§ÊòìÁ°ÆËÆ§ÔºåÂºÄÂßãËß£ÊûêËÆ¢ÂçïID...');
                console.log('  - ‰∫§ÊòìÂìàÂ∏å:', receipt.transactionHash);
                console.log('  - ‰∫§ÊòìÁä∂ÊÄÅ:', receipt.status === 1 ? 'ÊàêÂäü' : 'Â§±Ë¥•');
                console.log('  - Êó•ÂøóÊï∞Èáè:', receipt.logs ? receipt.logs.length : 0);
                console.log('  - ‰∫ã‰ª∂Êï∞Èáè:', receipt.events ? receipt.events.length : 0);
                
                // Ëé∑ÂèñËÆ¢ÂçïID
                let orderId = null;
                
                // ÊñπÊ≥ï1: ‰ªé logs Ëß£Êûê‰∫ã‰ª∂ÔºàÊúÄÂèØÈù†ÁöÑÊñπÊ≥ïÔºâ
                if (receipt.logs && receipt.logs.length > 0) {
                    console.log('üîç ÊñπÊ≥ï1: Â∞ùËØï‰ªé logs Ëß£Êûê‰∫ã‰ª∂...');
                    const contractInterface = contracts.rideOrder.interface;
                    const contractAddress = contracts.rideOrder.address.toLowerCase();
                    
                    for (let i = 0; i < receipt.logs.length; i++) {
                        const log = receipt.logs[i];
                        try {
                            // Ê£ÄÊü•Êó•ÂøóÊòØÂê¶Êù•Ëá™Êàë‰ª¨ÁöÑÂêàÁ∫¶
                            if (log.address && log.address.toLowerCase() !== contractAddress) {
                                continue; // Ë∑≥Ëøá‰∏çÊòØÊù•Ëá™Êàë‰ª¨ÂêàÁ∫¶ÁöÑÊó•Âøó
                            }
                            
                            const parsedLog = contractInterface.parseLog(log);
                            if (parsedLog && parsedLog.name === 'OrderCreated') {
                                orderId = parsedLog.args.orderId.toNumber();
                                console.log('‚úÖ ÊñπÊ≥ï1ÊàêÂäü: ‰ªé‰∫ã‰ª∂Êó•Âøó‰∏≠Ëß£ÊûêÂà∞ËÆ¢ÂçïID:', orderId);
                                break;
                            }
                        } catch (e) {
                            // ‰∏çÊòØËøô‰∏™‰∫ã‰ª∂ÊàñËß£ÊûêÂ§±Ë¥•ÔºåÁªßÁª≠Â∞ùËØï‰∏ã‰∏Ä‰∏™Êó•Âøó
                            continue;
                        }
                    }
                }
                
                // ÊñπÊ≥ï2: Â∞ùËØï‰ªé receipt.events Ëß£ÊûêÔºàÂÖºÂÆπÊóßÁâà ethersÔºâ
                if ((orderId === null || orderId === undefined) && receipt.events && receipt.events.length > 0) {
                    console.log('üîç ÊñπÊ≥ï2: Â∞ùËØï‰ªé receipt.events Ëß£Êûê...');
                    const orderCreatedEvent = receipt.events.find(e => 
                        e.event === 'OrderCreated' || 
                        (e.eventSignature && e.eventSignature.includes('OrderCreated')) ||
                        (e.name === 'OrderCreated')
                    );
                    if (orderCreatedEvent && orderCreatedEvent.args) {
                        orderId = orderCreatedEvent.args.orderId.toNumber ? 
                                  orderCreatedEvent.args.orderId.toNumber() : 
                                  parseInt(orderCreatedEvent.args.orderId);
                        console.log('‚úÖ ÊñπÊ≥ï2ÊàêÂäü: ‰ªé receipt.events ‰∏≠Ëß£ÊûêÂà∞ËÆ¢ÂçïID:', orderId);
                    }
                }
                
                // ÊñπÊ≥ï3: Â¶ÇÊûú‰∫ã‰ª∂Ëß£ÊûêÂ§±Ë¥•ÔºåÂ∞ùËØï‰ΩøÁî® getPassengerOrders Ëé∑ÂèñÊúÄÊñ∞ËÆ¢Âçï
                if (orderId === null || orderId === undefined) {
                    console.warn('‚ö†Ô∏è ÊñπÊ≥ï3: Êó†Ê≥ï‰ªé‰∫§ÊòìÊî∂ÊçÆ‰∏≠Ëß£ÊûêËÆ¢ÂçïIDÔºåÂ∞ùËØïÈÄöËøá getPassengerOrders Ëé∑ÂèñÊúÄÊñ∞ËÆ¢Âçï...');
                    try {
                        // Á≠âÂæÖ‰∏ÄÂ∞èÊÆµÊó∂Èó¥ÔºåÁ°Æ‰øùËÆ¢ÂçïÂ∑≤ÂàõÂª∫Âπ∂ÂÜôÂÖ•Âå∫ÂùóÈìæ
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        // Ëé∑ÂèñÂΩìÂâçËÆ¢ÂçïÂàóË°®
                        const passengerOrders = await contracts.rideOrder.getPassengerOrders(window.account);
                        
                        if (passengerOrders && passengerOrders.length > 0) {
                            // Â∞ÜËÆ¢ÂçïIDËΩ¨Êç¢‰∏∫Êï∞Â≠óÂπ∂ÊâæÂà∞ÊúÄÂ§ßÂÄºÔºàÊúÄÊñ∞ÁöÑËÆ¢ÂçïÔºâ
                            const orderIds = passengerOrders.map(id => {
                                if (typeof id === 'object' && id.toNumber) {
                                    return id.toNumber();
                                } else if (typeof id === 'string') {
                                    return parseInt(id);
                                } else {
                                    return id;
                                }
                            });
                            
                            // Ëé∑ÂèñÊúÄÂ§ßÁöÑËÆ¢ÂçïIDÔºàÂÅáËÆæËÆ¢ÂçïIDÊòØÈÄíÂ¢ûÁöÑÔºâ
                            orderId = Math.max(...orderIds);
                            console.log('‚úÖ ÊñπÊ≥ï3ÊàêÂäü: ‰ªé getPassengerOrders ‰∏≠Ëé∑ÂèñÂà∞ÊúÄÊñ∞ËÆ¢ÂçïID:', orderId);
                            console.log('  - ÊâÄÊúâËÆ¢ÂçïID:', orderIds);
                        } else {
                            console.warn('‚ö†Ô∏è ‰πòÂÆ¢ËÆ¢ÂçïÂàóË°®‰∏∫Á©∫');
                        }
                    } catch (e) {
                        console.error('‚ùå ÊñπÊ≥ï3Â§±Ë¥•: Ëé∑Âèñ‰πòÂÆ¢ËÆ¢ÂçïÂàóË°®Â§±Ë¥•:', e);
                    }
                }
                
                // ÊúÄÁªàÈ™åËØÅ
                if (orderId === null || orderId === undefined) {
                    const errorMsg = `Êó†Ê≥ï‰ªé‰∫§Êòì‰∏≠Ëé∑ÂèñËÆ¢ÂçïID„ÄÇ\n\n` +
                        `‰∫§ÊòìÂìàÂ∏å: ${receipt.transactionHash}\n` +
                        `Êó•ÂøóÊï∞Èáè: ${receipt.logs ? receipt.logs.length : 0}\n` +
                        `‰∫ã‰ª∂Êï∞Èáè: ${receipt.events ? receipt.events.length : 0}\n\n` +
                        `ËØ∑Ê£ÄÊü•‰∫§ÊòìÊòØÂê¶ÊàêÂäüÔºåÊàñÊâãÂä®Êü•ÁúãËÆ¢ÂçïÂàóË°®„ÄÇ`;
                    throw new Error(errorMsg);
                }
                
                console.log('‚úÖ ÊúÄÁªàÁ°ÆÂÆöÁöÑËÆ¢ÂçïID:', orderId);
                
                // ÂêåÊ≠•ËÆ¢ÂçïIDÂà∞ÂêéÁ´ØÈÖçÁΩÆ
                try {
                    const apiBaseUrl = window.API_BASE_URL || 'http://localhost:3000';
                    const syncResponse = await fetch(`${apiBaseUrl}/api/orders/sync/${orderId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (syncResponse.ok) {
                        const syncData = await syncResponse.json();
                        console.log('‚úÖ ËÆ¢ÂçïIDÂ∑≤ÂêåÊ≠•Âà∞ÂêéÁ´ØÈÖçÁΩÆ:', syncData.data);
                    } else {
                        console.warn('‚ö†Ô∏è ÂêåÊ≠•ËÆ¢ÂçïIDÂ§±Ë¥•Ôºå‰ΩÜ‰∏çÂΩ±ÂìçËÆ¢ÂçïÂàõÂª∫:', await syncResponse.text());
                    }
                } catch (syncError) {
                    // ÂêåÊ≠•Â§±Ë¥•‰∏çÂΩ±ÂìçËÆ¢ÂçïÂàõÂª∫ÔºåÂè™ËÆ∞ÂΩïË≠¶Âëä
                    console.warn('‚ö†Ô∏è ÂêåÊ≠•ËÆ¢ÂçïIDÂà∞ÂêéÁ´ØÂ§±Ë¥•ÔºàÂèØËÉΩÊòØÂêéÁ´ØÊú™ËøêË°åÔºâ:', syncError);
                }
                
                // ‰ªéÂêéÁ´ØAPIËé∑ÂèñËÆ¢Âçï‰ø°ÊÅØÔºàÊõø‰ª£Áõ¥Êé•Èìæ‰∏äÊü•ËØ¢Ôºâ
                // Ê≥®ÊÑèÔºöÂàöÂàõÂª∫ÁöÑËÆ¢ÂçïÂèØËÉΩÈúÄË¶ÅÁ≠âÂæÖÂêéÁ´ØÂêåÊ≠•ÔºåÊâÄ‰ª•ÂÖàÂ∞ùËØïAPIÔºåÂ§±Ë¥•ÂàôÂõûÈÄÄÂà∞Èìæ‰∏äÊü•ËØ¢
                let order;
                try {
                    order = await getOrderFromAPI(orderId);
                } catch (apiError) {
                    console.warn('‚ö†Ô∏è APIËé∑ÂèñËÆ¢ÂçïÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞Èìæ‰∏äÊü•ËØ¢:', apiError);
                    // Â¶ÇÊûúAPIÂ§±Ë¥•ÔºàÂèØËÉΩÊòØËÆ¢ÂçïÂàöÂàõÂª∫ÔºåÂêéÁ´ØËøòÊú™ÂêåÊ≠•ÔºâÔºåÂõûÈÄÄÂà∞Èìæ‰∏äÊü•ËØ¢
                    order = await contracts.rideOrder.getOrder(orderId);
                }
                
                // ËÆ°ÁÆóË¥πÁî®ÊòéÁªÜÔºàETH ‰ΩøÁî® 18 ‰ΩçÂ∞èÊï∞Ôºâ
                const PLATFORM_FEE_RATE = 0.05;
                // Â§ÑÁêÜ estimatedFareÔºöÂèØËÉΩÊòØÂ≠óÁ¨¶‰∏≤ÔºàÊù•Ëá™APIÔºâÊàñ BigNumberÔºàÊù•Ëá™Èìæ‰∏äÊü•ËØ¢Ôºâ
                let estimatedFareStr;
                if (typeof order.estimatedFare === 'string') {
                    // Â¶ÇÊûúÂ∑≤ÁªèÊòØÂ≠óÁ¨¶‰∏≤ÔºåÁõ¥Êé•‰ΩøÁî®
                    estimatedFareStr = parseFloat(order.estimatedFare).toFixed(8);
                } else if (order.estimatedFare && (order.estimatedFare._hex || order.estimatedFare.toString)) {
                    // Â¶ÇÊûúÊòØ BigNumberÔºå‰ΩøÁî® formatEther ËΩ¨Êç¢
                    estimatedFareStr = parseFloat(ethers.utils.formatEther(order.estimatedFare)).toFixed(8);
                } else {
                    // ÈªòËÆ§ÂÄº
                    estimatedFareStr = '0.00000000';
                }
                const totalOrderFareETH = estimatedFareStr;
                const totalOrderFareUSD = (parseFloat(totalOrderFareETH) * ethToUsdRate).toFixed(2);
                
                // ‰ªé‰øùÂ≠òÁöÑË¥πÁî®‰ø°ÊÅØ‰∏≠Ëé∑ÂèñÂü∫Á°ÄÈáëÈ¢ùÂíåÂπ≥Âè∞Ë¥π
                const fees = window.currentOrderFees || {};
                const orderBaseFareETH = fees.baseFareETH || parseFloat(totalOrderFareETH);
                const orderBaseFareUSD = fees.baseFareUSD || (orderBaseFareETH * ethToUsdRate);
                const platformFeeETH = fees.platformFeeETH || (orderBaseFareETH * PLATFORM_FEE_RATE);
                const platformFeeUSD = fees.platformFeeUSD || (orderBaseFareUSD * PLATFORM_FEE_RATE);
                
                // ‰º†ÈÄíÊòµÁß∞„ÄÅËÅîÁ≥ªÊñπÂºè‰ø°ÊÅØÂíåË¥πÁî®ÊòéÁªÜ
                showOrderInfo(orderId, order, receipt.transactionHash, userNickname, userContact, {
                    totalOrderFareETH,
                    totalOrderFareUSD,
                    baseFareETH: orderBaseFareETH.toFixed(8),
                    baseFareUSD: orderBaseFareUSD.toFixed(2),
                    platformFeeETH: platformFeeETH.toFixed(8),
                    platformFeeUSD: platformFeeUSD.toFixed(2),
                    gasCostETH,
                    gasCostUSD
                });
                
                document.getElementById('wallet-status').className = 'status success';
                document.getElementById('wallet-status').textContent = i18n.t('orderCreated', {
                    orderId: orderId
                });
                
                // Á´ãÂç≥Â∞ÜÊñ∞ËÆ¢ÂçïÊ∑ªÂä†Âà∞Êú¨Âú∞ËÆ¢ÂçïÂàóË°®Ôºà‰ΩøÁî®‰∫§ÊòìÁ°ÆËÆ§ÂêéÁöÑËÆ¢ÂçïÊï∞ÊçÆÔºâ
                // Â§ÑÁêÜ orderIdÔºöÂèØËÉΩÊòØÊï∞Â≠óÊàñ BigNumber
                const orderIdNum = typeof order.orderId === 'number' ? order.orderId : 
                                  (order.orderId?.toNumber ? order.orderId.toNumber() : parseInt(order.orderId));
                // Â§ÑÁêÜÂùêÊ†áÔºöÂèØËÉΩÊòØÊï∞Â≠óÊàñ BigNumber
                const getCoord = (coord) => {
                    if (typeof coord === 'number') return coord / 1e6;
                    if (coord?.toNumber) return coord.toNumber() / 1e6;
                    return parseFloat(coord) / 1e6 || 0;
                };
                // Â§ÑÁêÜÊó∂Èó¥Êà≥ÔºöÂèØËÉΩÊòØÊï∞Â≠ó„ÄÅBigNumber Êàñ Date ÂØπË±°
                const getTimestamp = (timestamp) => {
                    if (!timestamp) return null;
                    if (timestamp instanceof Date) return timestamp;
                    if (typeof timestamp === 'number') {
                        // Â¶ÇÊûúÊï∞Â≠óÂæàÂ§ßÔºàÂèØËÉΩÊòØÊØ´ÁßíÔºâÔºåÂê¶ÂàôÊòØÁßí
                        return timestamp > 1e12 ? new Date(timestamp) : new Date(timestamp * 1000);
                    }
                    if (timestamp.toNumber && typeof timestamp.toNumber === 'function') {
                        return new Date(timestamp.toNumber() * 1000);
                    }
                    if (typeof timestamp === 'string') {
                        const num = parseInt(timestamp);
                        return isNaN(num) ? null : (num > 1e12 ? new Date(num) : new Date(num * 1000));
                    }
                    return null;
                };
                const newOrder = {
                    orderId: orderIdNum,
                    passenger: order.passenger,
                    driver: order.driver,
                    pickup: {
                        address: order.pickup?.addressText || order.pickup?.address || '',
                        lat: getCoord(order.pickup?.latitude),
                        lng: getCoord(order.pickup?.longitude)
                    },
                    destination: {
                        address: order.destination?.addressText || order.destination?.address || '',
                        lat: getCoord(order.destination?.latitude),
                        lng: getCoord(order.destination?.longitude)
                    },
                    category: order.category || '',
                    subCategory: order.subCategory || '',
                    estimatedFare: typeof order.estimatedFare === 'string' ? order.estimatedFare : 
                                   (order.estimatedFare && (order.estimatedFare._hex || order.estimatedFare.toString) ? 
                                    ethers.utils.formatEther(order.estimatedFare) : '0'), // ETH 18‰ΩçÂ∞èÊï∞
                    actualFare: typeof order.actualFare === 'string' ? order.actualFare : 
                               (order.actualFare && (order.actualFare._hex || order.actualFare.toString) ? 
                                ethers.utils.formatEther(order.actualFare) : '0'), // ETH 18‰ΩçÂ∞èÊï∞
                    status: (() => {
                        // Á°Æ‰øù status Ë¢´Ê≠£Á°ÆËß£Êûê‰∏∫Êï∞Â≠ó
                        let s = order.status;
                        if (typeof s === 'number') {
                            return s;
                        } else if (s && typeof s.toNumber === 'function') {
                            return s.toNumber();
                        } else if (typeof s === 'string') {
                            return parseInt(s) || 0;
                        } else {
                            return parseInt(s) || 0;
                        }
                    })(),
                    createdAt: getTimestamp(order.createdAt) || new Date(),
                    acceptedAt: getTimestamp(order.acceptedAt),
                    completedAt: getTimestamp(order.completedAt),
                    pickedUpAt: getTimestamp(order.pickedUpAt),
                    startTimestamp: getTimestamp(order.startTimestamp),
                    endTimestamp: getTimestamp(order.endTimestamp)
                };
                
                // ÂàùÂßãÂåñ allOrders Êï∞ÁªÑÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
                if (!window.allOrders) {
                    window.allOrders = [];
                }
                
                // Ê£ÄÊü•ËÆ¢ÂçïÊòØÂê¶Â∑≤Â≠òÂú®ÔºàÈÅøÂÖçÈáçÂ§çÊ∑ªÂä†Ôºâ
                const existingIndex = window.allOrders.findIndex(o => o.orderId === newOrder.orderId);
                if (existingIndex === -1) {
                    // Ê∑ªÂä†Âà∞Êï∞ÁªÑÂºÄÂ§¥ÔºàÊúÄÊñ∞ÁöÑËÆ¢ÂçïÂú®ÂâçÔºâ
                    window.allOrders.unshift(newOrder);
                    // ÊåâÂàõÂª∫Êó∂Èó¥ÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
                    window.allOrders.sort((a, b) => b.createdAt - a.createdAt);
                } else {
                    // Â¶ÇÊûúÂ∑≤Â≠òÂú®ÔºåÊõ¥Êñ∞ÂÆÉ
                    window.allOrders[existingIndex] = newOrder;
                    window.allOrders.sort((a, b) => b.createdAt - a.createdAt);
                }
                
                // ÂàõÂª∫ËÆ¢ÂçïÊàêÂäüÂêéÔºåËá™Âä®ÂàáÊç¢Âà∞ Orders ËßÜÂõæÂπ∂ÊòæÁ§∫ Pending Ê†áÁ≠æ
                setTimeout(() => {
                    // ÂÖàÂàáÊç¢Âà∞ Orders ËßÜÂõæÔºàËøô‰ºöÊòæÁ§∫ËßÜÂõæÂπ∂Ë∞ÉÁî® loadOrdersÔºâ
                    showOrdersView();
                    
                    // Á≠âÂæÖËßÜÂõæÂÆåÂÖ®ÊòæÁ§∫ÂêéÔºåÊøÄÊ¥ª Pending Ê†áÁ≠æ
                    setTimeout(() => {
                        // ÂÜçÊ¨°Á°Æ‰øùËÆ¢ÂçïÂàóË°®Â∑≤Âä†ËΩΩÔºà‰ΩøÁî®Êñ∞ÂàõÂª∫ÁöÑËÆ¢ÂçïÊï∞ÊçÆÔºâ
                        if (window.loadOrders) {
                            window.loadOrders().catch(err => {
                                console.warn('Failed to reload orders:', err);
                            });
                        }
                        
                        // ÊøÄÊ¥ª Pending Ê†áÁ≠æ
                        const pendingTab = document.querySelector('.filter-tab[onclick*="pending"]');
                        if (pendingTab) {
                            pendingTab.click();
                        }
                    }, 300);
                }, 500);
                
            } catch (error) {
                console.error('ÂàõÂª∫ËÆ¢ÂçïÂ§±Ë¥•:', error);
                document.getElementById('wallet-status').className = 'status error';
                document.getElementById('wallet-status').textContent = i18n.t('orderCreateError') + ' ' + (error.message || error.reason || 'Unknown error');
            } finally {
                btn.disabled = false;
                btn.textContent = i18n.t('createOrder');
            }
        }
        
        // ÊòæÁ§∫ËÆ¢Âçï‰ø°ÊÅØ
        function showOrderInfo(orderId, order, txHash, userNickname = '', userContact = '', feeDetails = {}, targetElement = null, driverInfo = null) {
            const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
            
            // ËæÖÂä©ÂáΩÊï∞ÔºöÂ∞ÜÊó∂Èó¥Êà≥ËΩ¨Êç¢‰∏∫ Date ÂØπË±°
            const getTimestamp = (timestamp) => {
                if (!timestamp) return null;
                if (timestamp instanceof Date) return timestamp;
                if (typeof timestamp === 'number') return new Date(timestamp * 1000);
                if (timestamp.toNumber && typeof timestamp.toNumber === 'function') {
                    return new Date(timestamp.toNumber() * 1000);
                }
                if (typeof timestamp === 'string') {
                    const num = parseInt(timestamp);
                    return isNaN(num) ? null : new Date(num * 1000);
                }
                return null;
            };
            
            // Ëé∑ÂèñÂàõÂª∫Êó∂Èó¥
            const createdAt = getTimestamp(order.createdAt);
            const statusNames = [
                i18n.t('statusPending'),
                i18n.t('statusAccepted'),
                i18n.t('statusPickedUp'),
                i18n.t('statusCompleted'),
                i18n.t('statusCancelled')
            ];
            
            const statusBadges = ['pending', 'accepted', 'picked-up', 'completed', 'cancelled'];
            
            // Á°Æ‰øùÁä∂ÊÄÅÊòØÊï∞Â≠óÁ±ªÂûãÔºà‰∏érenderOrdersÂáΩÊï∞‰øùÊåÅ‰∏ÄËá¥Ôºâ
            let orderStatus = order.status;
            if (typeof orderStatus === 'number') {
                orderStatus = orderStatus;
            } else if (orderStatus && typeof orderStatus.toNumber === 'function') {
                // BigNumber Á±ªÂûã
                orderStatus = orderStatus.toNumber();
            } else if (typeof orderStatus === 'string') {
                orderStatus = parseInt(orderStatus) || 0;
            } else {
                orderStatus = parseInt(orderStatus) || 0;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶Êúâ‰∫âËÆÆ
            const hasDispute = order.disputeOpened || false;
            let statusName = statusNames[orderStatus] || 'Unknown';
            let badgeClass = statusBadges[orderStatus] || 'pending';
            
            // Â¶ÇÊûúËÆ¢ÂçïÂ∑≤ÂÆåÊàê‰∏îÊúâ‰∫âËÆÆÔºåÊòæÁ§∫ Completed/Disputed
            if (orderStatus === 3 && hasDispute) {
                statusName = isZh ? 'Â∑≤ÂÆåÊàê/‰∫âËÆÆ‰∏≠' : 'Completed/Disputed';
                badgeClass = 'disputed';
            }
            
            const status = statusName;
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÁßüËΩ¶Á±ªÂûã
            const isVehicleRental = order.category === 'Vehicle Rental' || order.category === 'General';
            
            // Âè∏Êú∫‰ø°ÊÅØÔºàÂΩìËÆ¢ÂçïË¢´Êé•ÂèóÂêéÊòæÁ§∫Ôºâ
            let driverInfoHtml = '';
            if (order.driver && order.driver !== ethers.constants.AddressZero) {
                const driverNickname = driverInfo?.nickname || '';
                // Â∞ùËØï‰ªéÂêéÁ´ØËé∑ÂèñdriverÁöÑcontactÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®ÈªòËÆ§ÂÄº
                // Ê≥®ÊÑèÔºöÁõÆÂâçuserid.jsonÂè™Â≠òÂÇ®nicknameÂíåidÔºåcontact‰ø°ÊÅØÊöÇÊó∂‰ΩøÁî®demoÊï∞ÊçÆ
                const driverContact = driverInfo?.contact || '13800000000'; // DemoÈªòËÆ§ËÅîÁ≥ªÊñπÂºè
                // DemoÈªòËÆ§ËΩ¶Âûã‰ø°ÊÅØ
                const vehicleModel = 'Ford Explorer';
                const vehicleColor = isZh ? 'ÁôΩËâ≤' : 'White';
                const vehiclePlate = 'NY0001';
                
                driverInfoHtml = `
                    <div class="driver-info-container" style="margin-top: 0; padding-top: 0; border-top: none;">
                        <div class="info-row" style="border-bottom: none; flex-direction: column; align-items: flex-start; padding-bottom: 0; margin-top: var(--spacing-md);">
                            <span class="info-label" style="font-size: 16px; font-weight: 700; color: #1f2937; margin-bottom: 0; width: 100%;">${isZh ? 'Êé•ÂçïËÄÖ‰ø°ÊÅØ / Driver Info' : 'Driver Info'}</span>
                        </div>
                        ${driverNickname ? `
                        <div class="info-row">
                            <span class="info-label">${i18n.t('nickname') || 'Name'}</span>
                            <span class="info-value">${driverNickname}</span>
                        </div>
                        ` : ''}
                        ${driverContact ? `
                        <div class="info-row">
                            <span class="info-label">${i18n.t('contactMethod') || 'Contact'}</span>
                            <span class="info-value">${driverContact}</span>
                        </div>
                        ` : ''}
                        <div class="info-row">
                            <span class="info-label">${isZh ? 'ËΩ¶Âûã / Vehicle Model' : 'Vehicle Model'}</span>
                            <span class="info-value">${vehicleModel}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">${isZh ? 'È¢úËâ≤ / Color' : 'Color'}</span>
                            <span class="info-value">${vehicleColor}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">${isZh ? 'ËΩ¶Áâå / License Plate' : 'License Plate'}</span>
                            <span class="info-value">${vehiclePlate}</span>
                        </div>
                    </div>
                `;
            }
            
            // ÁîüÊàêÂîØ‰∏ÄÁöÑÂÖ≥Èó≠ÊåâÈíÆ ID
            const closeBtnId = `close-order-info-${orderId}`;
            const targetElementId = targetElement ? targetElement.id : 'order-info';
            
            const orderInfoHtml = `
                <div class="order-info fade-in">
                    <div class="order-info-header">
                        <h3>${i18n.t('orderDetails')}</h3>
                        <button class="order-info-close-btn" id="${closeBtnId}" onclick="closeOrderModal()" title="${isZh ? 'ÂÖ≥Èó≠' : 'Close'}">√ó</button>
                    </div>
                    <div class="order-info-content">
                    <div class="info-row">
                        <span class="info-label">${i18n.t('orderId')}</span>
                        <span class="info-value">${orderId}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">${i18n.t('status')}</span>
                        <span class="info-value"><span class="badge ${badgeClass}">${status}</span></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">${i18n.t('pickupLocation')}</span>
                        <span class="info-value">${order.pickup.addressText}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">${i18n.t('destination')}</span>
                        <span class="info-value">${order.destination.addressText}</span>
                    </div>
                    ${driverInfoHtml}
                    <div class="info-row">
                        <span class="info-label">${i18n.t('category')}</span>
                        <span class="info-value">${order.category || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">${i18n.t('subCategory')}</span>
                        <span class="info-value">${order.subCategory || 'N/A'}</span>
                    </div>
                    <!-- Ë¥πÁî®ÊòéÁªÜ - ÂèØÊäòÂè†Âç°Áâá -->
                    <div class="collapsible-card" style="margin-top: 20px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; overflow: hidden;">
                        <div class="collapsible-header" onclick="toggleCollapsible('fee-details-${orderId}')" style="padding: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;">
                            <h4 style="margin: 0; color: #1f2937; font-size: 16px; font-weight: 700;">${i18n.t('feeDetails') || 'Ë¥πÁî®ÊòéÁªÜ / Fee Details'}</h4>
                            <span class="collapsible-icon" id="fee-details-icon-${orderId}" style="font-size: 18px; color: #6b7280; transition: transform 0.3s;">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="fee-details-${orderId}" style="display: none; padding: 0 16px 16px 16px;">
                            <div class="info-row" style="margin-top: 12px;">
                                <span class="info-label">${i18n.t('totalOrderAmount') || 'ËÆ¢ÂçïÈáëÈ¢ù'}:</span>
                                <span class="info-value" style="font-weight: 700; color: var(--primary-color);">
                                    ${feeDetails.totalOrderFareETH || (order.estimatedFare ? 
                                        (typeof order.estimatedFare === 'string' ? parseFloat(order.estimatedFare).toFixed(8) : 
                                         (order.estimatedFare && (order.estimatedFare._hex || order.estimatedFare.toString) ? 
                                          parseFloat(ethers.utils.formatEther(order.estimatedFare)).toFixed(8) : '0.00000000')) : 
                                        '0.00000000')} ETH
                                    <span style="color: #6b7280; font-size: 14px; font-weight: normal; margin-left: 8px;">
                                        ($${feeDetails.totalOrderFareUSD || (feeDetails.totalOrderFareETH ? (parseFloat(feeDetails.totalOrderFareETH) * (window.ETH_TO_USD_RATE || 2500)).toFixed(2) : '0.00')} USD)
                                    </span>
                                </span>
                            </div>
                            ${feeDetails.platformFeeETH ? `
                            <div class="info-row" style="font-size: 14px; margin-top: 8px;">
                                <span class="info-label" style="color: #6b7280;">${i18n.t('platformFee') || 'Âπ≥Âè∞Ë¥πÔºà5%Ôºâ'}:</span>
                                <span class="info-value" style="color: #6b7280;">${feeDetails.platformFeeETH} ETH ($${feeDetails.platformFeeUSD} USD)</span>
                            </div>
                            ` : ''}
                            ${feeDetails.gasCostETH ? `
                            <div class="info-row" style="font-size: 14px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                                <span class="info-label">${i18n.t('actualGasFee') || 'Gas Ë¥πÁî®'}:</span>
                                <span class="info-value">
                                    ${parseFloat(feeDetails.gasCostETH) < 0.0001 ? '< 0.0001' : parseFloat(feeDetails.gasCostETH).toFixed(8)} ETH 
                                    <span style="color: #6b7280; font-size: 14px;">($${feeDetails.gasCostUSD} USD)</span>
                                </span>
                            </div>
                            <div style="font-size: 11px; color: #9ca3af; margin-top: 6px; font-style: italic;">
                                ${isZh ? 'Ê≠§Ë¥πÁî®Áî®‰∫éÊâßË°åÂå∫ÂùóÈìæ‰∫§ÊòìÔºå‰∏ç‰ºöËøõÂÖ•ËÆ¢ÂçïÈáëÈ¢ù' : 'This fee is for executing the blockchain transaction, not included in order amount'}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- ËµÑÈáëÊµÅÂêëÂèØËßÜÂåñ - ÂèØÊäòÂè†Âç°Áâá -->
                    <div class="collapsible-card" style="margin-top: 20px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; overflow: hidden;">
                        <div class="collapsible-header" onclick="toggleCollapsible('fund-flow-${orderId}')" style="padding: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;">
                            <h4 style="margin: 0; color: #1f2937; font-size: 16px; font-weight: 700;">${isZh ? 'üí∞ ËµÑÈáëÊµÅÂêë / Fund Flow' : 'üí∞ Fund Flow'}</h4>
                            <span class="collapsible-icon" id="fund-flow-icon-${orderId}" style="font-size: 18px; color: #6b7280; transition: transform 0.3s;">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="fund-flow-${orderId}" style="display: none; padding: 0 16px 16px 16px;">
                            ${(() => {
                                const contractAddress = window.contracts?.rideOrder?.address || window.CONTRACT_ADDRESSES?.rideOrder || 'N/A';
                                const passengerAddr = order.passenger || 'N/A';
                                const driverAddr = order.driver && order.driver !== ethers.constants.AddressZero ? order.driver : null;
                                const orderAmount = feeDetails.totalOrderFareETH || (order.estimatedFare ? 
                                    (typeof order.estimatedFare === 'string' ? parseFloat(order.estimatedFare).toFixed(8) : 
                                     (order.estimatedFare && (order.estimatedFare._hex || order.estimatedFare.toString) ? 
                                      parseFloat(ethers.utils.formatEther(order.estimatedFare)).toFixed(8) : '0')) : 
                                    '0');
                                const platformFee = feeDetails.platformFeeETH || '0';
                                const driverAmount = driverAddr ? (parseFloat(orderAmount) - parseFloat(platformFee)).toFixed(8) : null;
                                const gasFee = feeDetails.gasCostETH || '0';
                                
                                function formatAddress(addr, maxLength = 10) {
                                    if (!addr || addr === 'N/A') return addr;
                                    if (addr.length <= maxLength * 2 + 2) return addr;
                                    return addr.substring(0, maxLength) + '...' + addr.substring(addr.length - maxLength);
                                }
                                
                                return `
                                    <!-- ÂàõÂª∫ËÆ¢ÂçïÊó∂ÁöÑËµÑÈáëÊµÅÂêë -->
                                    <div style="margin-bottom: 20px;">
                                        <div style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                            ${isZh ? 'üì§ ÂàõÂª∫ËÆ¢ÂçïÊó∂ / When Order Created' : 'üì§ When Order Created'}
                                        </div>
                                        <div style="display: flex; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 12px;">
                                            <div style="flex: 1; min-width: 140px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
                                                <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase;">${isZh ? '‰ªé / From' : 'From'}</div>
                                                <div onclick="copyToClipboard('${passengerAddr}'); this.style.background='#e0e7ff'; setTimeout(()=>this.style.background='',300)" style="font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 12px; color: var(--primary-color); font-weight: 600; word-break: break-all; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" title="${isZh ? 'ÁÇπÂáªÂ§çÂà∂ / Click to copy' : 'Click to copy'}">
                                                    ${formatAddress(passengerAddr)}
                                                </div>
                                                <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${isZh ? '‰πòÂÆ¢ / Passenger' : 'Passenger'}</div>
                                            </div>
                                            <div style="flex-shrink: 0; padding: 8px 0;">
                                                <div style="font-size: 20px; color: var(--primary-color);">‚Üí</div>
                                            </div>
                                            <div style="flex: 1; min-width: 140px; padding: 12px; background: white; border-radius: 8px; border: 2px solid var(--primary-color);">
                                                <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase;">${isZh ? 'Âà∞ / To' : 'To'}</div>
                                                <div onclick="copyToClipboard('${contractAddress}'); this.style.background='#e0e7ff'; setTimeout(()=>this.style.background='',300)" style="font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 12px; color: var(--primary-color); font-weight: 600; word-break: break-all; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" title="${isZh ? 'ÁÇπÂáªÂ§çÂà∂ / Click to copy' : 'Click to copy'}">
                                                    ${formatAddress(contractAddress)}
                                                </div>
                                                <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${isZh ? 'Êô∫ËÉΩÂêàÁ∫¶ / Contract' : 'Smart Contract'}</div>
                                            </div>
                                        </div>
                                        <div style="text-align: center; padding: 8px; background: #e0e7ff; border-radius: 6px; margin-top: 8px;">
                                            <span style="font-size: 14px; font-weight: 700; color: var(--primary-color);">
                                                ${orderAmount} ETH
                                            </span>
                                            <span style="font-size: 12px; color: #6b7280; margin-left: 8px;">
                                                ($${feeDetails.totalOrderFareUSD || (parseFloat(orderAmount) * (window.ETH_TO_USD_RATE || 2500)).toFixed(2)} USD)
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <!-- Gas Ë¥πÁî®ÊµÅÂêë -->
                                    ${gasFee && parseFloat(gasFee) > 0 ? `
                                    <div style="margin-bottom: 20px; padding-top: 20px; border-top: 1px dashed #e5e7eb;">
                                        <div style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                            ‚õΩ ${isZh ? 'Gas Ë¥πÁî® / Gas Fee' : 'Gas Fee'}
                                        </div>
                                        <div style="display: flex; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 12px;">
                                            <div style="flex: 1; min-width: 140px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
                                                <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase;">${isZh ? '‰ªé / From' : 'From'}</div>
                                                <div onclick="copyToClipboard('${passengerAddr}'); this.style.background='#e0e7ff'; setTimeout(()=>this.style.background='',300)" style="font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 12px; color: #6b7280; font-weight: 600; word-break: break-all; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" title="${isZh ? 'ÁÇπÂáªÂ§çÂà∂ / Click to copy' : 'Click to copy'}">
                                                    ${formatAddress(passengerAddr)}
                                                </div>
                                                <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${isZh ? '‰πòÂÆ¢ / Passenger' : 'Passenger'}</div>
                                            </div>
                                            <div style="flex-shrink: 0; padding: 8px 0;">
                                                <div style="font-size: 20px; color: #6b7280;">‚Üí</div>
                                            </div>
                                            <div style="flex: 1; min-width: 140px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #9ca3af;">
                                                <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase;">${isZh ? 'Âà∞ / To' : 'To'}</div>
                                                <div style="font-size: 12px; color: #6b7280; font-weight: 600;">
                                                    ${isZh ? 'Âå∫ÂùóÈìæÁΩëÁªú / Network' : 'Blockchain Network'}
                                                </div>
                                                <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${isZh ? 'ÁüøÂ∑•Ë¥πÁî® / Miner' : 'Miner Fee'}</div>
                                            </div>
                                        </div>
                                        <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 6px; margin-top: 8px;">
                                            <span style="font-size: 14px; font-weight: 700; color: #6b7280;">
                                                ${parseFloat(gasFee) < 0.0001 ? '< 0.0001' : parseFloat(gasFee).toFixed(8)} ETH
                                            </span>
                                            <span style="font-size: 12px; color: #9ca3af; margin-left: 8px;">
                                                ($${feeDetails.gasCostUSD || '0.00'} USD)
                                            </span>
                                        </div>
                                    </div>
                                    ` : ''}
                                    
                                    <!-- ËÆ¢ÂçïÂÆåÊàêÂêéÁöÑËµÑÈáëÊµÅÂêëÔºàÂ¶ÇÊûúËÆ¢ÂçïÂ∑≤ÂÆåÊàêÔºâ -->
                                    ${order.status === 3 && driverAddr && driverAmount ? `
                                    <div style="margin-bottom: 20px; padding-top: 20px; border-top: 2px solid #10b981;">
                                        <div style="font-size: 13px; font-weight: 600; color: #059669; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                            ‚úÖ ${isZh ? 'ËÆ¢ÂçïÂÆåÊàêÊó∂ / When Order Completed' : 'When Order Completed'}
                                        </div>
                                        
                                        <!-- Âè∏Êú∫Êî∂Ê¨æ -->
                                        <div style="margin-bottom: 16px;">
                                            <div style="display: flex; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 12px;">
                                                <div style="flex: 1; min-width: 140px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
                                                    <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase;">${isZh ? '‰ªé / From' : 'From'}</div>
                                                    <div style="font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 12px; color: var(--primary-color); font-weight: 600; word-break: break-all;">
                                                        ${formatAddress(contractAddress)}
                                                    </div>
                                                    <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${isZh ? 'Êô∫ËÉΩÂêàÁ∫¶ / Contract' : 'Smart Contract'}</div>
                                                </div>
                                                <div style="flex-shrink: 0; padding: 8px 0;">
                                                    <div style="font-size: 20px; color: #10b981;">‚Üí</div>
                                                </div>
                                                <div style="flex: 1; min-width: 140px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #10b981;">
                                                    <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase;">${isZh ? 'Âà∞ / To' : 'To'}</div>
                                                    <div onclick="copyToClipboard('${driverAddr}'); this.style.background='#e0e7ff'; setTimeout(()=>this.style.background='',300)" style="font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 12px; color: #059669; font-weight: 600; word-break: break-all; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" title="${isZh ? 'ÁÇπÂáªÂ§çÂà∂ / Click to copy' : 'Click to copy'}">
                                                        ${formatAddress(driverAddr)}
                                                    </div>
                                                    <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${isZh ? 'Âè∏Êú∫ / Driver' : 'Driver'}</div>
                                                </div>
                                            </div>
                                            <div style="text-align: center; padding: 8px; background: #d1fae5; border-radius: 6px; margin-top: 8px;">
                                                <span style="font-size: 14px; font-weight: 700; color: #059669;">
                                                    ${driverAmount} ETH
                                                </span>
                                                <span style="font-size: 12px; color: #6b7280; margin-left: 8px;">
                                                    ($${(parseFloat(driverAmount) * (window.ETH_TO_USD_RATE || 2500)).toFixed(2)} USD)
                                                </span>
                                                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">${isZh ? 'ËÆ¢ÂçïÈáëÈ¢ù - Âπ≥Âè∞Ë¥π' : 'Order Amount - Platform Fee'}</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Âπ≥Âè∞Ë¥π -->
                                        ${parseFloat(platformFee) > 0 ? `
                                        <div>
                                            <div style="display: flex; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 12px;">
                                                <div style="flex: 1; min-width: 140px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
                                                    <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase;">${isZh ? '‰ªé / From' : 'From'}</div>
                                                    <div style="font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 12px; color: var(--primary-color); font-weight: 600; word-break: break-all;">
                                                        ${formatAddress(contractAddress)}
                                                    </div>
                                                    <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${isZh ? 'Êô∫ËÉΩÂêàÁ∫¶ / Contract' : 'Smart Contract'}</div>
                                                </div>
                                                <div style="flex-shrink: 0; padding: 8px 0;">
                                                    <div style="font-size: 20px; color: #f59e0b;">‚Üí</div>
                                                </div>
                                                <div style="flex: 1; min-width: 140px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #f59e0b;">
                                                    <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase;">${isZh ? 'Âà∞ / To' : 'To'}</div>
                                                    <div style="font-size: 12px; color: #d97706; font-weight: 600;">
                                                        ${isZh ? 'Âπ≥Âè∞Èí±ÂåÖ / Platform' : 'Platform Wallet'}
                                                    </div>
                                                    <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${isZh ? 'Âπ≥Âè∞Ë¥π 5%' : 'Platform Fee 5%'}</div>
                                                </div>
                                            </div>
                                            <div style="text-align: center; padding: 8px; background: #fef3c7; border-radius: 6px; margin-top: 8px;">
                                                <span style="font-size: 14px; font-weight: 700; color: #d97706;">
                                                    ${platformFee} ETH
                                                </span>
                                                <span style="font-size: 12px; color: #6b7280; margin-left: 8px;">
                                                    ($${feeDetails.platformFeeUSD || (parseFloat(platformFee) * (window.ETH_TO_USD_RATE || 2500)).toFixed(2)} USD)
                                                </span>
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                    ` : ''}
                                    
                                    ${order.status === 4 ? `
                                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #ef4444;">
                                        <div style="font-size: 13px; font-weight: 600; color: #dc2626; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                            ‚ùå ${isZh ? 'ËÆ¢ÂçïÂèñÊ∂àÊó∂ / When Order Cancelled' : 'When Order Cancelled'}
                                        </div>
                                        <div style="display: flex; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 12px;">
                                            <div style="flex: 1; min-width: 140px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
                                                <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase;">${isZh ? '‰ªé / From' : 'From'}</div>
                                                <div onclick="copyToClipboard('${contractAddress}'); this.style.background='#e0e7ff'; setTimeout(()=>this.style.background='',300)" style="font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 12px; color: var(--primary-color); font-weight: 600; word-break: break-all; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" title="${isZh ? 'ÁÇπÂáªÂ§çÂà∂ / Click to copy' : 'Click to copy'}">
                                                    ${formatAddress(contractAddress)}
                                                </div>
                                                <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${isZh ? 'Êô∫ËÉΩÂêàÁ∫¶ / Contract' : 'Smart Contract'}</div>
                                            </div>
                                            <div style="flex-shrink: 0; padding: 8px 0;">
                                                <div style="font-size: 20px; color: #ef4444;">‚Üí</div>
                                            </div>
                                            <div style="flex: 1; min-width: 140px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #ef4444;">
                                                <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px; text-transform: uppercase;">${isZh ? 'Âà∞ / To' : 'To'}</div>
                                                <div onclick="copyToClipboard('${passengerAddr}'); this.style.background='#e0e7ff'; setTimeout(()=>this.style.background='',300)" style="font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 12px; color: #dc2626; font-weight: 600; word-break: break-all; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" title="${isZh ? 'ÁÇπÂáªÂ§çÂà∂ / Click to copy' : 'Click to copy'}">
                                                    ${formatAddress(passengerAddr)}
                                                </div>
                                                <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${isZh ? 'ÈÄÄÊ¨æÁªô‰πòÂÆ¢ / Refund' : 'Refund to Passenger'}</div>
                                            </div>
                                        </div>
                                        <div style="text-align: center; padding: 8px; background: #fee2e2; border-radius: 6px; margin-top: 8px;">
                                            <span style="font-size: 14px; font-weight: 700; color: #dc2626;">
                                                ${orderAmount} ETH
                                            </span>
                                            <span style="font-size: 12px; color: #6b7280; margin-left: 8px;">
                                                ($${feeDetails.totalOrderFareUSD || (parseFloat(orderAmount) * (window.ETH_TO_USD_RATE || 2500)).toFixed(2)} USD)
                                            </span>
                                        </div>
                                    </div>
                                    ` : ''}
                                `;
                            })()}
                        </div>
                    </div>
                        <div style="font-size: 11px; color: #9ca3af; margin-top: 8px; padding: 8px; background: #f3f4f6; border-radius: 6px; text-align: center;">
                            üí° ${isZh ? 'ÊèêÁ§∫ÔºöÁÇπÂáªÂú∞ÂùÄÂèØÂ§çÂà∂Âà∞Ââ™Ë¥¥Êùø' : 'Tip: Click address to copy to clipboard'}
                        </div>
                    </div>
                    
                    <!-- Dispute Section -->
                    <div class="dispute-section" id="passenger-dispute-section-${orderId}" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <h3>${isZh ? '‚öñÔ∏è ‰∫âËÆÆÂ§ÑÁêÜ' : '‚öñÔ∏è Dispute'}</h3>
                        <div id="passenger-dispute-status-${orderId}"></div>
                        <div id="passenger-dispute-info-${orderId}"></div>
                        <div id="passenger-dispute-form-${orderId}"></div>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">${i18n.t('transactionHash')}</span>
                        <span class="info-value"><a href="#" onclick="copyToClipboard('${txHash}'); return false;">${txHash.substring(0, 20)}...</a></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">${i18n.t('createdAt')}</span>
                        <span class="info-value">${createdAt ? createdAt.toLocaleString() : 'N/A'}</span>
                    </div>
                    </div>
                </div>
            `;
            
            // ‰ΩøÁî®‰º†ÂÖ•ÁöÑÁõÆÊ†áÂÖÉÁ¥†ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®ÈªòËÆ§ÁöÑ order-info
            const targetEl = targetElement || document.getElementById('order-info');
            if (targetEl) {
                targetEl.innerHTML = orderInfoHtml;
                targetEl.style.display = 'block';
                
                // Âä†ËΩΩÂπ∂Êõ¥Êñ∞ Dispute UI
                updateDisputeUI(orderId, order);
            } else {
                console.error('Êó†Ê≥ïÊâæÂà∞ËÆ¢ÂçïËØ¶ÊÉÖÊòæÁ§∫ÂÖÉÁ¥†');
            }
        }
        
        // Êõ¥Êñ∞ Dispute UI
        async function updateDisputeUI(orderId, order) {
            const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
            const disputeStatusEl = document.getElementById(`passenger-dispute-status-${orderId}`);
            const disputeInfoEl = document.getElementById(`passenger-dispute-info-${orderId}`);
            const disputeFormEl = document.getElementById(`passenger-dispute-form-${orderId}`);
            
            if (!disputeStatusEl || !disputeInfoEl || !disputeFormEl) {
                return;
            }
            
            // Âä†ËΩΩÊúÄÊñ∞ÁöÑ‰∫âËÆÆÁä∂ÊÄÅ
            const disputeStatus = await loadDisputeStatus(orderId);
            if (!disputeStatus) {
                disputeStatusEl.innerHTML = '<div style="color: #6b7280; font-size: 14px;">Êó†Ê≥ïÂä†ËΩΩ‰∫âËÆÆÁä∂ÊÄÅ</div>';
                return;
            }
            
            const rideStatus = disputeStatus.rideStatus || order.rideStatus || 0;
            const isAwaitingSettlement = rideStatus === 5; // AWAITING_SETTLEMENT = 5
            
            // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
            if (disputeStatus.disputeOpened) {
                disputeStatusEl.innerHTML = `
                    <div style="padding: 12px; background: ${disputeStatus.disputeResolved ? '#d1fae5' : '#fee2e2'}; border-radius: 8px; border: 1px solid ${disputeStatus.disputeResolved ? '#10b981' : '#ef4444'}; margin-bottom: 12px;">
                        <div style="font-size: 14px; font-weight: 600; color: ${disputeStatus.disputeResolved ? '#065f46' : '#991b1b'};">
                            ${disputeStatus.disputeResolved 
                                ? (isZh ? '‚úÖ ‰∫âËÆÆÂ∑≤Ëß£ÂÜ≥' : '‚úÖ Dispute Resolved')
                                : (isZh ? '‚ö†Ô∏è ‰∫âËÆÆÂ∑≤Êèê‰∫§ÔºåÁ≠âÂæÖÂπ≥Âè∞Â§ÑÁêÜ' : '‚ö†Ô∏è Dispute Submitted, Awaiting Resolution')}
                        </div>
                    </div>
                `;
            } else {
                disputeStatusEl.innerHTML = '';
            }
            
            // Êõ¥Êñ∞‰∫âËÆÆ‰ø°ÊÅØ
            if (disputeStatus.disputeOpened) {
                const openedAt = disputeStatus.disputeOpenedAt && disputeStatus.disputeOpenedAt.toNumber 
                    ? new Date(disputeStatus.disputeOpenedAt.toNumber() * 1000).toLocaleString()
                    : '';
                const resolvedAt = disputeStatus.disputeResolvedAt && disputeStatus.disputeResolvedAt.toNumber
                    ? new Date(disputeStatus.disputeResolvedAt.toNumber() * 1000).toLocaleString()
                    : '';
                
                disputeInfoEl.innerHTML = `
                    <div style="margin-top: 12px;">
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px; font-weight: 600;">
                            ${isZh ? '‰∫âËÆÆ‰ø°ÊÅØ / Dispute Info' : 'Dispute Info'}
                        </div>
                        <div style="padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <div style="margin-bottom: 8px;">
                                <span style="font-size: 12px; color: #6b7280;">${isZh ? 'ÂèëËµ∑‰∫∫ / Opened By' : 'Opened By'}:</span>
                                <span style="font-size: 13px; color: #1f2937; font-family: monospace; margin-left: 8px;">
                                    ${disputeStatus.disputeOpener ? (disputeStatus.disputeOpener.substring(0, 6) + '...' + disputeStatus.disputeOpener.substring(38)) : 'N/A'}
                                </span>
                            </div>
                            ${openedAt ? `
                            <div style="margin-bottom: 8px;">
                                <span style="font-size: 12px; color: #6b7280;">${isZh ? 'ÂèëËµ∑Êó∂Èó¥ / Opened At' : 'Opened At'}:</span>
                                <span style="font-size: 13px; color: #1f2937; margin-left: 8px;">${openedAt}</span>
                            </div>
                            ` : ''}
                            ${disputeStatus.disputeReason ? `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 6px; font-weight: 600;">
                                    ${isZh ? '‰∫âËÆÆÂéüÂõ† / Reason' : 'Reason'}
                                </div>
                                <div style="font-size: 14px; color: #1f2937; line-height: 1.6; white-space: pre-wrap;">${disputeStatus.disputeReason}</div>
                            </div>
                            ` : ''}
                            ${disputeStatus.disputeResolved ? `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 6px; font-weight: 600;">
                                    ${isZh ? 'Ëé∑ËÉúÊñπ / Winner' : 'Winner'}
                                </div>
                                <div style="font-size: 13px; color: #1f2937; font-family: monospace;">
                                    ${disputeStatus.disputeWinner ? (disputeStatus.disputeWinner.substring(0, 6) + '...' + disputeStatus.disputeWinner.substring(38)) : 'N/A'}
                                </div>
                                ${resolvedAt ? `
                                <div style="font-size: 11px; color: #6b7280; margin-top: 6px;">
                                    ${isZh ? 'Ëß£ÂÜ≥Êó∂Èó¥ / Resolved At' : 'Resolved At'}: ${resolvedAt}
                                </div>
                                ` : ''}
                                ${disputeStatus.disputeResolutionDetail ? `
                                <div style="margin-top: 8px; padding: 8px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6;">
                                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px; font-weight: 600;">
                                        ${isZh ? 'Ë£ÅÂÜ≥ËØ¥Êòé / Resolution Detail' : 'Resolution Detail'}
                                    </div>
                                    <div style="font-size: 13px; color: #1f2937; line-height: 1.5;">${disputeStatus.disputeResolutionDetail}</div>
                                </div>
                                ` : ''}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                disputeInfoEl.innerHTML = '';
            }
            
            // Êõ¥Êñ∞‰∫âËÆÆË°®ÂçïÔºà‰ªÖÂΩìËÆ¢ÂçïÂú® AWAITING_SETTLEMENT Áä∂ÊÄÅ‰∏îÊú™ÂèëËµ∑‰∫âËÆÆÊó∂ÊòæÁ§∫Ôºâ
            if (isAwaitingSettlement && !disputeStatus.disputeOpened) {
                disputeFormEl.innerHTML = `
                    <div style="margin-top: 16px;">
                        <textarea id="passenger-dispute-reason-${orderId}" placeholder="${isZh ? 'ËØ∑ÊèèËø∞ÊÇ®ÁöÑÈóÆÈ¢ò...' : 'Describe your issue...'}" style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; box-sizing: border-box;"></textarea>
                        <button id="btn-passenger-submit-dispute-${orderId}" onclick="submitDispute(${orderId})" style="margin-top: 12px; padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; width: 100%;">
                            ${isZh ? 'Êèê‰∫§‰∫âËÆÆ / Submit Dispute' : 'Submit Dispute'}
                        </button>
                    </div>
                `;
            } else {
                disputeFormEl.innerHTML = '';
            }
        }
        
        window.updateDisputeUI = updateDisputeUI;
        
        // ÂÖ≥Èó≠ËÆ¢ÂçïËØ¶ÊÉÖÊ®°ÊÄÅÂØπËØùÊ°Ü
        window.closeOrderModal = function() {
            const orderModal = document.getElementById('order-modal');
            const orderModalBody = document.getElementById('order-modal-body');
            if (orderModal) {
                orderModal.style.display = 'none';
                document.body.style.overflow = ''; // ÊÅ¢Â§çËÉåÊôØÊªöÂä®
            }
            if (orderModalBody) {
                orderModalBody.innerHTML = '';
            }
        };
        
        // ÂÖ≥Èó≠ËÆ¢ÂçïËØ¶ÊÉÖÔºàÂÖºÂÆπÊóß‰ª£Á†ÅÔºâ
        window.closeOrderInfo = function(elementId) {
            // Â¶ÇÊûúÊòØÊ®°ÊÄÅÂØπËØùÊ°ÜÔºå‰ΩøÁî®Êñ∞ÁöÑÂÖ≥Èó≠ÊñπÊ≥ï
            if (elementId === 'order-modal-body' || !elementId) {
                window.closeOrderModal();
                return;
            }
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'none';
                element.innerHTML = '';
            }
        };
        
        // ÂàáÊç¢ÂèØÊäòÂè†Âç°Áâá
        window.toggleCollapsible = function(elementId) {
            const content = document.getElementById(elementId);
            let iconId = '';
            if (elementId.startsWith('fee-details-')) {
                iconId = elementId.replace('fee-details-', 'fee-details-icon-');
            } else if (elementId.startsWith('fund-flow-')) {
                iconId = elementId.replace('fund-flow-', 'fund-flow-icon-');
            }
            const icon = iconId ? document.getElementById(iconId) : null;
            
            if (content) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    if (icon) {
                        icon.classList.add('expanded');
                    }
                } else {
                    content.style.display = 'none';
                    if (icon) {
                        icon.classList.remove('expanded');
                    }
                }
            }
        };
        
        // Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert(i18n.t('copied') + ' ' + text);
            });
        }
        
        // Âä†ËΩΩ‰∫âËÆÆÁä∂ÊÄÅ
        async function loadDisputeStatus(orderId) {
            if (!window.contractsInitialized || !window.contracts.rideOrder) {
                return null;
            }
            
            try {
                const disputeStatus = await window.contracts.rideOrder.getDisputeStatus(orderId);
                return {
                    disputeOpened: disputeStatus.disputeOpened,
                    disputeResolved: disputeStatus.disputeResolved,
                    disputeOpener: disputeStatus.disputeOpener,
                    disputeWinner: disputeStatus.disputeWinner,
                    disputeReason: disputeStatus.disputeReason,
                    disputeOpenedAt: disputeStatus.disputeOpenedAt,
                    disputeResolvedAt: disputeStatus.disputeResolvedAt,
                    disputeResolutionDetail: disputeStatus.disputeResolutionDetail,
                    rideStatus: disputeStatus.rideStatus
                };
            } catch (error) {
                console.error('Âä†ËΩΩ‰∫âËÆÆÁä∂ÊÄÅÂ§±Ë¥•:', error);
                return null;
            }
        }
        
        window.loadDisputeStatus = loadDisputeStatus;
        
        // Êèê‰∫§‰∫âËÆÆ
        window.submitDispute = async function(orderId) {
            if (!window.contractsInitialized || !window.contracts.rideOrder) {
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                alert(isZh ? '‚ö†Ô∏è ÂêàÁ∫¶Êú™ÂàùÂßãÂåñ' : '‚ö†Ô∏è Contract not initialized');
                return;
            }
            
            const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
            // Â∞ùËØï‰ªéÊñ∞ÁöÑË°®ÂçïÂÖÉÁ¥†Ëé∑ÂèñÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®ÂàôÂ∞ùËØïÊóßÁöÑ
            let reasonInput = document.getElementById(`passenger-dispute-reason-${orderId}`);
            if (!reasonInput) {
                reasonInput = document.getElementById(`dispute-input-${orderId}`);
            }
            if (!reasonInput) {
                alert(isZh ? 'Êó†Ê≥ïÊâæÂà∞‰∫âËÆÆËæìÂÖ•Ê°Ü' : 'Cannot find dispute input');
                return;
            }
            
            const reason = reasonInput.value.trim();
            if (!reason) {
                alert(isZh ? 'ËØ∑ËæìÂÖ•‰∫âËÆÆÂéüÂõ†' : 'Please enter dispute reason');
                return;
            }
            
            try {
                // Â∞ùËØïËé∑ÂèñÊñ∞ÁöÑÊåâÈíÆÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®ÂàôÂ∞ùËØïÊóßÁöÑ
                let btn = document.getElementById(`btn-passenger-submit-dispute-${orderId}`);
                if (!btn) {
                    btn = document.getElementById(`btn-submit-dispute-${orderId}`);
                }
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = isZh ? 'Êèê‰∫§‰∏≠...' : 'Submitting...';
                }
                
                const tx = await window.contracts.rideOrder.submitDispute(orderId, reason);
                await tx.wait();
                
                alert(isZh ? '‰∫âËÆÆÂ∑≤Êèê‰∫§ÊàêÂäüÔºÅ' : 'Dispute submitted successfully!');
                
                // Âà∑Êñ∞ËÆ¢ÂçïËØ¶ÊÉÖ
                if (typeof window.viewOrderDetail === 'function') {
                    await window.viewOrderDetail(orderId);
                } else if (typeof window.showOrderInfo === 'function') {
                    await window.showOrderInfo(orderId);
                }
            } catch (error) {
                console.error('Êèê‰∫§‰∫âËÆÆÂ§±Ë¥•:', error);
                const friendlyError = error.reason || error.message || 'Unknown error';
                alert(isZh ? `Êèê‰∫§‰∫âËÆÆÂ§±Ë¥•: ${friendlyError}` : `Failed to submit dispute: ${friendlyError}`);
                
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                let btn = document.getElementById(`btn-passenger-submit-dispute-${orderId}`);
                if (!btn) {
                    btn = document.getElementById(`btn-submit-dispute-${orderId}`);
                }
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = isZh ? 'Êèê‰∫§‰∫âËÆÆ / Submit Dispute' : 'Submit Dispute';
                }
            }
        };
        
        // Ëé∑Âèñ‰∫âËÆÆÁä∂ÊÄÅ
        window.getDisputeStatus = async function(orderId) {
            if (!window.contractsInitialized || !window.contracts.rideOrder) {
                return null;
            }
            
            try {
                const disputeStatus = await window.contracts.rideOrder.getDisputeStatus(orderId);
                return {
                    disputeOpened: disputeStatus.disputeOpened,
                    disputeReason: disputeStatus.disputeReason,
                    disputeResolved: disputeStatus.disputeResolved,
                    disputeWinner: disputeStatus.disputeWinner,
                    disputeTimestamp: disputeStatus.disputeTimestamp
                };
            } catch (error) {
                console.error('Ëé∑Âèñ‰∫âËÆÆÁä∂ÊÄÅÂ§±Ë¥•:', error);
                return null;
            }
        };
        
        // Passenger confirm complete order (call completeOrder, use estimatedFare as actualFare, as maturity simulation)
        window.passengerConfirmComplete = async function(orderId) {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('‚úÖ passengerConfirmComplete is clicked - ËÆ¢Âçï ID:', orderId);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
            
            if (!window.contractsInitialized || !window.contracts.rideOrder) {
                console.error('‚ùå ÂêàÁ∫¶Êú™ÂàùÂßãÂåñÔºÅ');
                alert(isZh ? 'ÂêàÁ∫¶Êú™ÂàùÂßãÂåñÔºÅ' : 'Contract not initialized!');
                return;
            }
            
            try {
                // Get order information (get latest status from contract)
                console.log('üìã Ëé∑ÂèñËÆ¢Âçï‰ø°ÊÅØÔºà‰ªéÂêàÁ∫¶Ëé∑ÂèñÊúÄÊñ∞Áä∂ÊÄÅÔºâ...');
                const order = await window.contracts.rideOrder.getOrder(orderId);
                
                // Ensure status is numeric type
                let contractStatus = order.status;
                if (typeof contractStatus === 'number') {
                    contractStatus = contractStatus;
                } else if (contractStatus && typeof contractStatus.toNumber === 'function') {
                    contractStatus = contractStatus.toNumber();
                } else if (typeof contractStatus === 'string') {
                    contractStatus = parseInt(contractStatus) || 0;
                } else {
                    contractStatus = parseInt(contractStatus) || 0;
                }
                
                // Ensure rideStatus is numeric type
                let contractRideStatus = order.rideStatus;
                if (typeof contractRideStatus === 'number') {
                    contractRideStatus = contractRideStatus;
                } else if (contractRideStatus && typeof contractRideStatus.toNumber === 'function') {
                    contractRideStatus = contractRideStatus.toNumber();
                } else if (typeof contractRideStatus === 'string') {
                    contractRideStatus = parseInt(contractRideStatus) || 0;
                } else {
                    contractRideStatus = parseInt(contractRideStatus) || 0;
                }
                
                const statusNames = ['Pending', 'Accepted', 'PickedUp', 'Completed', 'Cancelled'];
                // RideStatus Êûö‰∏æÂÄºÔºöNONE=0, CREATED=1, ACCEPTED=2, IN_PROGRESS=3, COMPLETED=4, AWAITING_SETTLEMENT=5, SETTLED=6
                // Ê≥®ÊÑèÔºöSolidity enum ‰ªé 0 ÂºÄÂßãÔºå‰ΩÜËøôÈáåÊàë‰ª¨ÈúÄË¶ÅÊ≠£Á°ÆÊò†Â∞Ñ
                // ÂÆûÈôÖ‰∏äÔºöNONE=0, CREATED=1, ACCEPTED=2, IN_PROGRESS=3, COMPLETED=4, AWAITING_SETTLEMENT=5, SETTLED=6
                // ‰ΩÜÊ†πÊçÆÂêàÁ∫¶ÂÆö‰πâÔºöenum RideStatus { NONE, CREATED, ACCEPTED, IN_PROGRESS, COMPLETED, AWAITING_SETTLEMENT, SETTLED }
                // ÊâÄ‰ª•Á¥¢ÂºïÂ∫îËØ•ÊòØÔºö0=NONE, 1=CREATED, 2=ACCEPTED, 3=IN_PROGRESS, 4=COMPLETED, 5=AWAITING_SETTLEMENT, 6=SETTLED
                const rideStatusNames = ['NONE', 'CREATED', 'ACCEPTED', 'IN_PROGRESS', 'COMPLETED', 'AWAITING_SETTLEMENT', 'SETTLED'];
                
                console.log('üìã ËÆ¢Âçï‰ø°ÊÅØÔºàÂêàÁ∫¶ÊúÄÊñ∞Áä∂ÊÄÅÔºâ:', {
                    orderId: order.orderId.toString(),
                    status: contractStatus,
                    statusName: statusNames[contractStatus] || 'Unknown',
                    rideStatus: contractRideStatus,
                    rideStatusName: rideStatusNames[contractRideStatus] || 'Unknown',
                    estimatedFare: ethers.utils.formatEther(order.estimatedFare) + ' ETH',
                    driver: order.driver,
                    disputeOpened: order.disputeOpened || false
                });
                
                // Ê£ÄÊü•ËÆ¢ÂçïÁä∂ÊÄÅÔºàÂÖÅËÆ∏ PickedUp Âíå Completed Áä∂ÊÄÅÔºâ
                if (contractStatus !== 2 && contractStatus !== 3) { // 2 = PickedUp, 3 = Completed
                    const errorMsg = isZh 
                        ? `ËÆ¢ÂçïÁä∂ÊÄÅ‰∏çÊ≠£Á°ÆÔºàÁä∂ÊÄÅ: ${contractStatus} - ${statusNames[contractStatus] || 'Unknown'}Ôºâ„ÄÇ\n\nËÆ¢ÂçïÂøÖÈ°ªÊòØ"Â∑≤‰∏äËΩ¶"(PickedUp)Êàñ"Â∑≤ÂÆåÊàê"(Completed)Áä∂ÊÄÅÊâçËÉΩÂÆåÊàê„ÄÇ`
                        : `Invalid order status (${contractStatus} - ${statusNames[contractStatus] || 'Unknown'}).\n\nOrder must be in "PickedUp" or "Completed" status to complete.`;
                    console.error('‚ùå', errorMsg);
                    alert(errorMsg);
                    return;
                }
                
                if (!order.driver || order.driver === ethers.constants.AddressZero) {
                    const errorMsg = isZh 
                        ? 'ËÆ¢ÂçïÂ∞öÊú™Ë¢´Âè∏Êú∫Êé•ÂçïÔºåÊó†Ê≥ïÂÆåÊàê„ÄÇ'
                        : 'Order has not been accepted by a driver yet.';
                    console.error('‚ùå', errorMsg);
                    alert(errorMsg);
                    return;
                }
                
                // Ê£ÄÊü•ËÆ¢ÂçïÊòØÂê¶Â∑≤ÁªèÊòØ Completed Áä∂ÊÄÅ
                const isCompleted = contractStatus === 3; // 3 = Completed
                
                console.log(`üìã ËÆ¢ÂçïÁä∂ÊÄÅÂà§Êñ≠: isCompleted = ${isCompleted} (status: ${contractStatus} - ${statusNames[contractStatus]})`);
                
                // Ëé∑ÂèñÂΩìÂâçË¥¶Êà∑‰ΩôÈ¢ùÔºà‰∫§ÊòìÂâçÔºâ
                let passengerBalanceBefore = null;
                try {
                    if (window.account && window.provider) {
                        passengerBalanceBefore = await window.provider.getBalance(window.account);
                        console.log('üí∞ ‰πòÂÆ¢‰∫§ÊòìÂâç‰ΩôÈ¢ù:', ethers.utils.formatEther(passengerBalanceBefore), 'ETH');
                    }
                } catch (balanceError) {
                    console.warn('‚ö†Ô∏è Êó†Ê≥ïËé∑Âèñ‰∫§ÊòìÂâç‰ΩôÈ¢ù:', balanceError);
                }
                
                let tx;
                let receipt;
                
                if (isCompleted) {
                    // Â¶ÇÊûúËÆ¢ÂçïÂ∑≤ÁªèÊòØ Completed Áä∂ÊÄÅÔºåË∞ÉÁî® settle ÂáΩÊï∞Êù•ÁªìÁÆóËµÑÈáëÔºà‰Ωú‰∏∫Âà∞ÊúüÊ®°ÊãüÔºâ
                    console.log('üìã ËÆ¢ÂçïÂ∑≤ÊòØ Completed Áä∂ÊÄÅÔºåË∞ÉÁî® settle ÂáΩÊï∞ÁªìÁÆóËµÑÈáëÔºàÊ®°Êãü complete order ÊµÅÁ®ãÔºâ...');
                    console.log(`üìã ÂΩìÂâç rideStatus: ${contractRideStatus} (${rideStatusNames[contractRideStatus]})`);
                    
                    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÁªìÁÆó
                    // RideStatus Êûö‰∏æÂÄºÔºà‰ªéÂêàÁ∫¶ÂÆö‰πâÔºâÔºöNONE=0, CREATED=1, ACCEPTED=2, IN_PROGRESS=3, COMPLETED=4, AWAITING_SETTLEMENT=5, SETTLED=6
                    const RideStatus = { NONE: 0, CREATED: 1, ACCEPTED: 2, IN_PROGRESS: 3, COMPLETED: 4, AWAITING_SETTLEMENT: 5, SETTLED: 6 };
                    
                    console.log(`üìã ÂΩìÂâç rideStatus: ${contractRideStatus} (${rideStatusNames[contractRideStatus] || 'Unknown'})`);
                    
                    // Â¶ÇÊûúÂ∑≤ÁªèÊòØ SETTLEDÔºà6ÔºâÔºåËØ¥ÊòéÂ∑≤ÁªèÁªìÁÆóÂÆåÊàê
                    if (contractRideStatus === RideStatus.SETTLED) {
                        // ËÆ¢ÂçïÂ∑≤ÁªìÁÆóÔºåÈ™åËØÅËΩ¨Ë¥¶‰ø°ÊÅØ
                        console.log('‚ö†Ô∏è ËÆ¢ÂçïÂ∑≤ÁªìÁÆóÔºåÈ™åËØÅËΩ¨Ë¥¶‰ø°ÊÅØ...');
                        
                        try {
                            // Êü•ËØ¢ PaymentReleased ‰∫ã‰ª∂
                            const filter = window.contracts.rideOrder.filters.PaymentReleased(orderId);
                            const events = await window.contracts.rideOrder.queryFilter(filter, -1000); // Êü•ËØ¢ÊúÄËøë1000‰∏™Âå∫Âùó
                            
                            if (events && events.length > 0) {
                                const latestEvent = events[events.length - 1];
                                const driverAddress = latestEvent.args.driver;
                                const driverAmount = latestEvent.args.driverAmount;
                                const platformFee = latestEvent.args.platformFee;
                                
                                console.log('üìã ÊâæÂà∞ PaymentReleased ‰∫ã‰ª∂:');
                                console.log('  ‰∫§ÊòìÂìàÂ∏å:', latestEvent.transactionHash);
                                console.log('  Âå∫ÂùóÂè∑:', latestEvent.blockNumber);
                                console.log('  Âè∏Êú∫Âú∞ÂùÄ:', driverAddress);
                                console.log('  Âè∏Êú∫ÈáëÈ¢ù:', ethers.utils.formatEther(driverAmount), 'ETH');
                                console.log('  Âπ≥Âè∞Ë¥πÁî®:', ethers.utils.formatEther(platformFee), 'ETH');
                                
                                // Ê£ÄÊü•Âè∏Êú∫ÂΩìÂâç‰ΩôÈ¢ù
                                try {
                                    if (window.provider) {
                                        const driverBalance = await window.provider.getBalance(driverAddress);
                                        console.log('  Âè∏Êú∫ÂΩìÂâç‰ΩôÈ¢ù:', ethers.utils.formatEther(driverBalance), 'ETH');
                                        
                                        const errorMsg = isZh 
                                            ? `ËÆ¢ÂçïÂ∑≤ÁªèÁªìÁÆóÂÆåÊàêÔºàrideStatus: ${contractRideStatus}Ôºâ„ÄÇ\n\nËΩ¨Ë¥¶ËØ¶ÊÉÖÔºö\nÂè∏Êú∫Âú∞ÂùÄ: ${driverAddress}\nÂè∏Êú∫ÈáëÈ¢ù: ${ethers.utils.formatEther(driverAmount)} ETH\nÂπ≥Âè∞Ë¥πÁî®: ${ethers.utils.formatEther(platformFee)} ETH\n\n‰∫§ÊòìÂìàÂ∏å: ${latestEvent.transactionHash}\n\nÂ¶ÇÊûúÂè∏Êú∫Á´ØÊ≤°ÊúâÁúãÂà∞‰ΩôÈ¢ùÊõ¥Êñ∞Ôºö\n1. Âà∑Êñ∞Âè∏Êú∫Á´ØÈ°µÈù¢\n2. Á°ÆËÆ§Âè∏Êú∫Á´ØËøûÊé•ÁöÑÈí±ÂåÖÂú∞ÂùÄÊòØ: ${driverAddress}\n3. Âú®Âå∫ÂùóÊµèËßàÂô®‰∏≠Êü•Áúã‰∫§ÊòìËØ¶ÊÉÖ`
                                            : `Order already settled (rideStatus: ${contractRideStatus}).\n\nTransfer details:\nDriver address: ${driverAddress}\nDriver amount: ${ethers.utils.formatEther(driverAmount)} ETH\nPlatform fee: ${ethers.utils.formatEther(platformFee)} ETH\n\nTransaction hash: ${latestEvent.transactionHash}\n\nIf driver doesn't see balance update:\n1. Refresh driver app page\n2. Confirm driver's connected wallet address is: ${driverAddress}\n3. View transaction in block explorer`;
                                        console.warn('‚ö†Ô∏è', errorMsg);
                                        alert(errorMsg);
                                    }
                                } catch (balanceError) {
                                    console.warn('‚ö†Ô∏è Êó†Ê≥ïÊ£ÄÊü•Âè∏Êú∫‰ΩôÈ¢ù:', balanceError);
                                    const errorMsg = isZh 
                                        ? `ËÆ¢ÂçïÂ∑≤ÁªèÁªìÁÆóÂÆåÊàê„ÄÇ\n\nÂè∏Êú∫Âú∞ÂùÄ: ${driverAddress}\nÂè∏Êú∫ÈáëÈ¢ù: ${ethers.utils.formatEther(driverAmount)} ETH\n‰∫§ÊòìÂìàÂ∏å: ${latestEvent.transactionHash}\n\nËØ∑Ê£ÄÊü•Âè∏Êú∫Á´Ø‰ΩôÈ¢ùÊòØÂê¶Êõ¥Êñ∞„ÄÇ`
                                        : `Order already settled.\n\nDriver address: ${driverAddress}\nDriver amount: ${ethers.utils.formatEther(driverAmount)} ETH\nTransaction hash: ${latestEvent.transactionHash}\n\nPlease check if driver's balance has been updated.`;
                                    alert(errorMsg);
                                }
                            } else {
                                console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ PaymentReleased ‰∫ã‰ª∂Ôºå‰ΩÜËÆ¢ÂçïÁä∂ÊÄÅÊòæÁ§∫Â∑≤ÁªìÁÆó');
                                const errorMsg = isZh 
                                    ? `ËÆ¢ÂçïÁä∂ÊÄÅÊòæÁ§∫Â∑≤ÁªìÁÆóÔºå‰ΩÜÊú™ÊâæÂà∞ËΩ¨Ë¥¶‰∫ã‰ª∂„ÄÇ\n\nËøôÂèØËÉΩË°®Á§∫ËΩ¨Ë¥¶Â§±Ë¥•‰ΩÜÁä∂ÊÄÅË¢´ÈîôËØØÊõ¥Êñ∞„ÄÇ\n\nËØ∑Ê£ÄÊü•‰∫§ÊòìÂéÜÂè≤ÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëò„ÄÇ`
                                    : `Order status shows settled, but no transfer event found.\n\nThis may indicate transfer failed but status was incorrectly updated.\n\nPlease check transaction history or contact administrator.`;
                                alert(errorMsg);
                            }
                        } catch (eventError) {
                            console.error('‚ùå Êü•ËØ¢‰∫ã‰ª∂Â§±Ë¥•:', eventError);
                            const errorMsg = isZh 
                                ? `ËÆ¢ÂçïÂ∑≤ÁªèÁªìÁÆóÂÆåÊàêÔºàrideStatus: ${contractRideStatus}Ôºâ„ÄÇ\n\nÊó†Ê≥ïÈ™åËØÅËΩ¨Ë¥¶ËØ¶ÊÉÖÔºåËØ∑Ê£ÄÊü•Âè∏Êú∫Á´Ø‰ΩôÈ¢ùÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëò„ÄÇ`
                                : `Order already settled (rideStatus: ${contractRideStatus}).\n\nUnable to verify transfer details, please check driver balance or contact administrator.`;
                            alert(errorMsg);
                        }
                        return;
                    }
                    
                    // Â¶ÇÊûúÊòØ AWAITING_SETTLEMENTÔºà5ÔºâÔºåÂèØ‰ª•ÁªìÁÆó
                    if (contractRideStatus !== RideStatus.AWAITING_SETTLEMENT) {
                        const errorMsg = isZh 
                            ? `ËÆ¢ÂçïÁä∂ÊÄÅ‰∏çÊ≠£Á°ÆÔºàrideStatus: ${contractRideStatus} - ${rideStatusNames[contractRideStatus] || 'Unknown'}Ôºâ„ÄÇ\n\nËÆ¢ÂçïÂøÖÈ°ªÊòØ AWAITING_SETTLEMENT Áä∂ÊÄÅÊâçËÉΩÁªìÁÆó„ÄÇ\n\nÂΩìÂâçÁä∂ÊÄÅÔºö${rideStatusNames[contractRideStatus] || 'Unknown'}`
                            : `Invalid order status (rideStatus: ${contractRideStatus} - ${rideStatusNames[contractRideStatus] || 'Unknown'}).\n\nOrder must be in AWAITING_SETTLEMENT status to settle.\n\nCurrent status: ${rideStatusNames[contractRideStatus] || 'Unknown'}`;
                        console.error('‚ùå', errorMsg);
                        alert(errorMsg);
                        return;
                    }
                    
                    if (contractRideStatus === RideStatus.SETTLED) {
                        const errorMsg = isZh 
                            ? `ËÆ¢ÂçïÂ∑≤ÁªèÁªìÁÆóÂÆåÊàêÔºàrideStatus: ${contractRideStatus} - ${rideStatusNames[contractRideStatus]}Ôºâ„ÄÇ\n\nÊó†ÈúÄÂÜçÊ¨°ÁªìÁÆó„ÄÇ`
                            : `Order already settled (rideStatus: ${contractRideStatus} - ${rideStatusNames[contractRideStatus]}).\n\nNo need to settle again.`;
                        console.warn('‚ö†Ô∏è', errorMsg);
                        alert(errorMsg);
                        return;
                    }
                    
                    // Áõ¥Êé•Ë∞ÉÁî® settleÔºå‰∏çÂÜçÊ£ÄÊü• rideStatusÔºàÂõ†‰∏∫ËøôÊòØÊ®°ÊãüÊµÅÁ®ãÔºâ
                    // Â¶ÇÊûú rideStatus ‰∏çÊòØ AWAITING_SETTLEMENTÔºåsettle ÂáΩÊï∞‰ºöÂú®ÂêàÁ∫¶Â±ÇÈù¢Ê£ÄÊü•
                    const confirmText = isZh 
                        ? `Á°ÆËÆ§ÁªìÁÆóËÆ¢Âçï #${orderId}Ôºü\n\nËÆ¢ÂçïÂ∑≤ÂÆåÊàêÔºåÁé∞Âú®Â∞ÜÁªìÁÆóËµÑÈáëÁªôÂè∏Êú∫ÔºàÊ®°Êãü complete order ÊµÅÁ®ãÔºâ„ÄÇ`
                        : `Confirm settling order #${orderId}?\n\nOrder is completed, funds will be settled to the driver (simulating complete order process).`;
                    
                    if (!confirm(confirmText)) {
                        console.log('Áî®Êà∑ÂèñÊ∂à‰∫ÜÁªìÁÆóÊìç‰Ωú');
                        return;
                    }
                    
                    console.log('üì§ Ë∞ÉÁî® settle ÂáΩÊï∞ÔºàÊ®°Êãü complete order ÊµÅÁ®ãÔºâ...');
                    console.log(`üìã Ë∞ÉÁî®ÂâçÁä∂ÊÄÅÊ£ÄÊü•: rideStatus=${contractRideStatus} (${rideStatusNames[contractRideStatus]}), status=${contractStatus} (${statusNames[contractStatus]})`);
                    
                    try {
                        tx = await window.contracts.rideOrder.settle(orderId);
                        console.log('‚úÖ settle ‰∫§ÊòìÂ∑≤ÂèëÈÄÅÔºåÂìàÂ∏å:', tx.hash);
                    } catch (settleError) {
                        console.error('‚ùå Ë∞ÉÁî® settle Â§±Ë¥•:', settleError);
                        const errorMsg = settleError?.message || settleError?.reason || settleError?.toString() || 'Unknown error';
                        console.error('‚ùå ÈîôËØØËØ¶ÊÉÖ:', {
                            message: settleError?.message,
                            reason: settleError?.reason,
                            code: settleError?.code,
                            data: settleError?.data
                        });
                        
                        // Â¶ÇÊûú settle Â§±Ë¥•ÔºåÊèê‰æõËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
                        if (errorMsg.includes('not ready to settle') || errorMsg.includes('AWAITING_SETTLEMENT')) {
                            const userMsg = isZh 
                                ? `Êó†Ê≥ïÁªìÁÆóËÆ¢ÂçïÔºö${errorMsg}\n\nÂΩìÂâç rideStatus: ${contractRideStatus} (${rideStatusNames[contractRideStatus] || 'Unknown'})\n\nËÆ¢ÂçïÂøÖÈ°ªÊòØ AWAITING_SETTLEMENT (5) Áä∂ÊÄÅÊâçËÉΩÁªìÁÆó„ÄÇ`
                                : `Cannot settle order: ${errorMsg}\n\nCurrent rideStatus: ${contractRideStatus} (${rideStatusNames[contractRideStatus] || 'Unknown'})\n\nOrder must be in AWAITING_SETTLEMENT (5) status to settle.`;
                            alert(userMsg);
                        } else if (errorMsg.includes('Insufficient contract balance')) {
                            const userMsg = isZh 
                                ? `Êó†Ê≥ïÁªìÁÆóËÆ¢ÂçïÔºöÂêàÁ∫¶‰ΩôÈ¢ù‰∏çË∂≥\n\n${errorMsg}\n\nËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò„ÄÇ`
                                : `Cannot settle order: Insufficient contract balance\n\n${errorMsg}\n\nPlease contact administrator.`;
                            alert(userMsg);
                        } else {
                            const userMsg = isZh 
                                ? `ÁªìÁÆóËÆ¢ÂçïÂ§±Ë¥•Ôºö${errorMsg}\n\nËØ∑Ê£ÄÊü•ËÆ¢ÂçïÁä∂ÊÄÅÂíåÂêàÁ∫¶‰ΩôÈ¢ù„ÄÇ`
                                : `Failed to settle order: ${errorMsg}\n\nPlease check order status and contract balance.`;
                            alert(userMsg);
                        }
                        return;
                    }
                    
                    // Á≠âÂæÖ‰∫§ÊòìÁ°ÆËÆ§
                    console.log('‚è≥ Á≠âÂæÖ settle ‰∫§ÊòìÁ°ÆËÆ§...');
                    let receipt;
                    try {
                        receipt = await tx.wait();
                        console.log('‚úÖ settle ‰∫§ÊòìÂ∑≤Á°ÆËÆ§ÔºåÂå∫ÂùóÂè∑:', receipt.blockNumber);
                        console.log('üìã ‰∫§ÊòìÂõûÊâß‰∏≠ÁöÑÊâÄÊúâ‰∫ã‰ª∂:', receipt.events?.map(e => e.event) || []);
                        
                        // Ê£ÄÊü• PaymentReleased Êàñ RideSettled ‰∫ã‰ª∂
                        const paymentReleasedEvent = receipt.events?.find(e => e.event === 'PaymentReleased');
                        const rideSettledEvent = receipt.events?.find(e => e.event === 'RideSettled');
                        
                        if (paymentReleasedEvent) {
                            const driverAmount = paymentReleasedEvent.args.driverAmount;
                            const platformFee = paymentReleasedEvent.args.platformFee;
                            console.log('‚úÖ PaymentReleased ‰∫ã‰ª∂Â∑≤ÂèëÂá∫:');
                            console.log('  ËÆ¢ÂçïID:', paymentReleasedEvent.args.orderId.toString());
                            console.log('  Âè∏Êú∫Âú∞ÂùÄ:', paymentReleasedEvent.args.driver);
                            console.log('  Âè∏Êú∫ÈáëÈ¢ù:', ethers.utils.formatEther(driverAmount), 'ETH');
                            console.log('  Âπ≥Âè∞Ë¥πÁî®:', ethers.utils.formatEther(platformFee), 'ETH');
                        } else {
                            console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ PaymentReleased ‰∫ã‰ª∂');
                        }
                        
                        if (rideSettledEvent) {
                            console.log('‚úÖ RideSettled ‰∫ã‰ª∂Â∑≤ÂèëÂá∫:');
                            console.log('  ËÆ¢ÂçïID:', rideSettledEvent.args.orderId.toString());
                            console.log('  ÁªìÁÆóÊó∂Èó¥:', new Date(rideSettledEvent.args.timestamp * 1000).toLocaleString());
                        } else {
                            console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ RideSettled ‰∫ã‰ª∂');
                        }
                        
                        // ÂÜçÊ¨°Ëé∑ÂèñËÆ¢ÂçïÁä∂ÊÄÅÔºåÁ°ÆËÆ§Â∑≤ÁªìÁÆó
                        try {
                            const orderAfterSettle = await window.contracts.rideOrder.getOrder(orderId);
                            let rideStatusAfter = orderAfterSettle.rideStatus;
                            if (typeof rideStatusAfter === 'number') {
                                rideStatusAfter = rideStatusAfter;
                            } else if (rideStatusAfter && typeof rideStatusAfter.toNumber === 'function') {
                                rideStatusAfter = rideStatusAfter.toNumber();
                            } else {
                                rideStatusAfter = parseInt(rideStatusAfter) || 0;
                            }
                            console.log('üìã ÁªìÁÆóÂêéËÆ¢ÂçïÁä∂ÊÄÅ:');
                            console.log('  rideStatus:', rideStatusAfter, `(${rideStatusNames[rideStatusAfter] || 'Unknown'})`);
                            console.log('  Â∫îËØ•ÊòØ SETTLED (6):', rideStatusAfter === RideStatus.SETTLED ? '‚úÖ' : '‚ùå');
                            
                            // È™åËØÅÂè∏Êú∫Âú∞ÂùÄÂíåÈáëÈ¢ù
                            if (paymentReleasedEvent) {
                                const driverAddress = paymentReleasedEvent.args.driver;
                                const driverAmount = paymentReleasedEvent.args.driverAmount;
                                console.log('üìã ËΩ¨Ë¥¶È™åËØÅ‰ø°ÊÅØ:');
                                console.log('  Âè∏Êú∫Âú∞ÂùÄ:', driverAddress);
                                console.log('  Âè∏Êú∫Â∫îÊî∂Âà∞ÈáëÈ¢ù:', ethers.utils.formatEther(driverAmount), 'ETH');
                                
                                // Ê£ÄÊü•Âè∏Êú∫ÂΩìÂâç‰ΩôÈ¢ùÔºàÂ¶ÇÊûúÂèØËÉΩÔºâ
                                try {
                                    if (window.provider) {
                                        const driverBalance = await window.provider.getBalance(driverAddress);
                                        console.log('  Âè∏Êú∫ÂΩìÂâç‰ΩôÈ¢ù:', ethers.utils.formatEther(driverBalance), 'ETH');
                                        
                                // Ê£ÄÊü•‰∫§ÊòìËØ¶ÊÉÖÔºåÈ™åËØÅËΩ¨Ë¥¶ÊòØÂê¶ÁúüÁöÑÂèëÁîü‰∫Ü
                                try {
                                    const txReceipt = await window.provider.getTransactionReceipt(tx.hash);
                                    if (txReceipt && txReceipt.status === 1) {
                                        console.log('  ‚úÖ ‰∫§ÊòìÂ∑≤ÊàêÂäüÁ°ÆËÆ§');
                                        
                                        // Ê£ÄÊü•‰∫§Êòì‰∏≠ÁöÑËΩ¨Ë¥¶ËÆ∞ÂΩï
                                        const txDetails = await window.provider.getTransaction(tx.hash);
                                        console.log('  üìã ‰∫§ÊòìËØ¶ÊÉÖ:');
                                        console.log('    ‰∫§ÊòìÂìàÂ∏å:', tx.hash);
                                        console.log('    Âå∫ÂùóÂè∑:', txReceipt.blockNumber);
                                        console.log('    Gas ‰ΩøÁî®Èáè:', txReceipt.gasUsed.toString());
                                        console.log('    ‰∫§ÊòìÁä∂ÊÄÅ: ÊàêÂäü');
                                        
                                        // Ê£ÄÊü•Âè∏Êú∫ÁöÑÂéÜÂè≤‰ΩôÈ¢ùÂèòÂåñÔºàÈÄöËøáÊü•ËØ¢Â§ö‰∏™Âå∫ÂùóÔºâ
                                        try {
                                            console.log('  üîç Ê£ÄÊü•Âè∏Êú∫‰ΩôÈ¢ùÂèòÂåñ...');
                                            const currentBlock = await window.provider.getBlockNumber();
                                            const settlementBlock = txReceipt.blockNumber;
                                            
                                            // Âú®ÁªìÁÆóÂå∫ÂùóÂâçÂêéÊü•ËØ¢‰ΩôÈ¢ù
                                            const balanceBeforeBlock = Math.max(0, settlementBlock - 1);
                                            const balanceAfterBlock = Math.min(currentBlock, settlementBlock + 1);
                                            
                                            // Ëé∑ÂèñÂå∫ÂùóÊó∂Èó¥Êà≥
                                            const blockBefore = await window.provider.getBlock(balanceBeforeBlock);
                                            const blockAfter = await window.provider.getBlock(balanceAfterBlock);
                                            
                                            // Ê≥®ÊÑèÔºöÊàë‰ª¨Êó†Ê≥ïÁõ¥Êé•Êü•ËØ¢ÂéÜÂè≤‰ΩôÈ¢ùÔºå‰ΩÜÂèØ‰ª•È™åËØÅÂΩìÂâç‰ΩôÈ¢ù
                                            const currentBalance = await window.provider.getBalance(driverAddress);
                                            console.log('    Âè∏Êú∫ÂΩìÂâç‰ΩôÈ¢ù:', ethers.utils.formatEther(currentBalance), 'ETH');
                                            console.log('    Â∫îËØ•Êî∂Âà∞ÁöÑÈáëÈ¢ù:', ethers.utils.formatEther(driverAmount), 'ETH');
                                            
                                            // ËÆ°ÁÆóÈ¢ÑÊúüÁöÑ‰ΩôÈ¢ù
                                            const expectedBalance = currentBalance.add(driverAmount);
                                            console.log('    È¢ÑÊúü‰ΩôÈ¢ùÔºàÂ¶ÇÊûúÊî∂Âà∞Ôºâ:', ethers.utils.formatEther(expectedBalance), 'ETH');
                                            
                                            // Ê£ÄÊü•ËΩ¨Ë¥¶Êó•ÂøóÔºàÈÄöËøá‰∫ã‰ª∂ÁöÑ topics Âíå dataÔºâ
                                            console.log('  üìã ËΩ¨Ë¥¶È™åËØÅÔºö');
                                            console.log('    Â¶ÇÊûúÂè∏Êú∫‰ΩôÈ¢ùÂ¢ûÂä†‰∫Ü', ethers.utils.formatEther(driverAmount), 'ETHÔºåËØ¥ÊòéËΩ¨Ë¥¶ÊàêÂäü');
                                            console.log('    üí° Ê≥®ÊÑèÔºöMetaMask ÂèØËÉΩ‰∏çÊòæÁ§∫ÂêàÁ∫¶ÂÜÖÈÉ®ËΩ¨Ë¥¶ÁöÑËÆ∞ÂΩï');
                                            console.log('    üí° ËØ∑Áõ¥Êé•Ê£ÄÊü•Âè∏Êú∫Èí±ÂåÖÁöÑ‰ΩôÈ¢ùÂèòÂåñÔºåËÄå‰∏çÊòØ‰∫§ÊòìËÆ∞ÂΩï');
                                            
                                        } catch (balanceCheckError) {
                                            console.warn('‚ö†Ô∏è Êó†Ê≥ïÊ£ÄÊü•‰ΩôÈ¢ùÂèòÂåñ:', balanceCheckError);
                                        }
                                        
                                        // ÊèêÁ§∫‰ø°ÊÅØ
                                        const tips = isZh 
                                            ? `\nüí° ÈáçË¶ÅÊèêÁ§∫Ôºö\n\n1. MetaMask ÈÄöÂ∏∏‰∏çÊòæÁ§∫ÂêàÁ∫¶ÂÜÖÈÉ®ËΩ¨Ë¥¶ÁöÑ‰∫§ÊòìËÆ∞ÂΩï\n2. Âç≥‰ΩøËΩ¨Ë¥¶ÊàêÂäüÔºåÂè∏Êú∫Âú® MetaMask ÁöÑ‰∫§ÊòìÂéÜÂè≤‰∏≠ÂèØËÉΩÁúã‰∏çÂà∞\n3. ËØ∑Áõ¥Êé•Ê£ÄÊü•Âè∏Êú∫Èí±ÂåÖÁöÑ‰ΩôÈ¢ùÊòØÂê¶Â¢ûÂä†‰∫Ü ${ethers.utils.formatEther(driverAmount)} ETH\n4. Â¶ÇÊûú‰ΩôÈ¢ùÂ¢ûÂä†‰∫ÜÔºåËØ¥ÊòéËΩ¨Ë¥¶ÊàêÂäü\n\nÈ™åËØÅÊñπÊ≥ïÔºö\n- ËÆ∞ÂΩïËΩ¨Ë¥¶ÂâçÁöÑ‰ΩôÈ¢ù\n- ËÆ∞ÂΩïËΩ¨Ë¥¶ÂêéÁöÑ‰ΩôÈ¢ù\n- Ê£ÄÊü•‰ΩôÈ¢ùÊòØÂê¶Â¢ûÂä†‰∫Ü ${ethers.utils.formatEther(driverAmount)} ETH\n\nÂ¶ÇÊûú‰ΩôÈ¢ùÊ≤°ÊúâÂ¢ûÂä†ÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëòÊ£ÄÊü•‰∫§Êòì„ÄÇ`
                                            : `\nüí° Important Note:\n\n1. MetaMask usually doesn't show internal contract transfer records\n2. Even if transfer succeeds, driver may not see it in MetaMask transaction history\n3. Please directly check if driver wallet balance increased by ${ethers.utils.formatEther(driverAmount)} ETH\n4. If balance increased, transfer was successful\n\nVerification method:\n- Record balance before transfer\n- Record balance after transfer\n- Check if balance increased by ${ethers.utils.formatEther(driverAmount)} ETH\n\nIf balance didn't increase, please contact administrator to check transaction.`;
                                        console.log(tips);
                                        
                                        // ÊòæÁ§∫ËØ¶ÁªÜÊèêÁ§∫ÁªôÁî®Êà∑
                                        const detailedMsg = isZh 
                                            ? `‚úÖ ÁªìÁÆóÊàêÂäüÔºÅ\n\nËΩ¨Ë¥¶ËØ¶ÊÉÖÔºö\nÂè∏Êú∫Âú∞ÂùÄ: ${driverAddress}\nÂè∏Êú∫ÈáëÈ¢ù: ${ethers.utils.formatEther(driverAmount)} ETH\n‰∫§ÊòìÂìàÂ∏å: ${tx.hash}\nÂå∫ÂùóÂè∑: ${txReceipt.blockNumber}\n\n‚ö†Ô∏è ÈáçË¶ÅÊèêÁ§∫Ôºö\nMetaMask ÂèØËÉΩ‰∏çÊòæÁ§∫ÂêàÁ∫¶ÂÜÖÈÉ®ËΩ¨Ë¥¶ÁöÑ‰∫§ÊòìËÆ∞ÂΩï„ÄÇ\nËØ∑Áõ¥Êé•Ê£ÄÊü•Âè∏Êú∫Èí±ÂåÖ‰ΩôÈ¢ùÊòØÂê¶Â¢ûÂä†‰∫Ü ${ethers.utils.formatEther(driverAmount)} ETH„ÄÇ\n\nÂ¶ÇÊûú‰ΩôÈ¢ùÂ¢ûÂä†‰∫ÜÔºåËØ¥ÊòéËΩ¨Ë¥¶ÊàêÂäü„ÄÇ`
                                            : `‚úÖ Settlement successful!\n\nTransfer details:\nDriver address: ${driverAddress}\nDriver amount: ${ethers.utils.formatEther(driverAmount)} ETH\nTransaction hash: ${tx.hash}\nBlock number: ${txReceipt.blockNumber}\n\n‚ö†Ô∏è Important:\nMetaMask may not show internal contract transfer records.\nPlease directly check if driver wallet balance increased by ${ethers.utils.formatEther(driverAmount)} ETH.\n\nIf balance increased, transfer was successful.`;
                                        console.log(detailedMsg);
                                        alert(detailedMsg);
                                    } else {
                                        console.error('  ‚ùå ‰∫§ÊòìÁä∂ÊÄÅÂºÇÂ∏∏ÔºÅ');
                                    }
                                } catch (txError) {
                                    console.warn('‚ö†Ô∏è Êó†Ê≥ïËé∑Âèñ‰∫§ÊòìËØ¶ÊÉÖ:', txError);
                                }
                                    }
                                } catch (balanceCheckError) {
                                    console.warn('‚ö†Ô∏è Êó†Ê≥ïÊ£ÄÊü•Âè∏Êú∫‰ΩôÈ¢ù:', balanceCheckError);
                                }
                            } else {
                                console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ PaymentReleased ‰∫ã‰ª∂Ôºå‰ΩÜËÆ¢ÂçïÁä∂ÊÄÅÊòæÁ§∫Â∑≤ÁªìÁÆó');
                                console.warn('  ËøôÂèØËÉΩË°®Á§∫ËΩ¨Ë¥¶ÊúâÈóÆÈ¢òÔºåËØ∑Ê£ÄÊü•‰∫§ÊòìËØ¶ÊÉÖ');
                            }
                        } catch (orderError) {
                            console.warn('‚ö†Ô∏è Êó†Ê≥ïËé∑ÂèñÁªìÁÆóÂêéÁöÑËÆ¢ÂçïÁä∂ÊÄÅ:', orderError);
                        }
                        
                    } catch (waitError) {
                        console.error('‚ùå Á≠âÂæÖ settle ‰∫§ÊòìÁ°ÆËÆ§Â§±Ë¥•:', waitError);
                        throw waitError;
                    }
                } else {
                    // Â¶ÇÊûúËÆ¢ÂçïÊòØ PickedUpÔºåË∞ÉÁî® completeOrder ÂáΩÊï∞
                    // ‰ΩøÁî® estimatedFare ‰Ωú‰∏∫ actualFareÔºà‰Ωú‰∏∫Âà∞ÊúüÊ®°ÊãüÔºâ
                    const actualFare = order.estimatedFare;
                    const actualFareETH = ethers.utils.formatEther(actualFare);
                    
                    const confirmText = isZh 
                        ? `Á°ÆËÆ§ÂÆåÊàêËÆ¢Âçï #${orderId}Ôºü\n\nËÆ¢ÂçïÈáëÈ¢ù: ${actualFareETH} ETH\n\nÂÆåÊàêÂêéÂ∞ÜËá™Âä®ÁªìÁÆóËµÑÈáëÁªôÂè∏Êú∫„ÄÇ`
                        : `Confirm completing order #${orderId}?\n\nOrder amount: ${actualFareETH} ETH\n\nFunds will be automatically settled to the driver.`;
                    
                    if (!confirm(confirmText)) {
                        console.log('Áî®Êà∑ÂèñÊ∂à‰∫ÜÂÆåÊàêËÆ¢ÂçïÊìç‰Ωú');
                        return;
                    }
                    
                    console.log('üì§ Ë∞ÉÁî® completeOrder ÂáΩÊï∞Ôºà‰Ωú‰∏∫Âà∞ÊúüÊ®°ÊãüÔºâ...');
                    try {
                        tx = await window.contracts.rideOrder.completeOrder(orderId, actualFare);
                        console.log('‚úÖ completeOrder ‰∫§ÊòìÂ∑≤ÂèëÈÄÅÔºåÂìàÂ∏å:', tx.hash);
                    } catch (completeError) {
                        console.error('‚ùå Ë∞ÉÁî® completeOrder Â§±Ë¥•:', completeError);
                        const errorMsg = completeError?.message || completeError?.reason || completeError?.toString() || 'Unknown error';
                        alert((isZh ? 'ÂÆåÊàêËÆ¢ÂçïÂ§±Ë¥•: ' : 'Failed to complete order: ') + errorMsg);
                        return;
                    }
                    
                    const statusEl = document.getElementById('wallet-status');
                    if (statusEl) {
                        statusEl.className = 'status info';
                        statusEl.textContent = isZh 
                            ? `‰∫§ÊòìÂ∑≤Êèê‰∫§ÔºåÁ≠âÂæÖÁ°ÆËÆ§... (Hash: ${tx.hash.substring(0, 10)}...)`
                            : `Transaction submitted, waiting for confirmation... (Hash: ${tx.hash.substring(0, 10)}...)`;
                    }
                    
                    // Á≠âÂæÖ‰∫§ÊòìÁ°ÆËÆ§
                    console.log('‚è≥ Á≠âÂæÖ completeOrder ‰∫§ÊòìÁ°ÆËÆ§...');
                    let receipt;
                    try {
                        receipt = await tx.wait();
                        console.log('‚úÖ completeOrder ‰∫§ÊòìÂ∑≤Á°ÆËÆ§ÔºåÂå∫ÂùóÂè∑:', receipt.blockNumber);
                        console.log('üìã ‰∫§ÊòìÂõûÊâß‰∏≠ÁöÑÊâÄÊúâ‰∫ã‰ª∂:', receipt.events?.map(e => e.event) || []);
                        
                        // Ê£ÄÊü• PaymentReleased ‰∫ã‰ª∂
                        const paymentReleasedEvent = receipt.events?.find(e => e.event === 'PaymentReleased');
                        if (paymentReleasedEvent) {
                            const driverAmount = paymentReleasedEvent.args.driverAmount;
                            const platformFee = paymentReleasedEvent.args.platformFee;
                            console.log('‚úÖ PaymentReleased ‰∫ã‰ª∂Â∑≤ÂèëÂá∫:');
                            console.log('  ËÆ¢ÂçïID:', paymentReleasedEvent.args.orderId.toString());
                            console.log('  Âè∏Êú∫Âú∞ÂùÄ:', paymentReleasedEvent.args.driver);
                            console.log('  Âè∏Êú∫ÈáëÈ¢ù:', ethers.utils.formatEther(driverAmount), 'ETH');
                            console.log('  Âπ≥Âè∞Ë¥πÁî®:', ethers.utils.formatEther(platformFee), 'ETH');
                        } else {
                            console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ PaymentReleased ‰∫ã‰ª∂ÔºàcompleteOrder ÂèØËÉΩÂ∑≤Ëá™Âä®ÁªìÁÆóÔºâ');
                        }
                    } catch (waitError) {
                        console.error('‚ùå Á≠âÂæÖ completeOrder ‰∫§ÊòìÁ°ÆËÆ§Â§±Ë¥•:', waitError);
                        throw waitError;
                    }
                }
                
                // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØÔºàÂè™ÊúâÂú®‰∏§‰∏™ÂàÜÊîØÈÉΩÊàêÂäüÊó∂ÊâçÊòæÁ§∫Ôºâ
                if (tx && typeof receipt !== 'undefined') {
                    const successMsg = isZh 
                        ? `‚úÖ Êìç‰ΩúÊàêÂäüÔºÅ\n\n‰∫§ÊòìÂìàÂ∏å: ${tx.hash}\nÂå∫ÂùóÂè∑: ${receipt.blockNumber}\n\nÂ¶ÇÊûúËøôÊòØ settle Êìç‰ΩúÔºåËµÑÈáëÂ∑≤ÂàÜÈÖçÁªôÂè∏Êú∫ÂíåÂπ≥Âè∞„ÄÇËØ∑Ê£ÄÊü•Âè∏Êú∫Á´Ø‰ΩôÈ¢ùÊòØÂê¶Êõ¥Êñ∞„ÄÇ`
                        : `‚úÖ Operation successful!\n\nTransaction hash: ${tx.hash}\nBlock number: ${receipt.blockNumber}\n\nIf this was a settle operation, funds have been distributed to the driver and platform. Please check if the driver's balance has been updated.`;
                    console.log(successMsg);
                    alert(successMsg);
                } else if (tx) {
                    // Â¶ÇÊûúÂè™Êúâ tx ‰ΩÜÊ≤°Êúâ receiptÔºåËØ¥ÊòéÂèØËÉΩËøòÂú®Á≠âÂæÖÁ°ÆËÆ§
                    console.log('‚úÖ ‰∫§ÊòìÂ∑≤ÂèëÈÄÅÔºåÁ≠âÂæÖÁ°ÆËÆ§‰∏≠...');
                }
                
                // Á≠âÂæÖ‰ΩôÈ¢ùÊõ¥Êñ∞
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Ëé∑Âèñ‰πòÂÆ¢Ë¥¶Êà∑‰ΩôÈ¢ùÔºà‰∫§ÊòìÂêéÔºâ
                let passengerBalanceAfter = null;
                try {
                    if (window.account && window.provider) {
                        passengerBalanceAfter = await window.provider.getBalance(window.account);
                        console.log('üí∞ ‰πòÂÆ¢‰∫§ÊòìÂêé‰ΩôÈ¢ù:', ethers.utils.formatEther(passengerBalanceAfter), 'ETH');
                        
                        if (passengerBalanceBefore) {
                            const balanceDiff = passengerBalanceAfter.sub(passengerBalanceBefore);
                            const balanceDiffETH = ethers.utils.formatEther(balanceDiff);
                            console.log('üìä ‰ΩôÈ¢ùÂèòÂåñ:', balanceDiffETH, 'ETH');
                            
                            if (balanceDiff.lt(0)) {
                                console.log('‚ö†Ô∏è ‰ΩôÈ¢ùÂáèÂ∞ëÔºàËøôÊòØÊ≠£Â∏∏ÁöÑÔºåÂõ†‰∏∫ËÆ¢ÂçïÈáëÈ¢ùÂ∑≤ÈîÅÂÆöÂú®ÂêàÁ∫¶‰∏≠Ôºâ');
                            }
                        }
                    }
                } catch (balanceError) {
                    console.warn('‚ö†Ô∏è Êó†Ê≥ïËé∑Âèñ‰∫§ÊòìÂêé‰ΩôÈ¢ù:', balanceError);
                }
                
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                
                const successMsg = isZh 
                    ? `ËÆ¢Âçï #${orderId} Â∑≤ÂÆåÊàêÂπ∂Â∑≤ÁªìÁÆóÔºÅ\n\nËµÑÈáëÂ∑≤Ëá™Âä®ËΩ¨ÁªôÂè∏Êú∫„ÄÇ`
                    : `Order #${orderId} completed and settled!\n\nFunds have been automatically transferred to the driver.`;
                
                if (statusEl) {
                    statusEl.className = 'status success';
                    statusEl.textContent = successMsg;
                }
                
                alert(successMsg);
                
                // Âà∑Êñ∞ËÆ¢ÂçïÂàóË°®
                if (typeof window.loadOrders === 'function') {
                    setTimeout(() => {
                        window.loadOrders();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('‚ùå ÂÆåÊàêËÆ¢ÂçïÂ§±Ë¥•:', error);
                const errorMsg = error.reason || error.message || 'Unknown error';
                
                // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
                alert(isZh ? `ÂÆåÊàêËÆ¢ÂçïÂ§±Ë¥•: ${errorMsg}` : `Failed to complete order: ${errorMsg}`);
            }
        };
        
        // ÊòæÁ§∫Èí±ÂåÖ‰ø°ÊÅØ
        window.showWalletInfo = function() {
            if (window.account) {
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                alert(`${isZh ? 'Èí±ÂåÖÂú∞ÂùÄ' : 'Wallet Address'}:\n${window.account}\n\n${isZh ? 'ÊÇ®ÂèØ‰ª•Â§çÂà∂Ê≠§Âú∞ÂùÄ‰∏é‰ªñ‰∫∫ÂàÜ‰∫´„ÄÇ' : 'You can copy this address to share it with others.'}`);
            } else {
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                alert(isZh ? 'ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ' : 'Please connect wallet first');
            }
        };
        
        // ÊòæÁ§∫ÁΩëÁªú‰ø°ÊÅØ
        window.showNetworkInfo = async function() {
            try {
                if (window.provider) {
                    const network = await window.provider.getNetwork();
                    const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                    alert(`${isZh ? 'ÁΩëÁªú‰ø°ÊÅØ' : 'Network Information'}:\n\n${isZh ? 'ÈìæID' : 'Chain ID'}: ${network.chainId}\n${isZh ? 'ÁΩëÁªúÂêçÁß∞' : 'Network Name'}: ${network.name}`);
                } else {
                    const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                    alert(isZh ? 'Êó†Ê≥ïËé∑ÂèñÁΩëÁªú‰ø°ÊÅØÔºåËØ∑ÂÖàËøûÊé•Èí±ÂåÖ' : 'Failed to get network information, please connect wallet first');
                }
            } catch (error) {
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                alert(`${isZh ? 'Ëé∑ÂèñÁΩëÁªú‰ø°ÊÅØÂ§±Ë¥•' : 'Failed to get network information'}: ${error.message}`);
            }
        };
        
        // ÂàáÊç¢Ë¥¶Êà∑
        window.switchAccount = async function() {
            if (typeof window.ethereum === 'undefined') {
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                alert(isZh ? 'MetaMaskÊú™ÂÆâË£ÖÔºÅ' : 'MetaMask is not installed!');
                return;
            }
            
            try {
                // ËØ∑Ê±ÇÂàáÊç¢Ë¥¶Êà∑ÔºàMetaMask‰ºöÊòæÁ§∫Ë¥¶Êà∑ÈÄâÊã©ÁïåÈù¢Ôºâ
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                // Ë¥¶Êà∑ÂàáÊç¢ÂêéÔºåethereum‰ºöËß¶ÂèëaccountsChanged‰∫ã‰ª∂ÔºåÈ°µÈù¢‰ºöËá™Âä®Âà∑Êñ∞
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                alert(isZh ? 'Ë¥¶Êà∑ÂàáÊç¢ÊàêÂäüÔºåÈ°µÈù¢Â∞ÜÂà∑Êñ∞' : 'Account switched successfully, page will refresh');
                location.reload();
            } catch (error) {
                const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
                alert(`${isZh ? 'ÂàáÊç¢Ë¥¶Êà∑Â§±Ë¥•' : 'Failed to switch account'}: ${error.message}`);
            }
        };
        
        // ÁîüÊàêÊ®°ÊãüÁî®Êà∑ÊòµÁß∞ÂíåÊâãÊú∫Âè∑Á†Å
        function generateMockUserInfo() {
            const mockNicknames = [
                'Âº†‰∏â', 'ÊùéÂõõ', 'Áéã‰∫î', 'ËµµÂÖ≠', 'Èí±‰∏É', 'Â≠ôÂÖ´', 'Âë®‰πù', 'Âê¥ÂçÅ',
                'Alice', 'Bob', 'Charlie', 'Diana', 'Edward', 'Fiona', 'George', 'Helen'
            ];
            const mockPhones = [
                '13800138000', '13900139000', '15000150000', '15100151000',
                '18800188000', '18900189000', '13600136000', '13700137000'
            ];
            
            const randomNickname = mockNicknames[Math.floor(Math.random() * mockNicknames.length)];
            const randomPhone = mockPhones[Math.floor(Math.random() * mockPhones.length)];
            
            return {
                nickname: randomNickname,
                phone: randomPhone
            };
        }
        
        // Âú®ÂàõÂª∫ËÆ¢ÂçïÊó∂Ëá™Âä®ÁîüÊàêÊ®°ÊãüÁî®Êà∑‰ø°ÊÅØÔºàÂ¶ÇÊûúÊú™ËÆæÁΩÆÔºâ
        window.generateMockUserInfo = generateMockUserInfo;
        
        // Êõ¥Êñ∞ SubCategory ÈÄâÈ°πÁöÑÂáΩÊï∞ÔºàÊ†πÊçÆÈÄâÊã©ÁöÑ CategoryÔºâ
        window.updateSubCategoryOptions = function() {
            const categorySelect = document.getElementById('category-select');
            const subCategorySelect = document.getElementById('subcategory-select');
            
            if (!categorySelect || !subCategorySelect) return;
            
            const selectedCategory = categorySelect.value;
            const isZh = (typeof i18n !== 'undefined' && i18n.currentLang === 'zh');
            
            // ‰øùÂ≠òÂΩìÂâçÈÄâ‰∏≠ÁöÑÂÄºÔºàÂ¶ÇÊûúÊúâÔºâ
            const currentValue = subCategorySelect.value;
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
            subCategorySelect.innerHTML = '';
            
            // Ê†πÊçÆÈÄâÊã©ÁöÑ Category ËÆæÁΩÆ SubCategory ÈÄâÈ°π
            let options = [];
            if (selectedCategory === 'rental') {
                options = [
                    { value: 'rental car', label: isZh ? 'Ê±ΩËΩ¶' : 'Car' },
                    { value: 'rental scooter', label: isZh ? 'ÊªëÊùøËΩ¶' : 'Scooter' }
                ];
            } else if (selectedCategory === 'goods') {
                options = [
                    { value: 'electronics', label: isZh ? 'ÁîµÂ≠ê‰∫ßÂìÅ' : 'Electronics' }
                ];
            } else if (selectedCategory === 'services') {
                options = [
                    { value: 'travel assistant', label: isZh ? 'ÊóÖË°åÂä©Êâã' : 'Travel Assistant' }
                ];
            }
            
            // Ê∑ªÂä†ÈÄâÈ°π
            options.forEach((opt, index) => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.label;
                // Â¶ÇÊûúÊòØÁ¨¨‰∏Ä‰∏™ÈÄâÈ°πÔºåÊàñÂΩìÂâçÂÄº‰∏éÈÄâÈ°πÂÄºÂåπÈÖçÔºåÂàôÈÄâ‰∏≠
                if (index === 0 || opt.value === currentValue) {
                    option.selected = true;
                }
                subCategorySelect.appendChild(option);
            });
        };
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        window.addEventListener('load', async () => {
            // ÂàùÂßãÂåñi18n
            i18n.updatePage();
            
            // ÁªëÂÆöËøûÊé•Èí±ÂåÖÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
            const connectBtn = document.getElementById('connect-btn');
            if (connectBtn) {
                connectBtn.addEventListener('click', async () => {
                    if (typeof window.connectWallet === 'function') {
                        try {
                            await window.connectWallet();
                        } catch (err) {
                            console.error('connectWallet error:', err);
                        }
                    } else {
                        console.error('connectWallet not available yet');
                        alert('Please wait, wallet connection is initializing...');
                    }
                });
            }

            // ÂàùÂßãÂåñ Catalog Âíå SubCatalog ÈÄâÈ°π
            if (typeof updateSubCategoryOptions === 'function') {
                updateSubCategoryOptions();
            }
            
            // ËÆæÁΩÆÂΩìÂâçËØ≠Ë®ÄÊòæÁ§∫
            const currentLang = i18n.currentLang;
            document.getElementById('current-lang').textContent = currentLang === 'en' ? 'EN' : '‰∏≠Êñá';
            
            // Êõ¥Êñ∞ËØ≠Ë®ÄÈÄâÈ°πÁä∂ÊÄÅ
            document.querySelectorAll('.lang-option').forEach(opt => {
                opt.classList.remove('active');
            });
            document.getElementById(`lang-option-${currentLang}`).classList.add('active');
            
            // Êõ¥Êñ∞ÈÄâ‰∏≠Ê†áËÆ∞
            document.getElementById('lang-check-en').style.display = currentLang === 'en' ? 'inline' : 'none';
            document.getElementById('lang-check-zh').style.display = currentLang === 'zh' ? 'inline' : 'none';
            
            // Ê£ÄÊµãÁßªÂä®ËÆæÂ§áÂπ∂ÊòæÁ§∫ÊèêÁ§∫
            const isMobile = isMobileDevice();
            if (isMobile) {
                document.getElementById('mobile-wallet-guide').style.display = 'block';
            }
            
            // Á≠âÂæÖÈí±ÂåÖÊ≥®ÂÖ•ÔºàÊó†ËÆ∫ÁßªÂä®Á´ØËøòÊòØÊ°åÈù¢Á´ØÔºåÊúâÊó∂ÈÉΩÈúÄË¶ÅÁ≠âÂæÖÔºâ
            console.log('üîç Initial wallet check...');
            const initialCheck = isWalletAvailable();
            
            if (!initialCheck) {
                console.log('‚è≥ Wallet not immediately available, waiting on page load...');
                const walletAvailable = await waitForWallet(5000); // È°µÈù¢Âä†ËΩΩÊó∂Á≠âÂæÖ5Áßí
                if (!walletAvailable) {
                    const isMobile = isMobileDevice();
                    document.getElementById('wallet-status').className = 'status info';
                    document.getElementById('wallet-status').innerHTML = `
                        <strong>${isMobile ? 'üì±' : 'üíª'} Wallet Detection</strong><br>
                        <p style="margin-top: 10px;">Wallet not detected. Please:</p>
                        <ol style="margin-left: 20px; margin-top: 10px; font-size: 0.9em;">
                            ${isMobile 
                                ? '<li>Use <strong>MetaMask Mobile</strong> built-in browser (recommended)</li><li>Or refresh this page after opening MetaMask</li><li>Make sure MetaMask is unlocked</li>'
                                : '<li>Make sure <strong>MetaMask extension</strong> is installed and enabled</li><li>Refresh this page (F5 or Ctrl+R)</li><li>Check if MetaMask is unlocked</li><li>Try disabling other wallet extensions</li>'
                            }
                        </ol>
                        <p style="margin-top: 10px; font-size: 0.85em; color: #666;">
                            Check browser console (F12) for detailed debug info.
                        </p>
                    `;
                }
            }
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ËøûÊé•Èí±ÂåÖ
            if (isWalletAvailable()) {
                try {
                    console.log('üîç Checking existing wallet connection...');
                    const ethereum = window.ethereum || window.web3?.currentProvider;
                    if (ethereum) {
                        console.log('  - Requesting existing accounts...');
                        const accounts = await ethereum.request({ method: 'eth_accounts' });
                        console.log('  - Existing accounts:', accounts);
                        if (accounts && accounts.length > 0) {
                            console.log('‚úì Found existing connection, auto-connecting...');
                            // Ëá™Âä®ËøûÊé•
                            account = accounts[0];
                            // Á°Æ‰øùËÆæÁΩÆ window.account
                            window.account = account;
                            provider = new ethers.providers.Web3Provider(ethereum);
                            signer = provider.getSigner();
                            // Á°Æ‰øùËÆæÁΩÆ window.provider Âíå window.signer
                            window.provider = provider;
                            window.signer = signer;
                            
                            // Êõ¥Êñ∞ËèúÂçï‰∏≠ÁöÑËøûÊé•Áä∂ÊÄÅ
                            const menuConnectionStatus = document.getElementById('menu-connection-status');
                            const menuConnectionText = document.getElementById('menu-connection-text');
                            const connectedText = i18n.t('connected');
                            if (menuConnectionStatus && menuConnectionText) {
                                menuConnectionStatus.style.display = 'block';
                                menuConnectionText.textContent = connectedText;
                            }
                            
                            // Êõ¥Êñ∞ËèúÂçï‰∏≠ÁöÑË¥¶Êà∑‰ø°ÊÅØ
                            const menuAccountInfo = document.getElementById('menu-account-info');
                            const menuAccountAddress = document.getElementById('menu-account-address');
                            if (menuAccountInfo && menuAccountAddress) {
                                menuAccountInfo.style.display = 'block';
                                menuAccountAddress.textContent = account.substring(0, 6) + '...' + account.substring(38);
                            }
                            
                            // ËøûÊé•ÊàêÂäüÂêéÈöêËóèwallet-statusÔºàÁä∂ÊÄÅÂ∑≤ÁßªÂà∞ËèúÂçï‰∏≠Ôºâ
                            const walletStatusEl = document.getElementById('wallet-status');
                            if (walletStatusEl) {
                                walletStatusEl.style.display = 'none';
                            }
                            document.getElementById('connect-btn').textContent = i18n.t('connected');
                            document.getElementById('connect-btn').disabled = true;
                            document.getElementById('order-form-section').style.display = 'block';
                            document.getElementById('mobile-wallet-guide').style.display = 'none';
                            
                            await initializeContracts();
                            await loadContractAddresses();
                            
                            // ËøûÊé•Èí±ÂåÖÊàêÂäüÂêéÔºåÂ¶ÇÊûúÂΩìÂâçÂú® Orders ËßÜÂõæÔºåËá™Âä®Âä†ËΩΩÂéÜÂè≤ËÆ¢Âçï
                            const ordersView = document.getElementById('orders-view');
                            if (ordersView && ordersView.style.display !== 'none') {
                                console.log('üìã Ê£ÄÊµãÂà∞Âú® Orders ËßÜÂõæÔºåËá™Âä®Âä†ËΩΩÂéÜÂè≤ËÆ¢Âçï...');
                                setTimeout(() => {
                                    if (window.loadOrders) {
                                        window.loadOrders();
                                    }
                                }, 500);
                            }
                        }
                    }
                } catch (error) {
                    console.log('Ê£ÄÊü•Èí±ÂåÖËøûÊé•Â§±Ë¥•:', error);
                    // ‰∏çÊòæÁ§∫ÈîôËØØÔºåËÆ©Áî®Êà∑ÊâãÂä®ËøûÊé•
                }
            }
            
            // È°µÈù¢Âä†ËΩΩÊó∂ÔºåÂ¶ÇÊûúÂ∑≤ËøûÊé•Èí±ÂåÖ‰∏îÂêàÁ∫¶Â∑≤ÂàùÂßãÂåñÔºåËá™Âä®Âä†ËΩΩÂéÜÂè≤ËÆ¢Âçï
            window.addEventListener('load', () => {
                setTimeout(async () => {
                    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ËøûÊé•Èí±ÂåÖ
                    if (window.account && window.contracts && window.contracts.rideOrder) {
                        console.log('üìã È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÊ£ÄÊµãÂà∞Â∑≤ËøûÊé•Èí±ÂåÖÔºåËá™Âä®Âä†ËΩΩÂéÜÂè≤ËÆ¢Âçï...');
                        
                        // Â¶ÇÊûúÂΩìÂâçÂú® Orders ËßÜÂõæÔºåÁõ¥Êé•Âä†ËΩΩ
                        const ordersView = document.getElementById('orders-view');
                        if (ordersView && ordersView.style.display !== 'none') {
                            if (window.loadOrders) {
                                await window.loadOrders();
                            }
                        } else {
                            // Â¶ÇÊûú‰∏çÂú® Orders ËßÜÂõæÔºåÂÖàÊ£ÄÊü• localStorage ÊòØÂê¶‰øùÂ≠ò‰∫Ü‰∏äÊ¨°ÁöÑËßÜÂõæÁä∂ÊÄÅ
                            const lastView = localStorage.getItem('lastActiveView');
                            if (lastView === 'orders') {
                                // Â¶ÇÊûú‰∏äÊ¨°Âú® Orders ËßÜÂõæÔºåÂàáÊç¢Âà∞ËØ•ËßÜÂõæÂπ∂Âä†ËΩΩËÆ¢Âçï
                                if (window.showOrdersView) {
                                    window.showOrdersView();
                                    setTimeout(() => {
                                        if (window.loadOrders) {
                                            window.loadOrders();
                                        }
                                    }, 300);
                                }
                            }
                        }
                    }
                }, 1000);
            });
        });
        
        // ÁõëÂê¨Ë¥¶Êà∑ÂàáÊç¢ÂíåÁΩëÁªúÂèòÂåñ
        function setupWalletListeners() {
            // Âª∂ËøüËÆæÁΩÆÁõëÂê¨Âô®ÔºåÁ°Æ‰øùethereumÂØπË±°Â∑≤Âä†ËΩΩ
            if (typeof window.ethereum !== 'undefined') {
                console.log('‚úì Setting up wallet event listeners');
                
                // ÁõëÂê¨Ë¥¶Êà∑ÂàáÊç¢
                window.ethereum.on('accountsChanged', (accounts) => {
                    console.log('üîÑ Accounts changed:', accounts);
                    if (accounts.length === 0) {
                        // Áî®Êà∑Êñ≠ÂºÄËøûÊé•
                        console.log('  - User disconnected, reloading...');
                        location.reload();
                    } else {
                        // Ë¥¶Êà∑ÂàáÊç¢
                        console.log('  - Account switched, reconnecting...');
                        if (typeof window.connectWallet === 'function') {
                            window.connectWallet();
                        }
                    }
                });
                
                // ÁõëÂê¨ÁΩëÁªúÂàáÊç¢
                window.ethereum.on('chainChanged', (chainId) => {
                    console.log('üîó Chain changed:', chainId);
                    // ÁΩëÁªúÂàáÊç¢Êó∂ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢
                    location.reload();
                });
            } else {
                // Â¶ÇÊûúethereumËøòÊ≤°Âä†ËΩΩÔºåÂª∂ËøüÈáçËØï
                console.log('‚è≥ Ethereum not ready, retrying in 1s...');
                setTimeout(setupWalletListeners, 1000);
            }
        }
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéËÆæÁΩÆÁõëÂê¨Âô®
        setTimeout(setupWalletListeners, 1000);
    </script>
</body>
</html>
