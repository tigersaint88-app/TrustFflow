<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYSTEM_ARCHITECTURE.md</title>
    <style>
        @media print {
            @page {
                margin: 2cm;
            }
            body {
                font-size: 10pt;
            }
            h1 {
                font-size: 18pt;
            }
            h2 {
                font-size: 16pt;
            }
            h3 {
                font-size: 14pt;
            }
            h4 {
                font-size: 12pt;
            }
            h5 {
                font-size: 11pt;
            }
            h6 {
                font-size: 10pt;
            }
            pre {
                page-break-inside: avoid;
                font-size: 9pt;
            }
            code {
                font-size: 9pt;
            }
            h1, h2, h3 {
                page-break-after: avoid;
            }
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.5;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
            font-size: 11pt;
        }
        h1 {
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
            font-size: 24pt;
        }
        h2 {
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            margin-top: 30px;
            font-size: 20pt;
        }
        h3 {
            margin-top: 25px;
            font-size: 16pt;
        }
        h4 {
            font-size: 14pt;
        }
        h5 {
            font-size: 12pt;
        }
        h6 {
            font-size: 11pt;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #007acc;
            font-size: 0.9em;
        }
        pre code {
            background: none;
            padding: 0;
        }
        ul, ol {
            padding-left: 30px;
        }
        li {
            margin: 5px 0;
        }
        a {
            color: #007acc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        blockquote {
            border-left: 4px solid #ccc;
            margin: 0;
            padding-left: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
    </style>
</head>
<body>
<h1>TrustFlow ç³»ç»Ÿæ¶æ„è¯¦è§£</h1>

<h2>ğŸ“ æ•´ä½“æ¶æ„å›¾</h2>

<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·å±‚ (User Layer)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ ä¹˜å®¢ç«¯ App   â”‚              â”‚  å¸æœºç«¯ App  â”‚                â”‚
â”‚  â”‚ (Frontend)   â”‚              â”‚  (Frontend)   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â”‚                             â”‚                         â”‚
â”‚         â”‚ MetaMask                    â”‚ MetaMask                â”‚
â”‚         â”‚ (Web3 Provider)              â”‚ (Web3 Provider)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                             â”‚
          â”‚ ç›´æ¥è°ƒç”¨æ™ºèƒ½åˆçº¦              â”‚ ç›´æ¥è°ƒç”¨æ™ºèƒ½åˆçº¦
          â”‚                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚                             â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚        åŒºå—é“¾å±‚ (Blockchain Layer)          â”‚                 â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚                 â”‚
â”‚  â”‚  â”‚TrustFlowRide â”‚  â”‚TrustFlowEscrowâ”‚       â”‚                 â”‚
â”‚  â”‚  â”‚  (è®¢å•ç®¡ç†)   â”‚  â”‚  (æ”¯ä»˜æ‰˜ç®¡)   â”‚       â”‚                 â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                 â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚                 â”‚
â”‚  â”‚  â”‚TrustFlowUser â”‚  â”‚TrustFlowRatingâ”‚       â”‚                 â”‚
â”‚  â”‚  â”‚  (ç”¨æˆ·ç®¡ç†)   â”‚  â”‚  (è¯„ä»·ç³»ç»Ÿ)   â”‚       â”‚                 â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                 â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚                 â”‚
â”‚  â”‚  â”‚TrustFlowDisputeâ”‚                        â”‚                 â”‚
â”‚  â”‚  â”‚  (äº‰è®®å¤„ç†)   â”‚                         â”‚                 â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                                                         â”‚
â”‚         â”‚ äº‹ä»¶ç›‘å¬                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ WebSocket / HTTP API
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åç«¯æœåŠ¡å±‚ (Backend Services)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Express API Server (ç«¯å£ 3000)                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ RESTful API æ¥å£                                         â”‚  â”‚
â”‚  â”‚  â”œâ”€ è®¢å•æŸ¥è¯¢ã€ç”¨æˆ·ä¿¡æ¯ã€ä½ç½®è¿½è¸ªç­‰                           â”‚  â”‚
â”‚  â”‚  â””â”€ é™æ€æ–‡ä»¶æœåŠ¡ï¼ˆå¯é€‰ï¼Œé›†æˆå‰ç«¯ï¼‰                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  WebSocket Server (ç«¯å£ 8080)                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ å®æ—¶è®¢å•æ¨é€                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ ä½ç½®æ›´æ–°æ¨é€                                             â”‚  â”‚
â”‚  â”‚  â””â”€ è®¢å•çŠ¶æ€é€šçŸ¥                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ è®¢å•åŒ¹é…æœåŠ¡      â”‚  â”‚ ä½ç½®è·Ÿè¸ªæœåŠ¡      â”‚  â”‚ åŒºå—é“¾ç›‘å¬    â”‚  â”‚
â”‚  â”‚ TF_orderMatching â”‚  â”‚ TF_locationTrackingâ”‚  â”‚ blockchain   â”‚  â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚ Listener     â”‚  â”‚
â”‚  â”‚ - å®æ—¶å¹¿æ’­       â”‚  â”‚ - GPSè¿½è¸ª         â”‚  â”‚              â”‚  â”‚
â”‚  â”‚ - æ™ºèƒ½åŒ¹é…       â”‚  â”‚ - è·¯å¾„è®°å½•        â”‚  â”‚ - ç›‘å¬äº‹ä»¶    â”‚  â”‚
â”‚  â”‚ - è·ç¦»è®¡ç®—       â”‚  â”‚ - IPFSå­˜å‚¨        â”‚  â”‚ - æ•°æ®åŒæ­¥    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®å­˜å‚¨å±‚ (Data Storage)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚    Redis     â”‚  â”‚     IPFS     â”‚  â”‚  æ•°æ®åº“      â”‚            â”‚
â”‚  â”‚  (ç¼“å­˜/é˜Ÿåˆ—)  â”‚  â”‚  (æ–‡ä»¶å­˜å‚¨)   â”‚  â”‚ (å¯é€‰)       â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>

<h2>ğŸ¯ å„ç»„ä»¶èŒè´£è¯¦è§£</h2>

<h3>1. å‰ç«¯å±‚ (Frontend Layer)</h3>

<h4>1.1 å‰ç«¯æœåŠ¡å™¨ (<code>scripts/serveFrontend.js</code> æˆ– <code>npm run frontend</code>)</h4>

<strong>èŒè´£</strong>ï¼š
<li>âœ… æä¾›é™æ€æ–‡ä»¶æœåŠ¡ï¼ˆHTMLã€CSSã€JavaScriptï¼‰</li>
<li>âœ… ä¸å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œåªè´Ÿè´£å±•ç¤º</li>
<li>âœ… è¿è¡Œåœ¨ç‹¬ç«‹ç«¯å£ï¼ˆé»˜è®¤ 3001ï¼‰</li>

<strong>æŠ€æœ¯æ ˆ</strong>ï¼š
<li>Express.js é™æ€æ–‡ä»¶æœåŠ¡å™¨</li>
<li>çº¯HTML + JavaScriptï¼ˆæ— æ¡†æ¶ä¾èµ–ï¼‰</li>

<strong>è®¿é—®æ–¹å¼</strong>ï¼š
<pre><code>bash
npm run frontend
<h1>è®¿é—®: http://localhost:3001</h1></code></pre>

<h4>1.2 å‰ç«¯åº”ç”¨ (<code>frontend/passenger-app/index.html</code>)</h4>

<strong>èŒè´£</strong>ï¼š
<li>âœ… <strong>è®¢å•åˆ›å»º</strong>ï¼šç”¨æˆ·å¡«å†™è®¢å•ä¿¡æ¯ï¼Œé€šè¿‡MetaMaskç›´æ¥è°ƒç”¨æ™ºèƒ½åˆçº¦</li>
<li>âœ… <strong>è®¢å•é€šçŸ¥</strong>ï¼šé€šè¿‡WebSocketæ¥æ”¶åç«¯æ¨é€çš„è®¢å•çŠ¶æ€æ›´æ–°</li>
<li>âœ… <strong>é’±åŒ…è¿æ¥</strong>ï¼šé€šè¿‡MetaMaskè¿æ¥ç”¨æˆ·é’±åŒ…</li>
<li>âœ… <strong>UIå±•ç¤º</strong>ï¼šè®¢å•åˆ—è¡¨ã€è®¢å•è¯¦æƒ…ã€çŠ¶æ€æ˜¾ç¤º</li>

<strong>ä¸æ™ºèƒ½åˆçº¦çš„äº¤äº’</strong>ï¼š
<pre><code>javascript
// å‰ç«¯ç›´æ¥è°ƒç”¨æ™ºèƒ½åˆçº¦ï¼ˆé€šè¿‡MetaMaskï¼‰
const tx = await contracts.rideOrder.createOrder(
    pickupLat, pickupLng, pickupAddress,
    destLat, destLng, destAddress,
    estimatedFare
);</code></pre>

<strong>ä¸åç«¯çš„äº¤äº’</strong>ï¼š
<pre><code>javascript
// WebSocketè¿æ¥ï¼Œæ¥æ”¶å®æ—¶é€šçŸ¥
const ws = new WebSocket('ws://localhost:8080');
ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === 'order_notification') {
        // æ˜¾ç¤ºè®¢å•é€šçŸ¥
    }
};</code></pre>

---

<h3>2. åç«¯æœåŠ¡å±‚ (Backend Services)</h3>

<h4>2.1 APIæœåŠ¡å™¨ (<code>backend/api/server.js</code>)</h4>

<strong>èŒè´£</strong>ï¼š
<li>âœ… <strong>RESTful API</strong>ï¼šæä¾›HTTPæ¥å£ä¾›å‰ç«¯æŸ¥è¯¢æ•°æ®</li>
<li>âœ… <strong>æ•°æ®èšåˆ</strong>ï¼šä»åŒºå—é“¾è¯»å–æ•°æ®å¹¶æ ¼å¼åŒ–è¿”å›</li>
<li>âœ… <strong>ä¸šåŠ¡é€»è¾‘</strong>ï¼šè´¹ç”¨è®¡ç®—ã€è®¢å•æŸ¥è¯¢ã€ç”¨æˆ·ä¿¡æ¯ç­‰</li>
<li>âœ… <strong>å¯é€‰ï¼šé™æ€æ–‡ä»¶æœåŠ¡</strong>ï¼šå¯ä»¥é›†æˆå‰ç«¯ï¼ˆ<code>npm run server:full</code>ï¼‰</li>

<strong>ä¸»è¦APIç«¯ç‚¹</strong>ï¼š
<pre><code>GET  /api/orders/:orderId          - è·å–è®¢å•è¯¦æƒ…
GET  /api/users/:address/orders   - è·å–ç”¨æˆ·è®¢å•å†å²
POST /api/calculate-fare          - è®¡ç®—é¢„ä¼°è´¹ç”¨
GET  /api/available-orders        - è·å–å¯ç”¨è®¢å•ï¼ˆå¸æœºï¼‰
GET  /api/tracking/:orderId       - è·å–è¡Œç¨‹è¯¦æƒ…
GET  /health                      - å¥åº·æ£€æŸ¥</code></pre>

<strong>è®¿é—®æ–¹å¼</strong>ï¼š
<pre><code>bash
npm run server        # ä»…APIæœåŠ¡
npm run server:dev    # å¼€å‘æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡å¯ï¼‰
npm run server:full   # API + å‰ç«¯é›†æˆ
<h1>è®¿é—®: http://localhost:3000</h1></code></pre>

<h4>2.2 è®¢å•åŒ¹é…æœåŠ¡ (<code>backend/services/TF_orderMatching.js</code>)</h4>

<strong>èŒè´£</strong>ï¼š
<li>âœ… <strong>ç›‘å¬åŒºå—é“¾äº‹ä»¶</strong>ï¼šå½“æ–°è®¢å•åˆ›å»ºæ—¶ï¼Œè‡ªåŠ¨è§¦å‘åŒ¹é…æµç¨‹</li>
<li>âœ… <strong>å®æ—¶è®¢å•å¹¿æ’­</strong>ï¼šé€šè¿‡WebSocketæ¨é€ç»™åœ¨çº¿å¸æœº</li>
<li>âœ… <strong>æ™ºèƒ½åŒ¹é…ç®—æ³•</strong>ï¼š</li>
  - è®¡ç®—å¸æœºä¸è®¢å•çš„è·ç¦»
  - è€ƒè™‘å¸æœºè¯„åˆ†
  - æ¨é€ç»™æœ€è¿‘çš„10ä¸ªå¸æœº
<li>âœ… <strong>è®¢å•é˜Ÿåˆ—ç®¡ç†</strong>ï¼šç®¡ç†å¾…æ¥å•è®¢å•</li>

<strong>å·¥ä½œæµç¨‹</strong>ï¼š
<pre><code>1. ç›‘å¬ TrustFlowRide.OrderCreated äº‹ä»¶
   â†“
<li>è·å–è®¢å•ä¿¡æ¯ï¼ˆèµ·ç‚¹ã€ç»ˆç‚¹ã€è´¹ç”¨ï¼‰</li>
   â†“
<li>æŸ¥è¯¢åœ¨çº¿å¸æœºåˆ—è¡¨</li>
   â†“
<li>è®¡ç®—æ¯ä¸ªå¸æœºåˆ°èµ·ç‚¹çš„è·ç¦»</li>
   â†“
<li>æ’åºå¹¶é€‰æ‹©æœ€è¿‘çš„10ä¸ªå¸æœº</li>
   â†“
<li>é€šè¿‡WebSocketæ¨é€è®¢å•ç»™è¿™äº›å¸æœº</code></pre></li>

<strong>WebSocketæ¶ˆæ¯æ ¼å¼</strong>ï¼š
<pre><code>javascript
// å‘é€ç»™å¸æœº
{
    type: 'new_order',
    order: {
        orderId: 123,
        pickup: { lat: 39.9, lng: 116.4 },
        destination: { lat: 40.0, lng: 116.4 },
        estimatedFare: "0.01",
        passenger: "0x..."
    }
}</code></pre>

<h4>2.3 ä½ç½®è·Ÿè¸ªæœåŠ¡ (<code>backend/services/TF_locationTracking.js</code>)</h4>

<strong>èŒè´£</strong>ï¼š
<li>âœ… <strong>GPSè½¨è¿¹è®°å½•</strong>ï¼šå®æ—¶è®°å½•å¸æœºä½ç½®</li>
<li>âœ… <strong>åˆ°è¾¾éªŒè¯</strong>ï¼šéªŒè¯å¸æœºæ˜¯å¦åˆ°è¾¾èµ·ç‚¹/ç»ˆç‚¹</li>
<li>âœ… <strong>IPFSå­˜å‚¨</strong>ï¼šå°†å®Œæ•´è½¨è¿¹ä¸Šä¼ åˆ°IPFS</li>
<li>âœ… <strong>è·ç¦»è®¡ç®—</strong>ï¼šè®¡ç®—å®é™…è¡Œé©¶è·ç¦»</li>

<h4>2.4 åŒºå—é“¾ç›‘å¬æœåŠ¡ (<code>backend/services/blockchainListener.js</code>)</h4>

<strong>èŒè´£</strong>ï¼š
<li>âœ… <strong>äº‹ä»¶ç›‘å¬</strong>ï¼šç›‘å¬æ‰€æœ‰æ™ºèƒ½åˆçº¦äº‹ä»¶</li>
<li>âœ… <strong>æ•°æ®åŒæ­¥</strong>ï¼šå°†é“¾ä¸Šæ•°æ®åŒæ­¥åˆ°æ•°æ®åº“/Redis</li>
<li>âœ… <strong>è§¦å‘åç«¯é€»è¾‘</strong>ï¼šå½“è®¢å•åˆ›å»ºæ—¶ï¼Œè§¦å‘è®¢å•åŒ¹é…æœåŠ¡</li>

<strong>ç›‘å¬çš„äº‹ä»¶</strong>ï¼š
<li><code>OrderCreated</code> â†’ è§¦å‘è®¢å•åŒ¹é…</li>
<li><code>OrderAccepted</code> â†’ é€šçŸ¥ä¹˜å®¢</li>
<li><code>OrderCompleted</code> â†’ è§¦å‘ä½ç½®è·Ÿè¸ªåœæ­¢</li>
<li><code>PaymentLocked</code> â†’ æ›´æ–°è®¢å•çŠ¶æ€</li>
<li><code>PaymentReleased</code> â†’ è®°å½•æ”¯ä»˜å®Œæˆ</li>

---

<h3>3. æ™ºèƒ½åˆçº¦å±‚ (Blockchain Layer)</h3>

<h4>3.1 åˆçº¦ä½ç½®</h4>

<strong>æºä»£ç </strong>ï¼š
<pre><code>contracts/
â”œâ”€â”€ TrustFlowRide.sol          # è®¢å•ç®¡ç†
â”œâ”€â”€ TrustFlowEscrow.sol        # æ”¯ä»˜æ‰˜ç®¡
â”œâ”€â”€ TrustFlowUserRegistry.sol  # ç”¨æˆ·ç®¡ç†
â”œâ”€â”€ TrustFlowRating.sol        # è¯„ä»·ç³»ç»Ÿ
â””â”€â”€ TrustFlowDispute.sol       # äº‰è®®å¤„ç†</code></pre>

<strong>ç¼–è¯‘åçš„ABI</strong>ï¼š
<pre><code>contracts/abi/
â”œâ”€â”€ TrustFlowRide.json
â”œâ”€â”€ TrustFlowEscrow.json
â”œâ”€â”€ TrustFlowUserRegistry.json
â”œâ”€â”€ TrustFlowRating.json
â””â”€â”€ TrustFlowDispute.json</code></pre>

<h4>3.2 åˆçº¦èŒè´£</h4>

<strong>TrustFlowRide.sol</strong> - è®¢å•ç®¡ç†
<li>åˆ›å»ºè®¢å•ã€æ¥å•ã€å®Œæˆè®¢å•</li>
<li>è®¢å•çŠ¶æ€ç®¡ç†</li>
<li>è®¢å•å†å²æŸ¥è¯¢</li>

<strong>TrustFlowEscrow.sol</strong> - æ”¯ä»˜æ‰˜ç®¡
<li>é”å®šèµ„é‡‘ï¼ˆä¸‹å•æ—¶ï¼‰</li>
<li>é‡Šæ”¾èµ„é‡‘ï¼ˆå®Œæˆæ—¶ï¼‰</li>
<li>é€€æ¬¾å¤„ç†ï¼ˆå–æ¶ˆæ—¶ï¼‰</li>
<li>å¹³å°æ‰‹ç»­è´¹</li>

<strong>TrustFlowUserRegistry.sol</strong> - ç”¨æˆ·ç®¡ç†
<li>ç”¨æˆ·æ³¨å†Œ</li>
<li>KYCéªŒè¯</li>
<li>ä¿¡ç”¨è¯„åˆ†</li>

<strong>TrustFlowRating.sol</strong> - è¯„ä»·ç³»ç»Ÿ
<li>åŒå‘è¯„ä»·</li>
<li>è¯„åˆ†ç»Ÿè®¡</li>

<strong>TrustFlowDispute.sol</strong> - äº‰è®®å¤„ç†
<li>äº‰è®®æäº¤</li>
<li>ä»²è£å¤„ç†</li>

<h4>3.3 åˆçº¦éƒ¨ç½²ä½ç½®</h4>

<strong>éƒ¨ç½²åˆ°åŒºå—é“¾ç½‘ç»œ</strong>ï¼š
<li>æœ¬åœ°æµ‹è¯•ï¼šHardhatæœ¬åœ°èŠ‚ç‚¹ (localhost:8545)</li>
<li>æµ‹è¯•ç½‘ï¼šPolygon Mumbaiã€BSC Testnet</li>
<li>ä¸»ç½‘ï¼šPolygonã€BSC</li>

<strong>éƒ¨ç½²ä¿¡æ¯å­˜å‚¨</strong>ï¼š
<pre><code>deployments/
â””â”€â”€ {network}-latest.json  # åŒ…å«æ‰€æœ‰åˆçº¦åœ°å€</code></pre>

---

<h2>ğŸ”„ å®Œæ•´æ•°æ®æµ</h2>

<h3>åœºæ™¯ï¼šä¹˜å®¢åˆ›å»ºè®¢å•</h3>

<pre><code>1. å‰ç«¯ (ä¹˜å®¢App)
   â”œâ”€ ç”¨æˆ·å¡«å†™è®¢å•ä¿¡æ¯
   â”œâ”€ ç‚¹å‡»"åˆ›å»ºè®¢å•"
   â””â”€ é€šè¿‡MetaMaskè°ƒç”¨æ™ºèƒ½åˆçº¦
      â†“
<li>æ™ºèƒ½åˆçº¦ (TrustFlowRide)</li>
   â”œâ”€ createOrder() å‡½æ•°æ‰§è¡Œ
   â”œâ”€ åˆ›å»ºè®¢å•è®°å½•
   â””â”€ è§¦å‘ OrderCreated äº‹ä»¶
      â†“
<li>åŒºå—é“¾ç›‘å¬æœåŠ¡</li>
   â”œâ”€ ç›‘å¬åˆ° OrderCreated äº‹ä»¶
   â”œâ”€ è§£æè®¢å•æ•°æ®
   â””â”€ è§¦å‘è®¢å•åŒ¹é…æœåŠ¡
      â†“
<li>è®¢å•åŒ¹é…æœåŠ¡</li>
   â”œâ”€ æŸ¥è¯¢åœ¨çº¿å¸æœº
   â”œâ”€ è®¡ç®—è·ç¦»
   â”œâ”€ é€‰æ‹©æœ€è¿‘çš„10ä¸ªå¸æœº
   â””â”€ é€šè¿‡WebSocketæ¨é€è®¢å•
      â†“
<li>å‰ç«¯ (å¸æœºApp)</li>
   â”œâ”€ æ¥æ”¶WebSocketæ¶ˆæ¯
   â”œâ”€ æ˜¾ç¤ºè®¢å•é€šçŸ¥
   â””â”€ å¸æœºç‚¹å‡»"æ¥å•"
      â†“
<li>æ™ºèƒ½åˆçº¦ (TrustFlowRide)</li>
   â”œâ”€ acceptOrder() å‡½æ•°æ‰§è¡Œ
   â”œâ”€ æ›´æ–°è®¢å•çŠ¶æ€
   â””â”€ è§¦å‘ OrderAccepted äº‹ä»¶
      â†“
<li>åç«¯æœåŠ¡</li>
   â”œâ”€ ç›‘å¬æœåŠ¡æ•è·äº‹ä»¶
   â”œâ”€ é€šçŸ¥ä¹˜å®¢ï¼ˆWebSocketï¼‰
   â””â”€ æ›´æ–°è®¢å•çŠ¶æ€</code></pre>

---

<h2>ğŸš€ éƒ¨ç½²æµç¨‹</h2>

<h3>æ­¥éª¤1: éƒ¨ç½²æ™ºèƒ½åˆçº¦</h3>

<pre><code>bash
<h1>1. ç¼–è¯‘åˆçº¦</h1>
npm run compile

<h1>2. å¯åŠ¨æœ¬åœ°èŠ‚ç‚¹ï¼ˆæµ‹è¯•ç”¨ï¼‰</h1>
npm run node

<h1>3. éƒ¨ç½²åˆ°æœ¬åœ°</h1>
npm run deploy:local

<h1>æˆ–éƒ¨ç½²åˆ°æµ‹è¯•ç½‘</h1>
npm run deploy:mumbai</code></pre>

<strong>éƒ¨ç½²è„šæœ¬</strong> (<code>scripts/deploy.js</code>)ï¼š
<li>æŒ‰é¡ºåºéƒ¨ç½²æ‰€æœ‰åˆçº¦</li>
<li>é…ç½®åˆçº¦ä¹‹é—´çš„å…³è”</li>
<li>ä¿å­˜éƒ¨ç½²ä¿¡æ¯åˆ° <code>deployments/</code> ç›®å½•</li>
<li>ç”ŸæˆABIæ–‡ä»¶åˆ° <code>contracts/abi/</code></li>

<strong>éƒ¨ç½²åçš„åˆçº¦åœ°å€</strong>ï¼š
<pre><code>json
{
  "network": "localhost",
  "contracts": {
    "rideOrder": "0x5FbDB2315678afecb367f032d93F642f64180aa3",
    "paymentEscrow": "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512",
    "userRegistry": "0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0",
    ...
  }
}</code></pre>

<h3>æ­¥éª¤2: é…ç½®åç«¯æœåŠ¡</h3>

<strong>æ›´æ–°é…ç½®æ–‡ä»¶</strong> (<code>backend/config/config.js</code> æˆ– <code>.env</code>)ï¼š
<pre><code>javascript
{
  rpcUrl: "http://localhost:8545",  // åŒºå—é“¾RPC
  contracts: {
    rideOrder: "0x5FbDB...",        // ä»éƒ¨ç½²ä¿¡æ¯ä¸­è·å–
    paymentEscrow: "0xe7f17...",
    ...
  },
  redis: {
    host: "localhost",
    port: 6379
  }
}</code></pre>

<strong>æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡</strong>ï¼š
<pre><code>bash
<h1>.env æ–‡ä»¶</h1>
RPC_URL=http://localhost:8545
RIDE_ORDER_ADDRESS=0x5FbDB...
PAYMENT_ESCROW_ADDRESS=0xe7f17...
REDIS_URL=redis://localhost:6379</code></pre>

<h3>æ­¥éª¤3: é…ç½®å‰ç«¯</h3>

<strong>è‡ªåŠ¨é…ç½®</strong>ï¼ˆæ¨èï¼‰ï¼š
<pre><code>bash
npm run setup:frontend</code></pre>

è¿™ä¼šè‡ªåŠ¨ä» <code>deployments/localhost-latest.json</code> è¯»å–åˆçº¦åœ°å€ï¼Œå¹¶ç”Ÿæˆï¼š
<li><code>frontend/passenger-app/.env</code> - Reactç¯å¢ƒå˜é‡ï¼ˆå¦‚æœä½¿ç”¨Reactï¼‰</li>
<li><code>frontend/passenger-app/config.js</code> - é™æ€HTMLé…ç½®</li>

<strong>æ‰‹åŠ¨é…ç½®</strong>ï¼š
åœ¨ <code>frontend/passenger-app/index.html</code> ä¸­ï¼Œåˆçº¦åœ°å€é€šè¿‡ä»¥ä¸‹æ–¹å¼åŠ è½½ï¼š
<li><code>config.js</code> æ–‡ä»¶ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰</li>
<li><code>localStorage</code>ï¼ˆç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ï¼‰</li>
<li>æµè§ˆå™¨æç¤ºè¾“å…¥</li>

<h3>æ­¥éª¤4: å¯åŠ¨æœåŠ¡</h3>

<strong>å¼€å‘ç¯å¢ƒ</strong>ï¼ˆæ¨èï¼‰ï¼š
<pre><code>bash
<h1>ç»ˆç«¯1: å¯åŠ¨åç«¯API</h1>
npm run server:dev

<h1>ç»ˆç«¯2: å¯åŠ¨å‰ç«¯</h1>
npm run frontend

<h1>ç»ˆç«¯3: å¯åŠ¨HardhatèŠ‚ç‚¹ï¼ˆå¦‚æœæœ¬åœ°æµ‹è¯•ï¼‰</h1>
npm run node</code></pre>

<strong>ç”Ÿäº§ç¯å¢ƒ</strong>ï¼ˆé›†æˆæœåŠ¡ï¼‰ï¼š
<pre><code>bash
<h1>å•ä¸ªå‘½ä»¤å¯åŠ¨æ‰€æœ‰æœåŠ¡</h1>
npm run server:full</code></pre>

---

<h2>ğŸ“Š ç³»ç»Ÿäº¤äº’å›¾</h2>

<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¹˜å®¢å‰ç«¯   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. createOrder() [ç›´æ¥è°ƒç”¨]
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TrustFlowRide  â”‚ â† æ™ºèƒ½åˆçº¦ï¼ˆéƒ¨ç½²åœ¨åŒºå—é“¾ï¼‰
â”‚   (æ™ºèƒ½åˆçº¦)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. OrderCreated äº‹ä»¶
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŒºå—é“¾ç›‘å¬æœåŠ¡   â”‚ â† åç«¯æœåŠ¡
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. è§¦å‘è®¢å•åŒ¹é…
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å•åŒ¹é…æœåŠ¡     â”‚ â† åç«¯æœåŠ¡
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. WebSocketæ¨é€
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¸æœºå‰ç«¯   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 5. acceptOrder() [ç›´æ¥è°ƒç”¨]
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TrustFlowRide  â”‚ â† æ™ºèƒ½åˆçº¦
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>

---

<h2>ğŸ”‘ å…³é”®ç‚¹æ€»ç»“</h2>

<h3>å‰ç«¯èŒè´£</h3>
<li>âœ… <strong>UIå±•ç¤º</strong>ï¼šè®¢å•åˆ›å»ºè¡¨å•ã€è®¢å•åˆ—è¡¨ã€çŠ¶æ€æ˜¾ç¤º</li>
<li>âœ… <strong>ç›´æ¥è°ƒç”¨åˆçº¦</strong>ï¼šé€šè¿‡MetaMaskç›´æ¥ä¸æ™ºèƒ½åˆçº¦äº¤äº’</li>
<li>âœ… <strong>æ¥æ”¶é€šçŸ¥</strong>ï¼šé€šè¿‡WebSocketæ¥æ”¶åç«¯æ¨é€çš„å®æ—¶æ›´æ–°</li>

<h3>åç«¯èŒè´£</h3>
<li>âœ… <strong>æ•°æ®æŸ¥è¯¢API</strong>ï¼šæä¾›HTTPæ¥å£æŸ¥è¯¢è®¢å•ã€ç”¨æˆ·ç­‰ä¿¡æ¯</li>
<li>âœ… <strong>è®¢å•åŒ¹é…</strong>ï¼šç›‘å¬é“¾ä¸Šäº‹ä»¶ï¼Œæ™ºèƒ½åŒ¹é…è®¢å•ç»™å¸æœº</li>
<li>âœ… <strong>å®æ—¶é€šçŸ¥</strong>ï¼šé€šè¿‡WebSocketæ¨é€è®¢å•å’ŒçŠ¶æ€æ›´æ–°</li>
<li>âœ… <strong>ä½ç½®è·Ÿè¸ª</strong>ï¼šè®°å½•GPSè½¨è¿¹ï¼Œå­˜å‚¨åˆ°IPFS</li>

<h3>æ™ºèƒ½åˆçº¦èŒè´£</h3>
<li>âœ… <strong>æ ¸å¿ƒä¸šåŠ¡é€»è¾‘</strong>ï¼šè®¢å•ç®¡ç†ã€æ”¯ä»˜æ‰˜ç®¡ã€ç”¨æˆ·ç®¡ç†</li>
<li>âœ… <strong>æ•°æ®å­˜å‚¨</strong>ï¼šå…³é”®æ•°æ®å­˜å‚¨åœ¨é“¾ä¸Šï¼Œä¸å¯ç¯¡æ”¹</li>
<li>âœ… <strong>äº‹ä»¶è§¦å‘</strong>ï¼šé€šè¿‡äº‹ä»¶é€šçŸ¥åç«¯æœåŠ¡</li>

<h3>éƒ¨ç½²è¦ç‚¹</h3>
<li><strong>åˆçº¦éƒ¨ç½²</strong>ï¼šä½¿ç”¨Hardhatéƒ¨ç½²åˆ°ç›®æ ‡ç½‘ç»œ</li>
<li><strong>åœ°å€é…ç½®</strong>ï¼šå°†åˆçº¦åœ°å€é…ç½®åˆ°åç«¯å’Œå‰ç«¯</li>
<li><strong>æœåŠ¡å¯åŠ¨</strong>ï¼šæŒ‰é¡ºåºå¯åŠ¨åç«¯å’Œå‰ç«¯æœåŠ¡</li>

---

<strong>æ›´å¤šè¯¦ç»†ä¿¡æ¯</strong>ï¼š
<li>éƒ¨ç½²æŒ‡å—ï¼š<code>docs/DEPLOYMENT.md</code></li>
<li>APIæ–‡æ¡£ï¼š<code>docs/API.md</code></li>
<li>æ¶æ„æ–‡æ¡£ï¼š<code>docs/ARCHITECTURE.md</code></li>


</body>
</html>